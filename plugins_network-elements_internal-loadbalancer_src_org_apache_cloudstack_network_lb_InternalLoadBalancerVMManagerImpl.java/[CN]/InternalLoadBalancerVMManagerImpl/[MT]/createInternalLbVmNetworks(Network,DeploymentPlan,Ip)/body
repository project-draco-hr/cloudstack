{
  LinkedHashMap<Network,List<? extends NicProfile>> networks=new LinkedHashMap<Network,List<? extends NicProfile>>(3);
  if (guestNetwork != null) {
    s_logger.debug("Adding nic for Internal LB in Guest network " + guestNetwork);
    NicProfile guestNic=new NicProfile();
    if (guestIp != null) {
      guestNic.setIp4Address(guestIp.addr());
    }
 else {
      guestNic.setIp4Address(_ipAddrMgr.acquireGuestIpAddress(guestNetwork,null));
    }
    guestNic.setGateway(guestNetwork.getGateway());
    guestNic.setBroadcastUri(guestNetwork.getBroadcastUri());
    guestNic.setBroadcastType(guestNetwork.getBroadcastDomainType());
    guestNic.setIsolationUri(guestNetwork.getBroadcastUri());
    guestNic.setMode(guestNetwork.getMode());
    String gatewayCidr=guestNetwork.getCidr();
    guestNic.setNetmask(NetUtils.getCidrNetmask(gatewayCidr));
    guestNic.setDefaultNic(true);
    networks.put(guestNetwork,new ArrayList<NicProfile>(Arrays.asList(guestNic)));
  }
  s_logger.debug("Adding nic for Internal LB vm in Control network ");
  List<? extends NetworkOffering> offerings=_ntwkModel.getSystemAccountNetworkOfferings(NetworkOffering.SystemControlNetwork);
  NetworkOffering controlOffering=offerings.get(0);
  Network controlConfig=_ntwkMgr.setupNetwork(_accountMgr.getSystemAccount(),controlOffering,plan,null,null,false).get(0);
  networks.put(controlConfig,new ArrayList<NicProfile>());
  return networks;
}
