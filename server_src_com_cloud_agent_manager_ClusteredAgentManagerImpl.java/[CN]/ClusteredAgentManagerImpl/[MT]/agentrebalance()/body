{
  Profiler profilerAgentLB=new Profiler();
  profilerAgentLB.start();
  if (_agentLBEnabled.value() && !_agentLbHappened) {
    SearchCriteriaService<HostVO,HostVO> sc=SearchCriteria2.create(HostVO.class);
    sc.addAnd(sc.getEntity().getManagementServerId(),Op.NNULL);
    sc.addAnd(sc.getEntity().getType(),Op.EQ,Host.Type.Routing);
    List<HostVO> allManagedRoutingAgents=sc.list();
    sc=SearchCriteria2.create(HostVO.class);
    sc.addAnd(sc.getEntity().getType(),Op.EQ,Host.Type.Routing);
    List<HostVO> allAgents=sc.list();
    double allHostsCount=allAgents.size();
    double managedHostsCount=allManagedRoutingAgents.size();
    if (allHostsCount > 0.0) {
      double load=managedHostsCount / allHostsCount;
      if (load >= _connectedAgentsThreshold.value()) {
        s_logger.debug("Scheduling agent rebalancing task as the average agent load " + load + " is more than the threshold "+ _connectedAgentsThreshold);
        _rebalanceService.scheduleRebalanceAgents();
        _agentLbHappened=true;
      }
 else {
        s_logger.trace("Not scheduling agent rebalancing task as the averages load " + load + " is less than the threshold "+ _connectedAgentsThreshold);
      }
    }
  }
  profilerAgentLB.stop();
}
