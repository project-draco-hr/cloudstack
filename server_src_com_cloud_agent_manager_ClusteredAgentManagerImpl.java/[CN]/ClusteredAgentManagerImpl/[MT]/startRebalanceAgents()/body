{
  if (s_logger.isDebugEnabled()) {
    s_logger.debug("Management server " + _nodeId + " was asked to do agent rebalancing; checking how many hosts can be taken from this server");
  }
  List<ManagementServerHostVO> allMS=_mshostDao.listBy(ManagementServerHost.State.Up,ManagementServerHost.State.Starting);
  List<HostVO> allManagedAgents=_hostDao.listManagedAgents();
  long avLoad=0L;
  if (!allManagedAgents.isEmpty() && !allMS.isEmpty()) {
    avLoad=allManagedAgents.size() / allMS.size();
  }
 else {
    if (s_logger.isDebugEnabled()) {
      s_logger.debug("Management server " + _nodeId + " found no hosts to rebalance. Current number of active management server nodes in the system is "+ allMS.size()+ "; number of managed agents is "+ allMS.size());
    }
    return;
  }
  for (  ManagementServerHostVO node : allMS) {
    if (node.getMsid() != _nodeId) {
      List<HostVO> hostsToRebalance=new ArrayList<HostVO>();
      for (      AgentLoadBalancerPlanner lbPlanner : _lbPlanners) {
        hostsToRebalance=lbPlanner.getHostsToRebalance(node.getMsid(),avLoad);
        if (!hostsToRebalance.isEmpty()) {
          break;
        }
 else {
          s_logger.debug("Agent load balancer planner " + lbPlanner.getName() + " found no hosts to be rebalanced from management server "+ _nodeId);
        }
      }
      if (!hostsToRebalance.isEmpty()) {
        for (        HostVO host : hostsToRebalance) {
          long hostId=host.getId();
          s_logger.debug("Asking management server " + node.getMsid() + " to give away host id="+ hostId);
          boolean result=true;
          HostTransferMapVO transfer=_hostTransferDao.startAgentTransfering(hostId,_nodeId,node.getMsid());
          try {
            Answer[] answer=sendRebalanceCommand(hostId,_nodeId,Event.RequestAgentRebalance);
            if (answer == null) {
              s_logger.warn("Failed to get host id=" + hostId + " from management server "+ node.getMsid());
              result=false;
            }
          }
 catch (          Exception ex) {
            s_logger.warn("Failed to get host id=" + hostId + " from management server "+ node.getMsid(),ex);
            result=false;
          }
 finally {
            HostTransferMapVO updatedTransfer=_hostTransferDao.findById(transfer.getId());
            if (!result && updatedTransfer.getState() == HostTransferState.TransferRequested) {
              if (s_logger.isDebugEnabled()) {
                s_logger.debug("Removing mapping from op_host_transfer as it failed to be set to transfer mode");
              }
              _hostTransferDao.remove(transfer.getId());
            }
          }
        }
      }
 else {
        s_logger.debug("Management server " + _nodeId + " found no hosts to rebalance.");
      }
    }
  }
}
