{
  DataObjectInStore obj=this.findObject(data,data.getDataStore());
  if (obj == null) {
    throw new CloudRuntimeException("can't find mapping in ObjectInDataStore table for: " + data);
  }
  if (data.getDataStore().getRole() == DataStoreRole.Image) {
switch (data.getType()) {
case TEMPLATE:
      this.stateMachines.transitTo(obj,event,null,templateDataStoreDao);
case SNAPSHOT:
    this.stateMachines.transitTo(obj,event,null,snapshotDataStoreDao);
case VOLUME:
  this.stateMachines.transitTo(obj,event,null,volumeDataStoreDao);
}
}
 else if (data.getType() == DataObjectType.TEMPLATE && data.getDataStore().getRole() == DataStoreRole.Primary) {
if (answer != null && answer instanceof CopyCmdAnswer) {
CopyCmdAnswer cpyAnswer=(CopyCmdAnswer)answer;
VMTemplateStoragePoolVO templatePoolRef=templatePoolDao.findByPoolTemplate(data.getDataStore().getId(),data.getId());
templatePoolRef.setDownloadPercent(100);
templatePoolRef.setDownloadState(Status.DOWNLOADED);
templatePoolRef.setLocalDownloadPath(cpyAnswer.getPath());
templatePoolRef.setInstallPath(cpyAnswer.getPath());
templatePoolDao.update(templatePoolRef.getId(),templatePoolRef);
}
try {
obj=this.findObject(data,data.getDataStore());
this.stateMachines.transitTo(obj,event,null,templatePoolDao);
}
 catch (NoTransitionException e) {
throw e;
}
}
 else {
throw new CloudRuntimeException("Invalid data or store type: " + data.getType() + " "+ data.getDataStore().getRole());
}
return true;
}
