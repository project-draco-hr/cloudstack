{
  s_logger.debug("Upgrading VPC service Map");
  PreparedStatement listVpc=null;
  PreparedStatement listServiceProviders=null;
  PreparedStatement insertProviders=null;
  ResultSet rs=null;
  ResultSet rs1=null;
  try {
    listVpc=conn.prepareStatement("SELECT id, vpc_offering_id FROM `cloud`.`vpc` where removed is NULL");
    rs=listVpc.executeQuery();
    while (rs.next()) {
      long vpc_id=rs.getLong(1);
      long offering_id=rs.getLong(2);
      listServiceProviders=conn.prepareStatement("SELECT service, provider FROM `cloud`.`vpc_offering_service_map` where vpc_offering_id = ?");
      listServiceProviders.setLong(1,offering_id);
      rs1=listServiceProviders.executeQuery();
      while (rs1.next()) {
        String service=rs1.getString(1);
        String provider=rs1.getString(2);
        insertProviders=conn.prepareStatement("INSERT INTO `cloud`.`vpc_service_map` (`vpc_id`, `service`, `provider`, `created`) VALUES (?, ?, ?, now());");
        insertProviders.setLong(1,vpc_id);
        insertProviders.setString(2,service);
        insertProviders.setString(3,provider);
        insertProviders.executeUpdate();
      }
      s_logger.debug("Upgraded service map for VPC: " + vpc_id);
    }
  }
 catch (  SQLException e) {
    throw new CloudRuntimeException("Error during VPC service map upgrade",e);
  }
 finally {
    try {
      if (rs != null) {
        rs.close();
      }
      if (rs1 != null) {
        rs1.close();
      }
      if (listVpc != null) {
        listVpc.close();
      }
      if (listServiceProviders != null) {
        listServiceProviders.close();
      }
      if (insertProviders != null) {
        insertProviders.close();
      }
    }
 catch (    SQLException e) {
    }
  }
}
