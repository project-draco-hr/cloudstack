{
  PreparedStatement tmplStoreInsert=null;
  PreparedStatement tmplStoreUpdate=null;
  s_logger.debug("Updating template_store_ref table from template_host_ref table");
  try {
    tmplStoreInsert=conn.prepareStatement("INSERT INTO `cloud`.`template_store_ref` (store_id,  template_id, created, last_updated, job_id, download_pct, size, physical_size, download_state, error_str, local_path, install_path, url, destroyed, is_copy, update_count, ref_cnt, store_role, state) select host_id, template_id, created, last_updated, job_id, download_pct, size, physical_size, download_state, error_str, local_path, install_path, url, destroyed, is_copy, 0, 0, 'Image', 'Allocated' from `cloud`.`template_host_ref`");
    int rowCount=tmplStoreInsert.executeUpdate();
    s_logger.debug("Insert modified " + rowCount + " rows");
    tmplStoreUpdate=conn.prepareStatement("update `cloud`.`template_store_ref` set state = 'Ready' where download_state = 'DOWNLOADED'");
    rowCount=tmplStoreUpdate.executeUpdate();
    s_logger.debug("Update modified " + rowCount + " rows");
  }
 catch (  SQLException e) {
    String msg="Unable to migrate template_host_ref." + e.getMessage();
    s_logger.error(msg);
    throw new CloudRuntimeException(msg,e);
  }
 finally {
    try {
      if (tmplStoreInsert != null) {
        tmplStoreInsert.close();
      }
      if (tmplStoreUpdate != null) {
        tmplStoreUpdate.close();
      }
    }
 catch (    SQLException e) {
    }
  }
  s_logger.debug("Completed updating template_store_ref table from template_host_ref table");
}
