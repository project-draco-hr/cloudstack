{
  PreparedStatement pstmt=null;
  ResultSet rs=null;
  s_logger.debug("Updating System Vm template IDs");
  try {
    Set<HypervisorType> hypervisorsListInUse=new HashSet<HypervisorType>();
    try {
      pstmt=conn.prepareStatement("select distinct(hypervisor_type) from `cloud`.`cluster` where removed is null");
      rs=pstmt.executeQuery();
      while (rs.next()) {
switch (HypervisorType.getType(rs.getString(1))) {
case XenServer:
          hypervisorsListInUse.add(HypervisorType.XenServer);
        break;
case KVM:
      hypervisorsListInUse.add(HypervisorType.KVM);
    break;
case VMware:
  hypervisorsListInUse.add(HypervisorType.VMware);
break;
case Hyperv:
hypervisorsListInUse.add(HypervisorType.Hyperv);
break;
case LXC:
hypervisorsListInUse.add(HypervisorType.LXC);
break;
}
}
}
 catch (SQLException e) {
throw new CloudRuntimeException("Error while listing hypervisors in use",e);
}
Map<HypervisorType,String> NewTemplateNameList=new HashMap<HypervisorType,String>(){
{
put(HypervisorType.XenServer,"systemvm-xenserver-4.2");
put(HypervisorType.VMware,"systemvm-vmware-4.2");
put(HypervisorType.KVM,"systemvm-kvm-4.2");
put(HypervisorType.LXC,"systemvm-lxc-4.2");
put(HypervisorType.Hyperv,"systemvm-hyperv-4.2");
}
}
;
Map<HypervisorType,String> routerTemplateConfigurationNames=new HashMap<HypervisorType,String>(){
{
put(HypervisorType.XenServer,"router.template.xen");
put(HypervisorType.VMware,"router.template.vmware");
put(HypervisorType.KVM,"router.template.kvm");
put(HypervisorType.LXC,"router.template.lxc");
put(HypervisorType.Hyperv,"router.template.hyperv");
}
}
;
for (Map.Entry<HypervisorType,String> hypervisorAndTemplateName : NewTemplateNameList.entrySet()) {
s_logger.debug("Updating " + hypervisorAndTemplateName.getKey() + " System Vms");
try {
pstmt=conn.prepareStatement("select id from `cloud`.`vm_template` where name like ? and removed is null order by id desc limit 1");
pstmt.setString(1,hypervisorAndTemplateName.getValue());
rs=pstmt.executeQuery();
if (rs.next()) {
long templateId=rs.getLong(1);
rs.close();
pstmt.close();
pstmt=conn.prepareStatement("update `cloud`.`vm_template` set type='SYSTEM' where id = ?");
pstmt.setLong(1,templateId);
pstmt.executeUpdate();
pstmt.close();
pstmt=conn.prepareStatement("update `cloud`.`vm_instance` set vm_template_id = ? where type <> 'User' and hypervisor_type = ?");
pstmt.setLong(1,templateId);
pstmt.setString(2,hypervisorAndTemplateName.getKey().toString());
pstmt.executeUpdate();
pstmt.close();
pstmt=conn.prepareStatement("UPDATE `cloud`.`configuration` SET value = ? WHERE name = ?");
pstmt.setString(1,hypervisorAndTemplateName.getValue());
pstmt.setString(2,routerTemplateConfigurationNames.get(hypervisorAndTemplateName.getKey()));
pstmt.executeUpdate();
pstmt.close();
}
 else {
if (hypervisorsListInUse.contains(hypervisorAndTemplateName.getKey())) {
throw new CloudRuntimeException("4.2.0 " + hypervisorAndTemplateName.getKey() + " SystemVm template not found. Cannot upgrade system Vms");
}
 else {
s_logger.warn("4.2.0 " + hypervisorAndTemplateName.getKey() + " SystemVm template not found. "+ hypervisorAndTemplateName.getKey()+ " hypervisor is not used, so not failing upgrade");
}
}
}
 catch (SQLException e) {
throw new CloudRuntimeException("Error while updating " + hypervisorAndTemplateName.getKey() + " systemVm template",e);
}
}
try {
pstmt=conn.prepareStatement("UPDATE `cloud`.`vm_template` set dynamically_scalable = 1 where name = ? and type = 'SYSTEM'");
pstmt.setString(1,NewTemplateNameList.get(HypervisorType.VMware));
pstmt.executeUpdate();
pstmt.close();
}
 catch (SQLException e) {
throw new CloudRuntimeException("Error while updating dynamically_scalable flag to 1 for SYSTEM template systemvm-vmware-4.2");
}
s_logger.debug("Updating System Vm Template IDs Complete");
}
  finally {
try {
if (rs != null) {
rs.close();
}
if (pstmt != null) {
pstmt.close();
}
}
 catch (SQLException e) {
}
}
}
