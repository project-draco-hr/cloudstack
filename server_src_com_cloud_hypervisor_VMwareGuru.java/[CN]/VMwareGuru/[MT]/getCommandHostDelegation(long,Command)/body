{
  boolean needDelegation=false;
  if (cmd instanceof PrimaryStorageDownloadCommand || cmd instanceof BackupSnapshotCommand || cmd instanceof DeleteSnapshotsDirCommand|| cmd instanceof DeleteSnapshotBackupCommand|| cmd instanceof CreatePrivateTemplateFromVolumeCommand|| cmd instanceof CreatePrivateTemplateFromSnapshotCommand|| cmd instanceof CopyVolumeCommand|| cmd instanceof CreateVolumeFromSnapshotCommand) {
    needDelegation=true;
  }
  if (needDelegation) {
    HostVO host=_hostDao.findById(hostId);
    assert(host != null);
    assert(host.getHypervisorType() == HypervisorType.VMware);
    long dcId=host.getDataCenterId();
    HostVO hostSecStorage=_hostDao.findSecondaryStorageHost(dcId);
    if (hostSecStorage != null && hostSecStorage.getStatus() == Status.Up) {
      cmd.setContextParam("hypervisor",HypervisorType.VMware.toString());
      Map<String,String> hostDetails=_hostDetailsDao.findDetails(hostId);
      cmd.setContextParam("guid",hostDetails.get("guid"));
      cmd.setContextParam("username",hostDetails.get("username"));
      cmd.setContextParam("password",hostDetails.get("password"));
      return hostSecStorage.getId();
    }
  }
  return hostId;
}
