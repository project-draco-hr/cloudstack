{
  if (routers == null || routers.isEmpty()) {
    s_logger.warn("Failed to add/remove VPN users: no router found for account and zone");
    throw new ResourceUnavailableException("Unable to assign ip addresses, domR doesn't exist for network " + network.getId(),DataCenter.class,network.getDataCenterId());
  }
  s_logger.debug("APPLYING VPN RULES");
  boolean agentResults=true;
  for (  final DomainRouterVO router : routers) {
    if (router.getState() != State.Running) {
      s_logger.warn("Failed to add/remove VPN users: router not in running state");
      throw new ResourceUnavailableException("Unable to assign ip addresses, domR is not in right state " + router.getState(),DataCenter.class,network.getDataCenterId());
    }
    VpnRules vpnRules=_virtualNetworkApplianceFactory.createVpnRules(network,users);
    final boolean agentResult=vpnRules.accept(_basicVisitor,router);
    agentResults=agentResults && agentResult;
  }
  final String[] result=new String[users.size()];
  for (int i=0; i < result.length; i++) {
    if (agentResults) {
      result[i]=null;
    }
 else {
      result[i]=String.valueOf(agentResults);
    }
  }
  return result;
}
