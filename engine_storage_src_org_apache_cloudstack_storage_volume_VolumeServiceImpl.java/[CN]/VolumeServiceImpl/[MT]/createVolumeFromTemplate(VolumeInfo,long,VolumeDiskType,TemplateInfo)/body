{
  PrimaryDataStore pd=dataStoreMgr.getPrimaryDataStore(dataStoreId);
  TemplateOnPrimaryDataStoreInfo templateOnPrimaryStore=pd.getTemplate(template);
  if (templateOnPrimaryStore == null) {
    templateOnPrimaryStore=createBaseImage(pd,template);
  }
  VolumeObject vo=(VolumeObject)volume;
  try {
    vo.stateTransit(VolumeEvent.CreateRequested);
  }
 catch (  Exception e) {
    throw new CloudRuntimeException(e.toString());
  }
  try {
    volume=pd.createVoluemFromBaseImage(volume,templateOnPrimaryStore);
    vo.stateTransit(VolumeEvent.OperationSucceeded);
  }
 catch (  Exception e) {
    vo.stateTransit(VolumeEvent.OperationFailed);
    throw new CloudRuntimeException(e.toString());
  }
  return volume;
}
