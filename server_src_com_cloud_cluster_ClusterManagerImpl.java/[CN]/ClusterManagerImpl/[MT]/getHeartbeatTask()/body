{
  return new Runnable(){
    @Override public void run(){
      Transaction txn=Transaction.open("ClusterHeartBeat");
      try {
        txn.transitToUserManagedConnection(getHeartbeatConnection());
        if (s_logger.isTraceEnabled()) {
          s_logger.trace("Cluster manager heartbeat update, id:" + _mshostId);
        }
        _mshostDao.update(_mshostId,getCurrentRunId(),DateUtil.currentGMTTime());
        if (s_logger.isTraceEnabled()) {
          s_logger.trace("Cluster manager peer-scan, id:" + _mshostId);
        }
        if (!_peerScanInited) {
          _peerScanInited=true;
          initPeerScan();
        }
        peerScan();
      }
 catch (      CloudRuntimeException e) {
        s_logger.error("Runtime DB exception ",e.getCause());
        if (e.getCause() instanceof ClusterInvalidSessionException) {
          s_logger.error("Invalid cluster session found");
          queueNotification(new ClusterManagerMessage(ClusterManagerMessage.MessageType.nodeIsolated));
        }
        if (isRootCauseConnectionRelated(e.getCause())) {
          s_logger.error("DB communication problem detected");
          queueNotification(new ClusterManagerMessage(ClusterManagerMessage.MessageType.nodeIsolated));
        }
        invalidHeartbeatConnection();
      }
catch (      Throwable e) {
        if (isRootCauseConnectionRelated(e.getCause())) {
          s_logger.error("DB communication problem detected");
          queueNotification(new ClusterManagerMessage(ClusterManagerMessage.MessageType.nodeIsolated));
        }
        s_logger.error("Problem with the cluster heartbeat!",e);
      }
 finally {
        txn.close("ClusterHeartBeat");
      }
    }
  }
;
}
