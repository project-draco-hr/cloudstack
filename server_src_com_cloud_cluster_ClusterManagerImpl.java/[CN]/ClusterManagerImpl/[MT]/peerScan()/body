{
  Date cutTime=DateUtil.currentGMTTime();
  List<ManagementServerHostVO> currentList=_mshostDao.getActiveList(new Date(cutTime.getTime() - heartbeatThreshold));
  List<ManagementServerHostVO> removedNodeList=new ArrayList<ManagementServerHostVO>();
  if (_mshostId != null) {
    for (    Map.Entry<Long,ManagementServerHostVO> entry : activePeers.entrySet()) {
      if (!isIdInList(entry.getKey(),currentList)) {
        if (entry.getKey().longValue() != _mshostId.longValue()) {
          if (s_logger.isDebugEnabled()) {
            s_logger.debug("Detected management node left, id:" + entry.getKey() + ", nodeIP:"+ entry.getValue().getServiceIP());
          }
          removedNodeList.add(entry.getValue());
        }
      }
    }
  }
  for (  ManagementServerHostVO mshost : removedNodeList) {
    activePeers.remove(mshost.getId());
    try {
      JmxUtil.unregisterMBean("ClusterManager","Node " + mshost.getId());
    }
 catch (    Exception e) {
      s_logger.warn("Unable to deregiester cluster node from JMX monitoring due to exception " + e.toString());
    }
  }
  List<ManagementServerHostVO> newNodeList=new ArrayList<ManagementServerHostVO>();
  for (  ManagementServerHostVO mshost : currentList) {
    if (!activePeers.containsKey(mshost.getId())) {
      activePeers.put(mshost.getId(),mshost);
      if (s_logger.isDebugEnabled()) {
        s_logger.debug("Detected management node joined, id:" + mshost.getId() + ", nodeIP:"+ mshost.getServiceIP());
      }
      newNodeList.add(mshost);
      try {
        JmxUtil.registerMBean("ClusterManager","Node " + mshost.getId(),new ClusterManagerMBeanImpl(mshost));
      }
 catch (      Exception e) {
        s_logger.warn("Unable to regiester cluster node into JMX monitoring due to exception " + e.toString());
      }
    }
  }
  if (newNodeList.size() > 0) {
    notifyNodeJoined(newNodeList);
  }
  if (removedNodeList.size() > 0) {
    notifyNodeLeft(removedNodeList);
  }
}
