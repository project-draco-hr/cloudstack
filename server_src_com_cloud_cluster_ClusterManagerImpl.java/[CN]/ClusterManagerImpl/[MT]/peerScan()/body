{
  Date cutTime=DateUtil.currentGMTTime();
  List<ManagementServerHostVO> currentList=_mshostDao.getActiveList(new Date(cutTime.getTime() - heartbeatThreshold));
  List<ManagementServerHostVO> removedNodeList=new ArrayList<ManagementServerHostVO>();
  if (_mshostId != null) {
    for (    Map.Entry<Long,ManagementServerHostVO> entry : activePeers.entrySet()) {
      if (!isIdInList(entry.getKey(),currentList)) {
        if (entry.getKey().longValue() != _mshostId.longValue()) {
          if (s_logger.isDebugEnabled()) {
            s_logger.debug("Detected management node left, id:" + entry.getKey() + ", nodeIP:"+ entry.getValue().getServiceIP());
          }
          removedNodeList.add(entry.getValue());
        }
      }
    }
  }
  Iterator<ManagementServerHostVO> it=removedNodeList.iterator();
  while (it.hasNext()) {
    ManagementServerHostVO mshost=it.next();
    if (!pingManagementNode(mshost.getMsid())) {
      s_logger.warn("Management node " + mshost.getId() + " is detected inactive by timestamp and also not pingable");
      activePeers.remove(mshost.getId());
      try {
        JmxUtil.unregisterMBean("ClusterManager","Node " + mshost.getId());
      }
 catch (      Exception e) {
        s_logger.warn("Unable to deregiester cluster node from JMX monitoring due to exception " + e.toString());
      }
    }
 else {
      s_logger.info("Management node " + mshost.getId() + " is detected inactive by timestamp but is pingable");
      it.remove();
    }
  }
  List<ManagementServerHostVO> newNodeList=new ArrayList<ManagementServerHostVO>();
  for (  ManagementServerHostVO mshost : currentList) {
    if (!activePeers.containsKey(mshost.getId())) {
      activePeers.put(mshost.getId(),mshost);
      if (s_logger.isDebugEnabled()) {
        s_logger.debug("Detected management node joined, id:" + mshost.getId() + ", nodeIP:"+ mshost.getServiceIP());
      }
      newNodeList.add(mshost);
      try {
        JmxUtil.registerMBean("ClusterManager","Node " + mshost.getId(),new ClusterManagerMBeanImpl(this,mshost));
      }
 catch (      Exception e) {
        s_logger.warn("Unable to regiester cluster node into JMX monitoring due to exception " + e.toString());
      }
    }
  }
  if (newNodeList.size() > 0) {
    Profiler profiler=new Profiler();
    profiler.start();
    notifyNodeJoined(newNodeList);
    profiler.stop();
    if (profiler.getDuration() > 1000) {
      if (s_logger.isDebugEnabled())       s_logger.debug("Notifying management server join event took " + profiler.getDuration() + " ms");
    }
 else {
      s_logger.warn("Notifying management server join event took " + profiler.getDuration() + " ms");
    }
  }
  if (removedNodeList.size() > 0) {
    Profiler profiler=new Profiler();
    profiler.start();
    notifyNodeLeft(removedNodeList);
    profiler.stop();
    if (profiler.getDuration() > 1000) {
      if (s_logger.isDebugEnabled())       s_logger.debug("Notifying management server leave event took " + profiler.getDuration() + " ms");
    }
 else {
      s_logger.warn("Notifying management server leave event took " + profiler.getDuration() + " ms");
    }
  }
}
