{
  Date cutTime=DateUtil.currentGMTTime();
  List<ManagementServerHostVO> currentList=_mshostDao.getActiveList(new Date(cutTime.getTime() - heartbeatThreshold));
  List<ManagementServerHostVO> removedNodeList=new ArrayList<ManagementServerHostVO>();
  if (_mshostId != null) {
    for (    Map.Entry<Long,ManagementServerHostVO> entry : activePeers.entrySet()) {
      if (!isIdInList(entry.getKey(),currentList)) {
        if (entry.getKey().longValue() != _mshostId.longValue()) {
          if (s_logger.isDebugEnabled())           s_logger.debug("Detected management node left, id:" + entry.getKey() + ", nodeIP:"+ entry.getValue().getServiceIP());
          removedNodeList.add(entry.getValue());
        }
      }
    }
  }
  for (  ManagementServerHostVO mshost : removedNodeList) {
    activePeers.remove(mshost.getId());
  }
  List<ManagementServerHostVO> newNodeList=new ArrayList<ManagementServerHostVO>();
  for (  ManagementServerHostVO mshost : currentList) {
    if (!activePeers.containsKey(mshost.getId())) {
      activePeers.put(mshost.getId(),mshost);
      if (s_logger.isDebugEnabled())       s_logger.debug("Detected management node joined, id:" + mshost.getId() + ", nodeIP:"+ mshost.getServiceIP());
      newNodeList.add(mshost);
    }
  }
  if (newNodeList.size() > 0)   notifyNodeJoined(newNodeList);
  if (removedNodeList.size() > 0)   notifyNodeLeft(removedNodeList);
}
