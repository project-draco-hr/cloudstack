{
  while (true) {
    try {
      ClusterServicePdu pdu=popIncomingClusterPdu(1000);
      if (pdu == null)       continue;
      if (pdu.isRequest()) {
        String result=dispatchClusterServicePdu(pdu);
        if (result == null)         result="";
        ClusterServicePdu responsePdu=new ClusterServicePdu();
        responsePdu.setSourcePeer(pdu.getDestPeer());
        responsePdu.setDestPeer(pdu.getSourcePeer());
        responsePdu.setAckSequenceId(pdu.getSequenceId());
        responsePdu.setJsonPackage(result);
        addOutgoingClusterPdu(responsePdu);
      }
 else {
        ClusterServiceRequestPdu requestPdu=popRequestPdu(pdu.getAckSequenceId());
        if (requestPdu != null) {
          requestPdu.setResponseResult(pdu.getJsonPackage());
synchronized (requestPdu) {
            requestPdu.notifyAll();
          }
        }
 else {
          s_logger.warn("Original request has already been cancelled. pdu: " + _gson.toJson(pdu));
        }
      }
    }
 catch (    Throwable e) {
      s_logger.error("Unexcpeted exception: ",e);
    }
  }
}
