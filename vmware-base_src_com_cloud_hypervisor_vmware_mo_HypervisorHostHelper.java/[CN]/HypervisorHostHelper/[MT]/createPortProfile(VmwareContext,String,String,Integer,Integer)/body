{
  Map<String,String> vsmCredentials=getValidatedVsmCredentials(context);
  String vsmIp=vsmCredentials.get("vsmip");
  String vsmUserName=vsmCredentials.get("vsmusername");
  String vsmPassword=vsmCredentials.get("vsmpassword");
  String msg;
  NetconfHelper netconfClient;
  try {
    s_logger.info("Connecting to Nexus VSM : " + vsmIp);
    netconfClient=new NetconfHelper(vsmIp,vsmUserName,vsmPassword);
    s_logger.info("Successfully connected to Nexus VSM : " + vsmIp);
  }
 catch (  CloudRuntimeException e) {
    msg="Failed to connect to Nexus VSM " + vsmIp + " with credentials of user "+ vsmUserName;
    s_logger.error(msg);
    throw new CloudRuntimeException(msg);
  }
  List<Pair<OperationType,String>> params=new ArrayList<Pair<OperationType,String>>();
  if (vlanId != null) {
    params.add(new Pair<OperationType,String>(OperationType.addvlanid,vlanId.toString()));
    try {
      s_logger.info("Updating Ethernet port profile " + ethPortProfileName + " with VLAN "+ vlanId);
      netconfClient.updatePortProfile(ethPortProfileName,SwitchPortMode.trunk,params);
      s_logger.info("Added " + vlanId + " to Ethernet port profile "+ ethPortProfileName);
    }
 catch (    CloudRuntimeException e) {
      msg="Failed to modify ethernet port profile " + ethPortProfileName + " with parameters "+ params.toString();
      s_logger.error(msg);
      if (netconfClient != null) {
        netconfClient.disconnect();
        s_logger.debug("Disconnected VSM session.");
      }
      throw new CloudRuntimeException(msg);
    }
  }
  try {
    if (vlanId == null) {
      s_logger.info("Adding port profile configured over untagged VLAN.");
      netconfClient.addPortProfile(networkName,PortProfileType.vethernet,BindingType.portbindingstatic,SwitchPortMode.access,0);
    }
 else {
      s_logger.info("Adding port profile configured over VLAN : " + vlanId.toString());
      netconfClient.addPortProfile(networkName,PortProfileType.vethernet,BindingType.portbindingstatic,SwitchPortMode.access,vlanId.intValue());
    }
  }
 catch (  CloudRuntimeException e) {
    msg="Failed to add vEthernet port profile " + networkName + ". Exception: "+ e.toString();
    s_logger.error(msg);
    if (vlanId == null) {
      s_logger.warn("Ignoring exception : " + e.toString());
    }
  }
 finally {
    if (netconfClient != null) {
      netconfClient.disconnect();
      s_logger.debug("Disconnected VSM session.");
    }
  }
}
