{
  ManagedObjectReference morNetwork=null;
  VmwareContext context=hostMo.getContext();
  ManagedObjectReference morEthernetPortProfile=hostMo.getDvPortGroupMor(ethPortProfileName);
  if (morEthernetPortProfile == null) {
    String msg="Unable to find Ethernet port profile " + ethPortProfileName;
    s_logger.error(msg);
    throw new Exception(msg);
  }
  boolean createGCTag=false;
  String networkName;
  Integer vid=null;
  if (vlanId != null && !UNTAGGED_VLAN_NAME.equalsIgnoreCase(vlanId)) {
    createGCTag=true;
    vid=Integer.parseInt(vlanId);
  }
  networkName=composeCloudNetworkName(namePrefix,vlanId,networkRateMbps,ethPortProfileName);
  DVSTrafficShapingPolicy shapingPolicy=null;
  if (networkRateMbps != null && networkRateMbps.intValue() > 0) {
    shapingPolicy=new DVSTrafficShapingPolicy();
    BoolPolicy isEnabled=new BoolPolicy();
    LongPolicy averageBandwidth=new LongPolicy();
    LongPolicy peakBandwidth=new LongPolicy();
    LongPolicy burstSize=new LongPolicy();
    isEnabled.setValue(true);
    averageBandwidth.setValue((long)networkRateMbps.intValue() * 1024L * 1024L);
    peakBandwidth.setValue((long)(averageBandwidth.getValue() * 1.5));
    burstSize.setValue((long)(5 * averageBandwidth.getValue() / 8));
    shapingPolicy.setEnabled(isEnabled);
    shapingPolicy.setAverageBandwidth(averageBandwidth);
    shapingPolicy.setPeakBandwidth(peakBandwidth);
    shapingPolicy.setBurstSize(burstSize);
  }
  boolean bWaitPortGroupReady=false;
  if (!hostMo.hasDvPortGroup(networkName)) {
    createPortProfile(context,ethPortProfileName,networkName,vid,networkRateMbps);
    bWaitPortGroupReady=true;
  }
 else {
    DVPortgroupConfigSpec spec=hostMo.getDvPortGroupSpec(networkName);
    if (!isSpecMatch(spec,vid,shapingPolicy)) {
      updatePortProfile(context,ethPortProfileName,vid,networkRateMbps);
      bWaitPortGroupReady=true;
    }
  }
  if (bWaitPortGroupReady)   morNetwork=waitForDvPortGroupReady(hostMo,networkName,timeOutMs);
 else   morNetwork=hostMo.getDvPortGroupMor(networkName);
  if (morNetwork == null) {
    String msg="Failed to create guest network " + networkName;
    s_logger.error(msg);
    throw new Exception(msg);
  }
  if (createGCTag) {
    NetworkMO networkMo=new NetworkMO(hostMo.getContext(),morNetwork);
    networkMo.setCustomFieldValue(CustomFieldConstants.CLOUD_GC,"true");
  }
  return new Pair<ManagedObjectReference,String>(morNetwork,networkName);
}
