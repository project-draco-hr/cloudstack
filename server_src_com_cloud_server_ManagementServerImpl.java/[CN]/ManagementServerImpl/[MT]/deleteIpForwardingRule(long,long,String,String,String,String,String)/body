{
  Transaction txn=Transaction.currentTxn();
  boolean locked=false;
  try {
    AccountVO accountVO=_accountDao.findById(accountId);
    if (accountVO == null) {
      throw new PermissionDeniedException("Account does not own supplied address");
    }
    if (!NetUtils.isValidPort(publicPort) || !NetUtils.isValidPort(privatePort)) {
      throw new InvalidParameterValueException("Invalid value for port");
    }
    if (!NetUtils.isValidProto(proto)) {
      throw new InvalidParameterValueException("Invalid protocol");
    }
    IPAddressVO ipVO=_publicIpAddressDao.acquire(publicIp);
    if (ipVO == null) {
      throw new PermissionDeniedException("User does not own supplied address");
    }
    locked=true;
    if ((ipVO.getAllocated() == null) || (ipVO.getAccountId() == null) || (ipVO.getAccountId().longValue() != accountId)) {
      if (!BaseCmd.isAdmin(accountVO.getType())) {
        throw new PermissionDeniedException("User/account does not own supplied address");
      }
    }
    txn.start();
    List<FirewallRuleVO> fwdings=_firewallRulesDao.listIPForwardingForUpdate(publicIp,publicPort,proto);
    FirewallRuleVO fwRule=null;
    if (fwdings.size() == 0) {
      throw new InvalidParameterValueException("No such rule");
    }
 else     if (fwdings.size() == 1) {
      fwRule=fwdings.get(0);
      if (fwRule.getPrivateIpAddress().equalsIgnoreCase(privateIp) && fwRule.getPrivatePort().equals(privatePort)) {
        _firewallRulesDao.delete(fwRule.getId());
      }
 else {
        throw new InvalidParameterValueException("No such rule");
      }
    }
 else {
      throw new InternalErrorException("Multiple matches. Please contact support");
    }
    fwRule.setEnabled(false);
    boolean success=_networkMgr.updateFirewallRule(fwRule,null,null);
    if (!success) {
      throw new InternalErrorException("Failed to update router");
    }
    txn.commit();
    return success;
  }
 catch (  Throwable e) {
    if (e instanceof InvalidParameterValueException) {
      throw (InvalidParameterValueException)e;
    }
 else     if (e instanceof PermissionDeniedException) {
      throw (PermissionDeniedException)e;
    }
 else     if (e instanceof InternalErrorException) {
      s_logger.warn("ManagementServer error",e);
      throw (InternalErrorException)e;
    }
    s_logger.warn("ManagementServer error",e);
  }
 finally {
    if (locked) {
      _publicIpAddressDao.release(publicIp);
    }
  }
  return false;
}
