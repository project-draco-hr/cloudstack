{
  Long ruleId=cmd.getId();
  NetworkRuleConfigVO netRule=null;
  if (ruleId != null) {
    Long userId=UserContext.current().getUserId();
    if (userId == null) {
      userId=User.UID_SYSTEM;
    }
    netRule=_networkRuleConfigDao.findById(ruleId);
    List<SecurityGroupVMMapVO> sgMappings=_securityGroupVMMapDao.listBySecurityGroup(netRule.getSecurityGroupId());
    if ((sgMappings != null) && !sgMappings.isEmpty()) {
      try {
        for (        SecurityGroupVMMapVO sgMapping : sgMappings) {
          UserVm userVm=_userVmDao.findById(sgMapping.getInstanceId());
          createFirewallRule(userId,sgMapping.getIpAddress(),userVm,netRule.getPublicPort(),netRule.getPrivatePort(),netRule.getProtocol(),netRule.getSecurityGroupId());
        }
      }
 catch (      NetworkRuleConflictException ex) {
        netRule.setCreateStatus(AsyncInstanceCreateStatus.Corrupted);
        _networkRuleConfigDao.update(ruleId,netRule);
        throw ex;
      }
    }
    netRule.setCreateStatus(AsyncInstanceCreateStatus.Created);
    _networkRuleConfigDao.update(ruleId,netRule);
  }
  return netRule;
}
