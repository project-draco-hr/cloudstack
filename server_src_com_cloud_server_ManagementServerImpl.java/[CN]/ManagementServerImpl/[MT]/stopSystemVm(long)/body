{
  UserContext context=UserContext.current();
  long callerId=context.getUserId();
  long callerAccountId=context.getAccount().getId();
  VMInstanceVO systemVm=_vmInstanceDao.findByIdTypes(vmId,VirtualMachine.Type.ConsoleProxy,VirtualMachine.Type.SecondaryStorageVm);
  if (systemVm == null) {
    throw new ServerApiException(BaseCmd.PARAM_ERROR,"unable to find a system vm with id " + vmId);
  }
  if (systemVm.getType().equals(VirtualMachine.Type.ConsoleProxy)) {
    long eventId=EventUtils.saveScheduledEvent(callerId,callerAccountId,EventTypes.EVENT_PROXY_STOP,"stopping console proxy with Id: " + vmId);
    return stopConsoleProxy(vmId,eventId);
  }
 else {
    long eventId=EventUtils.saveScheduledEvent(callerId,callerAccountId,EventTypes.EVENT_SSVM_STOP,"stopping secondary storage Vm Id: " + vmId);
    return stopSecondaryStorageVm(vmId,eventId);
  }
}
