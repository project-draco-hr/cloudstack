{
  Account account=(Account)UserContext.current().getAccountObject();
  Long userId=UserContext.current().getUserId();
  Long securityGroupId=cmd.getId();
  String publicIp=cmd.getPublicIp();
  Long vmId=cmd.getVirtualMachineId();
  SecurityGroupVO securityG=_securityGroupDao.findById(securityGroupId);
  if (securityG == null) {
    throw new ServerApiException(BaseCmd.PARAM_ERROR,"unable to find a port forwarding service with id " + securityGroupId);
  }
 else   if (account != null) {
    if (!isAdmin(account.getType()) && (account.getId() != securityG.getAccountId())) {
      throw new ServerApiException(BaseCmd.PARAM_ERROR,"unable to find a port forwarding service with id " + securityGroupId + " for this account");
    }
 else     if (!isChildDomain(account.getDomainId(),securityG.getDomainId())) {
      throw new ServerApiException(BaseCmd.PARAM_ERROR,"Invalid port forwarding service id (" + securityGroupId + ") given, unable to remove port forwarding service.");
    }
  }
  UserVmVO vmInstance=findUserVMInstanceById(vmId.longValue());
  if (vmInstance == null) {
    throw new ServerApiException(BaseCmd.VM_INVALID_PARAM_ERROR,"unable to find a virtual machine with id " + vmId);
  }
  if (account != null) {
    if (!isAdmin(account.getType()) && (account.getId() != vmInstance.getAccountId())) {
      throw new ServerApiException(BaseCmd.VM_INVALID_PARAM_ERROR,"unable to find a virtual machine with id " + vmId + " for this account");
    }
 else     if (!isChildDomain(account.getDomainId(),vmInstance.getDomainId())) {
      throw new ServerApiException(BaseCmd.PARAM_ERROR,"Invalid virtual machine id (" + vmId + ") given, unable to remove port forwarding service.");
    }
  }
  Account ipAddrAccount=findAccountByIpAddress(publicIp);
  if (ipAddrAccount == null) {
    if (account == null) {
      throw new ServerApiException(BaseCmd.PARAM_ERROR,"Unable to find ip address " + publicIp);
    }
 else {
      throw new ServerApiException(BaseCmd.PARAM_ERROR,"account " + account.getAccountName() + " doesn't own ip address "+ publicIp);
    }
  }
  Long accountId=ipAddrAccount.getId();
  if ((account != null) && !isAdmin(account.getType())) {
    if (account.getId() != accountId) {
      throw new ServerApiException(BaseCmd.PARAM_ERROR,"account " + account.getAccountName() + " doesn't own ip address "+ publicIp);
    }
  }
  if (userId == null) {
    userId=Long.valueOf(1);
  }
  long eventId=EventUtils.saveScheduledEvent(userId,vmInstance.getAccountId(),EventTypes.EVENT_PORT_FORWARDING_SERVICE_REMOVE,"removing port forwarding services for Vm with Id: " + vmId);
  removeSecurityGroup(userId,securityGroupId,publicIp,vmId,eventId);
}
