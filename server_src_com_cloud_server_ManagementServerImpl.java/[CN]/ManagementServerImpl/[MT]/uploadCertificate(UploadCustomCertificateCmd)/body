{
  try {
    CertificateVO cert=_certDao.listAll().get(0);
    if (cert.getMgmtServerId() != null)     throw new ResourceUnavailableException("Another management server is in the process of custom cert updating");
    if (cert.getUpdated().equalsIgnoreCase("Y")) {
      if (s_logger.isDebugEnabled())       s_logger.debug("A custom certificate already exists in the DB, will replace it with the new one being uploaded");
    }
 else {
      if (s_logger.isDebugEnabled())       s_logger.debug("No custom certificate exists in the DB, will upload a new one");
    }
    String certificatePath=cmd.getPath();
    CertificateVO lockedCert=_certDao.acquire(cert.getId());
    Long certVOId=_certDao.persistCustomCertToDb(certificatePath,lockedCert,this.getId());
    _certDao.release(lockedCert.getId());
    if (certVOId != null && certVOId != 0) {
      List<ConsoleProxyVO> cpList=_consoleProxyDao.listAll();
      if (cpList.size() == 0) {
        releaseCertRecord(cert);
        String msg="Unable to find any console proxies in the system for certificate update";
        s_logger.warn(msg);
        throw new ResourceUnavailableException(msg);
      }
      List<HostVO> cpHosts=_hostDao.listByType(com.cloud.host.Host.Type.ConsoleProxy);
      if (cpHosts.size() == 0) {
        releaseCertRecord(cert);
        String msg="Unable to find any console proxy hosts in the system for certificate update";
        s_logger.warn(msg);
        throw new ResourceUnavailableException(msg);
      }
      Map<String,Long> hostNameToHostIdMap=new HashMap<String,Long>();
      List<Long> updatedCpIdList=new ArrayList<Long>();
      for (      HostVO cpHost : cpHosts) {
        hostNameToHostIdMap.put(cpHost.getName(),cpHost.getId());
      }
      for (      ConsoleProxyVO cp : cpList) {
        Long cpHostId=hostNameToHostIdMap.get(cp.getName());
        UpdateCertificateCommand certCmd=new UpdateCertificateCommand(_certDao.findById(certVOId).getCertificate(),false);
        try {
          Answer updateCertAns=_agentMgr.send(cpHostId,certCmd);
          if (updateCertAns.getResult() == true) {
            long eventId=saveScheduledEvent(User.UID_SYSTEM,Account.ACCOUNT_ID_SYSTEM,EventTypes.EVENT_PROXY_REBOOT,"rebooting console proxy with Id: " + cp.getId());
            _consoleProxyMgr.rebootProxy(cp.getId(),eventId);
            if (s_logger.isDebugEnabled())             s_logger.debug("Successfully updated custom certificate on console proxy vm id:" + cp.getId() + " ,console proxy host id:"+ cpHostId);
            updatedCpIdList.add(cp.getId());
          }
        }
 catch (        AgentUnavailableException e) {
          s_logger.warn("Unable to send update certificate command to the console proxy resource as agent is unavailable for console proxy vm id:" + cp.getId() + " ,console proxy host id:"+ cpHostId,e);
        }
catch (        OperationTimedoutException e) {
          s_logger.warn("Unable to send update certificate command to the console proxy resource as there was a timeout for console proxy vm id:" + cp.getId() + " ,console proxy host id:"+ cpHostId,e);
        }
      }
      releaseCertRecord(cert);
      if (updatedCpIdList.size() == cpList.size()) {
        return ("Updated:" + updatedCpIdList.size() + " out of:"+ cpList.size()+ " console proxies");
      }
 else {
        throw new ManagementServerException("Updated:" + updatedCpIdList.size() + " out of:"+ cpList.size()+ " console proxies with successfully updated console proxy ids being:"+ updatedCpIdList.toString());
      }
    }
 else {
      return null;
    }
  }
 catch (  Exception e) {
    s_logger.warn("Failed to successfully update the cert across console proxies on management server:" + this.getId());
    if (e instanceof ResourceUnavailableException)     throw new ServerApiException(BaseCmd.CUSTOM_CERT_UPDATE_ERROR,e.getMessage());
    if (e instanceof ManagementServerException)     throw new ServerApiException(BaseCmd.CUSTOM_CERT_UPDATE_ERROR,e.getMessage());
  }
  return null;
}
