{
  Transaction txn=Transaction.currentTxn();
  LoadBalancerVO loadBalancer=null;
  LoadBalancerVO loadBalancerLock=null;
  try {
    loadBalancer=_loadBalancerDao.findById(loadBalancerId);
    if (loadBalancer == null) {
      return false;
    }
    IPAddressVO ipAddress=_publicIpAddressDao.findById(loadBalancer.getIpAddress());
    if (ipAddress == null) {
      return false;
    }
    DomainRouterVO router=_routerDao.findBy(ipAddress.getAccountId(),ipAddress.getDataCenterId());
    List<FirewallRuleVO> fwRules=_firewallRulesDao.listByLoadBalancerId(loadBalancerId);
    txn.start();
    if ((fwRules != null) && !fwRules.isEmpty()) {
      for (      FirewallRuleVO fwRule : fwRules) {
        fwRule.setEnabled(false);
        _firewallRulesDao.update(fwRule.getId(),fwRule);
      }
      List<FirewallRuleVO> allLbRules=new ArrayList<FirewallRuleVO>();
      List<IPAddressVO> ipAddrs=_networkMgr.listPublicIpAddressesInVirtualNetwork(loadBalancer.getAccountId(),ipAddress.getDataCenterId(),null);
      for (      IPAddressVO ipv : ipAddrs) {
        List<FirewallRuleVO> rules=_firewallRulesDao.listIPForwarding(ipv.getAddress(),false);
        allLbRules.addAll(rules);
      }
      _networkMgr.updateFirewallRules(loadBalancer.getIpAddress(),allLbRules,router);
      loadBalancerLock=_loadBalancerDao.acquire(loadBalancerId);
      if (loadBalancerLock == null) {
        s_logger.warn("deleteLoadBalancer: failed to lock load balancer " + loadBalancerId + ", deleting mappings anyway...");
      }
      _loadBalancerVMMapDao.remove(loadBalancerId);
      String description;
      String type=EventTypes.EVENT_NET_RULE_DELETE;
      String ruleName="load balancer";
      String level=EventVO.LEVEL_INFO;
      Account account=_accountDao.findById(loadBalancer.getAccountId());
      for (      FirewallRuleVO updatedRule : fwRules) {
        _firewallRulesDao.remove(updatedRule.getId());
        description="deleted " + ruleName + " rule ["+ updatedRule.getPublicIpAddress()+ ":"+ updatedRule.getPublicPort()+ "]->["+ updatedRule.getPrivateIpAddress()+ ":"+ updatedRule.getPrivatePort()+ "]"+ " "+ updatedRule.getProtocol();
        EventUtils.saveEvent(userId,account.getId(),level,type,description);
      }
    }
    txn.commit();
  }
 catch (  Exception ex) {
    txn.rollback();
    s_logger.error("Unexpected exception deleting load balancer " + loadBalancerId,ex);
    return false;
  }
 finally {
    if (loadBalancerLock != null) {
      _loadBalancerDao.release(loadBalancerId);
    }
  }
  boolean success=_loadBalancerDao.remove(loadBalancerId);
  EventVO event=new EventVO();
  event.setUserId(userId);
  event.setAccountId(loadBalancer.getAccountId());
  event.setType(EventTypes.EVENT_LOAD_BALANCER_DELETE);
  if (success) {
    event.setLevel(EventVO.LEVEL_INFO);
    String params="id=" + loadBalancer.getId();
    event.setParameters(params);
    event.setDescription("Successfully deleted load balancer " + loadBalancer.getName() + " (id:"+ loadBalancer.getId()+ ")");
  }
 else {
    event.setLevel(EventVO.LEVEL_ERROR);
    event.setDescription("Failed to delete load balancer " + loadBalancer.getName() + " (id:"+ loadBalancer.getId()+ ")");
  }
  _eventDao.persist(event);
  return success;
}
