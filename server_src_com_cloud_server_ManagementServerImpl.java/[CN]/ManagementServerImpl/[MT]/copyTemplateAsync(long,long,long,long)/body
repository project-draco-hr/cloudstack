{
  UserVO user=_userDao.findById(userId);
  if (user == null) {
    throw new InvalidParameterValueException("Please specify a valid user.");
  }
  VMTemplateVO template=_templateDao.findById(templateId);
  if (template == null) {
    throw new InvalidParameterValueException("Please specify a valid template/ISO.");
  }
  if (template.getFormat().equals(ImageFormat.ISO) && template.getName().equals("xs-tools.iso")) {
    throw new InvalidParameterValueException("The XenServer Tools ISO cannot be copied.");
  }
  DataCenterVO sourceZone=_dcDao.findById(sourceZoneId);
  if (sourceZone == null) {
    throw new InvalidParameterValueException("Please specify a valid source zone.");
  }
  DataCenterVO destZone=_dcDao.findById(destZoneId);
  if (destZone == null) {
    throw new InvalidParameterValueException("Please specify a valid destination zone.");
  }
  if (sourceZoneId == destZoneId) {
    throw new InvalidParameterValueException("Please specify different source and destination zones.");
  }
  HostVO srcSecHost=_hostDao.findSecondaryStorageHost(sourceZoneId);
  if (srcSecHost == null) {
    throw new InvalidParameterValueException("Source zone is not ready");
  }
  if (_hostDao.findSecondaryStorageHost(destZoneId) == null) {
    throw new InvalidParameterValueException("Destination zone is not ready.");
  }
  VMTemplateHostVO srcTmpltHost=null;
  srcTmpltHost=_templateHostDao.findByHostTemplate(srcSecHost.getId(),templateId);
  if (srcTmpltHost == null || srcTmpltHost.getDestroyed() || srcTmpltHost.getDownloadState() != VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {
    throw new InvalidParameterValueException("Please specify a template that is installed on secondary storage host: " + srcSecHost.getName());
  }
  long eventId=EventUtils.saveScheduledEvent(userId,template.getAccountId(),EventTypes.EVENT_TEMPLATE_COPY,"copying template with Id: " + templateId + " from zone: "+ sourceZoneId+ " to: "+ destZoneId);
  CopyTemplateParam param=new CopyTemplateParam(userId,templateId,sourceZoneId,destZoneId,eventId);
  Gson gson=GsonHelper.getBuilder().create();
  AsyncJobVO job=new AsyncJobVO();
  job.setUserId(UserContext.current().getUserId());
  job.setAccountId(template.getAccountId());
  job.setCmd("CopyTemplate");
  job.setCmdInfo(gson.toJson(param));
  job.setCmdOriginator(CopyTemplateCmd.getStaticName());
  return _asyncMgr.submitAsyncJob(job);
}
