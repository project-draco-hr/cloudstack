{
  String name=cmd.getDomainName();
  Long parentId=cmd.getParentDomainId();
  Long ownerId=UserContext.current().getAccountId();
  Account account=UserContext.current().getAccount();
  if (ownerId == null) {
    ownerId=Long.valueOf(1);
  }
  if (parentId == null) {
    parentId=Long.valueOf(DomainVO.ROOT_DOMAIN);
  }
  DomainVO parentDomain=_domainDao.findById(parentId);
  if (parentDomain == null) {
    throw new InvalidParameterValueException("Unable to create domain " + name + ", parent domain "+ parentId+ " not found.");
  }
  if ((account != null) && !_domainDao.isChildDomain(account.getDomainId(),parentId)) {
    throw new PermissionDeniedException("Unable to create domain " + name + ", permission denied.");
  }
  SearchCriteria<DomainVO> sc=_domainDao.createSearchCriteria();
  sc.addAnd("name",SearchCriteria.Op.EQ,name);
  sc.addAnd("parent",SearchCriteria.Op.EQ,parentId);
  List<DomainVO> domains=_domainDao.search(sc,null);
  if ((domains == null) || domains.isEmpty()) {
    DomainVO domain=new DomainVO(name,ownerId,parentId);
    try {
      DomainVO dbDomain=_domainDao.create(domain);
      EventUtils.saveEvent(new Long(1),ownerId,EventVO.LEVEL_INFO,EventTypes.EVENT_DOMAIN_CREATE,"Domain, " + name + " created with owner id = "+ ownerId+ " and parentId "+ parentId);
      return dbDomain;
    }
 catch (    IllegalArgumentException ex) {
      EventUtils.saveEvent(new Long(1),ownerId,EventVO.LEVEL_ERROR,EventTypes.EVENT_DOMAIN_CREATE,"Domain, " + name + " was not created with owner id = "+ ownerId+ " and parentId "+ parentId);
      throw ex;
    }
  }
 else {
    EventUtils.saveEvent(new Long(1),ownerId,EventVO.LEVEL_ERROR,EventTypes.EVENT_DOMAIN_CREATE,"Domain, " + name + " was not created with owner id = "+ ownerId+ " and parentId "+ parentId);
  }
  return null;
}
