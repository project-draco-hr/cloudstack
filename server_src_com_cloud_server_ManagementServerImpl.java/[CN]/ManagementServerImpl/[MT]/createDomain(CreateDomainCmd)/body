{
  String name=cmd.getDomainName();
  Long parentId=cmd.getParentDomainId();
  Long ownerId=UserContext.current().getCaller().getId();
  Account account=UserContext.current().getCaller();
  if (ownerId == null) {
    ownerId=Long.valueOf(1);
  }
  if (parentId == null) {
    parentId=Long.valueOf(DomainVO.ROOT_DOMAIN);
  }
  DomainVO parentDomain=_domainDao.findById(parentId);
  if (parentDomain == null) {
    throw new InvalidParameterValueException("Unable to create domain " + name + ", parent domain "+ parentId+ " not found.");
  }
  if ((account != null) && !_domainDao.isChildDomain(account.getDomainId(),parentId)) {
    throw new PermissionDeniedException("Unable to create domain " + name + ", permission denied.");
  }
  SearchCriteria<DomainVO> sc=_domainDao.createSearchCriteria();
  sc.addAnd("name",SearchCriteria.Op.EQ,name);
  sc.addAnd("parent",SearchCriteria.Op.EQ,parentId);
  List<DomainVO> domains=_domainDao.search(sc,null);
  if ((domains == null) || domains.isEmpty()) {
    DomainVO domain=new DomainVO(name,ownerId,parentId);
    try {
      return _domainDao.create(domain);
    }
 catch (    IllegalArgumentException ex) {
      s_logger.warn("Failed to create domain ",ex);
      throw ex;
    }
  }
 else {
    throw new InvalidParameterValueException("Domain with name " + name + " already exists for the parent id="+ parentId);
  }
}
