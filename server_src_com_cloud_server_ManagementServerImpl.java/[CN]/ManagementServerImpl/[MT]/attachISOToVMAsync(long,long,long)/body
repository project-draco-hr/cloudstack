{
  UserVmVO vm=_userVmDao.findById(vmId);
  if (vm == null) {
    throw new InvalidParameterValueException("Unable to find VM with ID " + vmId);
  }
  VMTemplateVO iso=_templateDao.findById(isoId);
  if (iso == null || !iso.getFormat().equals(ImageFormat.ISO)) {
    throw new InvalidParameterValueException("Unable to find ISO with id " + isoId);
  }
  AccountVO account=_accountDao.findById(vm.getAccountId());
  if (account == null) {
    throw new InvalidParameterValueException("Unable to find account for VM with ID " + vmId);
  }
  State vmState=vm.getState();
  if (vmState != State.Running && vmState != State.Stopped) {
    throw new InvalidParameterValueException("Please specify a VM that is either Stopped or Running.");
  }
  long eventId=saveScheduledEvent(userId,account.getId(),EventTypes.EVENT_ISO_ATTACH,"attaching ISO: " + isoId + " to Vm: "+ vmId);
  AttachISOParam param=new AttachISOParam(vmId,userId,isoId,true);
  param.setEventId(eventId);
  Gson gson=GsonHelper.getBuilder().create();
  AsyncJobVO job=new AsyncJobVO();
  job.setUserId(UserContext.current().getUserId());
  job.setAccountId(vm.getAccountId());
  job.setCmd("AttachISO");
  job.setCmdInfo(gson.toJson(param));
  return _asyncMgr.submitAsyncJob(job,true);
}
