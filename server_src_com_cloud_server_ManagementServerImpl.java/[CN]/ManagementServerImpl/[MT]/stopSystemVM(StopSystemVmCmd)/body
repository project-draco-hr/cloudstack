{
  Long id=cmd.getId();
  VMInstanceVO systemVm=_vmInstanceDao.findByIdTypes(id,VirtualMachine.Type.ConsoleProxy,VirtualMachine.Type.SecondaryStorageVm);
  if (systemVm == null) {
    throw new InvalidParameterValueException("unable to find a system vm with id " + id);
  }
  User caller=_userDao.findById(UserContext.current().getCallerUserId());
  try {
    if (_itMgr.advanceStop(systemVm,cmd.isForced(),caller,UserContext.current().getCaller())) {
      if (systemVm.getType() == VirtualMachine.Type.ConsoleProxy) {
        return _consoleProxyDao.findById(systemVm.getId());
      }
 else       if (systemVm.getType() == VirtualMachine.Type.SecondaryStorageVm) {
        return _secStorageVmDao.findById(systemVm.getId());
      }
    }
    return null;
  }
 catch (  OperationTimedoutException e) {
    throw new CloudRuntimeException("Unable to stop " + systemVm,e);
  }
}
