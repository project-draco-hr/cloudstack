{
  LoadBalancerVO loadBalancer=_loadBalancerDao.findById(loadBalancerId);
  if (loadBalancer == null) {
    return null;
  }
  List<UserVmVO> loadBalancerInstances=new ArrayList<UserVmVO>();
  List<LoadBalancerVMMapVO> vmLoadBalancerMappings=null;
  if (applied) {
    vmLoadBalancerMappings=_loadBalancerVMMapDao.listByLoadBalancerId(loadBalancerId,false);
  }
 else {
    vmLoadBalancerMappings=_loadBalancerVMMapDao.listByLoadBalancerId(loadBalancerId);
  }
  List<Long> appliedInstanceIdList=new ArrayList<Long>();
  if ((vmLoadBalancerMappings != null) && !vmLoadBalancerMappings.isEmpty()) {
    for (    LoadBalancerVMMapVO vmLoadBalancerMapping : vmLoadBalancerMappings) {
      appliedInstanceIdList.add(vmLoadBalancerMapping.getInstanceId());
    }
  }
  IPAddressVO addr=_publicIpAddressDao.findById(loadBalancer.getIpAddress());
  List<UserVmVO> userVms=_userVmDao.listVirtualNetworkInstancesByAcctAndZone(loadBalancer.getAccountId(),addr.getDataCenterId());
  for (  UserVmVO userVm : userVms) {
switch (userVm.getState()) {
case Destroyed:
case Expunging:
case Error:
case Unknown:
      continue;
  }
  boolean isApplied=appliedInstanceIdList.contains(userVm.getId());
  if (!applied && !isApplied) {
    loadBalancerInstances.add(userVm);
  }
 else   if (applied && isApplied) {
    loadBalancerInstances.add(userVm);
  }
}
return loadBalancerInstances;
}
