{
  VMTemplateVO template=null;
  if (templateId != null) {
    template=_templateDao.findById(templateId);
    if (template == null) {
      throw new InvalidParameterValueException("Please specify a valid template ID.");
    }
    if (isIso && template.getFormat() != ImageFormat.ISO) {
      s_logger.error("Template Id " + templateId + " is not an ISO");
      throw new InvalidParameterValueException("Template Id " + templateId + " is not an ISO");
    }
    if (!isIso && template.getFormat() == ImageFormat.ISO) {
      s_logger.error("Incorrect format of the template id " + templateId);
      throw new InvalidParameterValueException("Incorrect format " + template.getFormat() + " of the template id "+ templateId);
    }
  }
  boolean onlyReady=(templateFilter == TemplateFilter.featured) || (templateFilter == TemplateFilter.selfexecutable) || (templateFilter == TemplateFilter.sharedexecutable)|| (templateFilter == TemplateFilter.executable && isAccountSpecific)|| (templateFilter == TemplateFilter.community);
  Account account=null;
  DomainVO domain=null;
  if (accountId != null) {
    account=_accountDao.findById(accountId);
    domain=_domainDao.findById(account.getDomainId());
  }
 else {
    domain=_domainDao.findById(DomainVO.ROOT_DOMAIN);
  }
  Set<Pair<Long,Long>> templateZonePairSet=new HashSet<Pair<Long,Long>>();
  if (template == null) {
    templateZonePairSet=_templateDao.searchTemplates(name,keyword,templateFilter,isIso,bootable,account,domain,pageSize,startIndex,zoneId,hyperType,onlyReady,showDomr);
  }
 else {
    templateZonePairSet.add(new Pair<Long,Long>(template.getId(),zoneId));
  }
  return templateZonePairSet;
}
