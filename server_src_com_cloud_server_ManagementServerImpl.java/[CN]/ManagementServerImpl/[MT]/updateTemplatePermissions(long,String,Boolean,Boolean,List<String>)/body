{
  Transaction txn=Transaction.currentTxn();
  VMTemplateVO template=_templateDao.findById(templateId);
  if (template == null) {
    throw new InvalidParameterValueException("Unable to find template with id " + templateId);
  }
  Long accountId=template.getAccountId();
  if (accountId == null) {
    throw new InvalidParameterValueException("Update template permissions is an invalid operation on template " + template.getName());
  }
  Account account=_accountDao.findById(accountId);
  if (account == null) {
    throw new PermissionDeniedException("Unable to verify owner of template " + template.getName());
  }
  VMTemplateVO updatedTemplate=_templateDao.createForUpdate();
  if (isPublic != null) {
    updatedTemplate.setPublicTemplate(isPublic.booleanValue());
  }
  if (isFeatured != null) {
    updatedTemplate.setFeatured(isFeatured.booleanValue());
  }
  _templateDao.update(template.getId(),updatedTemplate);
  Long domainId=account.getDomainId();
  if ("add".equalsIgnoreCase(operation)) {
    txn.start();
    for (    String accountName : accountNames) {
      Account permittedAccount=_accountDao.findActiveAccount(accountName,domainId);
      if (permittedAccount != null) {
        if (permittedAccount.getId().longValue() == account.getId().longValue()) {
          continue;
        }
        LaunchPermissionVO existingPermission=_launchPermissionDao.findByTemplateAndAccount(templateId,permittedAccount.getId().longValue());
        if (existingPermission == null) {
          LaunchPermissionVO launchPermission=new LaunchPermissionVO(templateId,permittedAccount.getId().longValue());
          _launchPermissionDao.persist(launchPermission);
        }
      }
 else {
        txn.rollback();
        throw new InvalidParameterValueException("Unable to grant a launch permission to account " + accountName + ", account not found.  "+ "No permissions updated, please verify the account names and retry.");
      }
    }
    txn.commit();
  }
 else   if ("remove".equalsIgnoreCase(operation)) {
    try {
      List<Long> accountIds=new ArrayList<Long>();
      for (      String accountName : accountNames) {
        Account permittedAccount=_accountDao.findActiveAccount(accountName,domainId);
        if (permittedAccount != null) {
          accountIds.add(permittedAccount.getId());
        }
      }
      _launchPermissionDao.removePermissions(templateId,accountIds);
    }
 catch (    CloudRuntimeException ex) {
      throw new InternalErrorException("Internal error removing launch permissions for template " + template.getName());
    }
  }
 else   if ("reset".equalsIgnoreCase(operation)) {
    updatedTemplate=_templateDao.createForUpdate();
    updatedTemplate.setPublicTemplate(false);
    updatedTemplate.setFeatured(false);
    _templateDao.update(template.getId(),updatedTemplate);
    _launchPermissionDao.removeAllPermissions(templateId);
  }
  return true;
}
