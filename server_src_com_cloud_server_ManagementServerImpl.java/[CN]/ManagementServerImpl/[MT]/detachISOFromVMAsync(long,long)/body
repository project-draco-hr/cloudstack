{
  UserVm userVM=_userVmDao.findById(vmId);
  if (userVM == null) {
    throw new InvalidParameterValueException("Please specify a valid VM.");
  }
  Long isoId=userVM.getIsoId();
  if (isoId == null) {
    throw new InvalidParameterValueException("The specified VM has no ISO attached to it.");
  }
  State vmState=userVM.getState();
  if (vmState != State.Running && vmState != State.Stopped) {
    throw new InvalidParameterValueException("Please specify a VM that is either Stopped or Running.");
  }
  long eventId=saveScheduledEvent(userId,userVM.getAccountId(),EventTypes.EVENT_ISO_DETACH,"detaching ISO: " + isoId + " from Vm: "+ vmId);
  AttachISOParam param=new AttachISOParam(vmId,userId,isoId.longValue(),false);
  param.setEventId(eventId);
  Gson gson=GsonHelper.getBuilder().create();
  AsyncJobVO job=new AsyncJobVO();
  job.setUserId(UserContext.current().getUserId());
  job.setAccountId(userVM.getAccountId());
  job.setCmd("AttachISO");
  job.setCmdInfo(gson.toJson(param));
  return _asyncMgr.submitAsyncJob(job,true);
}
