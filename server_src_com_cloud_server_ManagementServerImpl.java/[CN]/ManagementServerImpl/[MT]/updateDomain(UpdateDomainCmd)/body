{
  Long domainId=cmd.getId();
  String domainName=cmd.getDomainName();
  DomainVO domain=_domainDao.findById(domainId);
  if (domain == null) {
    throw new InvalidParameterValueException("Unable to find domain " + domainId);
  }
 else   if (domain.getParent() == null) {
    throw new InvalidParameterValueException("ROOT domain can not be edited");
  }
  Account account=UserContext.current().getCaller();
  if ((account != null) && !isChildDomain(account.getDomainId(),domain.getId())) {
    throw new PermissionDeniedException("Unable to update domain " + domainId + ", permission denied");
  }
  if (domainName == null || domainName.equals(domain.getName())) {
    return _domainDao.findById(domainId);
  }
  SearchCriteria<DomainVO> sc=_domainDao.createSearchCriteria();
  sc.addAnd("name",SearchCriteria.Op.EQ,domainName);
  List<DomainVO> domains=_domainDao.search(sc,null);
  if ((domains == null) || domains.isEmpty()) {
    domain=_domainDao.findById(domainId);
    String updatedDomainPath=getUpdatedDomainPath(domain.getPath(),domainName);
    updateDomainChildren(domain,updatedDomainPath);
    _domainDao.update(domainId,domainName,updatedDomainPath);
    return _domainDao.findById(domainId);
  }
 else {
    domain=_domainDao.findById(domainId);
    s_logger.error("Domain with name " + domainName + " already exists in the system");
    throw new CloudRuntimeException("Failed to update domain " + domainId);
  }
}
