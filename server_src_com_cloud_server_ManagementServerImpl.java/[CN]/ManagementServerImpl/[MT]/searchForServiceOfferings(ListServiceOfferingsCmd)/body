{
  Filter searchFilter=new Filter(ServiceOfferingVO.class,"created",false,cmd.getStartIndex(),cmd.getPageSizeVal());
  SearchCriteria<ServiceOfferingVO> sc=_offeringsDao.createSearchCriteria();
  Account account=UserContext.current().getCaller();
  Object name=cmd.getServiceOfferingName();
  Object id=cmd.getId();
  Object keyword=cmd.getKeyword();
  Long vmId=cmd.getVirtualMachineId();
  Long domainId=cmd.getDomainId();
  Boolean issystem=cmd.getIsSystem();
  String vm_type_str=cmd.getSystemVmType();
  if (domainId != null) {
    if (account.getType() == Account.ACCOUNT_TYPE_ADMIN) {
      if (account.getDomainId() != 1 && issystem) {
        throw new InvalidParameterValueException("Non ROOT admins cannot access system's offering");
      }
      return _offeringsDao.findSystemOffering(domainId,issystem,vm_type_str);
    }
 else {
      if (issystem) {
        throw new InvalidParameterValueException("Non root users cannot access system's offering");
      }
      if (isPermissible(account.getDomainId(),domainId)) {
        return _offeringsDao.findSystemOffering(domainId,false,vm_type_str);
      }
 else {
        throw new PermissionDeniedException("The account:" + account.getAccountName() + " does not fall in the same domain hierarchy as the service offering");
      }
    }
  }
  if ((account.getType() == Account.ACCOUNT_TYPE_NORMAL || account.getType() == Account.ACCOUNT_TYPE_DOMAIN_ADMIN) || account.getType() == Account.ACCOUNT_TYPE_RESOURCE_DOMAIN_ADMIN) {
    if (issystem) {
      throw new InvalidParameterValueException("Only root admins can access system's offering");
    }
    return searchServiceOfferingsInternal(account,name,id,vmId,keyword,searchFilter);
  }
  if (account.getDomainId() != 1 && issystem) {
    throw new InvalidParameterValueException("Non ROOT admins cannot access system's offering");
  }
  if (keyword != null) {
    SearchCriteria<ServiceOfferingVO> ssc=_offeringsDao.createSearchCriteria();
    ssc.addOr("displayText",SearchCriteria.Op.LIKE,"%" + keyword + "%");
    ssc.addOr("name",SearchCriteria.Op.LIKE,"%" + keyword + "%");
    sc.addAnd("name",SearchCriteria.Op.SC,ssc);
  }
 else   if (vmId != null) {
    UserVmVO vmInstance=_userVmDao.findById(vmId);
    if ((vmInstance == null) || (vmInstance.getRemoved() != null)) {
      throw new InvalidParameterValueException("unable to find a virtual machine with id " + vmId);
    }
    if ((account != null) && !isAdmin(account.getType())) {
      if (account.getId() != vmInstance.getAccountId()) {
        throw new PermissionDeniedException("unable to find a virtual machine with id " + vmId + " for this account");
      }
    }
    ServiceOfferingVO offering=_offeringsDao.findByIdIncludingRemoved(vmInstance.getServiceOfferingId());
    sc.addAnd("id",SearchCriteria.Op.NEQ,offering.getId());
    sc.addAnd("useLocalStorage",SearchCriteria.Op.EQ,offering.getUseLocalStorage());
  }
  if (id != null) {
    sc.addAnd("id",SearchCriteria.Op.EQ,id);
  }
  if (name != null) {
    sc.addAnd("name",SearchCriteria.Op.LIKE,"%" + name + "%");
  }
  if (vm_type_str != null) {
    sc.addAnd("vm_type",SearchCriteria.Op.EQ,vm_type_str);
  }
  sc.addAnd("systemUse",SearchCriteria.Op.EQ,issystem);
  sc.addAnd("removed",SearchCriteria.Op.NULL);
  return _offeringsDao.search(sc,searchFilter);
}
