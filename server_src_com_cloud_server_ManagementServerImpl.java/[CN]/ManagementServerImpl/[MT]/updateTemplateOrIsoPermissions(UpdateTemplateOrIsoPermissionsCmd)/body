{
  Transaction txn=Transaction.currentTxn();
  Long id=cmd.getId();
  Account account=UserContext.current().getCaller();
  List<String> accountNames=cmd.getAccountNames();
  Long userId=UserContext.current().getCallerUserId();
  Boolean isFeatured=cmd.isFeatured();
  Boolean isPublic=cmd.isPublic();
  String operation=cmd.getOperation();
  String mediaType="";
  VMTemplateVO template=_templateDao.findById(id);
  if (template == null || !templateIsCorrectType(template)) {
    throw new InvalidParameterValueException("unable to find " + mediaType + " with id "+ id);
  }
  if (cmd instanceof UpdateTemplatePermissionsCmd) {
    mediaType="template";
    if (template.getFormat().equals(ImageFormat.ISO)) {
      throw new InvalidParameterValueException("Please provide a valid template");
    }
  }
  if (cmd instanceof UpdateIsoPermissionsCmd) {
    mediaType="iso";
    if (!template.getFormat().equals(ImageFormat.ISO)) {
      throw new InvalidParameterValueException("Please provide a valid iso");
    }
  }
  _accountMgr.checkAccess(account,template);
  if (userId == null) {
    userId=Long.valueOf(User.UID_SYSTEM);
  }
  if (template.getRemoved() != null) {
    s_logger.error("unable to update permissions for " + mediaType + " with id "+ id+ " as it is removed  ");
    throw new InvalidParameterValueException("unable to update permissions for " + mediaType + " with id "+ id+ " as it is removed ");
  }
  if (id == Long.valueOf(1)) {
    throw new InvalidParameterValueException("unable to update permissions for " + mediaType + " with id "+ id);
  }
  boolean isAdmin=((account == null) || isAdmin(account.getType()));
  boolean allowPublicUserTemplates=Boolean.parseBoolean(getConfigurationValue("allow.public.user.templates"));
  if (!isAdmin && !allowPublicUserTemplates && isPublic != null && isPublic) {
    throw new InvalidParameterValueException("Only private " + mediaType + "s can be created.");
  }
  if (accountNames != null) {
    if ((operation == null) || (!operation.equalsIgnoreCase("add") && !operation.equalsIgnoreCase("remove") && !operation.equalsIgnoreCase("reset"))) {
      throw new InvalidParameterValueException("Invalid operation on accounts, the operation must be either 'add' or 'remove' in order to modify launch permissions." + "  Given operation is: '" + operation + "'");
    }
  }
  Long accountId=template.getAccountId();
  if (accountId == null) {
    throw new InvalidParameterValueException("Update template permissions is an invalid operation on template " + template.getName());
  }
  VMTemplateVO updatedTemplate=_templateDao.createForUpdate();
  if (isPublic != null) {
    updatedTemplate.setPublicTemplate(isPublic.booleanValue());
  }
  if (isFeatured != null) {
    updatedTemplate.setFeatured(isFeatured.booleanValue());
  }
  _templateDao.update(template.getId(),updatedTemplate);
  Long domainId;
  domainId=(null == account) ? DomainVO.ROOT_DOMAIN : account.getDomainId();
  if ("add".equalsIgnoreCase(operation)) {
    txn.start();
    for (    String accountName : accountNames) {
      Account permittedAccount=_accountDao.findActiveAccount(accountName,domainId);
      if (permittedAccount != null) {
        if (permittedAccount.getId() == account.getId()) {
          continue;
        }
        LaunchPermissionVO existingPermission=_launchPermissionDao.findByTemplateAndAccount(id,permittedAccount.getId());
        if (existingPermission == null) {
          LaunchPermissionVO launchPermission=new LaunchPermissionVO(id,permittedAccount.getId());
          _launchPermissionDao.persist(launchPermission);
        }
      }
 else {
        txn.rollback();
        throw new InvalidParameterValueException("Unable to grant a launch permission to account " + accountName + ", account not found.  "+ "No permissions updated, please verify the account names and retry.");
      }
    }
    txn.commit();
  }
 else   if ("remove".equalsIgnoreCase(operation)) {
    List<Long> accountIds=new ArrayList<Long>();
    for (    String accountName : accountNames) {
      Account permittedAccount=_accountDao.findActiveAccount(accountName,domainId);
      if (permittedAccount != null) {
        accountIds.add(permittedAccount.getId());
      }
    }
    _launchPermissionDao.removePermissions(id,accountIds);
  }
 else   if ("reset".equalsIgnoreCase(operation)) {
    updatedTemplate=_templateDao.createForUpdate();
    updatedTemplate.setPublicTemplate(false);
    updatedTemplate.setFeatured(false);
    _templateDao.update(template.getId(),updatedTemplate);
    _launchPermissionDao.removeAllPermissions(id);
  }
  return true;
}
