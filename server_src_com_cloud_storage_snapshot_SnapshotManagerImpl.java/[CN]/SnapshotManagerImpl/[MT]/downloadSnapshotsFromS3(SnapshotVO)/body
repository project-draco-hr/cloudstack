{
  final VolumeVO volume=_volsDao.findById(snapshot.getVolumeId());
  final Long zoneId=volume.getDataCenterId();
  final HostVO secHost=this.templateMgr.getSecondaryStorageHost(zoneId);
  final S3TO s3=_s3Mgr.getS3TO(snapshot.getS3Id());
  final List<String> backupUuids=determineBackupUuids(snapshot);
  try {
    String parent=null;
    for (    final String backupUuid : backupUuids) {
      final DownloadSnapshotFromS3Command cmd=new DownloadSnapshotFromS3Command(s3,parent,secHost.getStorageUrl(),zoneId,volume.getAccountId(),volume.getId(),backupUuid,_backupsnapshotwait);
      final Answer answer=_agentMgr.sendToSSVM(zoneId,cmd);
      if ((answer == null) || !answer.getResult()) {
        throw new CloudRuntimeException(String.format("S3 snapshot download failed due to %1$s.",answer != null ? answer.getDetails() : "unspecified error"));
      }
      parent=backupUuid;
    }
  }
 catch (  Exception e) {
    throw new CloudRuntimeException("Snapshot download from S3 failed due to " + e.toString(),e);
  }
}
