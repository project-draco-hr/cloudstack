{
  Long volumeId=volume.getId();
  if (volume.getStatus() != AsyncInstanceCreateStatus.Created) {
    throw new InvalidParameterValueException("VolumeId: " + volumeId + " is not in Created state but "+ volume.getStatus()+ ". Cannot take snapshot.");
  }
  StoragePoolVO storagePoolVO=_storagePoolDao.findById(volume.getPoolId());
  if (storagePoolVO == null) {
    throw new InvalidParameterValueException("VolumeId: " + volumeId + " does not have a valid storage pool. Is it destroyed?");
  }
  if (storagePoolVO.isLocal()) {
    throw new InvalidParameterValueException("Cannot create a snapshot from a volume residing on a local storage pool, poolId: " + volume.getPoolId());
  }
  Long instanceId=volume.getInstanceId();
  if (instanceId != null) {
    if (_vmDao.findById(instanceId) == null) {
      throw new InvalidParameterValueException("Snapshots of volumes attached to System or router VM are not allowed");
    }
  }
  return createSnapshotImpl(volumeId,Snapshot.MANUAL_POLICY_ID);
}
