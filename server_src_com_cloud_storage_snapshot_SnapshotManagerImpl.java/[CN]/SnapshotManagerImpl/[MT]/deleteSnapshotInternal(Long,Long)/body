{
  if (s_logger.isDebugEnabled()) {
    s_logger.debug("Calling deleteSnapshot for snapshotId: " + snapshotId + " and policyId "+ policyId);
  }
  SnapshotVO lastSnapshot=null;
  SnapshotVO snapshot=_snapshotDao.findById(snapshotId);
  _snapshotDao.remove(snapshotId);
  UsageEventVO usageEvent=new UsageEventVO(EventTypes.EVENT_SNAPSHOT_DELETE,snapshot.getAccountId(),0L,snapshotId,snapshot.getName(),null,null,0L);
  _usageEventDao.persist(usageEvent);
  long lastId=snapshotId;
  boolean destroy=false;
  while (true) {
    lastSnapshot=_snapshotDao.findNextSnapshot(lastId);
    if (lastSnapshot == null) {
      destroy=true;
      break;
    }
    if (lastSnapshot.getRemoved() == null) {
      break;
    }
    lastId=lastSnapshot.getId();
  }
  if (destroy) {
    lastSnapshot=_snapshotDao.findByIdIncludingRemoved(lastId);
    while (lastSnapshot.getRemoved() != null) {
      String BackupSnapshotId=lastSnapshot.getBackupSnapshotId();
      if (BackupSnapshotId != null) {
        List<SnapshotVO> snaps=_snapshotDao.listByBackupUuid(lastSnapshot.getVolumeId(),BackupSnapshotId);
        if (snaps.size() > 1) {
          lastSnapshot.setBackupSnapshotId(null);
          _snapshotDao.update(lastSnapshot.getId(),lastSnapshot);
        }
 else {
          if (destroySnapshotBackUp(lastId,policyId)) {
          }
 else {
            s_logger.debug("Destroying snapshot backup failed " + lastSnapshot);
            break;
          }
        }
      }
      postDeleteSnapshot(lastId,policyId);
      lastId=lastSnapshot.getPrevSnapshotId();
      if (lastId == 0) {
        break;
      }
      lastSnapshot=_snapshotDao.findByIdIncludingRemoved(lastId);
    }
  }
  return true;
}
