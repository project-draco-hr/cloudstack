{
  Account account=(Account)UserContext.current().getAccountObject();
  Long userId=UserContext.current().getUserId();
  Long snapshotId=cmd.getId();
  Snapshot snapshotCheck=_snapshotDao.findById(snapshotId.longValue());
  if (snapshotCheck == null) {
    throw new ServerApiException(BaseCmd.SNAPSHOT_INVALID_PARAM_ERROR,"unable to find a snapshot with id " + snapshotId);
  }
  Account snapshotOwner=_accountDao.findById(snapshotCheck.getAccountId());
  if (snapshotOwner == null) {
    throw new ServerApiException(BaseCmd.SNAPSHOT_INVALID_PARAM_ERROR,"Snapshot id " + snapshotId + " does not have a valid account");
  }
  checkAccountPermissions(snapshotOwner.getId(),snapshotOwner.getDomainId(),"snapshot",snapshotId);
  if (userId == null) {
    userId=Long.valueOf(1);
  }
  long volumeId=snapshotCheck.getVolumeId();
  List<SnapshotPolicyVO> policies=listPoliciesforSnapshot(snapshotId);
  boolean status=true;
  for (  SnapshotPolicyVO policy : policies) {
    status=deleteSnapshotInternal(snapshotId,policy.getId(),userId);
    if (!status) {
      s_logger.warn("Failed to delete snapshot");
      throw new ServerApiException(BaseCmd.INTERNAL_ERROR,"Failed to delete snapshot:" + snapshotId);
    }
  }
  return status;
}
