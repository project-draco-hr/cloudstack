{
  Long userId=UserContext.current().getUserId();
  Long snapshotId=cmd.getId();
  Snapshot snapshotCheck=_snapshotDao.findById(snapshotId.longValue());
  if (snapshotCheck == null) {
    throw new ServerApiException(BaseCmd.SNAPSHOT_INVALID_PARAM_ERROR,"unable to find a snapshot with id " + snapshotId);
  }
  Account snapshotOwner=_accountDao.findById(snapshotCheck.getAccountId());
  if (snapshotOwner == null) {
    throw new ServerApiException(BaseCmd.SNAPSHOT_INVALID_PARAM_ERROR,"Snapshot id " + snapshotId + " does not have a valid account");
  }
  checkAccountPermissions(snapshotOwner.getId(),snapshotOwner.getDomainId(),"snapshot",snapshotId);
  if (userId == null) {
    userId=Long.valueOf(1);
  }
  boolean status=true;
  if (SnapshotType.MANUAL.ordinal() == (int)snapshotCheck.getSnapshotType()) {
    status=deleteSnapshotInternal(snapshotId,Snapshot.MANUAL_POLICY_ID,userId);
    if (!status) {
      s_logger.warn("Failed to delete snapshot");
      throw new ServerApiException(BaseCmd.INTERNAL_ERROR,"Failed to delete snapshot:" + snapshotId);
    }
  }
 else {
    List<SnapshotPolicyVO> policies=listPoliciesforVolume(snapshotCheck.getVolumeId());
    for (    SnapshotPolicyVO policy : policies) {
      status=deleteSnapshotInternal(snapshotId,policy.getId(),userId);
      if (!status) {
        s_logger.warn("Failed to delete snapshot");
        throw new ServerApiException(BaseCmd.INTERNAL_ERROR,"Failed to delete snapshot:" + snapshotId);
      }
    }
  }
  return status;
}
