{
  VolumeVO volume=_volsDao.acquireInLockTable(volumeId,10);
  if (volume == null) {
    volume=_volsDao.findById(volumeId);
    if (volume == null) {
      throw new CloudRuntimeException("Creating snapshot failed due to volume:" + volumeId + " doesn't exist");
    }
 else {
      throw new CloudRuntimeException("Creating snapshot failed due to volume:" + volumeId + " is being used, try it later ");
    }
  }
  SnapshotVO snapshot=null;
  boolean backedUp=false;
  try {
    snapshot=createSnapshotOnPrimary(volume,policyId,snapshotId);
    if (snapshot != null && snapshot.getStatus() == Snapshot.Status.CreatedOnPrimary) {
      snapshotId=snapshot.getId();
      backedUp=backupSnapshotToSecondaryStorage(snapshot,startEventId);
      if (!backedUp) {
        throw new CloudRuntimeException("Created snapshot: " + snapshotId + " on primary but failed to backup on secondary");
      }
    }
  }
 catch (  Exception e) {
    throw new CloudRuntimeException("Creating snapshot failed due to " + e.toString());
  }
 finally {
    postCreateSnapshot(volumeId,snapshotId,policyId,backedUp);
    _volsDao.releaseFromLockTable(volumeId);
  }
  return snapshot;
}
