{
  Account caller=UserContext.current().getCaller();
  VolumeVO volume=_volsDao.findById(volumeId);
  if (volume == null) {
    throw new InvalidParameterValueException("Creating snapshot failed due to volume:" + volumeId + " doesn't exist");
  }
  if (volume.getState() != Volume.State.Ready) {
    throw new InvalidParameterValueException("VolumeId: " + volumeId + " is not in "+ Volume.State.Ready+ " state but "+ volume.getState()+ ". Cannot take snapshot.");
  }
  if (volume.getTemplateId() != null) {
    VMTemplateVO template=_templateDao.findById(volume.getTemplateId());
    if (template != null && template.getTemplateType() == Storage.TemplateType.SYSTEM) {
      throw new InvalidParameterValueException("VolumeId: " + volumeId + " is for System VM , Creating snapshot against System VM volumes is not supported");
    }
  }
  StoragePoolVO storagePoolVO=_storagePoolDao.findById(volume.getPoolId());
  if (storagePoolVO == null) {
    throw new InvalidParameterValueException("VolumeId: " + volumeId + " please attach this volume to a VM before create snapshot for it");
  }
  _accountMgr.checkAccess(caller,null,volume);
  Account owner=_accountMgr.getAccount(volume.getAccountId());
  _resourceLimitMgr.checkResourceLimit(owner,ResourceType.snapshot);
  String timeString=DateUtil.getDateDisplayString(DateUtil.GMT_TIMEZONE,new Date(),DateUtil.YYYYMMDD_FORMAT);
  VMInstanceVO vmInstance=_vmDao.findById(volume.getInstanceId());
  String vmDisplayName="detached";
  if (vmInstance != null) {
    vmDisplayName=vmInstance.getHostName();
  }
  String snapshotName=vmDisplayName + "_" + volume.getName()+ "_"+ timeString;
  Type snapshotType=getSnapshotType(policyId);
  HypervisorType hypervisorType=this._volsDao.getHypervisorType(volumeId);
  SnapshotVO snapshotVO=new SnapshotVO(volume.getDataCenterId(),volume.getAccountId(),volume.getDomainId(),volume.getId(),volume.getDiskOfferingId(),null,snapshotName,(short)snapshotType.ordinal(),snapshotType.name(),volume.getSize(),hypervisorType);
  SnapshotVO snapshot=_snapshotDao.persist(snapshotVO);
  return snapshot;
}
