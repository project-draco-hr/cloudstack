{
  VolumeVO volume=_volsDao.findById(volumeId);
  boolean runSnap=true;
  if (volume.getInstanceId() == null) {
    long lastSnapId=_snapshotDao.getLastSnapshot(volumeId,0);
    SnapshotVO lastSnap=_snapshotDao.findById(lastSnapId);
    if (lastSnap != null) {
      Date lastSnapTime=lastSnap.getCreated();
      if (lastSnapTime.after(volume.getUpdated())) {
        runSnap=false;
        s_logger.debug("Volume: " + volumeId + " is detached and last snap time is after Volume detach time. Skip snapshot for recurring policy");
      }
    }
  }
 else   if (_storageMgr.volumeInactive(volume)) {
    long lastSnapId=_snapshotDao.getLastSnapshot(volumeId,0);
    SnapshotVO lastSnap=_snapshotDao.findById(lastSnapId);
    if (lastSnap != null) {
      Date lastSnapTime=lastSnap.getCreated();
      VMInstanceVO vmInstance=_vmDao.findById(volume.getInstanceId());
      if (vmInstance != null) {
        if (lastSnapTime.after(vmInstance.getUpdateTime())) {
          runSnap=false;
          s_logger.debug("Volume: " + volumeId + " is inactive and last snap time is after VM update time. Skip snapshot for recurring policy");
        }
      }
    }
  }
  if (!runSnap) {
    if (policies.contains(Snapshot.MANUAL_POLICY_ID)) {
      policies=new ArrayList<Long>();
      policies.add(Snapshot.MANUAL_POLICY_ID);
      runSnap=true;
      s_logger.debug("Volume: " + volumeId + " is detached/inactive. Executing snapshot for manual policy");
    }
  }
  if (volume.getDestroyed() || volume.getRemoved() != null) {
    s_logger.debug("Volume: " + volumeId + " is destroyed/removed. Not taking snapshot");
    runSnap=false;
  }
  return runSnap;
}
