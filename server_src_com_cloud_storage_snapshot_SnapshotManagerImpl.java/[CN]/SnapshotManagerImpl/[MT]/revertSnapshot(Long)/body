{
  Snapshot snapshot=_snapshotDao.findById(snapshotId);
  if (snapshot == null) {
    throw new InvalidParameterValueException("No such snapshot");
  }
  Volume volume=_volsDao.findById(snapshot.getVolumeId());
  Long instanceId=volume.getInstanceId();
  if (instanceId != null) {
    UserVmVO vm=_vmDao.findById(instanceId);
    if (vm.getState() != State.Stopped && vm.getState() != State.Shutdowned) {
      throw new InvalidParameterValueException("The VM the specified disk is attached to is not in the shutdown state.");
    }
  }
  StrategyPriority.sortStrategies(snapshotStrategies,snapshot);
  SnapshotStrategy snapshotStrategy=null;
  for (  SnapshotStrategy strategy : snapshotStrategies) {
    if (strategy.canHandle(snapshot) != Priority.CANT_HANDLE) {
      snapshotStrategy=strategy;
      break;
    }
  }
  if (snapshotStrategy == null) {
    return false;
  }
  return snapshotStrategy.revertSnapshot(snapshotId);
}
