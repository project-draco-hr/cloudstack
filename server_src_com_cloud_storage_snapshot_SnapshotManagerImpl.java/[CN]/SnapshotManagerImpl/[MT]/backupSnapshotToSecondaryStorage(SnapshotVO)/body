{
  long snapshotId=ss.getId();
  SnapshotVO snapshot=_snapshotDao.acquireInLockTable(snapshotId);
  if (snapshot == null) {
    throw new CloudRuntimeException("Can not acquire lock for snapshot: " + ss);
  }
  try {
    snapshot.setStatus(Snapshot.Status.BackingUp);
    _snapshotDao.update(snapshot.getId(),snapshot);
    long volumeId=snapshot.getVolumeId();
    VolumeVO volume=_volsDao.lockRow(volumeId,true);
    String primaryStoragePoolNameLabel=_storageMgr.getPrimaryStorageNameLabel(volume);
    Long dcId=volume.getDataCenterId();
    Long accountId=volume.getAccountId();
    String secondaryStoragePoolUrl=_storageMgr.getSecondaryStorageURL(volume.getDataCenterId());
    String snapshotUuid=snapshot.getPath();
    SnapshotVO prevSnapshot=null;
    String prevSnapshotUuid=null;
    String prevBackupUuid=null;
    long prevSnapshotId=snapshot.getPrevSnapshotId();
    if (prevSnapshotId > 0) {
      prevSnapshot=_snapshotDao.findByIdIncludingRemoved(prevSnapshotId);
      prevBackupUuid=prevSnapshot.getBackupSnapshotId();
      if (prevBackupUuid != null) {
        prevSnapshotUuid=prevSnapshot.getPath();
      }
    }
    boolean isVolumeInactive=_storageMgr.volumeInactive(volume);
    String vmName=_storageMgr.getVmNameOnVolume(volume);
    BackupSnapshotCommand backupSnapshotCommand=new BackupSnapshotCommand(primaryStoragePoolNameLabel,secondaryStoragePoolUrl,dcId,accountId,volumeId,volume.getPath(),snapshotUuid,snapshot.getName(),prevSnapshotUuid,prevBackupUuid,isVolumeInactive,vmName);
    String backedUpSnapshotUuid=null;
    boolean backedUp=false;
    BackupSnapshotAnswer answer=(BackupSnapshotAnswer)sendToPool(volume,backupSnapshotCommand);
    if (answer != null && answer.getResult()) {
      backedUpSnapshotUuid=answer.getBackupSnapshotName();
      if (backedUpSnapshotUuid != null) {
        backedUp=true;
      }
    }
 else     if (answer != null) {
      s_logger.error(answer.getDetails());
    }
    Transaction txn=Transaction.currentTxn();
    txn.start();
    if (backedUp) {
      snapshot.setBackupSnapshotId(backedUpSnapshotUuid);
      if (answer.isFull()) {
        snapshot.setPrevSnapshotId(0);
      }
      snapshot.setStatus(Snapshot.Status.BackedUp);
      _snapshotDao.update(snapshotId,snapshot);
      UsageEventVO usageEvent=new UsageEventVO(EventTypes.EVENT_SNAPSHOT_CREATE,snapshot.getAccountId(),volume.getDataCenterId(),snapshotId,snapshot.getName(),null,null,volume.getSize());
      _usageEventDao.persist(usageEvent);
      if (snapshot.getType() == Type.RECURRING) {
        _accountMgr.incrementResourceCount(snapshot.getAccountId(),ResourceType.snapshot);
      }
    }
 else {
      if (snapshot.getType() == Type.MANUAL) {
        _accountMgr.decrementResourceCount(snapshot.getAccountId(),ResourceType.snapshot);
      }
      UsageEventVO usageEvent=new UsageEventVO(EventTypes.EVENT_SNAPSHOT_DELETE,snapshot.getAccountId(),0L,snapshotId,snapshot.getName(),null,null,0L);
      _usageEventDao.persist(usageEvent);
      _snapshotDao.remove(snapshotId);
    }
    txn.commit();
    return backedUp;
  }
  finally {
    if (snapshot != null) {
      _snapshotDao.releaseFromLockTable(snapshotId);
    }
  }
}
