{
  HypervisorType hypervisorType;
  StoragePoolVO storagePool=_storagePoolDao.findById(volume.getDataStore().getId());
  ScopeType scope=storagePool.getScope();
  if (scope.equals(ScopeType.ZONE)) {
    hypervisorType=storagePool.getHypervisor();
  }
 else {
    hypervisorType=volume.getHypervisorType();
  }
  if (hypervisorType.equals(HypervisorType.Ovm)) {
    throw new InvalidParameterValueException("Ovm won't support taking snapshot");
  }
  if (hypervisorType.equals(HypervisorType.KVM)) {
    List<HostVO> hosts=null;
    if (scope.equals(ScopeType.CLUSTER)) {
      ClusterVO cluster=_clusterDao.findById(storagePool.getClusterId());
      hosts=_resourceMgr.listAllHostsInCluster(cluster.getId());
    }
 else     if (scope.equals(ScopeType.ZONE)) {
      hosts=_resourceMgr.listAllUpAndEnabledHostsInOneZoneByHypervisor(hypervisorType,volume.getDataCenterId());
    }
    if (hosts != null && !hosts.isEmpty()) {
      HostVO host=hosts.get(0);
      if (!hostSupportSnapsthot(host)) {
        throw new CloudRuntimeException("KVM Snapshot is not supported: " + host.getId());
      }
    }
  }
  if (volume.getInstanceId() != null) {
    UserVmVO userVm=_vmDao.findById(volume.getInstanceId());
    if (userVm != null) {
      if (userVm.getState().equals(State.Destroyed) || userVm.getState().equals(State.Expunging)) {
        throw new CloudRuntimeException("Creating snapshot failed due to volume:" + volume.getId() + " is associated with vm:"+ userVm.getInstanceName()+ " is in "+ userVm.getState().toString()+ " state");
      }
      if (userVm.getHypervisorType() == HypervisorType.VMware || userVm.getHypervisorType() == HypervisorType.KVM) {
        List<SnapshotVO> activeSnapshots=_snapshotDao.listByInstanceId(volume.getInstanceId(),Snapshot.State.Creating,Snapshot.State.CreatedOnPrimary,Snapshot.State.BackingUp);
        if (activeSnapshots.size() > 1) {
          throw new CloudRuntimeException("There is other active snapshot tasks on the instance to which the volume is attached, please try again later");
        }
      }
      List<VMSnapshotVO> activeVMSnapshots=_vmSnapshotDao.listByInstanceId(userVm.getId(),VMSnapshot.State.Creating,VMSnapshot.State.Reverting,VMSnapshot.State.Expunging);
      if (activeVMSnapshots.size() > 0) {
        throw new CloudRuntimeException("There is other active vm snapshot tasks on the instance to which the volume is attached, please try again later");
      }
    }
  }
  return true;
}
