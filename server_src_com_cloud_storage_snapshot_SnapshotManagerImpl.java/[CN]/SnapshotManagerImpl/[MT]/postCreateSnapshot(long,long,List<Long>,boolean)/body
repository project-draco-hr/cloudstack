{
  Long userId=UserContext.current().getUserId();
  Transaction txn=Transaction.currentTxn();
  txn.start();
  for (  long policyId : policyIds) {
    if (backedUp) {
      SnapshotPolicyRefVO snapPolicyRef=new SnapshotPolicyRefVO(snapshotId,volumeId,policyId);
      _snapPolicyRefDao.persist(snapPolicyRef);
      if (policyId == Snapshot.MANUAL_POLICY_ID) {
        Snapshot snapshot=_snapshotDao.findById(snapshotId);
        _accountMgr.incrementResourceCount(snapshot.getAccountId(),ResourceType.snapshot);
      }
    }
    if (policyId != Snapshot.MANUAL_POLICY_ID) {
      postCreateRecurringSnapshotForPolicy(userId,volumeId,snapshotId,policyId);
    }
 else {
      SnapshotScheduleVO snapshotSchedule=_snapshotScheduleDao.getCurrentSchedule(volumeId,policyId,true);
      if (snapshotSchedule != null) {
        _snapshotScheduleDao.expunge(snapshotSchedule.getId());
      }
    }
  }
  txn.commit();
}
