{
  boolean runSnap=isVolumeDirty(volume.getId(),policies);
  ImageFormat format=getImageFormat(volume.getId());
  if (format != null) {
    if (!(format == ImageFormat.VHD || format == ImageFormat.ISO || format == ImageFormat.QCOW2)) {
      s_logger.error("Currently, a snapshot can be taken from a Root Disk only if it is created from a 1) template in VHD format or 2) from an ISO.");
      runSnap=false;
    }
  }
  if (runSnap) {
    List<Long> policiesToBeRemoved=new ArrayList<Long>();
    for (    Long policyId : policies) {
      if (policyId == Snapshot.MANUAL_POLICY_ID) {
        AccountVO account=_accountDao.findById(volume.getAccountId());
        if (_accountMgr.resourceLimitExceeded(account,ResourceType.snapshot)) {
          throw new ResourceAllocationException("The maximum number of snapshots for account " + account.getAccountName() + " has been exceeded.");
        }
      }
 else {
        SnapshotPolicyVO volPolicy=_snapshotPolicyDao.findById(policyId);
        if (volPolicy == null || !volPolicy.isActive()) {
          s_logger.debug("Policy " + policyId + " has been removed for the volume "+ volume.getId()+ ". Not running snapshot for this policy");
          policiesToBeRemoved.add(policyId);
        }
      }
    }
    policies.removeAll(policiesToBeRemoved);
    if (policies.size() == 0) {
      runSnap=false;
    }
  }
  if (!runSnap) {
    s_logger.warn("Snapshot for volume " + volume.getId() + " not created. No policy assigned currently.");
  }
  return runSnap;
}
