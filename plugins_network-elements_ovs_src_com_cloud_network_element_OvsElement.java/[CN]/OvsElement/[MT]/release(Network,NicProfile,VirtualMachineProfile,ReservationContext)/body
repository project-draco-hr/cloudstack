{
  if (!canHandle(network,Service.Connectivity)) {
    return false;
  }
  if (nic.getBroadcastType() != Networks.BroadcastDomainType.Vswitch) {
    return false;
  }
  if (nic.getTrafficType() != Networks.TrafficType.Guest) {
    return false;
  }
  List<UserVmVO> userVms=_userVmDao.listByAccountIdAndHostId(vm.getVirtualMachine().getAccountId(),vm.getVirtualMachine().getHostId());
  if (vm.getType() == VirtualMachine.Type.User) {
    if (userVms.size() > 1) {
      return true;
    }
    List<DomainRouterVO> routers=_routerDao.findByNetwork(network.getId());
    for (    DomainRouterVO router : routers) {
      if (router.getHostId().equals(vm.getVirtualMachine().getHostId())) {
        return true;
      }
    }
  }
 else   if (vm.getType() == VirtualMachine.Type.DomainRouter && userVms.size() != 0) {
    return true;
  }
  HostVO host=_hostDao.findById(vm.getVirtualMachine().getHostId());
  _ovsTunnelMgr.checkAndRemoveHostFromTunnelNetwork(network,host);
  return true;
}
