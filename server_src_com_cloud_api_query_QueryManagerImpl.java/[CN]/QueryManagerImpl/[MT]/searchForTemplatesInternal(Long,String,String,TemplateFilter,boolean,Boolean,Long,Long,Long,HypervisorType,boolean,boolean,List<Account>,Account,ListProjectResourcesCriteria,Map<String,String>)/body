{
  VMTemplateVO template=null;
  if (templateId != null) {
    template=_templateDao.findById(templateId);
    if (template == null) {
      throw new InvalidParameterValueException("Please specify a valid template ID.");
    }
    if (isIso && template.getFormat() != ImageFormat.ISO) {
      s_logger.error("Template Id " + templateId + " is not an ISO");
      InvalidParameterValueException ex=new InvalidParameterValueException("Specified Template Id is not an ISO");
      ex.addProxyObject(template,templateId,"templateId");
      throw ex;
    }
    if (!isIso && template.getFormat() == ImageFormat.ISO) {
      s_logger.error("Incorrect format of the template id " + templateId);
      InvalidParameterValueException ex=new InvalidParameterValueException("Incorrect format " + template.getFormat() + " of the specified template id");
      ex.addProxyObject(template,templateId,"templateId");
      throw ex;
    }
    if (!template.isPublicTemplate() && caller.getType() != Account.ACCOUNT_TYPE_ADMIN) {
      Account owner=_accountMgr.getAccount(template.getAccountId());
      _accountMgr.checkAccess(caller,null,true,owner);
    }
  }
  DomainVO domain=null;
  if (!permittedAccounts.isEmpty()) {
    domain=_domainDao.findById(permittedAccounts.get(0).getDomainId());
  }
 else {
    domain=_domainDao.findById(DomainVO.ROOT_DOMAIN);
  }
  List<HypervisorType> hypers=null;
  if (!isIso) {
    hypers=_resourceMgr.listAvailHypervisorInZone(null,null);
  }
  Boolean isAscending=Boolean.parseBoolean(_configDao.getValue("sortkey.algorithm"));
  isAscending=(isAscending == null ? true : isAscending);
  Filter searchFilter=new Filter(TemplateJoinVO.class,"sortKey",isAscending,startIndex,pageSize);
  SearchCriteria<TemplateJoinVO> sc=_templateJoinDao.createSearchCriteria();
  if (listProjectResourcesCriteria == ListProjectResourcesCriteria.SkipProjectResources) {
    sc.addAnd("accountType",SearchCriteria.Op.NEQ,Account.ACCOUNT_TYPE_PROJECT);
  }
 else   if (listProjectResourcesCriteria == ListProjectResourcesCriteria.ListProjectResourcesOnly) {
    sc.addAnd("accountType",SearchCriteria.Op.EQ,Account.ACCOUNT_TYPE_PROJECT);
  }
  if ((templateFilter == TemplateFilter.self || templateFilter == TemplateFilter.selfexecutable) && (caller.getType() == Account.ACCOUNT_TYPE_DOMAIN_ADMIN || caller.getType() == Account.ACCOUNT_TYPE_RESOURCE_DOMAIN_ADMIN)) {
    sc.addAnd("domainPath",SearchCriteria.Op.LIKE,domain.getPath() + "%");
  }
  List<Long> relatedDomainIds=new ArrayList<Long>();
  List<Long> permittedAccountIds=new ArrayList<Long>();
  if (!permittedAccounts.isEmpty()) {
    for (    Account account : permittedAccounts) {
      permittedAccountIds.add(account.getId());
      DomainVO accountDomain=_domainDao.findById(account.getDomainId());
      DomainVO domainTreeNode=accountDomain;
      relatedDomainIds.add(domainTreeNode.getId());
      while (domainTreeNode.getParent() != null) {
        domainTreeNode=_domainDao.findById(domainTreeNode.getParent());
        relatedDomainIds.add(domainTreeNode.getId());
      }
      if (_accountMgr.isAdmin(account.getType())) {
        List<DomainVO> allChildDomains=_domainDao.findAllChildren(accountDomain.getPath(),accountDomain.getId());
        for (        DomainVO childDomain : allChildDomains) {
          relatedDomainIds.add(childDomain.getId());
        }
      }
    }
  }
  if (hypers != null && !hypers.isEmpty()) {
    String[] relatedHypers=new String[hypers.size()];
    for (int i=0; i < hypers.size(); i++) {
      relatedHypers[i]=hypers.get(i).toString();
    }
    sc.addAnd("hypervisorType",SearchCriteria.Op.IN,relatedHypers);
  }
  if (templateFilter == TemplateFilter.featured || templateFilter == TemplateFilter.community) {
    sc.addAnd("publicTemplate",SearchCriteria.Op.EQ,true);
    if (templateFilter == TemplateFilter.featured) {
      sc.addAnd("featured",SearchCriteria.Op.EQ,true);
    }
 else {
      sc.addAnd("featured",SearchCriteria.Op.EQ,false);
    }
    if (!permittedAccounts.isEmpty()) {
      SearchCriteria<TemplateJoinVO> scc=_templateJoinDao.createSearchCriteria();
      scc.addOr("domainId",SearchCriteria.Op.IN,relatedDomainIds.toArray());
      scc.addOr("domainId",SearchCriteria.Op.NULL);
      sc.addAnd("domainId",SearchCriteria.Op.SC,scc);
      if (!_accountMgr.isAdmin(caller.getType())) {
        sc.addAnd("accountId",SearchCriteria.Op.IN,permittedAccountIds.toArray());
      }
    }
  }
 else   if (templateFilter == TemplateFilter.self || templateFilter == TemplateFilter.selfexecutable) {
    if (!permittedAccounts.isEmpty()) {
      sc.addAnd("accountId",SearchCriteria.Op.IN,permittedAccountIds.toArray());
    }
  }
 else   if (templateFilter == TemplateFilter.sharedexecutable || templateFilter == TemplateFilter.shared) {
    SearchCriteria<TemplateJoinVO> scc=_templateJoinDao.createSearchCriteria();
    scc.addOr("accountId",SearchCriteria.Op.IN,permittedAccountIds.toArray());
    scc.addOr("sharedAccountId",SearchCriteria.Op.IN,permittedAccountIds.toArray());
    sc.addAnd("accountId",SearchCriteria.Op.SC,scc);
  }
 else   if (templateFilter == TemplateFilter.executable) {
    SearchCriteria<TemplateJoinVO> scc=_templateJoinDao.createSearchCriteria();
    scc.addOr("publicTemplate",SearchCriteria.Op.EQ,true);
    if (!permittedAccounts.isEmpty()) {
      scc.addOr("accountId",SearchCriteria.Op.IN,permittedAccountIds.toArray());
    }
    sc.addAnd("publicTemplate",SearchCriteria.Op.SC,scc);
  }
  if (tags != null && !tags.isEmpty()) {
    SearchCriteria<TemplateJoinVO> scc=_templateJoinDao.createSearchCriteria();
    int count=0;
    for (    String key : tags.keySet()) {
      SearchCriteria<TemplateJoinVO> scTag=_templateJoinDao.createSearchCriteria();
      scTag.addAnd("tagKey",SearchCriteria.Op.EQ,key);
      scTag.addAnd("tagValue",SearchCriteria.Op.EQ,tags.get(key));
      if (isIso) {
        scTag.addAnd("tagResourceType",SearchCriteria.Op.EQ,TaggedResourceType.ISO);
      }
 else {
        scTag.addAnd("tagResourceType",SearchCriteria.Op.EQ,TaggedResourceType.Template);
      }
      scc.addOr("tagKey",SearchCriteria.Op.SC,scTag);
      count++;
    }
    sc.addAnd("tagKey",SearchCriteria.Op.SC,scc);
  }
  if (keyword != null) {
    sc.addAnd("name",SearchCriteria.Op.LIKE,"%" + keyword + "%");
  }
 else   if (name != null) {
    sc.addAnd("name",SearchCriteria.Op.EQ,name);
  }
  if (isIso) {
    sc.addAnd("format",SearchCriteria.Op.EQ,"ISO");
  }
 else {
    sc.addAnd("format",SearchCriteria.Op.NEQ,"ISO");
  }
  if (!hyperType.equals(HypervisorType.None)) {
    sc.addAnd("hypervisorType",SearchCriteria.Op.EQ,hyperType);
  }
  if (bootable != null) {
    sc.addAnd("bootable",SearchCriteria.Op.EQ,bootable);
  }
  if (onlyReady) {
    sc.addAnd("downloadState",SearchCriteria.Op.EQ,Status.DOWNLOADED);
    sc.addAnd("destroyed",SearchCriteria.Op.EQ,false);
  }
  if (zoneId != null) {
    sc.addAnd("dataCenterId",SearchCriteria.Op.EQ,zoneId);
  }
  if (!showDomr) {
    sc.addAnd("templateType",SearchCriteria.Op.NEQ,Storage.TemplateType.SYSTEM);
  }
  Pair<List<TemplateJoinVO>,Integer> uniqueTmplPair=_templateJoinDao.searchAndCount(sc,searchFilter);
  Integer count=uniqueTmplPair.second();
  if (count.intValue() == 0) {
    return uniqueTmplPair;
  }
  List<TemplateJoinVO> uniqueTmpls=uniqueTmplPair.first();
  Long[] vrIds=new Long[uniqueTmpls.size()];
  int i=0;
  for (  TemplateJoinVO v : uniqueTmpls) {
    vrIds[i++]=v.getId();
  }
  List<TemplateJoinVO> vrs=_templateJoinDao.searchByIds(vrIds);
  return new Pair<List<TemplateJoinVO>,Integer>(vrs,count);
}
