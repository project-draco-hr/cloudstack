{
  Account caller=CallContext.current().getCallingAccount();
  List<Long> permittedDomains=new ArrayList<Long>();
  List<Long> permittedAccounts=new ArrayList<Long>();
  List<Long> permittedResources=new ArrayList<Long>();
  String key=cmd.getKey();
  String value=cmd.getValue();
  String resourceId=cmd.getResourceId();
  String resourceType=cmd.getResourceType();
  String customerName=cmd.getCustomer();
  boolean listAll=cmd.listAll();
  Ternary<Long,Boolean,ListProjectResourcesCriteria> domainIdRecursiveListProject=new Ternary<Long,Boolean,ListProjectResourcesCriteria>(cmd.getDomainId(),cmd.isRecursive(),null);
  _accountMgr.buildACLSearchParameters(caller,null,cmd.getAccountName(),cmd.getProjectId(),permittedDomains,permittedAccounts,permittedResources,domainIdRecursiveListProject,listAll,false,"listTags");
  Long domainId=domainIdRecursiveListProject.first();
  Boolean isRecursive=domainIdRecursiveListProject.second();
  ListProjectResourcesCriteria listProjectResourcesCriteria=domainIdRecursiveListProject.third();
  Filter searchFilter=new Filter(ResourceTagJoinVO.class,"resourceType",false,cmd.getStartIndex(),cmd.getPageSizeVal());
  SearchBuilder<ResourceTagJoinVO> sb=_resourceTagJoinDao.createSearchBuilder();
  sb.and("key",sb.entity().getKey(),SearchCriteria.Op.EQ);
  sb.and("value",sb.entity().getValue(),SearchCriteria.Op.EQ);
  if (resourceId != null) {
    sb.and().op("resourceId",sb.entity().getResourceId(),SearchCriteria.Op.EQ);
    sb.or("resourceUuid",sb.entity().getResourceUuid(),SearchCriteria.Op.EQ);
    sb.cp();
  }
  sb.and("resourceType",sb.entity().getResourceType(),SearchCriteria.Op.EQ);
  sb.and("customer",sb.entity().getCustomer(),SearchCriteria.Op.EQ);
  SearchCriteria<ResourceTagJoinVO> sc=sb.create();
  SearchCriteria<ResourceTagJoinVO> aclSc=_resourceTagJoinDao.createSearchCriteria();
  _accountMgr.buildACLViewSearchCriteria(sc,aclSc,isRecursive,permittedDomains,permittedAccounts,permittedResources,listProjectResourcesCriteria);
  if (key != null) {
    sc.setParameters("key",key);
  }
  if (value != null) {
    sc.setParameters("value",value);
  }
  if (resourceId != null) {
    sc.setParameters("resourceId",resourceId);
    sc.setParameters("resourceUuid",resourceId);
  }
  if (resourceType != null) {
    sc.setParameters("resourceType",resourceType);
  }
  if (customerName != null) {
    sc.setParameters("customer",customerName);
  }
  Pair<List<ResourceTagJoinVO>,Integer> result=_resourceTagJoinDao.searchAndCount(sc,searchFilter);
  return result;
}
