{
  List<VolumeVO> vols=_volsDao.findUsableVolumesForInstance(vm.getId());
  if (s_logger.isDebugEnabled()) {
    s_logger.debug("Preparing " + vols.size() + " volumes for "+ vm);
  }
  for (  VolumeVO vol : vols) {
    PrimaryDataStoreInfo pool=(PrimaryDataStoreInfo)this.dataStoreMgr.getDataStore(vol.getPoolId(),DataStoreRole.Primary);
    ServiceOfferingVO offering=_offeringDao.findById(vm.getServiceOfferingId());
    DiskOfferingVO diskOffering=_diskOfferingDao.findById(vol.getDiskOfferingId());
    VolumeTO newVolume=new VolumeTO(vol,pool);
    if (vol.getVolumeType() == Type.ROOT) {
      newVolume.setBytesReadRate(storageMgr.getDiskBytesReadRate(offering,diskOffering));
      newVolume.setBytesWriteRate(storageMgr.getDiskBytesWriteRate(offering,diskOffering));
      newVolume.setIopsReadRate(storageMgr.getDiskIopsReadRate(offering,diskOffering));
      newVolume.setIopsWriteRate(storageMgr.getDiskIopsWriteRate(offering,diskOffering));
    }
 else {
      newVolume.setBytesReadRate(storageMgr.getDiskBytesReadRate(null,diskOffering));
      newVolume.setBytesWriteRate(storageMgr.getDiskBytesWriteRate(null,diskOffering));
      newVolume.setIopsReadRate(storageMgr.getDiskIopsReadRate(null,diskOffering));
      newVolume.setIopsWriteRate(storageMgr.getDiskIopsWriteRate(null,diskOffering));
    }
    vm.addDisk(newVolume);
  }
  if (vm.getType() == VirtualMachine.Type.User) {
    UserVmVO userVM=(UserVmVO)vm.getVirtualMachine();
    if (userVM.getIsoId() != null) {
      Pair<String,String> isoPathPair=this._tmpltMgr.getAbsoluteIsoPath(userVM.getIsoId(),userVM.getDataCenterId());
      if (isoPathPair != null) {
        String isoPath=isoPathPair.first();
        VolumeTO iso=new VolumeTO(vm.getId(),Volume.Type.ISO,StoragePoolType.ISO,null,null,null,isoPath,0,null,null);
        vm.addDisk(iso);
      }
    }
  }
}
