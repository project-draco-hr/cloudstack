{
  Account locked=_accountDao.acquireInLockTable(owner.getId());
  if (locked == null) {
    throw new ConcurrentOperationException("Unable to acquire lock on " + owner);
  }
  try {
    if (predefined == null || (offering.getTrafficType() != TrafficType.Guest && predefined.getCidr() == null && predefined.getBroadcastUri() == null && !(predefined.getBroadcastDomainType() == BroadcastDomainType.Vlan || predefined.getBroadcastDomainType() == BroadcastDomainType.Lswitch || predefined.getBroadcastDomainType() == BroadcastDomainType.Vxlan))) {
      List<NetworkVO> configs=_networksDao.listBy(owner.getId(),offering.getId(),plan.getDataCenterId());
      if (configs.size() > 0) {
        if (s_logger.isDebugEnabled()) {
          s_logger.debug("Found existing network configuration for offering " + offering + ": "+ configs.get(0));
        }
        if (errorIfAlreadySetup) {
          InvalidParameterValueException ex=new InvalidParameterValueException("Found existing network configuration (with specified id) for offering (with specified id)");
          ex.addProxyObject(offering.getUuid(),"offeringId");
          ex.addProxyObject(configs.get(0).getUuid(),"networkConfigId");
          throw ex;
        }
 else {
          return configs;
        }
      }
    }
    final List<NetworkVO> networks=new ArrayList<NetworkVO>();
    long related=-1;
    for (    final NetworkGuru guru : networkGurus) {
      final Network network=guru.design(offering,plan,predefined,owner);
      if (network == null) {
        continue;
      }
      if (network.getId() != -1) {
        if (network instanceof NetworkVO) {
          networks.add((NetworkVO)network);
        }
 else {
          networks.add(_networksDao.findById(network.getId()));
        }
        continue;
      }
      final long id=_networksDao.getNextInSequence(Long.class,"id");
      if (related == -1) {
        related=id;
      }
      final long relatedFile=related;
      Transaction.execute(new TransactionCallbackNoReturn(){
        @Override public void doInTransactionWithoutResult(        TransactionStatus status){
          NetworkVO vo=new NetworkVO(id,network,offering.getId(),guru.getName(),owner.getDomainId(),owner.getId(),relatedFile,name,displayText,predefined.getNetworkDomain(),offering.getGuestType(),plan.getDataCenterId(),plan.getPhysicalNetworkId(),aclType,offering.getSpecifyIpRanges(),vpcId);
          vo.setDisplayNetwork(isDisplayNetworkEnabled == null ? true : isDisplayNetworkEnabled);
          networks.add(_networksDao.persist(vo,vo.getGuestType() == Network.GuestType.Isolated,finalizeServicesAndProvidersForNetwork(offering,plan.getPhysicalNetworkId())));
          if (domainId != null && aclType == ACLType.Domain) {
            _networksDao.addDomainToNetwork(id,domainId,subdomainAccess == null ? true : subdomainAccess);
          }
        }
      }
);
    }
    if (networks.size() < 1) {
      CloudRuntimeException ex=new CloudRuntimeException("Unable to convert network offering with specified id to network profile");
      ex.addProxyObject(offering.getUuid(),"offeringId");
      throw ex;
    }
    return networks;
  }
  finally {
    s_logger.debug("Releasing lock for " + locked);
    _accountDao.releaseFromLockTable(locked.getId());
  }
}
