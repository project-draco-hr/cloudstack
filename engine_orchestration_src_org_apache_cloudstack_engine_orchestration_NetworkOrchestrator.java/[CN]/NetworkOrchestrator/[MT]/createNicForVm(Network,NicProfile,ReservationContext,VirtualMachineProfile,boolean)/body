{
  VirtualMachine vm=vmProfile.getVirtualMachine();
  DataCenter dc=_entityMgr.findById(DataCenter.class,network.getDataCenterId());
  Host host=_hostDao.findById(vm.getHostId());
  DeployDestination dest=new DeployDestination(dc,null,null,host);
  NicProfile nic=getNicProfileForVm(network,requested,vm);
  if (nic == null || (vmProfile.getType() == VirtualMachine.Type.User)) {
    int deviceId=_nicDao.countNics(vm.getId());
    nic=allocateNic(requested,network,false,deviceId,vmProfile).first();
    if (nic == null) {
      throw new CloudRuntimeException("Failed to allocate nic for vm " + vm + " in network "+ network);
    }
    if (vmProfile.getType() == VirtualMachine.Type.User) {
      VMNetworkMapVO vno=new VMNetworkMapVO(vm.getId(),network.getId());
      _vmNetworkMapDao.persist(vno);
    }
    s_logger.debug("Nic is allocated successfully for vm " + vm + " in network "+ network);
  }
  if (prepare) {
    Pair<NetworkGuru,NetworkVO> implemented=implementNetwork(nic.getNetworkId(),dest,context);
    if (implemented == null) {
      throw new CloudRuntimeException("Failed to prepare the nic as a part of creating nic " + nic + " for vm "+ vm+ " due to network "+ network+ " implement failure");
    }
    nic=prepareNic(vmProfile,dest,context,nic.getId(),implemented.second());
    s_logger.debug("Nic is prepared successfully for vm " + vm + " in network "+ network);
  }
  return nic;
}
