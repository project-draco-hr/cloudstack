{
synchronized (buff) {
    buff.clear();
    buff.limit(4);
    while (buff.hasRemaining()) {
      if (ch.read(buff) == -1) {
        throw new IOException("Connection closed with -1 on reading size.");
      }
    }
    buff.flip();
    int length=buff.getInt();
    ByteArrayOutputStream output=new ByteArrayOutputStream(length);
    WritableByteChannel outCh=Channels.newChannel(output);
    int count=0;
    while (count < length) {
      buff.clear();
      int read=ch.read(buff);
      if (read < 0) {
        throw new IOException("Connection closed with -1 on reading data.");
      }
      count+=read;
      buff.flip();
      outCh.write(buff);
    }
    return output.toByteArray();
  }
}
