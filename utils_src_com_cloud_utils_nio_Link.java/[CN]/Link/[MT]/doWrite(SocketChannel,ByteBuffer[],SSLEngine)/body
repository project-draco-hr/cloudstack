{
  ByteBuffer pkgBuf;
  SSLSession sslSession=sslEngine.getSession();
  SSLEngineResult engResult;
  ByteBuffer headBuf=ByteBuffer.allocate(4);
  pkgBuf=ByteBuffer.allocate(sslSession.getPacketBufferSize() + 40);
  engResult=sslEngine.wrap(buffers,pkgBuf);
  if (engResult.getHandshakeStatus() != HandshakeStatus.FINISHED && engResult.getHandshakeStatus() != HandshakeStatus.NOT_HANDSHAKING && engResult.getStatus() != SSLEngineResult.Status.OK) {
    throw new IOException("SSL: SSLEngine return bad result! " + engResult);
  }
  int dataRemaining=pkgBuf.position();
  int headRemaining=4;
  pkgBuf.flip();
  headBuf.putInt(dataRemaining);
  headBuf.flip();
  while (headRemaining > 0) {
    if (s_logger.isTraceEnabled()) {
      s_logger.trace("Writing Header " + headRemaining);
    }
    long count=ch.write(headBuf);
    headRemaining-=count;
  }
  while (dataRemaining > 0) {
    if (s_logger.isTraceEnabled()) {
      s_logger.trace("Writing Data " + dataRemaining);
    }
    long count=ch.write(pkgBuf);
    dataRemaining-=count;
  }
}
