{
  HostVO host=_hostDao.findById(hostId);
  Status state;
  MaintainAnswer answer=(MaintainAnswer)easySend(hostId,new MaintainCommand());
  if (answer == null || !answer.getResult()) {
    s_logger.warn("Unable to put host in maintainance mode: " + hostId);
    return false;
  }
  do {
    host=_hostDao.findById(hostId);
    if (host == null) {
      s_logger.debug("Unable to find host " + hostId);
      return false;
    }
    state=host.getStatus();
    if (state == Status.Disconnected || state == Status.Updating) {
      s_logger.debug("Unable to put host " + hostId + " in matinenance mode because it is currently in "+ state);
      throw new AgentUnavailableException("Agent is in " + state + " state.  Please wait for it to become Alert state try again.",hostId);
    }
  }
 while (!_hostDao.updateStatus(host,Event.MaintenanceRequested,_nodeId));
  AgentAttache attache=findAttache(hostId);
  if (attache != null) {
    attache.setMaintenanceMode(true);
  }
  if (attache != null) {
    attache.cancelAllCommands(Status.PrepareForMaintenance,false);
  }
  final Host.Type type=host.getType();
  if (type == Host.Type.Routing) {
    final List<VMInstanceVO> vms=_vmDao.listByHostId(hostId);
    if (vms.size() == 0) {
      return true;
    }
    List<HostVO> hosts=_hostDao.listBy(host.getClusterId(),host.getPodId(),host.getDataCenterId());
    for (    final VMInstanceVO vm : vms) {
      if (hosts == null || hosts.size() <= 1 || !answer.getMigrate()) {
        _haMgr.scheduleStop(vm,hostId,WorkType.ForceStop);
      }
 else {
        _haMgr.scheduleMigration(vm);
      }
    }
  }
  return true;
}
