{
  SearchCriteria<CapacityVO> capacitySC=_capacityDao.createSearchCriteria();
  capacitySC.addAnd("hostOrPoolId",SearchCriteria.Op.EQ,server.getId());
  capacitySC.addAnd("dataCenterId",SearchCriteria.Op.EQ,server.getDataCenterId());
  capacitySC.addAnd("podId",SearchCriteria.Op.EQ,server.getPodId());
  List<CapacityVO> capacities=_capacityDao.search(capacitySC,null);
  if ((capacities != null) && !capacities.isEmpty()) {
    for (    CapacityVO capacity : capacities) {
      _capacityDao.remove(capacity.getId());
    }
  }
  if (startup instanceof StartupStorageCommand) {
    StartupStorageCommand ssCmd=(StartupStorageCommand)startup;
    if (ssCmd.getResourceType() == StorageResourceType.STORAGE_HOST) {
      CapacityVO capacity=new CapacityVO(server.getId(),server.getDataCenterId(),server.getPodId(),0L,server.getTotalSize(),CapacityVO.CAPACITY_TYPE_STORAGE);
      _capacityDao.persist(capacity);
      capacity=new CapacityVO(server.getId(),server.getDataCenterId(),server.getPodId(),0L,server.getTotalSize() * _overProvisioningFactor,CapacityVO.CAPACITY_TYPE_STORAGE_ALLOCATED);
      _capacityDao.persist(capacity);
    }
  }
 else   if (startup instanceof StartupRoutingCommand) {
    CapacityVO capacity=new CapacityVO(server.getId(),server.getDataCenterId(),server.getPodId(),0L,server.getTotalMemory(),CapacityVO.CAPACITY_TYPE_MEMORY);
    _capacityDao.persist(capacity);
    capacity=new CapacityVO(server.getId(),server.getDataCenterId(),server.getPodId(),0L,(long)(server.getCpus().longValue() * server.getSpeed().longValue() * _cpuOverProvisioningFactor),CapacityVO.CAPACITY_TYPE_CPU);
    _capacityDao.persist(capacity);
  }
}
