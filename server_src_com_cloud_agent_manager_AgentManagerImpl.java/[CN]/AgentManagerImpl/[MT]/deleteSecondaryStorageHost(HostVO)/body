{
  long zoneId=secStorageHost.getDataCenterId();
  long hostId=secStorageHost.getId();
  Transaction txn=Transaction.currentTxn();
  try {
    List<VMInstanceVO> allVmsInZone=_vmDao.listByZoneId(zoneId);
    if (!allVmsInZone.isEmpty()) {
      s_logger.warn("Cannot delete secondary storage host when there are  " + allVmsInZone.size() + " vms in zone "+ zoneId);
      return false;
    }
    txn.start();
    if (!_hostDao.updateStatus(secStorageHost,Event.MaintenanceRequested,_nodeId)) {
      if (s_logger.isDebugEnabled()) {
        s_logger.debug("Unable to take host " + hostId + " into maintenance mode.  Delete call is ignored");
      }
      return false;
    }
    if (!_hostDao.updateStatus(secStorageHost,Event.PreparationComplete,_nodeId)) {
      if (s_logger.isDebugEnabled()) {
        s_logger.debug("Unable to take host " + hostId + " into maintenance mode.  Delete call is ignored");
      }
      return false;
    }
    AgentAttache attache=findAttache(hostId);
    if (attache != null) {
      handleDisconnect(attache,Status.Event.Remove,false);
    }
    secStorageHost.setGuid(null);
    _hostDao.update(secStorageHost.getId(),secStorageHost);
    _hostDao.remove(secStorageHost.getId());
    SearchCriteria<VMTemplateHostVO> templateHostSC=_vmTemplateHostDao.createSearchCriteria();
    templateHostSC.addAnd("hostId",SearchCriteria.Op.EQ,secStorageHost.getId());
    _vmTemplateHostDao.remove(templateHostSC);
    SearchCriteria<CapacityVO> secStorageCapacitySC=_capacityDao.createSearchCriteria();
    secStorageCapacitySC.addAnd("hostOrPoolId",SearchCriteria.Op.EQ,secStorageHost.getId());
    secStorageCapacitySC.addAnd("capacityType",SearchCriteria.Op.EQ,Capacity.CAPACITY_TYPE_SECONDARY_STORAGE);
    _capacityDao.remove(secStorageCapacitySC);
    secStorageHost.setGuid(null);
    txn.commit();
    return true;
  }
 catch (  Throwable t) {
    s_logger.error("Unable to delete sec storage host: " + secStorageHost.getId(),t);
    return false;
  }
}
