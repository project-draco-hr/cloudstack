{
  HostVO storageHost=_serverDao.findById(sserverId);
  if (storageHost == null) {
    s_logger.warn("Huh? Agent id " + sserverId + " does not correspond to a row in hosts table?");
    return;
  }
  List<VMTemplateVO> allTemplates=_templateDao.listAllInZone(storageHost.getDataCenterId());
  VMTemplateVO rtngTmplt=_templateDao.findRoutingTemplate();
  VMTemplateVO defaultBuiltin=_templateDao.findDefaultBuiltinTemplate();
  if (rtngTmplt != null && !allTemplates.contains(rtngTmplt))   allTemplates.add(rtngTmplt);
  if (defaultBuiltin != null && !allTemplates.contains(defaultBuiltin)) {
    allTemplates.add(defaultBuiltin);
  }
  for (  VMTemplateVO tmplt : allTemplates) {
    String uniqueName=tmplt.getUniqueName();
    VMTemplateHostVO tmpltHost=_vmTemplateHostDao.findByHostTemplate(sserverId,tmplt.getId());
    if (templateInfo.containsKey(uniqueName)) {
      if (tmpltHost != null) {
        s_logger.info("Template Sync found " + uniqueName + " already in the template host table");
        if (tmpltHost.getUploadState() != Status.UPLOADED) {
          tmpltHost.setUpload_errorString("");
        }
        tmpltHost.setUploadPercent(100);
        tmpltHost.setUploadState(Status.UPLOADED);
        tmpltHost.setLastUpdated(new Date());
        _vmTemplateHostDao.update(tmpltHost.getId(),tmpltHost);
      }
 else {
        VMTemplateHostVO templtHost=new VMTemplateHostVO(sserverId,tmplt.getId(),new Date(),100,Status.UPLOADED,null,null,null,templateInfo.get(uniqueName).getInstallPath(),tmplt.getUrl());
        templtHost.setSize(templateInfo.get(uniqueName).getSize());
        _vmTemplateHostDao.persist(templtHost);
      }
      templateInfo.remove(uniqueName);
      continue;
    }
  }
}
