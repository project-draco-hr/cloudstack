{
  String errorString="";
  boolean success=false;
  List<HostVO> storageServers=_serverDao.listByTypeDataCenter(Host.Type.SecondaryStorage,dataCenterId);
  if (storageServers == null) {
    throw new CloudRuntimeException("No Storage Server found at the datacenter - " + dataCenterId);
  }
  Type type=(template.getFormat() == ImageFormat.ISO) ? Type.ISO : Type.TEMPLATE;
  List<UploadVO> extractURLList=_uploadDao.listByTypeUploadStatus(template.getId(),type,UploadVO.Status.DOWNLOAD_URL_CREATED);
  if (extractURLList.size() > 0) {
    return extractURLList.get(0);
  }
  HostVO sserver=storageServers.get(0);
  UploadVO uploadTemplateObj=new UploadVO(sserver.getId(),template.getId(),new Date(),Status.DOWNLOAD_URL_NOT_CREATED,0,type,Mode.HTTP_DOWNLOAD);
  uploadTemplateObj.setInstallPath(vmTemplateHost.getInstallPath());
  _uploadDao.persist(uploadTemplateObj);
  try {
    CreateEntityDownloadURLCommand cmd=new CreateEntityDownloadURLCommand(vmTemplateHost.getInstallPath());
    long result=send(sserver.getId(),cmd,null);
    if (result == -1) {
      errorString="Unable to create a link for " + type + " id:"+ template.getId();
      s_logger.error(errorString);
      throw new CloudRuntimeException(errorString);
    }
    List<SecondaryStorageVmVO> ssVms=_secStorageVmDao.getSecStorageVmListInStates(dataCenterId,State.Running);
    if (ssVms.size() > 0) {
      SecondaryStorageVmVO ssVm=ssVms.get(0);
      if (ssVm.getPublicIpAddress() == null) {
        errorString="A running secondary storage vm has a null public ip?";
        s_logger.error(errorString);
        throw new CloudRuntimeException(errorString);
      }
      String extractURL=generateCopyUrl(ssVm.getPublicIpAddress(),vmTemplateHost.getInstallPath());
      UploadVO vo=_uploadDao.createForUpdate();
      vo.setLastUpdated(new Date());
      vo.setUploadUrl(extractURL);
      vo.setUploadState(Status.DOWNLOAD_URL_CREATED);
      _uploadDao.update(uploadTemplateObj.getId(),vo);
      success=true;
      return _uploadDao.findById(uploadTemplateObj.getId(),true);
    }
    errorString="Couldnt find a running SSVM in the zone" + dataCenterId + ". Couldnt create the extraction URL.";
    throw new CloudRuntimeException(errorString);
  }
  finally {
    if (!success) {
      UploadVO uploadJob=_uploadDao.createForUpdate(uploadTemplateObj.getId());
      uploadJob.setLastUpdated(new Date());
      uploadJob.setErrorString(errorString);
      uploadJob.setUploadState(Status.ERROR);
      _uploadDao.update(uploadTemplateObj.getId(),uploadJob);
    }
  }
}
