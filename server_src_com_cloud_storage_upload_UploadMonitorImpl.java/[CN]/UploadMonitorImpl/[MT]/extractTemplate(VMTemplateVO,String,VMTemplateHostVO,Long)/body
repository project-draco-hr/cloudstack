{
  Type type=(template.getFormat() == ImageFormat.ISO) ? Type.ISO : Type.TEMPLATE;
  if (isTypeUploadInProgress(template.getId(),type)) {
    return;
  }
  List<HostVO> storageServers=_serverDao.listByTypeDataCenter(Host.Type.SecondaryStorage,dataCenterId);
  HostVO sserver=storageServers.get(0);
  UploadVO uploadTemplateObj=new UploadVO(sserver.getId(),template.getId(),new Date(),Upload.Status.NOT_UPLOADED,0,type,null,"jobid0000",url);
  _uploadDao.persist(uploadTemplateObj);
  if (vmTemplateHost != null) {
    start();
    UploadCommand ucmd=new UploadCommand(template,url,vmTemplateHost);
    UploadListener ul=new UploadListener(sserver,_timer,_uploadDao,uploadTemplateObj.getId(),this,ucmd,template.getAccountId(),template.getName(),type);
    _listenerMap.put(uploadTemplateObj,ul);
    long result=send(sserver.getId(),ucmd,ul);
    if (result == -1) {
      s_logger.warn("Unable to start upload of " + template.getUniqueName() + " from "+ sserver.getName()+ " to "+ url);
      ul.setDisconnected();
      ul.scheduleStatusCheck(RequestType.GET_OR_RESTART);
    }
  }
}
