{
  if (s_logger.isDebugEnabled()) {
    s_logger.debug("testing if vm (" + vm.getId() + ") is alive");
  }
  if (vm.getType() == VirtualMachine.Type.User) {
    UserVmVO userVm=_userVmDao.findById(vm.getId());
    Long routerId=null;
    if (routerId == null) {
      s_logger.debug("It's external dhcp mode, how to checking the vm is alive?");
      return true;
    }
 else {
      return testUserVM(vm,routerId);
    }
  }
 else   if ((vm.getType() == VirtualMachine.Type.DomainRouter) || (vm.getType() == VirtualMachine.Type.ConsoleProxy)) {
    HostVO vmHost=_hostDao.findById(vm.getHostId());
    List<HostVO> otherHosts=findHostByPod(vm.getPodId(),vm.getHostId());
    for (    HostVO otherHost : otherHosts) {
      Status vmState=testIpAddress(otherHost.getId(),vm.getPrivateIpAddress());
      if (vmState == null) {
        continue;
      }
      if (vmState == Status.Up) {
        if (s_logger.isDebugEnabled()) {
          s_logger.debug("successfully pinged vm's private IP (" + vm.getPrivateIpAddress() + "), returning that the VM is up");
        }
        return Boolean.TRUE;
      }
 else       if (vmState == Status.Down) {
        Status vmHostState=testIpAddress(otherHost.getId(),vmHost.getPrivateIpAddress());
        if ((vmHostState != null) && (vmHostState == Status.Up)) {
          if (s_logger.isDebugEnabled()) {
            s_logger.debug("successfully pinged vm's host IP (" + vmHost.getPrivateIpAddress() + "), but could not ping VM, returning that the VM is down");
          }
          return Boolean.FALSE;
        }
      }
    }
  }
  if (s_logger.isDebugEnabled()) {
    s_logger.debug("unable to determine state of vm (" + vm.getId() + "), returning null");
  }
  return null;
}
