{
  if (s_logger.isDebugEnabled()) {
    s_logger.debug("testing if vm (" + vm.getId() + ") is alive");
  }
  if (vm.getType() == VirtualMachine.Type.User) {
    UserVmVO userVm=_userVmDao.findById(vm.getId());
    Nic nic=_networkMgr.getNicForTraffic(userVm.getId(),TrafficType.Guest);
    if (nic == null) {
      if (s_logger.isDebugEnabled()) {
        s_logger.debug("Unable to find a guest nic for " + vm);
      }
      return null;
    }
    VirtualRouter router=_vnaMgr.getRouterForNetwork(nic.getNetworkId());
    if (router == null) {
      if (s_logger.isDebugEnabled()) {
        s_logger.debug("Unable to find a router in network " + nic.getNetworkId() + " to ping "+ vm);
      }
      return null;
    }
    return testUserVM(vm,nic,router);
  }
 else   if ((vm.getType() == VirtualMachine.Type.DomainRouter) || (vm.getType() == VirtualMachine.Type.ConsoleProxy)) {
    HostVO vmHost=_hostDao.findById(vm.getHostId());
    List<Long> otherHosts=findHostByPod(vm.getPodId(),vm.getHostId());
    for (    Long otherHost : otherHosts) {
      Status vmState=testIpAddress(otherHost,vm.getPrivateIpAddress());
      if (vmState == null) {
        continue;
      }
      if (vmState == Status.Up) {
        if (s_logger.isDebugEnabled()) {
          s_logger.debug("successfully pinged vm's private IP (" + vm.getPrivateIpAddress() + "), returning that the VM is up");
        }
        return Boolean.TRUE;
      }
 else       if (vmState == Status.Down) {
        Status vmHostState=testIpAddress(otherHost,vmHost.getPrivateIpAddress());
        if ((vmHostState != null) && (vmHostState == Status.Up)) {
          if (s_logger.isDebugEnabled()) {
            s_logger.debug("successfully pinged vm's host IP (" + vmHost.getPrivateIpAddress() + "), but could not ping VM, returning that the VM is down");
          }
          return Boolean.FALSE;
        }
      }
    }
  }
  if (s_logger.isDebugEnabled()) {
    s_logger.debug("unable to determine state of vm (" + vm.getId() + "), returning null");
  }
  return null;
}
