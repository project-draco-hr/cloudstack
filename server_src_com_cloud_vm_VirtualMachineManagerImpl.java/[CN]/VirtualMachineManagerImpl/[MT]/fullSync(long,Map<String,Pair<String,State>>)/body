{
  Map<Long,AgentVmInfo> infos=convertToInfos(newStates);
  List<VMInstanceVO> vms=_vmDao.listByClusterId(clusterId);
  for (  VMInstanceVO vm : vms) {
    if (vm.isRemoved() || vm.getState() == State.Destroyed || vm.getState() == State.Expunging)     continue;
    infos.remove(vm.getId());
  }
  vms=_vmDao.listStartingByClusterId(clusterId);
  for (  VMInstanceVO vm : vms) {
    if (vm.isRemoved() || vm.getState() == State.Destroyed || vm.getState() == State.Expunging)     continue;
    infos.remove(vm.getId());
  }
  for (  final AgentVmInfo left : infos.values()) {
    try {
      Host host=_resourceMgr.findHostByGuid(left.getHostUuid());
      if (host != null) {
        s_logger.warn("Stopping a VM which we do not have any record of " + left.name);
        Answer answer=_agentMgr.send(host.getId(),cleanup(left.name));
        if (!answer.getResult()) {
          s_logger.warn("Unable to stop a VM due to " + answer.getDetails());
        }
      }
    }
 catch (    Exception e) {
      s_logger.warn("Unable to stop a VM due to " + e.getMessage());
    }
  }
}
