{
  s_logger.info("Migrating " + vm + " to "+ dest);
  long dstHostId=dest.getHost().getId();
  Host fromHost=_hostDao.findById(srcHostId);
  if (fromHost == null) {
    s_logger.info("Unable to find the host to migrate from: " + srcHostId);
    return null;
  }
  VirtualMachineGuru<T> vmGuru=getVmGuru(vm);
  vm=vmGuru.findById(vm.getId());
  if (vm == null) {
    if (s_logger.isDebugEnabled()) {
      s_logger.debug("Unable to find the vm " + vm);
    }
    return null;
  }
  short alertType=AlertManager.ALERT_TYPE_USERVM_MIGRATE;
  if (VirtualMachine.Type.DomainRouter.equals(vm.getType())) {
    alertType=AlertManager.ALERT_TYPE_DOMAIN_ROUTER_MIGRATE;
  }
 else   if (VirtualMachine.Type.ConsoleProxy.equals(vm.getType())) {
    alertType=AlertManager.ALERT_TYPE_CONSOLE_PROXY_MIGRATE;
  }
  VirtualMachineProfile<VMInstanceVO> profile=new VirtualMachineProfileImpl<VMInstanceVO>(vm);
  _networkMgr.prepareNicForMigration(profile,dest);
  _storageMgr.prepareForMigration(profile,dest);
  HypervisorGuru hvGuru=_hvGurus.get(vm.getHypervisorType());
  VirtualMachineTO to=hvGuru.implement(profile);
  PrepareForMigrationCommand pfmc=new PrepareForMigrationCommand(to);
  ItWorkVO work=new ItWorkVO(UUID.randomUUID().toString(),_nodeId,State.Migrating,vm.getType(),vm.getId());
  work.setStep(Step.Prepare);
  work.setResourceType(ItWorkVO.ResourceType.Host);
  work.setResourceId(dstHostId);
  _workDao.persist(work);
  PrepareForMigrationAnswer pfma=null;
  try {
    pfma=(PrepareForMigrationAnswer)_agentMgr.send(dstHostId,pfmc);
    if (!pfma.getResult()) {
      String msg="Unable to prepare for migration due to " + pfma.getDetails();
      pfma=null;
      throw new AgentUnavailableException(msg,dstHostId);
    }
  }
 catch (  OperationTimedoutException e1) {
    throw new AgentUnavailableException("Operation timed out",dstHostId);
  }
 finally {
    if (pfma == null) {
      work.setStep(Step.Done);
      _workDao.update(work.getId(),work);
    }
  }
  vm.setLastHostId(srcHostId);
  if (vm == null || vm.getHostId() == null || vm.getHostId() != srcHostId || !changeState(vm,Event.MigrationRequested,dstHostId,work,Step.Migrating)) {
    s_logger.info("Migration cancelled because state has changed: " + vm);
    return null;
  }
  boolean migrated=false;
  try {
    boolean isWindows=_guestOsCategoryDao.findById(_guestOsDao.findById(vm.getGuestOSId()).getCategoryId()).getName().equalsIgnoreCase("Windows");
    MigrateCommand mc=new MigrateCommand(vm.getInstanceName(),dest.getHost().getPrivateIpAddress(),isWindows);
    try {
      MigrateAnswer ma=(MigrateAnswer)_agentMgr.send(vm.getLastHostId(),mc);
      if (!ma.getResult()) {
        s_logger.error("Unable to migrate due to " + ma.getDetails());
        return null;
      }
    }
 catch (    OperationTimedoutException e) {
      if (e.isActive()) {
        s_logger.warn("Active migration command so scheduling a restart for " + vm);
        _haMgr.scheduleRestart(vm,true);
      }
      throw new AgentUnavailableException("Operation timed out on migrating " + vm,dstHostId);
    }
    changeState(vm,VirtualMachine.Event.OperationSucceeded,dstHostId,work,Step.Started);
    try {
      if (!checkVmOnHost(vm,dstHostId)) {
        s_logger.error("Unable to complete migration for " + vm);
        _agentMgr.send(srcHostId,new Commands(cleanup(vm.getInstanceName())),null);
        cleanup(vmGuru,new VirtualMachineProfileImpl<T>(vm),work,Event.AgentReportStopped,true,_accountMgr.getSystemUser(),_accountMgr.getSystemAccount());
        return null;
      }
    }
 catch (    OperationTimedoutException e) {
    }
    migrated=true;
    return vm;
  }
  finally {
    if (!migrated) {
      s_logger.info("Migration was unsuccessful.  Cleaning up: " + vm);
      _alertMgr.sendAlert(alertType,fromHost.getDataCenterId(),fromHost.getPodId(),"Unable to migrate vm " + vm.getName() + " from host "+ fromHost.getName()+ " in zone "+ dest.getDataCenter().getName()+ " and pod "+ dest.getPod().getName(),"Migrate Command failed.  Please check logs.");
      _agentMgr.send(dstHostId,new Commands(cleanup(vm.getInstanceName())),null);
      stateTransitTo(vm,Event.OperationFailed,srcHostId);
    }
    work.setStep(Step.Done);
    _workDao.update(work.getId(),work);
  }
}
