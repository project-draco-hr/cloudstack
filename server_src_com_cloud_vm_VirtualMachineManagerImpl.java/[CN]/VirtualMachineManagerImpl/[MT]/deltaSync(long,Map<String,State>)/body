{
  Map<Long,AgentVmInfo> states=convertToIds(newStates);
  Commands commands=new Commands(OnError.Continue);
  boolean nativeHA=_agentMgr.isHostNativeHAEnabled(hostId);
  for (  final Map.Entry<Long,AgentVmInfo> entry : states.entrySet()) {
    AgentVmInfo info=entry.getValue();
    VMInstanceVO vm=info.vm;
    Command command=null;
    if (vm != null) {
      command=compareState(vm,info,false,nativeHA);
    }
 else {
      command=cleanup(info.name);
    }
    if (command != null) {
      commands.addCommand(command);
    }
  }
  return commands;
}
