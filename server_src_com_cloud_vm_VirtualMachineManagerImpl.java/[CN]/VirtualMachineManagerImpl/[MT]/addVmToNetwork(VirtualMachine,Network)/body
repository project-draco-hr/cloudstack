{
  VMInstanceVO vmVO=_vmDao.findById(vm.getId());
  NetworkVO networkVO=_networkDao.findById(network.getId());
  ReservationContext context=new ReservationContextImpl(null,null,_accountMgr.getActiveUser(User.UID_SYSTEM),_accountMgr.getAccount(Account.ACCOUNT_ID_SYSTEM));
  VirtualMachineProfileImpl<VMInstanceVO> vmProfile=new VirtualMachineProfileImpl<VMInstanceVO>(vmVO,null,null,null,null);
  DataCenter dc=_configMgr.getZone(network.getDataCenterId());
  Host host=_hostDao.findById(vm.getHostId());
  DeployDestination dest=new DeployDestination(dc,null,null,host);
  s_logger.debug("Adding vm " + vm + " to network "+ network);
  NicProfile nic=_networkMgr.allocateNic(null,network,false,100,vmProfile).first();
  nic=_networkMgr.prepareNic(vmProfile,dest,context,nic.getId(),networkVO);
  VirtualMachineGuru<VMInstanceVO> vmGuru=getVmGuru(vmVO);
  HypervisorGuru hvGuru=_hvGuruMgr.getGuru(vmProfile.getVirtualMachine().getHypervisorType());
  VirtualMachineTO vmTO=hvGuru.implement(vmProfile);
  NicTO nicTO=hvGuru.toNicTO(nic);
  return vmGuru.plugNic(network,nicTO,vmTO,context,null);
}
