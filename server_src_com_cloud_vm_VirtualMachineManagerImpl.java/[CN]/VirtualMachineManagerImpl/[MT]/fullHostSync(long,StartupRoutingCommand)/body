{
  Commands commands=new Commands(OnError.Continue);
  Map<Long,AgentVmInfo> infos=convertToInfos(startup);
  final List<? extends VMInstanceVO> vms=_vmDao.listByHostId(hostId);
  s_logger.debug("Found " + vms.size() + " VMs for host "+ hostId);
  for (  VMInstanceVO vm : vms) {
    AgentVmInfo info=infos.remove(vm.getId());
    List<VMSnapshotVO> vmSnapshotsInTrasientStates=_vmSnapshotDao.listByInstanceId(vm.getId(),VMSnapshot.State.Expunging,VMSnapshot.State.Reverting,VMSnapshot.State.Creating);
    if (vmSnapshotsInTrasientStates.size() > 1) {
      s_logger.info("Found vm " + vm.getInstanceName() + " with VM snapshots in transient states, needs to sync VM snapshot state");
      if (!_vmSnapshotMgr.syncVMSnapshot(vm,hostId)) {
        s_logger.warn("Failed to sync VM in a transient snapshot related state: " + vm.getInstanceName());
        continue;
      }
 else {
        s_logger.info("Successfully sync VM with transient snapshot: " + vm.getInstanceName());
      }
    }
    if (info == null) {
      info=new AgentVmInfo(vm.getInstanceName(),vm,State.Stopped);
    }
    HypervisorGuru hvGuru=_hvGuruMgr.getGuru(vm.getHypervisorType());
    Command command=compareState(hostId,vm,info,true,hvGuru.trackVmHostChange());
    if (command != null) {
      commands.addCommand(command);
    }
  }
  for (  final AgentVmInfo left : infos.values()) {
    boolean found=false;
    VMInstanceVO vm=_vmDao.findVMByInstanceName(left.name);
    if (vm != null) {
      found=true;
      HypervisorGuru hvGuru=_hvGuruMgr.getGuru(vm.getHypervisorType());
      if (hvGuru.trackVmHostChange()) {
        Command command=compareState(hostId,vm,left,true,true);
        if (command != null) {
          commands.addCommand(command);
        }
      }
 else {
        s_logger.warn("Stopping a VM, VM " + left.name + " migrate from Host "+ vm.getHostId()+ " to Host "+ hostId);
        commands.addCommand(cleanup(left.name));
      }
    }
    if (!found) {
      s_logger.warn("Stopping a VM that we have no record of <fullHostSync>: " + left.name);
      commands.addCommand(cleanup(left.name));
    }
  }
  return commands;
}
