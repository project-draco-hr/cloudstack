{
  VMInstanceVO vm=(VMInstanceVO)vm1;
  if (_vmSnapshotMgr.hasActiveVMSnapshotTasks(vm.getId())) {
    s_logger.error("State transit with event: " + e + " failed due to: "+ vm.getInstanceName()+ " has active VM snapshots tasks");
    return false;
  }
  State oldState=vm.getState();
  if (oldState == State.Starting) {
    if (e == Event.OperationSucceeded) {
      vm.setLastHostId(hostId);
    }
  }
 else   if (oldState == State.Stopping) {
    if (e == Event.OperationSucceeded) {
      vm.setLastHostId(vm.getHostId());
    }
  }
  return _stateMachine.transitTo(vm,e,new Pair<Long,Long>(vm.getHostId(),hostId),_vmDao);
}
