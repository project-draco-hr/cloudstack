{
  s_logger.debug("VM state transitted from :" + oldState + " to "+ newState+ " with event: "+ event+ "vm's original host id: "+ vm.getHostId()+ " new host id: "+ id);
  if (!transitionStatus) {
    return false;
  }
  if (oldState == State.Starting) {
    if (event == Event.OperationSucceeded) {
      if (vm.getLastHostId() != null && vm.getLastHostId() != id) {
        _capacityMgr.releaseVmCapacity(vm,true,false,vm.getLastHostId());
      }
      vm.setLastHostId(id);
    }
 else     if (event == Event.OperationFailed) {
      _capacityMgr.releaseVmCapacity(vm,false,false,vm.getHostId());
    }
 else     if (event == Event.OperationRetry) {
      _capacityMgr.releaseVmCapacity(vm,false,false,vm.getHostId());
    }
 else     if (event == Event.AgentReportStopped) {
      _capacityMgr.releaseVmCapacity(vm,false,true,vm.getHostId());
    }
  }
 else   if (oldState == State.Running) {
    if (event == Event.AgentReportStopped) {
      _capacityMgr.releaseVmCapacity(vm,false,true,vm.getHostId());
    }
  }
 else   if (oldState == State.Migrating) {
    if (event == Event.AgentReportStopped) {
      _capacityMgr.releaseVmCapacity(vm,false,true,vm.getHostId());
    }
 else     if (event == Event.MigrationFailedOnSource) {
      _capacityMgr.releaseVmCapacity(vm,false,false,id);
      id=vm.getHostId();
    }
 else     if (event == Event.MigrationFailedOnDest) {
      _capacityMgr.releaseVmCapacity(vm,false,false,vm.getHostId());
    }
 else     if (event == Event.OperationSucceeded) {
      _capacityMgr.releaseVmCapacity(vm,false,false,vm.getHostId());
      vm.setLastHostId(id);
    }
  }
 else   if (oldState == State.Stopping) {
    if (event == Event.AgentReportStopped || event == Event.OperationSucceeded) {
      _capacityMgr.releaseVmCapacity(vm,false,true,vm.getHostId());
    }
  }
 else   if (oldState == State.Stopped) {
    if (event == Event.DestroyRequested) {
      _capacityMgr.releaseVmCapacity(vm,true,false,vm.getLastHostId());
      vm.setLastHostId(null);
    }
  }
  return transitionStatus;
}
