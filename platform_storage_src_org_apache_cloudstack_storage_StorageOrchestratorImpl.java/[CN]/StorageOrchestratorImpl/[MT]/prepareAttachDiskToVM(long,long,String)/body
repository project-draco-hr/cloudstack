{
  VirtualMachine vm=_vmDao.findById(vmId);
  if (vm == null || vm.getState() != VirtualMachine.State.Running) {
    return;
  }
  VolumeVO volume=_volumeDao.findById(diskId);
  if (volume.getInstanceId() != null) {
    if (volume.getInstanceId() != vmId) {
      throw new InvalidParameterValueException("Volume " + volume + "already attached to "+ volume.getInstanceId());
    }
 else {
      return;
    }
  }
  List<VolumeVO> vols=new ArrayList<VolumeVO>();
  vols.add(volume);
  List<VolumeVO> rootDisks=_volumeDao.findByInstanceAndType(vmId,Volume.Type.ROOT);
  VolumeVO rootDisk=rootDisks.get(0);
  try {
    prepareVolumes(vols,rootDisk.getPoolId(),reservationId);
  }
 catch (  NoTransitionException e) {
    s_logger.debug("Failed to prepare volume: " + volume + ", due to"+ e.toString());
    throw new CloudRuntimeException(e.toString());
  }
  volume=_volumeDao.findById(diskId);
  volume.setInstanceId(vmId);
  _volumeDao.update(volume.getId(),volume);
}
