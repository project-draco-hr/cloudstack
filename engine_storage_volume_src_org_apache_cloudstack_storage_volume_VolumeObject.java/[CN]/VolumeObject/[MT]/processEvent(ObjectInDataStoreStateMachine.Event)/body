{
  if (this.dataStore == null) {
    return;
  }
  try {
    Volume.Event volEvent=null;
    if (this.dataStore.getRole() == DataStoreRole.ImageCache) {
      objectInStoreMgr.update(this,event);
      return;
    }
    if (this.dataStore.getRole() == DataStoreRole.Image) {
      objectInStoreMgr.update(this,event);
      if (this.volumeVO.getState() == Volume.State.Migrating || this.volumeVO.getState() == Volume.State.Copying || this.volumeVO.getState() == Volume.State.Uploaded) {
        return;
      }
      if (event == ObjectInDataStoreStateMachine.Event.CreateOnlyRequested) {
        volEvent=Volume.Event.UploadRequested;
      }
 else       if (event == ObjectInDataStoreStateMachine.Event.MigrationRequested) {
        volEvent=Volume.Event.CopyRequested;
      }
    }
 else {
      if (event == ObjectInDataStoreStateMachine.Event.CreateRequested || event == ObjectInDataStoreStateMachine.Event.CreateOnlyRequested) {
        volEvent=Volume.Event.CreateRequested;
      }
 else       if (event == ObjectInDataStoreStateMachine.Event.CopyingRequested) {
        volEvent=Volume.Event.CopyRequested;
      }
 else       if (event == ObjectInDataStoreStateMachine.Event.MigrationRequested) {
        volEvent=Volume.Event.MigrationRequested;
      }
    }
    if (event == ObjectInDataStoreStateMachine.Event.DestroyRequested) {
      volEvent=Volume.Event.DestroyRequested;
    }
 else     if (event == ObjectInDataStoreStateMachine.Event.ExpungeRequested) {
      volEvent=Volume.Event.ExpungingRequested;
    }
 else     if (event == ObjectInDataStoreStateMachine.Event.OperationSuccessed) {
      volEvent=Volume.Event.OperationSucceeded;
    }
 else     if (event == ObjectInDataStoreStateMachine.Event.OperationFailed) {
      volEvent=Volume.Event.OperationFailed;
    }
 else     if (event == ObjectInDataStoreStateMachine.Event.ResizeRequested) {
      volEvent=Volume.Event.ResizeRequested;
    }
    this.stateTransit(volEvent);
  }
 catch (  Exception e) {
    s_logger.debug("Failed to update state",e);
    throw new CloudRuntimeException("Failed to update state:" + e.toString());
  }
 finally {
    if (event == ObjectInDataStoreStateMachine.Event.OperationFailed && (this.volumeVO.getState() != Volume.State.Copying && this.volumeVO.getState() != Volume.State.Uploaded)) {
      objectInStoreMgr.delete(this);
    }
  }
}
