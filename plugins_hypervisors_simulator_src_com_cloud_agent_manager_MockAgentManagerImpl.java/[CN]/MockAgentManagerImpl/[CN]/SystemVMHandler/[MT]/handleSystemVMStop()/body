{
  Transaction txn=Transaction.open(Transaction.SIMULATOR_DB);
  try {
    if (this.mode.equalsIgnoreCase("Stop")) {
      txn.start();
      MockHost host=_mockHostDao.findByVmId(this.vmId);
      if (host != null) {
        String guid=host.getGuid();
        if (guid != null) {
          AgentResourceBase res=_resources.get(guid);
          if (res != null) {
            res.stop();
            _resources.remove(guid);
          }
        }
      }
      txn.commit();
      return;
    }
  }
 catch (  Exception ex) {
    txn.rollback();
    throw new CloudRuntimeException("Unable to get host " + guid + " due to "+ ex.getMessage(),ex);
  }
 finally {
    txn.close();
    txn=Transaction.open(Transaction.CLOUD_DB);
    txn.close();
  }
  HostVO host=hostDao.findByGuid(this.guid);
  if (host != null) {
    try {
      _resourceMgr.deleteHost(host.getId(),true,true);
    }
 catch (    Exception e) {
      s_logger.debug("Failed to delete host: ",e);
    }
  }
}
