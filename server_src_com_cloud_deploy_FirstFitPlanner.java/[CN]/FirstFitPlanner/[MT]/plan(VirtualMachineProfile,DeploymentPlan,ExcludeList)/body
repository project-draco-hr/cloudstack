{
  VirtualMachine vm=vmProfile.getVirtualMachine();
  ServiceOffering offering=vmProfile.getServiceOffering();
  DataCenter dc=_dcDao.findById(vm.getDataCenterId());
  int cpu_requested=offering.getCpu() * offering.getSpeed();
  int ram_requested=offering.getRamSize();
  if (vm.getLastHostId() != null) {
    HostVO host=_hostDao.findById(vm.getLastHostId());
    if (host.getStatus() == Status.Up) {
      boolean canDepployToLastHost=deployToHost(vm.getLastHostId(),cpu_requested,ram_requested,true);
      if (canDepployToLastHost) {
        Pod pod=_podDao.findById(vm.getPodId());
        Cluster cluster=_clusterDao.findById(host.getClusterId());
        return new DeployDestination(dc,pod,cluster,host);
      }
    }
  }
  List<HostPodVO> pods=_podDao.listByDataCenterId(plan.getDataCenterId());
  for (  HostPodVO hostPod : pods) {
    List<ClusterVO> clusters=_clusterDao.listByPodId(hostPod.getId());
    for (    ClusterVO clusterVO : clusters) {
      if (clusterVO.getHypervisorType() != vmProfile.getHypervisorType()) {
        continue;
      }
      List<HostVO> hosts=_hostDao.listByCluster(clusterVO.getId());
      for (      HostVO hostVO : hosts) {
        if (hostVO.getStatus() != Status.Up) {
          continue;
        }
        if (avoid.shouldAvoid(hostVO)) {
          continue;
        }
        boolean canDeployToHost=deployToHost(hostVO.getId(),cpu_requested,ram_requested,false);
        if (canDeployToHost) {
          Pod pod=_podDao.findById(hostPod.getId());
          Cluster cluster=_clusterDao.findById(clusterVO.getId());
          Host host=_hostDao.findById(hostVO.getId());
          return new DeployDestination(dc,pod,cluster,host);
        }
      }
    }
  }
  return null;
}
