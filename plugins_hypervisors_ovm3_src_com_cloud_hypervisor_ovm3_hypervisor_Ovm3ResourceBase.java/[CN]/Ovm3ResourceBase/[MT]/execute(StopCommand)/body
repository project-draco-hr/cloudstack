{
  String vmName=cmd.getVmName();
  State state=State.Error;
synchronized (this._vmstates) {
    state=_vmstates.get(vmName);
    this._vmstates.put(vmName,State.Stopping);
  }
  try {
    Xen vms=new Xen(c);
    Xen.Vm vm=null;
    vm=vms.getRunningVmConfig(vmName);
    if (vm == null) {
      state=State.Stopping;
      s_logger.debug("Unable to get details of vm: " + vmName + ", treating it as Stopping");
      return new StopAnswer(cmd,"success",true);
    }
    String repoId=_ovmObject.deDash(vm.getVmRootDiskPoolId());
    String vmId=vm.getVmUuid();
    vms.stopVm(repoId,vmId);
    int tries=30;
    while (vms.getRunningVmConfig(vmName) != null && tries > 0) {
      String msg="Waiting for " + vmName + " to stop";
      s_logger.debug(msg);
      tries--;
      Thread.sleep(10 * 1000);
    }
    vms.deleteVm(repoId,vmId);
    this.cleanup(vm);
    if (vms.getRunningVmConfig(vmName) != null) {
      String msg="Stop " + vmName + " failed ";
      s_logger.debug(msg);
      return new StopAnswer(cmd,msg,false);
    }
    state=State.Stopped;
    return new StopAnswer(cmd,"success",true);
  }
 catch (  Exception e) {
    s_logger.debug("Stop " + vmName + " failed ",e);
    return new StopAnswer(cmd,e.getMessage(),false);
  }
 finally {
synchronized (this._vmstates) {
      if (state != null) {
        this._vmstates.put(vmName,state);
      }
 else {
        this._vmstates.remove(vmName);
      }
    }
  }
}
