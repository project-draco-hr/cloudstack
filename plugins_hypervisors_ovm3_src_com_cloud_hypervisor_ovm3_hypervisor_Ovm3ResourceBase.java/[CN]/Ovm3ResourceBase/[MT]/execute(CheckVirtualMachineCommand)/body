{
  String vmName=cmd.getVmName();
  try {
    Xen vms=new Xen(c);
    Xen.Vm vm=vms.getRunningVmConfig(vmName);
    CloudStackPlugin plug=new CloudStackPlugin(c);
    Integer vncPort=Integer.valueOf(plug.getVncPort(vmName));
    if (vncPort == 0) {
      s_logger.warn("No VNC port for " + vmName);
    }
    Map<String,State> states=getAllVmStates();
    State vmState=states.get(vmName);
    if (vmState == null) {
      s_logger.warn("Check state of " + vmName + " return null in CheckVirtualMachineCommand");
      vmState=State.Stopped;
    }
synchronized (_vmstates) {
      _vmstates.put(vmName,State.Running);
    }
    return new CheckVirtualMachineAnswer(cmd,vmState,vncPort);
  }
 catch (  Exception e) {
    s_logger.debug("Check migration for " + vmName + " failed",e);
    return new CheckVirtualMachineAnswer(cmd,State.Stopped,null);
  }
}
