{
  Map<String,Xen.Vm> vms=getAllVms();
  final HashMap<String,State> states=new HashMap<String,State>();
  for (  final Map.Entry<String,Xen.Vm> entry : vms.entrySet()) {
    Xen.Vm vm=entry.getValue();
    if (vm.isControlDomain()) {
      continue;
    }
    State ns=State.Running;
    String as=vm.getVmState();
    if (as == null) {
      ns=State.Stopped;
      continue;
    }
    if (as.contains("r")) {
      ns=State.Running;
    }
 else     if (as.contains("b")) {
      ns=State.Running;
    }
 else     if (as.contains("p")) {
      ns=State.Running;
    }
 else     if (as.contains("s")) {
      if (this._vmstates.get(vm.getVmName()) == State.Migrating)       ns=State.Migrating;
      ns=State.Stopped;
    }
 else     if (as.contains("c")) {
      ns=State.Error;
    }
 else     if (as.contains("d")) {
      ns=State.Stopping;
    }
 else {
      ns=State.Unknown;
    }
    s_logger.debug("state " + ns + " for "+ vm.getVmName()+ " based on "+ as);
    states.put(vm.getVmName(),ns);
  }
  return states;
}
