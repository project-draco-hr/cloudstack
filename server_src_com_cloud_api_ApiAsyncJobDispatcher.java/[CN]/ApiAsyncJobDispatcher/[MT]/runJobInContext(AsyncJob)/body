{
  BaseAsyncCmd cmdObj=null;
  try {
    final Class<?> cmdClass=Class.forName(job.getCmd());
    cmdObj=(BaseAsyncCmd)cmdClass.newInstance();
    cmdObj=ComponentContext.inject(cmdObj);
    cmdObj.configure();
    cmdObj.setJob(job);
    final Type mapType=new TypeToken<Map<String,String>>(){
    }
.getType();
    final Gson gson=ApiGsonHelper.getBuilder().create();
    final Map<String,Object> params=gson.fromJson(job.getCmdInfo(),mapType);
    final String userIdStr=(String)params.get("ctxUserId");
    final String acctIdStr=(String)params.get("ctxAccountId");
    Long userId=null;
    Account accountObject=null;
    if (cmdObj instanceof BaseAsyncCreateCmd) {
      final BaseAsyncCreateCmd create=(BaseAsyncCreateCmd)cmdObj;
      create.setEntityId(Long.parseLong((String)params.get("id")));
      create.setEntityUuid((String)params.get("uuid"));
    }
    User user=null;
    if (userIdStr != null) {
      userId=Long.parseLong(userIdStr);
      user=_entityMgr.findById(User.class,userId);
    }
    if (acctIdStr != null) {
      accountObject=_entityMgr.findById(Account.class,Long.parseLong(acctIdStr));
    }
    CallContext.register(user,accountObject,job.getRelated());
    try {
      _dispatcher.dispatch(cmdObj,params,true);
      _asyncJobMgr.completeAsyncJob(job.getId(),JobInfo.Status.SUCCEEDED,0,ApiSerializerHelper.toSerializedString(cmdObj.getResponseObject()));
    }
  finally {
      CallContext.unregister();
    }
  }
 catch (  final Throwable e) {
    String errorMsg=null;
    int errorCode=ApiErrorCode.INTERNAL_ERROR.getHttpCode();
    if (!(e instanceof ServerApiException)) {
      s_logger.error("Unexpected exception while executing " + job.getCmd(),e);
      errorMsg=e.getMessage();
    }
 else {
      final ServerApiException sApiEx=(ServerApiException)e;
      errorMsg=sApiEx.getDescription();
      errorCode=sApiEx.getErrorCode().getHttpCode();
    }
    final ExceptionResponse response=new ExceptionResponse();
    response.setErrorCode(errorCode);
    response.setErrorText(errorMsg);
    response.setResponseName((cmdObj == null) ? "unknowncommandresponse" : cmdObj.getCommandName());
    _asyncJobMgr.completeAsyncJob(job.getId(),JobInfo.Status.FAILED,ApiErrorCode.INTERNAL_ERROR.getHttpCode(),ApiSerializerHelper.toSerializedString(response));
  }
}
