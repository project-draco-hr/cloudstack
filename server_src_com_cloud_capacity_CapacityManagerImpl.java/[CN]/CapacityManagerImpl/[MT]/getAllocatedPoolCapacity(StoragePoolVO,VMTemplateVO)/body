{
  Pair<Long,Long> sizes=_volumeDao.getNonDestroyedCountAndTotalByPool(pool.getId());
  long totalAllocatedSize=sizes.second() + sizes.first() * _extraBytesPerVolume;
  totalAllocatedSize=totalAllocatedSize + getVMSnapshotAllocatedCapacity(pool);
  boolean tmpinstalled=false;
  List<VMTemplateStoragePoolVO> templatePoolVOs;
  templatePoolVOs=_templatePoolDao.listByPoolId(pool.getId());
  for (  VMTemplateStoragePoolVO templatePoolVO : templatePoolVOs) {
    if ((templateForVmCreation != null) && !tmpinstalled && (templatePoolVO.getTemplateId() == templateForVmCreation.getId())) {
      tmpinstalled=true;
    }
    long templateSize=templatePoolVO.getTemplateSize();
    totalAllocatedSize+=templateSize + _extraBytesPerVolume;
  }
  return totalAllocatedSize;
}
