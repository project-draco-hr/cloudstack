{
  long totalAllocatedSize=0;
  if (pool.isManaged()) {
    totalAllocatedSize=getUsedBytes(pool);
  }
 else {
    Pair<Long,Long> sizes=_volumeDao.getNonDestroyedCountAndTotalByPool(pool.getId());
    totalAllocatedSize=sizes.second() + sizes.first() * _extraBytesPerVolume;
  }
  totalAllocatedSize=totalAllocatedSize + _volumeDao.getVMSnapshotSizeByPool(pool.getId());
  boolean tmpinstalled=false;
  List<VMTemplateStoragePoolVO> templatePoolVOs;
  templatePoolVOs=_templatePoolDao.listByPoolId(pool.getId());
  for (  VMTemplateStoragePoolVO templatePoolVO : templatePoolVOs) {
    if ((templateForVmCreation != null) && !tmpinstalled && (templatePoolVO.getTemplateId() == templateForVmCreation.getId())) {
      tmpinstalled=true;
    }
    long templateSize=templatePoolVO.getTemplateSize();
    totalAllocatedSize+=templateSize + _extraBytesPerVolume;
  }
  return totalAllocatedSize;
}
