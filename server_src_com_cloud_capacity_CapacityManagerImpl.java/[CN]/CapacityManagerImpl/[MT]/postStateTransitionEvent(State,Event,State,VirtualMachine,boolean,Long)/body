{
  s_logger.debug("VM state transitted from :" + oldState + " to "+ newState+ " with event: "+ event+ "vm's original host id: "+ vm.getLastHostId()+ " new host id: "+ vm.getHostId());
  if (!status) {
    return false;
  }
  if (oldState == State.Starting) {
    if (event == Event.OperationFailed) {
      releaseVmCapacity(vm,false,false,oldHostId);
    }
 else     if (event == Event.OperationRetry) {
      releaseVmCapacity(vm,false,false,oldHostId);
    }
 else     if (event == Event.AgentReportStopped) {
      releaseVmCapacity(vm,false,true,oldHostId);
    }
  }
 else   if (oldState == State.Running) {
    if (event == Event.AgentReportStopped) {
      releaseVmCapacity(vm,false,true,oldHostId);
    }
  }
 else   if (oldState == State.Migrating) {
    if (event == Event.AgentReportStopped) {
      releaseVmCapacity(vm,false,false,vm.getLastHostId());
      releaseVmCapacity(vm,false,true,oldHostId);
    }
 else     if (event == Event.OperationFailed) {
      releaseVmCapacity(vm,false,false,oldHostId);
    }
 else     if (event == Event.OperationSucceeded) {
      releaseVmCapacity(vm,false,false,vm.getLastHostId());
    }
  }
 else   if (oldState == State.Stopping) {
    if (event == Event.AgentReportStopped || event == Event.OperationSucceeded) {
      releaseVmCapacity(vm,false,true,oldHostId);
    }
  }
 else   if (oldState == State.Stopped) {
    if (event == Event.DestroyRequested) {
      releaseVmCapacity(vm,true,false,vm.getLastHostId());
    }
  }
  if ((newState == State.Starting || newState == State.Migrating) && vm.getHostId() != null) {
    boolean fromLastHost=false;
    if (vm.getLastHostId() == vm.getHostId()) {
      s_logger.debug("VM starting again on the last host it was stopped on");
      fromLastHost=true;
    }
    allocateVmCapacity(vm,fromLastHost);
  }
  return true;
}
