{
  Map<KvmDummyResourceBase,Map<String,String>> resources=new HashMap<KvmDummyResourceBase,Map<String,String>>();
  Map<String,String> details=new HashMap<String,String>();
  if (!uri.getScheme().equals("http")) {
    String msg="urlString is not http so we're not taking care of the discovery for this: " + uri;
    s_logger.debug(msg);
    return null;
  }
  com.trilead.ssh2.Connection sshConnection=null;
  String agentIp=null;
  try {
    String hostname=uri.getHost();
    InetAddress ia=InetAddress.getByName(hostname);
    agentIp=ia.getHostAddress();
    String guid=UUID.nameUUIDFromBytes(agentIp.getBytes()).toString();
    String guidWithTail=guid + "-LibvirtComputingResource";
    if (_hostDao.findByGuid(guidWithTail) != null) {
      s_logger.debug("Skipping " + agentIp + " because "+ guidWithTail+ " is already in the database.");
      return null;
    }
    sshConnection=new com.trilead.ssh2.Connection(agentIp,22);
    sshConnection.connect(null,60000,60000);
    if (!sshConnection.authenticateWithPassword(username,password)) {
      s_logger.debug("Failed to authenticate");
      return null;
    }
    if (!sshExecuteCmd(sshConnection,"lsmod|grep kvm >& /dev/null",3)) {
      s_logger.debug("It's not a KVM enabled machine");
      return null;
    }
    s_logger.debug("copying " + _setupAgentPath + " to host");
    SCPClient scp=new SCPClient(sshConnection);
    scp.put(_setupAgentPath,"/usr/bin","0755");
    String parameters=" -h " + _hostIp + " -z "+ dcId+ " -p "+ podId+ " -c "+ clusterId+ " -u "+ guid;
    if (_kvmPublicNic != null) {
      parameters+=" -P " + _kvmPublicNic;
    }
    if (_kvmPrivateNic != null) {
      parameters+=" -N " + _kvmPrivateNic;
    }
    sshExecuteCmd(sshConnection,"/usr/bin/setup_agent.sh " + parameters + " 1>&2",3);
    KvmDummyResourceBase kvmResource=new KvmDummyResourceBase();
    Map<String,Object> params=new HashMap<String,Object>();
    params.put("zone",Long.toString(dcId));
    params.put("pod",Long.toString(podId));
    params.put("cluster",Long.toString(clusterId));
    params.put("guid",guid);
    params.put("agentIp",agentIp);
    kvmResource.configure("kvm agent",params);
    resources.put(kvmResource,details);
    HostVO connectedHost=waitForHostConnect(dcId,podId,clusterId,guidWithTail);
    if (connectedHost == null)     return null;
    details.put("guid",guidWithTail);
    ClusterVO clu=_clusterDao.findById(clusterId);
    clu.setHypervisorType(HypervisorType.KVM.toString());
    _clusterDao.update(clusterId,clu);
    return resources;
  }
 catch (  Exception e) {
    String msg=" can't setup agent, due to " + e.toString() + " - "+ e.getMessage();
    s_logger.warn(msg);
  }
 finally {
    if (sshConnection != null)     sshConnection.close();
  }
  return null;
}
