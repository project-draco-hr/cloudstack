{
  String value=_configDao.getValue(Config.PrimaryStorageDownloadWait.toString());
  int primaryStorageDownloadWait=NumbersUtil.parseInt(value,Integer.parseInt(Config.PrimaryStorageDownloadWait.getDefaultValue()));
  CopyCommand copyCommand=new CopyCommand(snapshotInfo.getTO(),volumeInfo.getTO(),primaryStorageDownloadWait,VirtualMachineManager.ExecuteInSequence.value());
  CopyCmdAnswer copyCmdAnswer=null;
  try {
    _volumeService.grantAccess(snapshotInfo,hostVO,snapshotInfo.getDataStore());
    _volumeService.grantAccess(volumeInfo,hostVO,volumeInfo.getDataStore());
    Map<String,String> srcDetails=getSnapshotDetails(snapshotInfo);
    copyCommand.setOptions(srcDetails);
    Map<String,String> destDetails=getVolumeDetails(volumeInfo);
    copyCommand.setOptions2(destDetails);
    copyCmdAnswer=(CopyCmdAnswer)_agentMgr.send(hostVO.getId(),copyCommand);
  }
 catch (  CloudRuntimeException|AgentUnavailableException|OperationTimedoutException ex) {
    String msg="Failed to perform VDI copy : ";
    LOGGER.warn(msg,ex);
    throw new CloudRuntimeException(msg + ex.getMessage());
  }
 finally {
    _volumeService.revokeAccess(snapshotInfo,hostVO,snapshotInfo.getDataStore());
    _volumeService.revokeAccess(volumeInfo,hostVO,volumeInfo.getDataStore());
  }
  return copyCmdAnswer;
}
