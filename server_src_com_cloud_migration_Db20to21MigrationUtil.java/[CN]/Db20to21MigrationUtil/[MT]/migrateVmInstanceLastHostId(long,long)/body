{
  SearchBuilder<VMInstanceVO> sb=_vmInstanceDao.createSearchBuilder();
  sb.and("zoneId",sb.entity().getDataCenterIdToDeployIn(),Op.EQ);
  sb.and("podId",sb.entity().getPodIdToDeployIn(),Op.EQ);
  sb.done();
  Random rand=new Random();
  SearchCriteria<VMInstanceVO> sc=sb.create();
  sc.setParameters("zoneId",zoneId);
  sc.setParameters("podId",podId);
  List<VMInstanceVO> vmInstances=_vmInstanceDao.searchIncludingRemoved(sc,null,false,false);
  List<HostVO> podHosts=getHostsInPod(zoneId,podId);
  for (  VMInstanceVO vm : vmInstances) {
    if (vm.getHostId() != null) {
      vm.setLastHostId(vm.getHostId());
    }
 else {
      if (podHosts.size() > 0) {
        int next=rand.nextInt(podHosts.size());
        vm.setLastHostId(podHosts.get(next).getId());
      }
    }
    _vmInstanceDao.update(vm.getId(),vm);
  }
}
