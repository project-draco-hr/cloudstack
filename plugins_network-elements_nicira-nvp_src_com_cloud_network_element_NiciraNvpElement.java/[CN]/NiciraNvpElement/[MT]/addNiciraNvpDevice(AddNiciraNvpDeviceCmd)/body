{
  ServerResource resource=new NiciraNvpResource();
  String deviceName=Network.Provider.NiciraNvp.getName();
  NetworkDevice networkDevice=NetworkDevice.getNetworkDevice(deviceName);
  Long physicalNetworkId=cmd.getPhysicalNetworkId();
  NiciraNvpDeviceVO niciraNvpDevice=null;
  PhysicalNetworkVO physicalNetwork=_physicalNetworkDao.findById(physicalNetworkId);
  if (physicalNetwork == null) {
    throw new InvalidParameterValueException("Could not find phyical network with ID: " + physicalNetworkId);
  }
  long zoneId=physicalNetwork.getDataCenterId();
  PhysicalNetworkServiceProviderVO ntwkSvcProvider=_physicalNetworkServiceProviderDao.findByServiceProvider(physicalNetwork.getId(),networkDevice.getNetworkServiceProvder());
  if (ntwkSvcProvider == null) {
    throw new CloudRuntimeException("Network Service Provider: " + networkDevice.getNetworkServiceProvder() + " is not enabled in the physical network: "+ physicalNetworkId+ "to add this device");
  }
 else   if (ntwkSvcProvider.getState() == PhysicalNetworkServiceProvider.State.Shutdown) {
    throw new CloudRuntimeException("Network Service Provider: " + ntwkSvcProvider.getProviderName() + " is in shutdown state in the physical network: "+ physicalNetworkId+ "to add this device");
  }
  if (_niciraNvpDao.listByPhysicalNetwork(physicalNetworkId).size() != 0) {
    throw new CloudRuntimeException("A NiciraNvp device is already configured on this physical network");
  }
  Map<String,String> params=new HashMap<String,String>();
  params.put("guid",UUID.randomUUID().toString());
  params.put("zoneId",String.valueOf(physicalNetwork.getDataCenterId()));
  params.put("physicalNetworkId",String.valueOf(physicalNetwork.getId()));
  params.put("name","Nicira Controller - " + cmd.getHost());
  params.put("ip",cmd.getHost());
  params.put("adminuser",cmd.getUsername());
  params.put("adminpass",cmd.getPassword());
  params.put("transportzoneuuid",cmd.getTransportzoneUuid());
  params.put("transportzoneisotype",physicalNetwork.getIsolationMethods().get(0).toLowerCase());
  if (cmd.getL3GatewayServiceUuid() != null) {
    params.put("l3gatewayserviceuuid",cmd.getL3GatewayServiceUuid());
  }
  Map<String,Object> hostdetails=new HashMap<String,Object>();
  hostdetails.putAll(params);
  Transaction txn=Transaction.currentTxn();
  try {
    resource.configure(cmd.getHost(),hostdetails);
    Host host=_resourceMgr.addHost(zoneId,resource,Host.Type.L2Networking,params);
    if (host != null) {
      txn.start();
      niciraNvpDevice=new NiciraNvpDeviceVO(host.getId(),physicalNetworkId,ntwkSvcProvider.getProviderName(),deviceName);
      _niciraNvpDao.persist(niciraNvpDevice);
      DetailVO detail=new DetailVO(host.getId(),"niciranvpdeviceid",String.valueOf(niciraNvpDevice.getId()));
      _hostDetailsDao.persist(detail);
      txn.commit();
      return niciraNvpDevice;
    }
 else {
      throw new CloudRuntimeException("Failed to add Nicira Nvp Device due to internal error.");
    }
  }
 catch (  ConfigurationException e) {
    txn.rollback();
    throw new CloudRuntimeException(e.getMessage());
  }
}
