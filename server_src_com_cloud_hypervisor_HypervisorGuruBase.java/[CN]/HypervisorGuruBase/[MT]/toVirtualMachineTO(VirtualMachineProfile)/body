{
  ServiceOffering offering=vmProfile.getServiceOffering();
  VirtualMachine vm=vmProfile.getVirtualMachine();
  Long minMemory=(long)(offering.getRamSize() / vmProfile.getMemoryOvercommitRatio());
  int minspeed=(int)(offering.getSpeed() / vmProfile.getCpuOvercommitRatio());
  int maxspeed=(offering.getSpeed());
  VirtualMachineTO to=new VirtualMachineTO(vm.getId(),vm.getInstanceName(),vm.getType(),offering.getCpu(),minspeed,maxspeed,minMemory * 1024l * 1024l,offering.getRamSize() * 1024l * 1024l,null,null,vm.isHaEnabled(),vm.limitCpuUse(),vm.getVncPassword());
  to.setBootArgs(vmProfile.getBootArgs());
  List<NicProfile> nicProfiles=vmProfile.getNics();
  NicTO[] nics=new NicTO[nicProfiles.size()];
  int i=0;
  for (  NicProfile nicProfile : nicProfiles) {
    nics[i++]=toNicTO(nicProfile);
  }
  to.setNics(nics);
  to.setDisks(vmProfile.getDisks().toArray(new DiskTO[vmProfile.getDisks().size()]));
  if (vmProfile.getTemplate().getBits() == 32) {
    to.setArch("i686");
  }
 else {
    to.setArch("x86_64");
  }
  long templateId=vm.getTemplateId();
  Map<String,String> details=_templateDetailsDao.findDetails(templateId);
  assert(details != null);
  Map<String,String> detailsInVm=vm.getDetails();
  if (detailsInVm != null) {
    details.putAll(detailsInVm);
  }
  to.setDetails(details);
  VMInstanceVO vmInstance=_virtualMachineDao.findById(to.getId());
  Boolean isDynamicallyScalable=vmInstance.isDynamicallyScalable() && Boolean.parseBoolean(_configServer.getConfigValue(Config.EnableDynamicallyScaleVm.key(),Config.ConfigurationParameterScope.zone.toString(),vm.getDataCenterId()));
  to.setEnableDynamicallyScaleVm(isDynamicallyScalable);
  to.setUuid(vmInstance.getUuid());
  return to;
}
