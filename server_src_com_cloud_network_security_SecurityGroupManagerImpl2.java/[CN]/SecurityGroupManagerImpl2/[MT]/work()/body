{
  while (true) {
    try {
      s_logger.trace("Checking the work queue");
      List<SecurityGroupWork> workItems=_workQueue.getWork(1);
      for (      SecurityGroupWork work : workItems) {
        if (s_logger.isTraceEnabled()) {
          s_logger.trace("Processing " + work.getInstanceId());
        }
        try {
          VmRulesetLogVO rulesetLog=_rulesetLogDao.findByVmId(work.getInstanceId());
          if (rulesetLog == null) {
            s_logger.warn("Could not find ruleset log for vm " + work.getInstanceId());
            continue;
          }
          work.setLogsequenceNumber(rulesetLog.getLogsequence());
          sendRulesetUpdates(work);
        }
 catch (        Exception e) {
          s_logger.error("Problem during SG work " + work,e);
          work.setStep(Step.Error);
        }
      }
    }
 catch (    final Throwable th) {
      s_logger.error("Caught this throwable, ",th);
    }
  }
}
