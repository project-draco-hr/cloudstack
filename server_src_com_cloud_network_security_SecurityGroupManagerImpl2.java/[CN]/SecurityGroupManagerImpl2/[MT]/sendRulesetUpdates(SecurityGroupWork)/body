{
  Long userVmId=work.getInstanceId();
  UserVm vm=_userVMDao.findById(userVmId);
  if (vm != null && vm.getState() == State.Running) {
    Map<PortAndProto,Set<String>> rules=generateRulesForVM(userVmId);
    Long agentId=vm.getHostId();
    if (agentId != null) {
      SecurityIngressRulesCmd cmd=generateRulesetCmd(vm.getInstanceName(),vm.getPrivateIpAddress(),vm.getPrivateMacAddress(),vm.getId(),generateRulesetSignature(rules),work.getLogsequenceNumber(),rules);
      if (s_logger.isTraceEnabled()) {
        s_logger.trace("SecurityGroupManager v2: sending ruleset update for vm " + vm.getInstanceName() + ": num rules="+ cmd.getRuleSet().length+ " num cidrs="+ cmd.getTotalNumCidrs());
      }
      Commands cmds=new Commands(cmd);
      try {
        _agentMgr.send(agentId,cmds,_answerListener);
        if (s_logger.isTraceEnabled()) {
          s_logger.trace("SecurityGroupManager v2: sent ruleset updates for " + vm.getInstanceName() + " curr queue size="+ _workQueue.size());
        }
      }
 catch (      AgentUnavailableException e) {
        s_logger.debug("Unable to send updates for vm: " + userVmId + "(agentid="+ agentId+ ")");
      }
    }
  }
 else {
    if (s_logger.isTraceEnabled()) {
      if (vm != null)       s_logger.trace("No rules sent to vm " + vm + "state="+ vm.getState());
 else       s_logger.trace("Could not find vm: No rules sent to vm " + userVmId);
    }
  }
}
