{
  if (nic.getIp4Address() == null) {
    PublicIp ip=_networkMgr.fetchNewPublicIp(dc.getId(),VlanType.DirectAttached,vm.getOwner(),network.getId(),false);
    nic.setIp4Address(ip.getAddress());
    nic.setGateway(ip.getGateway());
    nic.setNetmask(ip.getNetmask());
    nic.setIsolationUri(IsolationType.Vlan.toUri(ip.getVlanTag()));
    nic.setBroadcastType(BroadcastDomainType.Vlan);
    nic.setBroadcastUri(BroadcastDomainType.Vlan.toUri(ip.getVlanTag()));
    nic.setFormat(AddressFormat.Ip4);
    nic.setReservationId(ip.getVlanTag());
    nic.setMacAddress(NetUtils.long2Mac(ip.getMacAddress() | 0x060000000000l | (((long)_rand.nextInt(32768) << 25) & 0x00fffe000000l)));
  }
  nic.setDns1(dc.getDns1());
  nic.setDns2(dc.getDns2());
}
