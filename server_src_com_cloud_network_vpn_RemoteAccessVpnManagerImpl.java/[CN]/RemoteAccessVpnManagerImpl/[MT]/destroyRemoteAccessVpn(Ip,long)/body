{
  long userId=UserContext.current().getCallerUserId();
  Account caller=UserContext.current().getCaller();
  RemoteAccessVpnVO vpn=_remoteAccessVpnDao.findById(ip);
  if (vpn == null) {
    s_logger.debug("vpn does not exists " + ip);
    return;
  }
  _accountMgr.checkAccess(caller,vpn);
  Account owner=_accountDao.findById(vpn.getAccountId());
  Network network=_networkMgr.getNetwork(vpn.getNetworkId());
  EventUtils.saveStartedEvent(userId,owner.getId(),EventTypes.EVENT_REMOTE_ACCESS_VPN_DESTROY,"Deleting Remote Access VPN for account: " + owner.getAccountName() + " in "+ ip,startEventId);
  vpn.setState(RemoteAccessVpn.State.Removed);
  _remoteAccessVpnDao.update(vpn.getServerAddress(),vpn);
  List<? extends RemoteAccessVpnElement> elements=_networkMgr.getRemoteAccessVpnElements();
  boolean success=false;
  try {
    for (    RemoteAccessVpnElement element : elements) {
      if (element.stop(network,vpn)) {
        success=true;
        break;
      }
    }
  }
  finally {
    if (!success) {
      EventUtils.saveEvent(userId,owner.getId(),EventVO.LEVEL_ERROR,EventTypes.EVENT_REMOTE_ACCESS_VPN_DESTROY,"Unable to delete Remote Access VPN ",owner.getAccountName());
    }
 else {
      Transaction txn=Transaction.currentTxn();
      try {
        txn.start();
        _remoteAccessVpnDao.remove(ip);
        List<FirewallRuleVO> ports=_rulesDao.listByIpAndPurpose(ip,Purpose.Vpn);
        if (ports != null) {
          for (          FirewallRuleVO port : ports) {
            _rulesDao.remove(port.getId());
            s_logger.debug("Successfully removed firewall rule with ip " + port.getSourceIpAddress() + " and port "+ port.getSourcePortStart()+ " as a part of vpn cleanup");
          }
        }
        EventUtils.saveEvent(userId,owner.getId(),EventTypes.EVENT_REMOTE_ACCESS_VPN_DESTROY,"Deleted Remote Access VPN for account: " + owner.getAccountName());
        txn.commit();
      }
 catch (      Exception ex) {
        txn.rollback();
        s_logger.warn("Unable to release the three vpn ports from the firewall rules",ex);
      }
    }
  }
}
