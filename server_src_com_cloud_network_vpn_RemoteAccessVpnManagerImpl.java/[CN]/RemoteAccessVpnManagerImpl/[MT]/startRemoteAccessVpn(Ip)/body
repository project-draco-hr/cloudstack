{
  long userId=UserContext.current().getCallerUserId();
  Account caller=UserContext.current().getCaller();
  RemoteAccessVpnVO vpn=_remoteAccessVpnDao.findById(vpnId);
  if (vpn == null) {
    throw new InvalidParameterValueException("Unable to find your vpn: " + vpnId);
  }
  _accountMgr.checkAccess(caller,vpn);
  Account owner=_accountDao.findById(vpn.getAccountId());
  Network network=_networkMgr.getNetwork(vpn.getNetworkId());
  EventUtils.saveStartedEvent(userId,owner.getId(),EventTypes.EVENT_REMOTE_ACCESS_VPN_CREATE,"Creating a Remote Access VPN for account: " + owner.getAccountName() + " in zone ");
  List<? extends RemoteAccessVpnElement> elements=_networkMgr.getRemoteAccessVpnElements();
  boolean started=false;
  try {
    for (    RemoteAccessVpnElement element : elements) {
      if (element.start(network,vpn)) {
        started=true;
        break;
      }
    }
    return vpn;
  }
  finally {
    if (started) {
      EventUtils.saveEvent(userId,owner.getId(),EventTypes.EVENT_REMOTE_ACCESS_VPN_CREATE,"Created a Remote Access VPN for account: " + owner.getAccountName());
      vpn.setState(RemoteAccessVpn.State.Running);
      _remoteAccessVpnDao.update(vpn.getServerAddress(),vpn);
    }
 else {
      EventUtils.saveEvent(userId,owner.getId(),EventVO.LEVEL_ERROR,EventTypes.EVENT_REMOTE_ACCESS_VPN_CREATE,"Unable to create Remote Access VPN ",owner.getAccountName());
    }
  }
}
