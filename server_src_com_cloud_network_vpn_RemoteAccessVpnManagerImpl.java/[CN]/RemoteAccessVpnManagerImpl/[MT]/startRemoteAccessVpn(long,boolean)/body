{
  Account caller=CallContext.current().getCallingAccount();
  final RemoteAccessVpnVO vpn=_remoteAccessVpnDao.findByPublicIpAddress(ipAddressId);
  if (vpn == null) {
    throw new InvalidParameterValueException("Unable to find your vpn: " + ipAddressId);
  }
  if (vpn.getVpcId() != null) {
    openFirewall=false;
  }
  _accountMgr.checkAccess(caller,null,vpn);
  boolean started=false;
  try {
    boolean firewallOpened=true;
    if (openFirewall) {
      firewallOpened=_firewallMgr.applyIngressFirewallRules(vpn.getServerAddressId(),caller);
    }
    if (firewallOpened) {
      for (      RemoteAccessVPNServiceProvider element : _vpnServiceProviders) {
        if (element.startVpn(vpn)) {
          started=true;
          break;
        }
      }
    }
    return vpn;
  }
  finally {
    if (started) {
      Transaction.execute(new TransactionCallbackNoReturn(){
        @Override public void doInTransactionWithoutResult(        TransactionStatus status){
          vpn.setState(RemoteAccessVpn.State.Running);
          _remoteAccessVpnDao.update(vpn.getId(),vpn);
          List<VpnUserVO> vpnUsers=_vpnUsersDao.listByAccount(vpn.getAccountId());
          for (          VpnUserVO user : vpnUsers) {
            if (user.getState() != VpnUser.State.Revoke) {
              UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VPN_USER_ADD,user.getAccountId(),0,user.getId(),user.getUsername(),user.getClass().getName(),user.getUuid());
            }
          }
        }
      }
);
    }
  }
}
