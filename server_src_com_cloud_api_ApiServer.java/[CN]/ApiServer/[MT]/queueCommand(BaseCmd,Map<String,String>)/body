{
  UserContext ctx=UserContext.current();
  Long callerUserId=ctx.getCallerUserId();
  Account caller=ctx.getCaller();
  BaseCmd realCmdObj=ComponentContext.getTargetObject(cmdObj);
  if (realCmdObj instanceof BaseAsyncCmd) {
    Long objectId=null;
    String objectUuid=null;
    if (realCmdObj instanceof BaseAsyncCreateCmd) {
      BaseAsyncCreateCmd createCmd=(BaseAsyncCreateCmd)cmdObj;
      _dispatcher.dispatchCreateCmd(createCmd,params);
      objectId=createCmd.getEntityId();
      objectUuid=createCmd.getEntityUuid();
      params.put("id",objectId.toString());
    }
 else {
      ApiDispatcher.processParameters(cmdObj,params);
    }
    BaseAsyncCmd asyncCmd=(BaseAsyncCmd)cmdObj;
    if (callerUserId != null) {
      params.put("ctxUserId",callerUserId.toString());
    }
    if (caller != null) {
      params.put("ctxAccountId",String.valueOf(caller.getId()));
    }
    long startEventId=ctx.getStartEventId();
    asyncCmd.setStartEventId(startEventId);
    Long eventId=EventUtils.saveScheduledEvent((callerUserId == null) ? User.UID_SYSTEM : callerUserId,asyncCmd.getEntityOwnerId(),asyncCmd.getEventType(),asyncCmd.getEventDescription(),startEventId);
    if (startEventId == 0) {
      startEventId=eventId;
    }
    params.put("ctxStartEventId",String.valueOf(startEventId));
    ctx.setAccountId(asyncCmd.getEntityOwnerId());
    Long instanceId=(objectId == null) ? asyncCmd.getInstanceId() : objectId;
    AsyncJobVO job=new AsyncJobVO(callerUserId,caller.getId(),cmdObj.getClass().getName(),ApiGsonHelper.getBuilder().create().toJson(params),instanceId,asyncCmd.getInstanceType());
    long jobId=_asyncMgr.submitAsyncJob(job);
    if (jobId == 0L) {
      String errorMsg="Unable to schedule async job for command " + job.getCmd();
      s_logger.warn(errorMsg);
      throw new ServerApiException(BaseCmd.INTERNAL_ERROR,errorMsg);
    }
    if (objectId != null) {
      String objUuid=(objectUuid == null) ? objectId.toString() : objectUuid;
      return ((BaseAsyncCreateCmd)asyncCmd).getResponse(jobId,objUuid);
    }
    SerializationContext.current().setUuidTranslation(true);
    return ApiResponseSerializer.toSerializedString(asyncCmd.getResponse(jobId),asyncCmd.getResponseType());
  }
 else {
    _dispatcher.dispatch(cmdObj,params);
    if (realCmdObj instanceof BaseListCmd && !(realCmdObj instanceof ListVMsCmd) && !(realCmdObj instanceof ListRoutersCmd)&& !(realCmdObj instanceof ListSecurityGroupsCmd)&& !(realCmdObj instanceof ListTagsCmd)&& !(realCmdObj instanceof ListEventsCmd)&& !(realCmdObj instanceof ListVMGroupsCmd)&& !(realCmdObj instanceof ListProjectsCmd)&& !(realCmdObj instanceof ListProjectAccountsCmd)&& !(realCmdObj instanceof ListProjectInvitationsCmd)&& !(realCmdObj instanceof ListHostsCmd)&& !(realCmdObj instanceof ListVolumesCmd)&& !(realCmdObj instanceof ListUsersCmd)&& !(realCmdObj instanceof ListAccountsCmd)&& !(realCmdObj instanceof ListStoragePoolsCmd)) {
      buildAsyncListResponse((BaseListCmd)cmdObj,caller);
    }
    SerializationContext.current().setUuidTranslation(true);
    return ApiResponseSerializer.toSerializedString((ResponseObject)cmdObj.getResponseObject(),cmdObj.getResponseType());
  }
}
