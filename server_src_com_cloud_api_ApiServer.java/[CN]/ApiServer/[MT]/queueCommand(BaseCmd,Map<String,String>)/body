{
  UserContext ctx=UserContext.current();
  Long userId=ctx.getUserId();
  Account account=ctx.getAccount();
  if (cmdObj instanceof BaseAsyncCmd) {
    Long objectId=null;
    if (cmdObj instanceof BaseAsyncCreateCmd) {
      BaseAsyncCreateCmd createCmd=(BaseAsyncCreateCmd)cmdObj;
      _dispatcher.dispatchCreateCmd(createCmd,params);
      objectId=createCmd.getId();
      params.put("id",objectId.toString());
    }
 else {
      ApiDispatcher.setupParameters(cmdObj,params);
    }
    BaseAsyncCmd asyncCmd=(BaseAsyncCmd)cmdObj;
    if (objectId != null) {
      objectId=asyncCmd.getInstanceId();
    }
    if (userId != null) {
      params.put("ctxUserId",userId.toString());
    }
    if (account != null) {
      params.put("ctxAccountId",String.valueOf(account.getId()));
    }
    Long eventId=EventUtils.saveScheduledEvent((userId == null) ? User.UID_SYSTEM : userId,asyncCmd.getAccountId(),asyncCmd.getEventType(),asyncCmd.getEventDescription());
    if (eventId != null) {
      params.put("starteventid",eventId.toString());
    }
    AsyncJobVO job=new AsyncJobVO();
    job.setInstanceId(asyncCmd.getInstanceId());
    job.setInstanceType(asyncCmd.getInstanceType());
    job.setUserId(userId);
    if (account != null) {
      job.setAccountId(ctx.getAccount().getId());
    }
 else {
      job.setAccountId(1L);
    }
    job.setCmd(cmdObj.getClass().getName());
    job.setCmdInfo(ApiGsonHelper.getBuilder().create().toJson(params));
    long jobId=_asyncMgr.submitAsyncJob(job);
    if (objectId != null) {
      return ((BaseAsyncCreateCmd)asyncCmd).getResponse(jobId,objectId);
    }
    return ApiResponseSerializer.toSerializedString(asyncCmd.getResponse(jobId),asyncCmd.getResponseType());
  }
 else {
    _dispatcher.dispatch(cmdObj,params);
    if (cmdObj instanceof BaseListCmd) {
      buildAsyncListResponse((BaseListCmd)cmdObj,account);
    }
    return ApiResponseSerializer.toSerializedString((ResponseObject)cmdObj.getResponseObject(),cmdObj.getResponseType());
  }
}
