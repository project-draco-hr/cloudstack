{
  StringBuffer sb=new StringBuffer();
  HttpServerConnection connObj=(HttpServerConnection)context.getAttribute("http.connection");
  if (connObj instanceof SocketHttpServerConnection) {
    InetAddress remoteAddr=((SocketHttpServerConnection)connObj).getRemoteAddress();
    sb.append(remoteAddr.toString() + " -- ");
  }
  sb.append(StringUtils.cleanString(request.getRequestLine().toString()));
  try {
    List<NameValuePair> paramList=null;
    try {
      paramList=URLEncodedUtils.parse(new URI(request.getRequestLine().getUri()),"UTF-8");
    }
 catch (    URISyntaxException e) {
      s_logger.error("Error parsing url request",e);
    }
    Map parameterMap=new HashMap<String,String[]>();
    String responseType=BaseCmd.RESPONSE_TYPE_XML;
    for (    NameValuePair param : paramList) {
      if (param.getName().equalsIgnoreCase("response")) {
        responseType=param.getValue();
        continue;
      }
      parameterMap.put(param.getName(),new String[]{param.getValue()});
    }
    if (!(responseType.equals(BaseCmd.RESPONSE_TYPE_JSON) || responseType.equals(BaseCmd.RESPONSE_TYPE_XML)))     responseType=BaseCmd.RESPONSE_TYPE_XML;
    try {
      UserContext.registerContext(_systemUser.getId(),_systemAccount,null,true);
      sb.insert(0,"(userId=" + User.UID_SYSTEM + " accountId="+ Account.ACCOUNT_ID_SYSTEM+ " sessionId="+ null+ ") ");
      String responseText=handleRequest(parameterMap,true,responseType,sb);
      sb.append(" 200 " + ((responseText == null) ? 0 : responseText.length()));
      writeResponse(response,responseText,HttpStatus.SC_OK,responseType,null);
    }
 catch (    ServerApiException se) {
      String responseText=getSerializedApiError(se,parameterMap,responseType);
      writeResponse(response,responseText,se.getErrorCode().getHttpCode(),responseType,se.getDescription());
      sb.append(" " + se.getErrorCode() + " "+ se.getDescription());
    }
catch (    RuntimeException e) {
      s_logger.error("Unhandled exception, ",e);
      throw e;
    }
  }
  finally {
    s_accessLogger.info(sb.toString());
    UserContext.unregisterContext();
  }
}
