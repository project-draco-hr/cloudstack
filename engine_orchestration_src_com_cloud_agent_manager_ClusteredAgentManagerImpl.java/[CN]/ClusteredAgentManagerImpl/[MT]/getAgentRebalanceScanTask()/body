{
  return new ManagedContextRunnable(){
    @Override protected void runInContext(){
      try {
        if (logger.isTraceEnabled()) {
          logger.trace("Agent rebalance task check, management server id:" + _nodeId);
        }
        if (!_agentLbHappened) {
          QueryBuilder<HostVO> sc=QueryBuilder.create(HostVO.class);
          sc.and(sc.entity().getManagementServerId(),Op.NNULL);
          sc.and(sc.entity().getType(),Op.EQ,Host.Type.Routing);
          List<HostVO> allManagedRoutingAgents=sc.list();
          sc=QueryBuilder.create(HostVO.class);
          sc.and(sc.entity().getType(),Op.EQ,Host.Type.Routing);
          List<HostVO> allAgents=sc.list();
          double allHostsCount=allAgents.size();
          double managedHostsCount=allManagedRoutingAgents.size();
          if (allHostsCount > 0.0) {
            double load=managedHostsCount / allHostsCount;
            if (load >= ConnectedAgentThreshold.value()) {
              logger.debug("Scheduling agent rebalancing task as the average agent load " + load + " is more than the threshold "+ ConnectedAgentThreshold.value());
              scheduleRebalanceAgents();
              _agentLbHappened=true;
            }
 else {
              logger.debug("Not scheduling agent rebalancing task as the averages load " + load + " is less than the threshold "+ ConnectedAgentThreshold.value());
            }
          }
        }
      }
 catch (      Throwable e) {
        logger.error("Problem with the clustered agent transfer scan check!",e);
      }
    }
  }
;
}
