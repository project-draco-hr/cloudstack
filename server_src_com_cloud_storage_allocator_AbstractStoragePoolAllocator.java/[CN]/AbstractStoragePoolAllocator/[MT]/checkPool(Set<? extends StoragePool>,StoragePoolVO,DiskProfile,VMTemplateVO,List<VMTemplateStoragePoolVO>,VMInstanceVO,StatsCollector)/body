{
  if (avoid.contains(pool)) {
    return false;
  }
  if (dskCh.getType().equals(VolumeType.ROOT) && pool.getPoolType().equals(StoragePoolType.Iscsi)) {
    return false;
  }
  if (!poolIsCorrectType(dskCh,pool,vm)) {
    return false;
  }
  Long clusterId=pool.getClusterId();
  ClusterVO cluster=_clusterDao.findById(clusterId);
  if (!(cluster.getHypervisorType() == template.getHypervisorType())) {
    return false;
  }
  if (sc != null) {
    long totalSize=pool.getCapacityBytes();
    StorageStats stats=sc.getStorageStats(pool.getId());
    if (stats != null) {
      double usedPercentage=((double)stats.getByteUsed() / (double)totalSize);
      if (s_logger.isDebugEnabled()) {
        s_logger.debug("Attempting to look for pool " + pool.getId() + " for storage, totalSize: "+ pool.getCapacityBytes()+ ", usedBytes: "+ stats.getByteUsed()+ ", usedPct: "+ usedPercentage+ ", threshold: "+ _storageUsedThreshold);
      }
      if (usedPercentage >= _storageUsedThreshold) {
        return false;
      }
    }
  }
  Pair<Long,Long> sizes=_volumeDao.getCountAndTotalByPool(pool.getId());
  long totalAllocatedSize=sizes.second() + sizes.first() * _extraBytesPerVolume;
  boolean tmpinstalled=false;
  List<VMTemplateStoragePoolVO> templatePoolVOs;
  if (templatesInPool != null) {
    templatePoolVOs=templatesInPool;
  }
 else {
    templatePoolVOs=_templatePoolDao.listByPoolId(pool.getId());
  }
  for (  VMTemplateStoragePoolVO templatePoolVO : templatePoolVOs) {
    VMTemplateVO templateInPool=_templateDao.findById(templatePoolVO.getTemplateId());
    int templateSizeMultiplier=pool.getPoolType() == StoragePoolType.NetworkFilesystem ? 1 : 2;
    if ((template != null) && !tmpinstalled && (templateInPool.getId() == template.getId())) {
      tmpinstalled=true;
    }
    s_logger.debug("For template: " + templateInPool.getName() + ", using template size multiplier: "+ templateSizeMultiplier);
    long templateSize=templatePoolVO.getTemplateSize();
    totalAllocatedSize+=templateSizeMultiplier * (templateSize + _extraBytesPerVolume);
  }
  if ((template != null) && !tmpinstalled) {
    HostVO secondaryStorageHost=_storageMgr.getSecondaryStorageHost(pool.getDataCenterId());
    if (secondaryStorageHost == null) {
      return false;
    }
 else {
      VMTemplateHostVO templateHostVO=_templateHostDao.findByHostTemplate(secondaryStorageHost.getId(),template.getId());
      if (templateHostVO == null) {
        return false;
      }
 else {
        s_logger.debug("For template: " + template.getName() + ", using template size multiplier: "+ 2);
        long templateSize=templateHostVO.getSize();
        totalAllocatedSize+=2 * (templateSize + _extraBytesPerVolume);
      }
    }
  }
  long askingSize=dskCh.getSize();
  int storageOverprovisioningFactor=1;
  if (pool.getPoolType() == StoragePoolType.NetworkFilesystem) {
    storageOverprovisioningFactor=_storageOverprovisioningFactor;
  }
  if (s_logger.isDebugEnabled()) {
    s_logger.debug("Attempting to look for pool " + pool.getId() + " for storage, maxSize : "+ (pool.getCapacityBytes() * storageOverprovisioningFactor)+ ", totalSize : "+ totalAllocatedSize+ ", askingSize : "+ askingSize);
  }
  if ((pool.getCapacityBytes() * storageOverprovisioningFactor) < (totalAllocatedSize + askingSize)) {
    if (s_logger.isDebugEnabled()) {
      s_logger.debug("Found pool " + pool.getId() + " for storage, maxSize : "+ (pool.getCapacityBytes() * storageOverprovisioningFactor)+ ", totalSize : "+ totalAllocatedSize+ ", askingSize : "+ askingSize);
    }
    return false;
  }
  return true;
}
