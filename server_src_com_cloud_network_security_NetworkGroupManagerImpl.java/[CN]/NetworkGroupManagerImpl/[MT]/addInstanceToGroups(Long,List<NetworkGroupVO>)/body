{
  if (!_enabled) {
    return true;
  }
  if (groups != null) {
    final Set<NetworkGroupVO> uniqueGroups=new TreeSet<NetworkGroupVO>(new NetworkGroupVOComparator());
    uniqueGroups.addAll(groups);
    final Transaction txn=Transaction.currentTxn();
    txn.start();
    UserVm userVm=_userVMDao.acquire(userVmId);
    if (userVm == null) {
      s_logger.warn("Failed to acquire lock on user vm id=" + userVmId);
    }
    try {
      for (      NetworkGroupVO networkGroup : uniqueGroups) {
        NetworkGroupVO ngrpLock=_networkGroupDao.lock(networkGroup.getId(),false);
        if (ngrpLock == null) {
          s_logger.warn("Failed to acquire lock on network group id=" + networkGroup.getId() + " name="+ networkGroup.getName());
          txn.rollback();
          return false;
        }
        if (_networkGroupVMMapDao.findByVmIdGroupId(userVmId,networkGroup.getId()) == null) {
          NetworkGroupVMMapVO groupVmMapVO=new NetworkGroupVMMapVO(networkGroup.getId(),userVmId);
          _networkGroupVMMapDao.persist(groupVmMapVO);
        }
      }
      txn.commit();
      return true;
    }
  finally {
      if (userVm != null) {
        _userVMDao.release(userVmId);
      }
    }
  }
  return false;
}
