{
  properties.putAll(params);
  Map<String,String> args=new HashMap<String,String>();
  String name;
  AgentResourceBase agentResource;
  if (_hostDao.findSecondaryStorageHost(getZone()) == null) {
    agentResource=new AgentStorageResource(1,AgentType.Storage,this);
    if (agentResource != null) {
      try {
        agentResource.start();
        name="SimulatedAgent." + 1;
        args.put(name,name);
        agentResource.configure(name,PropertiesUtil.toMap(properties));
      }
 catch (      ConfigurationException e) {
        s_logger.error("error while configuring server resource" + e.getMessage());
      }
      _resources.put(agentResource,args);
    }
  }
synchronized (this) {
    for (int i=0; i < getWorkers(); i++) {
      int agentId=getNextAgentId();
      if (getAgentType(i) == AgentType.Routing) {
        agentResource=new AgentRoutingResource(agentId,AgentType.Routing,this);
      }
 else {
        agentResource=new AgentStorageResource(agentId,AgentType.Storage,this);
      }
      if (agentResource != null) {
        try {
          agentResource.start();
          agentResource.configure("SimulatedAgent." + agentId,PropertiesUtil.toMap(properties));
          name="SimulatedAgent" + agentId;
          args.put(name,name);
        }
 catch (        ConfigurationException e) {
          s_logger.error("error while configuring server resource" + e.getMessage());
        }
        _resources.put(agentResource,args);
      }
    }
  }
  return _resources;
}
