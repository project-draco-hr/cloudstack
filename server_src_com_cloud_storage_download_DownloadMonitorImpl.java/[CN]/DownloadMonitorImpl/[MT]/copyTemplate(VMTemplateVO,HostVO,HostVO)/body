{
  boolean downloadJobExists=false;
  VMTemplateHostVO destTmpltHost=null;
  VMTemplateHostVO srcTmpltHost=null;
  srcTmpltHost=_vmTemplateHostDao.findByHostTemplate(sourceServer.getId(),template.getId());
  if (srcTmpltHost == null) {
    throw new InvalidParameterValueException("Template " + template.getName() + " not associated with "+ sourceServer.getName());
  }
  if (!_secMgr.generateSetupCommand(sourceServer.getId())) {
    return false;
  }
  String url=generateCopyUrl(sourceServer,srcTmpltHost);
  if (url == null) {
    s_logger.warn("Unable to start/resume copy of template " + template.getUniqueName() + " to "+ destServer.getName()+ ", no secondary storage vm in running state in source zone");
    throw new StorageUnavailableException("No secondary VM in running state in zone " + sourceServer.getDataCenterId(),srcTmpltHost.getPoolId());
  }
  destTmpltHost=_vmTemplateHostDao.findByHostTemplate(destServer.getId(),template.getId());
  if (destTmpltHost == null) {
    destTmpltHost=new VMTemplateHostVO(destServer.getId(),template.getId(),new Date(),0,VMTemplateStorageResourceAssoc.Status.NOT_DOWNLOADED,null,null,"jobid0000",null,url);
    destTmpltHost.setCopy(true);
    destTmpltHost.setPhysicalSize(srcTmpltHost.getPhysicalSize());
    _vmTemplateHostDao.persist(destTmpltHost);
  }
 else   if ((destTmpltHost.getJobId() != null) && (destTmpltHost.getJobId().length() > 2)) {
    downloadJobExists=true;
  }
  Long maxTemplateSizeInBytes=getMaxTemplateSizeInBytes();
  if (destTmpltHost != null) {
    start();
    DownloadCommand dcmd=new DownloadCommand(destServer.getStorageUrl(),url,template,TemplateConstants.DEFAULT_HTTP_AUTH_USER,_copyAuthPasswd,maxTemplateSizeInBytes);
    if (downloadJobExists) {
      dcmd=new DownloadProgressCommand(dcmd,destTmpltHost.getJobId(),RequestType.GET_OR_RESTART);
    }
    HostVO ssAhost=_agentMgr.getSSAgent(destServer);
    if (ssAhost == null) {
      s_logger.warn("There is no secondary storage VM for secondary storage host " + destServer.getName());
      return false;
    }
    DownloadListener dl=new DownloadListener(ssAhost,template,_timer,_vmTemplateHostDao,destTmpltHost.getId(),this,dcmd);
    if (downloadJobExists) {
      dl.setCurrState(destTmpltHost.getDownloadState());
    }
    DownloadListener old=null;
synchronized (_listenerMap) {
      old=_listenerMap.put(destTmpltHost,dl);
    }
    if (old != null) {
      old.abandon();
    }
    long result=send(ssAhost.getId(),dcmd,dl);
    if (result == -1) {
      s_logger.warn("Unable to start /resume COPY of template " + template.getUniqueName() + " to "+ destServer.getName());
      dl.setDisconnected();
      dl.scheduleStatusCheck(RequestType.GET_OR_RESTART);
    }
 else {
      return true;
    }
  }
  return false;
}
