{
  boolean downloadJobExists=false;
  TemplateDataStoreVO vmTemplateStore=null;
  vmTemplateStore=_vmTemplateStoreDao.findByStoreTemplate(store.getId(),template.getId());
  if (vmTemplateStore == null) {
    vmTemplateStore=new TemplateDataStoreVO(store.getId(),template.getId(),new Date(),0,VMTemplateStorageResourceAssoc.Status.NOT_DOWNLOADED,null,null,"jobid0000",null,template.getUrl());
    _vmTemplateStoreDao.persist(vmTemplateStore);
  }
 else   if ((vmTemplateStore.getJobId() != null) && (vmTemplateStore.getJobId().length() > 2)) {
    downloadJobExists=true;
  }
  Long maxTemplateSizeInBytes=getMaxTemplateSizeInBytes();
  String secUrl=store.getUri();
  if (vmTemplateStore != null) {
    start();
    DownloadSystemTemplateCommand dcmd=new DownloadSystemTemplateCommand(store.getTO(),secUrl,template,maxTemplateSizeInBytes);
    dcmd.setProxy(getHttpProxy());
    if (vmTemplateStore.isCopy()) {
      dcmd.setCreds(TemplateConstants.DEFAULT_HTTP_AUTH_USER,_copyAuthPasswd);
    }
    EndPoint endPoint=_epSelector.select(this.tmplFactory.getTemplate(template.getId(),store));
    if (endPoint == null) {
      s_logger.warn("There is no endpoint to send download template command");
      return;
    }
    endPoint.sendMessage(dcmd);
  }
}
