{
  if ((dnldStatus == VMTemplateStorageResourceAssoc.Status.DOWNLOADED) || (dnldStatus == Status.ABANDONED)) {
    VMTemplateHostVO vmTemplateHost=new VMTemplateHostVO(host.getId(),template.getId());
    DownloadListener oldListener=null;
synchronized (_listenerMap) {
      oldListener=_listenerMap.remove(vmTemplateHost);
    }
    if (oldListener != null) {
      oldListener.abandon();
    }
  }
  VMTemplateHostVO vmTemplateHost=_vmTemplateHostDao.findByHostTemplate(host.getId(),template.getId());
  if (dnldStatus == Status.DOWNLOADED) {
    long size=-1;
    if (vmTemplateHost != null) {
      size=vmTemplateHost.getSize();
    }
 else {
      s_logger.warn("Failed to get size for template" + template.getName());
    }
    String eventType=EventTypes.EVENT_TEMPLATE_CREATE;
    if ((template.getFormat()).equals(ImageFormat.ISO)) {
      eventType=EventTypes.EVENT_ISO_CREATE;
    }
    if (template.getAccountId() != Account.ACCOUNT_ID_SYSTEM) {
      UsageEventVO usageEvent=new UsageEventVO(eventType,template.getAccountId(),host.getDataCenterId(),template.getId(),template.getName(),null,template.getSourceTemplateId(),size);
      _usageEventDao.persist(usageEvent);
    }
  }
  if (vmTemplateHost != null) {
    Long poolId=vmTemplateHost.getPoolId();
    if (poolId != null) {
      VMTemplateStoragePoolVO vmTemplatePool=_vmTemplatePoolDao.findByPoolTemplate(poolId,template.getId());
      StoragePoolHostVO poolHost=_poolHostDao.findByPoolHost(poolId,host.getId());
      if (vmTemplatePool != null && poolHost != null) {
        vmTemplatePool.setDownloadPercent(vmTemplateHost.getDownloadPercent());
        vmTemplatePool.setDownloadState(vmTemplateHost.getDownloadState());
        vmTemplatePool.setErrorString(vmTemplateHost.getErrorString());
        String localPath=poolHost.getLocalPath();
        String installPath=vmTemplateHost.getInstallPath();
        if (installPath != null) {
          if (!installPath.startsWith("/")) {
            installPath="/" + installPath;
          }
          if (!(localPath == null) && !installPath.startsWith(localPath)) {
            localPath=localPath.replaceAll("/\\p{Alnum}+/*$","");
          }
          if (!(localPath == null) && installPath.startsWith(localPath)) {
            installPath=installPath.substring(localPath.length());
          }
        }
        vmTemplatePool.setInstallPath(installPath);
        vmTemplatePool.setLastUpdated(vmTemplateHost.getLastUpdated());
        vmTemplatePool.setJobId(vmTemplateHost.getJobId());
        vmTemplatePool.setLocalDownloadPath(vmTemplateHost.getLocalDownloadPath());
        _vmTemplatePoolDao.update(vmTemplatePool.getId(),vmTemplatePool);
      }
    }
  }
}
