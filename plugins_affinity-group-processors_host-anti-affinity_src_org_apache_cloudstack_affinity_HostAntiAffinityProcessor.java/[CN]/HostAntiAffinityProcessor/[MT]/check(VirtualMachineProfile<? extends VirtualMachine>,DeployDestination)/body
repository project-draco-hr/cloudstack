{
  if (plannedDestination.getHost() == null) {
    return true;
  }
  long plannedHostId=plannedDestination.getHost().getId();
  VirtualMachine vm=vmProfile.getVirtualMachine();
  List<AffinityGroupVMMapVO> vmGroupMappings=_affinityGroupVMMapDao.findByVmIdType(vm.getId(),getType());
  for (  AffinityGroupVMMapVO vmGroupMapping : vmGroupMappings) {
    final Transaction txn=Transaction.currentTxn();
    try {
      txn.start();
      AffinityGroupVO group=_affinityGroupDao.lockRow(vmGroupMapping.getAffinityGroupId(),true);
      List<Long> groupVMIds=_affinityGroupVMMapDao.listVmIdsByAffinityGroup(vmGroupMapping.getAffinityGroupId());
      groupVMIds.remove(vm.getId());
      for (      Long groupVMId : groupVMIds) {
        VMReservationVO vmReservation=_reservationDao.findByVmId(groupVMId);
        if (vmReservation.getHostId() != null && vmReservation.getHostId().equals(plannedHostId)) {
          return false;
        }
      }
      return true;
    }
  finally {
      txn.commit();
    }
  }
  return true;
}
