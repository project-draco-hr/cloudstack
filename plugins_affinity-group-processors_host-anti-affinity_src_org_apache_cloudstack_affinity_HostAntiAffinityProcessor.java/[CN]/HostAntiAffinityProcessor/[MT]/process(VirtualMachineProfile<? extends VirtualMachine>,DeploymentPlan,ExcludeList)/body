{
  VirtualMachine vm=vmProfile.getVirtualMachine();
  AffinityGroupVMMapVO vmGroupMapping=_affinityGroupVMMapDao.findByVmIdType(vm.getId(),getType());
  if (vmGroupMapping != null) {
    AffinityGroupVO group=_affinityGroupDao.findById(vmGroupMapping.getAffinityGroupId());
    if (s_logger.isDebugEnabled()) {
      s_logger.debug("Processing affinity group " + group.getName() + " for VM Id: "+ vm.getId());
    }
    List<Long> groupVMIds=_affinityGroupVMMapDao.listVmIdsByAffinityGroup(group.getId());
    for (    Long groupVMId : groupVMIds) {
      VMInstanceVO groupVM=_vmInstanceDao.findById(groupVMId);
      if (groupVM != null && !groupVM.isRemoved() && groupVM.getHostId() != null) {
        avoid.addHost(groupVM.getHostId());
      }
    }
  }
}
