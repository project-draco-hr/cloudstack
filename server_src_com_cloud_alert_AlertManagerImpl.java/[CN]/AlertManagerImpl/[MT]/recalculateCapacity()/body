{
  if (s_logger.isTraceEnabled()) {
    s_logger.trace("recalculating system capacity");
  }
  List<CapacityVO> newCapacities=new ArrayList<CapacityVO>();
  SearchCriteria<HostVO> sc=_hostDao.createSearchCriteria();
  sc.addAnd("status",SearchCriteria.Op.EQ,Status.Up.toString());
  List<HostVO> hosts=_hostDao.search(sc,null);
  List<ServiceOfferingVO> offerings=_offeringsDao.listAllIncludingRemoved();
  Map<Long,ServiceOfferingVO> offeringsMap=new HashMap<Long,ServiceOfferingVO>();
  for (  ServiceOfferingVO offering : offerings) {
    offeringsMap.put(offering.getId(),offering);
  }
  List<StoragePoolVO> storagePools=_storagePoolDao.listAll();
  for (  StoragePoolVO pool : storagePools) {
    long disk=0l;
    Pair<Long,Long> sizes=_volumeDao.getCountAndTotalByPool(pool.getId());
    disk=sizes.second();
    _storageMgr.createCapacityEntry(pool,disk);
  }
  Transaction txn=Transaction.currentTxn();
  try {
    txn.start();
    List<DataCenterVO> datacenters=_dcDao.listAllIncludingRemoved();
    for (    DataCenterVO datacenter : datacenters) {
      long dcId=datacenter.getId();
      s_logger.trace("Executing capacity update");
      createOrUpdateIpCapacity(dcId,null,CapacityVO.CAPACITY_TYPE_PUBLIC_IP);
      s_logger.trace("Done with capacity update");
    }
    txn.commit();
    txn.start();
    List<HostPodVO> pods=_podDao.listAllIncludingRemoved();
    for (    HostPodVO pod : pods) {
      long podId=pod.getId();
      long dcId=pod.getDataCenterId();
      s_logger.trace("Executing capacity update");
      createOrUpdateIpCapacity(dcId,podId,CapacityVO.CAPACITY_TYPE_PRIVATE_IP);
      s_logger.trace("Done with capacity update");
    }
    txn.commit();
  }
 catch (  Exception ex) {
    txn.rollback();
    s_logger.error("Unable to start transaction for capacity update");
  }
 finally {
    txn.close();
  }
}
