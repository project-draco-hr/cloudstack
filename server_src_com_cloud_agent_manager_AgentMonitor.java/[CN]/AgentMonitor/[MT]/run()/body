{
  s_logger.info("Agent Monitor is started.");
  while (!_stop) {
    try {
      Thread.sleep(60 * 1000);
    }
 catch (    InterruptedException e) {
      s_logger.info("Who woke me from my slumber?");
    }
    try {
      List<Long> behindAgents=findAgentsBehindOnPing();
      for (      Long agentId : behindAgents) {
        _agentMgr.disconnect(agentId,Event.PingTimeout,true);
      }
      List<HostVO> hosts=_hostDao.listByStatus(Status.PrepareForMaintenance,Status.ErrorInMaintenance);
      for (      HostVO host : hosts) {
        long hostId=host.getId();
        DataCenterVO dcVO=_dcDao.findById(host.getDataCenterId());
        HostPodVO podVO=_podDao.findById(host.getPodId());
        String hostDesc="name: " + host.getName() + " (id:"+ hostId+ "), availability zone: "+ dcVO.getName()+ ", pod: "+ podVO.getName();
        if (host.getType() != Host.Type.Storage) {
          List<VMInstanceVO> vos=_vmDao.listByHostId(hostId);
          if (vos.size() == 0) {
            _alertMgr.sendAlert(AlertManager.ALERT_TYPE_HOST,host.getDataCenterId(),host.getPodId(),"Migration Complete for host " + hostDesc,"Host [" + hostDesc + "] is ready for maintenance");
            _hostDao.updateStatus(host,Event.PreparationComplete,_msId);
          }
        }
      }
    }
 catch (    Throwable th) {
      s_logger.error("Caught the following exception: ",th);
    }
  }
  s_logger.info("Agent Monitor is leaving the building!");
}
