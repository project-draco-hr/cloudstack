{
  final UserVmVO vm=_userVmDao.findById(profile.getId());
  _userVmDao.loadDetails(vm);
  final DomainRouterVO router=routers.get(0);
  if (router.getState() != State.Running) {
    s_logger.warn("Failed to configure dhcp: router not in running state");
    throw new ResourceUnavailableException("Unable to assign ip addresses, domR is not in right state " + router.getState(),DataCenter.class,network.getDataCenterId());
  }
  final NicVO domr_guest_nic=_nicDao.findByInstanceIdAndIpAddressAndVmtype(router.getId(),_nicDao.getIpAddress(nic.getNetworkId(),router.getId()),VirtualMachine.Type.DomainRouter);
  if (!NetUtils.sameSubnet(domr_guest_nic.getIp4Address(),nic.getIp4Address(),nic.getNetmask())) {
    final List<NicIpAliasVO> aliasIps=_nicIpAliasDao.listByNetworkIdAndState(domr_guest_nic.getNetworkId(),NicIpAlias.state.active);
    boolean ipInVmsubnet=false;
    for (    final NicIpAliasVO alias : aliasIps) {
      if (NetUtils.sameSubnet(alias.getIp4Address(),nic.getIp4Address(),nic.getNetmask())) {
        ipInVmsubnet=true;
        break;
      }
    }
    PublicIp routerPublicIP=null;
    String routerAliasIp=null;
    final DataCenter dc=_dcDao.findById(router.getDataCenterId());
    if (ipInVmsubnet == false) {
      try {
        if (network.getTrafficType() == TrafficType.Guest && network.getGuestType() == GuestType.Shared) {
          _podDao.findById(vm.getPodIdToDeployIn());
          final Account caller=CallContext.current().getCallingAccount();
          final List<VlanVO> vlanList=_vlanDao.listVlansByNetworkIdAndGateway(network.getId(),nic.getGateway());
          final List<Long> vlanDbIdList=new ArrayList<Long>();
          for (          final VlanVO vlan : vlanList) {
            vlanDbIdList.add(vlan.getId());
          }
          if (dc.getNetworkType() == NetworkType.Basic) {
            routerPublicIP=_ipAddrMgr.assignPublicIpAddressFromVlans(router.getDataCenterId(),vm.getPodIdToDeployIn(),caller,Vlan.VlanType.DirectAttached,vlanDbIdList,nic.getNetworkId(),null,false);
          }
 else {
            routerPublicIP=_ipAddrMgr.assignPublicIpAddressFromVlans(router.getDataCenterId(),null,caller,Vlan.VlanType.DirectAttached,vlanDbIdList,nic.getNetworkId(),null,false);
          }
          routerAliasIp=routerPublicIP.getAddress().addr();
        }
      }
 catch (      final InsufficientAddressCapacityException e) {
        s_logger.info(e.getMessage());
        s_logger.info("unable to configure dhcp for this VM.");
        return false;
      }
      final NicIpAliasVO alias=new NicIpAliasVO(domr_guest_nic.getId(),routerAliasIp,router.getId(),CallContext.current().getCallingAccountId(),network.getDomainId(),nic.getNetworkId(),nic.getGateway(),nic.getNetmask());
      alias.setAliasCount((routerPublicIP.getIpMacAddress()));
      _nicIpAliasDao.persist(alias);
      final List<IpAliasTO> ipaliasTo=new ArrayList<IpAliasTO>();
      ipaliasTo.add(new IpAliasTO(routerAliasIp,alias.getNetmask(),alias.getAliasCount().toString()));
      final Commands cmds=new Commands(Command.OnError.Stop);
      createIpAlias(router,ipaliasTo,alias.getNetworkId(),cmds);
      configDnsMasq(router,network,cmds);
      final boolean result=sendCommandsToRouter(router,cmds);
      if (result == false) {
        final NicIpAliasVO ipAliasVO=_nicIpAliasDao.findByInstanceIdAndNetworkId(network.getId(),router.getId());
        final PublicIp routerPublicIPFinal=routerPublicIP;
        Transaction.execute(new TransactionCallbackNoReturn(){
          @Override public void doInTransactionWithoutResult(          final TransactionStatus status){
            _nicIpAliasDao.expunge(ipAliasVO.getId());
            _ipAddressDao.unassignIpAddress(routerPublicIPFinal.getId());
          }
        }
);
        throw new CloudRuntimeException("failed to configure ip alias on the router as a part of dhcp config");
      }
    }
    return true;
  }
  return true;
}
