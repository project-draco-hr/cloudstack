{
  long guestNetworkId=nic.getNetworkId();
  NetworkVO guestNetwork=_networkDao.findById(guestNetworkId);
  DomainRouterVO router=profile.getVirtualMachine();
  String type=null;
  String dhcpRange=null;
  String rpFilter=" ";
  DataCenterVO dc=_dcDao.findById(guestNetwork.getDataCenterId());
  if (dc.getNetworkType() == NetworkType.Advanced) {
    String cidr=guestNetwork.getCidr();
    if (cidr != null) {
      dhcpRange=NetUtils.getDhcpRange(cidr);
    }
  }
  String rpValue=_configDao.getValue(Config.NetworkRouterRpFilter.key());
  if (rpValue != null && rpValue.equalsIgnoreCase("true")) {
    _disable_rp_filter=true;
  }
 else {
    _disable_rp_filter=false;
  }
  boolean publicNetwork=false;
  if (_networkMgr.isProviderSupportServiceInNetwork(guestNetwork.getId(),Service.SourceNat,Provider.VirtualRouter)) {
    publicNetwork=true;
  }
  if (!publicNetwork) {
    type="dhcpsrvr";
  }
 else {
    type="router";
    if (_disable_rp_filter) {
      rpFilter=" disable_rp_filter=true";
    }
  }
  StringBuilder buf=profile.getBootArgsBuilder();
  buf.append(" type=" + type + rpFilter);
  boolean isRedundant=router.getIsRedundantRouter();
  if (isRedundant) {
    buf.append(" redundant_router=1");
    List<DomainRouterVO> routers=_routerDao.listByNetworkAndRole(guestNetwork.getId(),Role.VIRTUAL_ROUTER);
    try {
      int priority=getUpdatedPriority(guestNetwork,routers,router);
      router.setPriority(priority);
    }
 catch (    InsufficientVirtualNetworkCapcityException e) {
      s_logger.error("Failed to get update priority!",e);
      throw new CloudRuntimeException("Failed to get update priority!");
    }
  }
  if (nic.isDefaultNic() && dc.getNetworkType() == NetworkType.Basic) {
    long cidrSize=NetUtils.getCidrSize(nic.getNetmask());
    String cidr=NetUtils.getCidrSubNet(nic.getGateway(),cidrSize);
    if (cidr != null) {
      dhcpRange=NetUtils.getIpRangeStartIpFromCidr(cidr,cidrSize);
    }
  }
  if (dhcpRange != null) {
    buf.append(" dhcprange=" + dhcpRange);
  }
  if (isRedundant) {
    Network net=_networkMgr.getNetwork(nic.getNetworkId());
    buf.append(" guestgw=").append(net.getGateway());
    String brd=NetUtils.long2Ip(NetUtils.ip2Long(nic.getIp4Address()) | ~NetUtils.ip2Long(nic.getNetmask()));
    buf.append(" guestbrd=").append(brd);
    buf.append(" guestcidrsize=").append(NetUtils.getCidrSize(nic.getNetmask()));
    buf.append(" router_pr=").append(router.getPriority());
  }
  String domain=guestNetwork.getNetworkDomain();
  if (domain != null) {
    buf.append(" domain=" + domain);
  }
  boolean dnsProvided=false;
  boolean dhcpProvided=false;
  if (nic.getTrafficType() == TrafficType.Guest) {
    dnsProvided=_networkMgr.isProviderSupportServiceInNetwork(nic.getNetworkId(),Service.Dns,Provider.VirtualRouter);
    dhcpProvided=_networkMgr.isProviderSupportServiceInNetwork(nic.getNetworkId(),Service.Dhcp,Provider.VirtualRouter);
  }
  if (dnsProvided || dhcpProvided) {
    buf.append(" dns1=").append(defaultDns1);
    if (defaultDns2 != null) {
      buf.append(" dns2=").append(defaultDns2);
    }
    boolean useExtDns=!dnsProvided;
    String use_external_dns=_configDao.getValue(Config.UseExternalDnsServers.key());
    if (use_external_dns != null && use_external_dns.equals("true")) {
      useExtDns=true;
    }
    if (useExtDns) {
      buf.append(" useextdns=true");
    }
  }
}
