{
  long ownerId=router.getAccountId();
  final List<IPAddressVO> userIps=_networkModel.listPublicIpsAssignedToGuestNtwk(ownerId,guestNetworkId,null);
  List<PublicIp> allPublicIps=new ArrayList<PublicIp>();
  if (userIps != null && !userIps.isEmpty()) {
    boolean addIp=true;
    for (    IPAddressVO userIp : userIps) {
      if (skipInStates != null) {
        for (        IpAddress.State stateToSkip : skipInStates) {
          if (userIp.getState() == stateToSkip) {
            s_logger.debug("Skipping ip address " + userIp + " in state "+ userIp.getState());
            addIp=false;
            break;
          }
        }
      }
      if (addIp) {
        PublicIp publicIp=new PublicIp(userIp,_vlanDao.findById(userIp.getVlanId()),NetUtils.createSequenceBasedMacAddress(userIp.getMacAddress()));
        allPublicIps.add(publicIp);
      }
    }
  }
  Network network=_networkDao.findById(guestNetworkId);
  Map<PublicIp,Set<Service>> ipToServices=_networkModel.getIpToServices(allPublicIps,false,true);
  Map<Provider,ArrayList<PublicIp>> providerToIpList=_networkModel.getProviderToIpList(network,ipToServices);
  ArrayList<PublicIp> publicIps=providerToIpList.get(provider);
  return publicIps;
}
