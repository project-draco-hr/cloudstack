{
  DomainRouterVO router=startDhcp ? deployDhcp(network,dest,profile.getOwner(),profile.getParameters()) : deployVirtualRouter(network,dest,profile.getOwner(),profile.getParameters());
  _userVmDao.loadDetails((UserVmVO)profile.getVirtualMachine());
  String password=(String)profile.getParameter(VirtualMachineProfile.Param.VmPassword);
  String userData=profile.getVirtualMachine().getUserData();
  String sshPublicKey=profile.getVirtualMachine().getDetail("SSH.PublicKey");
  Commands cmds=new Commands(OnError.Stop);
  String routerControlIpAddress=null;
  List<NicVO> nics=_nicDao.listByVmId(router.getId());
  for (  NicVO n : nics) {
    NetworkVO nc=_networkDao.findById(n.getNetworkId());
    if (nc.getTrafficType() == TrafficType.Control) {
      routerControlIpAddress=n.getIp4Address();
    }
  }
  DhcpEntryCommand dhcpCommand=new DhcpEntryCommand(nic.getMacAddress(),nic.getIp4Address(),profile.getVirtualMachine().getHostName());
  dhcpCommand.setAccessDetail(NetworkElementCommand.ROUTER_IP,routerControlIpAddress);
  dhcpCommand.setAccessDetail(NetworkElementCommand.ROUTER_NAME,router.getInstanceName());
  cmds.addCommand("dhcp",dhcpCommand);
  if (password != null && network.isDefault()) {
    final String encodedPassword=PasswordGenerator.rot13(password);
    SavePasswordCommand cmd=new SavePasswordCommand(encodedPassword,nic.getIp4Address(),profile.getVirtualMachine().getHostName());
    cmd.setAccessDetail(NetworkElementCommand.ROUTER_IP,router.getPrivateIpAddress());
    cmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME,router.getInstanceName());
    cmds.addCommand("password",cmd);
  }
  String serviceOffering=_serviceOfferingDao.findByIdIncludingRemoved(profile.getServiceOfferingId()).getDisplayText();
  String zoneName=_dcDao.findById(network.getDataCenterId()).getName();
  cmds.addCommand("vmdata",generateVmDataCommand(router,nic.getIp4Address(),userData,serviceOffering,zoneName,nic.getIp4Address(),profile.getVirtualMachine().getHostName(),profile.getVirtualMachine().getInstanceName(),profile.getId(),sshPublicKey));
  try {
    _agentMgr.send(router.getHostId(),cmds);
  }
 catch (  OperationTimedoutException e) {
    throw new AgentUnavailableException("Unable to reach the agent ",router.getHostId(),e);
  }
  Answer answer=cmds.getAnswer("dhcp");
  if (!answer.getResult()) {
    s_logger.error("Unable to set dhcp entry for " + profile + " on domR: "+ router.getHostName()+ " due to "+ answer.getDetails());
    throw new ResourceUnavailableException("Unable to set dhcp entry for " + profile + " due to "+ answer.getDetails(),DataCenter.class,router.getDataCenterIdToDeployIn());
  }
  answer=cmds.getAnswer("password");
  if (answer != null && !answer.getResult()) {
    s_logger.error("Unable to set password for " + profile + " due to "+ answer.getDetails());
    throw new ResourceUnavailableException("Unable to set password due to " + answer.getDetails(),DataCenter.class,router.getDataCenterIdToDeployIn());
  }
  answer=cmds.getAnswer("vmdata");
  if (answer != null && !answer.getResult()) {
    s_logger.error("Unable to set VM data for " + profile + " due to "+ answer.getDetails());
    throw new ResourceUnavailableException("Unable to set VM data due to " + answer.getDetails(),DataCenter.class,router.getDataCenterIdToDeployIn());
  }
  return router;
}
