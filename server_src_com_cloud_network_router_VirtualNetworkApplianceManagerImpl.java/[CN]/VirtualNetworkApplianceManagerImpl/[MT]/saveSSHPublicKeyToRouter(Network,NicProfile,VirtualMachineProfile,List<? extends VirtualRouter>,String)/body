{
  final UserVmVO vm=_userVmDao.findById(profile.getVirtualMachine().getId());
  _userVmDao.loadDetails(vm);
  final VirtualMachineProfile updatedProfile=profile;
  return applyRules(network,routers,"save SSHkey entry",false,null,false,new RuleApplier(){
    @Override public boolean execute(    final Network network,    final VirtualRouter router) throws ResourceUnavailableException {
      final Commands cmds=new Commands(Command.OnError.Stop);
      final NicVO nicVo=_nicDao.findById(nic.getId());
      final VMTemplateVO template=_templateDao.findByIdIncludingRemoved(updatedProfile.getTemplateId());
      if (template != null && template.getEnablePassword()) {
        createPasswordCommand(router,updatedProfile,nicVo,cmds);
      }
      createVmDataCommand(router,vm,nicVo,sshPublicKey,cmds);
      return sendCommandsToRouter(router,cmds);
    }
  }
);
}
