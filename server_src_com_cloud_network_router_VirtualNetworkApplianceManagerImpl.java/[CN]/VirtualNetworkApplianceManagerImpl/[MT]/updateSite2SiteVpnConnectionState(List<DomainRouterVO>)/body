{
  for (  DomainRouterVO router : routers) {
    List<Site2SiteVpnConnectionVO> conns=_s2sVpnMgr.getConnectionsForRouter(router);
    if (conns == null || conns.isEmpty()) {
      continue;
    }
    if (router.getState() != State.Running) {
      for (      Site2SiteVpnConnectionVO conn : conns) {
        conn.setState(Site2SiteVpnConnection.State.Disconnected);
        _s2sVpnConnectionDao.persist(conn);
      }
      continue;
    }
    List<String> ipList=new ArrayList<String>();
    for (    Site2SiteVpnConnectionVO conn : conns) {
      if (conn.getState() != Site2SiteVpnConnection.State.Connected && conn.getState() != Site2SiteVpnConnection.State.Disconnected) {
        continue;
      }
      Site2SiteCustomerGateway gw=_s2sCustomerGatewayDao.findById(conn.getCustomerGatewayId());
      ipList.add(gw.getGatewayIp());
    }
    String privateIP=router.getPrivateIpAddress();
    HostVO host=_hostDao.findById(router.getHostId());
    if (host == null || host.getStatus() != Status.Up) {
      continue;
    }
 else     if (host.getManagementServerId() != ManagementServerNode.getManagementServerId()) {
      continue;
    }
 else     if (privateIP != null) {
      final CheckS2SVpnConnectionsCommand command=new CheckS2SVpnConnectionsCommand(ipList);
      command.setAccessDetail(NetworkElementCommand.ROUTER_IP,getRouterControlIp(router.getId()));
      command.setAccessDetail(NetworkElementCommand.ROUTER_NAME,router.getInstanceName());
      command.setWait(30);
      final Answer origAnswer=_agentMgr.easySend(router.getHostId(),command);
      CheckS2SVpnConnectionsAnswer answer=null;
      if (origAnswer instanceof CheckS2SVpnConnectionsAnswer) {
        answer=(CheckS2SVpnConnectionsAnswer)origAnswer;
      }
 else {
        s_logger.warn("Unable to update router " + router.getHostName() + "'s VPN connection status");
        continue;
      }
      if (!answer.getResult()) {
        s_logger.warn("Unable to update router " + router.getHostName() + "'s VPN connection status");
        continue;
      }
      for (      Site2SiteVpnConnectionVO conn : conns) {
        if (conn.getState() != Site2SiteVpnConnection.State.Connected && conn.getState() != Site2SiteVpnConnection.State.Disconnected) {
          continue;
        }
        Site2SiteVpnConnection.State oldState=conn.getState();
        Site2SiteCustomerGateway gw=_s2sCustomerGatewayDao.findById(conn.getCustomerGatewayId());
        if (answer.isConnected(gw.getGatewayIp())) {
          conn.setState(Site2SiteVpnConnection.State.Connected);
        }
 else {
          conn.setState(Site2SiteVpnConnection.State.Disconnected);
        }
        _s2sVpnConnectionDao.persist(conn);
        if (oldState != conn.getState()) {
          String title="Site-to-site Vpn Connection to " + gw.getName() + " just switch from "+ oldState+ " to "+ conn.getState();
          String context="Site-to-site Vpn Connection to " + gw.getName() + " on router "+ router.getHostName()+ "(id: "+ router.getId()+ ") "+ " just switch from "+ oldState+ " to "+ conn.getState();
          s_logger.info(context);
          _alertMgr.sendAlert(AlertManager.ALERT_TYPE_DOMAIN_ROUTER,router.getDataCenterIdToDeployIn(),router.getPodIdToDeployIn(),title,context);
        }
      }
    }
  }
}
