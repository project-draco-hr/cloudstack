{
  if (s_logger.isTraceEnabled()) {
    s_logger.trace("applyDhcpEntry(" + network.getCidr() + ", "+ nic.getMacAddress()+ ", "+ profile.getUuid()+ ", "+ dest.getHost()+ ", "+ routers+ ")");
  }
  final UserVmVO vm=_userVmDao.findById(profile.getId());
  _userVmDao.loadDetails(vm);
  final VirtualMachineProfile updatedProfile=profile;
  final boolean isZoneBasic=dest.getDataCenter().getNetworkType() == NetworkType.Basic;
  final Long podId=isZoneBasic ? dest.getPod().getId() : null;
  boolean podLevelException=false;
  if (isZoneBasic && podId != null && updatedProfile.getVirtualMachine().getType() == VirtualMachine.Type.User && network.getTrafficType() == TrafficType.Guest && network.getGuestType() == Network.GuestType.Shared) {
    podLevelException=true;
  }
  return applyRules(network,routers,"dhcp entry",podLevelException,podId,true,new RuleApplier(){
    @Override public boolean execute(    final Network network,    final VirtualRouter router) throws ResourceUnavailableException {
      final Commands cmds=new Commands(Command.OnError.Stop);
      if (!(isZoneBasic && router.getPodIdToDeployIn().longValue() != podId.longValue() && _dnsBasicZoneUpdates.equalsIgnoreCase("pod"))) {
        final NicVO nicVo=_nicDao.findById(nic.getId());
        createDhcpEntryCommand(router,vm,nicVo,cmds);
        return sendCommandsToRouter(router,cmds);
      }
      return true;
    }
  }
);
}
