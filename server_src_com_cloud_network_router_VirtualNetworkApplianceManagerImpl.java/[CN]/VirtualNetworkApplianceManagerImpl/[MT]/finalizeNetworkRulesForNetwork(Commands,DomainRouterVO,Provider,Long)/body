{
  s_logger.debug("Resending ipAssoc, port forwarding, load balancing rules as a part of Virtual router start");
  ArrayList<? extends PublicIpAddress> publicIps=getPublicIpsToApply(router,provider,guestNetworkId);
  List<FirewallRule> firewallRulesEgress=new ArrayList<FirewallRule>();
  if (_networkModel.isProviderSupportServiceInNetwork(guestNetworkId,Service.Firewall,provider)) {
    firewallRulesEgress.addAll(_rulesDao.listByNetworkPurposeTrafficType(guestNetworkId,Purpose.Firewall,FirewallRule.TrafficType.Egress));
  }
  s_logger.debug("Found " + firewallRulesEgress.size() + " firewall Egress rule(s) to apply as a part of domR "+ router+ " start.");
  if (!firewallRulesEgress.isEmpty()) {
    createFirewallRulesCommands(firewallRulesEgress,router,cmds,guestNetworkId);
  }
  if (publicIps != null && !publicIps.isEmpty()) {
    List<RemoteAccessVpn> vpns=new ArrayList<RemoteAccessVpn>();
    List<PortForwardingRule> pfRules=new ArrayList<PortForwardingRule>();
    List<FirewallRule> staticNatFirewallRules=new ArrayList<FirewallRule>();
    List<StaticNat> staticNats=new ArrayList<StaticNat>();
    List<FirewallRule> firewallRulesIngress=new ArrayList<FirewallRule>();
    for (    PublicIpAddress ip : publicIps) {
      if (_networkModel.isProviderSupportServiceInNetwork(guestNetworkId,Service.PortForwarding,provider)) {
        pfRules.addAll(_pfRulesDao.listForApplication(ip.getId()));
      }
      if (_networkModel.isProviderSupportServiceInNetwork(guestNetworkId,Service.StaticNat,provider)) {
        staticNatFirewallRules.addAll(_rulesDao.listByIpAndPurpose(ip.getId(),Purpose.StaticNat));
      }
      if (_networkModel.isProviderSupportServiceInNetwork(guestNetworkId,Service.Firewall,provider)) {
        firewallRulesIngress.addAll(_rulesDao.listByIpAndPurpose(ip.getId(),Purpose.Firewall));
      }
      if (_networkModel.isProviderSupportServiceInNetwork(guestNetworkId,Service.Vpn,provider)) {
        RemoteAccessVpn vpn=_vpnDao.findByPublicIpAddress(ip.getId());
        if (vpn != null) {
          vpns.add(vpn);
        }
      }
      if (_networkModel.isProviderSupportServiceInNetwork(guestNetworkId,Service.StaticNat,provider)) {
        if (ip.isOneToOneNat()) {
          StaticNatImpl staticNat=new StaticNatImpl(ip.getAccountId(),ip.getDomainId(),guestNetworkId,ip.getId(),ip.getVmIp(),false);
          staticNats.add(staticNat);
        }
      }
    }
    s_logger.debug("Found " + staticNats.size() + " static nat(s) to apply as a part of domR "+ router+ " start.");
    if (!staticNats.isEmpty()) {
      createApplyStaticNatCommands(staticNats,router,cmds,guestNetworkId);
    }
    s_logger.debug("Found " + firewallRulesIngress.size() + " firewall Ingress rule(s) to apply as a part of domR "+ router+ " start.");
    if (!firewallRulesIngress.isEmpty()) {
      createFirewallRulesCommands(firewallRulesIngress,router,cmds,guestNetworkId);
    }
    s_logger.debug("Found " + pfRules.size() + " port forwarding rule(s) to apply as a part of domR "+ router+ " start.");
    if (!pfRules.isEmpty()) {
      createApplyPortForwardingRulesCommands(pfRules,router,cmds,guestNetworkId);
    }
    s_logger.debug("Found " + staticNatFirewallRules.size() + " static nat rule(s) to apply as a part of domR "+ router+ " start.");
    if (!staticNatFirewallRules.isEmpty()) {
      List<StaticNatRule> staticNatRules=new ArrayList<StaticNatRule>();
      for (      FirewallRule rule : staticNatFirewallRules) {
        staticNatRules.add(_rulesMgr.buildStaticNatRule(rule,false));
      }
      createApplyStaticNatRulesCommands(staticNatRules,router,cmds,guestNetworkId);
    }
    s_logger.debug("Found " + vpns.size() + " vpn(s) to apply as a part of domR "+ router+ " start.");
    if (!vpns.isEmpty()) {
      for (      RemoteAccessVpn vpn : vpns) {
        createApplyVpnCommands(vpn,router,cmds);
      }
    }
    List<LoadBalancerVO> lbs=_loadBalancerDao.listByNetworkIdAndScheme(guestNetworkId,Scheme.Public);
    List<LoadBalancingRule> lbRules=new ArrayList<LoadBalancingRule>();
    if (_networkModel.isProviderSupportServiceInNetwork(guestNetworkId,Service.Lb,provider)) {
      for (      LoadBalancerVO lb : lbs) {
        List<LbDestination> dstList=_lbMgr.getExistingDestinations(lb.getId());
        List<LbStickinessPolicy> policyList=_lbMgr.getStickinessPolicies(lb.getId());
        List<LbHealthCheckPolicy> hcPolicyList=_lbMgr.getHealthCheckPolicies(lb.getId());
        Ip sourceIp=_networkModel.getPublicIpAddress(lb.getSourceIpAddressId()).getAddress();
        LoadBalancingRule loadBalancing=new LoadBalancingRule(lb,dstList,policyList,hcPolicyList,sourceIp);
        lbRules.add(loadBalancing);
      }
    }
    s_logger.debug("Found " + lbRules.size() + " load balancing rule(s) to apply as a part of domR "+ router+ " start.");
    if (!lbRules.isEmpty()) {
      createApplyLoadBalancingRulesCommands(lbRules,router,cmds,guestNetworkId);
    }
  }
  if (_networkModel.isProviderSupportServiceInNetwork(guestNetworkId,Service.Dhcp,provider)) {
    List<NicIpAliasVO> revokedIpAliasVOs=_nicIpAliasDao.listByNetworkIdAndState(guestNetworkId,NicIpAlias.state.revoked);
    s_logger.debug("Found" + revokedIpAliasVOs.size() + "ip Aliases to apply on the router as a part of dhco configuration");
    List<IpAliasTO> revokedIpAliasTOs=new ArrayList<IpAliasTO>();
    for (    NicIpAliasVO revokedAliasVO : revokedIpAliasVOs) {
      revokedIpAliasTOs.add(new IpAliasTO(revokedAliasVO.getIp4Address(),revokedAliasVO.getNetmask(),revokedAliasVO.getAliasCount().toString()));
    }
    List<NicIpAliasVO> aliasVOs=_nicIpAliasDao.listByNetworkIdAndState(guestNetworkId,NicIpAlias.state.active);
    s_logger.debug("Found" + aliasVOs.size() + "ip Aliases to apply on the router as a part of dhco configuration");
    List<IpAliasTO> activeIpAliasTOs=new ArrayList<IpAliasTO>();
    for (    NicIpAliasVO aliasVO : aliasVOs) {
      activeIpAliasTOs.add(new IpAliasTO(aliasVO.getIp4Address(),aliasVO.getNetmask(),aliasVO.getAliasCount().toString()));
    }
    createDeleteIpAliasCommand(router,revokedIpAliasTOs,activeIpAliasTOs,guestNetworkId,cmds);
  }
}
