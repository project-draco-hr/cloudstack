{
  _executor=Executors.newScheduledThreadPool(1,new NamedThreadFactory("RouterMonitor"));
  _checkExecutor=Executors.newScheduledThreadPool(1,new NamedThreadFactory("RouterStatusMonitor"));
  _networkStatsUpdateExecutor=Executors.newScheduledThreadPool(1,new NamedThreadFactory("NetworkStatsUpdater"));
  VirtualMachine.State.getStateMachine().registerListener(this);
  final Map<String,String> configs=_configDao.getConfiguration("AgentManager",params);
  _routerRamSize=NumbersUtil.parseInt(configs.get("router.ram.size"),DEFAULT_ROUTER_VM_RAMSIZE);
  _routerCpuMHz=NumbersUtil.parseInt(configs.get("router.cpu.mhz"),DEFAULT_ROUTER_CPU_MHZ);
  _routerExtraPublicNics=NumbersUtil.parseInt(_configDao.getValue(Config.RouterExtraPublicNics.key()),2);
  final String guestOSString=configs.get("network.dhcp.nondefaultnetwork.setgateway.guestos");
  if (guestOSString != null) {
    final String[] guestOSList=guestOSString.split(",");
    for (    final String os : guestOSList) {
      _guestOSNeedGatewayOnNonDefaultNetwork.add(os);
    }
  }
  String value=configs.get("start.retry");
  _retry=NumbersUtil.parseInt(value,2);
  value=configs.get("router.stats.interval");
  _routerStatsInterval=NumbersUtil.parseInt(value,300);
  value=configs.get("router.check.interval");
  _routerCheckInterval=NumbersUtil.parseInt(value,30);
  value=configs.get("router.check.poolsize");
  _rvrStatusUpdatePoolSize=NumbersUtil.parseInt(value,10);
  _vrUpdateQueue=new LinkedBlockingQueue<Long>(_rvrStatusUpdatePoolSize * 1000);
  _rvrStatusUpdateExecutor=Executors.newFixedThreadPool(_rvrStatusUpdatePoolSize,new NamedThreadFactory("RedundantRouterStatusMonitor"));
  String instance=configs.get("instance.name");
  if (instance == null) {
    instance="DEFAULT";
  }
  NetworkHelperImpl.setVMInstanceName(instance);
  final String rpValue=configs.get("network.disable.rpfilter");
  if (rpValue != null && rpValue.equalsIgnoreCase("true")) {
    _disableRpFilter=true;
  }
  _dnsBasicZoneUpdates=String.valueOf(_configDao.getValue(Config.DnsBasicZoneUpdates.key()));
  s_logger.info("Router configurations: " + "ramsize=" + _routerRamSize);
  _agentMgr.registerForHostEvents(new SshKeysDistriMonitor(_agentMgr,_hostDao,_configDao),true,false,false);
  final boolean useLocalStorage=Boolean.parseBoolean(configs.get(Config.SystemVMUseLocalStorage.key()));
  ServiceOfferingVO offering=new ServiceOfferingVO("System Offering For Software Router",1,_routerRamSize,_routerCpuMHz,null,null,true,null,ProvisioningType.THIN,useLocalStorage,true,null,true,VirtualMachine.Type.DomainRouter,true);
  offering.setUniqueName(ServiceOffering.routerDefaultOffUniqueName);
  offering=_serviceOfferingDao.persistSystemServiceOffering(offering);
  _routerDeploymentManagerBuilder.setOfferingId(offering.getId());
  NetworkHelperImpl.setSystemAccount(_accountMgr.getSystemAccount());
  final String aggregationRange=configs.get("usage.stats.job.aggregation.range");
  _usageAggregationRange=NumbersUtil.parseInt(aggregationRange,1440);
  _usageTimeZone=configs.get("usage.aggregation.timezone");
  if (_usageTimeZone == null) {
    _usageTimeZone="GMT";
  }
  _agentMgr.registerForHostEvents(this,true,false,false);
  s_logger.info("DomainRouterManager is configured.");
  return true;
}
