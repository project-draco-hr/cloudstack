{
  DomainRouterVO router=profile.getVirtualMachine();
  boolean result=true;
  Answer answer=cmds.getAnswer("checkSsh");
  if (answer != null && answer instanceof CheckSshAnswer) {
    CheckSshAnswer sshAnswer=(CheckSshAnswer)answer;
    if (sshAnswer == null || !sshAnswer.getResult()) {
      s_logger.warn("Unable to ssh to the VM: " + sshAnswer.getDetails());
      result=false;
    }
  }
 else {
    result=false;
  }
  if (result == false) {
    return result;
  }
  List<Network> guestNetworks=new ArrayList<Network>();
  List<? extends Nic> routerNics=_nicDao.listByVmId(profile.getId());
  for (  Nic nic : routerNics) {
    Network network=_networkModel.getNetwork(nic.getNetworkId());
    if (network.getTrafficType() == TrafficType.Guest) {
      guestNetworks.add(network);
      if (nic.getBroadcastUri().getScheme().equals("pvlan")) {
        NicProfile nicProfile=new NicProfile(nic,network,nic.getBroadcastUri(),nic.getIsolationUri(),0,false,"pvlan-nic");
        result=setupDhcpForPvlan(true,router,router.getHostId(),nicProfile);
      }
    }
  }
  if (!result) {
    return result;
  }
  answer=cmds.getAnswer("getDomRVersion");
  if (answer != null && answer instanceof GetDomRVersionAnswer) {
    GetDomRVersionAnswer versionAnswer=(GetDomRVersionAnswer)answer;
    if (answer == null || !answer.getResult()) {
      s_logger.warn("Unable to get the template/scripts version of router " + router.getInstanceName() + " due to: "+ versionAnswer.getDetails());
      result=false;
    }
 else {
      router.setTemplateVersion(versionAnswer.getTemplateVersion());
      router.setScriptsVersion(versionAnswer.getScriptsVersion());
      router=_routerDao.persist(router,guestNetworks);
    }
  }
 else {
    result=false;
  }
  return result;
}
