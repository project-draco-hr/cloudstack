{
  long networkId=router.getNetworkId();
  List<UserVmVO> vms=_userVmDao.listByNetworkId(networkId);
  if (!vms.isEmpty()) {
    for (    UserVmVO vm : vms) {
      if (vm.getState() != State.Destroyed && vm.getState() != State.Expunging) {
        NicVO nic=_nicDao.findByInstanceIdAndNetworkId(networkId,vm.getId());
        if (nic != null) {
          s_logger.debug("Creating dhcp entry for vm " + vm + " on domR "+ router+ ".");
          DhcpEntryCommand dhcpCommand=new DhcpEntryCommand(nic.getMacAddress(),nic.getIp4Address(),vm.getHostName());
          dhcpCommand.setAccessDetail(NetworkElementCommand.ROUTER_IP,router.getPrivateIpAddress());
          dhcpCommand.setAccessDetail(NetworkElementCommand.ROUTER_NAME,router.getInstanceName());
          DataCenterVO dcVo=_dcDao.findById(router.getDataCenterIdToDeployIn());
          dhcpCommand.setAccessDetail(NetworkElementCommand.ZONE_NETWORK_TYPE,dcVo.getNetworkType().toString());
          cmds.addCommand("dhcp",dhcpCommand);
        }
      }
    }
  }
}
