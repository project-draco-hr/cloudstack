{
  DomainRouterVO router=_routerDao.findByNetwork(network.getId());
  if (router == null) {
    router=_routerDao.findByNetworkIncludingRemoved(network.getId());
    if (router != null && (router.getState() == State.Destroyed || router.getState() == State.Expunging)) {
      return true;
    }
    s_logger.warn("Unable to associate ip addresses, virtual router doesn't exist in the network " + network.getId());
    throw new ResourceUnavailableException("Unable to assign ip addresses",DataCenter.class,network.getDataCenterId());
  }
  if (router.getState() == State.Running) {
    Commands cmds=new Commands(OnError.Continue);
    createAssociateIPCommands(router,ipAddress,cmds,0);
    return sendCommandsToRouter(router,cmds);
  }
 else   if (router.getState() == State.Stopped) {
    return true;
  }
 else {
    s_logger.warn("Unable to associate ip addresses, virtual router is not in the right state " + router.getState());
    throw new ResourceUnavailableException("Unable to assign ip addresses, domR is not in right state " + router.getState(),DataCenter.class,network.getDataCenterId());
  }
}
