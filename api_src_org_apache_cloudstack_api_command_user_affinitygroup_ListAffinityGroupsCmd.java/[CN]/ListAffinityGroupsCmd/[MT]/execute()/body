{
  Pair<List<AffinityGroup>,Integer> result=_affinityGroupService.listAffinityGroups(id,affinityGroupName,affinityGroupType,virtualMachineId,this.getStartIndex(),this.getPageSizeVal());
  if (result != null) {
    ListResponse<AffinityGroupResponse> response=new ListResponse<AffinityGroupResponse>();
    List<AffinityGroupResponse> groupResponses=new ArrayList<AffinityGroupResponse>();
    for (    AffinityGroup group : result.first()) {
      AffinityGroupResponse groupResponse=_responseGenerator.createAffinityGroupResponse(group);
      groupResponses.add(groupResponse);
    }
    response.setResponses(groupResponses,result.second());
    response.setResponseName(getCommandName());
    this.setResponseObject(response);
  }
 else {
    throw new ServerApiException(ApiErrorCode.INTERNAL_ERROR,"Failed to search for affinity groups");
  }
}
