{
  Map<String,List<FirewallRuleVO>> pools=new HashMap<String,List<FirewallRuleVO>>();
  for (  FirewallRuleVO rule : fwRules) {
    StringBuilder sb=new StringBuilder();
    String poolName=sb.append(rule.getPublicIpAddress().replace(".","_")).append('-').append(rule.getPublicPort()).toString();
    if (rule.isEnabled() && !rule.isForwarding()) {
      List<FirewallRuleVO> fwList=pools.get(poolName);
      if (fwList == null) {
        fwList=new ArrayList<FirewallRuleVO>();
        pools.put(poolName,fwList);
      }
      fwList.add(rule);
    }
  }
  List<String> result=new ArrayList<String>();
  result.addAll(Arrays.asList(globalSection));
  result.add(getBlankLine());
  result.addAll(Arrays.asList(defaultsSection));
  result.add(getBlankLine());
  if (pools.isEmpty()) {
    result.addAll(Arrays.asList(defaultListen));
  }
  result.add(getBlankLine());
  for (  Map.Entry<String,List<FirewallRuleVO>> e : pools.entrySet()) {
    List<String> poolRules=getRulesForPool(e.getKey(),e.getValue());
    result.addAll(poolRules);
  }
  return result.toArray(new String[result.size()]);
}
