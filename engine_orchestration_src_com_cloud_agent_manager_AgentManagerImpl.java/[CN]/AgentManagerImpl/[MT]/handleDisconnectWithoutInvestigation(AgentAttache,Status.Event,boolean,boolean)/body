{
  final long hostId=attache.getId();
  logger.info("Host " + hostId + " is disconnecting with event "+ event);
  Status nextStatus=null;
  final HostVO host=_hostDao.findById(hostId);
  if (host == null) {
    logger.warn("Can't find host with " + hostId);
    nextStatus=Status.Removed;
  }
 else {
    final Status currentStatus=host.getStatus();
    if (currentStatus == Status.Down || currentStatus == Status.Alert || currentStatus == Status.Removed) {
      if (logger.isDebugEnabled()) {
        logger.debug("Host " + hostId + " is already "+ currentStatus);
      }
      nextStatus=currentStatus;
    }
 else {
      try {
        nextStatus=currentStatus.getNextStatus(event);
      }
 catch (      final NoTransitionException e) {
        final String err="Cannot find next status for " + event + " as current status is "+ currentStatus+ " for agent "+ hostId;
        logger.debug(err);
        throw new CloudRuntimeException(err);
      }
      if (logger.isDebugEnabled()) {
        logger.debug("The next status of agent " + hostId + "is "+ nextStatus+ ", current status is "+ currentStatus);
      }
    }
  }
  if (logger.isDebugEnabled()) {
    logger.debug("Deregistering link for " + hostId + " with state "+ nextStatus);
  }
  removeAgent(attache,nextStatus);
  if (host != null && transitState) {
    disconnectAgent(host,event,_nodeId);
  }
  return true;
}
