{
  final long templateId=vmProfile.getTemplateId();
  final long autoscaleUserId=vmProfile.getAutoScaleUserId();
  final int destroyVmGraceperiod=vmProfile.getDestroyVmGraceperiod();
  final VirtualMachineTemplate template=_entityMgr.findById(VirtualMachineTemplate.class,templateId);
  if (template == null) {
    throw new InvalidParameterValueException("Unable to use the given template.");
  }
  if (destroyVmGraceperiod < 0) {
    throw new InvalidParameterValueException("Destroy Vm Grace Period cannot be less than 0.");
  }
  final User user=_userDao.findById(autoscaleUserId);
  if (user.getAccountId() != vmProfile.getAccountId()) {
    throw new InvalidParameterValueException("AutoScale User id does not belong to the same account");
  }
  final String apiKey=user.getApiKey();
  final String secretKey=user.getSecretKey();
  final String csUrl=ApiServiceConfiguration.ApiServletPath.value();
  if (apiKey == null) {
    throw new InvalidParameterValueException("apiKey for user: " + user.getUsername() + " is empty. Please generate it");
  }
  if (secretKey == null) {
    throw new InvalidParameterValueException("secretKey for user: " + user.getUsername() + " is empty. Please generate it");
  }
  if (csUrl == null || csUrl.contains("localhost")) {
    throw new InvalidParameterValueException("Global setting endpointe.url has to be set to the Management Server's API end point");
  }
  vmProfile=_autoScaleVmProfileDao.persist(vmProfile);
  return vmProfile;
}
