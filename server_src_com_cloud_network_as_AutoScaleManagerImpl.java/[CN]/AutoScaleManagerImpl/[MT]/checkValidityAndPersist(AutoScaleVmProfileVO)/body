{
  long templateId=vmProfile.getTemplateId();
  long autoscaleUserId=vmProfile.getAutoScaleUserId();
  int destroyVmGraceperiod=vmProfile.getDestroyVmGraceperiod();
  VirtualMachineTemplate template=_templateMgr.getTemplate(templateId);
  if (template == null) {
    throw new InvalidParameterValueException("Unable to use the given template.");
  }
  if (destroyVmGraceperiod < 0) {
    throw new InvalidParameterValueException("Destroy Vm Grace Period cannot be less than 0.");
  }
  User user=_userDao.findById(autoscaleUserId);
  if (user.getAccountId() != vmProfile.getAccountId()) {
    throw new InvalidParameterValueException("AutoScale User id does not belong to the same account");
  }
  String apiKey=user.getApiKey();
  String secretKey=user.getSecretKey();
  String csUrl=_configDao.getValue(Config.EndpointeUrl.key());
  if (apiKey == null) {
    throw new InvalidParameterValueException("apiKey for user: " + user.getUsername() + " is empty. Please generate it");
  }
  if (secretKey == null) {
    throw new InvalidParameterValueException("secretKey for user: " + user.getUsername() + " is empty. Please generate it");
  }
  if (csUrl == null || csUrl.contains("localhost")) {
    throw new InvalidParameterValueException("Global setting endpointe.url has to be set to the Management Server's API end point");
  }
  vmProfile=_autoScaleVmProfileDao.persist(vmProfile);
  return vmProfile;
}
