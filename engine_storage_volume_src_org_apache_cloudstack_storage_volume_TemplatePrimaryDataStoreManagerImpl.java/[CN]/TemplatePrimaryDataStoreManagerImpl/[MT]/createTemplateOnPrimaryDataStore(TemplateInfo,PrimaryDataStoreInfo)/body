{
  TemplatePrimaryDataStoreVO templateStoreVO=null;
  boolean freshNewTemplate=false;
  templateStoreVO=templateStoreDao.findByTemplateIdAndPoolId(template.getId(),dataStore.getId());
  if (templateStoreVO == null) {
    try {
      templateStoreVO=new TemplatePrimaryDataStoreVO(dataStore.getId(),template.getId());
      templateStoreVO=templateStoreDao.persist(templateStoreVO);
      freshNewTemplate=true;
    }
 catch (    Throwable th) {
      templateStoreVO=templateStoreDao.findByTemplateIdAndPoolId(template.getId(),dataStore.getId());
      if (templateStoreVO == null) {
        throw new CloudRuntimeException("Failed create db entry: " + th.toString());
      }
    }
  }
  if (!freshNewTemplate && templateStoreVO.getState() != TemplateOnPrimaryDataStoreStateMachine.State.Ready) {
    templateStoreVO=waitingForTemplateDownload(template,dataStore);
  }
  TemplateOnPrimaryDataStoreObject templateStoreObject=new TemplateOnPrimaryDataStoreObject(dataStore,template,templateStoreVO,templateStoreDao,this);
  return templateStoreObject;
}
