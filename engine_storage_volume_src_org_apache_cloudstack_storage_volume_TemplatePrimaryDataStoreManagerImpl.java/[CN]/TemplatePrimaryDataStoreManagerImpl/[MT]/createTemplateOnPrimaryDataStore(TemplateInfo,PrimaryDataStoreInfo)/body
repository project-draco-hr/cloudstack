{
  TemplatePrimaryDataStoreVO templateStoreVO=new TemplatePrimaryDataStoreVO(dataStore.getId(),template.getId());
  try {
    templateStoreVO=templateStoreDao.persist(templateStoreVO);
  }
 catch (  Throwable th) {
    templateStoreVO=templateStoreDao.findByTemplateIdAndPoolId(template.getId(),dataStore.getId());
    if (templateStoreVO != null) {
      templateStoreVO=waitingForTemplateDownload(template,dataStore);
    }
 else {
      throw new CloudRuntimeException("Failed create db entry: " + th.toString());
    }
  }
  TemplateOnPrimaryDataStoreObject templateStoreObject=new TemplateOnPrimaryDataStoreObject(dataStore,template,templateStoreVO,templateStoreDao,this);
  return templateStoreObject;
}
