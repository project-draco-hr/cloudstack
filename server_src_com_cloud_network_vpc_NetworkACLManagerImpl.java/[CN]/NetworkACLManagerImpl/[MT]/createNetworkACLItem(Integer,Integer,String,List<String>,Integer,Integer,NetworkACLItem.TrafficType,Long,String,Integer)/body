{
  NetworkACLItem.Action ruleAction=NetworkACLItem.Action.Allow;
  if ("deny".equalsIgnoreCase(action)) {
    ruleAction=NetworkACLItem.Action.Deny;
  }
  if (number == null) {
    number=_networkACLItemDao.getMaxNumberByACL(aclId) + 1;
  }
  Transaction txn=Transaction.currentTxn();
  txn.start();
  NetworkACLItemVO newRule=new NetworkACLItemVO(portStart,portEnd,protocol.toLowerCase(),aclId,sourceCidrList,icmpCode,icmpType,trafficType,ruleAction,number);
  newRule=_networkACLItemDao.persist(newRule);
  if (!_networkACLItemDao.setStateToAdd(newRule)) {
    throw new CloudRuntimeException("Unable to update the state to add for " + newRule);
  }
  UserContext.current().setEventDetails("ACL Item Id: " + newRule.getId());
  txn.commit();
  return getNetworkACLItem(newRule.getId());
}
