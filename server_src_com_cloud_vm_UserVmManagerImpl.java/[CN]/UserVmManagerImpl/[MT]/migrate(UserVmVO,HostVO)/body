{
  HostVO fromHost=_hostDao.findById(vm.getHostId());
  if (!_vmDao.updateIf(vm,VirtualMachine.Event.MigrationRequested,vm.getHostId())) {
    s_logger.debug("State for " + vm.toString() + " has changed so migration can not take place.");
    return false;
  }
  boolean isWindows=_guestOSCategoryDao.findById(_guestOSDao.findById(vm.getGuestOSId()).getCategoryId()).getName().equalsIgnoreCase("Windows");
  MigrateCommand cmd=new MigrateCommand(vm.getInstanceName(),host.getPrivateIpAddress(),isWindows);
  Answer answer=_agentMgr.send(fromHost.getId(),cmd);
  if (answer == null) {
    return false;
  }
  List<VolumeVO> vols=_volsDao.findCreatedByInstance(vm.getId());
  if (vols.size() == 0) {
    return true;
  }
  _storageMgr.unshare(vm,vols,fromHost);
  return true;
}
