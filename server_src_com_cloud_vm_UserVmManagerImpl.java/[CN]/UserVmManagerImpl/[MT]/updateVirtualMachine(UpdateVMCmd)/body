{
  String displayName=cmd.getDisplayName();
  String group=cmd.getGroup();
  Boolean ha=cmd.getHaEnable();
  Long id=cmd.getId();
  Long osTypeId=cmd.getOsTypeId();
  Account account=UserContext.current().getCaller();
  Long userId=UserContext.current().getCallerUserId();
  UserVmVO vmInstance=null;
  vmInstance=_vmDao.findById(id.longValue());
  if (vmInstance == null) {
    throw new InvalidParameterValueException("unable to find virtual machine with id " + id);
  }
  userId=accountAndUserValidation(id,account,userId,vmInstance);
  if (displayName == null) {
    displayName=vmInstance.getDisplayName();
  }
  if (ha == null) {
    ha=vmInstance.isHaEnabled();
  }
  UserVmVO vm=_vmDao.findById(id);
  if (vm == null) {
    throw new CloudRuntimeException("Unable to find virual machine with id " + id);
  }
  if (vm.getState() == State.Error || vm.getState() == State.Expunging) {
    s_logger.error("vm is not in the right state: " + id);
    throw new InvalidParameterValueException("Vm with id " + id + " is not in the right state");
  }
  String description="";
  if (displayName != vmInstance.getDisplayName()) {
    description+="New display name: " + displayName + ". ";
  }
  if (ha != vmInstance.isHaEnabled()) {
    if (ha) {
      description+="Enabled HA. ";
    }
 else {
      description+="Disabled HA. ";
    }
  }
  if (osTypeId == null) {
    osTypeId=vmInstance.getGuestOSId();
  }
 else {
    description+="Changed Guest OS Type to " + osTypeId + ". ";
  }
  if (group != null) {
    if (addInstanceToGroup(id,group)) {
      description+="Added to group: " + group + ".";
    }
  }
  _vmDao.updateVM(id,displayName,ha,osTypeId);
  return _vmDao.findById(id);
}
