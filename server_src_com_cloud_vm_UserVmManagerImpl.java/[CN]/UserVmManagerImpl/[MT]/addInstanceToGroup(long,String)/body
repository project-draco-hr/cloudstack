{
  UserVmVO vm=_vmDao.findById(userVmId);
  InstanceGroupVO group=_vmGroupDao.findByAccountAndName(vm.getAccountId(),groupName);
  if (group == null) {
    group=createVmGroup(groupName,vm.getAccountId());
  }
  if (group != null) {
    UserVm userVm=_vmDao.acquireInLockTable(userVmId);
    if (userVm == null) {
      logger.warn("Failed to acquire lock on user vm id=" + userVmId);
    }
    try {
      final InstanceGroupVO groupFinal=group;
      Transaction.execute(new TransactionCallbackNoReturn(){
        @Override public void doInTransactionWithoutResult(        TransactionStatus status){
          InstanceGroupVO ngrpLock=_vmGroupDao.lockRow(groupFinal.getId(),false);
          if (ngrpLock == null) {
            logger.warn("Failed to acquire lock on vm group id=" + groupFinal.getId() + " name="+ groupFinal.getName());
            throw new CloudRuntimeException("Failed to acquire lock on vm group id=" + groupFinal.getId() + " name="+ groupFinal.getName());
          }
          if (_groupVMMapDao.listByInstanceId(userVmId) != null) {
            List<InstanceGroupVMMapVO> groupVmMaps=_groupVMMapDao.listByInstanceId(userVmId);
            for (            InstanceGroupVMMapVO groupMap : groupVmMaps) {
              SearchCriteria<InstanceGroupVMMapVO> sc=_groupVMMapDao.createSearchCriteria();
              sc.addAnd("instanceId",SearchCriteria.Op.EQ,groupMap.getInstanceId());
              _groupVMMapDao.expunge(sc);
            }
          }
          InstanceGroupVMMapVO groupVmMapVO=new InstanceGroupVMMapVO(groupFinal.getId(),userVmId);
          _groupVMMapDao.persist(groupVmMapVO);
        }
      }
);
      return true;
    }
  finally {
      if (userVm != null) {
        _vmDao.releaseFromLockTable(userVmId);
      }
    }
  }
  return false;
}
