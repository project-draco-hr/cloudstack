{
  ServiceOffering offering=_offeringDao.findById(userVm.getServiceOfferingId());
  if (offering.getGuestIpType() != NetworkOffering.GuestIpType.Virtual) {
    IPAddressVO guestIP=(userVm.getGuestIpAddress() == null) ? null : _ipAddressDao.findById(new Ip(userVm.getGuestIpAddress()));
    if (guestIP != null && guestIP.getAllocatedTime() != null) {
      _ipAddressDao.unassignIpAddress(new Ip(userVm.getGuestIpAddress()));
      s_logger.debug("Released guest IP address=" + userVm.getGuestIpAddress() + " vmName="+ userVm.getName()+ " dcId="+ userVm.getDataCenterId());
      EventUtils.saveEvent(User.UID_SYSTEM,userVm.getAccountId(),EventTypes.EVENT_NET_IP_RELEASE,"released a public ip: " + userVm.getGuestIpAddress());
    }
 else {
      if (_IpAllocator != null && _IpAllocator.exteralIpAddressAllocatorEnabled()) {
        String guestIp=userVm.getGuestIpAddress();
        if (guestIp != null) {
          _IpAllocator.releasePrivateIpAddress(guestIp,userVm.getDataCenterId(),userVm.getPodId());
        }
      }
    }
  }
  userVm.setGuestIpAddress(null);
  _vmDao.update(userVm.getId(),userVm);
}
