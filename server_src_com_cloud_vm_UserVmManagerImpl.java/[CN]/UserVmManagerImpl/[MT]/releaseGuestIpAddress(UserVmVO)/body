{
  ServiceOffering offering=_offeringDao.findById(userVm.getServiceOfferingId());
  if (offering.getGuestIpType() != NetworkOffering.GuestIpType.Virtualized) {
    IPAddressVO guestIP=(userVm.getGuestIpAddress() == null) ? null : _ipAddressDao.findById(userVm.getGuestIpAddress());
    if (guestIP != null && guestIP.getAllocated() != null) {
      _ipAddressDao.unassignIpAddress(userVm.getGuestIpAddress());
      s_logger.debug("Released guest IP address=" + userVm.getGuestIpAddress() + " vmName="+ userVm.getName()+ " dcId="+ userVm.getDataCenterId());
      EventVO event=new EventVO();
      event.setUserId(User.UID_SYSTEM);
      event.setAccountId(userVm.getAccountId());
      event.setType(EventTypes.EVENT_NET_IP_RELEASE);
      event.setParameters("guestIPaddress=" + userVm.getGuestIpAddress() + "\nvmName="+ userVm.getName()+ "\ndcId="+ userVm.getDataCenterId());
      event.setDescription("released a public ip: " + userVm.getGuestIpAddress());
      _eventDao.persist(event);
    }
 else {
      if (_IpAllocator != null && _IpAllocator.exteralIpAddressAllocatorEnabled()) {
        String guestIp=userVm.getGuestIpAddress();
        if (guestIp != null) {
          _IpAllocator.releasePrivateIpAddress(guestIp,userVm.getDataCenterId(),userVm.getPodId());
        }
      }
    }
  }
  userVm.setGuestIpAddress(null);
  _vmDao.update(userVm.getId(),userVm);
}
