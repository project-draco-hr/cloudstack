{
  Account caller=UserContext.current().getAccount();
  Long userId=UserContext.current().getUserId();
  long id=cmd.getId();
  if (caller != null && caller.getRemoved() != null)   throw new PermissionDeniedException("The account " + caller.getId() + " is removed");
  UserVmVO vmInstance=_vmDao.findById(id);
  if (vmInstance == null) {
    throw new InvalidParameterValueException("unable to find a virtual machine with id " + id);
  }
  long eventId=EventUtils.saveScheduledEvent(userId,vmInstance.getAccountId(),EventTypes.EVENT_VM_STOP,"stopping Vm with Id: " + id);
  userId=accountAndUserValidation(id,caller,userId,vmInstance);
  UserVO user=_userDao.findById(userId);
  try {
    _itMgr.stop(vmInstance,user,caller);
  }
 catch (  AgentUnavailableException e) {
    throw new CloudRuntimeException("Unable to contact the agent to stop the virtual machine " + vmInstance,e);
  }
catch (  OperationTimedoutException e) {
    throw new CloudRuntimeException("Waiting too long for agent to stop the virtual machine " + vmInstance,e);
  }
  return _vmDao.findById(id);
}
