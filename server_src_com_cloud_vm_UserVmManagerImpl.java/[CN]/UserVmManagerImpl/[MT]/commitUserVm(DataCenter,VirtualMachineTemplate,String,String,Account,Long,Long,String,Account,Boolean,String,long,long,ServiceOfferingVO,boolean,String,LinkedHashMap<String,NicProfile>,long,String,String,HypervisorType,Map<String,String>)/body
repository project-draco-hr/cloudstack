{
  return Transaction.execute(new TransactionCallbackWithException<UserVmVO,InsufficientCapacityException>(){
    @Override public UserVmVO doInTransaction(    TransactionStatus status) throws InsufficientCapacityException {
      UserVmVO vm=new UserVmVO(id,instanceName,displayName,template.getId(),hypervisorType,template.getGuestOSId(),offering.getOfferHA(),offering.getLimitCpuUse(),owner.getDomainId(),owner.getId(),userId,offering.getId(),userData,hostName,diskOfferingId);
      vm.setUuid(uuidName);
      vm.setDynamicallyScalable(template.isDynamicallyScalable());
      Map<String,String> details=template.getDetails();
      if (details != null && !details.isEmpty()) {
        vm.details.putAll(details);
      }
      if (sshPublicKey != null) {
        vm.setDetail("SSH.PublicKey",sshPublicKey);
      }
      if (keyboard != null && !keyboard.isEmpty())       vm.setDetail(VmDetailConstants.KEYBOARD,keyboard);
      if (isIso) {
        vm.setIsoId(template.getId());
      }
      Long rootDiskSize=null;
      if (customParameters.containsKey("rootdisksize")) {
        if (NumbersUtil.parseLong(customParameters.get("rootdisksize"),-1) <= 0) {
          throw new InvalidParameterValueException("rootdisk size should be a non zero number.");
        }
        rootDiskSize=Long.parseLong(customParameters.get("rootdisksize"));
        if (hypervisorType != HypervisorType.KVM) {
          throw new InvalidParameterValueException("Hypervisor " + hypervisorType + " does not support rootdisksize override");
        }
        VMTemplateVO templateVO=_templateDao.findById(template.getId());
        if (templateVO == null) {
          throw new InvalidParameterValueException("Unable to look up template by id " + template.getId());
        }
        if ((rootDiskSize << 30) < templateVO.getSize()) {
          Long templateVOSizeGB=templateVO.getSize() / 1024 / 1024/ 1024;
          throw new InvalidParameterValueException("unsupported: rootdisksize override is smaller than template size " + templateVO.getSize() + "B ("+ templateVOSizeGB+ "GB)");
        }
 else {
          s_logger.debug("rootdisksize of " + (rootDiskSize << 30) + " was larger than template size of "+ templateVO.getSize());
        }
        s_logger.debug("found root disk size of " + rootDiskSize);
        customParameters.remove("rootdisksize");
      }
      if (isDisplayVm != null) {
        vm.setDisplayVm(isDisplayVm);
      }
 else {
        vm.setDisplayVm(true);
      }
      if (hypervisorType.equals(HypervisorType.VMware)) {
        UserVmCloneType cloneType=UserVmCloneType.linked;
        String value=_configDao.getValue(Config.VmwareCreateFullClone.key());
        if (value != null) {
          if (Boolean.parseBoolean(value) == true)           cloneType=UserVmCloneType.full;
        }
        UserVmCloneSettingVO vmCloneSettingVO=new UserVmCloneSettingVO(id,cloneType.toString());
        _vmCloneSettingDao.persist(vmCloneSettingVO);
      }
      long guestOSId=template.getGuestOSId();
      GuestOSVO guestOS=_guestOSDao.findById(guestOSId);
      long guestOSCategoryId=guestOS.getCategoryId();
      GuestOSCategoryVO guestOSCategory=_guestOSCategoryDao.findById(guestOSCategoryId);
      if (hypervisorType.equals(HypervisorType.VMware)) {
        if (guestOS.getDisplayName().toLowerCase().contains("apple mac os")) {
          vm.setDetail("smc.present","TRUE");
          vm.setDetail(VmDetailConstants.ROOK_DISK_CONTROLLER,"scsi");
          vm.setDetail(VmDetailConstants.DATA_DISK_CONTROLLER,"scsi");
          vm.setDetail("firmware","efi");
          s_logger.info("guestOS is OSX : overwrite root disk controller to scsi, use smc and efi");
        }
 else {
          String controllerSetting=_configDao.getValue("vmware.root.disk.controller");
          vm.setDetail(VmDetailConstants.ROOK_DISK_CONTROLLER,controllerSetting);
          if (controllerSetting.equalsIgnoreCase("scsi")) {
            vm.setDetail(VmDetailConstants.DATA_DISK_CONTROLLER,"scsi");
          }
 else {
            vm.setDetail(VmDetailConstants.DATA_DISK_CONTROLLER,"osdefault");
          }
        }
      }
      _vmDao.persist(vm);
      for (      String key : customParameters.keySet()) {
        vm.setDetail(key,customParameters.get(key));
      }
      _vmDao.saveDetails(vm);
      s_logger.debug("Allocating in the DB for vm");
      DataCenterDeployment plan=new DataCenterDeployment(zone.getId());
      List<String> computeTags=new ArrayList<String>();
      computeTags.add(offering.getHostTag());
      List<String> rootDiskTags=new ArrayList<String>();
      rootDiskTags.add(offering.getTags());
      if (isIso) {
        _orchSrvc.createVirtualMachineFromScratch(vm.getUuid(),Long.toString(owner.getAccountId()),vm.getIsoId().toString(),hostName,displayName,hypervisorType.name(),guestOSCategory.getName(),offering.getCpu(),offering.getSpeed(),offering.getRamSize(),diskSize,computeTags,rootDiskTags,networkNicMap,plan);
      }
 else {
        _orchSrvc.createVirtualMachine(vm.getUuid(),Long.toString(owner.getAccountId()),Long.toString(template.getId()),hostName,displayName,hypervisorType.name(),offering.getCpu(),offering.getSpeed(),offering.getRamSize(),diskSize,computeTags,rootDiskTags,networkNicMap,plan,rootDiskSize);
      }
      if (s_logger.isDebugEnabled()) {
        s_logger.debug("Successfully allocated DB entry for " + vm);
      }
      CallContext.current().setEventDetails("Vm Id: " + vm.getId());
      if (!offering.isDynamic()) {
        UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_CREATE,accountId,zone.getId(),vm.getId(),vm.getHostName(),offering.getId(),template.getId(),hypervisorType.toString(),VirtualMachine.class.getName(),vm.getUuid(),vm.isDisplayVm());
      }
 else {
        UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_CREATE,accountId,zone.getId(),vm.getId(),vm.getHostName(),offering.getId(),template.getId(),hypervisorType.toString(),VirtualMachine.class.getName(),vm.getUuid(),customParameters,vm.isDisplayVm());
      }
      resourceCountIncrement(accountId,isDisplayVm,new Long(offering.getCpu()),new Long(offering.getRamSize()));
      return vm;
    }
  }
);
}
