{
  VMTemplateVO template=_templateDao.findByIdIncludingRemoved(vm.getTemplateId());
  List<? extends Nic> nics=_nicDao.listByVmId(vm.getId());
  if (nics == null || nics.isEmpty()) {
    s_logger.error("unable to find any nics for vm " + vm.getUuid());
    return false;
  }
  for (  Nic nic : nics) {
    Network network=_networkDao.findById(nic.getNetworkId());
    NicProfile nicProfile=new NicProfile(nic,network,null,null,null,_networkModel.isSecurityGroupSupportedInNetwork(network),_networkModel.getNetworkTag(template.getHypervisorType(),network));
    VirtualMachineProfile<VMInstanceVO> vmProfile=new VirtualMachineProfileImpl<VMInstanceVO>((VMInstanceVO)vm);
    UserDataServiceProvider element=_networkModel.getUserDataUpdateProvider(network);
    if (element == null) {
      throw new CloudRuntimeException("Can't find network element for " + Service.UserData.getName() + " provider needed for UserData update");
    }
    boolean result=element.saveUserData(network,nicProfile,vmProfile);
    if (!result) {
      s_logger.error("Failed to update userdata for vm " + vm + " and nic "+ nic);
    }
  }
  return true;
}
