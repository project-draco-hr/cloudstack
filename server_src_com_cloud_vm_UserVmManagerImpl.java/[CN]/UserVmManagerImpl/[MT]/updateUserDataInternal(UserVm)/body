{
  VMTemplateVO template=_templateDao.findByIdIncludingRemoved(vm.getTemplateId());
  Nic defaultNic=_networkModel.getDefaultNic(vm.getId());
  if (defaultNic == null) {
    s_logger.error("Unable to update userdata for vm id=" + vm.getId() + " as the instance doesn't have default nic");
    return false;
  }
  Network defaultNetwork=_networkDao.findById(defaultNic.getNetworkId());
  NicProfile defaultNicProfile=new NicProfile(defaultNic,defaultNetwork,null,null,null,_networkModel.isSecurityGroupSupportedInNetwork(defaultNetwork),_networkModel.getNetworkTag(template.getHypervisorType(),defaultNetwork));
  VirtualMachineProfile<VMInstanceVO> vmProfile=new VirtualMachineProfileImpl<VMInstanceVO>((VMInstanceVO)vm);
  UserDataServiceProvider element=_networkModel.getUserDataUpdateProvider(defaultNetwork);
  if (element == null) {
    throw new CloudRuntimeException("Can't find network element for " + Service.UserData.getName() + " provider needed for UserData update");
  }
  boolean result=element.saveUserData(defaultNetwork,defaultNicProfile,vmProfile);
  return true;
}
