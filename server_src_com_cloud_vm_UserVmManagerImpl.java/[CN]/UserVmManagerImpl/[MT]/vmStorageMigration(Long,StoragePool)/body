{
  Account caller=CallContext.current().getCallingAccount();
  if (!_accountMgr.isRootAdmin(caller.getId())) {
    if (s_logger.isDebugEnabled()) {
      s_logger.debug("Caller is not a root admin, permission denied to migrate the VM");
    }
    throw new PermissionDeniedException("No permission to migrate VM, Only Root Admin can migrate a VM!");
  }
  VMInstanceVO vm=_vmInstanceDao.findById(vmId);
  if (vm == null) {
    throw new InvalidParameterValueException("Unable to find the VM by id=" + vmId);
  }
  if (vm.getState() != State.Stopped) {
    InvalidParameterValueException ex=new InvalidParameterValueException("VM is not Stopped, unable to migrate the vm having the specified id");
    ex.addProxyObject(vm.getUuid(),"vmId");
    throw ex;
  }
  if (vm.getType() != VirtualMachine.Type.User) {
    throw new InvalidParameterValueException("can only do storage migration on user vm");
  }
  List<VolumeVO> vols=_volsDao.findByInstance(vm.getId());
  if (vols.size() > 1) {
    throw new InvalidParameterValueException("Data disks attached to the vm, can not migrate. Need to dettach data disks at first");
  }
  if (_vmSnapshotDao.findByVm(vmId).size() > 0) {
    throw new InvalidParameterValueException("VM's disk cannot be migrated, please remove all the VM Snapshots for this VM");
  }
  HypervisorType destHypervisorType=destPool.getHypervisor();
  if (destHypervisorType == null) {
    destHypervisorType=_clusterDao.findById(destPool.getClusterId()).getHypervisorType();
  }
  if (vm.getHypervisorType() != destHypervisorType) {
    throw new InvalidParameterValueException("hypervisor is not compatible: dest: " + destHypervisorType.toString() + ", vm: "+ vm.getHypervisorType().toString());
  }
  _itMgr.storageMigration(vm.getUuid(),destPool);
  return _vmDao.findById(vm.getId());
}
