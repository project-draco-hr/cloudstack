{
  Transaction txn=Transaction.currentTxn();
  try {
    String vnet=vm.getVnet();
    vm.setVnet(null);
    vm.setProxyAssignTime(null);
    vm.setProxyId(null);
    txn.start();
    if (!_vmDao.updateIf(vm,e,null)) {
      s_logger.debug("Unable to update ");
      return;
    }
    if ((vm.getDomainRouterId() != null) && _vmDao.listBy(vm.getDomainRouterId(),State.Starting,State.Running).size() == 0) {
      DomainRouterVO router=_routerDao.findById(vm.getDomainRouterId());
      if (router.getState().equals(State.Stopped)) {
        _dcDao.releaseVnet(vnet,router.getDataCenterId(),router.getAccountId(),null);
      }
    }
    txn.commit();
    _networkGroupMgr.handleVmStateTransition(vm,State.Stopped);
  }
 catch (  Throwable th) {
    s_logger.error("Error during stop: ",th);
    throw new CloudRuntimeException("Error during stop: ",th);
  }
  EventVO event=new EventVO();
  event.setUserId(userId);
  event.setAccountId(vm.getAccountId());
  event.setType(EventTypes.EVENT_VM_STOP);
  event.setState(Event.State.Completed);
  event.setStartId(startEventId);
  event.setParameters("id=" + vm.getId() + "\n"+ "vmName="+ vm.getHostName()+ "\nsoId="+ vm.getServiceOfferingId()+ "\ntId="+ vm.getTemplateId()+ "\ndcId="+ vm.getDataCenterId());
  if (!vm.getHostName().equals(vm.getDisplayName()))   event.setDescription("Successfully stopped VM instance : " + vm.getHostName() + "("+ vm.getDisplayName()+ ")");
 else   event.setDescription("Successfully stopped VM instance : " + vm.getHostName());
  _eventDao.persist(event);
  if (_storageMgr.unshare(vm,null) == null) {
    s_logger.warn("Unable to set share to false for " + vm.toString());
  }
}
