{
  Long vmId=cmd.getId();
  Long newSvcOffId=cmd.getServiceOfferingId();
  Account caller=UserContext.current().getCaller();
  VMInstanceVO vmInstance=_vmInstanceDao.findById(vmId);
  if (vmInstance.getHypervisorType() != HypervisorType.XenServer) {
    throw new InvalidParameterValueException("This operation not permitted for this hypervisor of the vm");
  }
  _accountMgr.checkAccess(caller,null,true,vmInstance);
  _itMgr.checkIfCanUpgrade(vmInstance,newSvcOffId);
  ServiceOffering newServiceOffering=_configMgr.getServiceOffering(newSvcOffId);
  ServiceOffering oldServiceOffering=_configMgr.getServiceOffering(vmInstance.getServiceOfferingId());
  if (newServiceOffering.getSpeed() <= oldServiceOffering.getSpeed() && newServiceOffering.getRamSize() <= oldServiceOffering.getRamSize()) {
    throw new InvalidParameterValueException("Only scaling up the vm is supported");
  }
  if (vmInstance.getState().equals(State.Running)) {
    boolean success=false;
    int retry=_scaleRetry;
    while (retry-- != 0) {
      try {
        boolean existingHostHasCapacity=_capacityMgr.checkIfHostHasCapacity(vmInstance.getHostId(),newServiceOffering.getSpeed() - oldServiceOffering.getSpeed(),(newServiceOffering.getRamSize() - oldServiceOffering.getRamSize()) * 1024L * 1024L,false,ApiDBUtils.getCpuOverprovisioningFactor(),1f,false);
        if (!existingHostHasCapacity) {
          vmInstance=_itMgr.scale(vmInstance.getType(),vmInstance,newSvcOffId);
        }
 else {
          vmInstance.setSameHost(existingHostHasCapacity);
        }
        vmInstance=_itMgr.reConfigureVm(vmInstance,newServiceOffering,existingHostHasCapacity);
        success=true;
      }
 catch (      InsufficientCapacityException e) {
      }
catch (      ResourceUnavailableException e) {
        e.printStackTrace();
      }
catch (      ConcurrentOperationException e) {
        e.printStackTrace();
      }
catch (      VirtualMachineMigrationException e) {
        e.printStackTrace();
      }
catch (      ManagementServerException e) {
        e.printStackTrace();
      }
    }
    if (!success)     return null;
  }
  _itMgr.upgradeVmDb(vmId,newSvcOffId);
  return _vmDao.findById(vmInstance.getId());
}
