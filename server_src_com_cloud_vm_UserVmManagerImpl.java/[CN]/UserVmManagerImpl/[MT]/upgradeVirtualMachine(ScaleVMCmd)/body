{
  Long vmId=cmd.getId();
  Long newServiceOfferingId=cmd.getServiceOfferingId();
  CallContext.current().setEventDetails("Vm Id: " + vmId);
  boolean result=upgradeVirtualMachine(vmId,newServiceOfferingId,cmd.getDetails());
  if (result) {
    UserVmVO vmInstance=_vmDao.findById(vmId);
    if (vmInstance.getState().equals(State.Stopped)) {
      generateUsageEvent(_offeringDao.findById(newServiceOfferingId),cmd.getDetails(),_vmDao.findById(vmId),EventTypes.EVENT_VM_UPGRADE);
    }
    if (vmInstance.getState().equals(State.Running)) {
      generateUsageEvent(_offeringDao.findById(newServiceOfferingId),cmd.getDetails(),_vmDao.findById(vmId),EventTypes.EVENT_VM_UPGRADE);
    }
    return vmInstance;
  }
 else {
    throw new CloudRuntimeException("Failed to scale the VM");
  }
}
