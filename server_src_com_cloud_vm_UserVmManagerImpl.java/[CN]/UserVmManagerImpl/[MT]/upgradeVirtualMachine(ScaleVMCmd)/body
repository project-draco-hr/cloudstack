{
  Long vmId=cmd.getId();
  Long newServiceOfferingId=cmd.getServiceOfferingId();
  CallContext.current().setEventDetails("Vm Id: " + vmId);
  boolean result=upgradeVirtualMachine(vmId,newServiceOfferingId);
  if (result) {
    UserVmVO vmInstance=_vmDao.findById(vmId);
    if (vmInstance.getState().equals(State.Stopped)) {
      UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_UPGRADE,vmInstance.getAccountId(),vmInstance.getDataCenterId(),vmInstance.getId(),vmInstance.getHostName(),vmInstance.getServiceOfferingId(),vmInstance.getTemplateId(),vmInstance.getHypervisorType().toString(),VirtualMachine.class.getName(),vmInstance.getUuid());
    }
    if (vmInstance.getState().equals(State.Running)) {
      UsageEventUtils.publishUsageEvent(EventTypes.EVENT_VM_DYNAMIC_SCALE,vmInstance.getAccountId(),vmInstance.getDataCenterId(),vmInstance.getId(),vmInstance.getHostName(),vmInstance.getServiceOfferingId(),vmInstance.getTemplateId(),vmInstance.getHypervisorType().toString(),VirtualMachine.class.getName(),vmInstance.getUuid());
    }
    return vmInstance;
  }
 else {
    throw new CloudRuntimeException("Failed to scale the VM");
  }
}
