{
  Account account=UserContext.current().getCaller();
  Long userId=UserContext.current().getCallerUserId();
  if (account != null && account.getRemoved() != null) {
    throw new PermissionDeniedException("The account " + account.getId() + " is removed");
  }
  UserVmVO vm=_vmDao.findById(vmId);
  if (vm == null) {
    throw new InvalidParameterValueException("unable to find a virtual machine with id " + vmId);
  }
  userId=accountAndUserValidation(vmId,account,userId,vm);
  UserVO user=_userDao.findById(userId);
  if (_securityGroupMgr.isVmSecurityGroupEnabled(vmId) && !_securityGroupMgr.isVmMappedToDefaultSecurityGroup(vmId)) {
    if (s_logger.isDebugEnabled()) {
      s_logger.debug("Vm " + vm + " is security group enabled, but not mapped to default security group; creating the mapping automatically");
    }
    SecurityGroup defaultSecurityGroup=_securityGroupMgr.getDefaultSecurityGroup(vm.getAccountId());
    if (defaultSecurityGroup != null) {
      List<Long> groupList=new ArrayList<Long>();
      groupList.add(defaultSecurityGroup.getId());
      _securityGroupMgr.addInstanceToGroups(vmId,groupList);
    }
  }
  return _itMgr.start(vm,null,user,account);
}
