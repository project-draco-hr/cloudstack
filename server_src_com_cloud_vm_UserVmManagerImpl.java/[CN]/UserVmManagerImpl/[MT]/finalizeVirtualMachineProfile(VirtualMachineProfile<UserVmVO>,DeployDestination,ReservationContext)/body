{
  UserVmVO vm=profile.getVirtualMachine();
  Account owner=_accountDao.findById(vm.getAccountId());
  if (owner == null) {
    throw new PermissionDeniedException("The owner of " + vm + " does not exist: "+ vm.getAccountId());
  }
  if (owner.getState() == Account.State.disabled) {
    throw new PermissionDeniedException("The owner of " + vm + " is disabled: "+ vm.getAccountId());
  }
  if (vm.getIsoId() != null) {
    String isoPath=null;
    VirtualMachineTemplate template=_templateDao.findById(vm.getIsoId());
    if (template == null || template.getFormat() != ImageFormat.ISO) {
      throw new CloudRuntimeException("Can not find ISO in vm_template table for id " + vm.getIsoId());
    }
    Pair<String,String> isoPathPair=_storageMgr.getAbsoluteIsoPath(template.getId(),vm.getDataCenterId());
    if (isoPathPair == null) {
      s_logger.warn("Couldn't get absolute iso path");
      return false;
    }
 else {
      isoPath=isoPathPair.first();
    }
    if (template.isBootable()) {
      profile.setBootLoaderType(BootloaderType.CD);
    }
    GuestOSVO guestOS=_guestOSDao.findById(template.getGuestOSId());
    String displayName=null;
    if (guestOS != null) {
      displayName=guestOS.getDisplayName();
    }
    VolumeTO iso=new VolumeTO(profile.getId(),Volume.Type.ISO,StoragePoolType.ISO,null,template.getName(),null,isoPath,0,null,displayName);
    iso.setDeviceId(3);
    profile.addDisk(iso);
  }
 else {
    VirtualMachineTemplate template=profile.getTemplate();
    VolumeTO iso=new VolumeTO(profile.getId(),Volume.Type.ISO,StoragePoolType.ISO,null,template.getName(),null,null,0,null);
    iso.setDeviceId(3);
    profile.addDisk(iso);
    if (template != null) {
      if (template.isRequiresHvm()) {
        profile.setBootLoaderType(BootloaderType.HVM);
      }
 else {
        profile.setBootLoaderType(BootloaderType.PyGrub);
      }
    }
  }
  return true;
}
