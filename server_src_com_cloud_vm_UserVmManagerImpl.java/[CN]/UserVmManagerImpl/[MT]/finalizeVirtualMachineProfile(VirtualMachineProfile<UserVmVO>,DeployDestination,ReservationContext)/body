{
  UserVmVO vm=profile.getVirtualMachine();
  Account owner=_accountDao.findById(vm.getAccountId());
  if (owner == null) {
    throw new PermissionDeniedException("The owner of " + vm + " does not exist: "+ vm.getAccountId());
  }
  if (owner.getState() == Account.State.disabled) {
    throw new PermissionDeniedException("The owner of " + vm + " is disabled: "+ vm.getAccountId());
  }
  VirtualMachineTemplate template=profile.getTemplate();
  if (vm.getIsoId() != null) {
    template=_templateDao.findById(vm.getIsoId());
  }
  if (template != null && template.getFormat() == ImageFormat.ISO && vm.getIsoId() != null) {
    String isoPath=null;
    Pair<String,String> isoPathPair=_storageMgr.getAbsoluteIsoPath(template.getId(),vm.getDataCenterId());
    if (isoPathPair == null) {
      s_logger.warn("Couldn't get absolute iso path");
      return false;
    }
 else {
      isoPath=isoPathPair.first();
    }
    if (template.isBootable()) {
      profile.setBootLoaderType(BootloaderType.CD);
    }
    GuestOSVO guestOS=_guestOSDao.findById(template.getGuestOSId());
    String displayName=null;
    if (guestOS != null) {
      displayName=guestOS.getDisplayName();
    }
    VolumeTO iso=new VolumeTO(profile.getId(),Volume.Type.ISO,StorageResourceType.STORAGE_POOL,StoragePoolType.ISO,null,template.getName(),null,isoPath,0,null,displayName);
    iso.setDeviceId(3);
    profile.addDisk(iso);
  }
 else {
    VolumeTO iso=new VolumeTO(profile.getId(),Volume.Type.ISO,StorageResourceType.STORAGE_POOL,StoragePoolType.ISO,null,template.getName(),null,null,0,null);
    iso.setDeviceId(3);
    profile.addDisk(iso);
  }
  return true;
}
