{
  State state=vm.getState();
  if (state == State.Stopped) {
    if (s_logger.isDebugEnabled()) {
      s_logger.debug("VM is already stopped: " + vm.toString());
    }
    return true;
  }
  if (state == State.Creating || state == State.Destroyed || state == State.Expunging) {
    s_logger.warn("Stopped called on " + vm.toString() + " but the state is "+ state.toString());
    return true;
  }
  if (!_vmDao.updateIf(vm,Event.StopRequested,vm.getHostId())) {
    s_logger.debug("VM is not in a state to stop: " + vm.getState().toString());
    return false;
  }
  if (vm.getHostId() == null) {
    s_logger.debug("Host id is null so we can't stop it.  How did we get into here?");
    return false;
  }
  EventVO event=new EventVO();
  event.setUserId(userId);
  event.setAccountId(vm.getAccountId());
  event.setType(EventTypes.EVENT_VM_STOP);
  event.setStartId(startEventId);
  event.setParameters("id=" + vm.getId() + "\n"+ "vmName="+ vm.getHostName()+ "\nsoId="+ vm.getServiceOfferingId()+ "\ntId="+ vm.getTemplateId()+ "\ndcId="+ vm.getDataCenterId());
  StopCommand stop=new StopCommand(vm,vm.getInstanceName(),vm.getVnet());
  boolean stopped=false;
  try {
    Answer answer=_agentMgr.send(vm.getHostId(),stop);
    if (!answer.getResult()) {
      s_logger.warn("Unable to stop vm " + vm.getHostName() + " due to "+ answer.getDetails());
    }
 else {
      stopped=true;
    }
  }
 catch (  AgentUnavailableException e) {
    s_logger.warn("Agent is not available to stop vm " + vm.toString());
  }
catch (  OperationTimedoutException e) {
    s_logger.warn("operation timed out " + vm.toString());
  }
  if (stopped) {
    completeStopCommand(userId,vm,Event.OperationSucceeded,0);
  }
 else {
    if (!vm.getHostName().equals(vm.getDisplayName()))     event.setDescription("failed to stop VM instance : " + vm.getHostName() + "("+ vm.getDisplayName()+ ")");
 else     event.setDescription("failed to stop VM instance : " + vm.getHostName());
    event.setLevel(EventVO.LEVEL_ERROR);
    _eventDao.persist(event);
    _vmDao.updateIf(vm,Event.OperationFailed,vm.getHostId());
    s_logger.error("Unable to stop vm " + vm.getHostName());
  }
  return stopped;
}
