{
  Account account=UserContext.current().getAccount();
  if ((cmmd.getId() == null && cmmd.getDeviceId() == null && cmmd.getVirtualMachineId() == null) || (cmmd.getId() != null && (cmmd.getDeviceId() != null || cmmd.getVirtualMachineId() != null)) || (cmmd.getId() == null && (cmmd.getDeviceId() == null || cmmd.getVirtualMachineId() == null))) {
    throw new InvalidParameterValueException("Please provide either a volume id, or a tuple(device id, instance id)");
  }
  Long volumeId=cmmd.getId();
  VolumeVO volume=null;
  if (volumeId != null) {
    volume=_volsDao.findById(volumeId);
  }
 else {
    volume=_volsDao.findByInstanceAndDeviceId(cmmd.getVirtualMachineId(),cmmd.getDeviceId()).get(0);
  }
  Long vmId=null;
  if (cmmd.getVirtualMachineId() == null) {
    vmId=volume.getInstanceId();
  }
 else {
    vmId=cmmd.getVirtualMachineId();
  }
  boolean isAdmin;
  if (account == null) {
    isAdmin=true;
  }
 else {
    isAdmin=isAdmin(account.getType());
  }
  if (volume == null) {
    throw new ServerApiException(BaseCmd.PARAM_ERROR,"Unable to find volume with ID: " + volumeId);
  }
  if (!isAdmin) {
    if (account.getId() != volume.getAccountId()) {
      throw new ServerApiException(BaseCmd.PARAM_ERROR,"Unable to find volume with ID: " + volumeId + " for account: "+ account.getAccountName());
    }
  }
 else   if (account != null) {
    if (!_domainDao.isChildDomain(account.getDomainId(),volume.getDomainId())) {
      throw new ServerApiException(BaseCmd.ACCOUNT_ERROR,"Unable to detach volume with ID: " + volumeId + ", permission denied.");
    }
  }
  if (volume.getVolumeType() != VolumeType.DATADISK) {
    throw new InvalidParameterValueException("Please specify a data volume.");
  }
  if (!_storageMgr.volumeOnSharedStoragePool(volume)) {
    throw new InvalidParameterValueException("Please specify a volume that has been created on a shared storage pool.");
  }
  if (vmId == null) {
    throw new InvalidParameterValueException("The specified volume is not attached to a VM.");
  }
  UserVmVO vm=_vmDao.findById(vmId);
  if (vm.getState() != State.Running && vm.getState() != State.Stopped) {
    throw new InvalidParameterValueException("Please specify a VM that is either running or stopped.");
  }
  long eventId=EventUtils.saveScheduledEvent(1L,volume.getAccountId(),EventTypes.EVENT_VOLUME_DETACH,"detaching volume: " + volumeId + " from Vm: "+ vmId);
  AsyncJobExecutor asyncExecutor=BaseAsyncJobExecutor.getCurrentExecutor();
  if (asyncExecutor != null) {
    AsyncJobVO job=asyncExecutor.getJob();
    if (s_logger.isInfoEnabled()) {
      s_logger.info("Trying to attaching volume " + volumeId + "to vm instance:"+ vm.getId()+ ", update async job-"+ job.getId()+ " progress status");
    }
    _asyncMgr.updateAsyncJobAttachment(job.getId(),"volume",volumeId);
    _asyncMgr.updateAsyncJobStatus(job.getId(),BaseCmd.PROGRESS_INSTANCE_CREATED,volumeId);
  }
  String errorMsg="Failed to detach volume: " + volume.getName() + " from VM: "+ vm.getHostName();
  boolean sendCommand=(vm.getState() == State.Running);
  Answer answer=null;
  if (sendCommand) {
    AttachVolumeCommand cmd=new AttachVolumeCommand(false,vm.getInstanceName(),volume.getPoolType(),volume.getFolder(),volume.getPath(),volume.getName(),cmmd.getDeviceId() != null ? cmmd.getDeviceId() : volume.getDeviceId(),volume.getChainInfo());
    StoragePoolVO volumePool=_storagePoolDao.findById(volume.getPoolId());
    cmd.setPoolUuid(volumePool.getUuid());
    try {
      answer=_agentMgr.send(vm.getHostId(),cmd);
    }
 catch (    Exception e) {
      throw new CloudRuntimeException(errorMsg + " due to: " + e.getMessage());
    }
  }
  EventVO event=new EventVO();
  event.setAccountId(volume.getAccountId());
  event.setUserId(1L);
  event.setType(EventTypes.EVENT_VOLUME_DETACH);
  event.setState(Event.State.Completed);
  event.setStartId(eventId);
  if (!sendCommand || (answer != null && answer.getResult())) {
    _volsDao.detachVolume(volume.getId());
    if (answer != null && answer instanceof AttachVolumeAnswer) {
      volume.setChainInfo(((AttachVolumeAnswer)answer).getChainInfo());
      _volsDao.update(volume.getId(),volume);
    }
    if (!vm.getHostName().equals(vm.getDisplayName())) {
      event.setDescription("Volume: " + volume.getName() + " successfully detached from VM: "+ vm.getHostName()+ "("+ vm.getDisplayName()+ ")");
    }
 else {
      event.setDescription("Volume: " + volume.getName() + " successfully detached from VM: "+ vm.getHostName());
    }
    event.setLevel(EventVO.LEVEL_INFO);
    _eventDao.persist(event);
    return _volsDao.findById(volumeId);
  }
 else {
    if (answer != null) {
      String details=answer.getDetails();
      if (details != null && !details.isEmpty()) {
        errorMsg+="; " + details;
      }
    }
    throw new CloudRuntimeException(errorMsg);
  }
}
