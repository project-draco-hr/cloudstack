{
  UserVmVO vm=_vmDao.findById(vmId);
  if (vm != null) {
    if (vm.getState().equals(State.Stopped)) {
      _itMgr.stateTransitTo(vm,VirtualMachine.Event.OperationFailed,null);
      List<VolumeVO> volumesForThisVm=_volsDao.findByInstance(vm.getId());
      for (      VolumeVO volume : volumesForThisVm) {
        try {
          _storageMgr.destroyVolume(volume);
        }
 catch (        ConcurrentOperationException e) {
          s_logger.warn("Unable to delete volume:" + volume.getId() + " for vm:"+ vmId+ " whilst transitioning to error state");
        }
      }
    }
  }
}
