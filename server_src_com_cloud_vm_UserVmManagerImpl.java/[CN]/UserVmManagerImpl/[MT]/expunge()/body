{
  List<UserVmVO> vms=_vmDao.findDestroyedVms(new Date(System.currentTimeMillis() - ((long)_expungeDelay << 10)));
  s_logger.info("Found " + vms.size() + " vms to expunge.");
  for (  UserVmVO vm : vms) {
    boolean deleteRules=true;
    String privateIpAddress=vm.getPrivateIpAddress();
    long vmId=vm.getId();
    releaseGuestIpAddress(vm);
    vm.setGuestNetmask(null);
    vm.setGuestMacAddress(null);
    if (!_vmDao.updateIf(vm,VirtualMachine.Event.ExpungeOperation,null)) {
      s_logger.info("vm " + vmId + " is skipped because it is no longer in Destroyed state");
      continue;
    }
    if (VirtualMachineName.isValidRouterName(vm.getHostName()) && !vm.getState().equals(State.Running)) {
      deleteRules=false;
    }
  }
  List<VolumeVO> destroyedVolumes=_volsDao.findByDetachedDestroyed();
  s_logger.info("Found " + destroyedVolumes.size() + " detached volumes to expunge.");
  _storageMgr.destroy(null,destroyedVolumes);
}
