{
  Long vmId=cmd.getId();
  Long svcOffId=cmd.getServiceOfferingId();
  Account caller=UserContext.current().getCaller();
  UserVmVO vmInstance=_vmDao.findById(vmId);
  if (vmInstance == null) {
    throw new InvalidParameterValueException("unable to find a virtual machine with id " + vmId);
  }
  _accountMgr.checkAccess(caller,null,true,vmInstance);
  _itMgr.checkIfCanUpgrade(vmInstance,svcOffId);
  List<VMSnapshotVO> vmSnapshots=_vmSnapshotDao.findByVm(vmId);
  for (  VMSnapshotVO vmSnapshotVO : vmSnapshots) {
    if (vmSnapshotVO.getType() == VMSnapshot.Type.DiskAndMemory) {
      if (!_vmSnapshotMgr.deleteAllVMSnapshots(vmId,VMSnapshot.Type.DiskAndMemory)) {
        String errMsg="Failed to remove VM snapshot during upgrading, snapshot id " + vmSnapshotVO.getId();
        s_logger.debug(errMsg);
        throw new CloudRuntimeException(errMsg);
      }
    }
  }
  _itMgr.upgradeVmDb(vmId,svcOffId);
  return _vmDao.findById(vmInstance.getId());
}
