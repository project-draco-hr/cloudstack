{
  Account oldOwner=UserContext.current().getCaller();
  Account newOwner=_accountService.getAccount(cmd.getAccountId());
  if (newOwner == null) {
    throw new InvalidParameterValueException("Unable to find account " + newOwner + " in domain "+ oldOwner.getDomainId());
  }
  UserVmVO vm=_vmDao.findById(cmd.getHostId());
  vm.setAccountId(newOwner.getAccountId());
  DomainVO domain=_domainDao.findById(oldOwner.getDomainId());
  _accountMgr.checkAccess(oldOwner,domain);
  _accountMgr.checkAccess(newOwner,domain);
  if (_accountMgr.resourceLimitExceeded(newOwner,ResourceType.user_vm)) {
    ResourceAllocationException rae=new ResourceAllocationException("Maximum number of virtual machines for account: " + newOwner.getAccountName() + " has been exceeded.");
    rae.setResourceType("vm");
    throw rae;
  }
  this.stopVirtualMachine(cmd.getHostId(),true);
  vm.setAccountId(newOwner.getId());
  _vmDao.persist(vm);
  this.startVirtualMachine(cmd.getHostId());
  return vm;
}
