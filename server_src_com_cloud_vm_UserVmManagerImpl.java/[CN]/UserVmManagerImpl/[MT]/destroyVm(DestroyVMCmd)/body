{
  CallContext ctx=CallContext.current();
  long vmId=cmd.getId();
  boolean expunge=cmd.getExpunge();
  if (!_accountMgr.isAdmin(ctx.getCallingAccount().getType()) && expunge) {
    throw new PermissionDeniedException("Parameter " + ApiConstants.EXPUNGE + " can be passed by Admin only");
  }
  UserVm destroyedVm=destroyVm(vmId);
  if (expunge) {
    UserVmVO vm=_vmDao.findById(vmId);
    if (!expunge(vm,ctx.getCallingUserId(),ctx.getCallingAccount())) {
      throw new CloudRuntimeException("Failed to expunge vm " + destroyedVm);
    }
  }
  return destroyedVm;
}
