{
  String[] results=new String[cmd.getRules().length];
  ExecutionResult callResult;
  String routerIp=cmd.getAccessDetail(NetworkElementCommand.ROUTER_IP);
  String egressDefault=cmd.getAccessDetail(NetworkElementCommand.FIREWALL_EGRESS_DEFAULT);
  FirewallRuleTO[] allrules=cmd.getRules();
  FirewallRule.TrafficType trafficType=allrules[0].getTrafficType();
  if (routerIp == null) {
    return new SetFirewallRulesAnswer(cmd,false,results);
  }
  String[][] rules=cmd.generateFwRules();
  String args=" -F";
  if (trafficType == FirewallRule.TrafficType.Egress) {
    args+=" -E";
    if (egressDefault.equals("true")) {
      args+=" -P 1";
    }
 else     if (egressDefault.equals("System")) {
      args+=" -P 2";
    }
 else {
      args+=" -P 0";
    }
  }
  StringBuilder sb=new StringBuilder();
  String[] fwRules=rules[0];
  if (fwRules.length > 0) {
    for (int i=0; i < fwRules.length; i++) {
      sb.append(fwRules[i]).append(',');
    }
    args+=" -a " + sb.toString();
  }
  if (trafficType == FirewallRule.TrafficType.Egress) {
    callResult=executeInVR(routerIp,"firewall_egress.sh",args);
  }
 else {
    callResult=executeInVR(routerIp,"firewall_ingress.sh",args);
  }
  if (!callResult.isSuccess()) {
    for (int i=0; i < results.length; i++) {
      results[i]="Failed: " + callResult.getDetails();
    }
    return new SetFirewallRulesAnswer(cmd,false,results);
  }
  return new SetFirewallRulesAnswer(cmd,true,results);
}
