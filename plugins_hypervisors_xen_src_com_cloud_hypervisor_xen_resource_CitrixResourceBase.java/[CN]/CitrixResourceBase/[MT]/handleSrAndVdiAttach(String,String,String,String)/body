{
  VDI vdi=null;
  Connection conn=getConnection();
  Boolean[] created={false};
  SR sr=getIscsiSR(conn,iqn,storageHostName,iqn,chapInitiatorName,chapInitiatorPassword,created);
  if (created[0]) {
    VDI.Record vdir=new VDI.Record();
    vdir.nameLabel=iqn;
    vdir.SR=sr;
    vdir.type=Types.VdiType.USER;
    long totalSpace=sr.getPhysicalSize(conn);
    long unavailableSpace=sr.getPhysicalUtilisation(conn);
    vdir.virtualSize=totalSpace - unavailableSpace;
    if (vdir.virtualSize < 0) {
      throw new CloudRuntimeException("VDI virtual size cannot be less than 0.");
    }
    long maxNumberOfTries=(totalSpace / unavailableSpace >= 1) ? (totalSpace / unavailableSpace) : 1;
    long tryNumber=0;
    while (tryNumber <= maxNumberOfTries) {
      try {
        vdi=VDI.create(conn,vdir);
        break;
      }
 catch (      Exception ex) {
        tryNumber++;
        vdir.virtualSize-=unavailableSpace;
      }
    }
  }
 else {
    vdi=sr.getVDIs(conn).iterator().next();
  }
  return vdi;
}
