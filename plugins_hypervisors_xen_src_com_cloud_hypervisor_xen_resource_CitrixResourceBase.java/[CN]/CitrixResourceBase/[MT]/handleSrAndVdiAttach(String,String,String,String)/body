{
  VDI vdi=null;
  Connection conn=getConnection();
  Boolean[] created={false};
  SR sr=getIscsiSR(conn,iqn,storageHostName,iqn,chapInitiatorName,chapInitiatorPassword,created);
  if (created[0]) {
    VDI.Record vdir=new VDI.Record();
    vdir.nameLabel=iqn;
    vdir.SR=sr;
    vdir.type=Types.VdiType.USER;
    vdir.virtualSize=sr.getPhysicalSize(conn) - sr.getPhysicalUtilisation(conn) - getMetadata(sr.getPhysicalSize(conn));
    if (vdir.virtualSize < 0) {
      throw new Exception("VDI virtual size cannot be less than 0.");
    }
    vdi=VDI.create(conn,vdir);
  }
 else {
    vdi=sr.getVDIs(conn).iterator().next();
  }
  return vdi;
}
