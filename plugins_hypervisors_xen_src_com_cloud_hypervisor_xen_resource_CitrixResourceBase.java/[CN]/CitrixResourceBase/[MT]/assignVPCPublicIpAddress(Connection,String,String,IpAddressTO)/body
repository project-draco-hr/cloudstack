{
  try {
    VM router=getVM(conn,vmName);
    VIF correctVif=getVifByMac(conn,router,ip.getVifMacAddress());
    if (correctVif == null) {
      if (ip.isAdd()) {
        throw new InternalErrorException("Failed to find DomR VIF to associate IP with.");
      }
 else {
        s_logger.debug("VIF to deassociate IP with does not exist, return success");
        return;
      }
    }
    String args="";
    String snatArgs="";
    if (ip.isAdd()) {
      args+=" -A ";
      snatArgs+=" -A ";
    }
 else {
      args+=" -D ";
      snatArgs+=" -D ";
    }
    args+=" -l ";
    args+=ip.getPublicIp();
    args+=" -c ";
    args+="eth" + correctVif.getDevice(conn);
    args+=" -g ";
    args+=ip.getVlanGateway();
    args+=" -m ";
    args+=Long.toString(NetUtils.getCidrSize(ip.getVlanNetmask()));
    args+=" -n ";
    args+=NetUtils.getSubNet(ip.getPublicIp(),ip.getVlanNetmask());
    ExecutionResult result=executeInVR(routerIp,"vpc_ipassoc.sh",args);
    if (!result.isSuccess()) {
      throw new InternalErrorException("Xen plugin \"vpc_ipassoc\" failed." + result.getDetails());
    }
    if (ip.isSourceNat()) {
      snatArgs+=" -l " + ip.getPublicIp();
      snatArgs+=" -c " + "eth" + correctVif.getDevice(conn);
      result=executeInVR(routerIp,"vpc_privateGateway.sh",snatArgs);
      if (!result.isSuccess()) {
        throw new InternalErrorException("Xen plugin \"vpc_privateGateway\" failed." + result.getDetails());
      }
    }
  }
 catch (  Exception e) {
    String msg="Unable to assign public IP address due to " + e.toString();
    s_logger.warn(msg,e);
    throw new Exception(msg);
  }
}
