{
  String[] results=new String[cmd.getRules().length];
  String callResult;
  Connection conn=getConnection();
  String routerName=cmd.getAccessDetail(NetworkElementCommand.ROUTER_NAME);
  String privateGw=cmd.getAccessDetail(NetworkElementCommand.VPC_PRIVATE_GATEWAY);
  try {
    VM router=getVM(conn,routerName);
    String[][] rules=cmd.generateFwRules();
    StringBuilder sb=new StringBuilder();
    String[] aclRules=rules[0];
    for (int i=0; i < aclRules.length; i++) {
      sb.append(aclRules[i]).append(',');
    }
    if (privateGw != null) {
      s_logger.debug("Private gateway configuration is set");
    }
    NicTO nic=cmd.getNic();
    VIF vif=getVifByMac(conn,router,nic.getMac());
    if (privateGw != null) {
      s_logger.debug("Private gateway configuration is set");
      String args="";
      args+=" -d " + "eth" + vif.getDevice(conn);
      args+=" -a " + sb.toString();
      callResult=routerProxy("vpc_privategw_acl.sh",cmd.getAccessDetail(NetworkElementCommand.ROUTER_IP),args);
      if (callResult == null || callResult.isEmpty()) {
        for (int i=0; i < results.length; i++) {
          results[i]="Failed";
        }
        return new SetNetworkACLAnswer(cmd,false,results);
      }
    }
 else {
      String args="";
      args+=" -d " + "eth" + vif.getDevice(conn);
      args+=" -i " + nic.getIp();
      args+=" -m " + Long.toString(NetUtils.getCidrSize(nic.getNetmask()));
      args+=" -a " + sb.toString();
      callResult=routerProxy("vpc_acl.sh",cmd.getAccessDetail(NetworkElementCommand.ROUTER_IP),args);
      if (callResult == null || callResult.isEmpty()) {
        for (int i=0; i < results.length; i++) {
          results[i]="Failed";
        }
        return new SetNetworkACLAnswer(cmd,false,results);
      }
    }
    return new SetNetworkACLAnswer(cmd,true,results);
  }
 catch (  Exception e) {
    String msg="SetNetworkACL failed due to " + e.toString();
    s_logger.error(msg,e);
    return new SetNetworkACLAnswer(cmd,false,results);
  }
}
