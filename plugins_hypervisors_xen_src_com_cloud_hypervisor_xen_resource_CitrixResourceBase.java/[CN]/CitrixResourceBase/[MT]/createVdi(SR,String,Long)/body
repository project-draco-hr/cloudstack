{
  VDI vdi=null;
  Connection conn=getConnection();
  VDI.Record vdir=new VDI.Record();
  vdir.nameLabel=vdiNameLabel;
  vdir.SR=sr;
  vdir.type=Types.VdiType.USER;
  long totalSrSpace=sr.getPhysicalSize(conn);
  long unavailableSrSpace=sr.getPhysicalUtilisation(conn);
  long availableSrSpace=totalSrSpace - unavailableSrSpace;
  if (availableSrSpace < volumeSize) {
    throw new CloudRuntimeException("Available space for SR cannot be less than " + volumeSize + ".");
  }
  vdir.virtualSize=volumeSize;
  long maxNumberOfTries=(totalSrSpace / unavailableSrSpace >= 1) ? (totalSrSpace / unavailableSrSpace) : 1;
  long tryNumber=0;
  while (tryNumber <= maxNumberOfTries) {
    try {
      vdi=VDI.create(conn,vdir);
      break;
    }
 catch (    Exception ex) {
      tryNumber++;
      vdir.virtualSize-=unavailableSrSpace;
    }
  }
  return vdi;
}
