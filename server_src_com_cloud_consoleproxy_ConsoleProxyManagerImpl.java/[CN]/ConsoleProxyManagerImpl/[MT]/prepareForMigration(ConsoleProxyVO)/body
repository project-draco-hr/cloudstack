{
  VMTemplateVO template=_templateDao.findById(proxy.getTemplateId());
  long routerId=proxy.getId();
  boolean mirroredVols=proxy.isMirroredVols();
  DataCenterVO dc=_dcDao.findById(proxy.getDataCenterId());
  HostPodVO pod=_podDao.findById(proxy.getPodId());
  List<StoragePoolVO> sps=_storageMgr.getStoragePoolsForVm(proxy.getId());
  StoragePoolVO sp=sps.get(0);
  List<VolumeVO> vols=_volsDao.findCreatedByInstance(routerId);
  String[] storageIps=new String[2];
  VolumeVO vol=vols.get(0);
  storageIps[0]=vol.getHostIp();
  if (mirroredVols && (vols.size() == 2)) {
    storageIps[1]=vols.get(1).getHostIp();
  }
  PrepareForMigrationCommand cmd=new PrepareForMigrationCommand(proxy.getName(),null,storageIps,vols,mirroredVols);
  HostVO routingHost=null;
  HashSet<Host> avoid=new HashSet<Host>();
  HostVO fromHost=_hostDao.findById(proxy.getHostId());
  if (fromHost.getClusterId() == null) {
    s_logger.debug("The host is not in a cluster");
    return null;
  }
  avoid.add(fromHost);
  while ((routingHost=(HostVO)_agentMgr.findHost(Host.Type.Routing,dc,pod,sp,_serviceOffering,template,proxy,fromHost,avoid)) != null) {
    avoid.add(routingHost);
    if (s_logger.isDebugEnabled()) {
      s_logger.debug("Trying to migrate router to host " + routingHost.getName());
    }
    if (!_storageMgr.share(proxy,vols,routingHost,false)) {
      s_logger.warn("Can not share " + proxy.getName());
      throw new StorageUnavailableException(vol.getPoolId());
    }
    Answer answer=_agentMgr.easySend(routingHost.getId(),cmd);
    if (answer != null && answer.getResult()) {
      return routingHost;
    }
    _storageMgr.unshare(proxy,vols,routingHost);
  }
  return null;
}
