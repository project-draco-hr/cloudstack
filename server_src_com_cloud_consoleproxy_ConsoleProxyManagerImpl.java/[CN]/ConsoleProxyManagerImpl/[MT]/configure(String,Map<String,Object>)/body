{
  if (s_logger.isInfoEnabled())   s_logger.info("Start configuring console proxy manager : " + name);
  _name=name;
  ComponentLocator locator=ComponentLocator.getCurrentLocator();
  ConfigurationDao configDao=locator.getDao(ConfigurationDao.class);
  if (configDao == null) {
    throw new ConfigurationException("Unable to get the configuration dao.");
  }
  Map<String,String> configs=configDao.getConfiguration("management-server",params);
  _proxyRamSize=NumbersUtil.parseInt(configs.get("consoleproxy.ram.size"),DEFAULT_PROXY_VM_RAMSIZE);
  String value=configs.get("start.retry");
  _find_host_retry=NumbersUtil.parseInt(value,DEFAULT_FIND_HOST_RETRY_COUNT);
  value=configs.get("consoleproxy.cmd.port");
  _proxyCmdPort=NumbersUtil.parseInt(value,DEFAULT_PROXY_CMD_PORT);
  value=configs.get("consoleproxy.sslEnabled");
  if (value != null && value.equalsIgnoreCase("true"))   _sslEnabled=true;
  value=configs.get("consoleproxy.capacityscan.interval");
  _capacityScanInterval=NumbersUtil.parseLong(value,DEFAULT_CAPACITY_SCAN_INTERVAL);
  _capacityPerProxy=NumbersUtil.parseInt(configs.get("consoleproxy.session.max"),DEFAULT_PROXY_CAPACITY);
  _standbyCapacity=NumbersUtil.parseInt(configs.get("consoleproxy.capacity.standby"),DEFAULT_STANDBY_CAPACITY);
  _proxySessionTimeoutValue=NumbersUtil.parseInt(configs.get("consoleproxy.session.timeout"),DEFAULT_PROXY_SESSION_TIMEOUT);
  value=configs.get("consoleproxy.port");
  if (value != null)   _consoleProxyPort=NumbersUtil.parseInt(value,ConsoleProxyManager.DEFAULT_PROXY_VNC_PORT);
  value=configs.get("consoleproxy.url.port");
  if (value != null)   _consoleProxyUrlPort=NumbersUtil.parseInt(value,ConsoleProxyManager.DEFAULT_PROXY_URL_PORT);
  value=configs.get("system.vm.use.local.storage");
  if (value != null && value.equalsIgnoreCase("true"))   _use_lvm=true;
  value=configs.get("secondary.storage.vm");
  if (value != null && value.equalsIgnoreCase("true"))   _use_storage_vm=true;
  if (s_logger.isInfoEnabled()) {
    s_logger.info("Console proxy max session soft limit : " + _capacityPerProxy);
    s_logger.info("Console proxy standby capacity : " + _standbyCapacity);
  }
  _domain=configs.get("domain");
  if (_domain == null) {
    _domain="foo.com";
  }
  _instance=configs.get("instance.name");
  if (_instance == null) {
    _instance="DEFAULT";
  }
  value=(String)params.get("ssh.sleep");
  _ssh_sleep=NumbersUtil.parseInt(value,5) * 1000;
  value=(String)params.get("ssh.retry");
  _ssh_retry=NumbersUtil.parseInt(value,3);
  Map<String,String> agentMgrConfigs=configDao.getConfiguration("AgentManager",params);
  _mgmt_host=agentMgrConfigs.get("host");
  if (_mgmt_host == null) {
    s_logger.warn("Critical warning! Please configure your management server host address right after you have started your management server and then restart it, otherwise you won't be able to do console access");
  }
  value=agentMgrConfigs.get("port");
  _mgmt_port=NumbersUtil.parseInt(value,8250);
  _consoleProxyDao=locator.getDao(ConsoleProxyDao.class);
  if (_consoleProxyDao == null) {
    throw new ConfigurationException("Unable to get " + ConsoleProxyDao.class.getName());
  }
  _consoleProxyAllocators=locator.getAdapters(ConsoleProxyAllocator.class);
  if (_consoleProxyAllocators == null || !_consoleProxyAllocators.isSet()) {
    throw new ConfigurationException("Unable to get proxy allocators");
  }
  _dcDao=locator.getDao(DataCenterDao.class);
  if (_dcDao == null) {
    throw new ConfigurationException("Unable to get " + DataCenterDao.class.getName());
  }
  _templateDao=locator.getDao(VMTemplateDao.class);
  if (_templateDao == null) {
    throw new ConfigurationException("Unable to get " + VMTemplateDao.class.getName());
  }
  _ipAddressDao=locator.getDao(IPAddressDao.class);
  if (_ipAddressDao == null) {
    throw new ConfigurationException("Unable to get " + IPAddressDao.class.getName());
  }
  _volsDao=locator.getDao(VolumeDao.class);
  if (_volsDao == null) {
    throw new ConfigurationException("Unable to get " + VolumeDao.class.getName());
  }
  _podDao=locator.getDao(HostPodDao.class);
  if (_podDao == null) {
    throw new ConfigurationException("Unable to get " + HostPodDao.class.getName());
  }
  _hostDao=locator.getDao(HostDao.class);
  if (_hostDao == null) {
    throw new ConfigurationException("Unable to get " + HostDao.class.getName());
  }
  _eventDao=locator.getDao(EventDao.class);
  if (_eventDao == null) {
    throw new ConfigurationException("Unable to get " + EventDao.class.getName());
  }
  _storagePoolDao=locator.getDao(StoragePoolDao.class);
  if (_storagePoolDao == null) {
    throw new ConfigurationException("Unable to find " + StoragePoolDao.class);
  }
  _configDao=locator.getDao(ConfigurationDao.class);
  if (_configDao == null) {
    throw new ConfigurationException("Unable to find " + ConfigurationDao.class);
  }
  _vmTemplateHostDao=locator.getDao(VMTemplateHostDao.class);
  if (_vmTemplateHostDao == null) {
    throw new ConfigurationException("Unable to get " + VMTemplateHostDao.class.getName());
  }
  _instanceDao=locator.getDao(VMInstanceDao.class);
  if (_instanceDao == null)   throw new ConfigurationException("Unable to get " + VMInstanceDao.class.getName());
  _capacityDao=locator.getDao(CapacityDao.class);
  if (_capacityDao == null) {
    throw new ConfigurationException("Unable to get " + CapacityDao.class.getName());
  }
  _haDao=locator.getDao(HighAvailabilityDao.class);
  if (_haDao == null) {
    throw new ConfigurationException("Unable to get " + HighAvailabilityDao.class.getName());
  }
  _accountDao=locator.getDao(AccountDao.class);
  if (_accountDao == null) {
    throw new ConfigurationException("Unable to get " + AccountDao.class.getName());
  }
  _vlanDao=locator.getDao(VlanDao.class);
  if (_vlanDao == null) {
    throw new ConfigurationException("Unable to get " + VlanDao.class.getName());
  }
  _agentMgr=locator.getManager(AgentManager.class);
  if (_agentMgr == null) {
    throw new ConfigurationException("Unable to get " + AgentManager.class.getName());
  }
  _networkMgr=locator.getManager(NetworkManager.class);
  if (_networkMgr == null) {
    throw new ConfigurationException("Unable to get " + NetworkManager.class.getName());
  }
  _listener=new ConsoleProxyListener(this);
  _agentMgr.registerForHostEvents(_listener,true,true,false);
  _haMgr=locator.getManager(HighAvailabilityManager.class);
  if (_haMgr == null) {
    throw new ConfigurationException("Unable to get " + HighAvailabilityManager.class.getName());
  }
  _storageMgr=locator.getManager(StorageManager.class);
  if (_storageMgr == null) {
    throw new ConfigurationException("Unable to get " + StorageManager.class.getName());
  }
  _asyncMgr=locator.getManager(AsyncJobManager.class);
  if (_asyncMgr == null) {
    throw new ConfigurationException("Unable to get " + AsyncJobManager.class.getName());
  }
  Adapters<IpAddrAllocator> ipAllocators=locator.getAdapters(IpAddrAllocator.class);
  if (ipAllocators != null && ipAllocators.isSet()) {
    Enumeration<IpAddrAllocator> it=ipAllocators.enumeration();
    _IpAllocator=it.nextElement();
  }
  HighAvailabilityManager haMgr=locator.getManager(HighAvailabilityManager.class);
  if (haMgr != null) {
    haMgr.registerHandler(VirtualMachine.Type.ConsoleProxy,this);
  }
  boolean useLocalStorage=Boolean.parseBoolean((String)params.get(Config.SystemVMUseLocalStorage.key()));
  _serviceOffering=new ServiceOfferingVO("Fake Offering For DomP",1,_proxyRamSize,0,0,0,false,null,GuestIpType.Virtualized,useLocalStorage,true,null);
  _serviceOffering.setUniqueName("Cloud.com-ConsoleProxy");
  _serviceOffering=_offeringDao.persistSystemServiceOffering(_serviceOffering);
  _template=_templateDao.findConsoleProxyTemplate();
  if (_template == null) {
    throw new ConfigurationException("Unable to find the template for console proxy VMs");
  }
  _capacityScanScheduler.scheduleAtFixedRate(getCapacityScanTask(),STARTUP_DELAY,_capacityScanInterval,TimeUnit.MILLISECONDS);
  if (s_logger.isInfoEnabled())   s_logger.info("Console Proxy Manager is configured.");
  return true;
}
