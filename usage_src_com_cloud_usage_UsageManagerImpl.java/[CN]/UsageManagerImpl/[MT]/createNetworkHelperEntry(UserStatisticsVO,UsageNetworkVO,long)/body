{
  long currentAccountedBytesSent=0L;
  long currentAccountedBytesReceived=0L;
  if (usageNetworkStats != null) {
    if (s_logger.isDebugEnabled()) {
      s_logger.debug("getting current accounted bytes for... accountId: " + usageNetworkStats.getAccountId() + " in zone: "+ userStat.getDataCenterId()+ "; cbr: "+ usageNetworkStats.getCurrentBytesReceived()+ "; cbs: "+ usageNetworkStats.getCurrentBytesSent()+ "; nbr: "+ usageNetworkStats.getNetBytesReceived()+ "; nbs: "+ usageNetworkStats.getNetBytesSent());
    }
    currentAccountedBytesSent=(usageNetworkStats.getCurrentBytesSent() + usageNetworkStats.getNetBytesSent());
    currentAccountedBytesReceived=(usageNetworkStats.getCurrentBytesReceived() + usageNetworkStats.getNetBytesReceived());
  }
  long bytesSent=(userStat.getCurrentBytesSent() + userStat.getNetBytesSent()) - currentAccountedBytesSent;
  long bytesReceived=(userStat.getCurrentBytesReceived() + userStat.getNetBytesReceived()) - currentAccountedBytesReceived;
  if (bytesSent < 0) {
    s_logger.warn("Calculated negative value for bytes sent: " + bytesSent + ", user stats say: "+ (userStat.getCurrentBytesSent() + userStat.getNetBytesSent())+ ", previous network usage was: "+ currentAccountedBytesSent);
    bytesSent=0;
  }
  if (bytesReceived < 0) {
    s_logger.warn("Calculated negative value for bytes received: " + bytesReceived + ", user stats say: "+ (userStat.getCurrentBytesReceived() + userStat.getNetBytesReceived())+ ", previous network usage was: "+ currentAccountedBytesReceived);
    bytesReceived=0;
  }
  long hostId=0;
  if (userStat.getDeviceId() != null) {
    hostId=userStat.getDeviceId();
  }
  UsageNetworkVO usageNetworkVO=new UsageNetworkVO(userStat.getAccountId(),userStat.getDataCenterId(),hostId,userStat.getDeviceType(),userStat.getNetworkId(),bytesSent,bytesReceived,userStat.getNetBytesReceived(),userStat.getNetBytesSent(),userStat.getCurrentBytesReceived(),userStat.getCurrentBytesSent(),timestamp);
  if (s_logger.isDebugEnabled()) {
    s_logger.debug("creating networkHelperEntry... accountId: " + userStat.getAccountId() + " in zone: "+ userStat.getDataCenterId()+ "; cbr: "+ userStat.getCurrentBytesReceived()+ "; cbs: "+ userStat.getCurrentBytesSent()+ "; nbr: "+ userStat.getNetBytesReceived()+ "; nbs: "+ userStat.getNetBytesSent()+ "; curABS: "+ currentAccountedBytesSent+ "; curABR: "+ currentAccountedBytesReceived+ "; ubs: "+ bytesSent+ "; ubr: "+ bytesReceived);
  }
  m_usageNetworkDao.persist(usageNetworkVO);
}
