{
  if (vmMetadatum == null || vmMetadatum.isEmpty()) {
    return;
  }
  for (  final Map.Entry<String,String> entry : vmMetadatum.entrySet()) {
    final String name=entry.getKey();
    final String platform=entry.getValue();
    if (platform == null || platform.isEmpty()) {
      continue;
    }
    final VMInstanceVO vm=_vmDao.findVMByInstanceName(name);
    if (vm != null && vm.getType() == VirtualMachine.Type.User) {
      boolean changed=false;
      final UserVmVO userVm=_userVmDao.findById(vm.getId());
      _userVmDao.loadDetails(userVm);
      if (userVm.details.containsKey("timeoffset")) {
        userVm.details.remove("timeoffset");
        changed=true;
      }
      if (!userVm.details.containsKey("platform") || !userVm.details.get("platform").equals(platform)) {
        userVm.setDetail("platform",platform);
        changed=true;
      }
      String pvdriver="xenserver56";
      if (platform.contains("device_id")) {
        pvdriver="xenserver61";
      }
      if (!userVm.details.containsKey("hypervisortoolsversion") || !userVm.details.get("hypervisortoolsversion").equals(pvdriver)) {
        userVm.setDetail("hypervisortoolsversion",pvdriver);
        changed=true;
      }
      if (changed) {
        _userVmDao.saveDetails(userVm);
      }
    }
  }
}
