{
  long stallThresholdInMs=VmJobStateReportInterval.value() + (VmJobStateReportInterval.value() >> 1);
  Date cutTime=new Date(DateUtil.currentGMTTime().getTime() - stallThresholdInMs);
  List<Long> mostlikelyStoppedVMs=listStalledVMInTransitionStateOnUpHost(hostId,cutTime);
  for (  Long vmId : mostlikelyStoppedVMs) {
    VMInstanceVO vm=_vmDao.findById(vmId);
    assert(vm != null);
    handlePowerOffReportWithNoPendingJobsOnVM(vm);
  }
  List<Long> vmsWithRecentReport=listVMInTransitionStateWithRecentReportOnUpHost(hostId,cutTime);
  for (  Long vmId : vmsWithRecentReport) {
    VMInstanceVO vm=_vmDao.findById(vmId);
    assert(vm != null);
    if (vm.getPowerState() == PowerState.PowerOn)     handlePowerOnReportWithNoPendingJobsOnVM(vm);
 else     handlePowerOffReportWithNoPendingJobsOnVM(vm);
  }
}
