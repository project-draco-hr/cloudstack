{
  final CallContext context=CallContext.current();
  final User user=context.getCallingUser();
  final Account account=context.getCallingAccount();
  List<VmWorkJobVO> pendingWorkJobs=_workJobDao.listPendingWorkJobs(VirtualMachine.Type.Instance,vm.getId(),VmWorkRemoveVmFromNetwork.class.getName());
  VmWorkJobVO workJob=null;
  if (pendingWorkJobs != null && pendingWorkJobs.size() > 0) {
    assert(pendingWorkJobs.size() == 1);
    workJob=pendingWorkJobs.get(0);
  }
 else {
    workJob=new VmWorkJobVO(context.getContextId());
    workJob.setDispatcher(VmWorkConstants.VM_WORK_JOB_DISPATCHER);
    workJob.setCmd(VmWorkRemoveVmFromNetwork.class.getName());
    workJob.setAccountId(account.getId());
    workJob.setUserId(user.getId());
    workJob.setVmType(VirtualMachine.Type.Instance);
    workJob.setVmInstanceId(vm.getId());
    workJob.setRelated(AsyncJobExecutionContext.getOriginJobId());
    VmWorkRemoveVmFromNetwork workInfo=new VmWorkRemoveVmFromNetwork(user.getId(),account.getId(),vm.getId(),VirtualMachineManagerImpl.VM_WORK_JOB_HANDLER,network,broadcastUri);
    workJob.setCmdInfo(VmWorkSerializer.serialize(workInfo));
    _jobMgr.submitAsyncJob(workJob,VmWorkConstants.VM_WORK_QUEUE,vm.getId());
  }
  AsyncJobExecutionContext.getCurrentExecutionContext().joinJob(workJob.getId());
  return new VmJobVirtualMachineOutcome(workJob,vm.getId());
}
