{
  CallContext cctx=CallContext.current();
  VMInstanceVO vmVO=_vmDao.findById(vm.getId());
  NetworkVO network=_networkDao.findById(nic.getNetworkId());
  ReservationContext context=new ReservationContextImpl(null,null,cctx.getCallingUser(),cctx.getCallingAccount());
  VirtualMachineProfileImpl vmProfile=new VirtualMachineProfileImpl(vmVO,null,null,null,null);
  DataCenter dc=_entityMgr.findById(DataCenter.class,network.getDataCenterId());
  Host host=_hostDao.findById(vm.getHostId());
  DeployDestination dest=new DeployDestination(dc,null,null,host);
  HypervisorGuru hvGuru=_hvGuruMgr.getGuru(vmProfile.getVirtualMachine().getHypervisorType());
  VirtualMachineTO vmTO=hvGuru.implement(vmProfile);
  NicProfile nicProfile=new NicProfile(nic,network,nic.getBroadcastUri(),nic.getIsolationUri(),_networkModel.getNetworkRate(network.getId(),vm.getId()),_networkModel.isSecurityGroupSupportedInNetwork(network),_networkModel.getNetworkTag(vmProfile.getVirtualMachine().getHypervisorType(),network));
  if (vm.getState() == State.Running) {
    NicTO nicTO=toNicTO(nicProfile,vmProfile.getVirtualMachine().getHypervisorType());
    s_logger.debug("Un-plugging nic " + nic + " for vm "+ vm+ " from network "+ network);
    boolean result=unplugNic(network,nicTO,vmTO,context,dest);
    if (result) {
      s_logger.debug("Nic is unplugged successfully for vm " + vm + " in network "+ network);
      long isDefault=(nic.isDefaultNic()) ? 1 : 0;
      UsageEventUtils.publishUsageEvent(EventTypes.EVENT_NETWORK_OFFERING_REMOVE,vm.getAccountId(),vm.getDataCenterId(),vm.getId(),Long.toString(nic.getId()),network.getNetworkOfferingId(),null,isDefault,VirtualMachine.class.getName(),vm.getUuid(),vm.isDisplay());
    }
 else {
      s_logger.warn("Failed to unplug nic for the vm " + vm + " from network "+ network);
      return false;
    }
  }
 else   if (vm.getState() != State.Stopped) {
    s_logger.warn("Unable to remove vm " + vm + " from network  "+ network);
    throw new ResourceUnavailableException("Unable to remove vm " + vm + " from network, is not in the right state",DataCenter.class,vm.getDataCenterId());
  }
  _networkMgr.releaseNic(vmProfile,nic);
  s_logger.debug("Successfully released nic " + nic + "for vm "+ vm);
  _networkMgr.removeNic(vmProfile,nic);
  _nicsDao.expunge(nic.getId());
  return true;
}
