{
  VMInstanceVO vm=_vmDao.findByUuid(vmUuid);
  Long srchostId=vm.getHostId() != null ? vm.getHostId() : vm.getLastHostId();
  HostVO srcHost=_hostDao.findById(srchostId);
  Long srcClusterId=srcHost.getClusterId();
  try {
    stateTransitTo(vm,VirtualMachine.Event.StorageMigrationRequested,null);
  }
 catch (  NoTransitionException e) {
    s_logger.debug("Unable to migrate vm: " + e.toString());
    throw new CloudRuntimeException("Unable to migrate vm: " + e.toString());
  }
  VirtualMachineProfile profile=new VirtualMachineProfileImpl(vm);
  boolean migrationResult=false;
  try {
    migrationResult=volumeMgr.storageMigration(profile,destPool);
    if (migrationResult) {
      if (!vm.getPodIdToDeployIn().equals(destPool.getPodId())) {
        DataCenterDeployment plan=new DataCenterDeployment(vm.getDataCenterId(),destPool.getPodId(),null,null,null,null);
        VirtualMachineProfileImpl vmProfile=new VirtualMachineProfileImpl(vm,null,null,null,null);
        _networkMgr.reallocate(vmProfile,plan);
      }
      vm.setLastHostId(null);
      vm.setPodIdToDeployIn(destPool.getPodId());
      if (vm.getHypervisorType().equals(HypervisorType.VMware)) {
        Long destClusterId=destPool.getClusterId();
        if (srcClusterId != null && destClusterId != null && srcClusterId != destClusterId) {
          String srcDcName=_clusterDetailsDao.getVmwareDcName(srcClusterId);
          String destDcName=_clusterDetailsDao.getVmwareDcName(destClusterId);
          if (srcDcName != null && destDcName != null && !srcDcName.equals(destDcName)) {
            s_logger.debug("Since VM's storage was successfully migrated across VMware Datacenters, unregistering VM: " + vm.getInstanceName() + " from source host: "+ srcHost.getId());
            UnregisterVMCommand uvc=new UnregisterVMCommand(vm.getInstanceName());
            uvc.setCleanupVmFiles(true);
            try {
              _agentMgr.send(srcHost.getId(),uvc);
            }
 catch (            Exception e) {
              throw new CloudRuntimeException("Failed to unregister VM: " + vm.getInstanceName() + " from source host: "+ srcHost.getId()+ " after successfully migrating VM's storage across VMware Datacenters");
            }
          }
        }
      }
    }
 else {
      s_logger.debug("Storage migration failed");
    }
  }
 catch (  ConcurrentOperationException e) {
    s_logger.debug("Failed to migration: " + e.toString());
    throw new CloudRuntimeException("Failed to migration: " + e.toString());
  }
catch (  InsufficientVirtualNetworkCapacityException e) {
    s_logger.debug("Failed to migration: " + e.toString());
    throw new CloudRuntimeException("Failed to migration: " + e.toString());
  }
catch (  InsufficientAddressCapacityException e) {
    s_logger.debug("Failed to migration: " + e.toString());
    throw new CloudRuntimeException("Failed to migration: " + e.toString());
  }
catch (  InsufficientCapacityException e) {
    s_logger.debug("Failed to migration: " + e.toString());
    throw new CloudRuntimeException("Failed to migration: " + e.toString());
  }
catch (  StorageUnavailableException e) {
    s_logger.debug("Failed to migration: " + e.toString());
    throw new CloudRuntimeException("Failed to migration: " + e.toString());
  }
 finally {
    try {
      stateTransitTo(vm,VirtualMachine.Event.AgentReportStopped,null);
    }
 catch (    NoTransitionException e) {
      s_logger.debug("Failed to change vm state: " + e.toString());
      throw new CloudRuntimeException("Failed to change vm state: " + e.toString());
    }
  }
}
