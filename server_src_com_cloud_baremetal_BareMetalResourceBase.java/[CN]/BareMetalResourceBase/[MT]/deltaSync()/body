{
  final HashMap<String,State> changes=new HashMap<String,State>();
  if (_vmName == null) {
    return null;
  }
  State newState=getVmState();
  if (newState == null) {
    s_logger.warn("Cannot get power state of VM " + _vmName);
    return null;
  }
  final State oldState=removeVmState(_vmName);
  if (oldState == null) {
    changeVmState(_vmName,newState);
    changes.put(_vmName,newState);
  }
 else   if (oldState == State.Starting) {
    if (newState == State.Running) {
      changeVmState(_vmName,newState);
    }
 else     if (newState == State.Stopped) {
      s_logger.debug("Ignoring vm " + _vmName + " because of a lag in starting the vm.");
    }
  }
 else   if (oldState == State.Migrating) {
    s_logger.warn("How can baremetal VM get into migrating state???");
  }
 else   if (oldState == State.Stopping) {
    if (newState == State.Stopped) {
      changeVmState(_vmName,newState);
    }
 else     if (newState == State.Running) {
      s_logger.debug("Ignoring vm " + _vmName + " because of a lag in stopping the vm. ");
    }
  }
 else   if (oldState != newState) {
    changeVmState(_vmName,newState);
    changes.put(_vmName,newState);
  }
  return changes;
}
