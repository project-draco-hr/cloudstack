{
  Transaction txn=Transaction.open(Transaction.USAGE_DB);
  Date recentEventDate=getMostRecentEventDate();
  String sql=COPY_EVENTS;
  if (recentEventDate == null) {
    if (s_logger.isDebugEnabled()) {
      s_logger.debug("no recent event date, copying all events");
    }
    sql=COPY_ALL_EVENTS;
  }
  PreparedStatement pstmt=null;
  try {
    txn.start();
    pstmt=txn.prepareAutoCloseStatement(sql);
    int i=1;
    if (recentEventDate != null) {
      pstmt.setString(i++,DateUtil.getDateDisplayString(TimeZone.getTimeZone("GMT"),recentEventDate));
    }
    pstmt.setString(i,DateUtil.getDateDisplayString(TimeZone.getTimeZone("GMT"),endDate));
    pstmt.executeUpdate();
    txn.commit();
    return findRecentEvents(recentEventDate,endDate);
  }
 catch (  Exception ex) {
    txn.rollback();
    s_logger.error("error copying events from cloud db to usage db",ex);
    throw new UsageServerException(ex.getMessage());
  }
 finally {
    txn.close();
  }
}
