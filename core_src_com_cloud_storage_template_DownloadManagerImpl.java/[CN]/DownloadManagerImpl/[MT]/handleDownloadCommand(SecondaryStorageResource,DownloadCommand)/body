{
  if (cmd instanceof DownloadProgressCommand) {
    return handleDownloadProgressCmd(resource,(DownloadProgressCommand)cmd);
  }
  if (cmd.getUrl() == null) {
    return new DownloadAnswer("Template is corrupted on storage due to an invalid url , cannot download",VMTemplateStorageResourceAssoc.Status.DOWNLOAD_ERROR);
  }
  if (cmd.getName() == null) {
    return new DownloadAnswer("Invalid Name",VMTemplateStorageResourceAssoc.Status.DOWNLOAD_ERROR);
  }
  String installPathPrefix=null;
  installPathPrefix=resource.getRootDir(cmd) + File.separator + _templateDir;
  String user=null;
  String password=null;
  if (cmd.getAuth() != null) {
    user=cmd.getAuth().getUserName();
    password=new String(cmd.getAuth().getPassword());
  }
  long maxDownloadSizeInBytes=(cmd.getMaxDownloadSizeInBytes() == null) ? TemplateDownloader.DEFAULT_MAX_TEMPLATE_SIZE_IN_BYTES : (cmd.getMaxDownloadSizeInBytes());
  String jobId=downloadPublicTemplate(cmd.getId(),cmd.getUrl(),cmd.getName(),cmd.getFormat(),cmd.isHvm(),cmd.getAccountId(),cmd.getDescription(),cmd.getChecksum(),installPathPrefix,user,password,maxDownloadSizeInBytes);
  sleep();
  if (jobId == null) {
    return new DownloadAnswer("Internal Error",VMTemplateStorageResourceAssoc.Status.DOWNLOAD_ERROR);
  }
  return new DownloadAnswer(jobId,getDownloadPct(jobId),getDownloadError(jobId),getDownloadStatus2(jobId),getDownloadLocalPath(jobId),getInstallPath(jobId),getDownloadTemplateSize(jobId),getDownloadTemplateSize(jobId));
}
