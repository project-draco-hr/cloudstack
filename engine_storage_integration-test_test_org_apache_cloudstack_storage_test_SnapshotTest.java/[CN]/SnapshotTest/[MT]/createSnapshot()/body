{
  VolumeInfo vol=createCopyBaseImage();
  SnapshotVO snapshotVO=createSnapshotInDb(vol);
  SnapshotInfo snapshot=this.snapshotFactory.getSnapshot(snapshotVO.getId(),vol.getDataStore());
  SnapshotInfo newSnapshot=null;
  for (  SnapshotStrategy strategy : this.snapshotStrategies) {
    if (strategy.canHandle(snapshot)) {
      newSnapshot=strategy.takeSnapshot(snapshot);
    }
  }
  AssertJUnit.assertNotNull(newSnapshot);
  LocalHostEndpoint ep=new MockLocalHostEndPoint();
  ep.setResource(new MockLocalNfsSecondaryStorageResource());
  Mockito.when(epSelector.select(Matchers.any(DataStore.class))).thenReturn(ep);
  try {
    for (    SnapshotStrategy strategy : this.snapshotStrategies) {
      if (strategy.canHandle(snapshot)) {
        boolean res=strategy.deleteSnapshot(newSnapshot.getId());
        Assert.assertTrue(res);
      }
    }
  }
  finally {
    Mockito.when(epSelector.select(Matchers.any(DataStore.class))).thenReturn(remoteEp);
  }
}
