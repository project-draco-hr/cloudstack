{
  if (s_logger.isDebugEnabled()) {
    s_logger.debug("Creating actual resources for VM " + vm);
  }
  Journal journal=new Journal.LogJournal("Creating " + vm,s_logger);
  ServiceOffering offering=_offeringDao.findById(vm.getServiceOfferingId());
  VMTemplateVO template=_templateDao.findById(vm.getTemplateId());
  BootloaderType bt=BootloaderType.PyGrub;
  if (template.getFormat() == Storage.ImageFormat.ISO || template.isRequiresHvm()) {
    bt=BootloaderType.HVM;
  }
  GuestOSVO guestOS=_guestOsDao.findById(vm.getGuestOSId());
  if (guestOS == null) {
    throw new CloudRuntimeException("Guest OS is not set");
  }
  VirtualMachineProfile vmProfile=new VirtualMachineProfile(vm,offering,guestOS.getDisplayName(),template.getHypervisorType());
  _vmDao.updateIf(vm,Event.StartRequested,null);
  Set<DeployDestination> avoids=new HashSet<DeployDestination>();
  int retry=_retry;
  while (retry-- != 0) {
    DeployDestination dest=null;
    for (    DeploymentPlanner dispatcher : _planners) {
      dest=dispatcher.plan(vmProfile,plan,avoids);
      if (dest != null) {
        avoids.add(dest);
        journal.record("Deployment found ",vmProfile,dest);
        break;
      }
    }
    if (dest == null) {
      throw new CloudRuntimeException("Unable to create a deployment for " + vmProfile);
    }
    vm.setDataCenterId(dest.getDataCenter().getId());
    vm.setPodId(dest.getPod().getId());
    _vmDao.updateIf(vm,Event.OperationRetry,dest.getHost().getId());
    VirtualMachineTO vmTO=new VirtualMachineTO(vmProfile,bt);
    VolumeTO[] volumes=null;
    try {
      volumes=_storageMgr.prepare(vmProfile,dest);
    }
 catch (    ConcurrentOperationException e) {
      throw e;
    }
catch (    StorageUnavailableException e) {
      s_logger.warn("Unable to contact storage.",e);
      continue;
    }
    NicTO[] nics=_networkMgr.prepare(vmProfile,dest);
    vmTO.setNics(nics);
    vmTO.setDisks(volumes);
    if (checker != null) {
      checker.finalizeDeployment(vmTO,vmProfile,dest);
    }
    Start2Command cmd=new Start2Command(vmTO);
    try {
      Start2Answer answer=(Start2Answer)_agentMgr.send(dest.getHost().getId(),cmd);
      if (answer.getResult()) {
        if (!_vmDao.updateIf(vm,Event.OperationSucceeded,dest.getHost().getId())) {
          throw new CloudRuntimeException("Unable to transition to a new state.");
        }
        return vm;
      }
      s_logger.info("Unable to start VM on " + dest.getHost() + " due to "+ answer.getDetails());
    }
 catch (    AgentUnavailableException e) {
      s_logger.debug("Unable to send the start command to host " + dest.getHost());
      continue;
    }
catch (    OperationTimedoutException e) {
      s_logger.debug("Unable to send the start command to host " + dest.getHost());
      continue;
    }
  }
  if (s_logger.isDebugEnabled()) {
    s_logger.debug("Creation complete for VM " + vmProfile);
  }
  return null;
}
