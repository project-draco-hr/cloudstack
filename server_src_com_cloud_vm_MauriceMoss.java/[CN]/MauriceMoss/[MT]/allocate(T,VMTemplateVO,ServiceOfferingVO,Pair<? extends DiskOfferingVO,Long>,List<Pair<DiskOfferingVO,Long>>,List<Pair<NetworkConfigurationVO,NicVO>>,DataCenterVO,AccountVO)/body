{
  if (s_logger.isDebugEnabled()) {
    s_logger.debug("Allocating entries for VM: " + vm);
  }
  Transaction txn=Transaction.currentTxn();
  txn.start();
  List<NicVO> nics=_networkMgr.allocate(vm,networks);
  VolumeVO volume=_storageMgr.allocate(VolumeType.ROOT,rootDiskOffering.first(),"ROOT-" + vm.getId(),rootDiskOffering.second(),template.getFormat() != ImageFormat.ISO ? template : null,vm,owner);
  for (  Pair<DiskOfferingVO,Long> offering : dataDiskOfferings) {
    volume=_storageMgr.allocate(VolumeType.DATADISK,offering.first(),"DATA-" + vm.getId(),offering.second(),null,vm,owner);
  }
  txn.commit();
  if (s_logger.isDebugEnabled()) {
    s_logger.debug("Allocation completed for VM: " + vm);
  }
  return vm;
}
