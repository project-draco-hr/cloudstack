{
  if (s_logger.isDebugEnabled()) {
    s_logger.debug("Creating actual resources for VM " + vm);
  }
  Journal journal=new Journal.LogJournal("Creating " + vm,s_logger);
  ServiceOffering offering=_offeringDao.findById(vm.getServiceOfferingId());
  VirtualMachineProfile vmProfile=new VirtualMachineProfile(vm,offering);
  Set<DeployDestination> avoids=new HashSet<DeployDestination>();
  int retry=_retry;
  while (retry-- > 0) {
    DeployDestination dest=null;
    for (    DeploymentPlanner dispatcher : _planners) {
      dest=dispatcher.plan(vmProfile,plan,avoids);
      if (dest != null) {
        avoids.add(dest);
        journal.record("Deployment found ",vmProfile,dest);
        break;
      }
    }
    if (dest == null) {
      throw new CloudRuntimeException("Unable to create a deployment for " + vmProfile);
    }
    vm.setDataCenterId(dest.getDataCenter().getId());
    vm.setPodId(dest.getPod().getId());
    _vmDao.updateIf(vm,Event.StartRequested,dest.getHost().getId());
    VirtualMachineTO vmTO=new VirtualMachineTO();
    _networkMgr.prepare(vmProfile,dest);
  }
  if (s_logger.isDebugEnabled()) {
    s_logger.debug("Creation complete for VM " + vmProfile);
  }
  return null;
}
