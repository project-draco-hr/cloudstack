{
  if (s_logger.isDebugEnabled()) {
    s_logger.debug("Allocating entries for VM: " + vm);
  }
  VirtualMachineProfile vmProfile=new VirtualMachineProfile(vm,serviceOffering);
  Transaction txn=Transaction.currentTxn();
  txn.start();
  vm.setDataCenterId(plan.getDataCenterId());
  _vmDao.update(vm.getId(),vm);
  List<NicProfile> nics=_networkMgr.allocate(vmProfile,networks);
  vmProfile.setNics(nics);
  if (dataDiskOfferings == null) {
    dataDiskOfferings=new ArrayList<Pair<DiskOfferingVO,Long>>(0);
  }
  List<DiskProfile> disks=new ArrayList<DiskProfile>(dataDiskOfferings.size() + 1);
  if (template.getFormat() == ImageFormat.ISO) {
    disks.add(_storageMgr.allocateRawVolume(VolumeType.ROOT,"ROOT-" + vm.getId(),rootDiskOffering.first(),rootDiskOffering.second(),vm,owner));
  }
 else {
    disks.add(_storageMgr.allocateTemplatedVolume(VolumeType.ROOT,"ROOT-" + vm.getId(),rootDiskOffering.first(),template,vm,owner));
  }
  for (  Pair<DiskOfferingVO,Long> offering : dataDiskOfferings) {
    disks.add(_storageMgr.allocateRawVolume(VolumeType.DATADISK,"DATA-" + vm.getId(),offering.first(),offering.second(),vm,owner));
  }
  vmProfile.setDisks(disks);
  _vmDao.updateIf(vm,Event.OperationSucceeded,null);
  txn.commit();
  if (s_logger.isDebugEnabled()) {
    s_logger.debug("Allocation completed for VM: " + vm);
  }
  return vmProfile;
}
