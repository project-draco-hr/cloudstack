{
  String agentId=(String)req.getParams().getParameter("agentId");
  String gsonPackage=(String)req.getParams().getParameter("gsonPackage");
  String stopOnError=(String)req.getParams().getParameter("stopOnError");
  if (s_logger.isDebugEnabled()) {
    s_logger.debug("|->" + agentId + " "+ gsonPackage);
  }
  Command[] cmds=null;
  try {
    cmds=gson.fromJson(gsonPackage,Command[].class);
  }
 catch (  Throwable e) {
    assert(false);
    s_logger.error("Excection in gson decoding : ",e);
  }
  if (cmds.length == 1 && cmds[0] instanceof ChangeAgentCommand) {
    ChangeAgentCommand cmd=(ChangeAgentCommand)cmds[0];
    if (s_logger.isDebugEnabled()) {
      s_logger.debug("Intercepting command for agent change: agent " + cmd.getAgentId() + " event: "+ cmd.getEvent());
    }
    boolean result=false;
    try {
      result=manager.executeAgentUserRequest(cmd.getAgentId(),cmd.getEvent());
      if (s_logger.isDebugEnabled()) {
        s_logger.debug("Result is " + result);
      }
    }
 catch (    AgentUnavailableException e) {
      s_logger.warn("Agent is unavailable",e);
      return null;
    }
    Answer[] answers=new Answer[1];
    answers[0]=new ChangeAgentAnswer(cmd,result);
    return gson.toJson(answers);
  }
 else   if (cmds.length == 1 && cmds[0] instanceof TransferAgentCommand) {
    TransferAgentCommand cmd=(TransferAgentCommand)cmds[0];
    if (s_logger.isDebugEnabled()) {
      s_logger.debug("Intercepting command for agent rebalancing: agent " + cmd.getAgentId() + " event: "+ cmd.getEvent());
    }
    boolean result=false;
    try {
      result=manager.rebalanceAgent(cmd.getAgentId(),cmd.getEvent(),cmd.getCurrentOwner(),cmd.getFutureOwner());
      if (s_logger.isDebugEnabled()) {
        s_logger.debug("Result is " + result);
      }
    }
 catch (    AgentUnavailableException e) {
      s_logger.warn("Agent is unavailable",e);
      return null;
    }
catch (    OperationTimedoutException e) {
      s_logger.warn("Operation timed out",e);
      return null;
    }
    Answer[] answers=new Answer[1];
    answers[0]=new Answer(cmd,result,null);
    return gson.toJson(answers);
  }
  try {
    long startTick=System.currentTimeMillis();
    if (s_logger.isDebugEnabled()) {
      s_logger.debug("Send |-> " + agentId + " "+ gsonPackage+ " to agent manager");
    }
    Answer[] answers=manager.sendToAgent(Long.parseLong(agentId),cmds,Integer.parseInt(stopOnError) != 0 ? true : false);
    if (answers != null) {
      String jsonReturn=gson.toJson(answers);
      if (s_logger.isDebugEnabled()) {
        s_logger.debug("Completed |-> " + agentId + " "+ gsonPackage+ " in "+ (System.currentTimeMillis() - startTick)+ " ms, return result: "+ jsonReturn);
      }
      return jsonReturn;
    }
 else {
      if (s_logger.isDebugEnabled()) {
        s_logger.debug("Completed |-> " + agentId + " "+ gsonPackage+ " in "+ (System.currentTimeMillis() - startTick)+ " ms, return null result");
      }
    }
  }
 catch (  AgentUnavailableException e) {
    s_logger.warn("Agent is unavailable",e);
  }
catch (  OperationTimedoutException e) {
    s_logger.warn("Timed Out",e);
  }
  return null;
}
