{
  Account owner=_accountMgr.getAccount(networkOwnerId);
  NetworkOfferingVO ntwkOff=findSystemNetworkOffering(NetworkOffering.SystemPrivateGatewayNetworkOffering);
  PhysicalNetwork pNtwk=_physicalNetworkDao.findById(physicalNetworkId);
  if (pNtwk == null) {
    InvalidParameterValueException ex=new InvalidParameterValueException("Unable to find a physical network" + " having the given id");
    ex.addProxyObject("physical_network",physicalNetworkId,"physicalNetworkId");
    throw ex;
  }
  if (!NetUtils.isValidIp(startIp)) {
    throw new InvalidParameterValueException("Invalid format for the startIp parameter");
  }
  if (endIp == null) {
    endIp=startIp;
  }
 else   if (!NetUtils.isValidIp(endIp)) {
    throw new InvalidParameterValueException("Invalid format for the endIp parameter");
  }
  String cidr=null;
  if (!NetUtils.isValidIp(gateway)) {
    throw new InvalidParameterValueException("Invalid gateway");
  }
  if (!NetUtils.isValidNetmask(netmask)) {
    throw new InvalidParameterValueException("Invalid netmask");
  }
  cidr=NetUtils.ipAndNetMaskToCidr(gateway,netmask);
  Transaction txn=Transaction.currentTxn();
  txn.start();
  DataCenterVO dc=_dcDao.lockRow(pNtwk.getDataCenterId(),true);
  Network privateNetwork=_networksDao.getPrivateNetwork(BroadcastDomainType.Vlan.toUri(vlan).toString(),cidr,networkOwnerId,pNtwk.getDataCenterId());
  if (privateNetwork == null) {
    privateNetwork=_networkMgr.createGuestNetwork(ntwkOff.getId(),networkName,displayText,gateway,cidr,vlan,null,owner,null,pNtwk,pNtwk.getDataCenterId(),ACLType.Account,null,null,null,null);
    s_logger.debug("Created private network " + privateNetwork);
  }
 else {
    s_logger.debug("Private network already exists: " + privateNetwork);
  }
  PrivateIpVO privateIp=_privateIpDao.findByIpAndSourceNetworkId(privateNetwork.getId(),startIp);
  if (privateIp != null) {
    throw new InvalidParameterValueException("Private ip address " + startIp + " already used for private gateway"+ " in zone "+ _configMgr.getZone(pNtwk.getDataCenterId()).getName());
  }
  Long mac=dc.getMacAddress();
  Long nextMac=mac + 1;
  dc.setMacAddress(nextMac);
  privateIp=new PrivateIpVO(startIp,privateNetwork.getId(),nextMac,vpcId,sourceNat);
  _privateIpDao.persist(privateIp);
  _dcDao.update(dc.getId(),dc);
  txn.commit();
  s_logger.debug("Private network " + privateNetwork + " is created");
  return privateNetwork;
}
