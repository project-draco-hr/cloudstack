{
  boolean found=false;
  Type type=Host.Type.Routing;
  final Map<String,String> hostDetails=startup.getHostDetails();
  HostVO server=_hostDao.findByGuid(startup.getGuid());
  if (server == null) {
    server=_hostDao.findByGuid(startup.getGuidWithoutResource());
  }
  if (server != null && server.getRemoved() == null) {
    if (s_logger.isDebugEnabled()) {
      s_logger.debug("Found the host " + server.getId() + " by guid: "+ startup.getGuid());
    }
    found=true;
  }
 else {
    server=new HostVO(startup.getGuid());
  }
  server.setDetails(hostDetails);
  try {
    updateComputeHost(server,startup,type);
  }
 catch (  AgentAuthnException e) {
    throw new ConnectionException(true,"Failed to authorize host, invalid configuration",e);
  }
  if (!found) {
    server.setHostAllocationState(Host.HostAllocationState.Enabled);
    server=_hostDao.persist(server);
  }
 else {
    if (!_hostDao.connect(server,_nodeId)) {
      throw new CloudRuntimeException("Agent cannot connect because the current state is " + server.getStatus().toString());
    }
    s_logger.info("Old " + server.getType().toString() + " host reconnected w/ id ="+ server.getId());
  }
  return true;
}
