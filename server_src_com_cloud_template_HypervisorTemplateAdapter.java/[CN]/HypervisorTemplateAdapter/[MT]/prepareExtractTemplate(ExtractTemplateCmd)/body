{
  TemplateProfile profile=super.prepareExtractTemplate(extractcmd);
  VMTemplateVO template=profile.getTemplate();
  Long zoneId=profile.getZoneId();
  Long templateId=template.getId();
  if (template.getHypervisorType() == HypervisorType.VMware) {
    PrepareOVAPackingCommand cmd=null;
    String zoneName="";
    List<DataStore> imageStores=null;
    if (!template.isCrossZones()) {
      if (zoneId == null) {
        throw new CloudRuntimeException("ZoneId cannot be null for a template that is not available across zones");
      }
      DataCenterVO zone=_dcDao.findById(zoneId);
      zoneName=zone.getName();
      imageStores=this.storeMgr.getImageStoresByScope(new ZoneScope(profile.getZoneId()));
    }
 else {
      imageStores=this.storeMgr.listImageStores();
    }
    if (imageStores == null || imageStores.size() == 0) {
      throw new CloudRuntimeException("Unable to find an image store zone when trying to download template " + profile.getTemplate());
    }
    s_logger.debug("Attempting to mark template host refs for template: " + template.getName() + " as destroyed in zone: "+ zoneName);
    for (    DataStore store : imageStores) {
      long storeId=store.getId();
      List<TemplateDataStoreVO> templateStoreVOs=_tmpltStoreDao.listByTemplateStore(templateId,storeId);
      for (      TemplateDataStoreVO templateStoreVO : templateStoreVOs) {
        if (templateStoreVO.getDownloadState() == Status.DOWNLOAD_IN_PROGRESS) {
          String errorMsg="Please specify a template that is not currently being downloaded.";
          s_logger.debug("Template: " + template.getName() + " is currently being downloaded to secondary storage host: "+ store.getName()+ ".");
          throw new CloudRuntimeException(errorMsg);
        }
        String installPath=templateStoreVO.getInstallPath();
        if (installPath != null) {
          EndPoint ep=_epSelector.select(store);
          if (ep == null) {
            s_logger.warn("prepareOVAPacking (hyervisorTemplateAdapter): There is no secondary storage VM for secondary storage host " + store.getName());
            throw new CloudRuntimeException("PrepareExtractTemplate: can't locate ssvm for SecStorage Host.");
          }
          cmd=new PrepareOVAPackingCommand(store.getUri(),installPath);
          cmd.setContextParam("hypervisor",HypervisorType.VMware.toString());
          Answer answer=ep.sendMessage(cmd);
          if (answer == null || !answer.getResult()) {
            s_logger.debug("Failed to create OVA for template " + templateStoreVO + " due to "+ ((answer == null) ? "answer is null" : answer.getDetails()));
            throw new CloudRuntimeException("PrepareExtractTemplate: Failed to create OVA for template extraction. ");
          }
        }
      }
    }
  }
  return profile;
}
