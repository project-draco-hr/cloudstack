{
  VMTemplateVO template=persistTemplate(profile);
  if (template == null) {
    throw new CloudRuntimeException("Unable to persist the template " + profile.getTemplate());
  }
  List<DataStore> imageStores=this.storeMgr.getImageStoresByScope(new ZoneScope(profile.getZoneId()));
  if (imageStores == null || imageStores.size() == 0) {
    throw new CloudRuntimeException("Unable to find image store to download template " + profile.getTemplate());
  }
  for (  DataStore imageStore : imageStores) {
    AsyncCallFuture<CommandResult> future=this.imageService.createTemplateAsync(this.imageFactory.getTemplate(template.getId()),imageStore);
    try {
      future.get();
    }
 catch (    InterruptedException e) {
      s_logger.debug("create template Failed",e);
      throw new CloudRuntimeException("create template Failed",e);
    }
catch (    ExecutionException e) {
      s_logger.debug("create template Failed",e);
      throw new CloudRuntimeException("create template Failed",e);
    }
  }
  _resourceLimitMgr.incrementResourceCount(profile.getAccountId(),ResourceType.template);
  _resourceLimitMgr.incrementResourceCount(profile.getAccountId(),ResourceType.secondary_storage,UriUtils.getRemoteSize(profile.getUrl()));
  return template;
}
