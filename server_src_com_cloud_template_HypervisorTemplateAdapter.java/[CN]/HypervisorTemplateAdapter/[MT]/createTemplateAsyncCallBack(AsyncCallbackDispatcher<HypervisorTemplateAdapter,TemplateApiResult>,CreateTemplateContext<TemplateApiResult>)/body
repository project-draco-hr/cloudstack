{
  TemplateApiResult result=callback.getResult();
  TemplateInfo template=context.template;
  if (result.isFailed()) {
    _tmpltDao.remove(template.getId());
  }
 else {
    VMTemplateVO tmplt=this._tmpltDao.findById(template.getId());
    long accountId=tmplt.getAccountId();
    if (template.getSize() != null) {
      long physicalSize=0;
      DataStore ds=template.getDataStore();
      TemplateDataStoreVO tmpltStore=_tmpltStoreDao.findByStoreTemplate(ds.getId(),template.getId());
      if (tmpltStore != null) {
        physicalSize=tmpltStore.getPhysicalSize();
      }
 else {
        s_logger.warn("No entry found in template_store_ref for template id: " + template.getId() + " and image store id: "+ ds.getId()+ " at the end of registering template!");
      }
      Scope dsScope=ds.getScope();
      if (dsScope.getScopeType() == ScopeType.ZONE) {
        if (dsScope.getScopeId() != null) {
          UsageEventUtils.publishUsageEvent(EventTypes.EVENT_TEMPLATE_CREATE,template.getAccountId(),dsScope.getScopeId(),template.getId(),template.getName(),null,null,physicalSize,template.getSize(),VirtualMachineTemplate.class.getName(),template.getUuid());
        }
 else {
          s_logger.warn("Zone scope image store " + ds.getId() + " has a null scope id");
        }
      }
 else       if (dsScope.getScopeType() == ScopeType.REGION) {
        UsageEventUtils.publishUsageEvent(EventTypes.EVENT_TEMPLATE_CREATE,template.getAccountId(),-1,template.getId(),template.getName(),null,null,physicalSize,template.getSize(),VirtualMachineTemplate.class.getName(),template.getUuid());
      }
      _resourceLimitMgr.incrementResourceCount(accountId,ResourceType.secondary_storage,template.getSize());
    }
  }
  return null;
}
