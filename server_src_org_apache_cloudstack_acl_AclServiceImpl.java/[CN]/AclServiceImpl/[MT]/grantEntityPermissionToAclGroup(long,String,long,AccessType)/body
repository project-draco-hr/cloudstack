{
  Account caller=CallContext.current().getCallingAccount();
  AclGroup group=_aclGroupDao.findById(aclGroupId);
  if (group == null) {
    throw new InvalidParameterValueException("Unable to find acl group: " + aclGroupId + "; failed to grant permission to group.");
  }
  _accountMgr.checkAccess(caller,null,true,group);
  Class entityClass=entityClassMap.get(entityType);
  if (entityClass == null) {
    throw new InvalidParameterValueException("Entity type " + entityType + " permission granting is not supported yet");
  }
  ControlledEntity entity=(ControlledEntity)_entityMgr.findById(entityClass,entityId);
  if (entity == null) {
    throw new InvalidParameterValueException("Unable to find entity " + entityType + " by id: "+ entityId);
  }
  _accountMgr.checkAccess(caller,null,true,entity);
  AclEntityPermissionVO perm=_entityPermissionDao.findByGroupAndEntity(aclGroupId,entityType,entityId,accessType);
  if (perm == null) {
    String entityUuid=String.valueOf(entityId);
    if (entity instanceof Identity) {
      entityUuid=((Identity)entity).getUuid();
    }
    perm=new AclEntityPermissionVO(aclGroupId,entityType,entityId,entityUuid,accessType,true);
    _entityPermissionDao.persist(perm);
  }
  return group;
}
