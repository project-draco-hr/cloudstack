{
  Long id=cmd.getId();
  Site2SiteCustomerGatewayVO gw=_customerGatewayDao.findById(id);
  if (gw == null) {
    throw new InvalidParameterValueException("Find to find customer gateway with id " + id);
  }
  List<Site2SiteVpnConnectionVO> conns=_vpnConnectionDao.listByCustomerGatewayId(id);
  if (conns != null) {
    for (    Site2SiteVpnConnection conn : conns) {
      if (conn.getState() != State.Disconnected || conn.getState() != State.Error) {
        throw new InvalidParameterValueException("Unable to update customer gateway because there is active VPN connection " + conn.getId());
      }
    }
  }
  String gatewayIp=cmd.getGatewayIp();
  if (!NetUtils.isValidIp(gatewayIp)) {
    throw new InvalidParameterValueException("The customer gateway ip " + gatewayIp + " is invalid!");
  }
  String guestCidrList=cmd.getGuestCidrList();
  if (!NetUtils.validateGuestCidrList(guestCidrList)) {
    throw new InvalidParameterValueException("The customer gateway guest cidr list " + guestCidrList + " contains invalid guest cidr!");
  }
  String ipsecPsk=cmd.getIpsecPsk();
  String ikePolicy=cmd.getIkePolicy();
  String espPolicy=cmd.getEspPolicy();
  if (!NetUtils.isValidS2SVpnPolicy(ikePolicy)) {
    throw new InvalidParameterValueException("The customer gateway IKE policy" + ikePolicy + " is invalid!");
  }
  if (!NetUtils.isValidS2SVpnPolicy(espPolicy)) {
    throw new InvalidParameterValueException("The customer gateway ESP policy" + espPolicy + " is invalid!");
  }
  Long lifetime=cmd.getLifetime();
  if (lifetime == null) {
    lifetime=(long)86400;
  }
  if (lifetime > 86400) {
    throw new InvalidParameterValueException("The lifetime " + lifetime + " of vpn connection is invalid!");
  }
  gw.setGatewayIp(gatewayIp);
  gw.setGuestCidrList(guestCidrList);
  gw.setIkePolicy(ikePolicy);
  gw.setEspPolicy(espPolicy);
  gw.setIpsecPsk(ipsecPsk);
  gw.setLifetime(lifetime);
  _customerGatewayDao.persist(gw);
  return gw;
}
