{
  Account caller=UserContext.current().getCaller();
  Account owner=_accountMgr.getAccount(cmd.getEntityOwnerId());
  _accountMgr.checkAccess(caller,null,false,owner);
  Long customerGatewayId=cmd.getCustomerGatewayId();
  Site2SiteCustomerGateway customerGateway=_customerGatewayDao.findById(customerGatewayId);
  if (customerGateway == null) {
    throw new InvalidParameterValueException("Unable to found specified Site to Site VPN customer gateway " + customerGatewayId + " !");
  }
  _accountMgr.checkAccess(caller,null,false,customerGateway);
  Long vpnGatewayId=cmd.getVpnGatewayId();
  Site2SiteVpnGateway vpnGateway=_vpnGatewayDao.findById(vpnGatewayId);
  if (vpnGateway == null) {
    throw new InvalidParameterValueException("Unable to found specified Site to Site VPN gateway " + vpnGatewayId + " !");
  }
  _accountMgr.checkAccess(caller,null,false,vpnGateway);
  if (_vpnConnectionDao.findByVpnGatewayIdAndCustomerGatewayId(vpnGatewayId,customerGatewayId) != null) {
    throw new InvalidParameterValueException("The vpn connection with customer gateway id " + customerGatewayId + " or vpn gateway id "+ vpnGatewayId+ " already existed!");
  }
  if (_vpnConnectionDao.findByCustomerGatewayId(customerGatewayId) != null) {
    throw new InvalidParameterValueException("The vpn connection with specified customer gateway id " + customerGatewayId + " already exists!");
  }
  String[] cidrList=customerGateway.getGuestCidrList().split(",");
  String vpcCidr=_vpcDao.findById(vpnGateway.getVpcId()).getCidr();
  for (  String cidr : cidrList) {
    if (NetUtils.isNetworksOverlap(vpcCidr,cidr)) {
      throw new InvalidParameterValueException("The subnet of customer gateway " + customerGatewayId + "'s subnet "+ cidr+ " is overlapped with VPC cidr "+ vpcCidr+ "!");
    }
  }
  Site2SiteVpnConnectionVO conn=new Site2SiteVpnConnectionVO(owner.getAccountId(),owner.getDomainId(),vpnGatewayId,customerGatewayId);
  conn.setState(State.Pending);
  _vpnConnectionDao.persist(conn);
  return conn;
}
