{
  Account caller=UserContext.current().getCaller();
  Account owner=_accountMgr.getAccount(cmd.getEntityOwnerId());
  _accountMgr.checkAccess(caller,null,false,owner);
  String name=cmd.getName();
  String gatewayIp=cmd.getGatewayIp();
  if (!NetUtils.isValidIp(gatewayIp)) {
    throw new InvalidParameterValueException("The customer gateway ip " + gatewayIp + " is invalid!");
  }
  if (name == null) {
    name="VPN-" + gatewayIp;
  }
  String guestCidrList=cmd.getGuestCidrList();
  if (!NetUtils.validateGuestCidrList(guestCidrList)) {
    throw new InvalidParameterValueException("The customer gateway guest cidr list " + guestCidrList + " is invalid guest cidr!");
  }
  String ipsecPsk=cmd.getIpsecPsk();
  String ikePolicy=cmd.getIkePolicy();
  String espPolicy=cmd.getEspPolicy();
  if (!NetUtils.isValidS2SVpnPolicy(ikePolicy)) {
    throw new InvalidParameterValueException("The customer gateway IKE policy " + ikePolicy + " is invalid!");
  }
  if (!NetUtils.isValidS2SVpnPolicy(espPolicy)) {
    throw new InvalidParameterValueException("The customer gateway ESP policy " + espPolicy + " is invalid!");
  }
  Long lifetime=cmd.getLifetime();
  if (lifetime == null) {
    lifetime=(long)86400;
  }
  if (lifetime > 86400) {
    throw new InvalidParameterValueException("The lifetime " + lifetime + " of vpn connection is invalid!");
  }
  if (_customerGatewayDao.findByGatewayIp(gatewayIp) != null) {
    throw new InvalidParameterValueException("The customer gateway with ip " + gatewayIp + " already existed!");
  }
  if (_customerGatewayDao.findByName(name) != null) {
    throw new InvalidParameterValueException("The customer gateway with name " + name + " already existed!");
  }
  Site2SiteCustomerGatewayVO gw=new Site2SiteCustomerGatewayVO(name,owner.getAccountId(),owner.getDomainId(),gatewayIp,guestCidrList,ipsecPsk,ikePolicy,espPolicy,lifetime);
  _customerGatewayDao.persist(gw);
  return gw;
}
