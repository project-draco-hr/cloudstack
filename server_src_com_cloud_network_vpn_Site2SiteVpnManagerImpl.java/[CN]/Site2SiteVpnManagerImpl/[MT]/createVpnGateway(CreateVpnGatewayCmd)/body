{
  Long vpcId=cmd.getVpcId();
  VpcVO vpc=_vpcDao.findById(vpcId);
  if (vpc == null) {
    throw new InvalidParameterValueException("Invalid VPC " + vpcId + " for site to site vpn gateway creation!");
  }
  Site2SiteVpnGatewayVO gws=_vpnGatewayDao.findByVpcId(vpcId);
  if (gws != null) {
    throw new InvalidParameterValueException("The VPN gateway of VPC " + vpcId + " already existed!");
  }
  Long accountId=cmd.getEntityOwnerId();
  Long domainId=cmd.getDomainId();
  if (domainId == null) {
    domainId=Domain.ROOT_DOMAIN;
  }
  List<IPAddressVO> ips=_ipAddressDao.listByAssociatedVpc(vpcId,true);
  if (ips.size() != 1) {
    throw new CloudRuntimeException("Cannot found source nat ip of vpc " + vpcId);
  }
  Site2SiteVpnGatewayVO gw=new Site2SiteVpnGatewayVO(accountId,domainId,ips.get(0).getId(),vpcId);
  _vpnGatewayDao.persist(gw);
  return gw;
}
