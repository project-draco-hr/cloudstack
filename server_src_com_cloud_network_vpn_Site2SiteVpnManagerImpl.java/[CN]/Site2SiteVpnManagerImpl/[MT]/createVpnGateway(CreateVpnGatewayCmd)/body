{
  Long ipId=cmd.getPublicIpId();
  IpAddress ip=_networkMgr.getIp(ipId);
  Network network=_networkDao.findById(ip.getAssociatedWithNetworkId());
  if (network.getGuestType() != GuestType.Isolated) {
    throw new InvalidParameterValueException("The VPN gateway cannot create with non-isolated network " + ip.getAssociatedWithNetworkId());
  }
  Long domainId=ip.getDomainId();
  Long accountId=ip.getAccountId();
  if (_vpnGatewayDao.findByIpAddrId(ipId) != null) {
    throw new InvalidParameterValueException("The VPN gateway with ip ID " + ipId + " already existed!");
  }
  Site2SiteVpnGatewayVO gw=new Site2SiteVpnGatewayVO(ipId);
  _vpnGatewayDao.persist(gw);
  return gw;
}
