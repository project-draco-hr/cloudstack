{
  String value=configDao.getValue(Config.BackupSnapshotWait.toString());
  int _backupsnapshotwait=NumbersUtil.parseInt(value,Integer.parseInt(Config.BackupSnapshotWait.getDefaultValue()));
  DataObject cacheData=null;
  Answer answer=null;
  try {
    if (needCacheStorage(srcData,destData)) {
      Scope selectedScope=pickCacheScopeForCopy(srcData,destData);
      cacheData=cacheMgr.getCacheObject(srcData,selectedScope);
      CopyCommand cmd=new CopyCommand(srcData.getTO(),destData.getTO(),_backupsnapshotwait,VirtualMachineManager.ExecuteInSequence.value());
      cmd.setCacheTO(cacheData.getTO());
      EndPoint ep=selector.select(srcData,destData);
      if (ep == null) {
        String errMsg="No remote endpoint to send command, check if host or ssvm is down?";
        s_logger.error(errMsg);
        answer=new Answer(cmd,false,errMsg);
      }
 else {
        answer=ep.sendMessage(cmd);
      }
    }
 else {
      CopyCommand cmd=new CopyCommand(srcData.getTO(),destData.getTO(),_backupsnapshotwait,VirtualMachineManager.ExecuteInSequence.value());
      EndPoint ep=selector.select(srcData,destData);
      if (ep == null) {
        String errMsg="No remote endpoint to send command, check if host or ssvm is down?";
        s_logger.error(errMsg);
        answer=new Answer(cmd,false,errMsg);
      }
 else {
        answer=ep.sendMessage(cmd);
      }
    }
    if (cacheData != null) {
      cacheMgr.deleteCacheObject(cacheData);
    }
    return answer;
  }
 catch (  Exception e) {
    s_logger.debug("copy snasphot failed: " + e.toString());
    if (cacheData != null) {
      cacheMgr.deleteCacheObject(cacheData);
    }
    throw new CloudRuntimeException(e.toString());
  }
}
