{
  CreatePrivateTemplateAnswer answer=null;
  try {
    answer=(CreatePrivateTemplateAnswer)this.storageMgr.sendToPool(pool,cmd);
  }
 catch (  StorageUnavailableException e) {
    throw new CloudRuntimeException("Failed to execute CreatePrivateTemplateFromSnapshotCommand",e);
  }
  if (answer == null || !answer.getResult()) {
    return answer;
  }
  VMTemplateVO privateTemplate=templateDao.findById(templateId);
  String answerUniqueName=answer.getUniqueName();
  if (answerUniqueName != null) {
    privateTemplate.setUniqueName(answerUniqueName);
  }
  ImageFormat format=answer.getImageFormat();
  if (format != null) {
    privateTemplate.setFormat(format);
  }
 else {
    privateTemplate.setFormat(ImageFormat.RAW);
  }
  String checkSum=this.templateMgr.getChecksum(secStore,answer.getPath());
  Transaction txn=Transaction.currentTxn();
  txn.start();
  privateTemplate.setChecksum(checkSum);
  templateDao.update(privateTemplate.getId(),privateTemplate);
  templateDao.addTemplateToZone(privateTemplate,zoneId);
  TemplateDataStoreVO templateHostVO=new TemplateDataStoreVO(secStore.getId(),privateTemplate.getId());
  templateHostVO.setDownloadPercent(100);
  templateHostVO.setDownloadState(Status.DOWNLOADED);
  templateHostVO.setInstallPath(answer.getPath());
  templateHostVO.setLastUpdated(new Date());
  templateHostVO.setSize(answer.getVirtualSize());
  templateHostVO.setPhysicalSize(answer.getphysicalSize());
  templateStoreDao.persist(templateHostVO);
  txn.close();
  return answer;
}
