{
  if (vm != null) {
    try {
      if (vm.getPowerState(conn) == VmPowerState.RUNNING) {
        try {
          vm.hardShutdown(conn);
        }
 catch (        final Exception e) {
          final String msg="VM hardshutdown failed due to " + e.toString();
          s_logger.warn(msg,e);
        }
      }
      if (vm.getPowerState(conn) == VmPowerState.HALTED) {
        try {
          vm.destroy(conn);
        }
 catch (        final Exception e) {
          final String msg="VM destroy failed due to " + e.toString();
          s_logger.warn(msg,e);
        }
      }
    }
 catch (    final Exception e) {
      final String msg="VM getPowerState failed due to " + e.toString();
      s_logger.warn(msg,e);
    }
  }
  if (mounts != null) {
    for (    final Ternary<SR,VDI,VolumeVO> mount : mounts) {
      final VDI vdi=mount.second();
      Set<VBD> vbds=null;
      try {
        vbds=vdi.getVBDs(conn);
      }
 catch (      final Exception e) {
        final String msg="VDI getVBDS failed due to " + e.toString();
        s_logger.warn(msg,e);
        continue;
      }
      for (      final VBD vbd : vbds) {
        try {
          vbd.unplug(conn);
          vbd.destroy(conn);
        }
 catch (        final Exception e) {
          final String msg="VBD destroy failed due to " + e.toString();
          s_logger.warn(msg,e);
        }
      }
    }
  }
}
