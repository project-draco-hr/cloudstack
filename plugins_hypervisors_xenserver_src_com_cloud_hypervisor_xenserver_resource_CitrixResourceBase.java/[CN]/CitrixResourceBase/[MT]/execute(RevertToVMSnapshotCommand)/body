{
  final String vmName=cmd.getVmName();
  final List<VolumeObjectTO> listVolumeTo=cmd.getVolumeTOs();
  final VMSnapshot.Type vmSnapshotType=cmd.getTarget().getType();
  final Boolean snapshotMemory=vmSnapshotType == VMSnapshot.Type.DiskAndMemory;
  final Connection conn=getConnection();
  PowerState vmState=null;
  VM vm=null;
  try {
    final Set<VM> vmSnapshots=VM.getByNameLabel(conn,cmd.getTarget().getSnapshotName());
    if (vmSnapshots.size() == 0) {
      return new RevertToVMSnapshotAnswer(cmd,false,"Cannot find vmSnapshot with name: " + cmd.getTarget().getSnapshotName());
    }
    final VM vmSnapshot=vmSnapshots.iterator().next();
    try {
      vm=getVM(conn,vmName);
    }
 catch (    final Exception e) {
      vm=createWorkingVM(conn,vmName,cmd.getGuestOSType(),cmd.getPlatformEmulator(),listVolumeTo);
    }
    if (vm == null) {
      return new RevertToVMSnapshotAnswer(cmd,false,"Revert to VM Snapshot Failed due to can not find vm: " + vmName);
    }
    revertToSnapshot(conn,vmSnapshot,vmName,vm.getUuid(conn),snapshotMemory,_host.getUuid());
    vm=getVM(conn,vmName);
    final Set<VBD> vbds=vm.getVBDs(conn);
    final Map<String,VDI> vdiMap=new HashMap<String,VDI>();
    for (    final VBD vbd : vbds) {
      final VBD.Record vbdr=vbd.getRecord(conn);
      if (vbdr.type == Types.VbdType.DISK) {
        final VDI vdi=vbdr.VDI;
        vdiMap.put(vbdr.userdevice,vdi);
      }
    }
    if (!snapshotMemory) {
      vm.destroy(conn);
      vmState=PowerState.PowerOff;
    }
 else {
      vmState=PowerState.PowerOn;
    }
    for (    final VolumeObjectTO volumeTo : listVolumeTo) {
      final Long deviceId=volumeTo.getDeviceId();
      final VDI vdi=vdiMap.get(deviceId.toString());
      volumeTo.setPath(vdi.getUuid(conn));
    }
    return new RevertToVMSnapshotAnswer(cmd,listVolumeTo,vmState);
  }
 catch (  final Exception e) {
    s_logger.error("revert vm " + vmName + " to snapshot "+ cmd.getTarget().getSnapshotName()+ " failed due to "+ e.getMessage());
    return new RevertToVMSnapshotAnswer(cmd,false,e.getMessage());
  }
}
