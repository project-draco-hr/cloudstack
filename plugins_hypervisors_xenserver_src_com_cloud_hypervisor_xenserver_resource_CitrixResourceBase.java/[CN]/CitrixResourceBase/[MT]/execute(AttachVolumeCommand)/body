{
  final Connection conn=getConnection();
  final boolean attach=cmd.getAttach();
  final String vmName=cmd.getVmName();
  final String vdiNameLabel=vmName + "-DATA";
  final Long deviceId=cmd.getDeviceId();
  String errorMsg;
  if (attach) {
    errorMsg="Failed to attach volume";
  }
 else {
    errorMsg="Failed to detach volume";
  }
  try {
    VDI vdi=null;
    if (cmd.getAttach() && cmd.isManaged()) {
      final SR sr=getIscsiSR(conn,cmd.get_iScsiName(),cmd.getStorageHost(),cmd.get_iScsiName(),cmd.getChapInitiatorUsername(),cmd.getChapInitiatorPassword(),true);
      vdi=getVDIbyUuid(conn,cmd.getVolumePath(),false);
      if (vdi == null) {
        vdi=createVdi(sr,vdiNameLabel,cmd.getVolumeSize());
      }
    }
 else {
      vdi=getVDIbyUuid(conn,cmd.getVolumePath());
    }
    final VM vm=getVM(conn,vmName);
    if (attach) {
      String diskNumber=null;
      if (deviceId != null) {
        if (deviceId.longValue() == 3) {
          final String msg="Device 3 is reserved for CD-ROM, choose other device";
          return new AttachVolumeAnswer(cmd,msg);
        }
        if (isDeviceUsed(conn,vm,deviceId)) {
          final String msg="Device " + deviceId + " is used in VM "+ vmName;
          return new AttachVolumeAnswer(cmd,msg);
        }
        diskNumber=deviceId.toString();
      }
 else {
        diskNumber=getUnusedDeviceNum(conn,vm);
      }
      final VBD.Record vbdr=new VBD.Record();
      vbdr.VM=vm;
      vbdr.VDI=vdi;
      vbdr.bootable=false;
      vbdr.userdevice=diskNumber;
      vbdr.mode=Types.VbdMode.RW;
      vbdr.type=Types.VbdType.DISK;
      vbdr.unpluggable=true;
      final VBD vbd=VBD.create(conn,vbdr);
      vbd.plug(conn);
      vdi.setNameLabel(conn,vdiNameLabel);
      return new AttachVolumeAnswer(cmd,Long.parseLong(diskNumber),vdi.getUuid(conn));
    }
 else {
      final Set<VBD> vbds=vdi.getVBDs(conn);
      for (      final VBD vbd : vbds) {
        final VBD.Record vbdr=vbd.getRecord(conn);
        if (vbdr.currentlyAttached) {
          vbd.unplug(conn);
        }
        vbd.destroy(conn);
      }
      vdi.setNameLabel(conn,"detached");
      if (cmd.isManaged()) {
        handleSrAndVdiDetach(cmd.get_iScsiName(),conn);
      }
      return new AttachVolumeAnswer(cmd);
    }
  }
 catch (  final XenAPIException e) {
    final String msg=errorMsg + " for uuid: " + cmd.getVolumePath()+ "  due to "+ e.toString();
    s_logger.warn(msg,e);
    return new AttachVolumeAnswer(cmd,msg);
  }
catch (  final Exception e) {
    final String msg=errorMsg + " for uuid: " + cmd.getVolumePath()+ "  due to "+ e.getMessage();
    s_logger.warn(msg,e);
    return new AttachVolumeAnswer(cmd,msg);
  }
}
