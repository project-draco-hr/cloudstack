{
  if (nic.getIp4Address() == null) {
    Pair<String,VlanVO> ipAndVlan=_vlanDao.assignIpAddress(dc.getId(),vm.getVirtualMachine().getAccountId(),vm.getVirtualMachine().getDomainId(),VlanType.VirtualNetwork,true);
    if (ipAndVlan == null) {
      throw new InsufficientVirtualNetworkCapcityException("Unable to get public ip address in " + dc.getId(),DataCenter.class,dc.getId());
    }
    VlanVO vlan=ipAndVlan.second();
    nic.setIp4Address(ipAndVlan.first());
    nic.setGateway(vlan.getVlanGateway());
    nic.setNetmask(vlan.getVlanNetmask());
    nic.setIsolationUri(IsolationType.Vlan.toUri(vlan.getVlanId()));
    nic.setBroadcastType(BroadcastDomainType.Vlan);
    nic.setBroadcastUri(BroadcastDomainType.Vlan.toUri(vlan.getVlanId()));
    nic.setFormat(AddressFormat.Ip4);
    nic.setReservationId(Long.toString(vlan.getId()));
  }
  nic.setDns1(dc.getDns1());
  nic.setDns2(dc.getDns2());
}
