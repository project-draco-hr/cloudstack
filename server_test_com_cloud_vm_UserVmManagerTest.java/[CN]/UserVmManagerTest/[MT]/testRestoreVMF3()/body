{
  doReturn(VirtualMachine.State.Running).when(vmMock).getState();
  when(_vmDao.findById(anyLong())).thenReturn(vmMock);
  when(_volsDao.findByInstance(anyLong())).thenReturn(rootVols);
  doReturn(false).when(rootVols).isEmpty();
  when(rootVols.get(eq(0))).thenReturn(volumeMock);
  doReturn(3L).when(volumeMock).getTemplateId();
  when(_templateDao.findById(anyLong())).thenReturn(templateMock);
  when(_itMgr.stop(vmMock,userMock,account)).thenReturn(true);
  when(_itMgr.start(vmMock,null,userMock,account)).thenReturn(vmMock);
  when(_storageMgr.allocateDuplicateVolume(volumeMock,null)).thenReturn(volumeMock);
  doNothing().when(_volsDao).attachVolume(anyLong(),anyLong(),anyLong());
  when(volumeMock.getId()).thenReturn(3L);
  doNothing().when(_volsDao).detachVolume(anyLong());
  when(_storageMgr.destroyVolume(volumeMock)).thenReturn(true);
  _userVmMgr.restoreVMInternal(account,vmMock);
}
