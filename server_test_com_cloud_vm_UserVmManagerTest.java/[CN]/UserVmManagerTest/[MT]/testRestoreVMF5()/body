{
  doReturn(VirtualMachine.State.Running).when(_vmMock).getState();
  when(_vmDao.findById(anyLong())).thenReturn(_vmMock);
  when(_volsDao.findByInstanceAndType(314L,Volume.Type.ROOT)).thenReturn(_rootVols);
  doReturn(false).when(_rootVols).isEmpty();
  when(_rootVols.get(eq(0))).thenReturn(_volumeMock);
  doReturn(null).when(_volumeMock).getTemplateId();
  doReturn(3L).when(_vmMock).getIsoId();
  doReturn(ImageFormat.ISO).when(_templateMock).getFormat();
  when(_templateDao.findById(anyLong())).thenReturn(_templateMock);
  doNothing().when(_accountMgr).checkAccess(_account,null,true,_templateMock);
  when(_itMgr.stop(_vmMock,_userMock,_account)).thenReturn(true);
  when(_storageMgr.allocateDuplicateVolume(_volumeMock,null)).thenReturn(_volumeMock);
  doNothing().when(_vmMock).setIsoId(14L);
  when(_templateMock.getGuestOSId()).thenReturn(5L);
  doNothing().when(_vmMock).setGuestOSId(anyLong());
  doNothing().when(_vmMock).setTemplateId(3L);
  when(_vmDao.update(314L,_vmMock)).thenReturn(true);
  when(_storageMgr.allocateDuplicateVolume(_volumeMock,null)).thenReturn(_volumeMock);
  doNothing().when(_volsDao).attachVolume(anyLong(),anyLong(),anyLong());
  when(_volumeMock.getId()).thenReturn(3L);
  doNothing().when(_volsDao).detachVolume(anyLong());
  when(_templateMock.getUuid()).thenReturn("b1a3626e-72e0-4697-8c7c-a110940cc55d");
  Account account=new AccountVO("testaccount",1L,"networkdomain",(short)0,"uuid");
  UserVO user=new UserVO(1,"testuser","password","firstname","lastName","email","timezone",UUID.randomUUID().toString());
  CallContext.register(user,account);
  try {
    _userVmMgr.restoreVMInternal(_account,_vmMock,14L);
  }
  finally {
    CallContext.unregister();
  }
  verify(_vmMock,times(1)).setIsoId(14L);
}
