{
  Host host=super.allocateTo(vm,offering,type,dc,pod,clusterId,template,avoid);
  if (host != null) {
    return host;
  }
  s_logger.debug("First fit was unable to find a host");
  VirtualMachine.Type vmType=vm.getType();
  if (vmType == VirtualMachine.Type.User) {
    s_logger.debug("vm is not a system vm so let's just return null");
    return null;
  }
  List<PodCluster> pcs=_agentMgr.listByDataCenter(dc.getId());
  if (vmType == VirtualMachine.Type.DomainRouter) {
    s_logger.debug("VM is a domain router so we can only allow the host to be allocated in the same pod due to problems with the DHCP only domR");
    List<VolumeVO> vols=_volsDao.findByInstance(vm.getId());
    VolumeVO vol=vols.get(0);
    long podId=vol.getPodId();
    s_logger.debug("Pod id determined from volume " + vol.getId() + " is "+ podId);
    Iterator<PodCluster> it=pcs.iterator();
    while (it.hasNext()) {
      PodCluster pc=it.next();
      if (pc.getPod().getId() != podId) {
        it.remove();
      }
    }
  }
  Set<Pair<Long,Long>> avoidPcs=new HashSet<Pair<Long,Long>>();
  for (  Host h : avoid) {
    avoidPcs.add(new Pair<Long,Long>(h.getPodId(),h.getClusterId()));
  }
  for (  Pair<Long,Long> pcId : avoidPcs) {
    s_logger.debug("Removing " + pcId + " from the list of available pods");
    pcs.remove(new PodCluster(new HostPodVO(pcId.first()),pcId.second() != null ? new ClusterVO(pcId.second()) : null));
  }
  for (  PodCluster p : pcs) {
    clusterId=p.getCluster() == null ? null : p.getCluster().getId();
    host=super.allocateTo(vm,offering,type,dc,p.getPod(),clusterId,template,avoid);
    if (host != null) {
      return host;
    }
  }
  s_logger.debug("Unable to find any available pods at all!");
  return null;
}
