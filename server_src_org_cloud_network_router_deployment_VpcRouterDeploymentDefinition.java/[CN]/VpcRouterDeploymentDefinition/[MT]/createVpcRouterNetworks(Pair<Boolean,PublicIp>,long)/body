{
  TreeSet<String> publicVlans=new TreeSet<String>();
  publicVlans.add(sourceNatIp.second().getVlanTag());
  LinkedHashMap<Network,List<? extends NicProfile>> networks=nwHelper.createRouterNetworks(this,null,sourceNatIp);
  List<PrivateGateway> privateGateways=vpcMgr.getVpcPrivateGateways(vpcId);
  if (privateGateways != null && !privateGateways.isEmpty()) {
    for (    PrivateGateway privateGateway : privateGateways) {
      NicProfile privateNic=vpcHelper.createPrivateNicProfileForGateway(privateGateway);
      Network privateNetwork=networkModel.getNetwork(privateGateway.getNetworkId());
      networks.put(privateNetwork,new ArrayList<NicProfile>(Arrays.asList(privateNic)));
    }
  }
  List<? extends Network> guestNetworks=vpcMgr.getVpcNetworks(vpcId);
  for (  Network guestNetwork : guestNetworks) {
    if (networkModel.isPrivateGateway(guestNetwork.getId())) {
      continue;
    }
    if (guestNetwork.getState() == Network.State.Implemented || guestNetwork.getState() == Network.State.Setup) {
      NicProfile guestNic=vpcHelper.createGuestNicProfileForVpcRouter(guestNetwork);
      networks.put(guestNetwork,new ArrayList<NicProfile>(Arrays.asList(guestNic)));
    }
  }
  List<IPAddressVO> ips=ipAddressDao.listByAssociatedVpc(vpcId,false);
  List<NicProfile> publicNics=new ArrayList<NicProfile>();
  Network publicNetwork=null;
  for (  IPAddressVO ip : ips) {
    PublicIp publicIp=PublicIp.createFromAddrAndVlan(ip,vlanDao.findById(ip.getVlanId()));
    if ((ip.getState() == IpAddress.State.Allocated || ip.getState() == IpAddress.State.Allocating) && vpcMgr.isIpAllocatedToVpc(ip) && !publicVlans.contains(publicIp.getVlanTag())) {
      logger.debug("Allocating nic for router in vlan " + publicIp.getVlanTag());
      NicProfile publicNic=new NicProfile();
      publicNic.setDefaultNic(false);
      publicNic.setIp4Address(publicIp.getAddress().addr());
      publicNic.setGateway(publicIp.getGateway());
      publicNic.setNetmask(publicIp.getNetmask());
      publicNic.setMacAddress(publicIp.getMacAddress());
      publicNic.setBroadcastType(BroadcastDomainType.Vlan);
      publicNic.setBroadcastUri(BroadcastDomainType.Vlan.toUri(publicIp.getVlanTag()));
      publicNic.setIsolationUri(IsolationType.Vlan.toUri(publicIp.getVlanTag()));
      NetworkOffering publicOffering=networkModel.getSystemAccountNetworkOfferings(NetworkOffering.SystemPublicNetwork).get(0);
      if (publicNetwork == null) {
        List<? extends Network> publicNetworks=networkMgr.setupNetwork(VirtualNwStatus.account,publicOffering,this.plan,null,null,false);
        publicNetwork=publicNetworks.get(0);
      }
      publicNics.add(publicNic);
      publicVlans.add(publicIp.getVlanTag());
    }
  }
  if (publicNetwork != null) {
    if (networks.get(publicNetwork) != null) {
      List<NicProfile> publicNicProfiles=(List<NicProfile>)networks.get(publicNetwork);
      publicNicProfiles.addAll(publicNics);
      networks.put(publicNetwork,publicNicProfiles);
    }
 else {
      networks.put(publicNetwork,publicNics);
    }
  }
  return networks;
}
