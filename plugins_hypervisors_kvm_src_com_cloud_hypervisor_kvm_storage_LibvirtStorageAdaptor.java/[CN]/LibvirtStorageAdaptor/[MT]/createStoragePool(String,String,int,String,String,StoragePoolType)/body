{
  StoragePool sp=null;
  Connect conn=null;
  try {
    conn=LibvirtConnection.getConnection();
  }
 catch (  LibvirtException e) {
    throw new CloudRuntimeException(e.toString());
  }
  try {
    sp=conn.storagePoolLookupByUUIDString(name);
    if (sp.getInfo().state != StoragePoolState.VIR_STORAGE_POOL_RUNNING) {
      sp.undefine();
      sp=null;
    }
  }
 catch (  LibvirtException e) {
  }
  if (sp == null) {
    if (type == StoragePoolType.NetworkFilesystem) {
      sp=createNfsStoragePool(conn,name,host,path);
    }
 else     if (type == StoragePoolType.SharedMountPoint || type == StoragePoolType.Filesystem) {
      sp=createSharedStoragePool(conn,name,host,path);
    }
 else     if (type == StoragePoolType.RBD) {
      sp=createRBDStoragePool(conn,name,host,port,userInfo,path);
    }
 else     if (type == StoragePoolType.CLVM) {
      sp=createCLVMStoragePool(conn,name,host,path);
    }
  }
  try {
    StoragePoolInfo spi=sp.getInfo();
    if (spi.state != StoragePoolState.VIR_STORAGE_POOL_RUNNING) {
      sp.create(0);
    }
    LibvirtStoragePoolDef spd=getStoragePoolDef(conn,sp);
    LibvirtStoragePool pool=new LibvirtStoragePool(name,sp.getName(),type,this,sp);
    if (pool.getType() != StoragePoolType.RBD) {
      pool.setLocalPath(spd.getTargetPath());
    }
 else {
      pool.setLocalPath("");
    }
    pool.setCapacity(sp.getInfo().capacity);
    pool.setUsed(sp.getInfo().allocation);
    return pool;
  }
 catch (  LibvirtException e) {
    throw new CloudRuntimeException(e.toString());
  }
}
