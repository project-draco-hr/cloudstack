{
  KVMPhysicalDisk newDisk;
  if (destPool.getType() != StoragePoolType.RBD) {
    if (disk.getFormat() == PhysicalDiskFormat.TAR) {
      newDisk=destPool.createPhysicalDisk(name,PhysicalDiskFormat.DIR,disk.getVirtualSize());
    }
 else {
      newDisk=destPool.createPhysicalDisk(name,disk.getVirtualSize());
    }
  }
 else {
    newDisk=new KVMPhysicalDisk(destPool.getSourceDir() + "/" + name,name,destPool);
    newDisk.setFormat(PhysicalDiskFormat.RAW);
    newDisk.setSize(disk.getVirtualSize());
    newDisk.setVirtualSize(disk.getSize());
  }
  KVMStoragePool srcPool=disk.getPool();
  String destPath=newDisk.getPath();
  String sourcePath=disk.getPath();
  PhysicalDiskFormat sourceFormat=disk.getFormat();
  PhysicalDiskFormat destFormat=newDisk.getFormat();
  if ((srcPool.getType() != StoragePoolType.RBD) && (destPool.getType() != StoragePoolType.RBD)) {
    if (sourceFormat == PhysicalDiskFormat.TAR) {
      Script.runSimpleBashScript("tar -x -f " + sourcePath + " -C "+ destPath);
    }
 else     if (sourceFormat == PhysicalDiskFormat.DIR) {
      Script.runSimpleBashScript("mkdir -p " + destPath);
      Script.runSimpleBashScript("chmod 755 " + destPath);
      Script.runSimpleBashScript("cp -p -r " + sourcePath + "/* "+ destPath);
    }
 else     if (sourceFormat.equals(destFormat) && Script.runSimpleBashScript("qemu-img info " + sourcePath + "|grep backing") == null) {
      Script.runSimpleBashScript("cp -f " + sourcePath + " "+ destPath);
    }
 else {
      Script.runSimpleBashScript("qemu-img convert -f " + sourceFormat + " -O "+ destFormat+ " "+ sourcePath+ " "+ destPath);
    }
  }
 else   if ((srcPool.getType() != StoragePoolType.RBD) && (destPool.getType() == StoragePoolType.RBD)) {
    Script.runSimpleBashScript("qemu-img convert -f " + sourceFormat + " -O "+ destFormat+ " "+ sourcePath+ " "+ KVMPhysicalDisk.RBDStringBuilder(destPool.getSourceHost(),destPool.getSourcePort(),destPool.getAuthUserName(),destPool.getAuthSecret(),destPath));
  }
 else {
    Script.runSimpleBashScript("qemu-img convert -f " + sourceFormat + " -O "+ destFormat+ " "+ KVMPhysicalDisk.RBDStringBuilder(srcPool.getSourceHost(),srcPool.getSourcePort(),srcPool.getAuthUserName(),srcPool.getAuthSecret(),sourcePath)+ " "+ KVMPhysicalDisk.RBDStringBuilder(destPool.getSourceHost(),destPool.getSourcePort(),destPool.getAuthUserName(),destPool.getAuthSecret(),destPath));
  }
  return newDisk;
}
