{
  TemplateFilter templateFilterObj;
  try {
    templateFilterObj=TemplateFilter.valueOf(templateFilter);
  }
 catch (  IllegalArgumentException e) {
    templateFilterObj=TemplateFilter.selfexecutable;
  }
  boolean isAdmin=false;
  boolean isAccountSpecific=true;
  Account account=(Account)UserContext.current().getAccount();
  if ((account == null) || (account.getType() == Account.ACCOUNT_TYPE_ADMIN) || (account.getType() == Account.ACCOUNT_TYPE_DOMAIN_ADMIN)) {
    isAdmin=true;
    if ((accountName == null) || (domainId == null)) {
      isAccountSpecific=false;
    }
  }
  boolean onlyReady=(templateFilterObj == TemplateFilter.featured) || (templateFilterObj == TemplateFilter.selfexecutable) || (templateFilterObj == TemplateFilter.sharedexecutable)|| (templateFilterObj == TemplateFilter.executable && isAccountSpecific)|| (templateFilterObj == TemplateFilter.community);
  boolean showDomr=(templateFilterObj != TemplateFilter.selfexecutable);
  List<VMTemplateVO> templates=(List<VMTemplateVO>)getResponseObject();
  ListResponse<TemplateResponse> response=new ListResponse<TemplateResponse>();
  List<TemplateResponse> templateResponses=new ArrayList<TemplateResponse>();
  for (  VMTemplateVO template : templates) {
    if (!showDomr && template.getId() == TemplateConstants.DEFAULT_SYSTEM_VM_DB_ID) {
      continue;
    }
    List<VMTemplateHostVO> templateHostRefsForTemplate=ApiDBUtils.listTemplateHostBy(template.getId(),zoneId);
    for (    VMTemplateHostVO templateHostRef : templateHostRefsForTemplate) {
      if (onlyReady && templateHostRef.getDownloadState() != Status.DOWNLOADED) {
        continue;
      }
      TemplateResponse templateResponse=new TemplateResponse();
      templateResponse.setId(template.getId());
      templateResponse.setName(template.getName());
      templateResponse.setDisplayText(template.getDisplayText());
      templateResponse.setPublic(template.isPublicTemplate());
      templateResponse.setCreated(templateHostRef.getCreated());
      if (template.getRemoved() != null) {
        templateResponse.setRemoved(template.getRemoved());
      }
      templateResponse.setReady(templateHostRef.getDownloadState() == Status.DOWNLOADED);
      templateResponse.setFeatured(template.isFeatured());
      templateResponse.setPasswordEnabled(template.getEnablePassword());
      templateResponse.setCrossZones(template.isCrossZones());
      templateResponse.setFormat(template.getFormat());
      if (template.getTemplateType() != null) {
        templateResponse.setTemplateType(template.getTemplateType().toString());
      }
      templateResponse.setHypervisor(template.getHypervisorType().toString());
      GuestOS os=ApiDBUtils.findGuestOSById(template.getGuestOSId());
      if (os != null) {
        templateResponse.setOsTypeId(os.getId());
        templateResponse.setOsTypeName(os.getDisplayName());
      }
 else {
        templateResponse.setOsTypeId(-1L);
        templateResponse.setOsTypeName("");
      }
      Account owner=ApiDBUtils.findAccountById(template.getAccountId());
      if (owner != null) {
        templateResponse.setAccount(owner.getAccountName());
        templateResponse.setDomainId(owner.getDomainId());
        templateResponse.setDomainName(ApiDBUtils.findDomainById(owner.getDomainId()).getName());
      }
      HostVO host=ApiDBUtils.findHostById(templateHostRef.getHostId());
      DataCenterVO datacenter=ApiDBUtils.findZoneById(host.getDataCenterId());
      templateResponse.setZoneId(host.getDataCenterId());
      templateResponse.setZoneName(datacenter.getName());
      if (isAdmin || account.getId() == template.getAccountId()) {
        if (templateHostRef.getDownloadState() != Status.DOWNLOADED) {
          String templateStatus="Processing";
          if (templateHostRef.getDownloadState() == VMTemplateHostVO.Status.DOWNLOAD_IN_PROGRESS) {
            if (templateHostRef.getDownloadPercent() == 100) {
              templateStatus="Installing Template";
            }
 else {
              templateStatus=templateHostRef.getDownloadPercent() + "% Downloaded";
            }
          }
 else {
            templateStatus=templateHostRef.getErrorString();
          }
          templateResponse.setStatus(templateStatus);
        }
 else         if (templateHostRef.getDownloadState() == VMTemplateHostVO.Status.DOWNLOADED) {
          templateResponse.setStatus("Download Complete");
        }
 else {
          templateResponse.setStatus("Successfully Installed");
        }
      }
      long templateSize=templateHostRef.getSize();
      if (templateSize > 0) {
        templateResponse.setSize(templateSize);
      }
      AsyncJobVO asyncJob=ApiDBUtils.findInstancePendingAsyncJob("vm_template",template.getId());
      if (asyncJob != null) {
        templateResponse.setJobId(asyncJob.getId());
        templateResponse.setJobStatus(asyncJob.getStatus());
      }
      templateResponse.setResponseName("template");
      templateResponses.add(templateResponse);
    }
  }
  response.setResponses(templateResponses);
  response.setResponseName(getName());
  return response;
}
