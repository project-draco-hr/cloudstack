{
  boolean copyToSecondary=cmd.toSecondaryStorage();
  String volumePath=cmd.getVolumePath();
  StorageFilerTO pool=cmd.getPool();
  String secondaryStorageUrl=cmd.getSecondaryStorageURL();
  KVMStoragePool secondaryStoragePool=null;
  KVMStoragePool primaryPool=null;
  try {
    try {
      primaryPool=_storagePoolMgr.getStoragePool(pool.getType(),pool.getUuid());
    }
 catch (    CloudRuntimeException e) {
      if (e.getMessage().contains("not found")) {
        primaryPool=_storagePoolMgr.createStoragePool(cmd.getPool().getUuid(),cmd.getPool().getHost(),cmd.getPool().getPort(),cmd.getPool().getPath(),cmd.getPool().getUserInfo(),cmd.getPool().getType());
      }
 else {
        return new CopyVolumeAnswer(cmd,false,e.getMessage(),null,null);
      }
    }
    String volumeName=UUID.randomUUID().toString();
    if (copyToSecondary) {
      String destVolumeName=volumeName + ".qcow2";
      KVMPhysicalDisk volume=primaryPool.getPhysicalDisk(cmd.getVolumePath());
      String volumeDestPath="/volumes/" + cmd.getVolumeId() + File.separator;
      secondaryStoragePool=_storagePoolMgr.getStoragePoolByURI(secondaryStorageUrl);
      secondaryStoragePool.createFolder(volumeDestPath);
      secondaryStoragePool.delete();
      secondaryStoragePool=_storagePoolMgr.getStoragePoolByURI(secondaryStorageUrl + volumeDestPath);
      _storagePoolMgr.copyPhysicalDisk(volume,destVolumeName,secondaryStoragePool);
      return new CopyVolumeAnswer(cmd,true,null,null,volumeName);
    }
 else {
      volumePath="/volumes/" + cmd.getVolumeId() + File.separator;
      secondaryStoragePool=_storagePoolMgr.getStoragePoolByURI(secondaryStorageUrl + volumePath);
      KVMPhysicalDisk volume=secondaryStoragePool.getPhysicalDisk(cmd.getVolumePath() + ".qcow2");
      _storagePoolMgr.copyPhysicalDisk(volume,volumeName,primaryPool);
      return new CopyVolumeAnswer(cmd,true,null,null,volumeName);
    }
  }
 catch (  CloudRuntimeException e) {
    return new CopyVolumeAnswer(cmd,false,e.toString(),null,null);
  }
 finally {
    if (secondaryStoragePool != null) {
      secondaryStoragePool.delete();
    }
  }
}
