{
  final String templateFolder=cmd.getAccountId() + File.separator + cmd.getNewTemplateId();
  final String templateInstallFolder="template/tmpl/" + templateFolder;
  final String tmplName=UUID.randomUUID().toString();
  final String tmplFileName=tmplName + ".qcow2";
  KVMStoragePool secondaryPool=null;
  KVMStoragePool snapshotPool=null;
  try {
    String snapshotPath=cmd.getSnapshotUuid();
    final int index=snapshotPath.lastIndexOf("/");
    snapshotPath=snapshotPath.substring(0,index);
    snapshotPool=_storagePoolMgr.getStoragePoolByURI(cmd.getSecondaryStorageUrl() + snapshotPath);
    final KVMPhysicalDisk snapshot=snapshotPool.getPhysicalDisk(cmd.getSnapshotName());
    secondaryPool=_storagePoolMgr.getStoragePoolByURI(cmd.getSecondaryStorageUrl());
    final String templatePath=secondaryPool.getLocalPath() + File.separator + templateInstallFolder;
    _storage.mkdirs(templatePath);
    final String tmplPath=templateInstallFolder + File.separator + tmplFileName;
    final Script command=new Script(_createTmplPath,_cmdsTimeout,s_logger);
    command.add("-t",templatePath);
    command.add("-n",tmplFileName);
    command.add("-f",snapshot.getPath());
    command.execute();
    final Map<String,Object> params=new HashMap<String,Object>();
    params.put(StorageLayer.InstanceConfigKey,_storage);
    final Processor qcow2Processor=new QCOW2Processor();
    qcow2Processor.configure("QCOW2 Processor",params);
    final FormatInfo info=qcow2Processor.process(templatePath,null,tmplName);
    final TemplateLocation loc=new TemplateLocation(_storage,templatePath);
    loc.create(1,true,tmplName);
    loc.addFormat(info);
    loc.save();
    return new CreatePrivateTemplateAnswer(cmd,true,"",tmplPath,info.virtualSize,info.size,tmplName,info.format);
  }
 catch (  final ConfigurationException e) {
    return new CreatePrivateTemplateAnswer(cmd,false,e.getMessage());
  }
catch (  final InternalErrorException e) {
    return new CreatePrivateTemplateAnswer(cmd,false,e.getMessage());
  }
catch (  final IOException e) {
    return new CreatePrivateTemplateAnswer(cmd,false,e.getMessage());
  }
catch (  final CloudRuntimeException e) {
    return new CreatePrivateTemplateAnswer(cmd,false,e.getMessage());
  }
 finally {
    if (secondaryPool != null) {
      _storagePoolMgr.deleteStoragePool(secondaryPool.getType(),secondaryPool.getUuid());
    }
    if (snapshotPool != null) {
      _storagePoolMgr.deleteStoragePool(snapshotPool.getType(),snapshotPool.getUuid());
    }
  }
}
