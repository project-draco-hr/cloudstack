{
  final String vmName=cmd.getVmName();
  if (cmd.checkBeforeCleanup()) {
    try {
      final Connect conn=LibvirtConnection.getConnectionByVmName(vmName);
      final Domain vm=conn.domainLookupByName(cmd.getVmName());
      if (vm != null && vm.getInfo().state == DomainState.VIR_DOMAIN_RUNNING) {
        return new StopAnswer(cmd,"vm is still running on host",false);
      }
    }
 catch (    final Exception e) {
      s_logger.debug("Failed to get vm status in case of checkboforecleanup is true",e);
    }
  }
  try {
    final Connect conn=LibvirtConnection.getConnectionByVmName(vmName);
    final List<DiskDef> disks=getDisks(conn,vmName);
    final List<InterfaceDef> ifaces=getInterfaces(conn,vmName);
    destroyNetworkRulesForVM(conn,vmName);
    final String result=stopVM(conn,vmName);
    if (result == null) {
      for (      final DiskDef disk : disks) {
        cleanupDisk(disk);
      }
      for (      final InterfaceDef iface : ifaces) {
        for (        final VifDriver vifDriver : getAllVifDrivers()) {
          vifDriver.unplug(iface);
        }
      }
    }
    return new StopAnswer(cmd,result,true);
  }
 catch (  final LibvirtException e) {
    return new StopAnswer(cmd,e.getMessage(),false);
  }
}
