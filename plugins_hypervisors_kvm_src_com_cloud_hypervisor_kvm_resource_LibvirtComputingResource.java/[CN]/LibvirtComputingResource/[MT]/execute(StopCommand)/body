{
  final String vmName=cmd.getVmName();
  State state=null;
synchronized (_vms) {
    state=_vms.get(vmName);
    _vms.put(vmName,State.Stopping);
  }
  try {
    Connect conn=LibvirtConnection.getConnectionByVmName(vmName);
    List<DiskDef> disks=getDisks(conn,vmName);
    List<InterfaceDef> ifaces=getInterfaces(conn,vmName);
    destroy_network_rules_for_vm(conn,vmName);
    String result=stopVM(conn,vmName);
    if (result == null) {
      for (      DiskDef disk : disks) {
        if (disk.getDeviceType() == DiskDef.deviceType.CDROM && disk.getDiskPath() != null) {
          cleanupDisk(conn,disk);
        }
      }
      for (      InterfaceDef iface : ifaces) {
        for (        VifDriver vifDriver : getAllVifDrivers()) {
          vifDriver.unplug(iface);
        }
      }
    }
    state=State.Stopped;
    return new StopAnswer(cmd,result,0,true);
  }
 catch (  LibvirtException e) {
    return new StopAnswer(cmd,e.getMessage(),false);
  }
 finally {
synchronized (_vms) {
      if (state != null) {
        _vms.put(vmName,state);
      }
 else {
        _vms.remove(vmName);
      }
    }
  }
}
