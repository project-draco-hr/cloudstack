{
  VirtualMachineTO vm=cmd.getVirtualMachine();
  if (s_logger.isDebugEnabled()) {
    s_logger.debug("Preparing host for migrating " + vm);
  }
  NicTO[] nics=vm.getNics();
  boolean success=false;
  try {
    Connect conn=LibvirtConnection.getConnectionByVmName(vm.getName());
    for (    NicTO nic : nics) {
      getVifDriver(nic.getType()).plug(nic,null);
    }
    DiskTO[] volumes=vm.getDisks();
    for (    DiskTO volume : volumes) {
      if (volume.getType() == Volume.Type.ISO) {
        getVolumePath(conn,volume);
      }
    }
    _storagePoolMgr.connectPhysicalDisksViaVmSpec(vm);
synchronized (_vms) {
      _vms.put(vm.getName(),State.Migrating);
    }
    success=true;
    return new PrepareForMigrationAnswer(cmd);
  }
 catch (  LibvirtException e) {
    return new PrepareForMigrationAnswer(cmd,e.toString());
  }
catch (  InternalErrorException e) {
    return new PrepareForMigrationAnswer(cmd,e.toString());
  }
catch (  URISyntaxException e) {
    return new PrepareForMigrationAnswer(cmd,e.toString());
  }
 finally {
    if (!success) {
      _storagePoolMgr.disconnectPhysicalDisksViaVmSpec(vm);
    }
  }
}
