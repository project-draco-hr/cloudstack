{
  final VirtualMachineTO vm=cmd.getVirtualMachine();
  if (s_logger.isDebugEnabled()) {
    s_logger.debug("Preparing host for migrating " + vm);
  }
  final NicTO[] nics=vm.getNics();
  boolean skipDisconnect=false;
  try {
    final Connect conn=LibvirtConnection.getConnectionByVmName(vm.getName());
    for (    final NicTO nic : nics) {
      getVifDriver(nic.getType()).plug(nic,null,"");
    }
    final DiskTO[] volumes=vm.getDisks();
    for (    final DiskTO volume : volumes) {
      if (volume.getType() == Volume.Type.ISO) {
        getVolumePath(conn,volume);
      }
    }
    if (!_storagePoolMgr.connectPhysicalDisksViaVmSpec(vm)) {
      skipDisconnect=true;
      return new PrepareForMigrationAnswer(cmd,"failed to connect physical disks to host");
    }
    skipDisconnect=true;
    return new PrepareForMigrationAnswer(cmd);
  }
 catch (  final LibvirtException e) {
    return new PrepareForMigrationAnswer(cmd,e.toString());
  }
catch (  final InternalErrorException e) {
    return new PrepareForMigrationAnswer(cmd,e.toString());
  }
catch (  final URISyntaxException e) {
    return new PrepareForMigrationAnswer(cmd,e.toString());
  }
 finally {
    if (!skipDisconnect) {
      _storagePoolMgr.disconnectPhysicalDisksViaVmSpec(vm);
    }
  }
}
