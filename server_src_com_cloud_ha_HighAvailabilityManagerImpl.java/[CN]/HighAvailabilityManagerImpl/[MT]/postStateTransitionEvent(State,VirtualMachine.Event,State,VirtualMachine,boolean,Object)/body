{
  if (oldState == State.Running && event == VirtualMachine.Event.FollowAgentPowerOffReport && newState == State.Stopped) {
    final VMInstanceVO vm=_instanceDao.findById(vo.getId());
    if (vm.isHaEnabled()) {
      if (vm.getState() == State.Stopped)       s_logger.warn("Sanity check failed. postStateTransitionEvent reports transited to Stopped but VM " + vm + " is still at state "+ vm.getState());
      s_logger.info("Detected out-of-band stop of a HA enabled VM " + vm.getInstanceName() + ", will schedule restart");
      _executor.submit(new ManagedContextRunnable(){
        @Override protected void runInContext(){
          try {
            scheduleRestart(vm,true);
          }
 catch (          Exception e) {
            s_logger.warn("Unexpected exception when scheduling a HA restart",e);
          }
        }
      }
);
    }
  }
  return true;
}
