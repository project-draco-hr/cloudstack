{
  Long hostId=vm.getHostId();
  if (hostId == null) {
    try {
      s_logger.debug("Found a vm that is scheduled to be restarted but has no host id: " + vm);
      _itMgr.stateTransitTo(vm,Event.OperationFailed,null);
    }
 catch (    NoTransitionException e) {
    }
    return;
  }
  if (vm.getHypervisorType() == HypervisorType.VMware) {
    s_logger.info("Skip HA for VMware VM " + vm.getInstanceName());
    return;
  }
  if (!investigate) {
    if (s_logger.isDebugEnabled()) {
      s_logger.debug("VM does not require investigation so I'm marking it as Stopped: " + vm.toString());
    }
    short alertType=AlertManager.ALERT_TYPE_USERVM;
    if (VirtualMachine.Type.DomainRouter.equals(vm.getType())) {
      alertType=AlertManager.ALERT_TYPE_DOMAIN_ROUTER;
    }
 else     if (VirtualMachine.Type.ConsoleProxy.equals(vm.getType())) {
      alertType=AlertManager.ALERT_TYPE_CONSOLE_PROXY;
    }
    if (!(_forceHA || vm.isHaEnabled())) {
      String hostDesc="id:" + vm.getHostId() + ", availability zone id:"+ vm.getDataCenterIdToDeployIn()+ ", pod id:"+ vm.getPodIdToDeployIn();
      _alertMgr.sendAlert(alertType,vm.getDataCenterIdToDeployIn(),vm.getPodIdToDeployIn(),"VM (name: " + vm.getHostName() + ", id: "+ vm.getId()+ ") stopped unexpectedly on host "+ hostDesc,"Virtual Machine " + vm.getHostName() + " (id: "+ vm.getId()+ ") running on host ["+ vm.getHostId()+ "] stopped unexpectedly.");
      if (s_logger.isDebugEnabled()) {
        s_logger.debug("VM is not HA enabled so we're done.");
      }
    }
    try {
      _itMgr.advanceStop(vm,true,_accountMgr.getSystemUser(),_accountMgr.getSystemAccount());
    }
 catch (    ResourceUnavailableException e) {
    }
catch (    OperationTimedoutException e) {
    }
catch (    ConcurrentOperationException e) {
    }
  }
  List<HaWorkVO> items=_haDao.findPreviousHA(vm.getId());
  int maxRetries=0;
  for (  HaWorkVO item : items) {
    if (maxRetries < item.getTimesTried() && !item.canScheduleNew(_timeBetweenFailures)) {
      maxRetries=item.getTimesTried();
      break;
    }
  }
  HaWorkVO work=new HaWorkVO(vm.getId(),vm.getType(),WorkType.HA,investigate ? Step.Investigating : Step.Scheduled,hostId,vm.getState(),maxRetries + 1,vm.getUpdated());
  _haDao.persist(work);
  if (s_logger.isInfoEnabled()) {
    s_logger.info("Schedule vm for HA:  " + vm);
  }
  wakeupWorkers();
}
