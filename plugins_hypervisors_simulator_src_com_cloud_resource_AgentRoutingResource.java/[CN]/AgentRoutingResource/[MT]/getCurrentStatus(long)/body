{
  TransactionLegacy txn=TransactionLegacy.open(TransactionLegacy.SIMULATOR_DB);
  try {
    MockConfigurationVO config=_simMgr.getMockConfigurationDao().findByNameBottomUP(agentHost.getDataCenterId(),agentHost.getPodId(),agentHost.getClusterId(),agentHost.getId(),"PingCommand");
    if (config != null) {
      Map<String,String> configParameters=config.getParameters();
      for (      Map.Entry<String,String> entry : configParameters.entrySet()) {
        if (entry.getKey().equalsIgnoreCase("result")) {
          String value=entry.getValue();
          if (value.equalsIgnoreCase("fail")) {
            return null;
          }
        }
      }
    }
  }
 catch (  Exception e) {
    txn.rollback();
  }
 finally {
    txn.close();
    txn=TransactionLegacy.open(TransactionLegacy.CLOUD_DB);
    txn.close();
  }
  if (isStopped()) {
    return null;
  }
synchronized (_vms) {
    if (_vms.size() == 0) {
      _vms.putAll(_simMgr.getVmStates(hostGuid));
    }
  }
  final HashMap<String,State> newStates=sync();
  HashMap<String,Pair<Long,Long>> nwGrpStates=_simMgr.syncNetworkGroups(hostGuid);
  return new PingRoutingWithNwGroupsCommand(getType(),id,newStates,getHostVmStateReport(),nwGrpStates);
}
