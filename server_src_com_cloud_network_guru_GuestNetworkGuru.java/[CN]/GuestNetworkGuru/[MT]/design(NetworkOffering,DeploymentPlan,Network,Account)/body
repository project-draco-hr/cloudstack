{
  if (offering.getTrafficType() != TrafficType.Guest || offering.getGuestIpType() != GuestIpType.Virtual) {
    return null;
  }
  BroadcastDomainType broadcastType=null;
  Mode mode=null;
  GuestIpType ipType=offering.getGuestIpType();
  if (ipType == GuestIpType.Virtual) {
    mode=Mode.Dhcp;
    broadcastType=BroadcastDomainType.Vlan;
  }
 else {
    broadcastType=BroadcastDomainType.Native;
    mode=Mode.Dhcp;
  }
  DataCenterVO dc=_dcDao.findById(plan.getDataCenterId());
  NetworkVO network=new NetworkVO(offering.getTrafficType(),offering.getGuestIpType(),mode,broadcastType,offering.getId(),plan.getDataCenterId());
  if (userSpecified != null) {
    if ((userSpecified.getCidr() == null && userSpecified.getGateway() != null) || (userSpecified.getCidr() != null && userSpecified.getGateway() == null)) {
      throw new InvalidParameterValueException("cidr and gateway must be specified together.");
    }
    if (userSpecified.getCidr() != null) {
      network.setCidr(userSpecified.getCidr());
      network.setGateway(userSpecified.getGateway());
    }
 else {
      String guestNetworkCidr=dc.getGuestNetworkCidr();
      if (guestNetworkCidr != null) {
        String[] cidrTuple=guestNetworkCidr.split("\\/");
        network.setGateway(NetUtils.getIpRangeStartIpFromCidr(cidrTuple[0],Long.parseLong(cidrTuple[1])));
        network.setCidr(guestNetworkCidr);
      }
    }
    network.setDns1(dc.getDns1());
    network.setDns2(dc.getDns2());
    if (userSpecified.getBroadcastUri() != null) {
      network.setBroadcastUri(userSpecified.getBroadcastUri());
      network.setState(State.Setup);
    }
  }
 else {
    String guestNetworkCidr=dc.getGuestNetworkCidr();
    String[] cidrTuple=guestNetworkCidr.split("\\/");
    network.setGateway(NetUtils.getIpRangeStartIpFromCidr(cidrTuple[0],Long.parseLong(cidrTuple[1])));
    network.setCidr(guestNetworkCidr);
    network.setDns1(dc.getDns1());
    network.setDns2(dc.getDns2());
  }
  return network;
}
