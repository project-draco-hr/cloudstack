{
  FirewallRuleVO[] rules=new FirewallRuleVO[ports.length];
  Transaction txn=Transaction.currentTxn();
  txn.start();
  for (int i=0; i < ports.length; i++) {
    rules[i]=new FirewallRuleVO(null,ip.getAddress(),ports[i],protocol,ip.getAssociatedWithNetworkId(),ip.getAllocatedToAccountId(),ip.getAllocatedInDomainId(),purpose);
    rules[i]=_firewallDao.persist(rules[i]);
  }
  txn.commit();
  boolean success=false;
  try {
    for (    FirewallRuleVO newRule : rules) {
      detectRulesConflict(newRule,ip);
    }
    success=true;
    return rules;
  }
  finally {
    if (!success) {
      txn.start();
      for (      FirewallRuleVO newRule : rules) {
        _forwardingDao.remove(newRule.getId());
      }
      txn.commit();
    }
  }
}
