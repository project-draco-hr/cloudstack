{
  Account caller=UserContext.current().getCaller();
  List<PortForwardingRuleVO> rules=null;
  if (cmd.getIpAddress() != null) {
    Ip ipAddress=new Ip(cmd.getIpAddress());
    IPAddressVO ipAddressVO=_ipAddressDao.findById(ipAddress);
    if (ipAddressVO == null || !ipAddressVO.readyToUse()) {
      throw new InvalidParameterValueException("Ip address not ready for port forwarding rules yet: " + ipAddress);
    }
    rules=_forwardingDao.listByIp(ipAddress);
    _accountMgr.checkAccess(caller,rules.toArray(new PortForwardingRuleVO[rules.size()]));
  }
 else {
    rules=_forwardingDao.listByAccount(caller.getAccountId());
  }
  return rules;
}
