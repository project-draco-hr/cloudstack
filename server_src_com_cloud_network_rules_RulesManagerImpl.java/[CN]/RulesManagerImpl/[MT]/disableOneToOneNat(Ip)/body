{
  Account caller=UserContext.current().getCaller();
  IPAddressVO ipAddress=_ipAddressDao.findById(ip);
  checkIpAndUserVm(ipAddress,null,caller);
  if (!ipAddress.isOneToOneNat()) {
    throw new InvalidParameterValueException("One to one nat is not enabled for the ip: " + ip.addr());
  }
  List<FirewallRuleVO> rules=_firewallDao.listByIpAndNotRevoked(ip,true);
  if (rules != null) {
    for (    FirewallRuleVO rule : rules) {
      rule.setState(State.Revoke);
      _firewallDao.update(rule.getId(),rule);
      UsageEventVO usageEvent=new UsageEventVO(EventTypes.EVENT_NET_RULE_DELETE,rule.getAccountId(),0,rule.getId(),null);
      _usageEventDao.persist(usageEvent);
    }
  }
  if (applyPortForwardingRules(ip,true)) {
    ipAddress.setOneToOneNat(false);
    ipAddress.setAssociatedWithVmId(null);
    _ipAddressDao.update(ipAddress.getAddress(),ipAddress);
    return true;
  }
 else {
    s_logger.warn("Failed to disable one to one nat for the ip address " + ip.addr());
    return false;
  }
}
