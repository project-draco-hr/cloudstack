{
  Map<Network.Service,Set<Network.Provider>> svcProviderMap=new HashMap<Network.Service,Set<Network.Provider>>();
  Set<Network.Provider> defaultProviders=new HashSet<Network.Provider>();
  defaultProviders.add(Provider.VPCVirtualRouter);
  Set<Network.Provider> sdnProviders=new HashSet<Network.Provider>();
  sdnProviders.add(Provider.NiciraNvp);
  sdnProviders.add(Provider.JuniperContrailVpcRouter);
  boolean sourceNatSvc=false;
  boolean firewallSvs=false;
  for (  String serviceName : supportedServices) {
    Service service=Network.Service.getService(serviceName);
    if (service == null || nonSupportedServices.contains(service)) {
      throw new InvalidParameterValueException("Service " + serviceName + " is not supported in VPC");
    }
    if (service == Service.Connectivity) {
      s_logger.debug("Applying Connectivity workaround, setting provider to NiciraNvp");
      svcProviderMap.put(service,sdnProviders);
    }
 else {
      svcProviderMap.put(service,defaultProviders);
    }
    if (service == Service.NetworkACL) {
      firewallSvs=true;
    }
    if (service == Service.SourceNat) {
      sourceNatSvc=true;
    }
  }
  if (!sourceNatSvc) {
    s_logger.debug("Automatically adding source nat service to the list of VPC services");
    svcProviderMap.put(Service.SourceNat,defaultProviders);
  }
  if (!firewallSvs) {
    s_logger.debug("Automatically adding network ACL service to the list of VPC services");
    svcProviderMap.put(Service.NetworkACL,defaultProviders);
  }
  svcProviderMap.put(Service.Gateway,defaultProviders);
  if (serviceProviders != null) {
    for (    Entry<String,List<String>> serviceEntry : serviceProviders.entrySet()) {
      Network.Service service=Network.Service.getService(serviceEntry.getKey());
      if (svcProviderMap.containsKey(service)) {
        Set<Provider> providers=new HashSet<Provider>();
        if (serviceEntry.getValue() != null && serviceEntry.getValue().size() > 1) {
          throw new InvalidParameterValueException("In the current release only one provider can be " + "specified for the service");
        }
        for (        String prvNameStr : serviceEntry.getValue()) {
          Network.Provider provider=Network.Provider.getProvider(prvNameStr);
          if (provider == null) {
            throw new InvalidParameterValueException("Invalid service provider: " + prvNameStr);
          }
          providers.add(provider);
        }
        svcProviderMap.put(service,providers);
      }
 else {
        throw new InvalidParameterValueException("Service " + serviceEntry.getKey() + " is not enabled for the network "+ "offering, can't add a provider to it");
      }
    }
  }
  validateConnectivtyServiceCapablitlies(svcProviderMap.get(Service.Connectivity),serviceCapabilitystList);
  boolean supportsDistributedRouter=isVpcOfferingSupportsDistributedRouter(serviceCapabilitystList);
  VpcOffering offering=createVpcOffering(name,displayText,svcProviderMap,false,null,serviceOfferingId,supportsDistributedRouter);
  CallContext.current().setEventDetails(" Id: " + offering.getId() + " Name: "+ name);
  return offering;
}
