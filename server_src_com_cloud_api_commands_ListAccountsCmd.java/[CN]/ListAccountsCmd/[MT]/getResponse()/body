{
  List<AccountVO> accounts=(List<AccountVO>)getResponseObject();
  List<AccountResponse> response=new ArrayList<AccountResponse>();
  for (  AccountVO account : accounts) {
    boolean accountIsAdmin=(account.getType() == Account.ACCOUNT_TYPE_ADMIN);
    AccountResponse acctResponse=new AccountResponse();
    acctResponse.setId(account.getId());
    acctResponse.setName(account.getAccountName());
    acctResponse.setAccountType(account.getType());
    acctResponse.setDomainId(account.getDomainId());
    acctResponse.setDomainName(getManagementServer().findDomainIdById(account.getDomainId()).getName());
    List<UserStatisticsVO> stats=getManagementServer().listUserStatsBy(account.getId());
    if (stats == null) {
      throw new ServerApiException(BaseCmd.INTERNAL_ERROR,"Internal error searching for user stats");
    }
    long bytesSent=0;
    long bytesReceived=0;
    for (    UserStatisticsVO stat : stats) {
      long rx=stat.getNetBytesReceived() + stat.getCurrentBytesReceived();
      long tx=stat.getNetBytesSent() + stat.getCurrentBytesSent();
      bytesReceived=bytesReceived + Long.valueOf(rx);
      bytesSent=bytesSent + Long.valueOf(tx);
    }
    acctResponse.setBytesReceived(bytesReceived);
    acctResponse.setBytesSent(bytesSent);
    long vmLimit=getManagementServer().findCorrectResourceLimit(ResourceType.user_vm,account.getId());
    String vmLimitDisplay=(accountIsAdmin || vmLimit == -1) ? "Unlimited" : String.valueOf(vmLimit);
    long vmTotal=getManagementServer().getResourceCount(ResourceType.user_vm,account.getId());
    String vmAvail=(accountIsAdmin || vmLimit == -1) ? "Unlimited" : String.valueOf(vmLimit - vmTotal);
    acctResponse.setVmLimit(vmLimitDisplay);
    acctResponse.setVmTotal(vmTotal);
    acctResponse.setVmAvailable(vmAvail);
    long ipLimit=getManagementServer().findCorrectResourceLimit(ResourceType.public_ip,account.getId());
    String ipLimitDisplay=(accountIsAdmin || ipLimit == -1) ? "Unlimited" : String.valueOf(ipLimit);
    long ipTotal=getManagementServer().getResourceCount(ResourceType.public_ip,account.getId());
    String ipAvail=(accountIsAdmin || ipLimit == -1) ? "Unlimited" : String.valueOf(ipLimit - ipTotal);
    acctResponse.setIpLimit(ipLimitDisplay);
    acctResponse.setIpTotal(ipTotal);
    acctResponse.setIpAvailable(ipAvail);
    long volumeLimit=getManagementServer().findCorrectResourceLimit(ResourceType.volume,account.getId());
    String volumeLimitDisplay=(accountIsAdmin || volumeLimit == -1) ? "Unlimited" : String.valueOf(volumeLimit);
    long volumeTotal=getManagementServer().getResourceCount(ResourceType.volume,account.getId());
    String volumeAvail=(accountIsAdmin || volumeLimit == -1) ? "Unlimited" : String.valueOf(volumeLimit - volumeTotal);
    acctResponse.setVolumeLimit(volumeLimitDisplay);
    acctResponse.setVolumeTotal(volumeTotal);
    acctResponse.setVolumeAvailable(volumeAvail);
    long snapshotLimit=getManagementServer().findCorrectResourceLimit(ResourceType.snapshot,accountO.getId());
    String snapshotLimitDisplay=(accountIsAdmin || snapshotLimit == -1) ? "Unlimited" : String.valueOf(snapshotLimit);
    long snapshotTotal=getManagementServer().getResourceCount(ResourceType.snapshot,accountO.getId());
    String snapshotAvail=(accountIsAdmin || snapshotLimit == -1) ? "Unlimited" : String.valueOf(snapshotLimit - snapshotTotal);
    acctResponse.setSnapshotLimit(snapshotLimitDisplay);
    acctResponse.setSnapshotTotal(snapshotTotal);
    acctResponse.setSnapshotAvailable(snapshotAvail);
    long templateLimit=getManagementServer().findCorrectResourceLimit(ResourceType.template,accountO.getId());
    String templateLimitDisplay=(accountIsAdmin || templateLimit == -1) ? "Unlimited" : String.valueOf(templateLimit);
    long templateTotal=getManagementServer().getResourceCount(ResourceType.template,accountO.getId());
    String templateAvail=(accountIsAdmin || templateLimit == -1) ? "Unlimited" : String.valueOf(templateLimit - templateTotal);
    acctResponse.setTemplateLimit(templateLimitDisplay);
    acctResponse.setTemplateTotal(templateTotal);
    acctResponse.setTemplateAvailable(templateAvail);
    int vmStopped=0;
    int vmRunning=0;
    Long[] accountIds=new Long[1];
    accountIds[0]=account.getId();
    Criteria c1=new Criteria();
    c1.addCriteria(Criteria.ACCOUNTID,accountIds);
    List<? extends UserVm> virtualMachines=getManagementServer().searchForUserVMs(c1);
    for (Iterator<? extends UserVm> iter=virtualMachines.iterator(); iter.hasNext(); ) {
      UserVm vm=iter.next();
      if (vm.getState() == State.Stopped) {
        vmStopped++;
      }
 else       if (vm.getState() == State.Running) {
        vmRunning++;
      }
    }
    acctResponse.setVmStopped(vmStopped);
    acctResponse.setVmRunning(vmRunning);
    Account ctxAccount=(Account)UserContext.current().getAccountObject();
    if ((ctxAccount == null) || isAdmin(ctxAccount.getType())) {
      acctResponse.setState(account.getState());
      acctResponse.setCleanupRequired(account.getNeedsCleanup());
    }
    response.add(acctResponse);
  }
  return SerializerHelper.toSerializedString(response);
}
