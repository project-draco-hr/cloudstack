{
  String ruleName=genFirewallRuleName(rule.getId());
switch (prim) {
case CHECK_IF_EXISTS:
    Map<String,String> params=new HashMap<String,String>();
  params.put("type","config");
params.put("action","get");
params.put("xpath","/config/devices/entry/vsys/entry[@name='vsys1']/rulebase/security/rules/entry[@name='" + ruleName + "']");
String response=request(PaloAltoMethod.GET,params);
boolean result=(validResponse(response) && responseNotEmpty(response));
s_logger.debug("Firewall policy exists: " + ruleName + ", "+ result);
return result;
case ADD:
if (manageFirewallRule(cmdList,PaloAltoPrimative.CHECK_IF_EXISTS,rule)) {
return true;
}
String srcZone;
String dstZone;
String dstAddressXML;
String appXML;
String serviceXML;
String protocol=rule.getProtocol();
if (protocol.equals(Protocol.ICMP.toString())) {
appXML="<member>icmp</member><member>ping</member><member>traceroute</member>";
}
 else {
appXML="<member>any</member>";
}
if (protocol.equals(Protocol.TCP.toString()) || protocol.equals(Protocol.UDP.toString())) {
String portRange;
if (rule.getSrcPortRange() != null) {
int startPort=rule.getSrcPortRange()[0];
int endPort=rule.getSrcPortRange()[1];
if (startPort == endPort) {
portRange=String.valueOf(startPort);
}
 else {
portRange=String.valueOf(startPort) + "-" + String.valueOf(endPort);
}
manageService(cmdList,PaloAltoPrimative.ADD,protocol,portRange,null);
serviceXML="<member>" + genServiceName(protocol,portRange,null) + "</member>";
}
 else {
serviceXML="<member>any</member>";
}
}
 else {
serviceXML="<member>any</member>";
}
if (rule.getTrafficType() == FirewallRule.TrafficType.Egress) {
srcZone=_privateZone;
dstZone=_publicZone;
dstAddressXML="<member>any</member>";
}
 else {
srcZone=_publicZone;
dstZone=_privateZone;
dstAddressXML="<member>" + rule.getSrcIp() + "</member>";
}
String srcCidrXML="";
List<String> ruleSrcCidrList=rule.getSourceCidrList();
if (ruleSrcCidrList.size() > 0) {
for (int i=0; i < ruleSrcCidrList.size(); i++) {
if (ruleSrcCidrList.get(i).trim().equals("0.0.0.0/0")) {
if (rule.getTrafficType() == FirewallRule.TrafficType.Egress) {
srcCidrXML+="<member>" + getPrivateSubnet(rule.getSrcVlanTag()) + "</member>";
}
 else {
srcCidrXML+="<member>any</member>";
}
}
 else {
srcCidrXML+="<member>" + ruleSrcCidrList.get(i).trim() + "</member>";
}
}
}
 else {
if (rule.getTrafficType() == FirewallRule.TrafficType.Egress) {
srcCidrXML="<member>" + getPrivateSubnet(rule.getSrcVlanTag()) + "</member>";
}
 else {
srcCidrXML="<member>any</member>";
}
}
String xml="";
xml+="<from><member>" + srcZone + "</member></from>";
xml+="<to><member>" + dstZone + "</member></to>";
xml+="<source>" + srcCidrXML + "</source>";
xml+="<destination>" + dstAddressXML + "</destination>";
xml+="<application>" + appXML + "</application>";
xml+="<service>" + serviceXML + "</service>";
xml+="<action>allow</action>";
xml+="<negate-source>no</negate-source>";
xml+="<negate-destination>no</negate-destination>";
if (_threatProfile != null) {
xml+="<profile-setting><group><member>" + _threatProfile + "</member></group></profile-setting>";
}
if (_logProfile != null) {
xml+="<log-setting>" + _logProfile + "</log-setting>";
}
Map<String,String> a_params=new HashMap<String,String>();
a_params.put("type","config");
a_params.put("action","set");
a_params.put("xpath","/config/devices/entry/vsys/entry[@name='vsys1']/rulebase/security/rules/entry[@name='" + ruleName + "']");
a_params.put("element",xml);
cmdList.add(new DefaultPaloAltoCommand(PaloAltoMethod.POST,a_params));
return true;
case DELETE:
if (!manageFirewallRule(cmdList,PaloAltoPrimative.CHECK_IF_EXISTS,rule)) {
return true;
}
Map<String,String> d_params=new HashMap<String,String>();
d_params.put("type","config");
d_params.put("action","delete");
d_params.put("xpath","/config/devices/entry/vsys/entry[@name='vsys1']/rulebase/security/rules/entry[@name='" + ruleName + "']");
cmdList.add(new DefaultPaloAltoCommand(PaloAltoMethod.POST,d_params));
return true;
default :
s_logger.debug("Unrecognized command.");
return false;
}
}
