{
  AclPolicy policy=new AclPolicyVO("policy1","tester policy1");
  List<AclPolicy> policies=new ArrayList<AclPolicy>();
  policies.add(policy);
  Long policyId=policy.getId();
  Long resId=200L;
  Class clz=ListVMsCmd.class;
  when(_apiServer.getCmdClass("listVirtualMachines")).thenReturn(clz);
  when(_iamSrv.addAclPermissionToAclPolicy(policyId,AclEntityType.VirtualMachine.toString(),PermissionScope.RESOURCE.toString(),resId,"listVirtualMachines",AccessType.ListEntry.toString(),Permission.Allow,false)).thenReturn(policy);
  _aclSrv.addAclPermissionToAclPolicy(policyId,AclEntityType.VirtualMachine.toString(),PermissionScope.RESOURCE,resId,"listVirtualMachines",Permission.Allow,false);
  Pair<List<AclPolicy>,Integer> policyList=new Pair<List<AclPolicy>,Integer>(policies,1);
  List<AclPolicyPermission> policyPerms=new ArrayList<AclPolicyPermission>();
  AclPolicyPermission perm=new AclPolicyPermissionVO(policyId,"listVirtualMachines",AclEntityType.VirtualMachine.toString(),AccessType.ListEntry.toString(),PermissionScope.RESOURCE.toString(),resId,Permission.Allow,false);
  policyPerms.add(perm);
  when(_iamSrv.listAclPolicies(null,"policy1",callerDomainPath,0L,20L)).thenReturn(policyList);
  when(_iamSrv.listPolicyPermissions(policyId)).thenReturn(policyPerms);
  ListResponse<AclPolicyResponse> policyResp=_aclSrv.listAclPolicies(null,"policy1",callerDomainId,0L,20L);
  assertTrue("No. of response items should be one",policyResp.getCount() == 1);
  AclPolicyResponse resp=policyResp.getResponses().get(0);
  Set<AclPermissionResponse> permList=resp.getPermissionList();
  assertTrue("Permission list should not be empty",permList != null && permList.size() > 0);
  AclPermissionResponse permResp=permList.iterator().next();
  assertEquals("There should be one permission for listVirtualMachines","listVirtualMachines",permResp.getAction());
  policyPerms.remove(perm);
  _aclSrv.removeAclPermissionFromAclPolicy(policyId,AclEntityType.VirtualMachine.toString(),PermissionScope.RESOURCE,resId,"listVirtualMachines");
  policyResp=_aclSrv.listAclPolicies(null,"policy1",callerDomainId,0L,20L);
  assertTrue("No. of response items should be one",policyResp.getCount() == 1);
  resp=policyResp.getResponses().get(0);
  permList=resp.getPermissionList();
  assertTrue("Permission list should be empty",permList != null && permList.size() == 0);
}
