{
  Transaction txn=Transaction.currentTxn();
  try {
    txn.start();
    SearchCriteria<IPAddressVO> sc=VlanDbIdSearchUnallocated.create();
    sc.setParameters("vlanDbId",vlanDbId);
    IPAddressVO ip=this.lock(sc,true);
    if (ip != null) {
      ip.setAccountId(accountId);
      ip.setAllocated(new Date());
      ip.setDomainId(domainId);
      ip.setSourceNat(sourceNat);
      if (!update(ip.getAddress(),ip)) {
        s_logger.debug("Unable to retrieve any ip addresses");
        return null;
      }
      txn.commit();
      return ip.getAddress();
    }
 else {
      txn.rollback();
      s_logger.error("Unable to find an available IP address with related vlan, vlanDbId: " + vlanDbId);
    }
  }
 catch (  Exception e) {
    s_logger.warn("Unable to assign IP",e);
  }
  return null;
}
