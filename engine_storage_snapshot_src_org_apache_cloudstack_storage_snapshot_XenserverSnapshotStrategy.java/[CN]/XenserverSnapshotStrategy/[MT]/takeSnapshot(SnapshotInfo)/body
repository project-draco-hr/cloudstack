{
  SnapshotVO snapshotVO=snapshotDao.acquireInLockTable(snapshot.getId());
  if (snapshotVO == null) {
    throw new CloudRuntimeException("Failed to get lock on snapshot:" + snapshot.getId());
  }
  try {
    SnapshotResult result=snapshotSvr.takeSnapshot(snapshot);
    if (result.isFailed()) {
      s_logger.debug("Failed to take snapshot: " + result.getResult());
      throw new CloudRuntimeException(result.getResult());
    }
    snapshot=result.getSnashot();
    DataStore primaryStore=snapshot.getDataStore();
    SnapshotInfo backupedSnapshot=this.backupSnapshot(snapshot);
    try {
      SnapshotInfo parent=snapshot.getParent();
      if (backupedSnapshot != null && parent != null) {
        Long parentSnapshotId=parent.getId();
        while (parentSnapshotId != null && parentSnapshotId != 0L) {
          SnapshotDataStoreVO snapshotDataStoreVO=snapshotStoreDao.findByStoreSnapshot(primaryStore.getRole(),primaryStore.getId(),parentSnapshotId);
          if (snapshotDataStoreVO != null) {
            parentSnapshotId=snapshotDataStoreVO.getParentSnapshotId();
            snapshotStoreDao.remove(snapshotDataStoreVO.getId());
          }
 else {
            parentSnapshotId=null;
          }
        }
        SnapshotDataStoreVO snapshotDataStoreVO=snapshotStoreDao.findByStoreSnapshot(primaryStore.getRole(),primaryStore.getId(),snapshot.getId());
        if (snapshotDataStoreVO != null) {
          snapshotDataStoreVO.setParentSnapshotId(0L);
          snapshotStoreDao.update(snapshotDataStoreVO.getId(),snapshotDataStoreVO);
        }
      }
    }
 catch (    Exception e) {
      s_logger.debug("Failed to clean up snapshots on primary storage",e);
    }
    return backupedSnapshot;
  }
  finally {
    if (snapshotVO != null) {
      snapshotDao.releaseFromLockTable(snapshot.getId());
    }
  }
}
