from subprocess import PIPE, Popen
from signal import alarm, signal, SIGALRM, SIGKILL
import tempfile
import shutil
import os
import logging
import sys
import re
import traceback
import socket
import cloudException
import utilities
import configFileOps
from optparse import OptionParser
if (__name__ == '__main__'):
    parser = OptionParser()
    parser.add_option('-d', action='store_true', dest='debug')
    (options, args) = parser.parse_args()
    initLoging('/var/log/cloud/setupAgent.log')
    userInputs = getUserInputs()
    glbEnv = globalEnv()
    if options.debug:
        glbEnv.debug = True
    else:
        glbEnv.debug = False
    glbEnv.mgtSvr = userInputs[0]
    glbEnv.zoneToken = userInputs[1]
    glbEnv.defaultNic = userInputs[2]
    glbEnv.nics = []
    glbEnv.uuid = configFileOps('/etc/cloud/agent/agent.properties').getEntry('guid')
    if (glbEnv.uuid == ''):
        glbEnv.uuid = bash('uuidgen').getStdout()
    print 'Starting to configure your system:'
    syscfg = sysConfig.getSysConfigFactory(glbEnv)
    try:
        syscfg.config()
        print 'myCloud setup is Done!'
    except CloudRuntimeException as e:
        print e
        print 'Try to restore your system:'
        try:
            syscfg.restore()
        except:
            pass
