{
  Account caller=CallContext.current().getCallingAccount();
  APICommand commandAnnotation=cmd.getClass().getAnnotation(APICommand.class);
  String apiName=commandAnnotation != null ? commandAnnotation.name() : null;
  if (!entitiesToAccess.isEmpty()) {
    List<ControlledEntity> entitiesToOperate=new ArrayList<ControlledEntity>();
    for (    Object entity : entitiesToAccess.keySet()) {
      if (entity instanceof ControlledEntity) {
        if (AccessType.OperateEntry == entitiesToAccess.get(entity)) {
          entitiesToOperate.add((ControlledEntity)entity);
        }
 else {
          _accountMgr.checkAccess(caller,entitiesToAccess.get(entity),apiName,(ControlledEntity)entity);
        }
      }
 else       if (entity instanceof InfrastructureEntity) {
        if (entity instanceof DataCenter) {
          checkZoneAccess(caller,(DataCenter)entity);
        }
 else         if (entity instanceof ServiceOffering) {
          checkServiceOfferingAccess(caller,(ServiceOffering)entity);
        }
 else         if (entity instanceof DiskOffering) {
          checkDiskOfferingAccess(caller,(DiskOffering)entity);
        }
      }
    }
    if (!entitiesToOperate.isEmpty()) {
      _accountMgr.checkAccess(caller,AccessType.OperateEntry,false,apiName,(ControlledEntity[])entitiesToOperate.toArray());
    }
  }
}
