{
  Account caller=CallContext.current().getCallingAccount();
  Account owner=_accountMgr.getAccount(cmd.getEntityOwnerId());
  if (owner == null) {
    owner=caller;
  }
  APICommand commandAnnotation=cmd.getClass().getAnnotation(APICommand.class);
  String apiName=commandAnnotation != null ? commandAnnotation.name() : null;
  if (!entitiesToAccess.isEmpty()) {
    List<ControlledEntity> entitiesToOperate=new ArrayList<ControlledEntity>();
    for (    Object entity : entitiesToAccess.keySet()) {
      if (entity instanceof ControlledEntity) {
        if (AccessType.OperateEntry == entitiesToAccess.get(entity)) {
          entitiesToOperate.add((ControlledEntity)entity);
        }
 else {
          _accountMgr.checkAccess(owner,entitiesToAccess.get(entity),apiName,(ControlledEntity)entity);
        }
      }
 else       if (entity instanceof InfrastructureEntity) {
        if (entity instanceof DataCenter) {
          checkZoneAccess(owner,(DataCenter)entity);
        }
 else         if (entity instanceof ServiceOffering) {
          checkServiceOfferingAccess(owner,(ServiceOffering)entity);
        }
 else         if (entity instanceof DiskOffering) {
          checkDiskOfferingAccess(owner,(DiskOffering)entity);
        }
      }
    }
    if (!entitiesToOperate.isEmpty()) {
      _accountMgr.checkAccess(owner,AccessType.OperateEntry,apiName,entitiesToOperate.toArray(new ControlledEntity[entitiesToOperate.size()]));
    }
  }
}
