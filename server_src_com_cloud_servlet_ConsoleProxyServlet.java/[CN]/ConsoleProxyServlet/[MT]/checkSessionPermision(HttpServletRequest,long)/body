{
  HttpSession session=req.getSession(false);
  Account accountObj=(Account)session.getAttribute("accountobj");
  VMInstanceVO vm=_ms.findVMInstanceById(vmId);
  UserVmVO userVm;
switch (vm.getType()) {
case User:
    userVm=_ms.findUserVMInstanceById(vmId);
  if (userVm.getAccountId() != accountObj.getId().longValue() && accountObj.getType() != Account.ACCOUNT_TYPE_ADMIN) {
    if (s_logger.isDebugEnabled())     s_logger.debug("VM access is denied. VM owner account " + userVm.getAccountId() + " does not match the account id in session "+ accountObj.getId());
    return false;
  }
break;
case ConsoleProxy:
case DomainRouter:
case SecondaryStorageVm:
if (accountObj.getType() != Account.ACCOUNT_TYPE_ADMIN) {
if (s_logger.isDebugEnabled()) s_logger.debug("VM access is denied. Accessing restricted VM requires admin privilege");
return false;
}
break;
}
return true;
}
