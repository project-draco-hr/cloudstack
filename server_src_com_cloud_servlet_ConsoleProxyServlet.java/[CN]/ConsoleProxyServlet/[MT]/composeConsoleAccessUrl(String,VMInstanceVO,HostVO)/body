{
  StringBuffer sb=new StringBuffer(rootUrl);
  String host=hostVo.getPrivateIpAddress();
  Pair<String,Integer> portInfo=_ms.getVncPort(vm);
  if (s_logger.isDebugEnabled())   s_logger.debug("Port info " + portInfo.first());
  Ternary<String,String,String> parsedHostInfo=parseHostInfo(portInfo.first());
  String sid=vm.getVncPassword();
  String tag=String.valueOf(vm.getId());
  tag=_identityService.getIdentityUuid("vm_instance",tag);
  String ticket=genAccessTicket(host,String.valueOf(portInfo.second()),sid,tag);
  String consoleurl=null;
  String sessionref=null;
  sb.append("/ajax?host=").append(parsedHostInfo.first());
  sb.append("&port=").append(portInfo.second());
  sb.append("&sid=").append(sid);
  sb.append("&tag=").append(tag);
  sb.append("&ticket=").append(ticket);
  if (parsedHostInfo.second() != null && parsedHostInfo.third() != null) {
    try {
      consoleurl=URLEncoder.encode(parsedHostInfo.second(),"UTF-8");
      sessionref=URLEncoder.encode(parsedHostInfo.third(),"UTF-8");
      sb.append("&").append("consoleurl=").append(URLDecoder.decode(consoleurl,"UTF-8"));
      sb.append("&").append("sessionref=").append(URLDecoder.decode(sessionref,"UTF-8"));
    }
 catch (    UnsupportedEncodingException e) {
      s_logger.error("Unexpected exception ",e);
    }
  }
  long guestOs=vm.getGuestOSId();
  GuestOSVO guestOsVo=_ms.getGuestOs(guestOs);
  if (guestOsVo.getCategoryId() == 6)   sb.append("&guest=windows");
  if (s_logger.isDebugEnabled()) {
    s_logger.debug("Compose console url: " + sb.toString());
  }
  return sb.toString();
}
