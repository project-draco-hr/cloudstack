{
  VMInstanceVO vm=_ms.findVMInstanceById(vmId);
  if (vm == null) {
    s_logger.warn("VM " + vmId + " does not exist, sending blank response for console access request");
    sendResponse(resp,"");
    return;
  }
  if (vm.getHostId() == null) {
    s_logger.warn("VM " + vmId + " lost host info, sending blank response for console access request");
    sendResponse(resp,"");
    return;
  }
  HostVO host=_ms.getHostBy(vm.getHostId());
  if (host == null) {
    s_logger.warn("VM " + vmId + "'s host does not exist, sending blank response for console access request");
    sendResponse(resp,"");
    return;
  }
  String rootUrl=_ms.getConsoleAccessUrlRoot(vmId);
  if (rootUrl == null) {
    sendResponse(resp,"<html><body><p>Console access will be ready in a few minutes. Please try it again later.</p></body></html>");
    return;
  }
  String vmName=vm.getName();
  if (vmName == null)   vmName=vm.getInstanceName();
  StringBuffer sb=new StringBuffer();
  sb.append("<html><title>").append(vmName).append("</title><frameset><frame src=\"").append(composeConsoleAccessUrl(rootUrl,vm,host));
  sb.append("\"></frame></frameset></html>");
  sendResponse(resp,sb.toString());
}
