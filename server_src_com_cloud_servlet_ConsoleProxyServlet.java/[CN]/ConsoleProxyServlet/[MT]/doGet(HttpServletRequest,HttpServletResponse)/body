{
  try {
    HttpSession session=req.getSession(false);
    if (session == null) {
      s_logger.info("Invalid web session, reject console/thumbnail access");
      sendResponse(resp,"Access denied. You haven't logged in or your web session has timed out");
      return;
    }
    String userId=(String)session.getAttribute(BaseCmd.Properties.USER_ID.getName());
    String account=(String)session.getAttribute(BaseCmd.Properties.ACCOUNT.getName());
    Account accountObj=(Account)session.getAttribute(BaseCmd.Properties.ACCOUNT_OBJ.getName());
    if ((userId == null) || (account == null) || (accountObj == null)|| !verifyUser(Long.valueOf(userId))) {
      s_logger.info("Invalid user/account, reject console/thumbnail access");
      sendResponse(resp,"Access denied. Invalid or inconsistent account is found");
      return;
    }
    String cmd=req.getParameter("cmd");
    if (cmd == null || !isValidCmd(cmd)) {
      s_logger.info("invalid console servlet command: " + cmd);
      sendResponse(resp,"");
      return;
    }
    String vmIdString=req.getParameter("vm");
    long vmId=0;
    try {
      vmId=Long.parseLong(vmIdString);
    }
 catch (    NumberFormatException e) {
      s_logger.info("invalid console servlet command parameter: " + vmIdString);
      sendResponse(resp,"");
      return;
    }
    if (!checkSessionPermision(req,vmId)) {
      sendResponse(resp,"Permission denied");
      return;
    }
    if (cmd.equalsIgnoreCase("thumbnail"))     handleThumbnailRequest(req,resp,vmId);
 else     if (cmd.equalsIgnoreCase("access"))     handleAccessRequest(req,resp,vmId);
 else     handleAuthRequest(req,resp,vmId);
  }
 catch (  Throwable e) {
    s_logger.error("Unexepected exception in ConsoleProxyServlet",e);
    sendResponse(resp,"");
  }
}
