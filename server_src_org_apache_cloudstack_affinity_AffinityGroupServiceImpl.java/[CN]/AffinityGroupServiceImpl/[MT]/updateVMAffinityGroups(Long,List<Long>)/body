{
  UserVmVO vmInstance=_userVmDao.findById(vmId);
  if (vmInstance == null) {
    throw new InvalidParameterValueException("unable to find a virtual machine with id " + vmId);
  }
  if (!vmInstance.getState().equals(State.Stopped)) {
    s_logger.warn("Unable to update affinity groups of the virtual machine " + vmInstance.toString() + " in state "+ vmInstance.getState());
    throw new InvalidParameterValueException("Unable update affinity groups of the virtual machine " + vmInstance.toString() + " "+ "in state "+ vmInstance.getState()+ "; make sure the virtual machine is stopped and not in an error state before updating.");
  }
  for (  Long affinityGroupId : affinityGroupIds) {
    AffinityGroupVO ag=_affinityGroupDao.findById(affinityGroupId);
    if (ag == null) {
      throw new InvalidParameterValueException("Unable to find affinity group by id " + affinityGroupId);
    }
  }
  _affinityGroupVMMapDao.updateMap(vmId,affinityGroupIds);
  return vmInstance;
}
