{
  Account caller=UserContext.current().getCaller();
  Map<String,AffinityGroupProcessor> typeProcessorMap=getAffinityTypeToProcessorMap();
  if (typeProcessorMap != null && !typeProcessorMap.isEmpty()) {
    if (!typeProcessorMap.containsKey(affinityGroupType)) {
      throw new InvalidParameterValueException("Unable to create affinity group, invalid affinity group type" + affinityGroupType);
    }
  }
 else {
    throw new InvalidParameterValueException("Unable to create affinity group, no Affinity Group Types configured");
  }
  AffinityGroupProcessor processor=typeProcessorMap.get(affinityGroupType);
  if (processor.isAdminControlledGroup()) {
    throw new PermissionDeniedException("Cannot create the affinity group");
  }
  return createAffinityGroupInternal(account,domainId,affinityGroupName,affinityGroupType,description);
}
