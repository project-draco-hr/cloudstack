{
  s_logger.debug("allocate called with network: " + network.toString() + " nic: "+ nic.toString()+ " vm: "+ vm.toString());
  DataCenter dc=_dcDao.findById(network.getDataCenterId());
  if (nic != null && nic.getRequestedIpv4() != null) {
    throw new CloudRuntimeException("Does not support custom ip allocation at this time: " + nic);
  }
  if (nic == null) {
    nic=new NicProfile(Nic.ReservationStrategy.Create,null,null,null,null);
  }
  getIp(nic,dc,vm,network);
  if (nic.getIp4Address() == null) {
    nic.setStrategy(Nic.ReservationStrategy.Start);
  }
 else   if (vm.getVirtualMachine().getType() == VirtualMachine.Type.DomainRouter) {
    nic.setStrategy(Nic.ReservationStrategy.Managed);
  }
 else {
    nic.setStrategy(Nic.ReservationStrategy.Create);
  }
  nic.setBroadcastUri(generateBroadcastUri(network));
  return nic;
}
