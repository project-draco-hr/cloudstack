{
  Map<VM,VM.Record> vmentries=null;
  Connection conn=getConnection();
  for (int i=0; i < 2; i++) {
    try {
      vmentries=VM.getAllRecords(conn);
      break;
    }
 catch (    final Throwable e) {
      s_logger.warn("Unable to get vms",e);
    }
    try {
      Thread.sleep(1000);
    }
 catch (    final InterruptedException ex) {
    }
  }
  if (vmentries == null) {
    return;
  }
  for (  Map.Entry<VM,VM.Record> vmentry : vmentries.entrySet()) {
    VM.Record record=vmentry.getValue();
    if (record.isControlDomain || record.isASnapshot || record.isATemplate) {
      continue;
    }
    if (record.powerState != Types.VmPowerState.HALTED) {
      continue;
    }
    try {
      if (isRefNull(record.affinity) || !record.affinity.getUuid(conn).equals(_host.uuid)) {
        continue;
      }
      vmentry.getKey().destroy(conn);
    }
 catch (    Exception e) {
      String msg="VM destroy failed for " + record.nameLabel + " due to "+ e.getMessage();
      s_logger.warn(msg,e);
    }
  }
}
