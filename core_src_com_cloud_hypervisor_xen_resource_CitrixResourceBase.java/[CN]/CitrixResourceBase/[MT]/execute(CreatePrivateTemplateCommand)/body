{
  String secondaryStorageURL=cmd.getSecondaryStorageURL();
  String snapshotUUID=cmd.getSnapshotPath();
  String userSpecifiedName=cmd.getTemplateName();
  SR secondaryStorage=null;
  VDI privateTemplate=null;
  Connection conn=getConnection();
  try {
    URI uri=new URI(secondaryStorageURL);
    String remoteTemplateMountPath=uri.getHost() + ":" + uri.getPath()+ "/template/";
    String templateFolder=cmd.getAccountId() + "/" + cmd.getTemplateId()+ "/";
    String templateDownloadFolder=createTemplateDownloadFolder(remoteTemplateMountPath,templateFolder);
    String templateInstallFolder="tmpl/" + templateFolder;
    secondaryStorage=createNfsSRbyURI(new URI(secondaryStorageURL + "/template/" + templateDownloadFolder),false);
    VDI snapshot=getVDIbyUuid(snapshotUUID);
    privateTemplate=snapshot.copy(conn,secondaryStorage);
    if (userSpecifiedName != null) {
      privateTemplate.setNameLabel(conn,userSpecifiedName);
    }
    VDI.Record vdir=privateTemplate.getRecord(conn);
    String templateName=vdir.uuid;
    String templateFilename=templateName + ".vhd";
    String installPath="template/" + templateInstallFolder + templateFilename;
    long virtualSize=privateTemplate.getVirtualSize(conn);
    if (!postCreatePrivateTemplate(remoteTemplateMountPath,templateDownloadFolder,templateInstallFolder,templateFilename,templateName,userSpecifiedName,null,virtualSize,cmd.getTemplateId())) {
      throw new InternalErrorException("Failed to create the template.properties file.");
    }
    return new CreatePrivateTemplateAnswer(cmd,true,null,installPath,virtualSize,templateName,ImageFormat.VHD);
  }
 catch (  XenAPIException e) {
    if (privateTemplate != null) {
      destroyVDI(privateTemplate);
    }
    s_logger.warn("CreatePrivateTemplate Failed due to " + e.toString(),e);
    return new CreatePrivateTemplateAnswer(cmd,false,e.toString(),null,0,null,null);
  }
catch (  Exception e) {
    s_logger.warn("CreatePrivateTemplate Failed due to " + e.getMessage(),e);
    return new CreatePrivateTemplateAnswer(cmd,false,e.getMessage(),null,0,null,null);
  }
 finally {
    removeSR(secondaryStorage);
  }
}
