{
  Connection conn=getConnection();
  Map<SR,SR.Record> srs;
  try {
    srs=SR.getAllRecords(conn);
  }
 catch (  XenAPIException e) {
    s_logger.warn("Unable to get the SRs " + e.toString(),e);
    throw new CloudRuntimeException("Unable to get SRs " + e.toString(),e);
  }
catch (  XmlRpcException e) {
    throw new CloudRuntimeException("Unable to get SRs " + e.getMessage());
  }
  for (  Map.Entry<SR,SR.Record> sr : srs.entrySet()) {
    SR.Record rec=sr.getValue();
    if (SRType.NFS.equals(rec.type) || (SRType.ISO.equals(rec.type) && rec.nameLabel.endsWith("iso"))) {
      if (rec.PBDs == null || rec.PBDs.size() == 0) {
        cleanSR(sr.getKey(),rec);
        continue;
      }
      for (      PBD pbd : rec.PBDs) {
        if (isRefNull(pbd)) {
          continue;
        }
        PBD.Record pbdr=null;
        try {
          pbdr=pbd.getRecord(conn);
        }
 catch (        XenAPIException e) {
          s_logger.warn("Unable to get pbd record " + e.toString());
        }
catch (        XmlRpcException e) {
          s_logger.warn("Unable to get pbd record " + e.getMessage());
        }
        if (pbdr == null) {
          continue;
        }
        try {
          if (pbdr.host.getUuid(conn).equals(_host.uuid)) {
            if (!currentlyAttached(sr.getKey(),rec,pbd,pbdr)) {
              pbd.unplug(conn);
              pbd.destroy(conn);
              cleanSR(sr.getKey(),rec);
            }
 else             if (!pbdr.currentlyAttached) {
              pbd.plug(conn);
            }
          }
        }
 catch (        XenAPIException e) {
          s_logger.warn("Catch XenAPIException due to" + e.toString(),e);
        }
catch (        XmlRpcException e) {
          s_logger.warn("Catch XmlRpcException due to" + e.getMessage(),e);
        }
      }
    }
  }
}
