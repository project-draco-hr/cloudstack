{
  Connection conn=getConnection();
synchronized (_vms) {
    _vms.put(cmd.getVmName(),State.Starting);
  }
  try {
    Set<VM> vms=null;
    try {
      vms=VM.getByNameLabel(conn,cmd.getVmName());
    }
 catch (    XenAPIException e0) {
      s_logger.debug("getByNameLabel failed " + e0.toString());
      return new RebootAnswer(cmd,"getByNameLabel failed " + e0.toString());
    }
catch (    Exception e0) {
      s_logger.debug("getByNameLabel failed " + e0.getMessage());
      return new RebootAnswer(cmd,"getByNameLabel failed");
    }
    for (    VM vm : vms) {
      try {
        vm.cleanReboot(conn);
      }
 catch (      XenAPIException e) {
        s_logger.debug("Do Not support Clean Reboot, fall back to hard Reboot: " + e.toString());
        try {
          vm.hardReboot(conn);
        }
 catch (        XenAPIException e1) {
          s_logger.debug("Caught exception on hard Reboot " + e1.toString());
          return new RebootAnswer(cmd,"reboot failed: " + e1.toString());
        }
catch (        XmlRpcException e1) {
          s_logger.debug("Caught exception on hard Reboot " + e1.getMessage());
          return new RebootAnswer(cmd,"reboot failed");
        }
      }
catch (      XmlRpcException e) {
        String msg="Clean Reboot failed due to " + e.getMessage();
        s_logger.warn(msg,e);
        return new RebootAnswer(cmd,msg);
      }
    }
    return new RebootAnswer(cmd,"reboot succeeded",null,null);
  }
  finally {
synchronized (_vms) {
      _vms.put(cmd.getVmName(),State.Running);
    }
  }
}
