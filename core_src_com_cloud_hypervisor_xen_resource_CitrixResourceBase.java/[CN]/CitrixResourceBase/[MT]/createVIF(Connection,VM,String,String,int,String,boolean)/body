{
  VIF.Record vifr=new VIF.Record();
  vifr.VM=vm;
  vifr.device=devNum;
  vifr.MAC=mac;
  String nwUuid=(isPub ? _host.publicNetwork : _host.guestNetwork);
  String pifUuid=(isPub ? _host.publicPif : _host.guestPif);
  Network vlanNetwork=null;
  if ("untagged".equalsIgnoreCase(vlanTag)) {
    vlanNetwork=Network.getByUuid(conn,nwUuid);
  }
 else {
    vlanNetwork=enableVlanNetwork(Long.valueOf(vlanTag),pifUuid);
  }
  if (vlanNetwork == null) {
    throw new InternalErrorException("Failed to enable VLAN network with tag: " + vlanTag);
  }
  vifr.network=vlanNetwork;
  if (rate != 0) {
    vifr.qosAlgorithmType="ratelimit";
    vifr.qosAlgorithmParams=new HashMap<String,String>();
    vifr.qosAlgorithmParams.put("kbps",Integer.toString(rate * 1000));
  }
  VIF.create(conn,vifr);
}
