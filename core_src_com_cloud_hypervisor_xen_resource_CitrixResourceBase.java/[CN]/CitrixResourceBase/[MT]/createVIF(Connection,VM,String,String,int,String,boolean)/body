{
  String nwUuid=(isPub ? _host.publicNetwork : _host.guestNetwork);
  String pifUuid=(isPub ? _host.publicPif : _host.guestPif);
  Network vlanNetwork=null;
  if ("untagged".equalsIgnoreCase(vlanTag)) {
    vlanNetwork=Network.getByUuid(conn,nwUuid);
  }
 else {
    vlanNetwork=enableVlanNetwork(conn,Long.valueOf(vlanTag),pifUuid);
  }
  if (vlanNetwork == null) {
    throw new InternalErrorException("Failed to enable VLAN network with tag: " + vlanTag);
  }
  return createVIF(conn,vm,mac,rate,devNum,vlanNetwork);
}
