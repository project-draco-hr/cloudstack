{
  SR tmpltsr=null;
  String tmplturl=cmd.getUrl();
  int index=tmplturl.lastIndexOf("/");
  String mountpoint=tmplturl.substring(0,index);
  String tmpltname=null;
  if (index < tmplturl.length() - 1)   tmpltname=tmplturl.substring(index + 1).replace(".vhd","");
  try {
    Connection conn=getConnection();
    String pUuid=cmd.getPoolUuid();
    SR poolsr=null;
    Set<SR> srs=SR.getByNameLabel(conn,pUuid);
    if (srs.size() != 1) {
      String msg="There are " + srs.size() + " SRs with same name: "+ pUuid;
      s_logger.warn(msg);
      return new PrimaryStorageDownloadAnswer(msg);
    }
 else {
      poolsr=srs.iterator().next();
    }
    VDI vmtmpltvdi=null;
    VDI snapshotvdi=null;
    Set<VDI> vdis=VDI.getByNameLabel(conn,"Template " + cmd.getName());
    for (    VDI vdi : vdis) {
      VDI.Record vdir=vdi.getRecord(conn);
      if (vdir.SR.equals(poolsr)) {
        vmtmpltvdi=vdi;
        break;
      }
    }
    if (vmtmpltvdi == null) {
      tmpltsr=createNfsSRbyURI(new URI(mountpoint),false);
      tmpltsr.scan(conn);
      VDI tmpltvdi=null;
      if (tmpltname != null) {
        tmpltvdi=getVDIbyUuid(tmpltname);
      }
      if (tmpltvdi == null) {
        vdis=tmpltsr.getVDIs(conn);
        for (        VDI vdi : vdis) {
          tmpltvdi=vdi;
          break;
        }
      }
      if (tmpltvdi == null) {
        String msg="Unable to find template vdi on secondary storage" + "host:" + _host.uuid + "pool: "+ tmplturl;
        s_logger.warn(msg);
        return new PrimaryStorageDownloadAnswer(msg);
      }
      vmtmpltvdi=cloudVDIcopy(tmpltvdi,poolsr);
      snapshotvdi=vmtmpltvdi.snapshot(conn,new HashMap<String,String>());
      vmtmpltvdi.destroy(conn);
      try {
        poolsr.scan(conn);
      }
 catch (      Exception e) {
      }
      snapshotvdi.setNameLabel(conn,"Template " + cmd.getName());
      vmtmpltvdi=snapshotvdi;
    }
    VDI.Record vdiRec=vmtmpltvdi.getRecord(conn);
    long phySize=vdiRec.physicalUtilisation;
    String uuid=vdiRec.uuid;
    String parentUuid=vdiRec.smConfig.get("vhd-parent");
    if (parentUuid != null) {
      VDI parentVdi=getVDIbyUuid(parentUuid);
      phySize+=parentVdi.getPhysicalUtilisation(conn);
    }
    return new PrimaryStorageDownloadAnswer(uuid,phySize);
  }
 catch (  XenAPIException e) {
    String msg="XenAPIException:" + e.toString() + "host:"+ _host.uuid+ "pool: "+ tmplturl;
    s_logger.warn(msg,e);
    return new PrimaryStorageDownloadAnswer(msg);
  }
catch (  Exception e) {
    String msg="XenAPIException:" + e.getMessage() + "host:"+ _host.uuid+ "pool: "+ tmplturl;
    s_logger.warn(msg,e);
    return new PrimaryStorageDownloadAnswer(msg);
  }
 finally {
    removeSR(tmpltsr);
  }
}
