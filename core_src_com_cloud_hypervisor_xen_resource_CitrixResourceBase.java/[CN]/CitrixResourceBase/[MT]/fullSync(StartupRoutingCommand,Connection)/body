{
synchronized (_vms) {
    _vms.clear();
  }
  try {
    final HashMap<String,VmState> vmStates=new HashMap<String,VmState>();
    Host lhost=Host.getByUuid(conn,_host.uuid);
    Set<VM> vms=lhost.getResidentVMs(conn);
    for (    VM vm : vms) {
      VM.Record record=vm.getRecord(conn);
      if (record.isControlDomain || record.isASnapshot || record.isATemplate) {
        continue;
      }
      String vm_name=record.nameLabel;
      VmPowerState ps=record.powerState;
      final State state=convertToState(ps);
      Host host=record.residentOn;
      String host_uuid=null;
      if (host != null) {
        host_uuid=host.getUuid(conn);
        if (host_uuid.equals(_host.uuid)) {
synchronized (_vms) {
            _vms.put(vm_name,state);
          }
        }
      }
      if (s_logger.isTraceEnabled()) {
        s_logger.trace("VM " + vm_name + ": powerstate = "+ ps+ "; vm state="+ state.toString());
      }
      VmState vm_state=new StartupRoutingCommand.VmState(state,host_uuid);
      vmStates.put(vm_name,vm_state);
    }
    cmd.setChanges(vmStates);
  }
 catch (  final Throwable e) {
    String msg="Unable to get vms through host " + _host.uuid + " due to to "+ e.toString();
    s_logger.warn(msg,e);
    throw new CloudRuntimeException(msg);
  }
}
