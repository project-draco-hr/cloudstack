{
  String primaryStorageNameLabel=cmd.getPrimaryStoragePoolNameLabel();
  Long dcId=cmd.getDataCenterId();
  Long accountId=cmd.getAccountId();
  Long volumeId=cmd.getVolumeId();
  String secondaryStoragePoolURL=cmd.getSecondaryStoragePoolURL();
  String backedUpSnapshotUuid=cmd.getSnapshotUuid();
  Long newTemplateId=cmd.getNewTemplateId();
  String userSpecifiedName=cmd.getTemplateName();
  String details=null;
  SR snapshotSR=null;
  SR tmpltSR=null;
  boolean result=false;
  try {
    URI uri=new URI(secondaryStoragePoolURL);
    String secondaryStorageMountPath=uri.getHost() + ":" + uri.getPath();
    String installPath="template/tmpl/" + accountId + "/"+ newTemplateId;
    if (!createSecondaryStorageFolder(secondaryStorageMountPath,installPath)) {
      details=" Filed to create folder " + installPath + " in secondary storage";
      s_logger.warn(details);
      return new CreatePrivateTemplateAnswer(cmd,false,details);
    }
    Connection conn=getConnection();
    URI snapshotURI=new URI(secondaryStoragePoolURL + "/snapshots/" + accountId+ "/"+ volumeId);
    snapshotSR=createNfsSRbyURI(snapshotURI,false);
    snapshotSR.scan(conn);
    VDI snapshotVDI=getVDIbyUuid(backedUpSnapshotUuid);
    URI tmpltURI=new URI(secondaryStoragePoolURL + "/" + installPath);
    tmpltSR=createNfsSRbyURI(tmpltURI,false);
    VDI tmpltVDI=cloudVDIcopy(snapshotVDI,tmpltSR);
    String tmpltSrUUID=tmpltSR.getUuid(conn);
    String tmpltUUID=tmpltVDI.getUuid(conn);
    String tmpltFilename=tmpltUUID + ".vhd";
    long virtualSize=tmpltVDI.getVirtualSize(conn);
    long size=tmpltVDI.getPhysicalUtilisation(conn);
    result=postCreatePrivateTemplate(tmpltSrUUID,tmpltFilename,tmpltUUID,userSpecifiedName,null,size,virtualSize,newTemplateId);
    if (!result) {
      throw new CloudRuntimeException("Could not create the template.properties file on secondary storage dir: " + tmpltURI);
    }
    return new CreatePrivateTemplateAnswer(cmd,true,null,installPath,virtualSize,tmpltUUID,ImageFormat.VHD);
  }
 catch (  XenAPIException e) {
    details="Creating template from snapshot " + backedUpSnapshotUuid + " failed due to "+ e.getMessage();
    s_logger.error(details,e);
  }
catch (  Exception e) {
    details="Creating template from snapshot " + backedUpSnapshotUuid + " failed due to "+ e.getMessage();
    s_logger.error(details,e);
  }
 finally {
    removeSR(snapshotSR);
    removeSR(tmpltSR);
  }
  return new CreatePrivateTemplateAnswer(cmd,result,details);
}
