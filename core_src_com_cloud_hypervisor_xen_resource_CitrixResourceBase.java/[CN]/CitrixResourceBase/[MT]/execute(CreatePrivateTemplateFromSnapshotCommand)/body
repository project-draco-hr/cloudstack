{
  String primaryStorageNameLabel=cmd.getPrimaryStoragePoolNameLabel();
  Long dcId=cmd.getDataCenterId();
  Long accountId=cmd.getAccountId();
  Long volumeId=cmd.getVolumeId();
  String secondaryStoragePoolURL=cmd.getSecondaryStoragePoolURL();
  String backedUpSnapshotUuid=cmd.getSnapshotUuid();
  String origTemplateInstallPath=cmd.getOrigTemplateInstallPath();
  Long newTemplateId=cmd.getNewTemplateId();
  String userSpecifiedName=cmd.getTemplateName();
  String details="Failed to create private template " + newTemplateId + " from snapshot for volume: "+ volumeId+ " with backupUuid: "+ backedUpSnapshotUuid;
  String newTemplatePath=null;
  String templateName=null;
  boolean result=false;
  long virtualSize=0;
  try {
    URI uri=new URI(secondaryStoragePoolURL);
    String remoteTemplateMountPath=uri.getHost() + ":" + uri.getPath()+ "/template/";
    String templateFolder=cmd.getAccountId() + "/" + newTemplateId+ "/";
    String templateDownloadFolder=createTemplateDownloadFolder(remoteTemplateMountPath,templateFolder);
    String templateInstallFolder="tmpl/" + templateFolder;
    Pair<VHDInfo,String> vhdDetails=createVHDFromSnapshot(primaryStorageNameLabel,dcId,accountId,volumeId,secondaryStoragePoolURL,backedUpSnapshotUuid,origTemplateInstallPath,templateDownloadFolder);
    VHDInfo vhdInfo=vhdDetails.first();
    String failureDetails=vhdDetails.second();
    if (vhdInfo == null) {
      if (failureDetails != null) {
        details+=failureDetails;
      }
    }
 else {
      templateName=vhdInfo.getUuid();
      String templateFilename=templateName + ".vhd";
      String templateInstallPath=templateInstallFolder + "/" + templateFilename;
      newTemplatePath="template" + "/" + templateInstallPath;
      virtualSize=vhdInfo.getVirtualSize();
      result=postCreatePrivateTemplate(remoteTemplateMountPath,templateDownloadFolder,templateInstallFolder,templateFilename,templateName,userSpecifiedName,null,virtualSize,newTemplateId);
      if (!result) {
        details+=", reason: Could not create the template.properties file on secondary storage dir: " + templateInstallFolder;
      }
 else {
        details=null;
      }
    }
  }
 catch (  XenAPIException e) {
    details+=", reason: " + e.getMessage();
    s_logger.error(details,e);
  }
catch (  Exception e) {
    details+=", reason: " + e.getMessage();
    s_logger.error(details,e);
  }
  return new CreatePrivateTemplateAnswer(cmd,result,details,newTemplatePath,virtualSize,templateName,ImageFormat.VHD);
}
