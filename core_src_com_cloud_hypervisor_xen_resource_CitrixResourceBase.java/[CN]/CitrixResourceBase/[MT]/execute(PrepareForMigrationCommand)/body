{
  Connection conn=getConnection();
  VirtualMachineTO vm=cmd.getVirtualMachine();
  if (s_logger.isDebugEnabled()) {
    s_logger.debug("Preparing host for migrating " + vm);
  }
  VolumeTO[] disks=vm.getDisks();
  NicTO[] nics=vm.getNics();
  try {
    for (    VolumeTO disk : disks) {
      mount(conn,vm.getName(),disk);
    }
    for (    NicTO nic : nics) {
      getNetwork(conn,nic);
    }
synchronized (_vms) {
      _vms.put(vm.getName(),State.Migrating);
    }
    return new PrepareForMigrationAnswer(cmd);
  }
 catch (  XenAPIException e) {
    s_logger.warn("Unable to prepare for migration ",e);
    return new PrepareForMigrationAnswer(cmd,e);
  }
catch (  XmlRpcException e) {
    s_logger.warn("Unable to prepare for migration ",e);
    return new PrepareForMigrationAnswer(cmd,e);
  }
}
