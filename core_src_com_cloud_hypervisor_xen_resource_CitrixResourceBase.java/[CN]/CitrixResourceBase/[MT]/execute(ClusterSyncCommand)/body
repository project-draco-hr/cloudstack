{
  Connection conn=getConnection();
  Pool pool;
  try {
    pool=Pool.getByUuid(conn,_host.pool);
    Pool.Record poolr=pool.getRecord(conn);
    Host.Record hostr=poolr.master.getRecord(conn);
    if (!_host.uuid.equals(hostr.uuid)) {
      return new ClusterSyncAnswer(cmd.getClusterId());
    }
  }
 catch (  Throwable e) {
    s_logger.warn("Check for master failed, failing the Cluster sync command");
    return new ClusterSyncAnswer(cmd.getClusterId());
  }
  HashMap<String,Pair<String,State>> newStates=deltaClusterSync(conn);
  cmd.incrStep();
  if (cmd.isRightStep()) {
    HashMap<String,Pair<String,State>> allStates=fullClusterSync(conn);
    return new ClusterSyncAnswer(cmd.getClusterId(),newStates,allStates);
  }
 else {
    return new ClusterSyncAnswer(cmd.getClusterId(),newStates);
  }
}
