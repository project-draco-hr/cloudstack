{
  Connection conn=getConnection();
  Pool pool;
  try {
    pool=Pool.getByUuid(conn,_host.pool);
    Pool.Record poolr=pool.getRecord(conn);
    Host.Record hostr=poolr.master.getRecord(conn);
    if (!_host.uuid.equals(hostr.uuid)) {
      return new Answer(cmd);
    }
  }
 catch (  Throwable e) {
    s_logger.warn("Check for master failed, failing the Cluster sync command");
    return new Answer(cmd);
  }
  HashMap<String,Pair<String,State>> newStates=deltaClusterSync(conn);
  if (cmd.isRightStep()) {
    cmd.incrStep();
    HashMap<String,Pair<String,State>> allStates=fullClusterSync(conn);
    if (cmd.isInit()) {
      cmd.unsetInit();
      return new ClusterSyncAnswer(cmd.getClusterId(),newStates,allStates,true);
    }
 else {
      return new ClusterSyncAnswer(cmd.getClusterId(),newStates,allStates);
    }
  }
 else {
    cmd.incrStep();
    return new ClusterSyncAnswer(cmd.getClusterId(),newStates);
  }
}
