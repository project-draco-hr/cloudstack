{
  Network vlanNetwork=null;
  String name="VLAN" + Long.toString(tag);
synchronized (name.intern()) {
    vlanNetwork=getNetworkByName(conn,name);
    if (vlanNetwork == null) {
      if (s_logger.isDebugEnabled()) {
        s_logger.debug("Creating VLAN network for " + tag + " on host "+ _host.ip);
      }
      Network.Record nwr=new Network.Record();
      nwr.nameLabel=name;
      nwr.bridge=name;
      vlanNetwork=Network.create(conn,nwr);
    }
    PIF nPif=PIF.getByUuid(conn,pifUuid);
    PIF.Record nPifr=nPif.getRecord(conn);
    Network.Record vlanNetworkr=vlanNetwork.getRecord(conn);
    if (vlanNetworkr.PIFs != null) {
      for (      PIF pif : vlanNetworkr.PIFs) {
        PIF.Record pifr=pif.getRecord(conn);
        if (pifr.host.equals(nPifr.host)) {
          if (pifr.device.equals(nPifr.device)) {
            pif.plug(conn);
            return vlanNetwork;
          }
 else {
            throw new CloudRuntimeException("Creating VLAN " + tag + " on "+ nPifr.device+ " failed due to this VLAN is already created on "+ pifr.device);
          }
        }
      }
    }
    if (s_logger.isDebugEnabled()) {
      s_logger.debug("Creating VLAN " + tag + " on host "+ _host.ip+ " on device "+ nPifr.device);
    }
    VLAN vlan=VLAN.create(conn,nPif,tag,vlanNetwork);
    PIF untaggedPif=vlan.getUntaggedPIF(conn);
    if (!untaggedPif.getCurrentlyAttached(conn)) {
      untaggedPif.plug(conn);
    }
  }
  return vlanNetwork;
}
