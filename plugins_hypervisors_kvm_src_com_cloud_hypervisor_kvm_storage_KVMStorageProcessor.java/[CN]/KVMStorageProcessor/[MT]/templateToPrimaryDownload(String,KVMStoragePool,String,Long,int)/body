{
  int index=templateUrl.lastIndexOf("/");
  String mountpoint=templateUrl.substring(0,index);
  String templateName=null;
  if (index < templateUrl.length() - 1) {
    templateName=templateUrl.substring(index + 1);
  }
  KVMPhysicalDisk templateVol=null;
  KVMStoragePool secondaryPool=null;
  try {
    secondaryPool=storagePoolMgr.getStoragePoolByURI(mountpoint);
    if (templateName == null) {
      secondaryPool.refresh();
      List<KVMPhysicalDisk> disks=secondaryPool.listPhysicalDisks();
      if (disks == null || disks.isEmpty()) {
        s_logger.error("Failed to get volumes from pool: " + secondaryPool.getUuid());
        return null;
      }
      for (      KVMPhysicalDisk disk : disks) {
        if (disk.getName().endsWith("qcow2")) {
          templateVol=disk;
          break;
        }
      }
      if (templateVol == null) {
        s_logger.error("Failed to get template from pool: " + secondaryPool.getUuid());
        return null;
      }
    }
 else {
      templateVol=secondaryPool.getPhysicalDisk(templateName);
    }
    if (size > templateVol.getSize()) {
      s_logger.debug("Overriding provided template's size with new size " + size);
      templateVol.setSize(size);
      templateVol.setVirtualSize(size);
    }
 else {
      s_logger.debug("Using templates disk size of " + templateVol.getVirtualSize() + "since size passed was "+ size);
    }
    KVMPhysicalDisk primaryVol=storagePoolMgr.copyPhysicalDisk(templateVol,volUuid,primaryPool,timeout);
    return primaryVol;
  }
 catch (  CloudRuntimeException e) {
    s_logger.error("Failed to download template to primary storage",e);
    return null;
  }
 finally {
    if (secondaryPool != null) {
      secondaryPool.delete();
    }
  }
}
