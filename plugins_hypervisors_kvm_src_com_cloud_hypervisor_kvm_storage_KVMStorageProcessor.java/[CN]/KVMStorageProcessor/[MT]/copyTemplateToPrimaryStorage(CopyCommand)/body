{
  DataTO srcData=cmd.getSrcTO();
  DataTO destData=cmd.getDestTO();
  TemplateObjectTO template=(TemplateObjectTO)srcData;
  DataStoreTO imageStore=template.getDataStore();
  PrimaryDataStoreTO primaryStore=(PrimaryDataStoreTO)destData.getDataStore();
  if (!(imageStore instanceof NfsTO)) {
    return new CopyCmdAnswer("unsupported protocol");
  }
  NfsTO nfsImageStore=(NfsTO)imageStore;
  String tmplturl=nfsImageStore.getUrl() + File.separator + template.getPath();
  int index=tmplturl.lastIndexOf("/");
  String mountpoint=tmplturl.substring(0,index);
  String tmpltname=null;
  if (index < tmplturl.length() - 1) {
    tmpltname=tmplturl.substring(index + 1);
  }
  KVMPhysicalDisk tmplVol=null;
  KVMStoragePool secondaryPool=null;
  try {
    secondaryPool=storagePoolMgr.getStoragePoolByURI(mountpoint);
    if (tmpltname == null) {
      secondaryPool.refresh();
      List<KVMPhysicalDisk> disks=secondaryPool.listPhysicalDisks();
      if (disks == null || disks.isEmpty()) {
        return new PrimaryStorageDownloadAnswer("Failed to get volumes from pool: " + secondaryPool.getUuid());
      }
      for (      KVMPhysicalDisk disk : disks) {
        if (disk.getName().endsWith("qcow2")) {
          tmplVol=disk;
          break;
        }
      }
      if (tmplVol == null) {
        return new PrimaryStorageDownloadAnswer("Failed to get template from pool: " + secondaryPool.getUuid());
      }
    }
 else {
      tmplVol=secondaryPool.getPhysicalDisk(tmpltname);
    }
    KVMStoragePool primaryPool=storagePoolMgr.getStoragePool(primaryStore.getPoolType(),primaryStore.getUuid());
    KVMPhysicalDisk primaryVol=null;
    if (destData instanceof VolumeObjectTO) {
      VolumeObjectTO volume=(VolumeObjectTO)destData;
      primaryVol=storagePoolMgr.copyPhysicalDisk(tmplVol,volume.getUuid(),primaryPool,cmd.getWaitInMillSeconds());
    }
 else     if (destData instanceof TemplateObjectTO) {
      TemplateObjectTO destTempl=(TemplateObjectTO)destData;
      primaryVol=storagePoolMgr.copyPhysicalDisk(tmplVol,destTempl.getUuid(),primaryPool,cmd.getWaitInMillSeconds());
    }
 else {
      primaryVol=storagePoolMgr.copyPhysicalDisk(tmplVol,UUID.randomUUID().toString(),primaryPool,cmd.getWaitInMillSeconds());
    }
    DataTO data=null;
    if (destData.getObjectType() == DataObjectType.TEMPLATE) {
      TemplateObjectTO newTemplate=new TemplateObjectTO();
      newTemplate.setPath(primaryVol.getName());
      if (primaryPool.getType() == StoragePoolType.RBD) {
        newTemplate.setFormat(ImageFormat.RAW);
      }
 else {
        newTemplate.setFormat(ImageFormat.QCOW2);
      }
      data=newTemplate;
    }
 else     if (destData.getObjectType() == DataObjectType.VOLUME) {
      VolumeObjectTO volumeObjectTO=new VolumeObjectTO();
      volumeObjectTO.setPath(primaryVol.getName());
      if (primaryVol.getFormat() == PhysicalDiskFormat.RAW)       volumeObjectTO.setFormat(ImageFormat.RAW);
 else       if (primaryVol.getFormat() == PhysicalDiskFormat.QCOW2) {
        volumeObjectTO.setFormat(ImageFormat.QCOW2);
      }
      data=volumeObjectTO;
    }
    return new CopyCmdAnswer(data);
  }
 catch (  CloudRuntimeException e) {
    return new CopyCmdAnswer(e.toString());
  }
 finally {
    if (secondaryPool != null) {
      secondaryPool.delete();
    }
  }
}
