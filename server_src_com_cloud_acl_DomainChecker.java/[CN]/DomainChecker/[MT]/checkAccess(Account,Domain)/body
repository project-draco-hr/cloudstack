{
  if (caller.getState() != Account.State.enabled) {
    throw new PermissionDeniedException(caller + " is disabled.");
  }
  long domainId=domain.getId();
  if (domain.getType() == Domain.Type.Project) {
    if (caller.getType() == Account.ACCOUNT_TYPE_NORMAL) {
      if (!_projectMgr.canAccessDomain(caller,domainId)) {
        throw new PermissionDeniedException(caller + " does not have permission to operate within " + domain);
      }
      return true;
    }
 else {
      Project project=_projectMgr.findByProjectDomainId(domainId);
      domainId=project.getProjectDomainId();
    }
  }
  if (caller.getType() == Account.ACCOUNT_TYPE_NORMAL) {
    if (caller.getDomainId() != domainId) {
      throw new PermissionDeniedException(caller + " does not have permission to operate within " + domain);
    }
  }
 else   if (!_domainDao.isChildDomain(caller.getDomainId(),domainId)) {
    throw new PermissionDeniedException(caller + " does not have permission to operate within " + domain);
  }
  return true;
}
