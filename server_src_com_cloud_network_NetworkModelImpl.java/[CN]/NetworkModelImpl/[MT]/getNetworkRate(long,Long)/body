{
  VMInstanceVO vm=null;
  if (vmId != null) {
    vm=_vmDao.findById(vmId);
  }
  Network network=getNetwork(networkId);
  NetworkOffering ntwkOff=_entityMgr.findById(NetworkOffering.class,network.getNetworkOfferingId());
  boolean isUserVmsDefaultNetwork=false;
  boolean isDomRGuestOrPublicNetwork=false;
  boolean isSystemVmNetwork=false;
  if (vm != null) {
    Nic nic=_nicDao.findByNtwkIdAndInstanceId(networkId,vmId);
    if (vm.getType() == Type.User && nic != null && nic.isDefaultNic()) {
      isUserVmsDefaultNetwork=true;
    }
 else     if (vm.getType() == Type.DomainRouter && ntwkOff != null && (ntwkOff.getTrafficType() == TrafficType.Public || ntwkOff.getTrafficType() == TrafficType.Guest)) {
      isDomRGuestOrPublicNetwork=true;
    }
 else     if (vm.getType() == Type.ConsoleProxy || vm.getType() == Type.SecondaryStorageVm) {
      isSystemVmNetwork=true;
    }
  }
  if (isUserVmsDefaultNetwork || isDomRGuestOrPublicNetwork) {
    return _configMgr.getServiceOfferingNetworkRate(vm.getServiceOfferingId(),network.getDataCenterId());
  }
 else   if (isSystemVmNetwork) {
    return -1;
  }
 else {
    return _configMgr.getNetworkOfferingNetworkRate(ntwkOff.getId(),network.getDataCenterId());
  }
}
