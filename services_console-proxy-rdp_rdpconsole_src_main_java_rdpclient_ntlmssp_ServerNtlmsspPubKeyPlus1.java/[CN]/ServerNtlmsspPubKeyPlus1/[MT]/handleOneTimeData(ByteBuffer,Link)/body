{
  TSRequest tsRequest=new TSRequest("TSRequest");
  tsRequest.readTag(buf);
  ByteBuffer encryptedPubKey=tsRequest.pubKeyAuth.value;
  if (encryptedPubKey == null || encryptedPubKey.length == 0)   throw new RuntimeException("[" + this + "] ERROR: Unexpected message from RDP server. Expected encrypted server public key but got nothing instead. Data: "+ buf);
  byte[] decryptedPubKey=ntlmState.ntlm_DecryptMessage(encryptedPubKey.toByteArray());
  decryptedPubKey[0]--;
  if (!Arrays.equals(decryptedPubKey,ntlmState.subjectPublicKey))   throw new RuntimeException("[" + this + "] ERROR: Unexpected message from RDP server. Expected encrypted server public key but an unknown response. Encryted key after decryption: "+ new ByteBuffer(decryptedPubKey).toPlainHexString());
  buf.unref();
  switchOff();
}
