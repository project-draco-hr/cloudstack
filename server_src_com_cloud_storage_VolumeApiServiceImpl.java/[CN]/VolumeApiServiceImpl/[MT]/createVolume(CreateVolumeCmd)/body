{
  VolumeVO volume=_volsDao.findById(cmd.getEntityId());
  boolean created=true;
  try {
    if (cmd.getSnapshotId() != null) {
      volume=createVolumeFromSnapshot(volume,cmd.getSnapshotId());
      if (volume.getState() != Volume.State.Ready) {
        created=false;
      }
    }
    return volume;
  }
 catch (  Exception e) {
    created=false;
    s_logger.debug("Failed to create volume: " + volume.getId(),e);
    return null;
  }
 finally {
    if (!created) {
      s_logger.trace("Decrementing volume resource count for account id=" + volume.getAccountId() + " as volume failed to create on the backend");
      _resourceLimitMgr.decrementResourceCount(volume.getAccountId(),ResourceType.volume);
      _resourceLimitMgr.decrementResourceCount(volume.getAccountId(),ResourceType.primary_storage,new Long(volume.getSize()));
    }
  }
}
