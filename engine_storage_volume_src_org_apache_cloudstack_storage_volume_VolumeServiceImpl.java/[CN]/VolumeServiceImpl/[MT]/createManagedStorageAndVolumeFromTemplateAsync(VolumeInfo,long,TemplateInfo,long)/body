{
  PrimaryDataStore destPrimaryDataStore=dataStoreMgr.getPrimaryDataStore(destDataStoreId);
  TemplateInfo destTemplateInfo=(TemplateInfo)destPrimaryDataStore.create(srcTemplateInfo);
  Host destHost=_hostDao.findById(destHostId);
  if (destHost == null) {
    throw new CloudRuntimeException("Destinatin host should not be null.");
  }
  AsyncCallFuture<VolumeApiResult> future=new AsyncCallFuture<VolumeApiResult>();
  try {
    AsyncCallFuture<VolumeApiResult> createVolumeFuture=createVolumeAsync(volumeInfo,destPrimaryDataStore);
    VolumeApiResult createVolumeResult=createVolumeFuture.get();
    if (createVolumeResult.isFailed()) {
      throw new CloudRuntimeException("Creation of a volume failed: " + createVolumeResult.getResult());
    }
    volumeInfo=volFactory.getVolume(volumeInfo.getId(),destPrimaryDataStore);
    grantAccess(volumeInfo,destHost,destPrimaryDataStore);
    ManagedCreateBaseImageContext<CreateCmdResult> context=new ManagedCreateBaseImageContext<CreateCmdResult>(null,volumeInfo,destPrimaryDataStore,srcTemplateInfo,future);
    AsyncCallbackDispatcher<VolumeServiceImpl,CopyCommandResult> caller=AsyncCallbackDispatcher.create(this);
    caller.setCallback(caller.getTarget().managedCopyBaseImageCallback(null,null)).setContext(context);
    Map<String,String> details=new HashMap<String,String>();
    details.put(PrimaryDataStore.MANAGED,Boolean.TRUE.toString());
    details.put(PrimaryDataStore.STORAGE_HOST,destPrimaryDataStore.getHostAddress());
    details.put(PrimaryDataStore.STORAGE_PORT,String.valueOf(destPrimaryDataStore.getPort()));
    details.put(PrimaryDataStore.MANAGED_STORE_TARGET,volumeInfo.get_iScsiName());
    details.put(PrimaryDataStore.MANAGED_STORE_TARGET_ROOT_VOLUME,volumeInfo.getName());
    details.put(PrimaryDataStore.VOLUME_SIZE,String.valueOf(volumeInfo.getSize()));
    ChapInfo chapInfo=getChapInfo(volumeInfo,destPrimaryDataStore);
    if (chapInfo != null) {
      details.put(PrimaryDataStore.CHAP_INITIATOR_USERNAME,chapInfo.getInitiatorUsername());
      details.put(PrimaryDataStore.CHAP_INITIATOR_SECRET,chapInfo.getInitiatorSecret());
      details.put(PrimaryDataStore.CHAP_TARGET_USERNAME,chapInfo.getTargetUsername());
      details.put(PrimaryDataStore.CHAP_TARGET_SECRET,chapInfo.getTargetSecret());
    }
    destPrimaryDataStore.setDetails(details);
    motionSrv.copyAsync(srcTemplateInfo,destTemplateInfo,destHost,caller);
  }
 catch (  Throwable t) {
    String errMsg=t.toString();
    volumeInfo.processEvent(Event.DestroyRequested);
    revokeAccess(volumeInfo,destHost,destPrimaryDataStore);
    try {
      AsyncCallFuture<VolumeApiResult> expungeVolumeFuture=expungeVolumeAsync(volumeInfo);
      VolumeApiResult expungeVolumeResult=expungeVolumeFuture.get();
      if (expungeVolumeResult.isFailed()) {
        errMsg+=" : Failed to expunge a volume that was created";
      }
    }
 catch (    Exception ex) {
      errMsg+=" : " + ex.getMessage();
    }
    VolumeApiResult result=new VolumeApiResult(volumeInfo);
    result.setResult(errMsg);
    future.complete(result);
  }
  return future;
}
