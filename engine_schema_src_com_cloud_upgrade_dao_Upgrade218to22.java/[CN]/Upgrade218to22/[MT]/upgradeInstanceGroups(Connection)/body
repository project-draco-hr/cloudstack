{
  try (PreparedStatement globalSelect=conn.prepareStatement("SELECT DISTINCT v.group, v.account_id from vm_instance v where v.group is not null");ResultSet globalResult=globalSelect.executeQuery()){
    ArrayList<Object[]> groups=new ArrayList<Object[]>();
    while (globalResult.next()) {
      Object[] group=new Object[10];
      group[0]=globalResult.getString(1);
      group[1]=globalResult.getLong(2);
      groups.add(group);
    }
    for (    Object[] group : groups) {
      String groupName=(String)group[0];
      Long accountId=(Long)group[1];
      createInstanceGroups(conn,groupName,accountId);
    }
    try (PreparedStatement detailSelect=conn.prepareStatement("SELECT g.id, v.id from vm_instance v, instance_group g where g.name=v.group and g.account_id=v.account_id and v.group is not null");ResultSet detailResult=detailSelect.executeQuery()){
      ArrayList<Object[]> groupVmMaps=new ArrayList<Object[]>();
      while (detailResult.next()) {
        Object[] groupMaps=new Object[10];
        groupMaps[0]=detailResult.getLong(1);
        groupMaps[1]=detailResult.getLong(2);
        groupVmMaps.add(groupMaps);
      }
      for (      Object[] groupMap : groupVmMaps) {
        Long groupId=(Long)groupMap[0];
        Long instanceId=(Long)groupMap[1];
        createInstanceGroupVmMaps(conn,groupId,instanceId);
      }
    }
   }
 catch (  SQLException e) {
    throw new CloudRuntimeException("Can't update instance groups ",e);
  }
}
