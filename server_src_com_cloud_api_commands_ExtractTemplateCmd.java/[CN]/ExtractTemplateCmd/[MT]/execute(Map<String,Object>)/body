{
  String url=(String)params.get(BaseCmd.Properties.URL.getName());
  Long templateId=(Long)params.get(BaseCmd.Properties.ID.getName());
  Long zoneId=(Long)params.get(BaseCmd.Properties.ZONE_ID.getName());
  Account account=(Account)params.get(BaseCmd.Properties.ACCOUNT_OBJ.getName());
  ManagementServer managementServer=getManagementServer();
  VMTemplateVO template=managementServer.findTemplateById(templateId.longValue());
  if (template == null) {
    throw new ServerApiException(BaseCmd.INTERNAL_ERROR,"Unable to find template with id " + templateId);
  }
  if (template.getFormat() == ImageFormat.ISO) {
    throw new ServerApiException(BaseCmd.INTERNAL_ERROR,"Unsupported format, could not extract the template");
  }
  if (url.toLowerCase().contains("file://")) {
    throw new ServerApiException(BaseCmd.PARAM_ERROR,"file:// type urls are currently unsupported");
  }
  if (account != null) {
    if (!isAdmin(account.getType())) {
      if (template.getAccountId() != account.getId()) {
        throw new ServerApiException(BaseCmd.PARAM_ERROR,"Unable to find template with ID: " + templateId + " for account: "+ account.getAccountName());
      }
    }
 else     if (!managementServer.isChildDomain(account.getDomainId(),managementServer.findDomainIdByAccountId(template.getAccountId()))) {
      throw new ServerApiException(BaseCmd.PARAM_ERROR,"Unable to extract template " + templateId + " to "+ url+ ", permission denied.");
    }
  }
  try {
    managementServer.extractTemplate(url,templateId,zoneId);
  }
 catch (  Exception e) {
    s_logger.error(e.getMessage(),e);
    throw new ServerApiException(BaseCmd.INTERNAL_ERROR,"Internal Error Extracting the template " + e.getMessage());
  }
  DataCenterVO zone=managementServer.getDataCenterBy(zoneId);
  List<Pair<String,Object>> response=new ArrayList<Pair<String,Object>>();
  response.add(new Pair<String,Object>(BaseCmd.Properties.TEMPLATE_ID.getName(),templateId));
  response.add(new Pair<String,Object>(BaseCmd.Properties.NAME.getName(),template.getName()));
  response.add(new Pair<String,Object>(BaseCmd.Properties.DISPLAY_TEXT.getName(),template.getDisplayText()));
  response.add(new Pair<String,Object>(BaseCmd.Properties.URL.getName(),url));
  response.add(new Pair<String,Object>(BaseCmd.Properties.ZONE_ID.getName(),zoneId));
  response.add(new Pair<String,Object>(BaseCmd.Properties.ZONE_NAME.getName(),zone.getName()));
  response.add(new Pair<String,Object>(BaseCmd.Properties.TEMPLATE_STATUS.getName(),"Processing"));
  return response;
}
