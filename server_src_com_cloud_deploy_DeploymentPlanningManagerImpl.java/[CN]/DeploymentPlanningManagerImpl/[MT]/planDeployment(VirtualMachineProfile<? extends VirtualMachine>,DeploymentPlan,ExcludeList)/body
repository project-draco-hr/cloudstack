{
  VirtualMachine vm=vmProfile.getVirtualMachine();
  long vmGroupCount=_affinityGroupVMMapDao.countAffinityGroupsForVm(vm.getId());
  if (vmGroupCount > 0) {
    for (    AffinityGroupProcessor processor : _affinityProcessors) {
      processor.process(vmProfile,plan,avoids);
    }
  }
  if (s_logger.isDebugEnabled()) {
    s_logger.debug("Deploy avoids pods: " + avoids.getPodsToAvoid() + ", clusters: "+ avoids.getClustersToAvoid()+ ", hosts: "+ avoids.getHostsToAvoid());
  }
  DeployDestination dest=null;
  for (  DeploymentPlanner planner : _planners) {
    if (planner.canHandle(vmProfile,plan,avoids)) {
      dest=planner.plan(vmProfile,plan,avoids);
    }
 else {
      continue;
    }
    if (dest != null) {
      avoids.addHost(dest.getHost().getId());
      break;
    }
  }
  return dest;
}
