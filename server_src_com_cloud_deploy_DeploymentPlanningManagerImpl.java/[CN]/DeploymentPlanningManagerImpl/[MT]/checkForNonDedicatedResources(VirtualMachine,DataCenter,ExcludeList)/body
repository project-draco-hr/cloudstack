{
  boolean isExplicit=false;
  List<AffinityGroupVMMapVO> vmGroupMappings=_affinityGroupVMMapDao.findByVmIdType(vm.getId(),"ExplicitDedication");
  if (vmGroupMappings != null && !vmGroupMappings.isEmpty()) {
    isExplicit=true;
  }
  if (!isExplicit && vm.getType() == VirtualMachine.Type.User) {
    DedicatedResourceVO dedicatedZone=_dedicatedDao.findByZoneId(dc.getId());
    if (dedicatedZone != null) {
      throw new CloudRuntimeException("Failed to deploy VM. Zone " + dc.getName() + " is dedicated.");
    }
    List<HostPodVO> podsInDc=_podDao.listByDataCenterId(dc.getId());
    for (    HostPodVO pod : podsInDc) {
      DedicatedResourceVO dedicatedPod=_dedicatedDao.findByPodId(pod.getId());
      if (dedicatedPod != null) {
        avoids.addPod(dedicatedPod.getPodId());
        if (s_logger.isDebugEnabled()) {
          s_logger.debug("Cannot use this dedicated pod " + pod.getName() + ".");
        }
      }
    }
    List<ClusterVO> clusterInDc=_clusterDao.listClustersByDcId(dc.getId());
    for (    ClusterVO cluster : clusterInDc) {
      DedicatedResourceVO dedicatedCluster=_dedicatedDao.findByClusterId(cluster.getId());
      if (dedicatedCluster != null) {
        avoids.addCluster(dedicatedCluster.getClusterId());
        if (s_logger.isDebugEnabled()) {
          s_logger.debug("Cannot use this dedicated Cluster " + cluster.getName() + ".");
        }
      }
    }
    List<HostVO> hostInDc=_hostDao.listByDataCenterId(dc.getId());
    for (    HostVO host : hostInDc) {
      DedicatedResourceVO dedicatedHost=_dedicatedDao.findByHostId(host.getId());
      if (dedicatedHost != null) {
        avoids.addHost(dedicatedHost.getHostId());
        if (s_logger.isDebugEnabled()) {
          s_logger.debug("Cannot use this dedicated host " + host.getName() + ".");
        }
      }
    }
  }
}
