{
  boolean isExplicit=false;
  VirtualMachine vm=vmProfile.getVirtualMachine();
  List<AffinityGroupVMMapVO> vmGroupMappings=_affinityGroupVMMapDao.findByVmIdType(vm.getId(),"ExplicitDedication");
  if (vmGroupMappings != null && !vmGroupMappings.isEmpty()) {
    isExplicit=true;
  }
  if (!isExplicit && vm.getType() == VirtualMachine.Type.User) {
    DedicatedResourceVO dedicatedZone=_dedicatedDao.findByZoneId(dc.getId());
    if (dedicatedZone != null && dedicatedZone.getDomainId() != null) {
      throw new CloudRuntimeException("Failed to deploy VM. Zone " + dc.getName() + " is dedicated . Please use Explicit Dedication Affinity Group");
    }
    List<Long> allPodsInDc=_podDao.listAllPods(dc.getId());
    List<Long> allDedicatedPods=_dedicatedDao.listAllPods();
    allPodsInDc.retainAll(allDedicatedPods);
    avoids.addPodList(allPodsInDc);
    List<Long> allClustersInDc=_clusterDao.listAllCusters(dc.getId());
    List<Long> allDedicatedClusters=_dedicatedDao.listAllClusters();
    allClustersInDc.retainAll(allDedicatedClusters);
    avoids.addClusterList(allClustersInDc);
    List<Long> allHostsInDc=_hostDao.listAllHosts(dc.getId());
    List<Long> allDedicatedHosts=_dedicatedDao.listAllHosts();
    allHostsInDc.retainAll(allDedicatedHosts);
    avoids.addHostList(allHostsInDc);
  }
}
