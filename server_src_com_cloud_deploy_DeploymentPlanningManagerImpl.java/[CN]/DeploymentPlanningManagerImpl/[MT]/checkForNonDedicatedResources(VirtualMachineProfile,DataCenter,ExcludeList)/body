{
  boolean isExplicit=false;
  VirtualMachine vm=vmProfile.getVirtualMachine();
  DedicatedResourceVO dedicatedZone=_dedicatedDao.findByZoneId(dc.getId());
  if (dedicatedZone != null) {
    long accountDomainId=vmProfile.getOwner().getDomainId();
    long accountId=vmProfile.getOwner().getAccountId();
    if (dedicatedZone.getAccountId() != null) {
      if (dedicatedZone.getAccountId().equals(accountId)) {
        return;
      }
 else {
        throw new CloudRuntimeException("Failed to deploy VM, Zone " + dc.getName() + " not available for the user account "+ vmProfile.getOwner());
      }
    }
    if (!_affinityGroupService.isAffinityGroupAvailableInDomain(dedicatedZone.getAffinityGroupId(),accountDomainId)) {
      throw new CloudRuntimeException("Failed to deploy VM, Zone " + dc.getName() + " not available for the user domain "+ vmProfile.getOwner());
    }
  }
  List<AffinityGroupVMMapVO> vmGroupMappings=_affinityGroupVMMapDao.findByVmIdType(vm.getId(),"ExplicitDedication");
  if (vmGroupMappings != null && !vmGroupMappings.isEmpty()) {
    isExplicit=true;
  }
  if (!isExplicit) {
    List<Long> allPodsInDc=_podDao.listAllPods(dc.getId());
    List<Long> allDedicatedPods=_dedicatedDao.listAllPods();
    allPodsInDc.retainAll(allDedicatedPods);
    avoids.addPodList(allPodsInDc);
    List<Long> allClustersInDc=_clusterDao.listAllCusters(dc.getId());
    List<Long> allDedicatedClusters=_dedicatedDao.listAllClusters();
    allClustersInDc.retainAll(allDedicatedClusters);
    avoids.addClusterList(allClustersInDc);
    List<Long> allHostsInDc=_hostDao.listAllHosts(dc.getId());
    List<Long> allDedicatedHosts=_dedicatedDao.listAllHosts();
    allHostsInDc.retainAll(allDedicatedHosts);
    avoids.addHostList(allHostsInDc);
  }
}
