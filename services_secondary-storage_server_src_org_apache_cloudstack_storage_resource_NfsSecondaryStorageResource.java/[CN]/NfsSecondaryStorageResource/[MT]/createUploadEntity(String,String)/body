{
  TemplateOrVolumePostUploadCommand cmd=getTemplateOrVolumePostUploadCmd(metadata);
  UploadEntity uploadEntity=null;
  if (cmd == null) {
    updateStateMapWithError(uuid,"unable decode and deserialize metadata.");
    throw new InvalidParameterValueException("unable to decode and deserialize metadata");
  }
 else {
    uuid=cmd.getEntityUUID();
    if (uploadEntityStateMap.containsKey(uuid)) {
      uploadEntity=uploadEntityStateMap.get(uuid);
      throw new InvalidParameterValueException("The one time post url is already used and the upload is in " + uploadEntity.getUploadState() + " state.");
    }
    try {
      String absolutePath=cmd.getAbsolutePath();
      uploadEntity=new UploadEntity(uuid,cmd.getEntityId(),UploadEntity.Status.IN_PROGRESS,cmd.getName(),absolutePath);
      uploadEntity.setMetaDataPopulated(true);
      uploadEntity.setResourceType(UploadEntity.ResourceType.valueOf(cmd.getType()));
      uploadEntity.setFormat(Storage.ImageFormat.valueOf(cmd.getImageFormat()));
      uploadEntity.setTemplatePath(absolutePath);
      String dataStoreUrl=cmd.getDataTo();
      String installPathPrefix=this.getRootDir(dataStoreUrl) + File.separator + absolutePath;
      uploadEntity.setInstallPathPrefix(installPathPrefix);
      uploadEntity.setHvm(cmd.getRequiresHvm());
      uploadEntity.setChksum(cmd.getChecksum());
      if (!_storage.exists(installPathPrefix)) {
        _storage.mkdir(installPathPrefix);
      }
      uploadEntityStateMap.put(uuid,uploadEntity);
    }
 catch (    Exception e) {
      s_logger.debug("exception occured while creating upload entity " + e);
      updateStateMapWithError(uuid,e.getMessage());
    }
  }
  return uploadEntity;
}
