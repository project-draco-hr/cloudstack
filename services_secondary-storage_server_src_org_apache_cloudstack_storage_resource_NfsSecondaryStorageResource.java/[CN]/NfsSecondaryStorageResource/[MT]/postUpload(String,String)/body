{
  UploadEntity uploadEntity=uploadEntityStateMap.get(uuid);
  int installTimeoutPerGig=180 * 60 * 1000;
  String resourcePath=uploadEntity.getInstallPathPrefix();
  String finalResourcePath=uploadEntity.getTmpltPath();
  UploadEntity.ResourceType resourceType=uploadEntity.getResourceType();
  String fileSavedTempLocation=uploadEntity.getInstallPathPrefix() + "/" + filename;
  int imgSizeGigs=(int)Math.ceil(_storage.getSize(fileSavedTempLocation) * 1.0d / (1024 * 1024 * 1024));
  imgSizeGigs++;
  long timeout=(long)imgSizeGigs * installTimeoutPerGig;
  Script scr=new Script(getScriptLocation(resourceType),timeout,s_logger);
  scr.add("-s",Integer.toString(imgSizeGigs));
  scr.add("-S",Long.toString(UploadEntity.s_maxTemplateSize));
  if (uploadEntity.isHvm()) {
    scr.add("-h");
  }
  String extension=uploadEntity.getFormat().getFileExtension();
  String templateName="";
  if (extension.equals("iso")) {
    templateName=uploadEntity.getUuid().trim().replace(" ","_");
  }
 else {
    templateName=java.util.UUID.nameUUIDFromBytes((uploadEntity.getFilename() + System.currentTimeMillis()).getBytes()).toString();
  }
  String templateFilename=templateName + "." + extension;
  uploadEntity.setTemplatePath(finalResourcePath + "/" + templateFilename);
  scr.add("-n",templateFilename);
  scr.add("-t",resourcePath);
  scr.add("-f",fileSavedTempLocation);
  if (uploadEntity.getChksum() != null && uploadEntity.getChksum().length() > 1) {
    scr.add("-c",uploadEntity.getChksum());
  }
  scr.add("-u");
  String result;
  result=scr.execute();
  if (result != null) {
    return result;
  }
  File downloadedTemplate=new File(resourcePath + "/" + templateFilename);
  _storage.setWorldReadableAndWriteable(downloadedTemplate);
  String propertiesFile=resourcePath;
  if (resourceType == UploadEntity.ResourceType.TEMPLATE) {
    propertiesFile+="/template.properties";
  }
 else {
    propertiesFile+="/volume.properties";
  }
  File templateProperties=new File(propertiesFile);
  _storage.setWorldReadableAndWriteable(templateProperties);
  TemplateLocation loc=new TemplateLocation(_storage,resourcePath);
  try {
    loc.create(uploadEntity.getEntityId(),true,uploadEntity.getFilename());
  }
 catch (  IOException e) {
    s_logger.warn("Something is wrong with template location " + resourcePath,e);
    loc.purge();
    return "Unable to download due to " + e.getMessage();
  }
  Map<String,Processor> processors=_dlMgr.getProcessors();
  for (  Processor processor : processors.values()) {
    FormatInfo info=null;
    try {
      info=processor.process(resourcePath,null,templateName);
    }
 catch (    InternalErrorException e) {
      s_logger.error("Template process exception ",e);
      return e.toString();
    }
    if (info != null) {
      loc.addFormat(info);
      uploadEntity.setVirtualSize(info.virtualSize);
      uploadEntity.setPhysicalSize(info.size);
      break;
    }
  }
  if (!loc.save()) {
    s_logger.warn("Cleaning up because we're unable to save the formats");
    loc.purge();
  }
  uploadEntity.setStatus(UploadEntity.Status.COMPLETED);
  uploadEntityStateMap.put(uploadEntity.getUuid(),uploadEntity);
  return null;
}
