{
  HttpEntity entity=null;
  if (httpRequest instanceof HttpEntityEnclosingRequest) {
    entity=((HttpEntityEnclosingRequest)httpRequest).getEntity();
  }
  byte[] data;
  if (entity == null) {
    httpResponse.setEntity(new StringEntity("upload failed"));
    httpResponse.setStatusCode(HttpStatus.SC_UNPROCESSABLE_ENTITY);
    return;
  }
 else {
    data=EntityUtils.toByteArray(entity);
  }
  ByteArrayInputStream inputStream=new ByteArrayInputStream(data);
  ByteArrayOutputStream output=new ByteArrayOutputStream();
  HashMap<String,String> params=new HashMap<>();
  parsePostBody(inputStream,output,params);
  String encodedMetadata=params.get("metadata");
  String key=FileUtils.readFileToString(new File(POST_UPLOAD_KEY_LOCATION),"utf-8");
  String metadata=EncryptionUtil.decodeData(encodedMetadata,key);
  Gson gson=new GsonBuilder().create();
  TemplateOrVolumePostUploadCommand cmd=gson.fromJson(metadata,TemplateOrVolumePostUploadCommand.class);
  handleuplod(cmd.getEntityId(),cmd.getAbsolutePath(),cmd.getEntityUUID(),cmd.getLocalPath(),cmd.getName(),output.size(),cmd.getType(),cmd.getImageFormat(),output.toByteArray(),false,cmd.getChecksum(),cmd.getDataTo());
  s_logger.error(new String(data));
  httpResponse.setEntity(new StringEntity("upload successful"));
}
