{
  UploadEntity uploadEntity=null;
  try {
    if (uploadEntityStateMap.containsKey(entityId)) {
      uploadEntity=uploadEntityStateMap.get(entityId);
      uploadEntity.getFilewriter().write(data);
      uploadEntity.incremetByteCount(data.length);
      if (uploadEntity.getDownloadedsize() == uploadEntity.getEntitysize()) {
        uploadEntity.setStatus(UploadEntity.Status.COMPLETED);
        uploadEntity.getFile().renameTo(new File(uploadEntity.getAbsoluteFilePath()));
        uploadEntity.getFilewriter().close();
      }
 else {
        uploadEntity.setStatus(UploadEntity.Status.IN_PROGRESS);
      }
    }
 else {
      uploadEntity=new UploadEntity(entitySize,UploadEntity.Status.IN_PROGRESS,entityName,absolutePath);
      uploadEntityStateMap.put(entityId,uploadEntity);
      File tempFile=File.createTempFile("dnld_" + entityId,absolutePath);
      FileOutputStream filewriter=new FileOutputStream(tempFile.getAbsolutePath());
      uploadEntity.setFilewriter(filewriter);
      filewriter.write(data);
      uploadEntity.setFile(tempFile);
      uploadEntity.incremetByteCount(data.length);
    }
  }
 catch (  Exception e) {
    uploadEntity.setErrorMessage(e.getMessage());
    uploadEntity.setStatus(UploadEntity.Status.ERROR);
    try {
      uploadEntity.getFilewriter().close();
    }
 catch (    Exception io) {
      s_logger.debug("exception occured when closing a file object " + io.getMessage());
    }
    s_logger.debug("exception occured while writing to a file " + e);
  }
}
