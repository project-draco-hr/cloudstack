{
  Connection slaveConn=null;
  Connection c=null;
  try {
    s_logger.debug("Trying to transition master to " + slaveIp);
    slaveConn=new Connection(getURL(slaveIp),100);
    Session.slaveLocalLoginWithPassword(slaveConn,username,password);
    Pool.emergencyTransitionToMaster(slaveConn);
    try {
      Session.localLogout(slaveConn);
      slaveConn=null;
    }
 catch (    Exception e) {
    }
    forceSleep(10);
    c=new Connection(getURL(slaveIp),100);
    for (int i=0; i < 30; i++) {
      try {
        Session.loginWithPassword(c,username,password,APIVersion.latest().toString());
        s_logger.debug("Succeeded to transition master to " + slaveIp);
        return;
      }
 catch (      Types.HostIsSlave e) {
        s_logger.debug("HostIsSlave: Still waiting for the conversion to the master " + slaveIp);
      }
catch (      Exception e) {
        s_logger.debug("Exception: Still waiting for the conversion to the master");
      }
      forceSleep(2);
    }
    throw new RuntimeException("EmergencyTransitionToMaster failed after retry 30 times");
  }
 catch (  Exception e) {
    throw new RuntimeException("EmergencyTransitionToMaster failed due to " + e.getMessage());
  }
 finally {
    if (slaveConn != null) {
      try {
        Session.localLogout(slaveConn);
      }
 catch (      Exception e) {
      }
    }
    if (c != null) {
      try {
        Session.logout(c);
        c.dispose();
      }
 catch (      Exception e) {
      }
    }
  }
}
