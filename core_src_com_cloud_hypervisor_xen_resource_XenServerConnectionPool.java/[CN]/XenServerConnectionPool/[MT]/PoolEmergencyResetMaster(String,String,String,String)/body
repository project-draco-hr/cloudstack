{
  Connection slaveConn=null;
  try {
    s_logger.debug("Trying to reset master of slave " + slaveIp + " to "+ masterIp);
    slaveConn=new Connection(getURL(slaveIp),10);
    Session.slaveLocalLoginWithPassword(slaveConn,username,password);
    Pool.emergencyResetMaster(slaveConn,masterIp);
    if (slaveConn != null) {
      try {
        Session.localLogout(slaveConn);
      }
 catch (      Exception e) {
      }
    }
    forceSleep(10);
    for (int i=0; i < 30; i++) {
      try {
        Session.slaveLocalLoginWithPassword(slaveConn,username,password);
        Pool.Record pr=getPoolRecord(slaveConn);
        String mIp=pr.master.getAddress(slaveConn);
        if (mIp.trim().equals(masterIp.trim())) {
          s_logger.debug("Succeeded to reset master of slave " + slaveIp + " to "+ masterIp);
          return;
        }
      }
 catch (      Exception e) {
      }
      if (slaveConn != null) {
        try {
          Session.localLogout(slaveConn);
        }
 catch (        Exception e) {
        }
      }
      forceSleep(2);
    }
  }
 catch (  Exception e) {
  }
 finally {
    if (slaveConn != null) {
      try {
        Session.localLogout(slaveConn);
        slaveConn=null;
      }
 catch (      Exception e) {
      }
    }
  }
  throw new CloudRuntimeException("Unable to reset master of slave " + slaveIp + " to "+ masterIp+ "after 30 retry");
}
