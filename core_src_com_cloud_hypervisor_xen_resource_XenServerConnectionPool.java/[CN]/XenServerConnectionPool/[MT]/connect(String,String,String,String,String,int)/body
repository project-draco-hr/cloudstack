{
  XenServerConnection mConn=null;
  Connection sConn=null;
  String masterIp=null;
  if (hostUuid == null || poolUuid == null || ipAddress == null || username == null || password == null) {
    String msg="Connect some parameter are null hostUuid:" + hostUuid + " ,poolUuid:"+ poolUuid+ " ,ipAddress:"+ ipAddress;
    s_logger.debug(msg);
    throw new CloudRuntimeException(msg);
  }
synchronized (poolUuid.intern()) {
    mConn=getConnect(poolUuid);
    if (mConn != null) {
      try {
        Host.getByUuid(mConn,hostUuid);
        return mConn;
      }
 catch (      Types.SessionInvalid e) {
        s_logger.debug("Session thgrough ip " + mConn.getIp() + " is invalid for pool("+ poolUuid+ ") due to "+ e.toString());
        try {
          Session.loginWithPassword(mConn,mConn.getUsername(),mConn.getPassword(),APIVersion.latest().toString());
        }
 catch (        Exception e1) {
          if (s_logger.isDebugEnabled()) {
            s_logger.debug("connect through IP(" + mConn.getIp() + " for pool("+ poolUuid+ ") is broken due to "+ e.toString());
          }
          removeConnect(poolUuid);
          mConn=null;
        }
      }
catch (      UuidInvalid e) {
        String msg="Host(" + hostUuid + ") doesn't belong to pool("+ poolUuid+ "), please execute 'xe pool-join master-address="+ mConn.getIp()+ " master-username="+ mConn.getUsername()+ " master-password="+ mConn.getPassword();
        if (s_logger.isDebugEnabled()) {
          s_logger.debug(msg);
        }
        throw new CloudRuntimeException(msg,e);
      }
catch (      Exception e) {
        if (s_logger.isDebugEnabled()) {
          s_logger.debug("connect through IP(" + mConn.getIp() + " for pool("+ poolUuid+ ") is broken due to "+ e.toString());
        }
        removeConnect(poolUuid);
        mConn=null;
      }
    }
    if (s_logger.isDebugEnabled()) {
      s_logger.debug("Logging on as the slave to " + ipAddress);
    }
    try {
      sConn=new Connection(getURL(ipAddress));
      Session.slaveLocalLoginWithPassword(sConn,username,password);
    }
 catch (    Exception e) {
      String msg="Unable to create slave connection to host(" + hostUuid + ") due to "+ e.toString();
      if (s_logger.isDebugEnabled()) {
        s_logger.debug(msg);
      }
      throw new CloudRuntimeException(msg,e);
    }
    Pool.Record pr=null;
    try {
      pr=getPoolRecord(sConn);
    }
 catch (    Exception e) {
      PoolEmergencyTransitionToMaster(ipAddress,username,password);
      mConn=new XenServerConnection(getURL(ipAddress),ipAddress,username,password,_retries,_interval,wait);
      try {
        Session.loginWithPassword(mConn,username,password,APIVersion.latest().toString());
        pr=getPoolRecord(mConn);
      }
 catch (      Exception e1) {
        String msg="Unable to create master connection to host(" + hostUuid + ") after transition it to master, due to "+ e1.toString();
        if (s_logger.isDebugEnabled()) {
          s_logger.debug(msg);
        }
        throw new CloudRuntimeException(msg,e1);
      }
      if (!pr.uuid.equals(poolUuid)) {
        String msg="host(" + hostUuid + ") should be in pool("+ poolUuid+ "), but it is actually in pool("+ pr.uuid+ ")";
        if (s_logger.isDebugEnabled()) {
          s_logger.debug(msg);
        }
        throw new CloudRuntimeException(msg);
      }
 else {
        ensurePoolIntegrity(mConn,ipAddress,username,password,wait);
        addConnect(poolUuid,mConn);
        return mConn;
      }
    }
    if (!pr.uuid.equals(poolUuid)) {
      String msg="host(" + hostUuid + ") should be in pool("+ poolUuid+ "), but it is actually in pool("+ pr.uuid+ ")";
      if (s_logger.isDebugEnabled()) {
        s_logger.debug(msg);
      }
      throw new CloudRuntimeException(msg);
    }
    try {
      masterIp=pr.master.getAddress(sConn);
      mConn=new XenServerConnection(getURL(masterIp),masterIp,username,password,_retries,_interval,wait);
      Session.loginWithPassword(mConn,username,password,APIVersion.latest().toString());
      addConnect(poolUuid,mConn);
      return mConn;
    }
 catch (    Exception e) {
      String msg="Unable to logon in " + masterIp + " as master in pool("+ poolUuid+ ")";
      if (s_logger.isDebugEnabled()) {
        s_logger.debug(msg);
      }
      throw new CloudRuntimeException(msg);
    }
  }
}
