{
  Connection slaveConn=null;
  Connection masterConn=null;
  try {
    slaveConn=new Connection(getURL(ip),100);
    Session.slaveLocalLoginWithPassword(slaveConn,username,password);
    if (s_logger.isDebugEnabled()) {
      s_logger.debug("Slave logon to " + ip);
    }
    String masterIp=null;
    try {
      Pool.Record pr=getPoolRecord(slaveConn);
      Host master=pr.master;
      masterIp=master.getAddress(slaveConn);
      s_logger.debug("Logging on as the master to " + masterIp);
      masterConn=new Connection(getURL(masterIp),100);
      Session.loginWithPassword(masterConn,username,password,APIVersion.latest().toString());
      return masterConn;
    }
 catch (    Exception e) {
      s_logger.debug("Failed to log on as master to ");
      if (masterConn != null) {
        try {
          Session.logout(masterConn);
        }
 catch (        Exception e1) {
        }
        masterConn.dispose();
        masterConn=null;
      }
    }
  }
 catch (  Exception e) {
    s_logger.debug("Failed to slave local login to " + ip);
  }
 finally {
    if (slaveConn != null) {
      try {
        Session.localLogout(slaveConn);
      }
 catch (      Exception e1) {
      }
      slaveConn.dispose();
      slaveConn=null;
    }
  }
  return null;
}
