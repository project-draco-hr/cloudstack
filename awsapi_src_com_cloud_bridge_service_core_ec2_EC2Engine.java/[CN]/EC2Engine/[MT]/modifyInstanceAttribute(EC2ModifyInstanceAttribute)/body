{
  boolean status=true;
  String instanceId=request.getInstanceId();
  try {
    EC2DescribeInstancesResponse vmResponse=new EC2DescribeInstancesResponse();
    vmResponse=lookupInstances(instanceId,vmResponse,null);
    EC2Instance[] instances=vmResponse.getInstanceSet();
    if (!instances[0].getState().equalsIgnoreCase("stopped")) {
      throw new Exception("Cannot modify, instance should be in stopped state");
    }
    if (request.getInstanceType() != null) {
      String instanceType=request.getInstanceType();
      CloudStackServiceOfferingVO svcOffering=getCSServiceOfferingId(instanceType);
      if (svcOffering == null)       throw new Exception("instanceType not found");
      CloudStackUserVm userVm=getApi().changeServiceForVirtualMachine(instanceId,svcOffering.getId());
      status=(userVm != null);
    }
    if (status != false && request.getUserData() != null) {
      CloudStackUserVm userVm=getApi().updateVirtualMachine(instanceId,null,null,null,null,request.getUserData());
      status=(userVm != null);
    }
  }
 catch (  Exception e) {
    logger.error("ModifyInstanceAttribute - ",e);
    handleException(e);
  }
  return status;
}
