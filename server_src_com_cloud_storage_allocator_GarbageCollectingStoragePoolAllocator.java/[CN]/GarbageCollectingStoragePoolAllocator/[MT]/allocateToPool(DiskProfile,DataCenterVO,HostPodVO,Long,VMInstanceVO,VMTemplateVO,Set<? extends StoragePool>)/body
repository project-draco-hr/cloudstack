{
  if (!_storagePoolCleanupEnabled) {
    s_logger.debug("Storage pool cleanup is not enabled, so GarbageCollectingStoragePoolAllocator is being skipped.");
    return null;
  }
  _storageMgr.cleanupStorage(false);
  StoragePoolAllocator allocator;
  if (localStorageAllocationNeeded(dskCh,vm)) {
    allocator=_localStoragePoolAllocator;
  }
 else {
    allocator=_firstFitStoragePoolAllocator;
  }
  Set<StoragePool> myAvoids=new HashSet<StoragePool>();
  for (  StoragePool pool : avoid) {
    myAvoids.add(pool);
  }
  return allocator.allocateToPool(dskCh,dc,pod,clusterId,vm,template,myAvoids);
}
