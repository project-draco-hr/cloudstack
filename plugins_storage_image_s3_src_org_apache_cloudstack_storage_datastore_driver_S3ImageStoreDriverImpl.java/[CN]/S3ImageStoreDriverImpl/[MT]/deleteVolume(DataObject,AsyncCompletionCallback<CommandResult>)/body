{
  VolumeVO vol=volumeDao.findById(data.getId());
  if (s_logger.isDebugEnabled()) {
    s_logger.debug("Expunging " + vol);
  }
  VolumeDataStoreVO volumeStore=_volumeStoreDao.findByVolume(vol.getId());
  if (volumeStore != null) {
    if (volumeStore.getDownloadState() == VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {
      DataStore store=_dataStoreMgr.getDataStore(volumeStore.getDataStoreId(),DataStoreRole.Image);
      EndPoint ep=_epSelector.select(store);
      DeleteVolumeCommand dtCommand=new DeleteVolumeCommand(store.getTO(),volumeStore.getVolumeId(),volumeStore.getInstallPath());
      Answer answer=ep.sendMessage(dtCommand);
      if (answer == null || !answer.getResult()) {
        s_logger.debug("Failed to delete " + volumeStore + " due to "+ ((answer == null) ? "answer is null" : answer.getDetails()));
        return;
      }
    }
 else     if (volumeStore.getDownloadState() == VMTemplateStorageResourceAssoc.Status.DOWNLOAD_IN_PROGRESS) {
      s_logger.debug("Volume: " + vol.getName() + " is currently being uploaded; cant' delete it.");
      throw new CloudRuntimeException("Please specify a volume that is not currently being uploaded.");
    }
    _volumeStoreDao.remove(volumeStore.getId());
    volumeDao.remove(vol.getId());
    CommandResult result=new CommandResult();
    callback.complete(result);
    return;
  }
}
