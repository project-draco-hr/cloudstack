{
  Long routerId=cmd.getId();
  Long serviceOfferingId=cmd.getServiceOfferingId();
  Account account=(Account)UserContext.current().getAccountObject();
  DomainRouterVO router=_routerDao.findById(routerId);
  if (router == null) {
    throw new InvalidParameterValueException("Unable to find router with id " + routerId);
  }
  if ((account != null) && !_domainDao.isChildDomain(account.getDomainId(),router.getDomainId())) {
    throw new PermissionDeniedException("Invalid domain router id (" + routerId + ") given, unable to stop router.");
  }
  if (router.getServiceOfferingId() == serviceOfferingId) {
    s_logger.debug("Router: " + routerId + "already has service offering: "+ serviceOfferingId);
    return true;
  }
  ServiceOfferingVO newServiceOffering=_serviceOfferingDao.findById(serviceOfferingId);
  if (newServiceOffering == null) {
    throw new InvalidParameterValueException("Unable to find service offering with id " + serviceOfferingId);
  }
  ServiceOfferingVO currentServiceOffering=_serviceOfferingDao.findById(router.getServiceOfferingId());
  if (!currentServiceOffering.getGuestIpType().equals(newServiceOffering.getGuestIpType())) {
    throw new InvalidParameterValueException("Can't upgrade, due to new newtowrk type: " + newServiceOffering.getGuestIpType() + " is different from "+ "curruent network type: "+ currentServiceOffering.getGuestIpType());
  }
  if (currentServiceOffering.getUseLocalStorage() != newServiceOffering.getUseLocalStorage()) {
    throw new InvalidParameterValueException("Can't upgrade, due to new local storage status : " + newServiceOffering.getGuestIpType() + " is different from "+ "curruent local storage status: "+ currentServiceOffering.getUseLocalStorage());
  }
  router=_routerDao.acquire(routerId);
  router.setServiceOfferingId(serviceOfferingId);
  return _routerDao.update(routerId,router);
}
