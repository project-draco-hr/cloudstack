{
  if (router.getRole() == Role.DHCP_FIREWALL_LB_PASSWD_USERDATA) {
    final List<IPAddressVO> ipAddrs=_networkMgr.listPublicIpAddressesInVirtualNetwork(router.getAccountId(),router.getDataCenterId(),null);
    final List<String> ipAddrList=new ArrayList<String>();
    for (    final IPAddressVO ipVO : ipAddrs) {
      ipAddrList.add(ipVO.getAddress());
    }
    if (!ipAddrList.isEmpty()) {
      final boolean success=_networkMgr.associateIP(router,ipAddrList,true,0);
      if (!success) {
        return false;
      }
    }
    final List<FirewallRuleVO> fwRules=new ArrayList<FirewallRuleVO>();
    for (    final IPAddressVO ipVO : ipAddrs) {
      fwRules.addAll(_rulesDao.listIPForwarding(ipVO.getAddress()));
    }
    final List<FirewallRuleVO> result=_networkMgr.updateFirewallRules(router.getPublicIpAddress(),fwRules,router);
    if (result.size() != fwRules.size()) {
      return false;
    }
  }
  return resendDhcpEntries(router);
}
