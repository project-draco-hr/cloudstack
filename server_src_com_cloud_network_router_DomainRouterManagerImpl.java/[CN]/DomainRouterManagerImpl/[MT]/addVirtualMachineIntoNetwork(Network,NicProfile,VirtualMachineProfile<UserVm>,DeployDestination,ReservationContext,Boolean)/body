{
  VirtualRouter router=startDhcp ? deployDhcp(network,dest,profile.getOwner()) : deployVirtualRouter(network,dest,profile.getOwner());
  String password=profile.getVirtualMachine().getPassword();
  String userData=profile.getVirtualMachine().getUserData();
  Commands cmds=new Commands(OnError.Stop);
  String routerPublicIpAddress=nic.getIp4Address();
  String routerControlIpAddress=null;
  List<NicVO> nics=_nicDao.listBy(router.getId());
  for (  NicVO n : nics) {
    NetworkVO nc=_networksDao.findById(n.getNetworkId());
    if (n.getIp4Address() != null && nc.getTrafficType() == TrafficType.Public) {
      routerPublicIpAddress=nic.getIp4Address();
    }
 else     if (nc.getTrafficType() == TrafficType.Control) {
      routerControlIpAddress=n.getIp4Address();
    }
  }
  cmds.addCommand("dhcp",new DhcpEntryCommand(nic.getMacAddress(),nic.getIp4Address(),routerControlIpAddress,profile.getVirtualMachine().getName()));
  if (password != null) {
    final String encodedPassword=rot13(password);
    cmds.addCommand("password",new SavePasswordCommand(encodedPassword,nic.getIp4Address(),routerControlIpAddress,profile.getVirtualMachine().getName()));
  }
  String serviceOffering=_serviceOfferingDao.findById(profile.getServiceOfferingId()).getDisplayText();
  String zoneName=_dcDao.findById(network.getDataCenterId()).getName();
  cmds.addCommand("vmdata",generateVmDataCommand(routerControlIpAddress,routerPublicIpAddress,nic.getIp4Address(),userData,serviceOffering,zoneName,nic.getIp4Address(),profile.getVirtualMachine().getName(),profile.getVirtualMachine().getInstanceName(),profile.getId()));
  try {
    _agentMgr.send(router.getHostId(),cmds);
  }
 catch (  OperationTimedoutException e) {
    throw new AgentUnavailableException("Unable to reach the agent ",router.getHostId(),e);
  }
  Answer answer=cmds.getAnswer("dhcp");
  if (!answer.getResult()) {
    s_logger.error("Unable to set dhcp entry for " + profile + " on domR: "+ router.getName()+ " due to "+ answer.getDetails());
    throw new ResourceUnavailableException("Unable to set dhcp entry for " + profile + " due to "+ answer.getDetails(),DataCenter.class,router.getDataCenterId());
  }
  answer=cmds.getAnswer("password");
  if (answer != null && !answer.getResult()) {
    s_logger.error("Unable to set password for " + profile + " due to "+ answer.getDetails());
    throw new ResourceUnavailableException("Unable to set password due to " + answer.getDetails(),DataCenter.class,router.getDataCenterId());
  }
  answer=cmds.getAnswer("vmdata");
  if (answer != null && !answer.getResult()) {
    s_logger.error("Unable to set VM data for " + profile + " due to "+ answer.getDetails());
    throw new ResourceUnavailableException("Unable to set VM data due to " + answer.getDetails(),DataCenter.class,router.getDataCenterId());
  }
  return router;
}
