{
  boolean sourceNat=false;
  Map<VlanVO,ArrayList<IpAddress>> vlanIpMap=new HashMap<VlanVO,ArrayList<IpAddress>>();
  for (  final IpAddress ip : ipAddrList) {
    VlanVO vlan=_vlanDao.findById(ip.getVlanId());
    ArrayList<IpAddress> ipList=vlanIpMap.get(vlan);
    if (ipList == null) {
      ipList=new ArrayList<IpAddress>();
    }
    ipList.add(ip);
    vlanIpMap.put(vlan,ipList);
  }
  for (  Map.Entry<VlanVO,ArrayList<IpAddress>> vlanAndIp : vlanIpMap.entrySet()) {
    boolean firstIP=true;
    ArrayList<IpAddress> ipList=vlanAndIp.getValue();
    Collections.sort(ipList,new Comparator<IpAddress>(){
      @Override public int compare(      IpAddress o1,      IpAddress o2){
        return o1.getAddress().compareTo(o2.getAddress());
      }
    }
);
    for (    final IpAddress ip : ipList) {
      boolean add=(ip.getState() == IpAddress.State.Releasing ? false : true);
      sourceNat=ip.isSourceNat();
      VlanVO vlan=vlanAndIp.getKey();
      String vlanId=vlan.getVlanId();
      String vlanGateway=vlan.getVlanGateway();
      String vlanNetmask=vlan.getVlanNetmask();
      String vifMacAddress=null;
      if (firstIP && add) {
        String[] macAddresses=_dcDao.getNextAvailableMacAddressPair(ip.getDataCenterId());
        vifMacAddress=macAddresses[1];
      }
      String vmGuestAddress=null;
      if (vmId != 0) {
        vmGuestAddress=_vmDao.findById(vmId).getGuestIpAddress();
      }
      cmds.addCommand("IPAssocCommand",new IPAssocCommand(router.getInstanceName(),router.getPrivateIpAddress(),ip.getAddress(),add,firstIP,sourceNat,vlanId,vlanGateway,vlanNetmask,vifMacAddress,vmGuestAddress));
      firstIP=false;
    }
  }
  return cmds;
}
