{
  DomainRouterVO router=_routerDao.findByNetworkConfiguration(config.getId());
  try {
    router=start(router,context.getCaller(),context.getAccount());
  }
 catch (  InsufficientNetworkCapacityException e) {
    throw e;
  }
catch (  InsufficientCapacityException e) {
    throw new ResourceUnavailableException("Unable to start router for " + config,e);
  }
  if (router == null) {
    s_logger.error("Can't find a domain router to start VM: " + profile);
    throw new ResourceUnavailableException("Can't find a domain router to start " + profile + " in "+ config);
  }
  String password=null;
  String userData=profile.getVirtualMachine().getUserData();
  Commands cmds=new Commands(OnError.Stop);
  String routerPublicIpAddress=nic.getIp4Address();
  String routerControlIpAddress=null;
  List<NicVO> nics=_nicDao.listBy(router.getId());
  for (  NicVO n : nics) {
    NetworkConfigurationVO nc=_networkConfigurationDao.findById(n.getNetworkConfigurationId());
    if (n.getIp4Address() != null && nc.getTrafficType() == TrafficType.Public) {
      routerPublicIpAddress=nic.getIp4Address();
    }
 else     if (nc.getTrafficType() == TrafficType.Control) {
      routerControlIpAddress=n.getIp4Address();
    }
  }
  cmds.addCommand("dhcp",new DhcpEntryCommand(nic.getMacAddress(),nic.getIp4Address(),routerControlIpAddress,profile.getVirtualMachine().getHostName()));
  if (password != null) {
    final String encodedPassword=rot13(password);
    cmds.addCommand("password",new SavePasswordCommand(encodedPassword,nic.getIp4Address(),routerControlIpAddress,profile.getVirtualMachine().getHostName()));
  }
  String serviceOffering=_serviceOfferingDao.findById(profile.getServiceOfferingId()).getDisplayText();
  String zoneName=_dcDao.findById(config.getDataCenterId()).getName();
  cmds.addCommand("vmdata",generateVmDataCommand(routerControlIpAddress,routerPublicIpAddress,nic.getIp4Address(),userData,serviceOffering,zoneName,nic.getIp4Address(),profile.getVirtualMachine().getHostName(),profile.getVirtualMachine().getHostName(),profile.getId()));
  try {
    _agentMgr.send(router.getHostId(),cmds);
  }
 catch (  AgentUnavailableException e) {
    throw new ResourceUnavailableException("Unable to reach the agent ",e);
  }
catch (  OperationTimedoutException e) {
    throw new ResourceUnavailableException("Unable to reach the agent ",e);
  }
  Answer answer=cmds.getAnswer("dhcp");
  if (!answer.getResult()) {
    s_logger.error("Unable to set dhcp entry for " + profile + " on domR: "+ router.getHostName()+ " due to "+ answer.getDetails());
    throw new ResourceUnavailableException("Unable to set dhcp entry for " + profile + " due to "+ answer.getDetails());
  }
  answer=cmds.getAnswer("password");
  if (answer != null && !answer.getResult()) {
    s_logger.error("Unable to set password for " + profile + " due to "+ answer.getDetails());
    throw new ResourceUnavailableException("Unable to set password due to " + answer.getDetails());
  }
  answer=cmds.getAnswer("vmdata");
  if (answer != null && !answer.getResult()) {
    s_logger.error("Unable to set VM data for " + profile + " due to "+ answer.getDetails());
    throw new ResourceUnavailableException("Unable to set VM data due to " + answer.getDetails());
  }
  return router;
}
