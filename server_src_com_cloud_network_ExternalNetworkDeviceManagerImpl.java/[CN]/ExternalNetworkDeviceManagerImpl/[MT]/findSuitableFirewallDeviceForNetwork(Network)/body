{
  long physicalNetworkId=network.getPhysicalNetworkId();
  List<ExternalFirewallDeviceVO> fwDevices=_externalFirewallDeviceDao.listByPhysicalNetwork(physicalNetworkId);
  for (  ExternalFirewallDeviceVO fwDevice : fwDevices) {
    long fullCapacity=fwDevice.getCapacity();
    List<NetworkExternalFirewallVO> mappedNetworks=_networkExternalFirewallDao.listByFirewallDeviceId(fwDevice.getId());
    long usedCapacity=(mappedNetworks == null) ? 0 : mappedNetworks.size();
    if ((fullCapacity - usedCapacity) > 0) {
      return fwDevice.getId();
    }
  }
  throw new InsufficientNetworkCapacityException("Unable to find a firewall provider with sufficient capcity " + " to implement the network",Network.class,network.getId());
}
