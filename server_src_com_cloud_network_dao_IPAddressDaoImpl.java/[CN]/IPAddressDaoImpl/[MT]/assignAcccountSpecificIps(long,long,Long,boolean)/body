{
  SearchBuilder<IPAddressVO> VlanDbIdSearch=createSearchBuilder();
  VlanDbIdSearch.and("vlanDbId",VlanDbIdSearch.entity().getVlanId(),SearchCriteria.Op.EQ);
  VlanDbIdSearch.and("sourceNat",VlanDbIdSearch.entity().isSourceNat(),SearchCriteria.Op.EQ);
  VlanDbIdSearch.done();
  Transaction txn=Transaction.currentTxn();
  try {
    txn.start();
    SearchCriteria<IPAddressVO> sc=VlanDbIdSearch.create();
    sc.setParameters("vlanDbId",vlanDbId);
    sc.setParameters("sourceNat",sourceNat);
    List<IPAddressVO> ipList=this.lockRows(sc,null,true);
    List<String> ipStringList=new ArrayList<String>();
    for (    IPAddressVO ip : ipList) {
      ip.setAllocatedToAccountId(accountId);
      ip.setAllocatedTime(new Date());
      ip.setAllocatedInDomainId(domainId);
      ip.setSourceNat(sourceNat);
      ip.setState(State.Allocated);
      if (!update(ip.getAddress(),ip)) {
        s_logger.debug("Unable to retrieve ip address " + ip.getAddress());
        return null;
      }
      ipStringList.add(ip.getAddress());
    }
    txn.commit();
    return ipStringList;
  }
 catch (  Exception e) {
    s_logger.warn("Unable to assign IP",e);
  }
  return null;
}
