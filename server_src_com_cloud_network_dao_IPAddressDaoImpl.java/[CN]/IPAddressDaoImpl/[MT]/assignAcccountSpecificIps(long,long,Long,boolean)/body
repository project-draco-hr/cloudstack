{
  Transaction txn=Transaction.currentTxn();
  txn.start();
  SearchCriteria<IPAddressVO> sc=AllFieldsSearch.create();
  sc.setParameters("vlan",vlanDbId);
  sc.setParameters("sourceNat",sourceNat);
  List<IPAddressVO> ipList=lockRows(sc,null,true);
  List<String> ipStringList=new ArrayList<String>();
  for (  IPAddressVO ip : ipList) {
    ip.setAllocatedToAccountId(accountId);
    ip.setAllocatedTime(new Date());
    ip.setAllocatedInDomainId(domainId);
    ip.setSourceNat(sourceNat);
    ip.setState(State.Allocated);
    if (!update(ip.getAddress(),ip)) {
      throw new CloudRuntimeException("Unable to update a locked ip address " + ip.getAddress());
    }
    ipStringList.add(ip.getAddress());
  }
  txn.commit();
  return ipStringList;
}
