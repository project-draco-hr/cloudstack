{
  Transaction txn=Transaction.currentTxn();
  txn.start();
  SearchCriteria<IPAddressVO> sc=VlanDbIdSearchUnallocated.create();
  sc.setParameters("vlanDbId",vlanDbId);
  IPAddressVO ip=this.lockOneRandomRow(sc,true);
  if (ip == null) {
    s_logger.info("Unable to get an ip address in " + vlanDbId);
    return null;
  }
  ip.setAllocatedToAccountId(accountId);
  ip.setAllocatedTime(new Date());
  ip.setAllocatedInDomainId(domainId);
  ip.setSourceNat(sourceNat);
  ip.setState(State.Allocated);
  if (!update(ip.getAddress(),ip)) {
    throw new CloudRuntimeException("How can I lock the row but can't update it: " + ip.getAddress());
  }
  txn.commit();
  return ip.getAddress();
}
