{
  Transaction txn=Transaction.currentTxn();
  txn.start();
  SearchCriteria<IPAddressVO> sc=VlanDbIdSearchUnallocated.create();
  sc.setParameters("vlanDbId",vlanDbId);
  Filter filter=new Filter(IPAddressVO.class,"vlanId",true,0l,1l);
  List<IPAddressVO> ips=this.lockRows(sc,filter,true);
  if (ips.size() == 0) {
    s_logger.info("Unable to get an ip address in " + vlanDbId);
    return null;
  }
  IPAddressVO ip=ips.get(0);
  ip.setAllocatedToAccountId(accountId);
  ip.setAllocatedTime(new Date());
  ip.setAllocatedInDomainId(domainId);
  ip.setSourceNat(sourceNat);
  ip.setState(State.Allocated);
  if (!update(ip.getAddress(),ip)) {
    throw new CloudRuntimeException("How can I lock the row but can't update it: " + ip.getAddress());
  }
  txn.commit();
  return ip;
}
