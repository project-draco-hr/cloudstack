{
  prepareWriting();
  while (len > 0) {
    if (bufferBytes > bufferSize - 4)     flush(false);
    int partLen;
    if (bufferBytes + len > bufferSize) {
      partLen=bufferSize - bufferBytes;
    }
 else {
      partLen=len;
    }
    System.arraycopy(b,off,buffer,bufferBytes,partLen);
    bufferBytes+=partLen;
    off+=partLen;
    len-=partLen;
  }
}
