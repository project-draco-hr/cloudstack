{
  VirtualMachineEntityImpl vmEntity=new VirtualMachineEntityImpl(id,owner,hostName,displayName,cpu,speed,memory,computeTags,rootDiskTags,networks,vmEntityManager);
  HypervisorType hypervisorType=HypervisorType.valueOf(hypervisor);
  VMInstanceVO vm=_vmDao.findByUUID(id);
  Pair<DiskOfferingVO,Long> rootDiskOffering=new Pair<DiskOfferingVO,Long>(null,null);
  List<Pair<DiskOfferingVO,Long>> dataDiskOfferings=new ArrayList<Pair<DiskOfferingVO,Long>>();
  ServiceOfferingVO offering=_serviceOfferingDao.findById(vm.getServiceOfferingId());
  rootDiskOffering.first(offering);
  DiskOfferingVO diskOffering=_diskOfferingDao.findById(vm.getDiskOfferingId());
  if (diskOffering == null) {
    throw new InvalidParameterValueException("Unable to find disk offering " + vm.getDiskOfferingId());
  }
  Long size=null;
  if (diskOffering.getDiskSize() == 0) {
    size=diskSize;
    if (size == null) {
      throw new InvalidParameterValueException("Disk offering " + diskOffering + " requires size parameter.");
    }
  }
  dataDiskOfferings.add(new Pair<DiskOfferingVO,Long>(diskOffering,size));
  if (_itMgr.allocate(vm,_templateDao.findById(new Long(templateId)),offering,rootDiskOffering,dataDiskOfferings,null,null,plan,hypervisorType,null) == null) {
    return null;
  }
  return vmEntity;
}
