{
  long ownerId=owner.getId();
  PublicIp ip=null;
  Transaction txn=Transaction.currentTxn();
  try {
    txn.start();
    owner=_accountDao.acquireInLockTable(ownerId);
    if (owner == null) {
      ConcurrentOperationException ex=new ConcurrentOperationException("Unable to lock account");
      throw ex;
    }
    if (s_logger.isDebugEnabled()) {
      s_logger.debug("lock account " + ownerId + " is acquired");
    }
    ip=fetchNewPublicIp(dcId,null,null,owner,VlanType.VirtualNetwork,guestNtwkId,isSourceNat,false,null,false,vpcId);
    IPAddressVO publicIp=ip.ip();
    markPublicIpAsAllocated(publicIp);
    _ipAddressDao.update(publicIp.getId(),publicIp);
    txn.commit();
    return ip;
  }
  finally {
    if (owner != null) {
      if (s_logger.isDebugEnabled()) {
        s_logger.debug("Releasing lock account " + ownerId);
      }
      _accountDao.releaseFromLockTable(ownerId);
    }
    if (ip == null) {
      txn.rollback();
      s_logger.error("Unable to get source nat ip address for account " + ownerId);
    }
  }
}
