{
  final GlobalLock portableIpLock=GlobalLock.getInternLock("PortablePublicIpRange");
  try {
    return Transaction.execute(new TransactionCallback<Boolean>(){
      @Override public Boolean doInTransaction(      TransactionStatus status){
        portableIpLock.lock(5);
        IPAddressVO ip=_ipAddressDao.findById(addrId);
        PortableIpVO portableIp=_portableIpDao.findByIpAddress(ip.getAddress().addr());
        _portableIpDao.unassignIpAddress(portableIp.getId());
        VlanVO vlan=_vlanDao.findById(ip.getVlanId());
        _vlanDao.remove(vlan.getId());
        _ipAddressDao.remove(ip.getId());
        return true;
      }
    }
);
  }
  finally {
    portableIpLock.releaseRef();
  }
}
