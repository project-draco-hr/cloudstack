{
  StopAnswer answer=null;
  final String vmName=cmd.getVmName();
  Long bytesReceived=new Long(0);
  Long bytesSent=new Long(0);
  State state=null;
synchronized (_vms) {
    state=_vms.get(vmName);
    _vms.put(vmName,State.Stopping);
  }
  try {
    destroy_network_rules_for_vm(vmName);
    String result=stopVM(vmName,defineOps.UNDEFINE_VM);
    answer=new StopAnswer(cmd,null,0,bytesSent,bytesReceived);
    if (result != null) {
      answer=new StopAnswer(cmd,result,0,bytesSent,bytesReceived);
    }
    final String result2=cleanupVnet(cmd.getVnet());
    if (result2 != null) {
      result=result2 + (result != null ? ("\n" + result) : "");
      answer=new StopAnswer(cmd,result,0,bytesSent,bytesReceived);
    }
    return answer;
  }
  finally {
    if (answer == null || !answer.getResult()) {
synchronized (_vms) {
        _vms.put(vmName,state);
      }
    }
  }
}
