{
  List<DiskDef> disks=null;
  Domain dm=null;
  int deviceId=devId;
  try {
    if (!attach) {
      dm=conn.domainLookupByUUID(UUID.nameUUIDFromBytes(vmName.getBytes()));
      LibvirtDomainXMLParser parser=new LibvirtDomainXMLParser();
      String xml=dm.getXMLDesc(0);
      parser.parseDomainXML(xml);
      disks=parser.getDisks();
      boolean diskAttached=false;
      for (      DiskDef disk : disks) {
        String file=disk.getDiskPath();
        if (file != null && file.equalsIgnoreCase(sourceFile)) {
          deviceId=disk.getDiskSeq();
          diskAttached=true;
          break;
        }
      }
      if (!diskAttached) {
        throw new InternalErrorException("disk: " + sourceFile + " is not attached before");
      }
    }
    DiskDef disk=new DiskDef();
    String guestOSType=getGuestType(conn,vmName);
    if (isGuestPVEnabled(guestOSType)) {
      disk.defFileBasedDisk(sourceFile,deviceId,DiskDef.diskBus.VIRTIO,DiskDef.diskFmtType.QCOW2);
    }
 else {
      disk.defFileBasedDisk(sourceFile,deviceId,DiskDef.diskBus.SCSI,DiskDef.diskFmtType.QCOW2);
    }
    String xml=disk.toString();
    return attachOrDetachDevice(conn,attach,vmName,xml);
  }
  finally {
    if (dm != null) {
      dm.free();
    }
  }
}
