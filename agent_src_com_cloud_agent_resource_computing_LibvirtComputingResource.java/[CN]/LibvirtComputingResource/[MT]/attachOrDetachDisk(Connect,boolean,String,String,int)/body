{
  List<DiskDef> disks=null;
  Domain dm=null;
  try {
    dm=conn.domainLookupByUUID(UUID.nameUUIDFromBytes(vmName.getBytes()));
    LibvirtDomainXMLParser parser=new LibvirtDomainXMLParser();
    String xml=dm.getXMLDesc(0);
    parser.parseDomainXML(xml);
    disks=parser.getDisks();
  }
 catch (  LibvirtException e) {
    throw e;
  }
 finally {
    if (dm != null) {
      dm.free();
    }
  }
  if (!attach) {
    boolean diskAttached=false;
    for (    DiskDef disk : disks) {
      if (disk.getDiskPath().equalsIgnoreCase(sourceFile)) {
        devId=disk.getDiskSeq();
        diskAttached=true;
      }
    }
    if (!diskAttached) {
      throw new InternalErrorException("disk: " + sourceFile + " is not attached before");
    }
  }
  DiskDef disk=new DiskDef();
  String guestOSType=getGuestType(conn,vmName);
  if (isGuestPVEnabled(guestOSType)) {
    disk.defFileBasedDisk(sourceFile,devId,DiskDef.diskBus.VIRTIO,DiskDef.diskFmtType.QCOW2);
  }
 else {
    disk.defFileBasedDisk(sourceFile,devId,DiskDef.diskBus.SCSI,DiskDef.diskFmtType.QCOW2);
  }
  String xml=disk.toString();
  return attachOrDetachDevice(conn,attach,vmName,xml);
}
