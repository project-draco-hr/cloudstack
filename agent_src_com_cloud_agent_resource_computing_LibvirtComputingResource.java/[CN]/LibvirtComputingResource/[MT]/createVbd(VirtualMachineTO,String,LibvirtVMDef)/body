{
  boolean foundISO=false;
  for (  VolumeTO volume : vmSpec.getDisks()) {
    String volPath=getVolumePath(volume);
    DiskDef.diskBus diskBusType=getGuestDiskModel(vmSpec.getOs());
    DiskDef disk=new DiskDef();
    if (volume.getType() == VolumeType.ISO) {
      if (volPath == null) {
        disk.defISODisk(null);
      }
 else {
        disk.defISODisk(volPath);
      }
    }
 else {
      int devId=0;
      if (volume.getType() == VolumeType.ROOT) {
        devId=0;
      }
 else {
        devId=1;
      }
      disk.defFileBasedDisk(volume.getPath(),devId,diskBusType,DiskDef.diskFmtType.QCOW2);
    }
    if (volume.getType() == VolumeType.DATADISK && diskBusType != DiskDef.diskBus.VIRTIO) {
      disk.setAttachDeferred(true);
    }
    if (!disk.isAttachDeferred()) {
      vm.getDevices().addDevice(disk);
    }
  }
  if (vmSpec.getType() != VirtualMachine.Type.User) {
    DiskDef iso=new DiskDef();
    iso.defISODisk(_sysvmISOPath);
    vm.getDevices().addDevice(iso);
    createPatchVbd(vmName,vm,vmSpec);
  }
}
