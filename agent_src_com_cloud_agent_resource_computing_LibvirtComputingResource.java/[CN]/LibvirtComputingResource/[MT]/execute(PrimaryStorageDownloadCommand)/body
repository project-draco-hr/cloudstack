{
  String tmplturl=cmd.getUrl();
  int index=tmplturl.lastIndexOf("/");
  String mountpoint=tmplturl.substring(0,index);
  String tmpltname=null;
  if (index < tmplturl.length() - 1) {
    tmpltname=tmplturl.substring(index + 1);
  }
  StoragePool secondaryPool=null;
  StoragePool primaryPool=null;
  StorageVol tmplVol=null;
  StorageVol primaryVol=null;
  String result;
  Connect conn=null;
  try {
    conn=LibvirtConnection.getConnection();
    secondaryPool=_storageResource.getStoragePoolbyURI(conn,new URI(mountpoint));
    if (tmpltname == null) {
      _storageResource.storagePoolRefresh(secondaryPool);
      String[] volumes=secondaryPool.listVolumes();
      if (volumes == null) {
        return new PrimaryStorageDownloadAnswer("Failed to get volumes from pool: " + secondaryPool.getName());
      }
      for (      String volumeName : volumes) {
        if (volumeName.endsWith("qcow2")) {
          tmpltname=volumeName;
          break;
        }
      }
      if (tmpltname == null) {
        return new PrimaryStorageDownloadAnswer("Failed to get template from pool: " + secondaryPool.getName());
      }
    }
    LibvirtStoragePoolDef poolDef=_storageResource.getStoragePoolDef(conn,secondaryPool);
    tmplVol=_storageResource.getVolume(conn,secondaryPool,poolDef.getTargetPath() + File.separator + tmpltname);
    primaryPool=_storageResource.getStoragePool(conn,cmd.getPoolUuid());
    LibvirtStorageVolumeDef vol=new LibvirtStorageVolumeDef(UUID.randomUUID().toString(),tmplVol.getInfo().capacity,volFormat.QCOW2,null,null);
    s_logger.debug(vol.toString());
    primaryVol=_storageResource.copyVolume(primaryPool,vol,tmplVol);
    StorageVolInfo priVolInfo=primaryVol.getInfo();
    return new PrimaryStorageDownloadAnswer(primaryVol.getKey(),priVolInfo.allocation);
  }
 catch (  LibvirtException e) {
    s_logger.debug(e.toString());
    return new PrimaryStorageDownloadAnswer(e.toString());
  }
catch (  URISyntaxException e) {
    return new PrimaryStorageDownloadAnswer(e.toString());
  }
 finally {
    try {
      if (primaryVol != null) {
        primaryVol.free();
      }
      if (primaryPool != null) {
        primaryPool.free();
      }
      if (tmplVol != null) {
        tmplVol.free();
      }
      _storageResource.deleteStoragePool(conn,secondaryPool);
    }
 catch (    LibvirtException l) {
    }
  }
}
