{
  String tmplturl=cmd.getUrl();
  int index=tmplturl.lastIndexOf("/");
  String mountpoint=tmplturl.substring(0,index);
  String tmpltname=null;
  if (index < tmplturl.length() - 1) {
    tmpltname=tmplturl.substring(index + 1);
  }
  StoragePool secondaryPool=null;
  StoragePool primaryPool=null;
  StorageVol tmplVol=null;
  StorageVol primaryVol=null;
  String result;
  try {
    Connect conn=LibvirtConnection.getConnection();
    secondaryPool=getNfsSPbyURI(conn,new URI(mountpoint));
    if (secondaryPool == null) {
      return new PrimaryStorageDownloadAnswer(" Failed to create storage pool");
    }
    if (tmpltname == null) {
synchronized (getStoragePool(secondaryPool.getUUIDString())) {
        secondaryPool.refresh(0);
      }
      String[] volumes=secondaryPool.listVolumes();
      if (volumes == null) {
        return new PrimaryStorageDownloadAnswer("Failed to get volumes from pool: " + secondaryPool.getName());
      }
      for (      String volumeName : volumes) {
        if (volumeName.endsWith("qcow2")) {
          tmpltname=volumeName;
          break;
        }
      }
      if (tmpltname == null) {
        return new PrimaryStorageDownloadAnswer("Failed to get template from pool: " + secondaryPool.getName());
      }
    }
    tmplVol=getVolume(conn,secondaryPool,getPathOfStoragePool(secondaryPool) + tmpltname);
    if (tmplVol == null) {
      return new PrimaryStorageDownloadAnswer(" Can't find volume");
    }
    primaryPool=getStoragePool(conn,cmd.getPoolUuid());
    LibvirtStorageVolumeDef vol=new LibvirtStorageVolumeDef(UUID.randomUUID().toString(),tmplVol.getInfo().capacity,volFormat.QCOW2,null,null);
    s_logger.debug(vol.toString());
    primaryVol=copyVolume(primaryPool,vol,tmplVol);
    if (primaryVol == null) {
      return new PrimaryStorageDownloadAnswer(" Can't create storage volume on storage pool");
    }
    StorageVolInfo priVolInfo=primaryVol.getInfo();
    return new PrimaryStorageDownloadAnswer(primaryVol.getKey(),priVolInfo.allocation);
  }
 catch (  LibvirtException e) {
    result="Failed to download template: " + e.toString();
    s_logger.debug(result);
    return new PrimaryStorageDownloadAnswer(result);
  }
catch (  URISyntaxException e) {
    return new PrimaryStorageDownloadAnswer(e.toString());
  }
 finally {
    try {
      if (primaryVol != null) {
        primaryVol.free();
      }
      if (primaryPool != null) {
        primaryPool.free();
      }
      if (tmplVol != null) {
        tmplVol.free();
      }
      if (secondaryPool != null) {
        String uuid=secondaryPool.getUUIDString();
synchronized (getStoragePool(uuid)) {
          secondaryPool.destroy();
          secondaryPool.undefine();
          secondaryPool.free();
        }
        rmStoragePool(uuid);
      }
    }
 catch (    LibvirtException l) {
    }
  }
}
