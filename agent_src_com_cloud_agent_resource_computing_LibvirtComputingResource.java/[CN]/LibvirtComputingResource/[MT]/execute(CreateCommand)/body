{
  StorageFilerTO pool=cmd.getPool();
  DiskProfile dskch=cmd.getDiskCharacteristics();
  StorageVol tmplVol=null;
  StoragePool primaryPool=null;
  StorageVol vol=null;
  long disksize;
  try {
    Connect conn=LibvirtConnection.getConnection();
    primaryPool=_storageResource.getStoragePool(conn,pool.getUuid());
    if (cmd.getTemplateUrl() != null) {
      tmplVol=_storageResource.getVolume(conn,primaryPool,cmd.getTemplateUrl());
      vol=_storageResource.createVolumeFromTempl(primaryPool,tmplVol);
      if (vol == null) {
        return new Answer(cmd,false," Can't create storage volume on storage pool");
      }
      disksize=tmplVol.getInfo().capacity;
    }
 else {
      disksize=dskch.getSize();
      vol=_storageResource.createVolume(conn,primaryPool,UUID.randomUUID().toString(),dskch.getSize(),volFormat.QCOW2);
    }
    VolumeTO volume=new VolumeTO(cmd.getVolumeId(),dskch.getType(),getStorageResourceType(),pool.getType(),pool.getUuid(),pool.getPath(),vol.getName(),vol.getKey(),disksize,null);
    return new CreateAnswer(cmd,volume);
  }
 catch (  LibvirtException e) {
    s_logger.debug("Failed to create volume: " + e.toString());
    return new CreateAnswer(cmd,e);
  }
 finally {
    try {
      if (vol != null) {
        vol.free();
      }
      if (tmplVol != null) {
        tmplVol.free();
      }
      if (primaryPool != null) {
        primaryPool.free();
      }
    }
 catch (    LibvirtException e) {
    }
  }
}
