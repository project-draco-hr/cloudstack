{
  LOGGER.debug("CheckVirtualMachineCommand: " + cmd.getVmName());
  String vmName=cmd.getVmName();
  try {
    CloudstackPlugin plug=new CloudstackPlugin(c);
    Integer vncPort=Integer.valueOf(plug.getVncPort(vmName));
    if (vncPort == 0) {
      LOGGER.warn("No VNC port for " + vmName);
    }
    Map<String,State> states=getAllVmStates(vmStateMap);
    State vmState=states.get(vmName);
    if (vmState == null) {
      LOGGER.warn("Check state of " + vmName + " return null in CheckVirtualMachineCommand");
      vmState=State.Stopped;
    }
synchronized (vmStateMap) {
      vmStateMap.put(vmName,State.Running);
    }
    return new CheckVirtualMachineAnswer(cmd,convertStateToPower(vmState),vncPort);
  }
 catch (  Ovm3ResourceException e) {
    LOGGER.debug("Check migration for " + vmName + " failed",e);
    return new CheckVirtualMachineAnswer(cmd,convertStateToPower(State.Stopped),null);
  }
}
