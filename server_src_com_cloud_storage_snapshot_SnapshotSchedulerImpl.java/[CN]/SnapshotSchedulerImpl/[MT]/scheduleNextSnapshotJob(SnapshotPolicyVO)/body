{
  long policyId=policyInstance.getId();
  Date nextSnapshotTimestamp=getNextScheduledTime(policyId,_currentTimestamp);
  SnapshotScheduleVO snapshotScheduleVO=new SnapshotScheduleVO(policyInstance.getVolumeId(),policyId,nextSnapshotTimestamp);
  try {
    _snapshotScheduleDao.persist(snapshotScheduleVO);
  }
 catch (  EntityExistsException e) {
    snapshotScheduleVO=_snapshotScheduleDao.findOneByVolume(policyInstance.getVolumeId());
    try {
      snapshotScheduleVO=_snapshotScheduleDao.acquireInLockTable(snapshotScheduleVO.getId());
      snapshotScheduleVO.setPolicyId(policyId);
      snapshotScheduleVO.setScheduledTimestamp(nextSnapshotTimestamp);
      _snapshotScheduleDao.update(snapshotScheduleVO.getId(),snapshotScheduleVO);
    }
  finally {
      if (snapshotScheduleVO != null) {
        _snapshotScheduleDao.releaseFromLockTable(snapshotScheduleVO.getId());
      }
    }
  }
  return nextSnapshotTimestamp;
}
