{
  if (oldState == State.Starting) {
    if (event == Event.OperationRetry || event == Event.OperationFailed) {
      releaseResource(vm,false,false);
    }
  }
  if (!transitionStatus) {
    return true;
  }
  Transaction txn=Transaction.open(Transaction.CLOUD_DB);
  try {
    txn.start();
    if (oldState == State.Starting) {
      if (event == Event.OperationSucceeded) {
        vm.setLastHostId(id);
        _vmDao.update(vm.getId(),vm);
      }
    }
 else     if (oldState == State.Running) {
      if (event == Event.AgentReportStopped) {
        releaseResource(vm,false,true);
      }
    }
 else     if (oldState == State.Migrating) {
      if (event == Event.AgentReportStopped) {
        releaseResource(vm,false,true);
      }
 else       if (event == Event.OperationFailed) {
        if (vm.getHostId() == id) {
        }
 else {
          releaseResource(vm,false,false);
          if (id != null) {
            addResource(vm,id);
          }
        }
      }
 else       if (event == Event.OperationSucceeded) {
        releaseResource(vm,false,false);
        addResource(vm,id);
      }
    }
 else     if (oldState == State.Stopping) {
      if (event == Event.AgentReportStopped || event == Event.OperationSucceeded) {
        releaseResource(vm,false,true);
      }
    }
 else     if (oldState == State.Stopped) {
      if (event == Event.DestroyRequested) {
        releaseResource(vm,true,false);
        vm.setLastHostId(null);
        _vmDao.update(vm.getId(),vm);
      }
    }
    transitionStatus=_vmDao.updateState(oldState,event,newState,vm,id);
    if (transitionStatus) {
      txn.commit();
    }
 else {
      txn.rollback();
    }
  }
 catch (  Exception e) {
    txn.rollback();
  }
 finally {
    txn.close();
  }
  return transitionStatus;
}
