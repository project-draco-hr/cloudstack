{
  List<NetworkConfigurationVO> configs=_networkConfigDao.listBy(owner.getId(),offering.getId(),plan.getDataCenterId());
  if (configs.size() > 0) {
    if (s_logger.isDebugEnabled()) {
      s_logger.debug("Found existing network configuration for offering " + offering + ": "+ configs.get(0));
    }
    return configs.get(0);
  }
  long id=_networkConfigDao.getNextInSequence(Long.class,"id");
  long related=id;
  for (  NetworkGuru guru : _networkGurus) {
    NetworkConfiguration config=guru.design(offering,plan,predefined,owner);
    if (config == null) {
      continue;
    }
    if (config.getId() != null) {
      if (config instanceof NetworkConfigurationVO) {
        return (NetworkConfigurationVO)config;
      }
 else {
        return _networkConfigDao.findById(config.getId());
      }
    }
    NetworkConfigurationVO vo=new NetworkConfigurationVO(id,config,offering.getId(),plan.getDataCenterId(),guru.getName(),owner.getDomainId(),owner.getId(),related);
    return _networkConfigDao.persist(vo);
  }
  throw new CloudRuntimeException("Unable to convert network offering to network profile: " + offering.getId());
}
