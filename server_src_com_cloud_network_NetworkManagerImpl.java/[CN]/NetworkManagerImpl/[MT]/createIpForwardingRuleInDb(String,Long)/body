{
  Transaction txn=Transaction.currentTxn();
  txn.start();
  UserVmVO userVM=null;
  FirewallRuleVO newFwRule=null;
  boolean locked=false;
  try {
    IPAddressVO ipAddress=_ipAddressDao.findById(ipAddr);
    if (ipAddress == null) {
      throw new InvalidParameterValueException("Unable to create ip forwarding rule on address " + ipAddress + ", invalid IP address specified.");
    }
    userVM=_vmDao.findById(virtualMachineId);
    if (userVM == null) {
      throw new InvalidParameterValueException("Unable to create ip forwarding rule on address " + ipAddress + ", invalid virtual machine id specified ("+ virtualMachineId+ ").");
    }
    userVM=_vmDao.acquireInLockTable(userVM.getId());
    if (userVM == null) {
      s_logger.warn("Unable to acquire lock on user vm for creating 1-1 NAT rule");
      return newFwRule;
    }
 else {
      locked=true;
    }
    if ((ipAddress.getAccountId() == null) || (ipAddress.getAccountId().longValue() != userVM.getAccountId())) {
      throw new InvalidParameterValueException("Unable to create ip forwarding rule, IP address " + ipAddress + " owner is not the same as owner of virtual machine "+ userVM.toString());
    }
    if (ipAddress.getDataCenterId() != userVM.getDataCenterId()) {
      throw new InvalidParameterValueException("Unable to create ip forwarding rule, IP address " + ipAddress + " is not in the same availability zone as virtual machine "+ userVM.toString());
    }
    Account account=UserContext.current().getAccount();
    if (account != null) {
      if ((account.getType() == Account.ACCOUNT_TYPE_ADMIN) || (account.getType() == Account.ACCOUNT_TYPE_DOMAIN_ADMIN)) {
        if (!_domainDao.isChildDomain(account.getDomainId(),userVM.getDomainId())) {
          throw new PermissionDeniedException("Unable to create ip forwarding rule, IP address " + ipAddress + " to virtual machine "+ virtualMachineId+ ", permission denied.");
        }
      }
 else       if (account.getId() != userVM.getAccountId()) {
        throw new PermissionDeniedException("Unable to create ip forwarding rule, IP address " + ipAddress + " to virtual machine "+ virtualMachineId+ ", permission denied.");
      }
    }
    List<FirewallRuleVO> existingNatRules=_rulesDao.findByPublicIpPrivateIpForNatRule(ipAddr,userVM.getGuestIpAddress());
    if (existingNatRules.size() > 0) {
      throw new NetworkRuleConflictException("The specified rule for public ip:" + ipAddr + " vm id:"+ virtualMachineId+ " already exists");
    }
    newFwRule=new FirewallRuleVO();
    newFwRule.setEnabled(true);
    newFwRule.setForwarding(true);
    newFwRule.setPrivatePort(null);
    newFwRule.setProtocol("NAT");
    newFwRule.setPublicPort(null);
    newFwRule.setPublicIpAddress(ipAddress.getAddress());
    newFwRule.setPrivateIpAddress(userVM.getGuestIpAddress());
    newFwRule.setGroupId(null);
    _rulesDao.persist(newFwRule);
    txn.commit();
  }
 catch (  Exception e) {
    s_logger.warn("Unable to create new firewall rule for 1:1 NAT");
    txn.rollback();
    throw new ServerApiException(BaseCmd.INTERNAL_ERROR,"Unable to create new firewall rule for 1:1 NAT:" + e.getMessage());
  }
 finally {
    if (locked)     _vmDao.releaseFromLockTable(userVM.getId());
  }
  return newFwRule;
}
