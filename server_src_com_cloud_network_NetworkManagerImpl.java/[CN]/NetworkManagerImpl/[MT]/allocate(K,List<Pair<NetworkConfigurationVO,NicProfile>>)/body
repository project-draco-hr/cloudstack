{
  List<NicProfile> nicProfiles=new ArrayList<NicProfile>(networks.size());
  Transaction txn=Transaction.currentTxn();
  txn.start();
  for (  Pair<NetworkConfigurationVO,NicProfile> network : networks) {
    for (    NetworkConcierge concierge : _networkConcierges) {
      NicProfile profile=concierge.allocate(vm,network.first(),network.second());
      if (profile == null) {
        continue;
      }
      NicVO vo=new NicVO(concierge.getUniqueName(),vm.getId(),network.first().getId());
      if (profile.getIp4Address() != null) {
        vo.setIp4Address(profile.getIp4Address());
        vo.setState(NicVO.State.Reserved);
      }
      if (profile.getMacAddress() != null) {
        vo.setMacAddress(profile.getMacAddress());
      }
      if (profile.getMode() != null) {
        vo.setMode(profile.getMode());
      }
      vo=_nicDao.persist(vo);
      nicProfiles.add(new NicProfile(vo,network.first()));
    }
  }
  txn.commit();
  return nicProfiles;
}
