{
  if (networkId != null) {
    Network network=_networksDao.findById(networkId);
    if (network == null) {
      throw new InvalidParameterValueException("Invalid network id is given");
    }
    if (network.getGuestType() == Network.GuestType.Shared) {
      DataCenter zone=_configMgr.getZone(zoneId);
      if (zone == null) {
        throw new InvalidParameterValueException("Invalid zone Id is given");
      }
      if (isSharedNetworkOfferingWithServices(network.getNetworkOfferingId()) && zone.getNetworkType() == NetworkType.Advanced) {
        Account caller=UserContext.current().getCaller();
        long callerUserId=UserContext.current().getCallerUserId();
        _accountMgr.checkAccess(caller,AccessType.UseNetwork,false,network);
        if (s_logger.isDebugEnabled()) {
          s_logger.debug("Associate IP address called by the user " + callerUserId + " account "+ ipOwner.getId());
        }
        return allocateIp(ipOwner,false,caller,callerUserId,zone);
      }
 else {
        throw new InvalidParameterValueException("Associate IP address can only called on the shared networks in the advanced zone" + " with Firewall/Source Nat/Static Nat/Port Forwarding/Load balancing services enabled");
      }
    }
  }
  return allocateIP(ipOwner,false,zoneId);
}
