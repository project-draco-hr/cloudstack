{
  PhysicalNetworkVO network=_physicalNetworkDao.findById(physicalNetworkId);
  if (network == null) {
    throw new InvalidParameterValueException("Physical Network id=" + physicalNetworkId + "doesn't exist in the system");
  }
  if (destinationPhysicalNetworkId != null) {
    PhysicalNetworkVO destNetwork=_physicalNetworkDao.findById(destinationPhysicalNetworkId);
    if (destNetwork == null) {
      throw new InvalidParameterValueException("Destination Physical Network id=" + destinationPhysicalNetworkId + "doesn't exist in the system");
    }
  }
  if (providerName != null) {
    Provider provider=Network.Provider.getProvider(providerName);
    if (provider == null) {
      throw new InvalidParameterValueException("Invalid Network Service Provider=" + providerName);
    }
  }
  Transaction txn=Transaction.currentTxn();
  try {
    txn.start();
    PhysicalNetworkServiceProviderVO nsp=new PhysicalNetworkServiceProviderVO(physicalNetworkId,providerName);
    if (destinationPhysicalNetworkId != null) {
      nsp.setDestinationPhysicalNetworkId(destinationPhysicalNetworkId);
    }
    nsp=_pNSPDao.persist(nsp);
    txn.commit();
    return nsp;
  }
 catch (  Exception ex) {
    txn.rollback();
    s_logger.warn("Exception: ",ex);
    throw new CloudRuntimeException("Fail to add a provider to physical network");
  }
 finally {
    txn.close();
  }
}
