{
  Transaction txn=Transaction.currentTxn();
  IPAddressVO ip=_ipAddressDao.findById(addrId);
  if (ip.getState() != State.Releasing) {
    txn.start();
    ip=_ipAddressDao.markAsUnavailable(addrId);
    _accountMgr.decrementResourceCount(_ipAddressDao.findById(addrId).getAccountId(),ResourceType.public_ip);
    long isSourceNat=(ip.isSourceNat()) ? 1 : 0;
    if (ip.getAccountId() != Account.ACCOUNT_ID_SYSTEM) {
      UsageEventVO usageEvent=new UsageEventVO(EventTypes.EVENT_NET_IP_RELEASE,ip.getAccountId(),ip.getDataCenterId(),addrId,ip.getAddress().addr(),isSourceNat);
      _usageEventDao.persist(usageEvent);
    }
    txn.commit();
  }
  return ip;
}
