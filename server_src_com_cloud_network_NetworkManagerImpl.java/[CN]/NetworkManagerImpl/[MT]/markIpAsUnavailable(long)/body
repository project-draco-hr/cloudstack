{
  Transaction txn=Transaction.currentTxn();
  IPAddressVO ip=_ipAddressDao.findById(addrId);
  if (ip.getAllocatedToAccountId() == null && ip.getAllocatedTime() == null) {
    s_logger.trace("Ip address id=" + addrId + " is already released");
    return ip;
  }
  if (ip.getState() != State.Releasing) {
    txn.start();
    if (ip.getAssociatedWithNetworkId() != null) {
      _accountMgr.decrementResourceCount(_ipAddressDao.findById(addrId).getAccountId(),ResourceType.public_ip);
    }
    long isSourceNat=(ip.isSourceNat()) ? 1 : 0;
    if (ip.getAccountId() != Account.ACCOUNT_ID_SYSTEM) {
      NetworkVO network=_networksDao.findByIdIncludingRemoved(ip.getSourceNetworkId());
      String guestType="";
      if ((network != null) && (network.getGuestType() != null)) {
        guestType=network.getGuestType().toString();
      }
      UsageEventVO usageEvent=new UsageEventVO(EventTypes.EVENT_NET_IP_RELEASE,ip.getAccountId(),ip.getDataCenterId(),addrId,ip.getAddress().addr(),isSourceNat,guestType);
      _usageEventDao.persist(usageEvent);
    }
    ip=_ipAddressDao.markAsUnavailable(addrId);
    txn.commit();
  }
  return ip;
}
