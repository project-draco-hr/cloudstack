{
  Long userId=UserContext.current().getUserId();
  Account account=getAccountForApiCommand(cmd.getAccountName(),cmd.getDomainId());
  EventUtils.saveStartedEvent(userId,account.getId(),EventTypes.EVENT_VPN_USERS_ADD_OR_DELETE,"Add/remove VPN users for account: " + account.getAccountName(),cmd.getStartEventId());
  List<RemoteAccessVpnVO> vpnVOList=_remoteAccessVpnDao.findByAccount(account.getId());
  String publicIp=vpnVO.getVpnServerAddress();
  Long vpnId=vpnVO.getId();
  Transaction txn=Transaction.currentTxn();
  txn.start();
  boolean locked=false;
  boolean created=false;
  try {
    IPAddressVO ipAddr=_ipAddressDao.acquire(publicIp);
    if (ipAddr == null) {
      throw new ConcurrentOperationException("Another operation active, unable to create vpn");
    }
    locked=true;
    vpnVO=_routerMgr.startRemoteAccessVpn(vpnVO);
    created=(vpnVO != null);
    return vpnVO;
  }
  finally {
    if (created) {
      EventUtils.saveEvent(userId,account.getId(),EventTypes.EVENT_VPN_USERS_ADD_OR_DELETE,"Created a Remote Access VPN for account: " + account.getAccountName() + " in zone "+ cmd.getZoneId());
    }
 else {
      EventUtils.saveEvent(userId,account.getId(),EventVO.LEVEL_ERROR,EventTypes.EVENT_VPN_USERS_ADD_OR_DELETE,"Unable to create Remote Access VPN ",account.getAccountName() + " in zone " + cmd.getZoneId());
      _remoteAccessVpnDao.remove(vpnId);
    }
    txn.commit();
    if (locked) {
      _ipAddressDao.release(publicIp);
    }
  }
}
