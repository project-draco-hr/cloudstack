{
  List<NicProfile> nicProfiles=new ArrayList<NicProfile>(networks.size());
  Transaction txn=Transaction.currentTxn();
  txn.start();
  int deviceId=0;
  for (  Pair<NetworkConfigurationVO,NicProfile> network : networks) {
    NetworkGuru concierge=_networkGurus.get(network.first().getGuruName());
    NicProfile profile=concierge.allocate(network.first(),network.second(),vm);
    if (profile == null) {
      continue;
    }
    NicVO vo=new NicVO(concierge.getName(),vm.getId(),network.first().getId());
    vo.setDeviceId(deviceId++);
    vo.setMode(network.first().getMode());
    if (profile.getIp4Address() != null) {
      vo.setIp4Address(profile.getIp4Address());
      vo.setState(NicVO.State.Reserved);
    }
    if (profile.getMacAddress() != null) {
      vo.setMacAddress(profile.getMacAddress());
    }
    if (profile.getMode() != null) {
      vo.setMode(profile.getMode());
    }
    vo=_nicDao.persist(vo);
    nicProfiles.add(new NicProfile(vo,network.first()));
  }
  txn.commit();
  return nicProfiles;
}
