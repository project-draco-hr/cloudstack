{
  Set<Purpose> result=new HashSet<Purpose>();
  if (includeRevoked) {
    List<FirewallRuleVO> rules=_firewallDao.listByIp(ip.getId());
    if (rules == null || rules.isEmpty()) {
      return null;
    }
    for (    FirewallRuleVO rule : rules) {
      if (rule.getPurpose() != Purpose.Firewall) {
        result.add(rule.getPurpose());
      }
    }
  }
 else {
    List<FirewallRuleVO> rules=_firewallDao.listByIpAndNotRevoked(ip.getId());
    if (rules == null || rules.isEmpty()) {
      return null;
    }
    for (    FirewallRuleVO rule : rules) {
      if (rule.getPurpose() != Purpose.Firewall) {
        result.add(rule.getPurpose());
      }
    }
  }
  return result;
}
