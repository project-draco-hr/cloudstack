{
  Vlan vlan=_networkModel.getVlanForNetwork(networkId);
  if (vlan == null) {
    s_logger.debug("Cannot find related vlan or too many vlan attached to network " + networkId);
    return null;
  }
  String ip=NetUtils.getIp6FromRange(vlan.getIp6Range());
  if (_ipv6Dao.findByDcIdAndIp(dcId,ip) != null) {
    throw new CloudRuntimeException("Fail to get unique ipv6 address");
  }
  DataCenterVO dc=_dcDao.findById(dcId);
  Long mac=dc.getMacAddress();
  Long nextMac=mac + 1;
  dc.setMacAddress(nextMac);
  _dcDao.update(dc.getId(),dc);
  String macAddress=NetUtils.long2Mac(NetUtils.createSequenceBasedMacAddress(mac));
  PublicIpv6AddressVO ipVO=new PublicIpv6AddressVO(ip,dcId,macAddress,vlan.getId());
  ipVO.setPhysicalNetworkId(vlan.getPhysicalNetworkId());
  ipVO.setSourceNetworkId(vlan.getNetworkId());
  ipVO.setState(PublicIpv6Address.State.Allocated);
  ipVO.setDomainId(owner.getDomainId());
  ipVO.setAccountId(owner.getAccountId());
  _ipv6Dao.persist(ipVO);
  return ipVO;
}
