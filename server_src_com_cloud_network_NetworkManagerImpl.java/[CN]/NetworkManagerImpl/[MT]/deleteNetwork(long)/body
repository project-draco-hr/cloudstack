{
  int nicCount=getActiveNicsInNetwork(networkId);
  if (nicCount > 0) {
    throw new InvalidParameterValueException("Unable to remove the network id=" + networkId + " as it has active Nics.");
  }
  Account caller=UserContext.current().getCaller();
  NetworkVO network=_networksDao.findById(networkId);
  if (network == null) {
    throw new InvalidParameterValueException("unable to find network " + networkId);
  }
  Account owner=_accountMgr.getAccount(network.getAccountId());
  if (!_accountMgr.isAdmin(caller.getType())) {
    if (network.getAccountId() != caller.getId()) {
      throw new PermissionDeniedException("Account " + caller.getAccountName() + " does not own network id="+ networkId+ ", permission denied");
    }
  }
 else {
    _accountMgr.checkAccess(caller,owner);
  }
  List<UserVmVO> userVms=_vmDao.listByNetworkId(networkId);
  for (  UserVmVO vm : userVms) {
    if (!(vm.getState() == VirtualMachine.State.Error || (vm.getState() == VirtualMachine.State.Expunging && vm.getRemoved() != null))) {
      throw new InvalidParameterValueException("Can't delete the network, not all user vms are expunged");
    }
  }
  User callerUser=_accountMgr.getActiveUser(UserContext.current().getCallerUserId());
  ReservationContext context=new ReservationContextImpl(null,null,callerUser,owner);
  return deleteNetworkInternal(networkId,context);
}
