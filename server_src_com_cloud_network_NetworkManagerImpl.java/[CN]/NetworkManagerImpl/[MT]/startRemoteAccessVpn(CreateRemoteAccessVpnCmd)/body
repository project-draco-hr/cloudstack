{
  Long userId=UserContext.current().getUserId();
  Account account=getAccountForApiCommand(cmd.getAccountName(),cmd.getDomainId());
  EventUtils.saveStartedEvent(userId,account.getId(),EventTypes.EVENT_REMOTE_ACCESS_VPN_CREATE,"Creating a Remote Access VPN for account: " + account.getAccountName() + " in zone "+ cmd.getZoneId(),cmd.getStartEventId());
  RemoteAccessVpnVO vpnVO=_remoteAccessVpnDao.findById(cmd.getId());
  String publicIp=vpnVO.getVpnServerAddress();
  Long vpnId=vpnVO.getId();
  Transaction txn=Transaction.currentTxn();
  txn.start();
  boolean locked=false;
  boolean created=false;
  try {
    IPAddressVO ipAddr=_ipAddressDao.acquireInLockTable(publicIp);
    if (ipAddr == null) {
      throw new ConcurrentOperationException("Another operation active, unable to create vpn");
    }
    locked=true;
    vpnVO=_routerMgr.startRemoteAccessVpn(vpnVO);
    created=(vpnVO != null);
    return vpnVO;
  }
  finally {
    if (created) {
      EventUtils.saveEvent(userId,account.getId(),EventTypes.EVENT_REMOTE_ACCESS_VPN_CREATE,"Created a Remote Access VPN for account: " + account.getAccountName() + " in zone "+ cmd.getZoneId());
    }
 else {
      EventUtils.saveEvent(userId,account.getId(),EventVO.LEVEL_ERROR,EventTypes.EVENT_REMOTE_ACCESS_VPN_CREATE,"Unable to create Remote Access VPN ",account.getAccountName() + " in zone " + cmd.getZoneId());
      _remoteAccessVpnDao.remove(vpnId);
    }
    txn.commit();
    if (locked) {
      _ipAddressDao.releaseFromLockTable(publicIp);
    }
  }
}
