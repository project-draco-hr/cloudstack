{
  PhysicalNetworkServiceProviderVO provider=_pNSPDao.findById(id);
  if (provider == null) {
    throw new InvalidParameterValueException("Network Service Provider id=" + id + "doesn't exist in the system");
  }
  NetworkElement element=getElementImplementingProvider(provider.getProviderName());
  if (element == null) {
    throw new InvalidParameterValueException("Unable to find the Network Element implementing the Service Provider '" + provider.getProviderName() + "'");
  }
  PhysicalNetworkServiceProvider.State state=null;
  if (stateStr != null && !stateStr.isEmpty()) {
    try {
      state=PhysicalNetworkServiceProvider.State.valueOf(stateStr);
    }
 catch (    IllegalArgumentException ex) {
      throw new InvalidParameterValueException("Unable to resolve state '" + stateStr + "' to a supported value {Enabled or Disabled or Shutdown}");
    }
  }
  boolean update=false;
  if (state != null) {
    if (s_logger.isDebugEnabled()) {
      s_logger.debug("updating state of the service provider id=" + id + " on physical network: "+ provider.getPhysicalNetworkId()+ " to state: "+ stateStr);
    }
switch (state) {
case Enabled:
      if (element != null && element.isReady(provider)) {
        provider.setState(PhysicalNetworkServiceProvider.State.Enabled);
        update=true;
      }
    break;
case Disabled:
  provider.setState(PhysicalNetworkServiceProvider.State.Disabled);
update=true;
break;
case Shutdown:
User callerUser=_accountMgr.getActiveUser(UserContext.current().getCallerUserId());
Account callerAccount=_accountMgr.getActiveAccountById(callerUser.getAccountId());
ReservationContext context=new ReservationContextImpl(null,null,callerUser,callerAccount);
if (s_logger.isDebugEnabled()) {
s_logger.debug("Shutting down the service provider id=" + id + " on physical network: "+ provider.getPhysicalNetworkId());
}
if (element != null && element.shutdownProviderInstances(provider,context,forcedShutdown)) {
provider.setState(PhysicalNetworkServiceProvider.State.Shutdown);
update=true;
}
break;
}
}
if (enabledServices != null) {
if (!element.canEnableIndividualServices()) {
throw new InvalidParameterValueException("Cannot update set of Services for this Service Provider '" + provider.getProviderName() + "'");
}
List<Service> services=new ArrayList<Service>();
for (String serviceName : enabledServices) {
Network.Service service=Network.Service.getService(serviceName);
if (service == null) {
throw new InvalidParameterValueException("Invalid Network Service specified=" + serviceName);
}
services.add(service);
}
provider.setEnabledServices(services);
update=true;
}
if (update) {
_pNSPDao.update(id,provider);
}
return provider;
}
