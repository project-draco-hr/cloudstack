{
  if (includeRevoked) {
    List<FirewallRuleVO> loadBalancingRules=_firewallDao.listByIpAndPurpose(ip.getId(),Purpose.LoadBalancing);
    if (loadBalancingRules != null && !loadBalancingRules.isEmpty()) {
      return Purpose.LoadBalancing;
    }
    List<FirewallRuleVO> firewall_rules=_firewallDao.listByIpAndPurpose(ip.getId(),Purpose.Firewall);
    if (firewall_rules != null && !firewall_rules.isEmpty()) {
      return Purpose.Firewall;
    }
    List<FirewallRuleVO> staticNatRules=_firewallDao.listByIpAndPurpose(ip.getId(),Purpose.StaticNat);
    if (staticNatRules != null && !staticNatRules.isEmpty()) {
      return Purpose.StaticNat;
    }
    List<PortForwardingRuleVO> pfRules=_portForwardingDao.listByIp(ip.getId());
    if (pfRules != null && !pfRules.isEmpty()) {
      return Purpose.PortForwarding;
    }
  }
 else {
    List<FirewallRuleVO> loadBalancingRules=_firewallDao.listByIpAndPurposeAndNotRevoked(ip.getId(),Purpose.LoadBalancing);
    if (loadBalancingRules != null && !loadBalancingRules.isEmpty()) {
      return Purpose.LoadBalancing;
    }
    List<FirewallRuleVO> firewall_rules=_firewallDao.listByIpAndPurposeAndNotRevoked(ip.getId(),Purpose.Firewall);
    if (firewall_rules != null && !firewall_rules.isEmpty()) {
      return Purpose.Firewall;
    }
    List<FirewallRuleVO> staticNatRules=_firewallDao.listByIpAndPurposeAndNotRevoked(ip.getId(),Purpose.StaticNat);
    if (staticNatRules != null && !staticNatRules.isEmpty()) {
      return Purpose.StaticNat;
    }
    List<PortForwardingRuleVO> pfRules=_portForwardingDao.listByIpAndNotRevoked(ip.getId());
    if (pfRules != null && !pfRules.isEmpty()) {
      return Purpose.PortForwarding;
    }
  }
  return null;
}
