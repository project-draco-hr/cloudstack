{
  String accountName=cmd.getAccountName();
  long domainId=cmd.getDomainId();
  Long zoneId=cmd.getZoneId();
  Account caller=UserContext.current().getCaller();
  long userId=UserContext.current().getCallerUserId();
  Account ipOwner=_accountMgr.getActiveAccount(accountName,domainId);
  if (ipOwner == null) {
    throw new InvalidParameterValueException("Unable to find account " + accountName + " in domain "+ domainId+ ", permission denied");
  }
  _accountMgr.checkAccess(caller,ipOwner);
  DataCenterVO zone=null;
  if (zoneId != null) {
    zone=_dcDao.findById(zoneId);
    if (zone == null) {
      throw new InvalidParameterValueException("Can't find zone by id " + zoneId);
    }
    if (Grouping.AllocationState.Disabled == zone.getAllocationState() && !_accountMgr.isRootAdmin(caller.getType())) {
      throw new PermissionDeniedException("Cannot perform this operation, Zone is currently disabled: " + zoneId);
    }
  }
  long ownerId=ipOwner.getId();
  Long networkId=cmd.getNetworkId();
  Network network=null;
  if (networkId != null) {
    network=_networksDao.findById(networkId);
    if (network == null) {
      throw new InvalidParameterValueException("Network id is invalid: " + networkId);
    }
  }
  if (zone.getNetworkType() != NetworkType.Basic && network.getAccountId() != ipOwner.getId()) {
    throw new InvalidParameterValueException("The owner of the network is not the same as owner of the IP");
  }
  PublicIp ip=null;
  Transaction txn=Transaction.currentTxn();
  Account accountToLock=null;
  try {
    if (s_logger.isDebugEnabled()) {
      s_logger.debug("Associate IP address called for user " + userId + " account "+ ownerId);
    }
    accountToLock=_accountDao.acquireInLockTable(ownerId);
    if (accountToLock == null) {
      s_logger.warn("Unable to lock account: " + ownerId);
      throw new ConcurrentOperationException("Unable to acquire account lock");
    }
    if (s_logger.isDebugEnabled()) {
      s_logger.debug("Associate IP address lock acquired");
    }
    if (_accountMgr.resourceLimitExceeded(accountToLock,ResourceType.public_ip)) {
      ResourceAllocationException rae=new ResourceAllocationException("Maximum number of public IP addresses for account: " + accountToLock.getAccountName() + " has been exceeded.");
      rae.setResourceType("ip");
      throw rae;
    }
    boolean isSourceNat=false;
    txn.start();
    List<IPAddressVO> addrs=listPublicIpAddressesInVirtualNetwork(ownerId,zoneId,true,networkId);
    if (addrs.isEmpty() && network.getGuestType() == GuestIpType.Virtual) {
      isSourceNat=true;
    }
    ip=fetchNewPublicIp(zoneId,null,null,ipOwner,VlanType.VirtualNetwork,network.getId(),isSourceNat,false);
    if (ip == null) {
      throw new InsufficientAddressCapacityException("Unable to find available public IP addresses",DataCenter.class,zoneId);
    }
    UserContext.current().setEventDetails("Ip Id: " + ip.getId());
    Ip ipAddress=ip.getAddress();
    s_logger.debug("Got " + ipAddress + " to assign for account "+ ipOwner.getId()+ " in zone "+ network.getDataCenterId());
    txn.commit();
  }
  finally {
    if (accountToLock != null) {
      _accountDao.releaseFromLockTable(ownerId);
      s_logger.debug("Associate IP address lock released");
    }
  }
  return ip;
}
