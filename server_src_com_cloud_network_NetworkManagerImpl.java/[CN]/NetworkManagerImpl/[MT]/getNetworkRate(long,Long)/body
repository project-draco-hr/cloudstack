{
  VMInstanceVO vm=null;
  if (vmId != null) {
    vm=_vmDao.findById(vmId);
  }
  Network network=getNetwork(networkId);
  NetworkOffering networkOffering=_configMgr.getNetworkOffering(network.getNetworkOfferingId());
  if (vm != null && vm.getType() == Type.User && network.isDefault()) {
    return _configMgr.getServiceOfferingNetworkRate(vm.getServiceOfferingId());
  }
 else {
    if (vm != null && vm.getType() == Type.DomainRouter && networkOffering.getTrafficType() == TrafficType.Public && networkOffering.getGuestType() == null) {
      List<? extends NetworkOffering> guestOfferings=_networkOfferingDao.listByTrafficTypeAndGuestType(false,TrafficType.Guest,GuestIpType.Virtual);
      if (!guestOfferings.isEmpty()) {
        networkOffering=guestOfferings.get(0);
      }
    }
    return _configMgr.getNetworkOfferingNetworkRate(networkOffering.getId());
  }
}
