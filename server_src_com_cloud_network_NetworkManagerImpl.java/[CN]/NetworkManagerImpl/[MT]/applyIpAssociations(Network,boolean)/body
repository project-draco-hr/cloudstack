{
  List<IPAddressVO> userIps=_ipAddressDao.listByNetwork(network.getId());
  List<PublicIp> publicIps=new ArrayList<PublicIp>();
  if (userIps != null && !userIps.isEmpty()) {
    for (    IPAddressVO userIp : userIps) {
      PublicIp publicIp=new PublicIp(userIp,_vlanDao.findById(userIp.getVlanId()),userIp.getMacAddress());
      publicIps.add(publicIp);
    }
  }
  boolean success=true;
  for (  NetworkElement element : _networkElements) {
    try {
      element.applyIps(network,publicIps);
    }
 catch (    ResourceUnavailableException e) {
      success=false;
      if (!continueOnError) {
        throw e;
      }
 else {
        s_logger.debug("Resource is not available: " + element.getName(),e);
      }
    }
  }
  if (success) {
    for (    IPAddressVO addr : userIps) {
      if (addr.getState() == IpAddress.State.Allocating) {
        addr.setState(IpAddress.State.Allocated);
        addr.setAssociatedNetworkId(network.getId());
        _ipAddressDao.update(addr.getAddress(),addr);
      }
 else       if (addr.getState() == IpAddress.State.Releasing) {
        _ipAddressDao.unassignIpAddress(addr.getAddress());
      }
    }
  }
  return success;
}
