{
  List<IPAddressVO> userIps=_ipAddressDao.listByAssociatedNetwork(network.getId(),null);
  List<PrivateIp> publicIps=new ArrayList<PrivateIp>();
  if (userIps != null && !userIps.isEmpty()) {
    for (    IPAddressVO userIp : userIps) {
      PrivateIp publicIp=new PrivateIp(userIp,_vlanDao.findById(userIp.getVlanId()),NetUtils.createSequenceBasedMacAddress(userIp.getMacAddress()));
      publicIps.add(publicIp);
    }
  }
  boolean success=applyIpAssociations(network,false,continueOnError,publicIps);
  if (success) {
    for (    IPAddressVO addr : userIps) {
      if (addr.getState() == IpAddress.State.Allocating) {
        markPublicIpAsAllocated(addr);
      }
 else       if (addr.getState() == IpAddress.State.Releasing) {
        if (cleanupIpResources(addr.getId(),Account.ACCOUNT_ID_SYSTEM,_accountMgr.getSystemAccount())) {
          s_logger.debug("Unassiging ip address " + addr);
          _ipAddressDao.unassignIpAddress(addr.getId());
        }
 else {
          success=false;
          s_logger.warn("Failed to release resources for ip address id=" + addr.getId());
        }
      }
    }
  }
  return success;
}
