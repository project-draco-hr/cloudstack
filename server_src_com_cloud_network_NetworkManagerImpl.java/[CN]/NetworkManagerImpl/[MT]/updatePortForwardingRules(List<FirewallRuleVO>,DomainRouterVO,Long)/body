{
  final List<FirewallRuleVO> fwdRules=new ArrayList<FirewallRuleVO>();
  final List<FirewallRuleVO> result=new ArrayList<FirewallRuleVO>();
  if (fwRules.size() == 0) {
    return result;
  }
  final Command[] cmds=new Command[fwRules.size()];
  int i=0;
  for (  final FirewallRuleVO rule : fwRules) {
    IPAddressVO ip=_ipAddressDao.findById(rule.getPublicIpAddress());
    VlanVO vlan=_vlanDao.findById(new Long(ip.getVlanDbId()));
    String vlanNetmask=vlan.getVlanNetmask();
    rule.setVlanNetmask(vlanNetmask);
    if (rule.isForwarding()) {
      fwdRules.add(rule);
      final SetFirewallRuleCommand cmd=new SetFirewallRuleCommand(router.getInstanceName(),router.getPrivateIpAddress(),rule);
      cmds[i++]=cmd;
    }
  }
  Answer[] answers=null;
  try {
    answers=_agentMgr.send(hostId,cmds,false);
  }
 catch (  final AgentUnavailableException e) {
    s_logger.warn("agent unavailable",e);
  }
catch (  final OperationTimedoutException e) {
    s_logger.warn("Timed Out",e);
  }
  if (answers == null) {
    return result;
  }
  i=0;
  for (  final FirewallRuleVO rule : fwdRules) {
    final Answer ans=answers[i++];
    if (ans != null) {
      if (ans.getResult()) {
        result.add(rule);
      }
    }
  }
  return result;
}
