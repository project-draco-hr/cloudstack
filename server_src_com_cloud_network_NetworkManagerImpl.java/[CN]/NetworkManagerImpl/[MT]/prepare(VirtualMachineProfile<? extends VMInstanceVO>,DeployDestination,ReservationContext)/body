{
  List<NicVO> nics=_nicDao.listByVmId(vmProfile.getId());
  for (  NicVO nic : nics) {
    Pair<NetworkGuru,NetworkVO> implemented=implementNetwork(nic.getNetworkId(),dest,context);
    NetworkGuru guru=implemented.first();
    NetworkVO network=implemented.second();
    NetworkOffering no=_configMgr.getNetworkOffering(network.getNetworkOfferingId());
    Integer networkRate=_configMgr.getNetworkRate(no.getId());
    NicProfile profile=null;
    if (nic.getReservationStrategy() == Nic.ReservationStrategy.Start) {
      nic.setState(Nic.State.Reserving);
      nic.setReservationId(context.getReservationId());
      _nicDao.update(nic.getId(),nic);
      URI broadcastUri=nic.getBroadcastUri();
      if (broadcastUri == null) {
        broadcastUri=network.getBroadcastUri();
      }
      URI isolationUri=nic.getIsolationUri();
      profile=new NicProfile(nic,network,broadcastUri,isolationUri,networkRate);
      guru.reserve(profile,network,vmProfile,dest,context);
      nic.setIp4Address(profile.getIp4Address());
      nic.setIp6Address(profile.getIp6Address());
      nic.setMacAddress(profile.getMacAddress());
      nic.setIsolationUri(profile.getIsolationUri());
      nic.setBroadcastUri(profile.getBroadCastUri());
      nic.setReserver(guru.getName());
      nic.setState(Nic.State.Reserved);
      nic.setNetmask(profile.getNetmask());
      nic.setGateway(profile.getGateway());
      nic.setAddressFormat(profile.getFormat());
      updateNic(nic,network.getId(),1);
    }
 else {
      profile=new NicProfile(nic,network,nic.getBroadcastUri(),nic.getIsolationUri(),networkRate);
      nic.setState(Nic.State.Reserved);
      updateNic(nic,network.getId(),1);
    }
    for (    NetworkElement element : _networkElements) {
      if (s_logger.isDebugEnabled()) {
        s_logger.debug("Asking " + element.getName() + " to prepare for "+ nic);
      }
      element.prepare(network,profile,vmProfile,dest,context);
    }
    profile.setSecurityGroupEnabled(network.isSecurityGroupEnabled());
    guru.updateNicProfile(profile,network);
    vmProfile.addNic(profile);
  }
}
