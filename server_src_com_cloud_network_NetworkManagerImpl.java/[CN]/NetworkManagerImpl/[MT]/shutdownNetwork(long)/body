{
  Transaction txn=Transaction.currentTxn();
  txn.start();
  NetworkVO network=_networksDao.lockRow(networkId,true);
  if (network == null) {
    s_logger.debug("Unable to find network with id: " + networkId);
    return;
  }
  if (network.getState() != Network.State.Implemented && network.getState() != Network.State.Destroying) {
    s_logger.debug("Network is not implemented: " + network);
    return;
  }
  network.setState(Network.State.Destroying);
  _networksDao.update(network.getId(),network);
  txn.commit();
  boolean success=true;
  for (  NetworkElement element : _networkElements) {
    try {
      if (s_logger.isDebugEnabled()) {
        s_logger.debug("Sending network shutdown to " + element);
      }
      element.shutdown(network,null);
    }
 catch (    ResourceUnavailableException e) {
      s_logger.warn("Unable to complete shutdown of the network due to element: " + element.getName(),e);
      success=false;
    }
catch (    ConcurrentOperationException e) {
      s_logger.warn("Unable to complete shutdown of the network due to element: " + element.getName(),e);
      success=false;
    }
catch (    Exception e) {
      s_logger.warn("Unable to complete shutdown of the network due to element: " + element.getName(),e);
      success=false;
    }
  }
  txn.start();
  if (success) {
    if (s_logger.isDebugEnabled()) {
    }
    NetworkGuru guru=_networkGurus.get(network.getGuruName());
    guru.destroy(network,_networkOfferingDao.findById(network.getNetworkOfferingId()));
    network.setState(Network.State.Allocated);
    _networksDao.update(network.getId(),network);
    _networksDao.clearCheckForGc(networkId);
  }
 else {
    network.setState(Network.State.Implemented);
    _networksDao.update(network.getId(),network);
  }
  txn.commit();
}
