{
  List<PublicIp> ipList=new ArrayList<PublicIp>();
  ipList.add(ip);
  Map<PublicIp,Set<Service>> ipToServices=getIpToServices(ipList,false);
  Set<Service> currentServices=ipToServices.get(ip);
  if (currentServices == null || currentServices.isEmpty()) {
    return true;
  }
  if (currentServices.size() != 1) {
    throw new CloudRuntimeException("There are multiply services used ip " + ip.getAddress() + ".");
  }
  if (service != null && (Service)currentServices.toArray()[0] != service) {
    throw new CloudRuntimeException("The IP " + ip.getAddress() + " is already used as "+ ((Service)currentServices.toArray()[0]).getName()+ " rather than "+ service.getName());
  }
  return true;
}
