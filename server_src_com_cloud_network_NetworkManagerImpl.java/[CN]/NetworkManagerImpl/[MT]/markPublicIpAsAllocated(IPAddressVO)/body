{
  Transaction txn=Transaction.currentTxn();
  Account owner=_accountMgr.getAccount(addr.getAccountId());
  long isSourceNat=(addr.isSourceNat()) ? 1 : 0;
  txn.start();
  addr.setState(IpAddress.State.Allocated);
  _ipAddressDao.update(addr.getId(),addr);
  if (owner.getAccountId() != Account.ACCOUNT_ID_SYSTEM) {
    UsageEventVO usageEvent=new UsageEventVO(EventTypes.EVENT_NET_IP_ASSIGN,owner.getId(),addr.getDataCenterId(),addr.getId(),addr.getAddress().toString(),isSourceNat);
    _usageEventDao.persist(usageEvent);
  }
  _accountMgr.incrementResourceCount(owner.getId(),ResourceType.public_ip);
  txn.commit();
}
