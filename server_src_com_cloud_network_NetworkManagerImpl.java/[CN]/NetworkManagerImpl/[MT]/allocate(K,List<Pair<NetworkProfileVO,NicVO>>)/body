{
  List<NicVO> nics=new ArrayList<NicVO>(networks.size());
  Transaction txn=Transaction.currentTxn();
  txn.start();
  for (  Pair<NetworkProfileVO,NicVO> network : networks) {
    for (    NetworkConcierge concierge : _networkConcierges) {
      Nic nic=concierge.allocate(vm,network.first(),network.second());
      if (nic == null) {
        continue;
      }
      NicVO vo=new NicVO(concierge.getUniqueName(),vm.getId(),network.first().getId());
      if (nic.getIp4Address() != null) {
        vo.setIp4Address(nic.getIp4Address());
        vo.setState(NicVO.State.IpAcquired);
      }
      if (nic.getMacAddress() != null) {
        vo.setMacAddress(nic.getMacAddress());
      }
      if (nic.getMode() != null) {
        vo.setMode(nic.getMode());
      }
      vo=_nicDao.persist(vo);
      nics.add(vo);
    }
  }
  txn.commit();
  return nics;
}
