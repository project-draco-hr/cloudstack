{
  Long userId=UserContext.current().getUserId();
  Account account=getAccountForApiCommand(cmd.getAccountName(),cmd.getDomainId());
  EventUtils.saveStartedEvent(userId,account.getId(),EventTypes.EVENT_VPN_USER_ADD,"Add VPN user for account: " + account.getAccountName(),cmd.getStartEventId());
  if (!cmd.getUserName().matches("^[a-zA-Z0-9][a-zA-Z0-9@._-]{2,63}$")) {
    throw new InvalidParameterValueException("Username has to be begin with an alphabet have 3-64 characters including alphabets, numbers and the set '@.-_'");
  }
  if (!cmd.getPassword().matches("^[a-zA-Z0-9][a-zA-Z0-9@#+=._-]{2,31}$")) {
    throw new InvalidParameterValueException("Password has to be 3-32 characters including alphabets, numbers and the set '@#+=.-_'");
  }
  account=_accountDao.acquireInLockTable(account.getId());
  if (account == null) {
    throw new ConcurrentOperationException("Unable to add vpn user: Another operation active");
  }
  try {
    long userCount=_vpnUsersDao.getVpnUserCount(account.getId());
    Integer userLimit=getIntegerConfigValue(Config.RemoteAccessVpnUserLimit.key(),8);
    if (userCount >= userLimit) {
      throw new AccountLimitException("Cannot add more than " + userLimit + " remote access vpn users");
    }
    VpnUserVO user=addRemoveVpnUser(account,cmd.getUserName(),cmd.getPassword(),true);
    if (user != null) {
      EventUtils.saveEvent(userId,account.getId(),EventTypes.EVENT_VPN_USER_ADD,"Added a VPN user for account: " + account.getAccountName() + " username= "+ cmd.getUserName());
      return user;
    }
 else {
      EventUtils.saveEvent(userId,account.getId(),EventVO.LEVEL_ERROR,EventTypes.EVENT_VPN_USER_ADD,"Unable to add VPN user for account: ",account.getAccountName() + " username= " + cmd.getUserName());
      throw new ServerApiException(BaseCmd.INTERNAL_ERROR,"Unable to add VPN user for account: " + account.getAccountName() + " username= "+ cmd.getUserName());
    }
  }
  finally {
    if (account != null)     _accountDao.releaseFromLockTable(account.getId());
  }
}
