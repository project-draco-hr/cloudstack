{
  VMTemplateVO template=_tmpltDao.findById(templateHostRef.getTemplateId());
  long templateId=template.getId();
  HostVO secondaryStorageHost=_hostDao.findById(templateHostRef.getHostId());
  long zoneId=secondaryStorageHost.getDataCenterId();
  DataCenterVO zone=_dcDao.findById(zoneId);
  List<VMInstanceVO> nonExpungedVms=_vmInstanceDao.listNonExpungedByZoneAndTemplate(zoneId,templateId);
  if (!nonExpungedVms.isEmpty()) {
    s_logger.debug("Template " + template.getName() + " in zone "+ zone.getName()+ " is not deleteable because there are non-expunged VMs deployed from this template.");
    return false;
  }
  List<VolumeVO> volumes=_volumeDao.findByTemplateAndZone(templateId,zoneId);
  for (  VolumeVO volume : volumes) {
    List<SnapshotVO> snapshots=_snapshotDao.listByVolumeId(volume.getId());
    if (!snapshots.isEmpty()) {
      s_logger.debug("Template " + template.getName() + " in zone "+ zone.getName()+ " is not deleteable because there are snapshots using this template.");
      return false;
    }
  }
  return true;
}
