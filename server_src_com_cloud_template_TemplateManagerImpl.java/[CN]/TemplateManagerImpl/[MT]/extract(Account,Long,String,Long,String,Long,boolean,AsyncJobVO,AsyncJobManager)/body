{
  String desc="template";
  if (isISO) {
    desc="ISO";
  }
  VMTemplateVO template=_tmpltDao.findById(templateId);
  if (template == null) {
    throw new InvalidParameterValueException("Unable to find " + desc + " with id "+ templateId);
  }
  if (template.getTemplateType() == Storage.TemplateType.SYSTEM) {
    throw new InvalidParameterValueException("Unable to extract the " + desc + " "+ template.getName()+ " as it is a default System template");
  }
  if (isISO) {
    if (template.getFormat() != ImageFormat.ISO) {
      throw new InvalidParameterValueException("Unsupported format, could not extract the ISO");
    }
  }
 else {
    if (template.getFormat() == ImageFormat.ISO) {
      throw new InvalidParameterValueException("Unsupported format, could not extract the template");
    }
  }
  if (!template.isExtractable()) {
    throw new PermissionDeniedException("The " + desc + " is not allowed to be extracted");
  }
  if (_dcDao.findById(zoneId) == null) {
    throw new IllegalArgumentException("Please specify a valid zone.");
  }
  if (account != null) {
    if (!isAdmin(account.getType())) {
      if (template.getAccountId() != account.getId()) {
        throw new PermissionDeniedException("Unable to find " + desc + " with ID: "+ templateId+ " for account: "+ account.getAccountName());
      }
    }
 else {
      Account userAccount=_accountDao.findById(template.getAccountId());
      if ((userAccount == null) || !_domainDao.isChildDomain(account.getDomainId(),userAccount.getDomainId())) {
        throw new PermissionDeniedException("Unable to extract " + desc + "="+ templateId+ " - permission denied.");
      }
    }
  }
  HostVO secondaryStorageHost=_storageMgr.getSecondaryStorageHost(zoneId);
  VMTemplateHostVO tmpltHostRef=null;
  if (secondaryStorageHost != null) {
    tmpltHostRef=_tmpltHostDao.findByHostTemplate(secondaryStorageHost.getId(),templateId);
    if (tmpltHostRef != null && tmpltHostRef.getDownloadState() != com.cloud.storage.VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {
      throw new InvalidParameterValueException("The " + desc + " has not been downloaded ");
    }
  }
  Upload.Mode extractMode;
  if (mode == null || (!mode.equals(Upload.Mode.FTP_UPLOAD.toString()) && !mode.equals(Upload.Mode.HTTP_DOWNLOAD.toString()))) {
    throw new ServerApiException(BaseCmd.PARAM_ERROR,"Please specify a valid extract Mode " + Upload.Mode.values());
  }
 else {
    extractMode=mode.equals(Upload.Mode.FTP_UPLOAD.toString()) ? Upload.Mode.FTP_UPLOAD : Upload.Mode.HTTP_DOWNLOAD;
  }
  long userId=UserContext.current().getUserId();
  long accountId=template.getAccountId();
  String event=isISO ? EventTypes.EVENT_ISO_EXTRACT : EventTypes.EVENT_TEMPLATE_EXTRACT;
  if (extractMode == Upload.Mode.FTP_UPLOAD) {
    URI uri=null;
    try {
      uri=new URI(url);
      if ((uri.getScheme() == null) || (!uri.getScheme().equalsIgnoreCase("ftp"))) {
        throw new InvalidParameterValueException("Unsupported scheme for url: " + url);
      }
    }
 catch (    Exception ex) {
      throw new InvalidParameterValueException("Invalid url given: " + url);
    }
    String host=uri.getHost();
    try {
      InetAddress hostAddr=InetAddress.getByName(host);
      if (hostAddr.isAnyLocalAddress() || hostAddr.isLinkLocalAddress() || hostAddr.isLoopbackAddress()|| hostAddr.isMulticastAddress()) {
        throw new InvalidParameterValueException("Illegal host specified in url");
      }
      if (hostAddr instanceof Inet6Address) {
        throw new InvalidParameterValueException("IPV6 addresses not supported (" + hostAddr.getHostAddress() + ")");
      }
    }
 catch (    UnknownHostException uhe) {
      throw new InvalidParameterValueException("Unable to resolve " + host);
    }
    if (_uploadMonitor.isTypeUploadInProgress(templateId,isISO ? Type.ISO : Type.TEMPLATE)) {
      throw new IllegalArgumentException(template.getName() + " upload is in progress. Please wait for some time to schedule another upload for the same");
    }
    EventUtils.saveStartedEvent(userId,accountId,event,"Starting extraction of " + template.getName() + " mode:"+ extractMode.toString(),eventId);
    return _uploadMonitor.extractTemplate(template,url,tmpltHostRef,zoneId,eventId,job.getId(),mgr);
  }
  EventUtils.saveStartedEvent(userId,accountId,event,"Starting extraction of " + template.getName() + " in mode:"+ extractMode.toString(),eventId);
  UploadVO vo=_uploadMonitor.createEntityDownloadURL(template,tmpltHostRef,zoneId,eventId);
  if (vo != null) {
    ExtractJobResultObject resultObject=new ExtractJobResultObject(template.getAccountId(),template.getName(),Upload.Status.DOWNLOAD_URL_CREATED.toString(),vo.getId(),url);
    mgr.completeAsyncJob(job.getId(),AsyncJobResult.STATUS_SUCCEEDED,1,resultObject);
    EventUtils.saveEvent(userId,accountId,EventVO.LEVEL_INFO,event,"Completed extraction of " + template.getName() + " in mode:"+ mode,null,eventId);
    return vo.getId();
  }
 else {
    EventUtils.saveEvent(userId,accountId,EventVO.LEVEL_ERROR,event,"Failed extraction of " + template.getName() + " in mode:"+ mode,null,eventId);
    mgr.completeAsyncJob(job.getId(),AsyncJobResult.STATUS_FAILED,2,null);
    return null;
  }
}
