{
  String desc="template";
  if (isISO) {
    desc="ISO";
  }
  eventId=eventId == null ? 0 : eventId;
  VMTemplateVO template=_tmpltDao.findById(templateId);
  if (template == null) {
    throw new InvalidParameterValueException("Unable to find " + desc + " with id "+ templateId);
  }
  if (template.getTemplateType() == Storage.TemplateType.SYSTEM) {
    throw new InvalidParameterValueException("Unable to extract the " + desc + " "+ template.getName()+ " as it is a default System template");
  }
  if (template.getTemplateType() == Storage.TemplateType.PERHOST) {
    throw new InvalidParameterValueException("Unable to extract the " + desc + " "+ template.getName()+ " as it resides on host and not on SSVM");
  }
  if (isISO) {
    if (template.getFormat() != ImageFormat.ISO) {
      throw new InvalidParameterValueException("Unsupported format, could not extract the ISO");
    }
  }
 else {
    if (template.getFormat() == ImageFormat.ISO) {
      throw new InvalidParameterValueException("Unsupported format, could not extract the template");
    }
  }
  if (_dcDao.findById(zoneId) == null) {
    throw new IllegalArgumentException("Please specify a valid zone.");
  }
  if (account != null && account.getType() != Account.ACCOUNT_TYPE_ADMIN) {
    if (template.getAccountId() == account.getId() && template.isExtractable()) {
    }
 else     if (template.getAccountId() != account.getId() && template.isPublicTemplate() && template.isExtractable()) {
    }
 else {
      throw new PermissionDeniedException("Unable to extract " + desc + "="+ templateId+ " - permission denied.");
    }
  }
  HostVO secondaryStorageHost=_storageMgr.getSecondaryStorageHost(zoneId);
  VMTemplateHostVO tmpltHostRef=null;
  if (secondaryStorageHost != null) {
    tmpltHostRef=_tmpltHostDao.findByHostTemplate(secondaryStorageHost.getId(),templateId);
    if (tmpltHostRef != null && tmpltHostRef.getDownloadState() != com.cloud.storage.VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {
      throw new InvalidParameterValueException("The " + desc + " has not been downloaded ");
    }
  }
  Upload.Mode extractMode;
  if (mode == null || (!mode.equals(Upload.Mode.FTP_UPLOAD.toString()) && !mode.equals(Upload.Mode.HTTP_DOWNLOAD.toString()))) {
    throw new InvalidParameterValueException("Please specify a valid extract Mode " + Upload.Mode.values());
  }
 else {
    extractMode=mode.equals(Upload.Mode.FTP_UPLOAD.toString()) ? Upload.Mode.FTP_UPLOAD : Upload.Mode.HTTP_DOWNLOAD;
  }
  if (extractMode == Upload.Mode.FTP_UPLOAD) {
    URI uri=null;
    try {
      uri=new URI(url);
      if ((uri.getScheme() == null) || (!uri.getScheme().equalsIgnoreCase("ftp"))) {
        throw new InvalidParameterValueException("Unsupported scheme for url: " + url);
      }
    }
 catch (    Exception ex) {
      throw new InvalidParameterValueException("Invalid url given: " + url);
    }
    String host=uri.getHost();
    try {
      InetAddress hostAddr=InetAddress.getByName(host);
      if (hostAddr.isAnyLocalAddress() || hostAddr.isLinkLocalAddress() || hostAddr.isLoopbackAddress()|| hostAddr.isMulticastAddress()) {
        throw new InvalidParameterValueException("Illegal host specified in url");
      }
      if (hostAddr instanceof Inet6Address) {
        throw new InvalidParameterValueException("IPV6 addresses not supported (" + hostAddr.getHostAddress() + ")");
      }
    }
 catch (    UnknownHostException uhe) {
      throw new InvalidParameterValueException("Unable to resolve " + host);
    }
    if (_uploadMonitor.isTypeUploadInProgress(templateId,isISO ? Type.ISO : Type.TEMPLATE)) {
      throw new IllegalArgumentException(template.getName() + " upload is in progress. Please wait for some time to schedule another upload for the same");
    }
    return _uploadMonitor.extractTemplate(template,url,tmpltHostRef,zoneId,eventId,job.getId(),mgr);
  }
  UploadVO vo=_uploadMonitor.createEntityDownloadURL(template,tmpltHostRef,zoneId,eventId);
  if (vo != null) {
    return vo.getId();
  }
 else {
    return null;
  }
}
