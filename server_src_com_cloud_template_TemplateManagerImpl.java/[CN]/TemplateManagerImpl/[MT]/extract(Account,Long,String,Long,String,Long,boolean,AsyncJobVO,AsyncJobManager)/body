{
  String desc=Upload.Type.TEMPLATE.toString();
  if (isISO) {
    desc=Upload.Type.ISO.toString();
  }
  eventId=eventId == null ? 0 : eventId;
  if (!_accountMgr.isRootAdmin(caller.getType()) && _disableExtraction) {
    throw new PermissionDeniedException("Extraction has been disabled by admin");
  }
  VMTemplateVO template=_tmpltDao.findById(templateId);
  if (template == null || template.getRemoved() != null) {
    throw new InvalidParameterValueException("Unable to find " + desc + " with id "+ templateId);
  }
  if (template.getTemplateType() == Storage.TemplateType.SYSTEM) {
    throw new InvalidParameterValueException("Unable to extract the " + desc + " "+ template.getName()+ " as it is a default System template");
  }
 else   if (template.getTemplateType() == Storage.TemplateType.PERHOST) {
    throw new InvalidParameterValueException("Unable to extract the " + desc + " "+ template.getName()+ " as it resides on host and not on SSVM");
  }
  if (isISO) {
    if (template.getFormat() != ImageFormat.ISO) {
      throw new InvalidParameterValueException("Unsupported format, could not extract the ISO");
    }
  }
 else {
    if (template.getFormat() == ImageFormat.ISO) {
      throw new InvalidParameterValueException("Unsupported format, could not extract the template");
    }
  }
  if (zoneId != null && _dcDao.findById(zoneId) == null) {
    throw new IllegalArgumentException("Please specify a valid zone.");
  }
  if (!_accountMgr.isRootAdmin(caller.getType()) && !template.isExtractable()) {
    throw new InvalidParameterValueException("Unable to extract template id=" + templateId + " as it's not extractable");
  }
  _accountMgr.checkAccess(caller,AccessType.ModifyEntry,true,template);
  List<DataStore> ssStores=this._dataStoreMgr.getImageStoresByScope(new ZoneScope(zoneId));
  TemplateDataStoreVO tmpltStoreRef=null;
  ImageStoreEntity tmpltStore=null;
  if (ssStores != null) {
    for (    DataStore store : ssStores) {
      tmpltStoreRef=this._tmplStoreDao.findByStoreTemplate(store.getId(),templateId);
      if (tmpltStoreRef != null) {
        if (tmpltStoreRef.getDownloadState() == com.cloud.storage.VMTemplateStorageResourceAssoc.Status.DOWNLOADED) {
          tmpltStore=(ImageStoreEntity)store;
          break;
        }
      }
    }
  }
  if (tmpltStoreRef == null) {
    throw new InvalidParameterValueException("The " + desc + " has not been downloaded ");
  }
  if (tmpltStore.getProviderName().equalsIgnoreCase("S3") || tmpltStore.getProviderName().equalsIgnoreCase("Swift")) {
    return new Pair<Long,String>(null,tmpltStoreRef.getInstallPath());
  }
  Upload.Mode extractMode;
  if (mode == null || (!mode.equalsIgnoreCase(Upload.Mode.FTP_UPLOAD.toString()) && !mode.equalsIgnoreCase(Upload.Mode.HTTP_DOWNLOAD.toString()))) {
    throw new InvalidParameterValueException("Please specify a valid extract Mode. Supported modes: " + Upload.Mode.FTP_UPLOAD + ", "+ Upload.Mode.HTTP_DOWNLOAD);
  }
 else {
    extractMode=mode.equalsIgnoreCase(Upload.Mode.FTP_UPLOAD.toString()) ? Upload.Mode.FTP_UPLOAD : Upload.Mode.HTTP_DOWNLOAD;
  }
  if (extractMode == Upload.Mode.FTP_UPLOAD) {
    URI uri=null;
    try {
      uri=new URI(url);
      if ((uri.getScheme() == null) || (!uri.getScheme().equalsIgnoreCase("ftp"))) {
        throw new InvalidParameterValueException("Unsupported scheme for url: " + url);
      }
    }
 catch (    Exception ex) {
      throw new InvalidParameterValueException("Invalid url given: " + url);
    }
    String host=uri.getHost();
    try {
      InetAddress hostAddr=InetAddress.getByName(host);
      if (hostAddr.isAnyLocalAddress() || hostAddr.isLinkLocalAddress() || hostAddr.isLoopbackAddress()|| hostAddr.isMulticastAddress()) {
        throw new InvalidParameterValueException("Illegal host specified in url");
      }
      if (hostAddr instanceof Inet6Address) {
        throw new InvalidParameterValueException("IPV6 addresses not supported (" + hostAddr.getHostAddress() + ")");
      }
    }
 catch (    UnknownHostException uhe) {
      throw new InvalidParameterValueException("Unable to resolve " + host);
    }
    if (_uploadMonitor.isTypeUploadInProgress(templateId,isISO ? Type.ISO : Type.TEMPLATE)) {
      throw new IllegalArgumentException(template.getName() + " upload is in progress. Please wait for some time to schedule another upload for the same");
    }
    return new Pair<Long,String>(_uploadMonitor.extractTemplate(template,url,tmpltStoreRef,zoneId,eventId,job.getId(),mgr),null);
  }
  UploadVO vo=_uploadMonitor.createEntityDownloadURL(template,tmpltStoreRef,zoneId,eventId);
  if (vo != null) {
    return new Pair<Long,String>(vo.getId(),null);
  }
 else {
    return null;
  }
}
