{
  Long id=_tmpltDao.getNextInSequence(Long.class,"id");
  AccountVO account=_accountDao.findById(accountId);
  if (account.getType() != Account.ACCOUNT_TYPE_ADMIN && zoneId == null) {
    throw new IllegalArgumentException("Only admins can create templates in all zones");
  }
  VMTemplateVO template=new VMTemplateVO(id,name,format,isPublic,featured,isExtractable,type,url,requiresHvm,bits,accountId,chksum,displayText,enablePassword,guestOSId,bootable,hyperType);
  if (zoneId == null) {
    List<DataCenterVO> dcs=_dcDao.listAllIncludingRemoved();
    for (    DataCenterVO dc : dcs) {
      _tmpltDao.addTemplateToZone(template,dc.getId());
    }
    template.setCrossZones(true);
  }
 else {
    _tmpltDao.addTemplateToZone(template,zoneId);
  }
  if (hyperType == HypervisorType.BareMetal) {
    VMTemplateHostVO vmTemplateHost=null;
    if (zoneId == null) {
      List<DataCenterVO> dcs=_dcDao.listAllIncludingRemoved();
      for (      DataCenterVO dc : dcs) {
        vmTemplateHost=_vmTemplateHostDao.findByHostTemplate(dc.getId(),template.getId());
        if (vmTemplateHost == null) {
          vmTemplateHost=new VMTemplateHostVO(dc.getId(),template.getId(),new Date(),100,VMTemplateStorageResourceAssoc.Status.DOWNLOADED,null,null,null,null,template.getUrl());
          _vmTemplateHostDao.persist(vmTemplateHost);
        }
      }
    }
 else {
      vmTemplateHost=new VMTemplateHostVO(zoneId,template.getId(),new Date(),100,VMTemplateStorageResourceAssoc.Status.DOWNLOADED,null,null,null,null,template.getUrl());
      _vmTemplateHostDao.persist(vmTemplateHost);
    }
  }
 else {
    _downloadMonitor.downloadTemplateToStorage(id,zoneId);
  }
  _accountMgr.incrementResourceCount(accountId,ResourceType.template);
  return template;
}
