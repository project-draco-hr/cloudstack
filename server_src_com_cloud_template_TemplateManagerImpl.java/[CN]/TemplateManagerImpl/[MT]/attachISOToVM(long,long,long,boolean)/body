{
  UserVmVO vm=_userVmDao.findById(vmId);
  VMTemplateVO iso=_tmpltDao.findById(isoId);
  long startEventId=0;
  if (attach) {
    startEventId=EventUtils.saveStartedEvent(userId,vm.getAccountId(),EventTypes.EVENT_ISO_ATTACH,"Attaching ISO: " + isoId + " to Vm: "+ vmId,startEventId);
  }
 else {
    startEventId=EventUtils.saveStartedEvent(userId,vm.getAccountId(),EventTypes.EVENT_ISO_DETACH,"Detaching ISO: " + isoId + " from Vm: "+ vmId,startEventId);
  }
  boolean success=_vmMgr.attachISOToVM(vmId,isoId,attach);
  if (attach) {
    vm.setIsoId(iso.getId());
  }
 else {
    vm.setIsoId(null);
  }
  _userVmDao.update(vmId,vm);
  if (success) {
    if (attach) {
      EventUtils.saveEvent(userId,vm.getAccountId(),EventVO.LEVEL_INFO,EventTypes.EVENT_ISO_ATTACH,"Successfully attached ISO: " + iso.getName() + " to VM with ID: "+ vmId,null,startEventId);
    }
 else {
      EventUtils.saveEvent(userId,vm.getAccountId(),EventVO.LEVEL_INFO,EventTypes.EVENT_ISO_DETACH,"Successfully detached ISO from VM with ID: " + vmId,null,startEventId);
    }
  }
 else {
    if (attach) {
      EventUtils.saveEvent(userId,vm.getAccountId(),EventVO.LEVEL_ERROR,EventTypes.EVENT_ISO_ATTACH,"Failed to attach ISO: " + iso.getName() + " to VM with ID: "+ vmId,null,startEventId);
    }
 else {
      EventUtils.saveEvent(userId,vm.getAccountId(),EventVO.LEVEL_ERROR,EventTypes.EVENT_ISO_DETACH,"Failed to detach ISO from VM with ID: " + vmId,null,startEventId);
    }
  }
  return success;
}
