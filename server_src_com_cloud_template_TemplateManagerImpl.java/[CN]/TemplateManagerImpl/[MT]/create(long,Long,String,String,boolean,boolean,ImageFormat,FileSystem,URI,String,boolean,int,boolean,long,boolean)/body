{
  Long id=_tmpltDao.getNextInSequence(Long.class,"id");
  UserVO user=_userDao.findById(userId);
  long accountId=user.getAccountId();
  AccountVO account=_accountDao.findById(accountId);
  if (account.getType() != Account.ACCOUNT_TYPE_ADMIN && zoneId == null) {
    throw new IllegalArgumentException("Only admins can create templates in all zones");
  }
  VMTemplateVO template=new VMTemplateVO(id,name,format,isPublic,featured,fs,url.toString(),requiresHvm,bits,accountId,chksum,displayText,enablePassword,guestOSId,bootable);
  if (zoneId == null) {
    List<DataCenterVO> dcs=_dcDao.listAllIncludingRemoved();
    for (    DataCenterVO dc : dcs) {
      _tmpltDao.addTemplateToZone(template,dc.getId());
    }
    template.setCrossZones(true);
  }
 else {
    _tmpltDao.addTemplateToZone(template,zoneId);
  }
  UserAccount userAccount=_userAccountDao.findById(userId);
  _downloadMonitor.downloadTemplateToStorage(id,zoneId);
  _accountMgr.incrementResourceCount(userAccount.getAccountId(),ResourceType.template);
  return id;
}
