{
  if (caller != null) {
    if (!isAdmin(caller.getType())) {
      if ((userVm != null) && (caller.getId() != userVm.getAccountId())) {
        throw new PermissionDeniedException(msg + ". Permission denied.");
      }
      if ((template != null) && (!template.isPublicTemplate() && (caller.getId() != template.getAccountId()) && (template.getTemplateType() != TemplateType.PERHOST))) {
        throw new PermissionDeniedException(msg + ". Permission denied.");
      }
    }
 else {
      if (userVm != null) {
        _accountMgr.checkAccess(caller,userVm);
      }
      if (template != null && !template.isPublicTemplate()) {
        Account templateOwner=_accountDao.findById(template.getAccountId());
        _accountMgr.checkAccess(caller,templateOwner);
      }
    }
  }
  return userId;
}
