{
  Account account=UserContext.current().getCaller();
  Long userId=UserContext.current().getCallerUserId();
  Long vmId=cmd.getVirtualMachineId();
  Long isoId=cmd.getId();
  UserVmVO vmInstanceCheck=_userVmDao.findById(vmId);
  if (vmInstanceCheck == null) {
    throw new InvalidParameterValueException("Unable to find a virtual machine with id " + vmId);
  }
  VMTemplateVO iso=_tmpltDao.findById(isoId);
  if (iso == null) {
    throw new ServerApiException(BaseCmd.PARAM_ERROR,"Unable to find an ISO with id " + isoId);
  }
  State vmState=vmInstanceCheck.getState();
  if (vmState != State.Running && vmState != State.Stopped) {
    throw new InvalidParameterValueException("Please specify a VM that is either Stopped or Running.");
  }
  String errMsg="Unable to attach ISO" + isoId + "to virtual machine "+ vmId;
  userId=accountAndUserValidation(account,userId,vmInstanceCheck,iso,errMsg);
  VMInstanceVO vm=ApiDBUtils.findVMInstanceById(vmId);
  VMTemplateVO vmTemplate=ApiDBUtils.findTemplateById(vm.getTemplateId());
  if ("xen-pv-drv-iso".equals(iso.getDisplayText()) && vmTemplate.getHypervisorType() != Hypervisor.HypervisorType.XenServer) {
    throw new InvalidParameterValueException("Cannot attach Xenserver PV drivers to incompatible hypervisor " + vmTemplate.getHypervisorType());
  }
  return attachISOToVM(vmId,userId,isoId,true);
}
