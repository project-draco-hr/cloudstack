{
  Account account=UserContext.current().getCaller();
  Long userId=UserContext.current().getCallerUserId();
  Long vmId=cmd.getVirtualMachineId();
  UserVmVO vmInstanceCheck=_userVmDao.findById(vmId.longValue());
  if (vmInstanceCheck == null) {
    throw new InvalidParameterValueException("Unable to find a virtual machine with id " + vmId);
  }
  UserVm userVM=_userVmDao.findById(vmId);
  if (userVM == null) {
    throw new InvalidParameterValueException("Please specify a valid VM.");
  }
  Long isoId=userVM.getIsoId();
  if (isoId == null) {
    throw new InvalidParameterValueException("The specified VM has no ISO attached to it.");
  }
  UserContext.current().setEventDetails("Vm Id: " + vmId + " ISO Id: "+ isoId);
  State vmState=userVM.getState();
  if (vmState != State.Running && vmState != State.Stopped) {
    throw new InvalidParameterValueException("Please specify a VM that is either Stopped or Running.");
  }
  String errMsg="Unable to detach ISO " + isoId + " from virtual machine";
  userId=accountAndUserValidation(account,userId,vmInstanceCheck,null,errMsg);
  return attachISOToVM(vmId,userId,isoId,false);
}
