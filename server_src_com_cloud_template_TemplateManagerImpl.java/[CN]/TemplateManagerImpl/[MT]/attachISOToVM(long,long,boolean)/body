{
  UserVmVO vm=this._userVmDao.findById(vmId);
  if (vm == null) {
    return false;
  }
 else   if (vm.getState() != State.Running) {
    return true;
  }
  TemplateInfo tmplt=this._tmplFactory.getTemplate(isoId,DataStoreRole.Image,vm.getDataCenterId());
  if (tmplt == null) {
    s_logger.warn("ISO: " + isoId + " does not exist");
    return false;
  }
  if (tmplt.getDataStore() != null && !(tmplt.getDataStore().getTO() instanceof NfsTO)) {
    String value=_configDao.getValue(Config.PrimaryStorageDownloadWait.toString());
    int _primaryStorageDownloadWait=NumbersUtil.parseInt(value,Integer.parseInt(Config.PrimaryStorageDownloadWait.getDefaultValue()));
    Scope destScope=new ZoneScope(vm.getDataCenterId());
    TemplateInfo cacheData=(TemplateInfo)cacheMgr.createCacheObject(tmplt,destScope);
    CopyCommand cmd=new CopyCommand(tmplt.getTO(),cacheData.getTO(),_primaryStorageDownloadWait);
    EndPoint ep=selector.select(tmplt,cacheData);
    Answer answer=ep.sendMessage(cmd);
    if (answer != null && answer.getResult()) {
      tmplt=cacheData;
    }
 else {
      s_logger.error("Failed in copy iso from S3 to cache storage");
      return false;
    }
  }
  String vmName=vm.getInstanceName();
  HostVO host=_hostDao.findById(vm.getHostId());
  if (host == null) {
    s_logger.warn("Host: " + vm.getHostId() + " does not exist");
    return false;
  }
  DataTO isoTO=tmplt.getTO();
  DiskTO disk=new DiskTO(isoTO,null,Volume.Type.ISO);
  Command cmd=null;
  if (attach) {
    cmd=new AttachCommand(disk,vmName);
  }
 else {
    cmd=new DettachCommand(disk,vmName);
  }
  Answer a=_agentMgr.easySend(vm.getHostId(),cmd);
  return (a != null && a.getResult());
}
