{
  GlobalLock swiftTemplateSyncLock=GlobalLock.getInternLock("templatemgr.swiftTemplateSync");
  try {
    Boolean swiftEnable=Boolean.valueOf(_configDao.getValue(Config.SwiftEnable.key()));
    if (!swiftEnable) {
      return;
    }
    List<HypervisorType> hypers=_clusterDao.getAvailableHypervisorInZone(null);
    List<VMTemplateVO> templates=_tmpltDao.listByHypervisorType(hypers);
    List<Long> templateIds=new ArrayList<Long>();
    for (    VMTemplateVO template : templates) {
      templateIds.add(template.getId());
    }
    if (swiftTemplateSyncLock.lock(3)) {
      try {
        List<VMTemplateHostVO> templtHostRefs=_tmpltHostDao.listByState(VMTemplateHostVO.Status.DOWNLOADED);
        List<VMTemplateSwiftVO> templtSwiftRefs=_tmpltSwiftDao.listAll();
        for (        VMTemplateHostVO templtHostRef : templtHostRefs) {
          if (!templateIds.contains(templtHostRef.getId())) {
            continue;
          }
          boolean found=false;
          for (          VMTemplateSwiftVO templtSwiftRef : templtSwiftRefs) {
            if (templtHostRef.getTemplateId() == templtSwiftRef.getTemplateId()) {
              found=true;
              break;
            }
          }
          if (!found) {
            try {
              uploadTemplateToSwiftFromSecondaryStorage(templtHostRef);
            }
 catch (            Exception e) {
              s_logger.debug("failed to upload template " + templtHostRef.getTemplateId() + " to Swift due to "+ e.toString());
            }
          }
        }
      }
 catch (      Throwable e) {
        s_logger.error("Problem with sync swift template due to " + e.toString(),e);
      }
 finally {
        swiftTemplateSyncLock.unlock();
      }
    }
  }
 catch (  Throwable e) {
    s_logger.error("Problem with sync swift template due to " + e.toString(),e);
  }
 finally {
    swiftTemplateSyncLock.releaseRef();
  }
}
