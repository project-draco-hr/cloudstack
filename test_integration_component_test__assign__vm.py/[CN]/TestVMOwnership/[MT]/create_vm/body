def create_vm(self, account, domain, isRunning=False, project=None, limit=None, pfrule=False, lbrule=None, natrule=None, volume=None, snapshot=False):
    self.debug(('Deploying instance in the account: %s' % account.name))
    self.virtual_machine = VirtualMachine.create(self.apiclient, self.services['virtual_machine'], accountid=account.name, domainid=domain.id, serviceofferingid=self.service_offering.id, mode=(self.zone.networktype if pfrule else 'basic'), projectid=(project.id if project else None))
    self.debug(('Deployed instance in account: %s' % account.name))
    list_virtual_machines(self.apiclient, id=self.virtual_machine.id)
    if snapshot:
        volumes = list_volumes(self.apiclient, virtualmachineid=self.virtual_machine.id, type='ROOT', listall=True)
        self.snapshot = Snapshot.create(self.apiclient, volumes[0].id, account=account.name, domainid=account.domainid)
    if volume:
        self.virtual_machine.attach_volume(self.apiclient, volume)
    if (not isRunning):
        self.virtual_machine.stop(self.apiclient)
    self.cleanup.append(self.virtual_machine)
