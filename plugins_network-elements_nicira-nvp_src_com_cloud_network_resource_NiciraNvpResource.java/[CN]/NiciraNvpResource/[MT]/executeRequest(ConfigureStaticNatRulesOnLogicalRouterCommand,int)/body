{
  try {
    NiciraNvpList<NatRule> existingRules=_niciraNvpApi.findNatRulesByLogicalRouterUuid(cmd.getLogicalRouterUuid());
    for (    StaticNatRuleTO rule : cmd.getRules()) {
      String insideIp=rule.getDstIp();
      String insideCidr=rule.getDstIp() + "/32";
      String outsideIp=rule.getSrcIp();
      String outsideCidr=rule.getSrcIp() + "/32";
      NatRule incoming=null;
      NatRule outgoing=null;
      for (      NatRule storedRule : existingRules.getResults()) {
        if ("SourceNatRule".equals(storedRule.getType())) {
          if (outsideIp.equals(storedRule.getToSourceIpAddressMin()) && outsideIp.equals(storedRule.getToSourceIpAddressMax()) && storedRule.getToSourcePortMin() == null) {
            outgoing=storedRule;
          }
        }
        if ("DestinationNatRule".equals(storedRule.getType()) && storedRule.getToDestinationPort() != null) {
          continue;
        }
        if (outsideIp.equals(storedRule.getMatch().getDestinationIpAddresses())) {
          incoming=storedRule;
        }
      }
      if (incoming != null && outgoing != null) {
        if (insideIp.equals(incoming.getToDestinationIpAddressMin())) {
          if (rule.revoked()) {
            s_logger.debug("Deleting incoming rule " + incoming.getUuid());
            _niciraNvpApi.deleteLogicalRouterNatRule(cmd.getLogicalRouterUuid(),incoming.getUuid());
            s_logger.debug("Deleting outgoing rule " + outgoing.getUuid());
            _niciraNvpApi.deleteLogicalRouterNatRule(cmd.getLogicalRouterUuid(),outgoing.getUuid());
          }
        }
 else {
          s_logger.debug("Updating outgoing rule " + outgoing.getUuid());
          outgoing.setToDestinationIpAddressMin(insideIp);
          outgoing.setToDestinationIpAddressMax(insideIp);
          _niciraNvpApi.modifyLogicalRouterNatRule(cmd.getLogicalRouterUuid(),outgoing);
          s_logger.debug("Updating incoming rule " + outgoing.getUuid());
          incoming.setToSourceIpAddressMin(insideIp);
          incoming.setToSourceIpAddressMax(insideIp);
          _niciraNvpApi.modifyLogicalRouterNatRule(cmd.getLogicalRouterUuid(),incoming);
          break;
        }
      }
 else {
        if (rule.revoked()) {
          s_logger.warn("Tried deleting a rule that does not exist, " + rule.getSrcIp() + " -> "+ rule.getDstIp());
          break;
        }
        Match m=new Match();
        m.setDestinationIpAddresses(outsideCidr);
        NatRule newDnatRule=new NatRule();
        newDnatRule.setType("DestinationNatRule");
        newDnatRule.setMatch(m);
        newDnatRule.setToDestinationIpAddressMin(insideIp);
        newDnatRule.setToDestinationIpAddressMax(insideIp);
        newDnatRule=_niciraNvpApi.createLogicalRouterNatRule(cmd.getLogicalRouterUuid(),newDnatRule);
        s_logger.debug("Created " + natRuleToString(newDnatRule));
        m=new Match();
        m.setSourceIpAddresses(insideIp + "/32");
        NatRule newSnatRule=new NatRule();
        newSnatRule.setType("SourceNatRule");
        newSnatRule.setMatch(m);
        newSnatRule.setToSourceIpAddressMin(outsideIp);
        newSnatRule.setToSourceIpAddressMax(outsideIp);
        newSnatRule=_niciraNvpApi.createLogicalRouterNatRule(cmd.getLogicalRouterUuid(),newSnatRule);
        s_logger.debug("Created " + natRuleToString(newSnatRule));
      }
    }
    return new ConfigureStaticNatRulesOnLogicalRouterAnswer(cmd,true,cmd.getRules().size() + " StaticNat rules applied");
  }
 catch (  NiciraNvpApiException e) {
    if (numRetries > 0) {
      return retry(cmd,--numRetries);
    }
 else {
      return new ConfigureStaticNatRulesOnLogicalRouterAnswer(cmd,e);
    }
  }
}
