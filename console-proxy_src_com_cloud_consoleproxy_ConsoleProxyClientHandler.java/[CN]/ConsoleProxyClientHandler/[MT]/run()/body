{
  try {
    String srcinfo=clientSocket.getInetAddress().getHostAddress() + ":" + clientSocket.getPort();
    clientIns=new DataInputStream(new BufferedInputStream(clientSocket.getInputStream()));
    clientOuts=clientSocket.getOutputStream();
    clientOuts.write("RFB 000.000\000".getBytes("US-ASCII"));
    clientOuts.flush();
    int b1=clientIns.read();
    int b2=clientIns.read();
    if (b1 != 'V' || b2 != 'M') {
      throw new Exception("Bad header");
    }
    byte[] proxyInfo=new byte[clientIns.read()];
    clientIns.readFully(proxyInfo);
    String proxyString=new String(proxyInfo,"US-ASCII");
    StringTokenizer stk=new StringTokenizer(proxyString,":\n");
    String host=stk.nextToken();
    int port=Integer.parseInt(stk.nextToken());
    String sid=stk.nextToken();
    ConsoleProxyViewer viewer=ConsoleProxy.getVncViewer(host,port,sid,"");
    ConsoleProxy.waitForViewerToStart(viewer);
    handleClientSession(viewer,srcinfo);
  }
 catch (  Exception ioe) {
    if (s_logger.isDebugEnabled())     s_logger.debug(ioe.toString());
  }
 finally {
    cleanup();
  }
}
