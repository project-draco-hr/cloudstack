{
  if (!_isEnabled) {
    return;
  }
  VirtualMachine.Type vmType=instance.getType();
  if (vmType != VirtualMachine.Type.User && vmType != VirtualMachine.Type.DomainRouter) {
    return;
  }
  try {
    long hostId=instance.getHostId();
    long accountId=instance.getAccountId();
    String tag=Long.toString(askVlanId(accountId,hostId));
    CheckAndUpdateDhcpFlow(instance);
    String vlans=getVlanInPortMapping(accountId,hostId);
    VmFlowLogVO log=_flowLogDao.findOrNewByVmId(instance.getId(),instance.getName());
    cmds.addCommand(new OvsSetTagAndFlowCommand(instance.getName(),tag,vlans,Long.toString(log.getLogsequence()),instance.getId()));
  }
 catch (  OvsVlanExhaustedException e) {
    e.printStackTrace();
  }
}
