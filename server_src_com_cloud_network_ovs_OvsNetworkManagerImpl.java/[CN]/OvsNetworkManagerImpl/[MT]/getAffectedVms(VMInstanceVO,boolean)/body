{
  long accountId=instance.getAccountId();
  if (!_vlanMappingDirtyDao.isDirty(accountId)) {
    s_logger.debug("OVSAFFECTED: no VM affected by " + instance.getName());
    return null;
  }
  Set<Long> affectedVms=new HashSet<Long>();
  List<UserVmVO> vms=_userVmDao.listByAccountId(accountId);
  for (  UserVmVO vm : vms) {
    affectedVms.add(new Long(vm.getId()));
  }
  if (tellRouter && instance.getType() != VirtualMachine.Type.DomainRouter) {
    DomainRouterVO router=_routerDao.findBy(accountId,instance.getDataCenterId());
    if (router != null) {
      affectedVms.add(new Long(router.getId()));
    }
  }
  return affectedVms;
}
