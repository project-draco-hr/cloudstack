{
  long accountId=instance.getAccountId();
  long hostId=instance.getHostId();
  final Transaction txn=Transaction.currentTxn();
  txn.start();
  VlanMappingVO vo=_vlanMappingDao.findByAccountIdAndHostId(accountId,hostId);
  if (vo.unref() == 0) {
    _vlanMappingDao.remove(vo.getId());
    _vlanMappingDirtyDao.markDirty(accountId);
    String s=String.format("%1$s is the last VM(host:%2$s, accountId:%3$s), remove vlan",instance.getName(),hostId,accountId);
    s_logger.debug("OVSDIRTY:" + s);
  }
 else {
    _vlanMappingDao.update(vo.getId(),vo);
    s_logger.debug(instance.getName() + " reduces reference count of (account,host) = (" + accountId+ ","+ hostId+ ") to "+ vo.getRef());
  }
  _flowLogDao.deleteByVmId(instance.getId());
  txn.commit();
  try {
    Commands cmds=new Commands(new OvsDeleteFlowCommand(instance.getName()));
    _agentMgr.send(hostId,cmds,_ovsListener);
  }
 catch (  Exception e) {
    e.printStackTrace();
  }
}
