{
  if (!_isEnabled) {
    return;
  }
  if (instance.getType() == VirtualMachine.Type.DomainRouter) {
    return;
  }
  long accountId=instance.getAccountId();
  DomainRouterVO router=_routerDao.findBy(accountId,instance.getDataCenterIdToDeployIn());
  if (router == null) {
    return;
  }
  if (!_vlanMappingDirtyDao.isDirty(accountId)) {
    return;
  }
  try {
    long hostId=router.getHostId();
    String tag=Long.toString(_vlanMappingDao.findByAccountIdAndHostId(accountId,hostId).getVlan());
    VmFlowLogVO log=_flowLogDao.findOrNewByVmId(instance.getId(),instance.getHostName());
    String vlans=getVlanInPortMapping(accountId,hostId);
    s_logger.debug("ask router " + router.getHostName() + " on host "+ hostId+ " update vlan map to "+ vlans);
    Commands cmds=new Commands(new OvsSetTagAndFlowCommand(router.getHostName(),tag,vlans,Long.toString(log.getLogsequence()),instance.getId()));
    _agentMgr.send(router.getHostId(),cmds,_ovsListener);
  }
 catch (  Exception e) {
    s_logger.warn("apply flow to router failed",e);
  }
}
