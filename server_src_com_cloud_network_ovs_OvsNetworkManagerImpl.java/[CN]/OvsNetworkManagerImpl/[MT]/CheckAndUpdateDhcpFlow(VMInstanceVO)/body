{
  if (!_isEnabled) {
    return;
  }
  if (instance.getType() == VirtualMachine.Type.DomainRouter) {
    return;
  }
  long accountId=instance.getAccountId();
  DomainRouterVO router=_routerDao.findBy(accountId,instance.getDataCenterId());
  if (router == null) {
    return;
  }
  if (!_vlanMappingDirtyDao.isDirty(accountId)) {
    return;
  }
  try {
    String vlans=getVlanMapping(accountId);
    String tag=Long.toString(_vlanMappingDao.findByAccountIdAndHostId(router.getAccountId(),router.getHostId()).getVlan());
    VmFlowLogVO log=_flowLogDao.findOrNewByVmId(instance.getId(),instance.getName());
    s_logger.debug("ask router " + router.getName() + " on host "+ router.getHostId()+ " update vlan map to "+ vlans);
    _agentMgr.send(router.getHostId(),new OvsSetTagAndFlowCommand(router.getName(),tag,vlans,Long.toString(log.getLogsequence()),instance.getId()));
  }
 catch (  Exception e) {
    e.printStackTrace();
  }
}
