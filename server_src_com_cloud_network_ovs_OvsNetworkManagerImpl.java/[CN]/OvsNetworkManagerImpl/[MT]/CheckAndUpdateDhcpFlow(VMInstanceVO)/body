{
  if (!_isEnabled) {
    return;
  }
  if (instance.getType() == VirtualMachine.Type.DomainRouter) {
    return;
  }
  long accountId=instance.getAccountId();
  DomainRouterVO router=_routerDao.findBy(accountId,instance.getDataCenterId());
  if (router == null) {
    return;
  }
  if (!_vlanMappingDirtyDao.isDirty(accountId)) {
    return;
  }
  try {
    String tag=Long.toString(_vlanMappingDao.findByAccountIdAndHostId(accountId,router.getHostId()).getVlan());
    long hostId=router.getHostId();
    VmFlowLogVO log=_flowLogDao.findOrNewByVmId(instance.getId(),instance.getName());
    String vlans=getVlanInPortMapping(accountId,hostId);
    s_logger.debug("ask router " + router.getName() + " on host "+ hostId+ " update vlan map to "+ vlans);
    Commands cmds=new Commands(new OvsSetTagAndFlowCommand(router.getName(),tag,vlans,Long.toString(log.getLogsequence()),instance.getId()));
    _agentMgr.send(router.getHostId(),cmds,_ovsListener);
  }
 catch (  Exception e) {
    e.printStackTrace();
  }
}
