{
  for (  Map.Entry<Long,VirtualMachine.PowerState> entry : translatedInfo.entrySet()) {
    if (s_logger.isDebugEnabled())     s_logger.debug("VM state report. host: " + hostId + ", vm id: "+ entry.getKey()+ ", power state: "+ entry.getValue());
    if (_instanceDao.updatePowerState(entry.getKey(),hostId,entry.getValue())) {
      if (s_logger.isDebugEnabled())       s_logger.debug("VM state report is updated. host: " + hostId + ", vm id: "+ entry.getKey()+ ", power state: "+ entry.getValue());
      _messageBus.publish(null,VirtualMachineManager.Topics.VM_POWER_STATE,PublishScope.GLOBAL,entry.getKey());
    }
 else {
      if (s_logger.isDebugEnabled())       s_logger.debug("VM power state does not change, skip DB writing. vm id: " + entry.getKey());
    }
  }
  List<VMInstanceVO> vmsThatAreMissingReport=_instanceDao.findByHostInStates(hostId,VirtualMachine.State.Running,VirtualMachine.State.Stopping);
  java.util.Iterator<VMInstanceVO> it=vmsThatAreMissingReport.iterator();
  while (it.hasNext()) {
    VMInstanceVO instance=it.next();
    if (translatedInfo.get(instance.getId()) != null)     it.remove();
  }
  if (vmsThatAreMissingReport.size() > 0) {
    for (    VMInstanceVO instance : vmsThatAreMissingReport) {
      if (_instanceDao.updatePowerState(instance.getId(),hostId,VirtualMachine.PowerState.PowerReportMissing)) {
        if (s_logger.isDebugEnabled())         s_logger.debug("VM state report is updated. host: " + hostId + ", vm id: "+ instance.getId()+ ", power state: PowerReportMissing ");
        _messageBus.publish(null,VirtualMachineManager.Topics.VM_POWER_STATE,PublishScope.GLOBAL,instance.getId());
      }
 else {
        if (s_logger.isDebugEnabled())         s_logger.debug("VM power state does not change, skip DB writing. vm id: " + instance.getId());
      }
    }
  }
}
