{
  UserContext caller=UserContext.current();
  LoadBalancerVO loadBalancerLock=null;
  LoadBalancerVO loadBalancer=_lbDao.findById(Long.valueOf(loadBalancerId));
  if (loadBalancer == null) {
    throw new InvalidParameterException("Invalid load balancer value: " + loadBalancerId);
  }
  _accountMgr.checkAccess(caller.getCaller(),loadBalancer);
  try {
    loadBalancerLock=_lbDao.acquireInLockTable(loadBalancerId);
    if (loadBalancerLock == null) {
      s_logger.warn("Failed to acquire lock to delete load balance rule id " + loadBalancerId);
      return false;
    }
    loadBalancer.setState(FirewallRule.State.Add);
    _lbDao.persist(loadBalancer);
    for (    long instanceId : instanceIds) {
      LoadBalancerVMMapVO map=_lb2VmMapDao.findByLoadBalancerIdAndVmId(loadBalancerId,instanceId);
      map.setRevoke(true);
      _lb2VmMapDao.persist(map);
      s_logger.debug("Set load balancer rule for revoke: rule id " + loadBalancerId + ", vmId "+ instanceId);
    }
    if (applyLoadBalancerConfig(loadBalancerId)) {
      _lb2VmMapDao.remove(loadBalancerId,instanceIds,null);
      s_logger.debug("Load balancer rule id " + loadBalancerId + " is removed for vms "+ instanceIds);
    }
 else {
      s_logger.warn("Failed to remove load balancer rule id " + loadBalancerId + " for vms "+ instanceIds);
      throw new CloudRuntimeException("Failed to remove load balancer rule id " + loadBalancerId + " for vms "+ instanceIds);
    }
  }
 catch (  ResourceUnavailableException e) {
    s_logger.warn("Unable to apply the load balancer config because resource is unavaliable.",e);
    return false;
  }
 finally {
    if (loadBalancerLock != null) {
      _lbDao.releaseFromLockTable(loadBalancerId);
    }
  }
  return true;
}
