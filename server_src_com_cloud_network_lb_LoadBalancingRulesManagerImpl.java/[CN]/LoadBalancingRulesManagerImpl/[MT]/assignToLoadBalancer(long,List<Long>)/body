{
  UserContext ctx=UserContext.current();
  Account caller=ctx.getCaller();
  LoadBalancerVO loadBalancer=_lbDao.findById(loadBalancerId);
  if (loadBalancer == null) {
    throw new InvalidParameterValueException("Failed to assign to load balancer " + loadBalancerId + ", the load balancer was not found.");
  }
  List<LoadBalancerVMMapVO> mappedInstances=_lb2VmMapDao.listByLoadBalancerId(loadBalancerId,false);
  Set<Long> mappedInstanceIds=new HashSet<Long>();
  for (  LoadBalancerVMMapVO mappedInstance : mappedInstances) {
    mappedInstanceIds.add(Long.valueOf(mappedInstance.getInstanceId()));
  }
  List<UserVm> vmsToAdd=new ArrayList<UserVm>();
  for (  Long instanceId : instanceIds) {
    if (mappedInstanceIds.contains(instanceId)) {
      throw new InvalidParameterValueException("VM " + instanceId + " is already mapped to load balancer.");
    }
    UserVm vm=_vmDao.findById(instanceId);
    if (vm == null || vm.getState() == State.Destroyed || vm.getState() == State.Expunging) {
      throw new InvalidParameterValueException("Invalid instance id: " + instanceId);
    }
    _rulesMgr.checkRuleAndUserVm(loadBalancer,vm,caller);
    if (vm.getAccountId() != loadBalancer.getAccountId()) {
      throw new PermissionDeniedException("Cannot add virtual machines that do not belong to the same owner.");
    }
    List<? extends Nic> nics=_networkMgr.getNics(vm.getId());
    Nic nicInSameNetwork=null;
    for (    Nic nic : nics) {
      if (nic.getNetworkId() == loadBalancer.getNetworkId()) {
        nicInSameNetwork=nic;
        break;
      }
    }
    if (nicInSameNetwork == null) {
      throw new InvalidParameterValueException("VM " + instanceId + " cannot be added because it doesn't belong in the same network.");
    }
    if (s_logger.isDebugEnabled()) {
      s_logger.debug("Adding " + vm + " to the load balancer pool");
    }
    vmsToAdd.add(vm);
  }
  Transaction txn=Transaction.currentTxn();
  txn.start();
  for (  UserVm vm : vmsToAdd) {
    LoadBalancerVMMapVO map=new LoadBalancerVMMapVO(loadBalancer.getId(),vm.getId(),false);
    map=_lb2VmMapDao.persist(map);
  }
  txn.commit();
  boolean success=false;
  try {
    loadBalancer.setState(FirewallRule.State.Add);
    _lbDao.persist(loadBalancer);
    applyLoadBalancerConfig(loadBalancerId);
    success=true;
  }
 catch (  ResourceUnavailableException e) {
    s_logger.warn("Unable to apply the load balancer config because resource is unavaliable.",e);
  }
  if (!success) {
    throw new CloudRuntimeException("Failed to add load balancer rule id " + loadBalancerId + " for vms "+ instanceIds);
  }
  return success;
}
