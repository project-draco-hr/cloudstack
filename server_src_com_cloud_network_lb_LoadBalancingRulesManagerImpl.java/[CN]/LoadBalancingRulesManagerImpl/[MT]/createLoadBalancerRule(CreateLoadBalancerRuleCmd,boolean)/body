{
  Account lbOwner=_accountMgr.getAccount(lb.getEntityOwnerId());
  int defPortStart=lb.getDefaultPortStart();
  int defPortEnd=lb.getDefaultPortEnd();
  if (!NetUtils.isValidPort(defPortEnd)) {
    throw new InvalidParameterValueException("privatePort is an invalid value: " + defPortEnd);
  }
  if (defPortStart > defPortEnd) {
    throw new InvalidParameterValueException("private port range is invalid: " + defPortStart + "-"+ defPortEnd);
  }
  if ((lb.getAlgorithm() == null) || !NetUtils.isValidAlgorithm(lb.getAlgorithm())) {
    throw new InvalidParameterValueException("Invalid algorithm: " + lb.getAlgorithm());
  }
  Long ipAddrId=lb.getSourceIpAddressId();
  IPAddressVO ipAddressVO=null;
  if (ipAddrId != null) {
    ipAddressVO=_ipAddressDao.findById(ipAddrId);
    if (ipAddressVO == null) {
      throw new InvalidParameterValueException("Unable to create load balance rule; ip id=" + ipAddrId + ""+ " doesn't exist in the system");
    }
 else     if (ipAddressVO.isOneToOneNat()) {
      throw new NetworkRuleConflictException("Can't do load balance on ip address: " + ipAddressVO.getAddress());
    }
  }
  LoadBalancer result=null;
  if (result == null) {
    IpAddress ip=null;
    Network guestNetwork=_networkMgr.getNetwork(lb.getNetworkId());
    NetworkOffering off=_configMgr.getNetworkOffering(guestNetwork.getNetworkOfferingId());
    if (off.getElasticLb() && ipAddressVO == null) {
      ip=_networkMgr.assignSystemIp(lb.getNetworkId(),lbOwner,true,false);
      lb.setSourceIpAddressId(ip.getId());
    }
    boolean performedIpAssoc=false;
    try {
      if (ipAddressVO != null) {
        if (ipAddressVO.getAssociatedWithNetworkId() == null) {
          ipAddressVO.setAssociatedWithNetworkId(lb.getNetworkId());
          _networkMgr.checkIpForService(ipAddressVO,Service.Lb);
          s_logger.debug("The ip is not associated with the network id=" + lb.getNetworkId() + " so assigning");
          ipAddressVO=_networkMgr.associateIPToGuestNetwork(ipAddrId,lb.getNetworkId());
          performedIpAssoc=true;
        }
 else {
          _networkMgr.checkIpForService(ipAddressVO,Service.Lb);
        }
      }
      if (lb.getSourceIpAddressId() == null) {
        throw new CloudRuntimeException("No ip address is defined to assign the LB to");
      }
      result=createLoadBalancer(lb,openFirewall);
    }
 catch (    Exception ex) {
      s_logger.warn("Failed to create load balancer due to ",ex);
      if (ex instanceof NetworkRuleConflictException) {
        throw (NetworkRuleConflictException)ex;
      }
    }
 finally {
      if (result == null && ip != null) {
        s_logger.debug("Releasing system IP address " + ip + " as corresponding lb rule failed to create");
        _networkMgr.handleSystemIpRelease(ip);
      }
      if (performedIpAssoc) {
        ip=_ipAddressDao.findById(ip.getId());
        if (ip != null && ip.getVpcId() != null && _firewallDao.listByIp(ip.getId()).isEmpty()) {
          s_logger.debug("Releasing VPC ip address " + ip + " as LB rule failed to create");
          _networkMgr.unassignIPFromVpcNetwork(ip.getId());
        }
      }
    }
  }
  if (result == null) {
    throw new CloudRuntimeException("Failed to create load balancer rule: " + lb.getName());
  }
  return result;
}
