{
  CiscoNexusVSMDeviceVO cisconexusvsm=_ciscoNexusVSMDeviceDao.findById(vsmId);
  if (cisconexusvsm == null) {
    return true;
  }
  List<ClusterVSMMapVO> clusterList=_clusterVSMDao.listByVSMId(vsmId);
  for (  ClusterVSMMapVO record : clusterList) {
    Long clusterId=record.getClusterId();
    List<HostVO> hosts=_resourceMgr.listAllHostsInCluster(clusterId);
    if (hosts != null && hosts.size() > 0) {
      throw new ResourceInUseException("Non-empty cluster with id" + clusterId + "still uses VSM. Please empty the cluster first");
    }
  }
  Transaction txn=Transaction.currentTxn();
  try {
    txn.start();
    for (    ClusterVSMMapVO record : clusterList) {
      _ciscoNexusVSMDeviceDao.remove(vsmId);
      _clusterVSMDao.removeByVsmId(vsmId);
    }
    txn.commit();
  }
 catch (  CloudRuntimeException e) {
    throw e;
  }
  return true;
}
