{
  s_logger.debug("External network stats collector is running...");
  for (  DataCenterVO zone : _dcDao.listAll()) {
    if (!_networkMgr.zoneIsConfiguredForExternalNetworking(zone.getId())) {
      s_logger.debug("Zone " + zone.getName() + " is not configured for external networking, so skipping usage check.");
      continue;
    }
    HostVO externalFirewall=getExternalNetworkAppliance(zone.getId(),Host.Type.ExternalFirewall);
    HostVO externalLoadBalancer=getExternalNetworkAppliance(zone.getId(),Host.Type.ExternalLoadBalancer);
    if (externalFirewall == null) {
      s_logger.debug("Skipping usage check for zone " + zone.getName());
      continue;
    }
    s_logger.debug("Collecting external network stats for zone " + zone.getName());
    ExternalNetworkResourceUsageCommand cmd=new ExternalNetworkResourceUsageCommand();
    ExternalNetworkResourceUsageAnswer firewallAnswer=(ExternalNetworkResourceUsageAnswer)_agentMgr.easySend(externalFirewall.getId(),cmd);
    if (firewallAnswer == null || !firewallAnswer.getResult()) {
      String details=(firewallAnswer != null) ? firewallAnswer.getDetails() : "details unavailable";
      String msg="Unable to get external firewall stats for " + zone.getName() + " due to: "+ details+ ".";
      s_logger.error(msg);
      continue;
    }
    ExternalNetworkResourceUsageAnswer lbAnswer=null;
    if (externalLoadBalancer != null) {
      lbAnswer=(ExternalNetworkResourceUsageAnswer)_agentMgr.easySend(externalLoadBalancer.getId(),cmd);
      if (lbAnswer == null || !lbAnswer.getResult()) {
        String details=(lbAnswer != null) ? lbAnswer.getDetails() : "details unavailable";
        String msg="Unable to get external load balancer stats for " + zone.getName() + " due to: "+ details+ ".";
        s_logger.error(msg);
      }
    }
    List<DomainRouterVO> domainRoutersInZone=_routerDao.listByDataCenter(zone.getId());
    for (    DomainRouterVO domainRouter : domainRoutersInZone) {
      long accountId=domainRouter.getAccountId();
      long zoneId=domainRouter.getDataCenterIdToDeployIn();
      AccountVO account=_accountDao.findById(accountId);
      if (account == null) {
        s_logger.debug("Skipping stats update for account with ID " + accountId);
        continue;
      }
      if (!manageStatsEntries(true,accountId,zoneId,externalFirewall,firewallAnswer,externalLoadBalancer,lbAnswer)) {
        continue;
      }
      manageStatsEntries(false,accountId,zoneId,externalFirewall,firewallAnswer,externalLoadBalancer,lbAnswer);
    }
  }
}
