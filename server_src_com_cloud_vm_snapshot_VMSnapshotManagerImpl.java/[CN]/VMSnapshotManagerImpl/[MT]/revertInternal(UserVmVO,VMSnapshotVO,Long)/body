{
  try {
    VMSnapshotVO snapshot=_vmSnapshotDao.findById(vmSnapshotVo.getId());
    List<VolumeTO> volumeTOs=getVolumeTOList(userVm.getId());
    String vmInstanceName=userVm.getInstanceName();
    VMSnapshotTO parent=getSnapshotWithParents(snapshot).getParent();
    VMSnapshotTO vmSnapshotTO=new VMSnapshotTO(snapshot.getId(),snapshot.getName(),snapshot.getType(),snapshot.getCreated().getTime(),snapshot.getDescription(),snapshot.getCurrent(),parent);
    GuestOSVO guestOS=_guestOSDao.findById(userVm.getGuestOSId());
    RevertToVMSnapshotCommand revertToSnapshotCommand=new RevertToVMSnapshotCommand(vmInstanceName,vmSnapshotTO,volumeTOs,guestOS.getDisplayName());
    RevertToVMSnapshotAnswer answer=(RevertToVMSnapshotAnswer)sendToPool(hostId,revertToSnapshotCommand);
    if (answer != null && answer.getResult()) {
      processAnswer(vmSnapshotVo,userVm,answer,hostId);
      s_logger.debug("RevertTo " + vmSnapshotVo.getName() + " succeeded for vm: "+ userVm.getInstanceName());
    }
 else {
      String errMsg="Revert VM: " + userVm.getInstanceName() + " to snapshot: "+ vmSnapshotVo.getName()+ " failed";
      if (answer != null && answer.getDetails() != null)       errMsg=errMsg + " due to " + answer.getDetails();
      s_logger.error(errMsg);
      vmSnapshotStateTransitTo(vmSnapshotVo,VMSnapshot.Event.OperationFailed);
      throw new CloudRuntimeException(errMsg);
    }
  }
 catch (  Exception e) {
    if (e instanceof AgentUnavailableException) {
      try {
        vmSnapshotStateTransitTo(vmSnapshotVo,VMSnapshot.Event.OperationFailed);
      }
 catch (      NoTransitionException e1) {
        s_logger.error("Cannot set vm snapshot state due to: " + e1.getMessage());
      }
    }
    String errMsg="revert vm: " + userVm.getInstanceName() + " to snapshot "+ vmSnapshotVo.getName()+ " failed due to "+ e.getMessage();
    s_logger.error(errMsg);
    throw new CloudRuntimeException(e.getMessage());
  }
  return userVm;
}
