{
  UserVmVO userVm=_userVMDao.findById(vmId);
  if (userVm == null) {
    throw new InvalidParameterValueException("Create vm to snapshot failed due to vm: " + vmId + " is not found");
  }
  VMSnapshotVO vmSnapshot=_vmSnapshotDao.findById(vmSnapshotId);
  if (vmSnapshot == null) {
    throw new CloudRuntimeException("VM snapshot id: " + vmSnapshotId + " can not be found");
  }
  Long hostId=pickRunningHost(vmId);
  try {
    vmSnapshotStateTransitTo(vmSnapshot,VMSnapshot.Event.CreateRequested);
  }
 catch (  NoTransitionException e) {
    throw new CloudRuntimeException(e.getMessage());
  }
  return createVmSnapshotInternal(userVm,vmSnapshot,hostId);
}
