{
  final Transaction txn=Transaction.currentTxn();
  try {
    txn.start();
    if (as instanceof CreateVMSnapshotAnswer) {
      CreateVMSnapshotAnswer answer=(CreateVMSnapshotAnswer)as;
      finalizeCreate(vmSnapshot,answer.getVolumeTOs());
      vmSnapshotStateTransitTo(vmSnapshot,VMSnapshot.Event.OperationSucceeded);
    }
 else     if (as instanceof RevertToVMSnapshotAnswer) {
      RevertToVMSnapshotAnswer answer=(RevertToVMSnapshotAnswer)as;
      finalizeRevert(vmSnapshot,answer.getVolumeTOs());
      vmSnapshotStateTransitTo(vmSnapshot,VMSnapshot.Event.OperationSucceeded);
    }
 else     if (as instanceof DeleteVMSnapshotAnswer) {
      DeleteVMSnapshotAnswer answer=(DeleteVMSnapshotAnswer)as;
      finalizeDelete(vmSnapshot,answer.getVolumeTOs());
      _vmSnapshotDao.remove(vmSnapshot.getId());
    }
    txn.commit();
  }
 catch (  Exception e) {
    String errMsg="Error while process answer: " + as.getClass() + " due to "+ e.getMessage();
    s_logger.error(errMsg,e);
    txn.rollback();
    throw new CloudRuntimeException(errMsg);
  }
 finally {
    txn.close();
  }
}
