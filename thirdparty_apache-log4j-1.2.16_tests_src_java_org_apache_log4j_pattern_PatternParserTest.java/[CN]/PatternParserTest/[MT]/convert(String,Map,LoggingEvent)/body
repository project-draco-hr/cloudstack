{
  List converters=new ArrayList();
  List fields=new ArrayList();
  PatternParser.parse(pattern,converters,fields,registry,PatternParser.getPatternLayoutRules());
  assertEquals(converters.size(),fields.size());
  StringBuffer buf=new StringBuffer();
  Iterator converterIter=converters.iterator();
  Iterator fieldIter=fields.iterator();
  while (converterIter.hasNext()) {
    int fieldStart=buf.length();
    ((PatternConverter)converterIter.next()).format(event,buf);
    ((FormattingInfo)fieldIter.next()).format(fieldStart,buf);
  }
  return buf.toString();
}
