{
  final StateMachine2<VirtualMachineTemplate.State,VirtualMachineTemplate.Event,VirtualMachineTemplate> stateMachine=VirtualMachineTemplate.State.getStateMachine();
  Transaction.execute(new TransactionCallbackNoReturn(){
    @Override public void doInTransactionWithoutResult(    TransactionStatus status){
      VMTemplateVO tmpTemplate=_templateDao.findById(template.getId());
      TemplateDataStoreVO tmpTemplateDataStore=_templateDataStoreDao.findById(templateDataStore.getId());
      try {
switch (answer.getStatus()) {
case COMPLETED:
          tmpTemplateDataStore.setDownloadState(VMTemplateStorageResourceAssoc.Status.DOWNLOADED);
        tmpTemplateDataStore.setState(State.Ready);
      stateMachine.transitTo(tmpTemplate,VirtualMachineTemplate.Event.OperationSucceeded,null,_templateDao);
    if (s_logger.isDebugEnabled()) {
      s_logger.debug("Template " + tmpTemplate.getUuid() + " uploaded successfully");
    }
  break;
case IN_PROGRESS:
if (tmpTemplate.getState() == VirtualMachineTemplate.State.NotUploaded) {
  tmpTemplateDataStore.setDownloadState(VMTemplateStorageResourceAssoc.Status.DOWNLOAD_IN_PROGRESS);
  stateMachine.transitTo(tmpTemplate,VirtualMachineTemplate.Event.UploadRequested,null,_templateDao);
}
 else if (tmpTemplate.getState() == VirtualMachineTemplate.State.UploadInProgress) {
  if (System.currentTimeMillis() - tmpTemplateDataStore.getCreated().getTime() > _uploadOperationTimeout) {
    tmpTemplateDataStore.setDownloadState(VMTemplateStorageResourceAssoc.Status.DOWNLOAD_ERROR);
    stateMachine.transitTo(tmpTemplate,VirtualMachineTemplate.Event.OperationFailed,null,_templateDao);
    if (s_logger.isDebugEnabled()) {
      s_logger.debug("Template " + tmpTemplate.getUuid() + " failed to upload due to operation timed out");
    }
  }
}
break;
case ERROR:
tmpTemplateDataStore.setDownloadState(VMTemplateStorageResourceAssoc.Status.DOWNLOAD_ERROR);
tmpTemplateDataStore.setState(State.Failed);
stateMachine.transitTo(tmpTemplate,VirtualMachineTemplate.Event.OperationFailed,null,_templateDao);
if (s_logger.isDebugEnabled()) {
s_logger.debug("Template " + tmpTemplate.getUuid() + " failed to upload. Error details: "+ answer.getDetails());
}
break;
case UNKNOWN:
if (tmpTemplate.getState() == VirtualMachineTemplate.State.NotUploaded) {
if (System.currentTimeMillis() - tmpTemplateDataStore.getCreated().getTime() > _uploadOperationTimeout) {
tmpTemplateDataStore.setDownloadState(VMTemplateStorageResourceAssoc.Status.ABANDONED);
tmpTemplateDataStore.setState(State.Failed);
stateMachine.transitTo(tmpTemplate,VirtualMachineTemplate.Event.OperationTimeout,null,_templateDao);
if (s_logger.isDebugEnabled()) {
s_logger.debug("Template " + tmpTemplate.getUuid() + " failed to upload due to operation timed out");
}
}
}
break;
}
_templateDataStoreDao.update(tmpTemplateDataStore.getId(),tmpTemplateDataStore);
}
 catch (NoTransitionException e) {
s_logger.error("Unexpected error " + e.getMessage());
}
}
}
);
}
