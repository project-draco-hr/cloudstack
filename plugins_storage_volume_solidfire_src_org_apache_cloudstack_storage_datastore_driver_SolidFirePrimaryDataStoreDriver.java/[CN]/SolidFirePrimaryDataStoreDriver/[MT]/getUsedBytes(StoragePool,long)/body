{
  long usedSpace=0;
  List<VolumeVO> lstVolumes=_volumeDao.findByPoolId(storagePool.getId(),null);
  if (lstVolumes != null) {
    for (    VolumeVO volume : lstVolumes) {
      if (volume.getId() == volumeIdToIgnore) {
        continue;
      }
      VolumeDetailVO volumeDetail=_volumeDetailsDao.findDetail(volume.getId(),SolidFireUtil.VOLUME_SIZE);
      if (volumeDetail != null && volumeDetail.getValue() != null) {
        long volumeSize=Long.parseLong(volumeDetail.getValue());
        usedSpace+=volumeSize;
      }
 else {
        SolidFireUtil.SolidFireConnection sfConnection=SolidFireUtil.getSolidFireConnection(storagePool.getId(),_storagePoolDetailsDao);
        try {
          long lVolumeId=Long.parseLong(volume.getFolder());
          SolidFireUtil.SolidFireVolume sfVolume=SolidFireUtil.getSolidFireVolume(sfConnection,lVolumeId);
          updateVolumeDetails(volume.getId(),sfVolume.getTotalSize());
        }
 catch (        NumberFormatException ex) {
        }
      }
    }
  }
  List<SnapshotVO> lstSnapshots=_snapshotDao.listAll();
  if (lstSnapshots != null) {
    for (    SnapshotVO snapshot : lstSnapshots) {
      SnapshotDetailsVO snapshotDetails=_snapshotDetailsDao.findDetail(snapshot.getId(),SolidFireUtil.STORAGE_POOL_ID);
      if (snapshotDetails != null && snapshotDetails.getValue() != null && Long.parseLong(snapshotDetails.getValue()) == storagePool.getId()) {
        snapshotDetails=_snapshotDetailsDao.findDetail(snapshot.getId(),SolidFireUtil.VOLUME_SIZE);
        if (snapshotDetails != null && snapshotDetails.getValue() != null) {
          long snapshotSize=Long.parseLong(snapshotDetails.getValue());
          usedSpace+=snapshotSize;
        }
      }
    }
  }
  return usedSpace;
}
