{
  CreateCmdResult result=null;
  try {
    VolumeInfo volumeInfo=snapshotInfo.getBaseVolume();
    VolumeVO volumeVO=_volumeDao.findById(volumeInfo.getId());
    long sfVolumeId=Long.parseLong(volumeVO.getFolder());
    long storagePoolId=volumeVO.getPoolId();
    SolidFireUtil.SolidFireConnection sfConnection=SolidFireUtil.getSolidFireConnection(storagePoolId,_storagePoolDetailsDao);
    SolidFireUtil.SolidFireVolume sfVolume=SolidFireUtil.getSolidFireVolume(sfConnection,sfVolumeId);
    StoragePoolVO storagePool=_storagePoolDao.findById(storagePoolId);
    long capacityBytes=storagePool.getCapacityBytes();
    long usedBytes=getUsedBytes(storagePool);
    long sfVolumeSize=sfVolume.getTotalSize();
    usedBytes+=sfVolumeSize;
    if (usedBytes > capacityBytes) {
      throw new CloudRuntimeException("Insufficient amount of space remains in this primary storage to take a snapshot");
    }
    storagePool.setUsedBytes(usedBytes);
    long sfNewVolumeId=SolidFireUtil.createSolidFireVolume(sfConnection,snapshotInfo.getUuid(),sfVolume.getAccountId(),sfVolumeSize,sfVolume.isEnable512e(),"",sfVolume.getMinIops(),sfVolume.getMaxIops(),sfVolume.getBurstIops());
    _storagePoolDao.update(storagePoolId,storagePool);
    SolidFireUtil.SolidFireVolume sfNewVolume=SolidFireUtil.getSolidFireVolume(sfConnection,sfNewVolumeId);
    updateSnapshotDetails(snapshotInfo.getId(),sfNewVolumeId,storagePoolId,sfVolumeSize,sfNewVolume.getIqn());
    SnapshotObjectTO snapshotObjectTo=(SnapshotObjectTO)snapshotInfo.getTO();
    snapshotObjectTo.setPath(String.valueOf(sfNewVolumeId));
    CreateObjectAnswer createObjectAnswer=new CreateObjectAnswer(snapshotObjectTo);
    result=new CreateCmdResult(null,createObjectAnswer);
    result.setResult(null);
  }
 catch (  Exception ex) {
    s_logger.debug(SolidFireUtil.LOG_PREFIX + "Failed to take CloudStack snapshot: " + snapshotInfo.getId(),ex);
    result=new CreateCmdResult(null,new CreateObjectAnswer(ex.toString()));
    result.setResult(ex.toString());
  }
  callback.complete(result);
}
