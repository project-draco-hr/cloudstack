{
  final Connection connection=getConnection();
  final VirtualMachineTO vmSpec=cmd.getVirtualMachine();
  try {
    final Host host=Host.getByUuid(connection,_host.getUuid());
    final Set<VM> vms=VM.getByNameLabel(connection,vmSpec.getName());
    final VM migratedVm=vms.iterator().next();
    if (migratedVm == null) {
      throw new CloudRuntimeException("Couldn't find the migrated vm " + vmSpec.getName() + " on the destination host.");
    }
    final List<VolumeObjectTO> volumeToSet=getUpdatedVolumePathsOfMigratedVm(connection,migratedVm,vmSpec.getDisks());
    migratedVm.setAffinity(connection,host);
    return new MigrateWithStorageCompleteAnswer(cmd,volumeToSet);
  }
 catch (  final CloudRuntimeException e) {
    s_logger.error("Migration of vm " + vmSpec.getName() + " with storage failed due to "+ e.toString(),e);
    return new MigrateWithStorageCompleteAnswer(cmd,e);
  }
catch (  final Exception e) {
    s_logger.error("Migration of vm " + vmSpec.getName() + " with storage failed due to "+ e.toString(),e);
    return new MigrateWithStorageCompleteAnswer(cmd,e);
  }
}
