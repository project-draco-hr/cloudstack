{
  List<VirtualDevice> devices=_context.getVimClient().getDynamicProperty(_mor,"config.hardware.device");
  List<Integer> existingUnitNumbers=new ArrayList<Integer>();
  int deviceNumber=0;
  int scsiControllerKey=getGenericScsiDeviceControllerKeyNoException();
  if (devices != null && devices.size() > 0) {
    for (    VirtualDevice device : devices) {
      if (device.getControllerKey() != null && device.getControllerKey().intValue() == controllerKey) {
        existingUnitNumbers.add(device.getUnitNumber());
      }
    }
  }
  while (true) {
    if (!existingUnitNumbers.contains(Integer.valueOf(deviceNumber))) {
      if (controllerKey != scsiControllerKey || !VmwareHelper.isReservedScsiDeviceNumber(deviceNumber))       break;
    }
    ++deviceNumber;
  }
  return deviceNumber;
}
