{
  Transaction txn=Transaction.open(Transaction.SIMULATOR_DB);
  MockSecStorageVO storage=null;
  try {
    txn.start();
    storage=_mockSecStorageDao.findByUrl(url);
    txn.commit();
  }
 catch (  Exception ex) {
    txn.rollback();
    throw new CloudRuntimeException("Unable to find sec storage at " + url,ex);
  }
 finally {
    txn.close();
    txn=Transaction.open(Transaction.CLOUD_DB);
    txn.close();
  }
  if (storage == null) {
    storage=new MockSecStorageVO();
    URI uri;
    try {
      uri=new URI(url);
    }
 catch (    URISyntaxException e) {
      return;
    }
    String nfsHost=uri.getHost();
    String nfsPath=uri.getPath();
    String path=nfsHost + ":" + nfsPath;
    String dir="/mnt/" + UUID.nameUUIDFromBytes(path.getBytes()).toString() + File.separator;
    storage.setUrl(url);
    storage.setCapacity(DEFAULT_HOST_STORAGE_SIZE);
    storage.setMountPoint(dir);
    txn=Transaction.open(Transaction.SIMULATOR_DB);
    try {
      txn.start();
      storage=_mockSecStorageDao.persist(storage);
      txn.commit();
    }
 catch (    Exception ex) {
      txn.rollback();
      throw new CloudRuntimeException("Error when saving storage " + storage,ex);
    }
 finally {
      txn.close();
      txn=Transaction.open(Transaction.CLOUD_DB);
      txn.close();
    }
    long defaultTemplateSize=2 * 1024 * 1024* 1024L;
    MockVolumeVO template=new MockVolumeVO();
    template.setName("simulator-domR");
    template.setPath(storage.getMountPoint() + "template/tmpl/1/9/" + UUID.randomUUID().toString());
    template.setPoolId(storage.getId());
    template.setSize(defaultTemplateSize);
    template.setType(MockVolumeType.TEMPLATE);
    template.setStatus(Status.DOWNLOADED);
    txn=Transaction.open(Transaction.SIMULATOR_DB);
    try {
      txn.start();
      template=_mockVolumeDao.persist(template);
      txn.commit();
    }
 catch (    Exception ex) {
      txn.rollback();
      throw new CloudRuntimeException("Error when saving template " + template,ex);
    }
 finally {
      txn.close();
      txn=Transaction.open(Transaction.CLOUD_DB);
      txn.close();
    }
    template=new MockVolumeVO();
    template.setName("simulator-Centos");
    template.setPath(storage.getMountPoint() + "template/tmpl/1/10/" + UUID.randomUUID().toString());
    template.setPoolId(storage.getId());
    template.setSize(defaultTemplateSize);
    template.setType(MockVolumeType.TEMPLATE);
    template.setStatus(Status.DOWNLOADED);
    txn=Transaction.open(Transaction.SIMULATOR_DB);
    try {
      txn.start();
      template=_mockVolumeDao.persist(template);
      txn.commit();
    }
 catch (    Exception ex) {
      txn.rollback();
      throw new CloudRuntimeException("Error when saving template " + template,ex);
    }
 finally {
      txn.close();
      txn=Transaction.open(Transaction.CLOUD_DB);
      txn.close();
    }
  }
}
