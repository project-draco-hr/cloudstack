{
  DataStoreTO store=cmd.getDataStore();
  if (!(store instanceof NfsTO)) {
    return new Answer(cmd,false,"Unsupported image data store: " + store);
  }
  Transaction txn=Transaction.open(Transaction.SIMULATOR_DB);
  MockSecStorageVO storage=null;
  String nfsUrl=((NfsTO)cmd.getDataStore()).getUrl();
  try {
    txn.start();
    storage=_mockSecStorageDao.findByUrl(nfsUrl);
    if (storage == null) {
      return new Answer(cmd,false,"Failed to get secondary storage");
    }
    txn.commit();
  }
 catch (  Exception ex) {
    txn.rollback();
    throw new CloudRuntimeException("Error when finding sec storage " + nfsUrl,ex);
  }
 finally {
    txn.close();
    txn=Transaction.open(Transaction.CLOUD_DB);
    txn.close();
  }
  txn=Transaction.open(Transaction.SIMULATOR_DB);
  try {
    txn.start();
    List<MockVolumeVO> templates=_mockVolumeDao.findByStorageIdAndType(storage.getId(),MockVolumeType.TEMPLATE);
    Map<String,TemplateProp> templateInfos=new HashMap<String,TemplateProp>();
    for (    MockVolumeVO template : templates) {
      templateInfos.put(template.getName(),new TemplateProp(template.getName(),template.getPath().replaceAll(storage.getMountPoint(),""),template.getSize(),template.getSize(),true,false));
    }
    txn.commit();
    return new ListTemplateAnswer(nfsUrl,templateInfos);
  }
 catch (  Exception ex) {
    txn.rollback();
    throw new CloudRuntimeException("Error when finding template on sec storage " + storage.getId(),ex);
  }
 finally {
    txn.close();
    txn=Transaction.open(Transaction.CLOUD_DB);
    txn.close();
  }
}
