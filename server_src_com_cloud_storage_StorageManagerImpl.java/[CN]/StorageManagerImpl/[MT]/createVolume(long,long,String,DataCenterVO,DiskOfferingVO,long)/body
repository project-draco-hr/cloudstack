{
  String volumeName="";
  VolumeVO createdVolume=null;
  try {
    volumeName=getRandomVolumeName();
    Account account=_accountDao.findById(accountId);
    VolumeVO volume=new VolumeVO(null,userSpecifiedName,-1,-1,-1,-1,new Long(-1),null,null,0,Volume.VolumeType.DATADISK);
    volume.setPoolId(null);
    volume.setDataCenterId(dc.getId());
    volume.setPodId(null);
    volume.setAccountId(accountId);
    volume.setDomainId(account.getDomainId().longValue());
    volume.setMirrorState(MirrorState.NOT_MIRRORED);
    volume.setDiskOfferingId(diskOffering.getId());
    volume.setStorageResourceType(StorageResourceType.STORAGE_POOL);
    volume.setInstanceId(null);
    volume.setUpdated(new Date());
    volume.setStatus(AsyncInstanceCreateStatus.Creating);
    volume.setDomainId(account.getDomainId().longValue());
    volume=_volsDao.persist(volume);
    AsyncJobExecutor asyncExecutor=BaseAsyncJobExecutor.getCurrentExecutor();
    if (asyncExecutor != null) {
      AsyncJobVO job=asyncExecutor.getJob();
      if (s_logger.isInfoEnabled())       s_logger.info("CreateVolume created a new instance " + volume.getId() + ", update async job-"+ job.getId()+ " progress status");
      _asyncMgr.updateAsyncJobAttachment(job.getId(),"volume",volume.getId());
      _asyncMgr.updateAsyncJobStatus(job.getId(),BaseCmd.PROGRESS_INSTANCE_CREATED,volume.getId());
    }
    List<StoragePoolVO> poolsToAvoid=new ArrayList<StoragePoolVO>();
    Set<Long> podsToAvoid=new HashSet<Long>();
    Pair<HostPodVO,Long> pod=null;
    while ((pod=_agentMgr.findPod(null,null,dc,account.getId(),podsToAvoid)) != null) {
      if ((createdVolume=createVolume(volume,null,null,dc,pod.first(),null,null,diskOffering,poolsToAvoid)) != null) {
        break;
      }
 else {
        podsToAvoid.add(pod.first().getId());
      }
    }
    EventVO event=new EventVO();
    event.setAccountId(accountId);
    event.setUserId(userId);
    event.setType(EventTypes.EVENT_VOLUME_CREATE);
    event.setStartId(startEventId);
    Transaction txn=Transaction.currentTxn();
    txn.start();
    if (createdVolume != null) {
      _accountMgr.incrementResourceCount(accountId,ResourceType.volume);
      long sizeMB=createdVolume.getSize() / (1024 * 1024);
      StoragePoolVO pool=_storagePoolDao.findById(createdVolume.getPoolId());
      String eventParams="id=" + createdVolume.getId() + "\ndoId="+ diskOffering.getId()+ "\ntId="+ -1+ "\ndcId="+ dc.getId()+ "\nsize="+ sizeMB;
      event.setLevel(EventVO.LEVEL_INFO);
      event.setDescription("Created volume: " + createdVolume.getName() + " with size: "+ sizeMB+ " MB in pool: "+ pool.getName());
      event.setParameters(eventParams);
      _eventDao.persist(event);
    }
 else {
      volume.setStatus(AsyncInstanceCreateStatus.Corrupted);
      volume.setDestroyed(true);
      _volsDao.update(volume.getId(),volume);
    }
    txn.commit();
  }
 catch (  Exception e) {
    s_logger.error("Unhandled exception while saving volume " + volumeName,e);
  }
  return createdVolume;
}
