{
  VolumeVO createdVolume=null;
  SnapshotVO snapshot=_snapshotDao.findById(snapshotId);
  Long origVolumeId=snapshot.getVolumeId();
  VolumeVO originalVolume=_volsDao.findById(origVolumeId);
  VMTemplateVO template=null;
  if (originalVolume != null) {
    template=_templateDao.findById(originalVolume.getTemplateId());
  }
  Pair<VolumeVO,String> volumeDetails=createVolumeFromSnapshot(volume,snapshot,template,originalVolume.getSize());
  createdVolume=volumeDetails.first();
  Transaction txn=Transaction.currentTxn();
  txn.start();
  long templateId=-1;
  long diskOfferingId=-1;
  if (originalVolume.getTemplateId() != null) {
    templateId=originalVolume.getTemplateId();
  }
  diskOfferingId=originalVolume.getDiskOfferingId();
  long sizeMB=createdVolume.getSize() / (1024 * 1024);
  if (createdVolume.getPath() != null) {
    UsageEventVO usageEvent=new UsageEventVO(EventTypes.EVENT_VOLUME_CREATE,volume.getAccountId(),volume.getDataCenterId(),volume.getId(),volume.getName(),diskOfferingId,templateId,sizeMB);
    _usageEventDao.persist(usageEvent);
  }
  txn.commit();
  return createdVolume;
}
