{
  Long userId=UserContext.current().getCallerUserId();
  User user=_userDao.findById(userId);
  Account account=UserContext.current().getCaller();
  boolean restart=true;
  StoragePoolVO primaryStorage=null;
  primaryStorage=_storagePoolDao.findById(primaryStorageId);
  if (primaryStorage == null) {
    String msg="Unable to obtain lock on the storage pool record in preparePrimaryStorageForMaintenance()";
    s_logger.error(msg);
    throw new InvalidParameterValueException(msg);
  }
  List<StoragePoolVO> spes=_storagePoolDao.listBy(primaryStorage.getDataCenterId(),primaryStorage.getPodId(),primaryStorage.getClusterId(),ScopeType.CLUSTER);
  for (  StoragePoolVO sp : spes) {
    if (sp.getStatus() == StoragePoolStatus.PrepareForMaintenance) {
      throw new CloudRuntimeException("Only one storage pool in a cluster can be in PrepareForMaintenance mode, " + sp.getId() + " is already in  PrepareForMaintenance mode ");
    }
  }
  if (!primaryStorage.getStatus().equals(DataStoreStatus.Up) && !primaryStorage.getStatus().equals(DataStoreStatus.ErrorInMaintenance)) {
    throw new InvalidParameterValueException("Primary storage with id " + primaryStorageId + " is not ready for migration, as the status is:"+ primaryStorage.getStatus().toString());
  }
  DataStoreProvider provider=dataStoreProviderMgr.getDataStoreProvider(primaryStorage.getStorageProviderName());
  DataStoreLifeCycle lifeCycle=provider.getDataStoreLifeCycle();
  DataStore store=dataStoreMgr.getDataStore(primaryStorage.getId(),DataStoreRole.Primary);
  lifeCycle.maintain(store);
  return (PrimaryDataStoreInfo)dataStoreMgr.getDataStore(primaryStorage.getId(),DataStoreRole.Primary);
}
