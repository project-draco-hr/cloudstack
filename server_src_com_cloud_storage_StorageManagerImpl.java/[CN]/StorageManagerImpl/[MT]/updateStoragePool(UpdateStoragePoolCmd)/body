{
  Long id=cmd.getId();
  List<String> tags=cmd.getTags();
  StoragePoolVO pool=_storagePoolDao.findById(id);
  if (pool == null) {
    throw new IllegalArgumentException("Unable to find storage pool with ID: " + id);
  }
  if (tags != null) {
    Map<String,String> existingDetails=_storagePoolDetailsDao.getDetails(id);
    Set<String> existingKeys=existingDetails.keySet();
    Map<String,String> existingDetailsToKeep=new HashMap<String,String>();
    for (    String existingKey : existingKeys) {
      String existingValue=existingDetails.get(existingKey);
      if (!Boolean.TRUE.toString().equalsIgnoreCase(existingValue)) {
        existingDetailsToKeep.put(existingKey,existingValue);
      }
    }
    Map<String,String> details=new HashMap<String,String>();
    for (    String tag : tags) {
      tag=tag.trim();
      if (tag.length() > 0 && !details.containsKey(tag)) {
        details.put(tag,"true");
      }
    }
    Set<String> existingKeysToKeep=existingDetailsToKeep.keySet();
    for (    String existingKeyToKeep : existingKeysToKeep) {
      String existingValueToKeep=existingDetailsToKeep.get(existingKeyToKeep);
      if (details.containsKey(existingKeyToKeep)) {
        throw new CloudRuntimeException("Storage tag '" + existingKeyToKeep + "' conflicts with a stored property of this primary storage. No changes were made.");
      }
      details.put(existingKeyToKeep,existingValueToKeep);
    }
    _storagePoolDao.updateDetails(id,details);
  }
  return (PrimaryDataStoreInfo)dataStoreMgr.getDataStore(pool.getId(),DataStoreRole.Primary);
}
