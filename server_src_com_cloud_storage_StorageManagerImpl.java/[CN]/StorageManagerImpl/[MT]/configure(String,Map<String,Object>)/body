{
  Map<String,String> configs=_configDao.getConfiguration("management-server",params);
  _retry=NumbersUtil.parseInt(configs.get(Config.StartRetry.key()),10);
  _pingInterval=NumbersUtil.parseInt(configs.get("ping.interval"),60);
  _hostRetry=NumbersUtil.parseInt(configs.get("host.retry"),2);
  _storagePoolAcquisitionWaitSeconds=NumbersUtil.parseInt(configs.get("pool.acquisition.wait.seconds"),1800);
  s_logger.info("pool.acquisition.wait.seconds is configured as " + _storagePoolAcquisitionWaitSeconds + " seconds");
  _agentMgr.registerForHostEvents(new StoragePoolMonitor(this,_storagePoolDao),true,false,true);
  String storageCleanupEnabled=configs.get("storage.cleanup.enabled");
  _storageCleanupEnabled=(storageCleanupEnabled == null) ? true : Boolean.parseBoolean(storageCleanupEnabled);
  String value=_configDao.getValue(Config.CreateVolumeFromSnapshotWait.toString());
  _createVolumeFromSnapshotWait=NumbersUtil.parseInt(value,Integer.parseInt(Config.CreateVolumeFromSnapshotWait.getDefaultValue()));
  value=_configDao.getValue(Config.CopyVolumeWait.toString());
  _copyvolumewait=NumbersUtil.parseInt(value,Integer.parseInt(Config.CopyVolumeWait.getDefaultValue()));
  value=_configDao.getValue(Config.RecreateSystemVmEnabled.key());
  _recreateSystemVmEnabled=Boolean.parseBoolean(value);
  value=_configDao.getValue(Config.StorageTemplateCleanupEnabled.key());
  _templateCleanupEnabled=(value == null ? true : Boolean.parseBoolean(value));
  String time=configs.get("storage.cleanup.interval");
  _storageCleanupInterval=NumbersUtil.parseInt(time,86400);
  s_logger.info("Storage cleanup enabled: " + _storageCleanupEnabled + ", interval: "+ _storageCleanupInterval+ ", template cleanup enabled: "+ _templateCleanupEnabled);
  String workers=configs.get("expunge.workers");
  int wrks=NumbersUtil.parseInt(workers,10);
  _executor=Executors.newScheduledThreadPool(wrks,new NamedThreadFactory("StorageManager-Scavenger"));
  _agentMgr.registerForHostEvents(ComponentContext.inject(LocalStoragePoolListener.class),true,false,false);
  String maxVolumeSizeInGbString=_configDao.getValue("storage.max.volume.size");
  _maxVolumeSizeInGb=NumbersUtil.parseLong(maxVolumeSizeInGbString,2000);
  String _customDiskOfferingMinSizeStr=_configDao.getValue(Config.CustomDiskOfferingMinSize.toString());
  _customDiskOfferingMinSize=NumbersUtil.parseInt(_customDiskOfferingMinSizeStr,Integer.parseInt(Config.CustomDiskOfferingMinSize.getDefaultValue()));
  String _customDiskOfferingMaxSizeStr=_configDao.getValue(Config.CustomDiskOfferingMaxSize.toString());
  _customDiskOfferingMaxSize=NumbersUtil.parseInt(_customDiskOfferingMaxSizeStr,Integer.parseInt(Config.CustomDiskOfferingMaxSize.getDefaultValue()));
  _serverId=_msServer.getId();
  UpHostsInPoolSearch=_storagePoolHostDao.createSearchBuilder(Long.class);
  UpHostsInPoolSearch.selectField(UpHostsInPoolSearch.entity().getHostId());
  SearchBuilder<HostVO> hostSearch=_hostDao.createSearchBuilder();
  hostSearch.and("status",hostSearch.entity().getStatus(),Op.EQ);
  hostSearch.and("resourceState",hostSearch.entity().getResourceState(),Op.EQ);
  UpHostsInPoolSearch.join("hosts",hostSearch,hostSearch.entity().getId(),UpHostsInPoolSearch.entity().getHostId(),JoinType.INNER);
  UpHostsInPoolSearch.and("pool",UpHostsInPoolSearch.entity().getPoolId(),Op.EQ);
  UpHostsInPoolSearch.done();
  StoragePoolSearch=_vmInstanceDao.createSearchBuilder();
  SearchBuilder<VolumeVO> volumeSearch=_volumeDao.createSearchBuilder();
  volumeSearch.and("volumeType",volumeSearch.entity().getVolumeType(),SearchCriteria.Op.EQ);
  volumeSearch.and("poolId",volumeSearch.entity().getPoolId(),SearchCriteria.Op.EQ);
  StoragePoolSearch.join("vmVolume",volumeSearch,volumeSearch.entity().getInstanceId(),StoragePoolSearch.entity().getId(),JoinBuilder.JoinType.INNER);
  StoragePoolSearch.done();
  LocalStorageSearch=_storagePoolDao.createSearchBuilder();
  SearchBuilder<StoragePoolHostVO> storageHostSearch=_storagePoolHostDao.createSearchBuilder();
  storageHostSearch.and("hostId",storageHostSearch.entity().getHostId(),SearchCriteria.Op.EQ);
  LocalStorageSearch.join("poolHost",storageHostSearch,storageHostSearch.entity().getPoolId(),LocalStorageSearch.entity().getId(),JoinBuilder.JoinType.INNER);
  LocalStorageSearch.and("type",LocalStorageSearch.entity().getPoolType(),SearchCriteria.Op.IN);
  LocalStorageSearch.done();
  Volume.State.getStateMachine().registerListener(new VolumeStateListener());
  return true;
}
