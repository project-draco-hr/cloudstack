{
  Map<String,String> configs=_configDao.getConfiguration("management-server",params);
  _storagePoolAcquisitionWaitSeconds=NumbersUtil.parseInt(configs.get("pool.acquisition.wait.seconds"),1800);
  s_logger.info("pool.acquisition.wait.seconds is configured as " + _storagePoolAcquisitionWaitSeconds + " seconds");
  _agentMgr.registerForHostEvents(new StoragePoolMonitor(this,_storagePoolDao),true,false,true);
  String storageCleanupEnabled=configs.get("storage.cleanup.enabled");
  _storageCleanupEnabled=(storageCleanupEnabled == null) ? true : Boolean.parseBoolean(storageCleanupEnabled);
  String value=_configDao.getValue(Config.StorageTemplateCleanupEnabled.key());
  _templateCleanupEnabled=(value == null ? true : Boolean.parseBoolean(value));
  String time=configs.get("storage.cleanup.interval");
  _storageCleanupInterval=NumbersUtil.parseInt(time,86400);
  s_logger.info("Storage cleanup enabled: " + _storageCleanupEnabled + ", interval: "+ _storageCleanupInterval+ ", template cleanup enabled: "+ _templateCleanupEnabled);
  String cleanupInterval=configs.get("extract.url.cleanup.interval");
  _downloadUrlCleanupInterval=NumbersUtil.parseInt(cleanupInterval,7200);
  String urlExpirationInterval=configs.get("extract.url.expiration.interval");
  _downloadUrlExpirationInterval=NumbersUtil.parseInt(urlExpirationInterval,14400);
  String workers=configs.get("expunge.workers");
  int wrks=NumbersUtil.parseInt(workers,10);
  _executor=Executors.newScheduledThreadPool(wrks,new NamedThreadFactory("StorageManager-Scavenger"));
  _agentMgr.registerForHostEvents(ComponentContext.inject(LocalStoragePoolListener.class),true,false,false);
  _serverId=_msServer.getId();
  UpHostsInPoolSearch=_storagePoolHostDao.createSearchBuilder(Long.class);
  UpHostsInPoolSearch.selectFields(UpHostsInPoolSearch.entity().getHostId());
  SearchBuilder<HostVO> hostSearch=_hostDao.createSearchBuilder();
  hostSearch.and("status",hostSearch.entity().getStatus(),Op.EQ);
  hostSearch.and("resourceState",hostSearch.entity().getResourceState(),Op.EQ);
  UpHostsInPoolSearch.join("hosts",hostSearch,hostSearch.entity().getId(),UpHostsInPoolSearch.entity().getHostId(),JoinType.INNER);
  UpHostsInPoolSearch.and("pool",UpHostsInPoolSearch.entity().getPoolId(),Op.EQ);
  UpHostsInPoolSearch.done();
  StoragePoolSearch=_vmInstanceDao.createSearchBuilder();
  SearchBuilder<VolumeVO> volumeSearch=_volumeDao.createSearchBuilder();
  volumeSearch.and("volumeType",volumeSearch.entity().getVolumeType(),SearchCriteria.Op.EQ);
  volumeSearch.and("poolId",volumeSearch.entity().getPoolId(),SearchCriteria.Op.EQ);
  volumeSearch.and("state",volumeSearch.entity().getState(),SearchCriteria.Op.EQ);
  StoragePoolSearch.join("vmVolume",volumeSearch,volumeSearch.entity().getInstanceId(),StoragePoolSearch.entity().getId(),JoinBuilder.JoinType.INNER);
  StoragePoolSearch.done();
  LocalStorageSearch=_storagePoolDao.createSearchBuilder();
  SearchBuilder<StoragePoolHostVO> storageHostSearch=_storagePoolHostDao.createSearchBuilder();
  storageHostSearch.and("hostId",storageHostSearch.entity().getHostId(),SearchCriteria.Op.EQ);
  LocalStorageSearch.join("poolHost",storageHostSearch,storageHostSearch.entity().getPoolId(),LocalStorageSearch.entity().getId(),JoinBuilder.JoinType.INNER);
  LocalStorageSearch.and("type",LocalStorageSearch.entity().getPoolType(),SearchCriteria.Op.IN);
  LocalStorageSearch.done();
  Volume.State.getStateMachine().registerListener(new VolumeStateListener(_configDao));
  return true;
}
