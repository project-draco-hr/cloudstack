{
  boolean destroyVolumes=false;
  long count=1;
  long consoleProxyId=0;
  long ssvmId=0;
  try {
    StoragePoolVO primaryStorage=_storagePoolDao.findById(primaryStorageId);
    if (primaryStorage == null) {
      s_logger.warn("The primary storage does not exist");
      return false;
    }
    count=_storagePoolDao.countBy(primaryStorage.getId(),Status.Up);
    if (count > 1) {
      destroyVolumes=true;
    }
    List<VolumeVO> allVolumes=_volsDao.findByPoolId(primaryStorageId);
    List<VolumeVO> markedVolumes=new ArrayList<VolumeVO>();
    for (    VolumeVO volume : allVolumes) {
      VMInstanceVO vmInstance=_vmInstanceDao.findById(volume.getInstanceId());
      if (vmInstance.getState().equals(State.Running) || vmInstance.getState().equals(State.Stopped) || vmInstance.getState().equals(State.Stopping)|| vmInstance.getState().equals(State.Starting)) {
        if (vmInstance.getType().equals(VirtualMachine.Type.ConsoleProxy)) {
          if (destroyVolumes)           markedVolumes.add(volume);
          _configMgr.updateConfiguration(userId,"consoleproxy.restart","false");
          long eventId=saveScheduledEvent(User.UID_SYSTEM,Account.ACCOUNT_ID_SYSTEM,EventTypes.EVENT_PROXY_STOP,"stopping console proxy with Id: " + vmInstance.getId());
          if (!_consoleProxyMgr.stopProxy(vmInstance.getId(),eventId)) {
            s_logger.warn("There was an error stopping the console proxy id: " + vmInstance.getId() + " ,cannot enable storage maintenance");
            primaryStorage.setStatus(Status.ErrorInMaintenance);
            _storagePoolDao.persist(primaryStorage);
            return false;
          }
 else {
            if (destroyVolumes) {
              consoleProxyId=vmInstance.getId();
            }
          }
        }
        if (vmInstance.getType().equals(VirtualMachine.Type.User)) {
          long eventId=saveScheduledEvent(User.UID_SYSTEM,Account.ACCOUNT_ID_SYSTEM,EventTypes.EVENT_VM_STOP,"stopping user vm with Id: " + vmInstance.getId());
          if (!_userVmMgr.stopVirtualMachine(userId,vmInstance.getId(),eventId)) {
            s_logger.warn("There was an error stopping the user vm id: " + vmInstance.getId() + " ,cannot enable storage maintenance");
            primaryStorage.setStatus(Status.ErrorInMaintenance);
            _storagePoolDao.persist(primaryStorage);
            return false;
          }
        }
        if (vmInstance.getType().equals(VirtualMachine.Type.SecondaryStorageVm)) {
          if (destroyVolumes)           markedVolumes.add(volume);
          long eventId1=saveScheduledEvent(User.UID_SYSTEM,Account.ACCOUNT_ID_SYSTEM,EventTypes.EVENT_SSVM_STOP,"stopping ssvm with Id: " + vmInstance.getId());
          if (!_secStorageMgr.stopSecStorageVm(vmInstance.getId(),eventId1)) {
            s_logger.warn("There was an error stopping the ssvm id: " + vmInstance.getId() + " ,cannot enable storage maintenance");
            primaryStorage.setStatus(Status.ErrorInMaintenance);
            _storagePoolDao.persist(primaryStorage);
            return false;
          }
 else {
            if (destroyVolumes) {
              ssvmId=vmInstance.getId();
            }
          }
        }
        if (vmInstance.getType().equals(VirtualMachine.Type.DomainRouter)) {
          if (destroyVolumes)           markedVolumes.add(volume);
          long eventId2=saveScheduledEvent(User.UID_SYSTEM,Account.ACCOUNT_ID_SYSTEM,EventTypes.EVENT_ROUTER_STOP,"stopping domain router with Id: " + vmInstance.getId());
          if (!_networkMgr.stopRouter(vmInstance.getId(),eventId2)) {
            s_logger.warn("There was an error stopping the domain router id: " + vmInstance.getId() + " ,cannot enable primary storage maintenance");
            primaryStorage.setStatus(Status.ErrorInMaintenance);
            _storagePoolDao.persist(primaryStorage);
            return false;
          }
        }
      }
    }
    for (    VolumeVO vol : markedVolumes) {
      _volsDao.remove(vol.getId());
    }
    if (destroyVolumes) {
      long eventId=saveScheduledEvent(User.UID_SYSTEM,Account.ACCOUNT_ID_SYSTEM,EventTypes.EVENT_SSVM_START,"starting ssvm with Id: " + ssvmId);
      if (_secStorageMgr.startSecStorageVm(ssvmId,eventId) == null) {
        s_logger.warn("There was an error starting the ssvm id: " + ssvmId + " on another storage pool, cannot enable primary storage maintenance");
        primaryStorage.setStatus(Status.ErrorInMaintenance);
        _storagePoolDao.persist(primaryStorage);
        return false;
      }
      long eventId1=saveScheduledEvent(User.UID_SYSTEM,Account.ACCOUNT_ID_SYSTEM,EventTypes.EVENT_PROXY_START,"starting console proxy with Id: " + consoleProxyId);
      _configMgr.updateConfiguration(userId,"consoleproxy.restart","true");
      if (_consoleProxyMgr.startProxy(consoleProxyId,eventId1) == null) {
        s_logger.warn("There was an error starting the console proxy id: " + consoleProxyId + " on another storage pool, cannot enable primary storage maintenance");
        primaryStorage.setStatus(Status.ErrorInMaintenance);
        _storagePoolDao.persist(primaryStorage);
        return false;
      }
    }
    primaryStorage.setStatus(Status.Maintenance);
    _storagePoolDao.persist(primaryStorage);
  }
 catch (  Exception e) {
    s_logger.error("Exception in enabling primary storage maintenance:" + e);
  }
  return true;
}
