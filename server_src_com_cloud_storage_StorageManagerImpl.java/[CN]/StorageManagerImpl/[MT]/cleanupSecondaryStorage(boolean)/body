{
  try {
    List<DataStore> imageStores=this.dataStoreMgr.getImageStoresByScope(new ZoneScope(null));
    for (    DataStore store : imageStores) {
      try {
        long storeId=store.getId();
        List<TemplateDataStoreVO> destroyedTemplateStoreVOs=this._templateStoreDao.listDestroyed(storeId);
        s_logger.debug("Secondary storage garbage collector found " + destroyedTemplateStoreVOs.size() + " templates to cleanup on secondary storage host: "+ store.getName());
        for (        TemplateDataStoreVO destroyedTemplateStoreVO : destroyedTemplateStoreVOs) {
          if (!_tmpltMgr.templateIsDeleteable(destroyedTemplateStoreVO.getTemplateId())) {
            if (s_logger.isDebugEnabled()) {
              s_logger.debug("Not deleting template at: " + destroyedTemplateStoreVO);
            }
            continue;
          }
          if (s_logger.isDebugEnabled()) {
            s_logger.debug("Deleting template store: " + destroyedTemplateStoreVO);
          }
          VMTemplateVO destroyedTemplate=this._vmTemplateDao.findById(destroyedTemplateStoreVO.getTemplateId());
          if (destroyedTemplate == null) {
            s_logger.error("Cannot find template : " + destroyedTemplateStoreVO.getTemplateId() + " from template table");
            throw new CloudRuntimeException("Template " + destroyedTemplateStoreVO.getTemplateId() + " is found in secondary storage, but not found in template table");
          }
          String installPath=destroyedTemplateStoreVO.getInstallPath();
          if (installPath != null) {
            EndPoint ep=_epSelector.select(store);
            Command cmd=new DeleteTemplateCommand(store.getTO(),destroyedTemplateStoreVO.getInstallPath(),destroyedTemplate.getId(),destroyedTemplate.getAccountId());
            Answer answer=ep.sendMessage(cmd);
            if (answer == null || !answer.getResult()) {
              s_logger.debug("Failed to delete " + destroyedTemplateStoreVO + " due to "+ ((answer == null) ? "answer is null" : answer.getDetails()));
            }
 else {
              _templateStoreDao.remove(destroyedTemplateStoreVO.getId());
              s_logger.debug("Deleted template at: " + destroyedTemplateStoreVO.getInstallPath());
            }
          }
 else {
            _templateStoreDao.remove(destroyedTemplateStoreVO.getId());
          }
        }
      }
 catch (      Exception e) {
        s_logger.warn("problem cleaning up templates in secondary storage store " + store.getName(),e);
      }
    }
    for (    DataStore store : imageStores) {
      try {
        List<SnapshotDataStoreVO> destroyedSnapshotStoreVOs=_snapshotStoreDao.listDestroyed(store.getId());
        s_logger.debug("Secondary storage garbage collector found " + destroyedSnapshotStoreVOs.size() + " snapshots to cleanup on secondary storage host: "+ store.getName());
        for (        SnapshotDataStoreVO destroyedSnapshotStoreVO : destroyedSnapshotStoreVOs) {
          SnapshotInfo snap=snapshotFactory.getSnapshot(destroyedSnapshotStoreVO.getSnapshotId(),store);
          if (snap.getChild() != null) {
            s_logger.debug("Skip snapshot on store: " + destroyedSnapshotStoreVO + " , because it has child");
            continue;
          }
          if (s_logger.isDebugEnabled()) {
            s_logger.debug("Deleting snapshot on store: " + destroyedSnapshotStoreVO);
          }
          String installPath=destroyedSnapshotStoreVO.getInstallPath();
          if (installPath != null) {
            EndPoint ep=_epSelector.select(store);
            DeleteSnapshotBackupCommand cmd=new DeleteSnapshotBackupCommand(store.getTO(),store.getUri(),null,null,null,destroyedSnapshotStoreVO.getInstallPath(),false);
            Answer answer=ep.sendMessage(cmd);
            if (answer == null || !answer.getResult()) {
              s_logger.debug("Failed to delete " + destroyedSnapshotStoreVO + " due to "+ ((answer == null) ? "answer is null" : answer.getDetails()));
            }
 else {
              _volumeStoreDao.remove(destroyedSnapshotStoreVO.getId());
              s_logger.debug("Deleted snapshot at: " + destroyedSnapshotStoreVO.getInstallPath());
            }
          }
 else {
            _snapshotStoreDao.remove(destroyedSnapshotStoreVO.getId());
          }
        }
      }
 catch (      Exception e2) {
        s_logger.warn("problem cleaning up snapshots in secondary storage store " + store.getName(),e2);
      }
    }
    for (    DataStore store : imageStores) {
      try {
        List<VolumeDataStoreVO> destroyedStoreVOs=_volumeStoreDao.listDestroyed(store.getId());
        s_logger.debug("Secondary storage garbage collector found " + destroyedStoreVOs.size() + " volumes to cleanup on secondary storage host: "+ store.getName());
        for (        VolumeDataStoreVO destroyedStoreVO : destroyedStoreVOs) {
          if (s_logger.isDebugEnabled()) {
            s_logger.debug("Deleting volume on store: " + destroyedStoreVO);
          }
          String installPath=destroyedStoreVO.getInstallPath();
          if (installPath != null) {
            EndPoint ep=_epSelector.select(store);
            DeleteVolumeCommand cmd=new DeleteVolumeCommand(store.getTO(),destroyedStoreVO.getVolumeId(),destroyedStoreVO.getInstallPath());
            Answer answer=ep.sendMessage(cmd);
            if (answer == null || !answer.getResult()) {
              s_logger.debug("Failed to delete " + destroyedStoreVO + " due to "+ ((answer == null) ? "answer is null" : answer.getDetails()));
            }
 else {
              _volumeStoreDao.remove(destroyedStoreVO.getId());
              s_logger.debug("Deleted volume at: " + destroyedStoreVO.getInstallPath());
            }
          }
 else {
            _volumeStoreDao.remove(destroyedStoreVO.getId());
          }
        }
      }
 catch (      Exception e2) {
        s_logger.warn("problem cleaning up volumes in secondary storage store " + store.getName(),e2);
      }
    }
  }
 catch (  Exception e3) {
    s_logger.warn("problem cleaning up secondary storage ",e3);
  }
}
