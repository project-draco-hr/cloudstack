{
  List<VolumeDataStoreVO> volumesOnImageStoreList=_volumeStoreDao.listVolumeDownloadUrls();
  for (  VolumeDataStoreVO volumeOnImageStore : volumesOnImageStoreList) {
    try {
      long downloadUrlCurrentAgeInSecs=DateUtil.getTimeDifference(DateUtil.now(),volumeOnImageStore.getExtractUrlCreated());
      if (downloadUrlCurrentAgeInSecs < _downloadUrlExpirationInterval) {
        continue;
      }
      s_logger.debug("Removing download url " + volumeOnImageStore.getExtractUrl() + " for volume id "+ volumeOnImageStore.getVolumeId());
      ImageStoreEntity secStore=(ImageStoreEntity)_dataStoreMgr.getDataStore(volumeOnImageStore.getDataStoreId(),DataStoreRole.Image);
      secStore.deleteExtractUrl(volumeOnImageStore.getInstallPath(),volumeOnImageStore.getExtractUrl(),Upload.Type.VOLUME);
      _volumeStoreDao.expunge(volumeOnImageStore.getId());
    }
 catch (    Throwable th) {
      s_logger.warn("Caught exception while deleting download url " + volumeOnImageStore.getExtractUrl() + " for volume id "+ volumeOnImageStore.getVolumeId(),th);
    }
  }
  List<TemplateDataStoreVO> templatesOnImageStoreList=_templateStoreDao.listTemplateDownloadUrls();
  for (  TemplateDataStoreVO templateOnImageStore : templatesOnImageStoreList) {
    try {
      long downloadUrlCurrentAgeInSecs=DateUtil.getTimeDifference(DateUtil.now(),templateOnImageStore.getExtractUrlCreated());
      if (downloadUrlCurrentAgeInSecs < _downloadUrlExpirationInterval) {
        continue;
      }
      s_logger.debug("Removing download url " + templateOnImageStore.getExtractUrl() + " for template id "+ templateOnImageStore.getTemplateId());
      ImageStoreEntity secStore=(ImageStoreEntity)_dataStoreMgr.getDataStore(templateOnImageStore.getDataStoreId(),DataStoreRole.Image);
      secStore.deleteExtractUrl(templateOnImageStore.getInstallPath(),templateOnImageStore.getExtractUrl(),Upload.Type.TEMPLATE);
      templateOnImageStore.setExtractUrl(null);
      templateOnImageStore.setExtractUrlCreated(null);
      _templateStoreDao.update(templateOnImageStore.getId(),templateOnImageStore);
    }
 catch (    Throwable th) {
      s_logger.warn("caught exception while deleting download url " + templateOnImageStore.getExtractUrl() + " for template id "+ templateOnImageStore.getTemplateId(),th);
    }
  }
}
