{
  System.setProperty("java.awt.headless","true");
  configProxy(conf);
  ConsoleProxyServerFactory factory=getHttpServerFactory();
  if (factory == null) {
    s_logger.error("Unable to load console proxy server factory");
    System.exit(1);
  }
  if (httpListenPort != 0) {
    startupHttpMain();
  }
 else {
    s_logger.error("A valid HTTP server port is required to be specified, please check your consoleproxy.httpListenPort settings");
    System.exit(1);
  }
  if (httpCmdListenPort > 0) {
    startupHttpCmdPort();
  }
 else {
    s_logger.info("HTTP command port is disabled");
  }
  ViewerGCThread cthread=new ViewerGCThread(connectionMap);
  cthread.setName("Viewer GC Thread");
  cthread.start();
  if (tcpListenPort > 0) {
    SSLServerSocket srvSock=null;
    try {
      srvSock=factory.createSSLServerSocket(tcpListenPort);
      s_logger.info("Listening for TCP on port " + tcpListenPort);
    }
 catch (    IOException ioe) {
      s_logger.error(ioe.toString(),ioe);
      System.exit(1);
    }
    if (srvSock != null) {
      while (true) {
        Socket conn=null;
        try {
          conn=srvSock.accept();
          String srcinfo=conn.getInetAddress().getHostAddress() + ":" + conn.getPort();
          s_logger.info("Accepted connection from " + srcinfo);
          conn.setSoLinger(false,0);
          ConsoleProxyClientHandler worker=new ConsoleProxyClientHandler(conn);
          worker.setName("Proxy Thread " + worker.getId() + " <"+ srcinfo);
          worker.start();
        }
 catch (        IOException ioe2) {
          s_logger.error(ioe2.toString(),ioe2);
          try {
            if (conn != null) {
              conn.close();
            }
          }
 catch (          IOException ioe) {
          }
        }
catch (        Throwable e) {
          s_logger.error(e.toString(),e);
          System.exit(1);
        }
      }
    }
 else {
      s_logger.warn("TCP port is enabled in configuration but we are not able to instantiate server socket.");
    }
  }
 else {
    s_logger.info("TCP port is disabled for applet viewers");
  }
}
