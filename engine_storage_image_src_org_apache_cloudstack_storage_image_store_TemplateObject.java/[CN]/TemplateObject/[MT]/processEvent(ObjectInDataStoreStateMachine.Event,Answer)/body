{
  try {
    if (this.getDataStore().getRole() == DataStoreRole.Primary) {
      if (answer instanceof CopyCmdAnswer) {
        CopyCmdAnswer cpyAnswer=(CopyCmdAnswer)answer;
        TemplateObjectTO newTemplate=(TemplateObjectTO)cpyAnswer.getNewData();
        VMTemplateStoragePoolVO templatePoolRef=templatePoolDao.findByPoolTemplate(this.getDataStore().getId(),this.getId());
        templatePoolRef.setDownloadPercent(100);
        templatePoolRef.setDownloadState(Status.DOWNLOADED);
        templatePoolRef.setLocalDownloadPath(newTemplate.getPath());
        templatePoolRef.setInstallPath(newTemplate.getPath());
        templatePoolDao.update(templatePoolRef.getId(),templatePoolRef);
      }
    }
 else     if (this.getDataStore().getRole() == DataStoreRole.Image || this.getDataStore().getRole() == DataStoreRole.ImageCache) {
      if (answer instanceof CopyCmdAnswer) {
        CopyCmdAnswer cpyAnswer=(CopyCmdAnswer)answer;
        TemplateObjectTO newTemplate=(TemplateObjectTO)cpyAnswer.getNewData();
        TemplateDataStoreVO templateStoreRef=this.templateStoreDao.findByStoreTemplate(this.getDataStore().getId(),this.getId());
        templateStoreRef.setInstallPath(newTemplate.getPath());
        templateStoreDao.update(templateStoreRef.getId(),templateStoreRef);
      }
    }
    ojbectInStoreMgr.update(this,event);
  }
 catch (  NoTransitionException e) {
    s_logger.debug("failed to update state",e);
    throw new CloudRuntimeException("Failed to update state" + e.toString());
  }
}
