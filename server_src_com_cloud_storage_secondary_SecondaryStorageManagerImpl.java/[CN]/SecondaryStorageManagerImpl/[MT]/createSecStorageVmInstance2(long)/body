{
  long startEventId=saveStartedEvent(User.UID_SYSTEM,Account.ACCOUNT_ID_SYSTEM,EventTypes.EVENT_SSVM_CREATE,"Creating secondary storage Vm in zone : " + dataCenterId,0);
  HostVO secHost=_hostDao.findSecondaryStorageHost(dataCenterId);
  if (secHost == null) {
    String msg="No secondary storage available in zone " + dataCenterId + ", cannot create secondary storage vm";
    s_logger.warn(msg);
    saveFailedEvent(User.UID_SYSTEM,Account.ACCOUNT_ID_SYSTEM,EventTypes.EVENT_SSVM_CREATE,msg,startEventId);
    throw new CloudRuntimeException(msg);
  }
  _secHostUuid=secHost.getGuid();
  _nfsShare=secHost.getStorageUrl();
  long id=_secStorageVmDao.getNextInSequence(Long.class,"id");
  String name=VirtualMachineName.getSystemVmName(id,_instance,"s").intern();
  AccountVO systemAcct=_accountMgr.getSystemAccount();
  DataCenterDeployment plan=new DataCenterDeployment(dataCenterId);
  List<NetworkOfferingVO> defaultOffering=_networkMgr.getSystemAccountNetworkOfferings(NetworkOfferingVO.SystemVmPublicNetwork);
  List<NetworkOfferingVO> offerings=_networkMgr.getSystemAccountNetworkOfferings(NetworkOfferingVO.SystemVmControlNetwork,NetworkOfferingVO.SystemVmManagementNetwork);
  List<Pair<NetworkVO,NicProfile>> networks=new ArrayList<Pair<NetworkVO,NicProfile>>(offerings.size() + 1);
  NicProfile defaultNic=new NicProfile();
  defaultNic.setDefaultNic(true);
  defaultNic.setDeviceId(2);
  networks.add(new Pair<NetworkVO,NicProfile>(_networkMgr.setupNetworkConfiguration(systemAcct,defaultOffering.get(0),plan).get(0),defaultNic));
  for (  NetworkOfferingVO offering : offerings) {
    networks.add(new Pair<NetworkVO,NicProfile>(_networkMgr.setupNetworkConfiguration(systemAcct,offering,plan).get(0),null));
  }
  SecondaryStorageVmVO secStorageVm=new SecondaryStorageVmVO(id,_serviceOffering.getId(),name,_template.getId(),_template.getGuestOSId(),dataCenterId,systemAcct.getDomainId(),systemAcct.getId());
  try {
    secStorageVm=_itMgr.allocate(secStorageVm,_template,_serviceOffering,networks,plan,systemAcct);
  }
 catch (  InsufficientCapacityException e) {
    s_logger.warn("InsufficientCapacity",e);
    throw new CloudRuntimeException("Insufficient capacity exception",e);
  }
catch (  StorageUnavailableException e) {
    s_logger.warn("Unable to contact storage",e);
    throw new CloudRuntimeException("Unable to contact storage",e);
  }
  Map<String,Object> context=new HashMap<String,Object>();
  context.put("secStorageVmId",secStorageVm.getId());
  return context;
}
