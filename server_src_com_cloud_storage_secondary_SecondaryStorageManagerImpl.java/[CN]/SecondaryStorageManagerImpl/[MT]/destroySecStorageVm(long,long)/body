{
  AsyncJobExecutor asyncExecutor=BaseAsyncJobExecutor.getCurrentExecutor();
  if (asyncExecutor != null) {
    AsyncJobVO job=asyncExecutor.getJob();
    if (s_logger.isInfoEnabled())     s_logger.info("Destroy secondary storage vm " + vmId + ", update async job-"+ job.getId());
    _asyncMgr.updateAsyncJobAttachment(job.getId(),"secstorage_vm",vmId);
  }
  long eventId=saveStartedEvent(User.UID_SYSTEM,Account.ACCOUNT_ID_SYSTEM,EventTypes.EVENT_SSVM_DESTROY,"Destroying secondary storage Vm Id: " + vmId,startEventId);
  if (startEventId == 0) {
    startEventId=eventId;
  }
  SecondaryStorageVmVO vm=_secStorageVmDao.findById(vmId);
  if (vm == null || vm.getState() == State.Destroyed) {
    String msg="Unable to find vm or vm is destroyed: " + vmId;
    if (s_logger.isDebugEnabled()) {
      s_logger.debug(msg);
    }
    saveFailedEvent(User.UID_SYSTEM,Account.ACCOUNT_ID_SYSTEM,EventTypes.EVENT_SSVM_DESTROY,msg,startEventId);
    return true;
  }
  if (s_logger.isDebugEnabled()) {
    s_logger.debug("Destroying secondary storage vm vm " + vmId);
  }
  if (!_secStorageVmDao.updateIf(vm,Event.DestroyRequested,null)) {
    String msg="Unable to destroy the vm because it is not in the correct state: " + vmId;
    s_logger.debug(msg);
    saveFailedEvent(User.UID_SYSTEM,Account.ACCOUNT_ID_SYSTEM,EventTypes.EVENT_SSVM_DESTROY,msg,startEventId);
    return false;
  }
  Transaction txn=Transaction.currentTxn();
  List<VolumeVO> vols=null;
  try {
    vols=_volsDao.findByInstance(vmId);
    if (vols.size() != 0) {
      _storageMgr.destroy(vm,vols);
    }
    return true;
  }
  finally {
    try {
      txn.start();
      if (vm.getPublicIpAddress() != null)       freePublicIpAddress(vm.getPublicIpAddress(),vm.getDataCenterId(),vm.getPodId());
      vm.setPublicIpAddress(null);
      _secStorageVmDao.remove(vm.getId());
      final EventVO event=new EventVO();
      event.setUserId(User.UID_SYSTEM);
      event.setAccountId(Account.ACCOUNT_ID_SYSTEM);
      event.setType(EventTypes.EVENT_SSVM_DESTROY);
      event.setLevel(EventVO.LEVEL_INFO);
      event.setStartId(startEventId);
      event.setDescription("Secondary Storage Vm destroyed - " + vm.getName());
      _eventDao.persist(event);
      txn.commit();
    }
 catch (    Exception e) {
      s_logger.error("Caught this error: ",e);
      txn.rollback();
      return false;
    }
 finally {
      s_logger.debug("secondary storage vm vm is destroyed : " + vm.getName());
    }
  }
}
