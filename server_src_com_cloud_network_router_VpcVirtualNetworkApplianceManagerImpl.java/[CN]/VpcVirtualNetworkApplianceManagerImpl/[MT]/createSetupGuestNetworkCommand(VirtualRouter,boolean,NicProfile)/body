{
  Network network=_networkMgr.getNetwork(guestNic.getNetworkId());
  String defaultDns1=null;
  String defaultDns2=null;
  boolean dnsProvided=_networkMgr.isProviderSupportServiceInNetwork(network.getId(),Service.Dns,Provider.VPCVirtualRouter);
  boolean dhcpProvided=_networkMgr.isProviderSupportServiceInNetwork(network.getId(),Service.Dhcp,Provider.VPCVirtualRouter);
  boolean setupDns=dnsProvided || dhcpProvided;
  if (setupDns) {
    defaultDns1=guestNic.getDns1();
    defaultDns2=guestNic.getDns2();
  }
  Nic nic=_nicDao.findByInstanceIdAndNetworkId(network.getId(),router.getId());
  String networkDomain=network.getNetworkDomain();
  String dhcpRange=getGuestDhcpRange(guestNic,network,_configMgr.getZone(network.getDataCenterId()));
  NicProfile nicProfile=_networkMgr.getNicProfile(router,nic.getNetworkId(),null);
  SetupGuestNetworkCommand setupCmd=new SetupGuestNetworkCommand(dhcpRange,networkDomain,false,null,defaultDns1,defaultDns2,add,_itMgr.toNicTO(nicProfile,router.getHypervisorType()));
  long guestVlanTag=Long.parseLong(network.getBroadcastUri().getHost());
  String brd=NetUtils.long2Ip(NetUtils.ip2Long(guestNic.getIp4Address()) | ~NetUtils.ip2Long(guestNic.getNetmask()));
  setupCmd.setAccessDetail(NetworkElementCommand.ROUTER_IP,getRouterControlIp(router.getId()));
  setupCmd.setAccessDetail(NetworkElementCommand.ROUTER_GUEST_IP,getRouterIpInNetwork(network.getId(),router.getId()));
  setupCmd.setAccessDetail(NetworkElementCommand.GUEST_VLAN_TAG,String.valueOf(guestVlanTag));
  setupCmd.setAccessDetail(NetworkElementCommand.GUEST_NETWORK_GATEWAY,network.getGateway());
  setupCmd.setAccessDetail(NetworkElementCommand.GUEST_BRIDGE,brd);
  setupCmd.setAccessDetail(NetworkElementCommand.ROUTER_NAME,router.getInstanceName());
  return setupCmd;
}
