{
  boolean result=true;
  if (router.getState() == State.Running) {
    SetupGuestNetworkCommand setupCmd=createSetupGuestNetworkCommand(router,add,guestNic);
    Commands cmds=new Commands(OnError.Stop);
    cmds.addCommand("setupguestnetwork",setupCmd);
    sendCommandsToRouter(router,cmds);
    SetupGuestNetworkAnswer setupAnswer=cmds.getAnswer(SetupGuestNetworkAnswer.class);
    String setup=add ? "set" : "destroy";
    if (!(setupAnswer != null && setupAnswer.getResult())) {
      s_logger.warn("Unable to " + setup + " guest network on router "+ router);
      result=false;
    }
    return result;
  }
 else   if (router.getState() == State.Stopped || router.getState() == State.Stopping) {
    s_logger.debug("Router " + router.getInstanceName() + " is in "+ router.getState()+ ", so not sending setup guest network command to the backend");
    return true;
  }
 else {
    s_logger.warn("Unable to setup guest network on virtual router " + router + " is not in the right state "+ router.getState());
    throw new ResourceUnavailableException("Unable to setup guest network on the backend," + " virtual router " + router + " is not in the right state",DataCenter.class,router.getDataCenterId());
  }
}
