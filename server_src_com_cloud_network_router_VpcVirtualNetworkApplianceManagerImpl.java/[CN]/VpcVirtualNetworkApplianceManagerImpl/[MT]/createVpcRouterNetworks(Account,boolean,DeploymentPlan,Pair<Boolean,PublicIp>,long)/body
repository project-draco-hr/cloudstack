{
  LinkedHashMap<Network,List<? extends NicProfile>> networks=new LinkedHashMap<Network,List<? extends NicProfile>>(4);
  TreeSet<String> publicVlans=new TreeSet<String>();
  publicVlans.add(sourceNatIp.second().getVlanTag());
  networks=super.createRouterNetworks(owner,isRedundant,plan,null,sourceNatIp);
  List<PrivateGateway> privateGateways=_vpcMgr.getVpcPrivateGateways(vpcId);
  if (privateGateways != null && !privateGateways.isEmpty()) {
    for (    PrivateGateway privateGateway : privateGateways) {
      NicProfile privateNic=createPrivateNicProfileForGateway(privateGateway);
      Network privateNetwork=_networkModel.getNetwork(privateGateway.getNetworkId());
      networks.put(privateNetwork,new ArrayList<NicProfile>(Arrays.asList(privateNic)));
    }
  }
  List<? extends Network> guestNetworks=_vpcMgr.getVpcNetworks(vpcId);
  for (  Network guestNetwork : guestNetworks) {
    if (guestNetwork.getState() == Network.State.Implemented || guestNetwork.getState() == Network.State.Setup) {
      NicProfile guestNic=createGuestNicProfileForVpcRouter(guestNetwork);
      networks.put(guestNetwork,new ArrayList<NicProfile>(Arrays.asList(guestNic)));
    }
  }
  List<IPAddressVO> ips=_ipAddressDao.listByAssociatedVpc(vpcId,false);
  List<NicProfile> publicNics=new ArrayList<NicProfile>();
  Network publicNetwork=null;
  for (  IPAddressVO ip : ips) {
    PublicIp publicIp=PublicIp.createFromAddrAndVlan(ip,_vlanDao.findById(ip.getVlanId()));
    if ((ip.getState() == IpAddress.State.Allocated || ip.getState() == IpAddress.State.Allocating) && _vpcMgr.isIpAllocatedToVpc(ip) && !publicVlans.contains(publicIp.getVlanTag())) {
      s_logger.debug("Allocating nic for router in vlan " + publicIp.getVlanTag());
      NicProfile publicNic=new NicProfile();
      publicNic.setDefaultNic(false);
      publicNic.setIp4Address(publicIp.getAddress().addr());
      publicNic.setGateway(publicIp.getGateway());
      publicNic.setNetmask(publicIp.getNetmask());
      publicNic.setMacAddress(publicIp.getMacAddress());
      publicNic.setBroadcastType(BroadcastDomainType.Vlan);
      publicNic.setBroadcastUri(BroadcastDomainType.Vlan.toUri(publicIp.getVlanTag()));
      publicNic.setIsolationUri(IsolationType.Vlan.toUri(publicIp.getVlanTag()));
      NetworkOffering publicOffering=_networkModel.getSystemAccountNetworkOfferings(NetworkOffering.SystemPublicNetwork).get(0);
      if (publicNetwork == null) {
        List<? extends Network> publicNetworks=_networkMgr.setupNetwork(_systemAcct,publicOffering,plan,null,null,false);
        publicNetwork=publicNetworks.get(0);
      }
      publicNics.add(publicNic);
      publicVlans.add(publicIp.getVlanTag());
    }
  }
  if (publicNetwork != null) {
    if (networks.get(publicNetwork) != null) {
      List<NicProfile> publicNicProfiles=(List<NicProfile>)networks.get(publicNetwork);
      publicNicProfiles.addAll(publicNics);
      networks.put(publicNetwork,publicNicProfiles);
    }
 else {
      networks.put(publicNetwork,publicNics);
    }
  }
  return networks;
}
