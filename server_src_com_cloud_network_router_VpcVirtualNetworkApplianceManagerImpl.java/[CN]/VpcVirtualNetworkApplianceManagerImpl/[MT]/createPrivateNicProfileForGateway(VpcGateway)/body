{
  Network privateNetwork=_networkMgr.getNetwork(privateGateway.getNetworkId());
  PrivateIpVO ipVO=_privateIpDao.allocateIpAddress(privateNetwork.getDataCenterId(),privateNetwork.getId(),privateGateway.getIp4Address());
  Nic privateNic=_nicDao.findByIp4AddressAndNetworkId(ipVO.getIpAddress(),privateNetwork.getId());
  NicProfile privateNicProfile=new NicProfile();
  if (privateNic != null) {
    VirtualMachine vm=_vmDao.findById(privateNic.getId());
    privateNicProfile=new NicProfile(privateNic,privateNetwork,privateNic.getBroadcastUri(),privateNic.getIsolationUri(),_networkMgr.getNetworkRate(privateNetwork.getId(),vm.getId()),_networkMgr.isSecurityGroupSupportedInNetwork(privateNetwork),_networkMgr.getNetworkTag(vm.getHypervisorType(),privateNetwork));
  }
 else {
    String vlanTag=privateNetwork.getBroadcastUri().getHost();
    String netmask=NetUtils.getCidrNetmask(privateNetwork.getCidr());
    PrivateIpAddress ip=new PrivateIpAddress(ipVO,vlanTag,privateNetwork.getGateway(),netmask,NetUtils.long2Mac(NetUtils.createSequenceBasedMacAddress(ipVO.getMacAddress())));
    privateNicProfile.setIp4Address(ip.getIpAddress());
    privateNicProfile.setGateway(ip.getGateway());
    privateNicProfile.setNetmask(ip.getNetmask());
    privateNicProfile.setIsolationUri(IsolationType.Vlan.toUri(ip.getVlanTag()));
    privateNicProfile.setBroadcastUri(IsolationType.Vlan.toUri(ip.getVlanTag()));
    privateNicProfile.setBroadcastType(BroadcastDomainType.Vlan);
    privateNicProfile.setFormat(AddressFormat.Ip4);
    privateNicProfile.setReservationId(String.valueOf(ip.getVlanTag()));
    privateNicProfile.setMacAddress(ip.getMacAddress());
  }
  return privateNicProfile;
}
