{
  DomainRouterVO router=profile.getVirtualMachine();
  boolean isVpc=(router.getVpcId() != null);
  if (!isVpc) {
    return super.finalizeCommandsOnStart(cmds,profile);
  }
  NicProfile controlNic=getControlNic(profile);
  if (controlNic == null) {
    s_logger.error("Control network doesn't exist for the router " + router);
    return false;
  }
  finalizeSshAndVersionAndNetworkUsageOnStart(cmds,profile,router,controlNic);
  Map<Nic,Network> guestNics=new HashMap<Nic,Network>();
  Map<Nic,Network> publicNics=new HashMap<Nic,Network>();
  List<? extends Nic> routerNics=_nicDao.listByVmId(profile.getId());
  for (  Nic routerNic : routerNics) {
    Network network=_networkMgr.getNetwork(routerNic.getNetworkId());
    if (network.getTrafficType() == TrafficType.Guest) {
      guestNics.put(routerNic,network);
    }
 else     if (network.getTrafficType() == TrafficType.Public) {
      publicNics.put(routerNic,network);
    }
  }
  try {
    List<PublicIp> sourceNat=new ArrayList<PublicIp>(1);
    for (    Nic publicNic : publicNics.keySet()) {
      Network publicNtwk=publicNics.get(publicNic);
      IPAddressVO userIp=_ipAddressDao.findByIpAndSourceNetworkId(publicNtwk.getId(),publicNic.getIp4Address());
      if (userIp.isSourceNat()) {
        PublicIp publicIp=new PublicIp(userIp,_vlanDao.findById(userIp.getVlanId()),NetUtils.createSequenceBasedMacAddress(userIp.getMacAddress()));
        sourceNat.add(publicIp);
        if (router.getPublicIpAddress() == null) {
          DomainRouterVO routerVO=_routerDao.findById(router.getId());
          routerVO.setPublicIpAddress(publicNic.getIp4Address());
          routerVO.setPublicNetmask(publicNic.getNetmask());
          routerVO.setPublicMacAddress(publicNic.getMacAddress());
          _routerDao.update(routerVO.getId(),routerVO);
        }
      }
      PlugNicCommand plugNicCmd=new PlugNicCommand(_itMgr.toVmTO(profile),getNicTO(router,publicNic.getNetworkId()));
      cmds.addCommand(plugNicCmd);
    }
    if (!sourceNat.isEmpty()) {
      createVpcAssociatePublicIPCommands(router,sourceNat,cmds);
    }
    for (    Nic nic : guestNics.keySet()) {
      PlugNicCommand plugNicCmd=new PlugNicCommand(_itMgr.toVmTO(profile),getNicTO(router,nic.getNetworkId()));
      cmds.addCommand(plugNicCmd);
      if (!_networkMgr.isPrivateGateway(nic)) {
        VirtualMachine vm=_vmDao.findById(router.getId());
        NicProfile nicProfile=_networkMgr.getNicProfile(vm,nic.getNetworkId());
        SetupGuestNetworkCommand setupCmd=createSetupGuestNetworkCommand(router,true,nicProfile);
        cmds.addCommand(setupCmd);
      }
 else {
        PrivateIpVO ipVO=_privateIpDao.findByIpAndSourceNetworkId(nic.getNetworkId(),nic.getIp4Address());
        Network network=_networkDao.findById(nic.getNetworkId());
        String vlanTag=network.getBroadcastUri().getHost();
        String netmask=NetUtils.getCidrNetmask(network.getCidr());
        PrivateIpAddress ip=new PrivateIpAddress(ipVO,vlanTag,network.getGateway(),netmask,ipVO.getMacAddress());
        List<PrivateIpAddress> privateIps=new ArrayList<PrivateIpAddress>(1);
        privateIps.add(ip);
        createVpcAssociatePrivateIPCommands(router,privateIps,cmds,true);
      }
    }
  }
 catch (  Exception ex) {
    s_logger.warn("Failed to add router " + router + " to network due to exception ",ex);
    return false;
  }
  List<? extends StaticRoute> routes=_staticRouteDao.listByVpcId(router.getVpcId());
  List<StaticRouteProfile> staticRouteProfiles=new ArrayList<StaticRouteProfile>(routes.size());
  Map<Long,VpcGateway> gatewayMap=new HashMap<Long,VpcGateway>();
  for (  StaticRoute route : routes) {
    VpcGateway gateway=gatewayMap.get(route.getVpcGatewayId());
    if (gateway == null) {
      gateway=_vpcMgr.getVpcGateway(route.getVpcGatewayId());
      gatewayMap.put(gateway.getId(),gateway);
    }
    staticRouteProfiles.add(new StaticRouteProfile(route,gateway));
  }
  s_logger.debug("Found " + staticRouteProfiles.size() + " static routes to apply as a part of vpc route "+ router+ " start");
  if (!staticRouteProfiles.isEmpty()) {
    createStaticRouteCommands(staticRouteProfiles,router,cmds);
  }
  boolean reprogramGuestNtwks=true;
  if (profile.getParameter(Param.ReProgramGuestNetworks) != null && (Boolean)profile.getParameter(Param.ReProgramGuestNetworks) == false) {
    reprogramGuestNtwks=false;
  }
  VirtualRouterProvider vrProvider=_vrProviderDao.findById(router.getElementId());
  if (vrProvider == null) {
    throw new CloudRuntimeException("Cannot find related virtual router provider of router: " + router.getHostName());
  }
  Provider provider=Network.Provider.getProvider(vrProvider.getType().toString());
  if (provider == null) {
    throw new CloudRuntimeException("Cannot find related provider of virtual router provider: " + vrProvider.getType().toString());
  }
  List<Long> routerGuestNtwkIds=_routerDao.getRouterNetworks(router.getId());
  for (  Long guestNetworkId : routerGuestNtwkIds) {
    if (reprogramGuestNtwks) {
      finalizeIpAssocForNetwork(cmds,router,provider,guestNetworkId);
      finalizeNetworkRulesForNetwork(cmds,router,provider,guestNetworkId);
    }
    finalizeUserDataAndDhcpOnStart(cmds,router,provider,guestNetworkId);
  }
  return true;
}
