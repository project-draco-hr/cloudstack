{
  Set<Long> affectedVms=new HashSet<Long>();
  affectedVms.add(vm.getId());
  List<SecurityGroupVMMapVO> groupsForVm=_securityGroupVMMapDao.listByInstanceId(vm.getId());
  for (  SecurityGroupVMMapVO mapVO : groupsForVm) {
    List<IngressRuleVO> allowingRules=_ingressRuleDao.listByAllowedSecurityGroupId(mapVO.getSecurityGroupId());
    affectedVms.addAll(getAffectedVmsForIngressRules(allowingRules));
  }
  return affectedVms;
}
