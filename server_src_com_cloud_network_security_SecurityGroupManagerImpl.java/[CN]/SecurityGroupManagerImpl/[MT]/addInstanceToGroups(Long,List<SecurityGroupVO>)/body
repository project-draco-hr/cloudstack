{
  if (!_enabled) {
    return true;
  }
  if (groups != null) {
    final Set<SecurityGroupVO> uniqueGroups=new TreeSet<SecurityGroupVO>(new SecurityGroupVOComparator());
    uniqueGroups.addAll(groups);
    final Transaction txn=Transaction.currentTxn();
    txn.start();
    UserVm userVm=_userVMDao.acquireInLockTable(userVmId);
    if (userVm == null) {
      s_logger.warn("Failed to acquire lock on user vm id=" + userVmId);
    }
    try {
      for (      SecurityGroupVO networkGroup : uniqueGroups) {
        SecurityGroupVO ngrpLock=_securityGroupDao.lockRow(networkGroup.getId(),false);
        if (ngrpLock == null) {
          s_logger.warn("Failed to acquire lock on network group id=" + networkGroup.getId() + " name="+ networkGroup.getName());
          txn.rollback();
          return false;
        }
        if (_securityGroupVMMapDao.findByVmIdGroupId(userVmId,networkGroup.getId()) == null) {
          SecurityGroupVMMapVO groupVmMapVO=new SecurityGroupVMMapVO(networkGroup.getId(),userVmId);
          _securityGroupVMMapDao.persist(groupVmMapVO);
        }
      }
      txn.commit();
      return true;
    }
  finally {
      if (userVm != null) {
        _userVMDao.releaseFromLockTable(userVmId);
      }
    }
  }
  return false;
}
