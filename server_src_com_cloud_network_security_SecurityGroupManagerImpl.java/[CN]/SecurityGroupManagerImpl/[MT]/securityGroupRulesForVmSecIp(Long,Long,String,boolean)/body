{
  String vmMac=null;
  String vmName=null;
  if (secondaryIp == null || nicId == null || networkId == null) {
    throw new InvalidParameterValueException("Vm nicId or networkId or secondaryIp can't be null");
  }
  NicVO nic=_nicDao.findById(nicId);
  Long vmId=nic.getInstanceId();
  List<SecurityGroupVO> vmSgGrps=getSecurityGroupsForVm(vmId);
  if (vmSgGrps == null) {
    s_logger.debug("Vm is not in any Security group ");
    return true;
  }
  Account caller=CallContext.current().getCallingAccount();
  for (  SecurityGroupVO securityGroup : vmSgGrps) {
    Account owner=_accountMgr.getAccount(securityGroup.getAccountId());
    if (owner == null) {
      throw new InvalidParameterValueException("Unable to find security group owner by id=" + securityGroup.getAccountId());
    }
    _accountMgr.checkAccess(caller,null,true,securityGroup);
  }
  UserVm vm=_userVMDao.findById(vmId);
  if (vm.getType() != VirtualMachine.Type.User) {
    throw new InvalidParameterValueException("Can't configure the SG ipset, arprules rules for the non user vm");
  }
  if (vm != null) {
    vmMac=vm.getPrivateMacAddress();
    vmName=vm.getInstanceName();
    if (vmMac == null || vmName == null) {
      throw new InvalidParameterValueException("vm name or vm mac can't be null");
    }
  }
  NetworkRulesVmSecondaryIpCommand cmd=new NetworkRulesVmSecondaryIpCommand(vmName,vmMac,secondaryIp,ruleAction);
  s_logger.debug("Asking agent to configure rules for vm secondary ip");
  Commands cmds=null;
  cmds=new Commands(cmd);
  try {
    _agentMgr.send(vm.getHostId(),cmds);
  }
 catch (  AgentUnavailableException e) {
    s_logger.debug(e.toString());
  }
catch (  OperationTimedoutException e) {
    s_logger.debug(e.toString());
  }
  return true;
}
