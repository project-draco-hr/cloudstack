{
  Map<PortAndProto,Set<String>> allowed=new TreeMap<PortAndProto,Set<String>>();
  List<NetworkGroupVMMapVO> groupsForVm=_networkGroupVMMapDao.listByInstanceId(userVmId);
  for (  NetworkGroupVMMapVO mapVO : groupsForVm) {
    List<IngressRuleVO> rules=_ingressRuleDao.listByNetworkGroupId(mapVO.getNetworkGroupId());
    for (    IngressRuleVO rule : rules) {
      PortAndProto portAndProto=new PortAndProto(rule.getProtocol(),rule.getStartPort(),rule.getEndPort());
      Set<String> cidrs=allowed.get(portAndProto);
      if (cidrs == null) {
        cidrs=new TreeSet<String>(new CidrComparator());
      }
      if (rule.getAllowedNetworkId() != null) {
        List<NetworkGroupVMMapVO> allowedInstances=_networkGroupVMMapDao.listByNetworkGroup(rule.getAllowedNetworkId(),State.Running);
        for (        NetworkGroupVMMapVO ngmapVO : allowedInstances) {
          String cidr=ngmapVO.getGuestIpAddress();
          if (cidr != null) {
            cidr=cidr + "/32";
            cidrs.add(cidr);
          }
        }
      }
 else       if (rule.getAllowedSourceIpCidr() != null) {
        cidrs.add(rule.getAllowedSourceIpCidr());
      }
      if (cidrs.size() > 0)       allowed.put(portAndProto,cidrs);
    }
  }
  return allowed;
}
