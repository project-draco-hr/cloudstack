{
  List<Long> affectedVms=new ArrayList<Long>();
  List<SecurityGroupVMMapVO> groupsForVm=_securityGroupVMMapDao.listByInstanceId(vm.getId());
  for (  SecurityGroupVMMapVO mapVO : groupsForVm) {
    List<SecurityGroupRuleVO> allowingRules=_securityGroupRuleDao.listByAllowedSecurityGroupId(mapVO.getSecurityGroupId());
    affectedVms.addAll(getAffectedVmsForSecurityRules(allowingRules));
  }
  return affectedVms;
}
