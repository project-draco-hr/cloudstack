{
  Connection connection=getConnection();
  VirtualMachineTO vmSpec=cmd.getVirtualMachine();
  try {
    Host host=Host.getByUuid(connection,_host.uuid);
    Set<VM> vms=VM.getByNameLabel(connection,vmSpec.getName());
    VM migratedVm=vms.iterator().next();
    if (migratedVm == null) {
      throw new CloudRuntimeException("Couldn't find the migrated vm " + vmSpec.getName() + " on the destination host.");
    }
    List<VolumeObjectTO> volumeToSet=getUpdatedVolumePathsOfMigratedVm(connection,migratedVm,vmSpec.getDisks());
    migratedVm.setAffinity(connection,host);
synchronized (_cluster.intern()) {
      s_vms.put(_cluster,_name,vmSpec.getName(),State.Running);
    }
    return new MigrateWithStorageCompleteAnswer(cmd,volumeToSet);
  }
 catch (  CloudRuntimeException e) {
    s_logger.error("Migration of vm " + vmSpec.getName() + " with storage failed due to "+ e.toString(),e);
    return new MigrateWithStorageCompleteAnswer(cmd,e);
  }
catch (  Exception e) {
    s_logger.error("Migration of vm " + vmSpec.getName() + " with storage failed due to "+ e.toString(),e);
    return new MigrateWithStorageCompleteAnswer(cmd,e);
  }
}
