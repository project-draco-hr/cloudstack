{
  if (!_isEnabled) {
    return;
  }
  List<UserVmVO> userVms=_userVmDao.listByAccountIdAndHostId(vm.getAccountId(),vm.getHostId());
  if (vm.getType() == VirtualMachine.Type.User) {
    if (userVms.size() > 1) {
      return;
    }
    DomainRouterVO router=_routerDao.findBy(vm.getAccountId(),vm.getDataCenterId());
    if (router.getHostId() == vm.getHostId()) {
      return;
    }
  }
 else   if (vm.getType() == VirtualMachine.Type.DomainRouter && userVms.size() != 0) {
    return;
  }
  try {
    Command cmd=new OvsDestroyTunnelCommand(vm.getAccountId(),"[]");
    Answer ans=_agentMgr.send(vm.getHostId(),cmd);
    handleDestroyTunnelAnswer(ans,vm.getHostId(),0,vm.getAccountId());
    List<OvsTunnelAccountVO> peers=_tunnelAccountDao.listByToAccount(vm.getHostId(),vm.getAccountId());
    for (    OvsTunnelAccountVO p : peers) {
      cmd=new OvsDestroyTunnelCommand(p.getAccount(),p.getPortName());
      ans=_agentMgr.send(p.getFrom(),cmd);
      handleDestroyTunnelAnswer(ans,p.getFrom(),p.getTo(),p.getAccount());
    }
  }
 catch (  Exception e) {
    s_logger.warn(String.format("Destroy tunnel(account:%1$s, hostId:%2$s) failed",vm.getAccountId(),vm.getHostId()),e);
  }
}
