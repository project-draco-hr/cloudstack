{
  try {
    SearchCriteria<HostVO> sc=_hostDao.createSearchCriteria();
    sc.addAnd("status",SearchCriteria.Op.EQ,Status.Up.toString());
    sc.addAnd("type",SearchCriteria.Op.EQ,Host.Type.Storage.toString());
    ConcurrentHashMap<Long,StorageStats> storageStats=new ConcurrentHashMap<Long,StorageStats>();
    List<HostVO> hosts=_hostDao.search(sc,null);
    for (    HostVO host : hosts) {
      GetStorageStatsCommand command=new GetStorageStatsCommand(host.getGuid());
      Answer answer=_agentMgr.easySend(host.getId(),command);
      if (answer != null && answer.getResult()) {
        storageStats.put(host.getId(),(StorageStats)answer);
      }
    }
    sc=_hostDao.createSearchCriteria();
    sc.addAnd("status",SearchCriteria.Op.EQ,Status.Up.toString());
    sc.addAnd("type",SearchCriteria.Op.EQ,Host.Type.SecondaryStorage.toString());
    hosts=_hostDao.search(sc,null);
    for (    HostVO host : hosts) {
      GetStorageStatsCommand command=new GetStorageStatsCommand(host.getGuid());
      Answer answer=_agentMgr.easySend(host.getId(),command);
      if (answer != null && answer.getResult()) {
        storageStats.put(host.getId(),(StorageStats)answer);
      }
    }
    _storageStats=storageStats;
    ConcurrentHashMap<Long,StorageStats> storagePoolStats=new ConcurrentHashMap<Long,StorageStats>();
    List<StoragePoolVO> storagePools=_storagePoolDao.listAll();
    for (    StoragePoolVO pool : storagePools) {
      GetStorageStatsCommand command=new GetStorageStatsCommand(pool.getUuid(),pool.getPoolType(),pool.getPath());
      Answer answer=_storageManager.sendToPool(pool,command);
      if (answer != null && answer.getResult()) {
        storagePoolStats.put(pool.getId(),(StorageStats)answer);
      }
    }
    _storagePoolStats=storagePoolStats;
    List<CapacityVO> newCapacities=new ArrayList<CapacityVO>();
    for (    Long hostId : storageStats.keySet()) {
      StorageStats stats=storageStats.get(hostId);
      HostVO host=_hostDao.findById(hostId);
      host.setTotalSize(stats.getCapacityBytes());
      _hostDao.update(host.getId(),host);
      if (Host.Type.SecondaryStorage.equals(host.getType())) {
        CapacityVO capacity=new CapacityVO(host.getId(),host.getDataCenterId(),host.getPodId(),stats.getByteUsed(),stats.getCapacityBytes(),CapacityVO.CAPACITY_TYPE_SECONDARY_STORAGE);
        newCapacities.add(capacity);
      }
 else       if (Host.Type.Storage.equals(host.getType())) {
        CapacityVO capacity=new CapacityVO(host.getId(),host.getDataCenterId(),host.getPodId(),stats.getByteUsed(),stats.getCapacityBytes(),CapacityVO.CAPACITY_TYPE_STORAGE);
        newCapacities.add(capacity);
      }
    }
    for (    Long poolId : storagePoolStats.keySet()) {
      StorageStats stats=storagePoolStats.get(poolId);
      StoragePoolVO pool=_storagePoolDao.findById(poolId);
      if (pool == null) {
        continue;
      }
      pool.setCapacityBytes(stats.getCapacityBytes());
      long available=stats.getCapacityBytes() - stats.getByteUsed();
      if (available < 0) {
        available=0;
      }
      pool.setAvailableBytes(available);
      _storagePoolDao.update(pool.getId(),pool);
      CapacityVO capacity=new CapacityVO(poolId,pool.getDataCenterId(),pool.getPodId(),stats.getByteUsed(),stats.getCapacityBytes(),CapacityVO.CAPACITY_TYPE_STORAGE);
      newCapacities.add(capacity);
    }
    Transaction txn=Transaction.open(Transaction.CLOUD_DB);
    try {
      if (s_logger.isTraceEnabled()) {
        s_logger.trace("recalculating system storage capacity");
      }
      txn.start();
      _capacityDao.clearStorageCapacities();
      for (      CapacityVO newCapacity : newCapacities) {
        s_logger.trace("Executing capacity update");
        _capacityDao.persist(newCapacity);
        s_logger.trace("Done with capacity update");
      }
      txn.commit();
    }
 catch (    Exception ex) {
      txn.rollback();
      s_logger.error("Unable to start transaction for storage capacity update");
    }
 finally {
      txn.close();
    }
  }
 catch (  Throwable t) {
    s_logger.error("Error trying to retrieve storage stats",t);
  }
}
