{
  if (canHandle(dest,network.getTrafficType(),network.getGuestType(),network.getNetworkOfferingId())) {
    if (vm.getType() != VirtualMachine.Type.User) {
      return false;
    }
    @SuppressWarnings("unchecked") VirtualMachineProfile<UserVm> uservm=(VirtualMachineProfile<UserVm>)vm;
    Map<VirtualMachineProfile.Param,Object> params=new HashMap<VirtualMachineProfile.Param,Object>(1);
    params.put(VirtualMachineProfile.Param.ReProgramNetwork,true);
    List<DomainRouterVO> routers=_routerMgr.deployDhcp(network,dest,_accountMgr.getAccount(network.getAccountId()),uservm.getParameters());
    Long podId=dest.getPod().getId();
    DataCenter dc=dest.getDataCenter();
    boolean isPodBased=(dc.getNetworkType() == NetworkType.Basic || _networkMgr.isSecurityGroupSupportedInNetwork(network)) && network.getTrafficType() == TrafficType.Guest;
    if (isPodBased && _routerMgr.getDnsBasicZoneUpdate().equalsIgnoreCase("all")) {
      List<DomainRouterVO> allRunningRoutersOutsideThePod=_routerDao.findByNetworkOutsideThePod(network.getId(),podId,State.Running,Role.DHCP_USERDATA);
      routers.addAll(allRunningRoutersOutsideThePod);
    }
    List<VirtualRouter> rets=_routerMgr.addVirtualMachineIntoNetwork(network,nic,uservm,dest,context,routers);
    return (rets != null) && (!rets.isEmpty());
  }
 else {
    return false;
  }
}
