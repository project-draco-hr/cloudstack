{
  List<Command> commands=new ArrayList<Command>();
  List<VolumeVO> volumes=_volumeDao.findByInstance(vm.getId());
  if (volumes != null) {
    for (    VolumeVO volume : volumes) {
      if (volume.getVolumeType() == Volume.Type.DATADISK) {
        StoragePoolVO storagePool=_storagePoolDao.findById(volume.getPoolId());
        if (storagePool.isManaged()) {
          DataTO volTO=_volFactory.getVolume(volume.getId()).getTO();
          DiskTO disk=new DiskTO(volTO,volume.getDeviceId(),volume.getPath(),volume.getVolumeType());
          DettachCommand cmd=new DettachCommand(disk,vm.getInstanceName());
          cmd.setManaged(true);
          cmd.setStorageHost(storagePool.getHostAddress());
          cmd.setStoragePort(storagePool.getPort());
          cmd.set_iScsiName(volume.get_iScsiName());
          commands.add(cmd);
        }
      }
    }
  }
  return commands;
}
