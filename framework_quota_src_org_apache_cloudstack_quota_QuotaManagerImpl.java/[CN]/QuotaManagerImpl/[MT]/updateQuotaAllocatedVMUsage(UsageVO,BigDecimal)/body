{
  QuotaUsageVO quota_usage=null;
  QuotaTariffVO tariff=_quotaTariffDao.findTariffPlanByUsageType(QuotaTypes.ALLOCATED_VM,usageRecord.getEndDate());
  if (tariff != null && tariff.getCurrencyValue().compareTo(BigDecimal.ZERO) != 0) {
    BigDecimal vmusage;
    BigDecimal onehourcostforvmusage;
    onehourcostforvmusage=tariff.getCurrencyValue().multiply(aggregationRatio);
    vmusage=new BigDecimal(usageRecord.getRawUsage()).multiply(onehourcostforvmusage);
    quota_usage=new QuotaUsageVO(usageRecord.getId(),usageRecord.getZoneId(),usageRecord.getAccountId(),usageRecord.getDomainId(),QuotaTypes.ALLOCATED_VM,vmusage,usageRecord.getStartDate(),usageRecord.getEndDate());
    _quotaUsageDao.persistQuotaUsage(quota_usage);
  }
  usageRecord.setQuotaCalculated(1);
  _usageDao.persistUsage(usageRecord);
  return quota_usage;
}
