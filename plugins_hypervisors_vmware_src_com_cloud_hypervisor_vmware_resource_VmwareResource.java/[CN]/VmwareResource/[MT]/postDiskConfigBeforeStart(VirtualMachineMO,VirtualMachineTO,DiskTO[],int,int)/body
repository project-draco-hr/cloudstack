{
  VirtualMachineDiskInfoBuilder diskInfoBuilder=vmMo.getDiskInfoBuilder();
  int controllerKey;
  int ideUnitNumber=1;
  int scsiUnitNumber=0;
  for (  DiskTO vol : sortedDisks) {
    VolumeObjectTO volumeTO=(VolumeObjectTO)vol.getData();
    if (vol.getType() == Volume.Type.ISO)     continue;
    controllerKey=getDiskController(vol,vmSpec,ideControllerKey,scsiControllerKey);
    String deviceBusName;
    if (controllerKey == ideControllerKey)     deviceBusName=String.format("ide%d:%d",0,ideUnitNumber++);
 else     deviceBusName=String.format("scsi%d:%d",0,scsiUnitNumber++);
    VirtualMachineDiskInfo diskInfo=diskInfoBuilder.getDiskInfoByDeviceBusName(deviceBusName);
    assert(diskInfo != null);
    String[] diskChain=diskInfo.getDiskChain();
    assert(diskChain.length > 0);
    DatastoreFile file=new DatastoreFile(diskChain[0]);
    if (!file.getFileBaseName().equalsIgnoreCase(volumeTO.getPath())) {
      if (s_logger.isInfoEnabled())       s_logger.info("Detected disk-chain top file change on volume: " + volumeTO.getId() + " "+ volumeTO.getPath()+ " -> "+ file.getFileBaseName());
    }
    VolumeObjectTO volInSpec=getVolumeInSpec(vmSpec,volumeTO);
    volInSpec.setPath(file.getFileBaseName());
    volInSpec.setChainInfo(_gson.toJson(diskInfo));
  }
}
