{
  s_logger.info("Executing resource SetupGuestNetworkCommand " + _gson.toJson(cmd));
  VmwareManager mgr=getServiceContext().getStockObject(VmwareManager.CONTEXT_STOCK_NAME);
  NicTO nic=cmd.getNic();
  String routerIp=getRouterSshControlIp(cmd);
  String domrGIP=cmd.getAccessDetail(NetworkElementCommand.ROUTER_GUEST_IP);
  String domrName=cmd.getAccessDetail(NetworkElementCommand.ROUTER_NAME);
  String gw=cmd.getAccessDetail(NetworkElementCommand.GUEST_NETWORK_GATEWAY);
  String cidr=Long.toString(NetUtils.getCidrSize(nic.getNetmask()));
  String domainName=cmd.getNetworkDomain();
  String dns=cmd.getDefaultDns1();
  if (dns == null || dns.isEmpty()) {
    dns=cmd.getDefaultDns2();
  }
 else {
    String dns2=cmd.getDefaultDns2();
    if (dns2 != null && !dns2.isEmpty()) {
      dns+="," + dns2;
    }
  }
  try {
    int ethDeviceNum=findRouterEthDeviceIndex(domrName,routerIp,nic.getMac());
    s_logger.info("find interface index. routerIp: " + routerIp + ", mac: "+ nic.getMac()+ ", index: "+ ethDeviceNum);
    String args=(cmd.isAdd() ? "-C" : "-D");
    String dev="eth" + ethDeviceNum;
    args+=" -d " + dev;
    args+=" -i " + domrGIP;
    args+=" -g " + gw;
    args+=" -m " + cidr;
    args+=" -n " + NetUtils.getSubNet(domrGIP,nic.getNetmask());
    if (dns != null && !dns.isEmpty()) {
      args+=" -s " + dns;
    }
    if (domainName != null && !domainName.isEmpty()) {
      args+=" -e " + domainName;
    }
    Pair<Boolean,String> result=SshHelper.sshExecute(routerIp,DEFAULT_DOMR_SSHPORT,"root",mgr.getSystemVMKeyFile(),null,"/opt/cloud/bin/vpc_guestnw.sh " + args);
    if (!result.first()) {
      String msg="SetupGuestNetworkCommand on domain router " + routerIp + " failed. message: "+ result.second();
      s_logger.error(msg);
      return new SetupGuestNetworkAnswer(cmd,false,msg);
    }
    if (s_logger.isInfoEnabled()) {
      s_logger.info("SetupGuestNetworkCommand on domain router " + routerIp + " completed");
    }
    return new SetupGuestNetworkAnswer(cmd,true,"success");
  }
 catch (  Exception e) {
    String msg="SetupGuestNetwork failed due to " + e.toString();
    s_logger.warn(msg,e);
    return new SetupGuestNetworkAnswer(cmd,false,msg);
  }
}
