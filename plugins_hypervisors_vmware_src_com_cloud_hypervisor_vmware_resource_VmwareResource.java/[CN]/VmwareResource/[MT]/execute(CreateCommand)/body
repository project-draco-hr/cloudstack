{
  if (s_logger.isInfoEnabled()) {
    s_logger.info("Executing resource CreateCommand: " + _gson.toJson(cmd));
  }
  StorageFilerTO pool=cmd.getPool();
  DiskProfile dskch=cmd.getDiskCharacteristics();
  try {
    VmwareContext context=getServiceContext();
    VmwareHypervisorHost hyperHost=getHyperHost(context);
    DatacenterMO dcMo=new DatacenterMO(context,hyperHost.getHyperHostDatacenter());
    ManagedObjectReference morDatastore=HypervisorHostHelper.findDatastoreWithBackwardsCompatibility(hyperHost,pool.getUuid());
    if (morDatastore == null)     throw new Exception("Unable to find datastore in vSphere");
    DatastoreMO dsMo=new DatastoreMO(context,morDatastore);
    if (dskch.getType() == Volume.Type.ROOT) {
      String vmdkName=dskch.getName() + "-" + dskch.getVolumeId();
      if (cmd.getTemplateUrl() == null) {
        String dummyVmName=getWorkerName(context,cmd,0);
        VirtualMachineMO vmMo=null;
        try {
          vmMo=prepareVolumeHostDummyVm(hyperHost,dsMo,dummyVmName);
          if (vmMo == null) {
            throw new Exception("Unable to create a dummy VM for volume creation");
          }
          String volumeDatastorePath=String.format("[%s] %s.vmdk",dsMo.getName(),vmdkName);
synchronized (this) {
            s_logger.info("Delete file if exists in datastore to clear the way for creating the volume. file: " + volumeDatastorePath);
            VmwareHelper.deleteVolumeVmdkFiles(dsMo,vmdkName,dcMo);
            vmMo.createDisk(volumeDatastorePath,(int)(dskch.getSize() / (1024L * 1024L)),morDatastore,-1);
            vmMo.detachDisk(volumeDatastorePath,false);
          }
          VolumeTO vol=new VolumeTO(cmd.getVolumeId(),dskch.getType(),pool.getType(),pool.getUuid(),dskch.getName(),pool.getPath(),vmdkName,dskch.getSize(),null);
          return new CreateAnswer(cmd,vol);
        }
  finally {
          vmMo.detachAllDisks();
          s_logger.info("Destroy dummy VM after volume creation");
          vmMo.destroy();
        }
      }
 else {
        VirtualMachineMO vmTemplate=VmwareHelper.pickOneVmOnRunningHost(dcMo.findVmByNameAndLabel(cmd.getTemplateUrl()),true);
        if (vmTemplate == null) {
          s_logger.warn("Template host in vSphere is not in connected state, request template reload");
          return new CreateAnswer(cmd,"Template host in vSphere is not in connected state, request template reload",true);
        }
        ManagedObjectReference morPool=hyperHost.getHyperHostOwnerResourcePool();
        ManagedObjectReference morCluster=hyperHost.getHyperHostCluster();
        if (!_fullCloneFlag) {
          createVMLinkedClone(vmTemplate,dcMo,dsMo,vmdkName,morDatastore,morPool);
        }
 else {
          createVMFullClone(vmTemplate,dcMo,dsMo,vmdkName,morDatastore,morPool);
        }
        VirtualMachineMO vmMo=new ClusterMO(context,morCluster).findVmOnHyperHost(vmdkName);
        assert(vmMo != null);
        s_logger.info("detach disks from volume-wrapper VM " + vmdkName);
        vmMo.detachAllDisks();
        s_logger.info("destroy volume-wrapper VM " + vmdkName);
        vmMo.destroy();
        String srcFile=String.format("[%s] %s/",dsMo.getName(),vmdkName);
        dsMo.deleteFile(srcFile,dcMo.getMor(),true);
        VolumeTO vol=new VolumeTO(cmd.getVolumeId(),dskch.getType(),pool.getType(),pool.getUuid(),dskch.getName(),pool.getPath(),vmdkName,dskch.getSize(),null);
        return new CreateAnswer(cmd,vol);
      }
    }
 else {
      VirtualMachineMO vmMo=null;
      String volumeUuid=UUID.randomUUID().toString().replace("-","");
      String volumeDatastorePath=String.format("[%s] %s.vmdk",dsMo.getName(),volumeUuid);
      String dummyVmName=getWorkerName(context,cmd,0);
      try {
        vmMo=prepareVolumeHostDummyVm(hyperHost,dsMo,dummyVmName);
        if (vmMo == null) {
          throw new Exception("Unable to create a dummy VM for volume creation");
        }
synchronized (this) {
          VmwareHelper.deleteVolumeVmdkFiles(dsMo,volumeUuid.toString(),dcMo);
          vmMo.createDisk(volumeDatastorePath,(int)(dskch.getSize() / (1024L * 1024L)),morDatastore,vmMo.getScsiDeviceControllerKey());
          vmMo.detachDisk(volumeDatastorePath,false);
        }
        VolumeTO vol=new VolumeTO(cmd.getVolumeId(),dskch.getType(),pool.getType(),pool.getUuid(),dskch.getName(),pool.getPath(),volumeUuid,dskch.getSize(),null);
        return new CreateAnswer(cmd,vol);
      }
  finally {
        s_logger.info("Destroy dummy VM after volume creation");
        vmMo.detachAllDisks();
        vmMo.destroy();
      }
    }
  }
 catch (  Throwable e) {
    if (e instanceof RemoteException) {
      s_logger.warn("Encounter remote exception to vCenter, invalidate VMware session context");
      invalidateServiceContext();
    }
    String msg="CreateCommand failed due to " + VmwareHelper.getExceptionMessage(e);
    s_logger.error(msg,e);
    return new CreateAnswer(cmd,new Exception(e));
  }
}
