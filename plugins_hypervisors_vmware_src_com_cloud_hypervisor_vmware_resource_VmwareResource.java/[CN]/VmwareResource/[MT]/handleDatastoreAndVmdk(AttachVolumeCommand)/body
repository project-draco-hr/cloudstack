{
  ManagedObjectReference morDs=null;
  VmwareContext context=getServiceContext();
  VmwareHypervisorHost hyperHost=getHyperHost(context);
  String iqn=cmd.get_iScsiName();
  if (cmd.getAttach()) {
    morDs=createVmfsDatastore(hyperHost,iqn,cmd.getStorageHost(),cmd.getStoragePort(),iqn,cmd.getChapInitiatorUsername(),cmd.getChapInitiatorPassword(),cmd.getChapTargetUsername(),cmd.getChapTargetPassword());
    DatastoreMO dsMo=new DatastoreMO(context,morDs);
    String volumeDatastorePath=String.format("[%s] %s.vmdk",dsMo.getName(),dsMo.getName());
    if (!dsMo.fileExists(volumeDatastorePath)) {
      String dummyVmName=getWorkerName(context,cmd,0);
      VirtualMachineMO vmMo=prepareVolumeHostDummyVm(hyperHost,dsMo,dummyVmName);
      if (vmMo == null) {
        throw new Exception("Unable to create a dummy VM for volume creation");
      }
      vmMo.createDisk(volumeDatastorePath,getMBsFromBytes(dsMo.getSummary().getFreeSpace()),morDs,vmMo.getScsiDeviceControllerKey());
      vmMo.detachDisk(volumeDatastorePath,false);
    }
  }
 else {
    deleteVmfsDatastore(hyperHost,iqn,cmd.getStorageHost(),cmd.getStoragePort(),iqn);
  }
  return morDs;
}
