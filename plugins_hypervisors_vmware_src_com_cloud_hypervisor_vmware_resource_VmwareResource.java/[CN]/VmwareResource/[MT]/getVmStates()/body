{
  VmwareHypervisorHost hyperHost=getHyperHost(getServiceContext());
  ObjectContent[] ocs=hyperHost.getVmPropertiesOnHyperHost(new String[]{"name","runtime.powerState","config.template"});
  HashMap<String,State> newStates=new HashMap<String,State>();
  if (ocs != null && ocs.length > 0) {
    for (    ObjectContent oc : ocs) {
      List<DynamicProperty> objProps=oc.getPropSet();
      if (objProps != null) {
        boolean isTemplate=false;
        String name=null;
        String VMInternalCSName=null;
        VirtualMachinePowerState powerState=VirtualMachinePowerState.POWERED_OFF;
        for (        DynamicProperty objProp : objProps) {
          if (objProp.getName().equals("config.template")) {
            if (objProp.getVal().toString().equalsIgnoreCase("true")) {
              isTemplate=true;
            }
          }
 else           if (objProp.getName().equals("runtime.powerState")) {
            powerState=(VirtualMachinePowerState)objProp.getVal();
          }
 else           if (objProp.getName().equals("name")) {
            name=(String)objProp.getVal();
          }
 else {
            assert(false);
          }
        }
        VirtualMachineMO vmMo=new VirtualMachineMO(hyperHost.getContext(),oc.getObj());
        VMInternalCSName=vmMo.getCustomFieldValue(CustomFieldConstants.CLOUD_VM_INTERNAL_NAME);
        if (VMInternalCSName != null)         name=VMInternalCSName;
        if (!isTemplate) {
          newStates.put(name,convertState(powerState));
        }
      }
    }
  }
  return newStates;
}
