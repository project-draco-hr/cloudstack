{
  String volumePath=cmd.getVolumePath();
  StorageFilerTO poolTo=cmd.getPool();
  if (s_logger.isInfoEnabled()) {
    s_logger.info("Executing resource MigrateVolumeCommand: " + _gson.toJson(cmd));
  }
  String vmName=cmd.getAttachedVmName();
  VirtualMachineMO vmMo=null;
  VmwareHypervisorHost srcHyperHost=null;
  ManagedObjectReference morDs=null;
  ManagedObjectReference morDc=null;
  VirtualMachineRelocateSpec relocateSpec=new VirtualMachineRelocateSpec();
  List<VirtualMachineRelocateSpecDiskLocator> diskLocators=new ArrayList<VirtualMachineRelocateSpecDiskLocator>();
  VirtualMachineRelocateSpecDiskLocator diskLocator=null;
  String tgtDsName="";
  try {
    srcHyperHost=getHyperHost(getServiceContext());
    morDc=srcHyperHost.getHyperHostDatacenter();
    tgtDsName=poolTo.getUuid();
    DatacenterMO dcMo=new DatacenterMO(getServiceContext(),morDc);
    vmMo=dcMo.findVm(vmName);
    if (vmMo == null) {
      String msg="VM " + vmName + " does not exist in VMware datacenter "+ morDc.getValue();
      s_logger.error(msg);
      throw new Exception(msg);
    }
    vmName=vmMo.getName();
    morDs=HypervisorHostHelper.findDatastoreWithBackwardsCompatibility(srcHyperHost,tgtDsName);
    if (morDs == null) {
      String msg="Unable to find the mounted datastore with name " + tgtDsName + " to execute MigrateVolumeCommand";
      s_logger.error(msg);
      throw new Exception(msg);
    }
    DatastoreMO targetDsMo=new DatastoreMO(srcHyperHost.getContext(),morDs);
    String fullVolumePath=VmwareStorageLayoutHelper.getVmwareDatastorePathFromVmdkFileName(targetDsMo,vmName,volumePath + ".vmdk");
    int diskId=getVirtualDiskInfo(vmMo,volumePath + ".vmdk");
    diskLocator=new VirtualMachineRelocateSpecDiskLocator();
    diskLocator.setDatastore(morDs);
    diskLocator.setDiskId(diskId);
    diskLocators.add(diskLocator);
    relocateSpec.getDisk().add(diskLocator);
    if (!vmMo.changeDatastore(relocateSpec)) {
      throw new Exception("Change datastore operation failed during volume migration");
    }
 else {
      s_logger.debug("Successfully migrated volume " + volumePath + " to target datastore "+ tgtDsName);
    }
    String apiVersion=HypervisorHostHelper.getVcenterApiVersion(vmMo.getContext());
    if (apiVersion.compareTo("5.0") >= 0) {
      if (!vmMo.consolidateVmDisks()) {
        s_logger.warn("VM disk consolidation failed after storage migration.");
      }
 else {
        s_logger.debug("Successfully consolidated disks of VM " + vmName + ".");
      }
    }
    if (!targetDsMo.fileExists(fullVolumePath)) {
      VirtualDisk[] disks=vmMo.getAllDiskDevice();
      for (      VirtualDisk disk : disks)       if (disk.getKey() == diskId) {
        volumePath=vmMo.getVmdkFileBaseName(disk);
      }
    }
    return new MigrateVolumeAnswer(cmd,true,null,volumePath);
  }
 catch (  Exception e) {
    String msg="Catch Exception " + e.getClass().getName() + " due to "+ e.toString();
    s_logger.error(msg,e);
    return new MigrateVolumeAnswer(cmd,false,msg,null);
  }
}
