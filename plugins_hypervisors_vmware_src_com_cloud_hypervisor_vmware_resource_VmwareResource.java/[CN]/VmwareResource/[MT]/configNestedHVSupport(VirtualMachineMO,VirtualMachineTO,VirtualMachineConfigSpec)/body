{
  VmwareContext context=vmMo.getContext();
  if ("true".equals(vmSpec.getDetails().get(VmDetailConstants.NESTED_VIRTUALIZATION_FLAG))) {
    if (s_logger.isDebugEnabled())     s_logger.debug("Nested Virtualization enabled in configuration, checking hypervisor capability");
    ManagedObjectReference hostMor=vmMo.getRunningHost().getMor();
    ManagedObjectReference computeMor=context.getVimClient().getMoRefProp(hostMor,"parent");
    ManagedObjectReference environmentBrowser=context.getVimClient().getMoRefProp(computeMor,"environmentBrowser");
    HostCapability hostCapability=context.getService().queryTargetCapabilities(environmentBrowser,hostMor);
    Boolean nestedHvSupported=hostCapability.isNestedHVSupported();
    if (nestedHvSupported == null) {
      s_logger.warn("Hypervisor doesn't support nested virtualization, unable to set config for VM " + vmSpec.getName());
    }
 else     if (nestedHvSupported.booleanValue()) {
      s_logger.debug("Hypervisor supports nested virtualization, enabling for VM " + vmSpec.getName());
      vmConfigSpec.setNestedHVEnabled(true);
    }
 else {
      s_logger.warn("Hypervisor doesn't support nested virtualization, unable to set config for VM " + vmSpec.getName());
      vmConfigSpec.setNestedHVEnabled(false);
    }
  }
}
