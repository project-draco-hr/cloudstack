{
  if (_template != null) {
    TemplateDataStoreVO updateBuilder=_vmTemplateStoreDao.createForUpdate();
    updateBuilder.setDownloadPercent(answer.getDownloadPct());
    updateBuilder.setDownloadState(answer.getDownloadStatus());
    updateBuilder.setLastUpdated(new Date());
    updateBuilder.setErrorString(answer.getErrorString());
    updateBuilder.setJobId(answer.getJobId());
    updateBuilder.setLocalDownloadPath(answer.getDownloadPath());
    updateBuilder.setInstallPath(answer.getInstallPath());
    updateBuilder.setSize(answer.getTemplateSize());
    updateBuilder.setPhysicalSize(answer.getTemplatePhySicalSize());
    Status dndStatus=answer.getDownloadStatus();
    if (_callback != null) {
      if (dndStatus == Status.DOWNLOAD_ERROR) {
        CreateCmdResult result=new CreateCmdResult(null,null);
        result.setSucess(false);
        result.setResult("Download template failed");
        _callback.complete(result);
      }
 else       if (dndStatus == Status.DOWNLOADED) {
        CreateCmdResult result=new CreateCmdResult(null,null);
        _callback.complete(result);
      }
    }
 else {
      if (dndStatus == Status.DOWNLOAD_ERROR) {
        updateBuilder.setState(ObjectInDataStoreStateMachine.State.Failed);
      }
 else       if (dndStatus == Status.DOWNLOAD_IN_PROGRESS) {
        updateBuilder.setState(ObjectInDataStoreStateMachine.State.Creating2);
      }
 else       if (dndStatus == Status.DOWNLOADED) {
        updateBuilder.setState(ObjectInDataStoreStateMachine.State.Ready);
      }
    }
    _vmTemplateStoreDao.update(getTemplateStoreId(),updateBuilder);
    if (answer.getCheckSum() != null) {
      VMTemplateVO templateDaoBuilder=_vmTemplateDao.createForUpdate();
      templateDaoBuilder.setChecksum(answer.getCheckSum());
      _vmTemplateDao.update(_template.getId(),templateDaoBuilder);
    }
    if (answer.getTemplateSize() > 0) {
      long accountId=_template.getAccountId();
      try {
        _resourceLimitMgr.checkResourceLimit(_accountMgr.getAccount(accountId),com.cloud.configuration.Resource.ResourceType.secondary_storage,answer.getTemplateSize() - UriUtils.getRemoteSize(_template.getUrl()));
      }
 catch (      ResourceAllocationException e) {
        s_logger.warn(e.getMessage());
        _alertMgr.sendAlert(_alertMgr.ALERT_TYPE_RESOURCE_LIMIT_EXCEEDED,_sserver.getDataCenterId(),null,e.getMessage(),e.getMessage());
      }
 finally {
        _resourceLimitMgr.recalculateResourceCount(accountId,_accountMgr.getAccount(accountId).getDomainId(),com.cloud.configuration.Resource.ResourceType.secondary_storage.getOrdinal());
      }
    }
  }
 else {
    VolumeHostVO updateBuilder=_volumeHostDao.createForUpdate();
    updateBuilder.setDownloadPercent(answer.getDownloadPct());
    updateBuilder.setDownloadState(answer.getDownloadStatus());
    updateBuilder.setLastUpdated(new Date());
    updateBuilder.setErrorString(answer.getErrorString());
    updateBuilder.setJobId(answer.getJobId());
    updateBuilder.setLocalDownloadPath(answer.getDownloadPath());
    updateBuilder.setInstallPath(answer.getInstallPath());
    updateBuilder.setSize(answer.getTemplateSize());
    updateBuilder.setPhysicalSize(answer.getTemplatePhySicalSize());
    _volumeHostDao.update(getVolumeHostId(),updateBuilder);
    VolumeVO updateVolume=_volumeDao.createForUpdate();
    updateVolume.setSize(answer.getTemplateSize());
    _volumeDao.update(_volume.getId(),updateVolume);
    if (answer.getTemplateSize() > 0) {
      try {
        String url=_volumeHostDao.findByVolumeId(_volume.getId()).getDownloadUrl();
        _resourceLimitMgr.checkResourceLimit(_accountMgr.getAccount(_volume.getAccountId()),com.cloud.configuration.Resource.ResourceType.secondary_storage,answer.getTemplateSize() - UriUtils.getRemoteSize(url));
      }
 catch (      ResourceAllocationException e) {
        s_logger.warn(e.getMessage());
        _alertMgr.sendAlert(_alertMgr.ALERT_TYPE_RESOURCE_LIMIT_EXCEEDED,_volume.getDataCenterId(),_volume.getPodId(),e.getMessage(),e.getMessage());
      }
 finally {
        _resourceLimitMgr.recalculateResourceCount(_volume.getAccountId(),_volume.getDomainId(),com.cloud.configuration.Resource.ResourceType.secondary_storage.getOrdinal());
      }
    }
  }
}
