{
  if (template != null) {
    TemplateDataStoreVO updateBuilder=_vmTemplateStoreDao.createForUpdate();
    updateBuilder.setDownloadPercent(answer.getDownloadPct());
    updateBuilder.setDownloadState(answer.getDownloadStatus());
    updateBuilder.setLastUpdated(new Date());
    updateBuilder.setErrorString(answer.getErrorString());
    updateBuilder.setJobId(answer.getJobId());
    updateBuilder.setLocalDownloadPath(answer.getDownloadPath());
    updateBuilder.setInstallPath(answer.getInstallPath());
    updateBuilder.setSize(answer.getTemplateSize());
    updateBuilder.setPhysicalSize(answer.getTemplatePhySicalSize());
    _vmTemplateStoreDao.update(getTemplateStoreId(),updateBuilder);
    if (answer.getCheckSum() != null) {
      VMTemplateVO templateDaoBuilder=_vmTemplateDao.createForUpdate();
      templateDaoBuilder.setChecksum(answer.getCheckSum());
      _vmTemplateDao.update(template.getId(),templateDaoBuilder);
    }
    if (answer.getTemplateSize() > 0) {
      long accountId=template.getAccountId();
      try {
        _resourceLimitMgr.checkResourceLimit(_accountMgr.getAccount(accountId),com.cloud.configuration.Resource.ResourceType.secondary_storage,answer.getTemplateSize() - UriUtils.getRemoteSize(template.getUrl()));
      }
 catch (      ResourceAllocationException e) {
        s_logger.warn(e.getMessage());
        _alertMgr.sendAlert(_alertMgr.ALERT_TYPE_RESOURCE_LIMIT_EXCEEDED,sserver.getDataCenterId(),null,e.getMessage(),e.getMessage());
      }
 finally {
        _resourceLimitMgr.recalculateResourceCount(accountId,_accountMgr.getAccount(accountId).getDomainId(),com.cloud.configuration.Resource.ResourceType.secondary_storage.getOrdinal());
      }
    }
    Status dndStatus=answer.getDownloadStatus();
    if (dndStatus == Status.DOWNLOAD_ERROR || dndStatus == Status.DOWNLOADED) {
      if (callback != null) {
        CreateCmdResult result=new CreateCmdResult(null,null);
        callback.complete(result);
      }
    }
  }
 else {
    VolumeHostVO updateBuilder=volumeHostDao.createForUpdate();
    updateBuilder.setDownloadPercent(answer.getDownloadPct());
    updateBuilder.setDownloadState(answer.getDownloadStatus());
    updateBuilder.setLastUpdated(new Date());
    updateBuilder.setErrorString(answer.getErrorString());
    updateBuilder.setJobId(answer.getJobId());
    updateBuilder.setLocalDownloadPath(answer.getDownloadPath());
    updateBuilder.setInstallPath(answer.getInstallPath());
    updateBuilder.setSize(answer.getTemplateSize());
    updateBuilder.setPhysicalSize(answer.getTemplatePhySicalSize());
    volumeHostDao.update(getVolumeHostId(),updateBuilder);
    VolumeVO updateVolume=_volumeDao.createForUpdate();
    updateVolume.setSize(answer.getTemplateSize());
    _volumeDao.update(volume.getId(),updateVolume);
    if (answer.getTemplateSize() > 0) {
      try {
        String url=volumeHostDao.findByVolumeId(volume.getId()).getDownloadUrl();
        _resourceLimitMgr.checkResourceLimit(_accountMgr.getAccount(volume.getAccountId()),com.cloud.configuration.Resource.ResourceType.secondary_storage,answer.getTemplateSize() - UriUtils.getRemoteSize(url));
      }
 catch (      ResourceAllocationException e) {
        s_logger.warn(e.getMessage());
        _alertMgr.sendAlert(_alertMgr.ALERT_TYPE_RESOURCE_LIMIT_EXCEEDED,volume.getDataCenterId(),volume.getPodId(),e.getMessage(),e.getMessage());
      }
 finally {
        _resourceLimitMgr.recalculateResourceCount(volume.getAccountId(),volume.getDomainId(),com.cloud.configuration.Resource.ResourceType.secondary_storage.getOrdinal());
      }
    }
  }
}
