{
  long dcId=plan.getDataCenterId();
  long podId=plan.getPodId();
  long clusterId=plan.getClusterId();
  ServiceOffering offering=vmProfile.getServiceOffering();
  VMTemplateVO template=(VMTemplateVO)vmProfile.getTemplate();
  if (type == Host.Type.Storage) {
    return new ArrayList<Host>();
  }
  String hostTag=offering.getHostTag();
  if (hostTag != null) {
    s_logger.debug("Looking for hosts in dc: " + dcId + "  pod:"+ podId+ "  cluster:"+ clusterId+ " having host tag:"+ hostTag);
  }
 else {
    s_logger.debug("Looking for hosts in dc: " + dcId + "  pod:"+ podId+ "  cluster:"+ clusterId);
  }
  List<HostVO> clusterHosts=new ArrayList<HostVO>();
  if (hostTag != null) {
    clusterHosts=_hostDao.listByHostTag(type,clusterId,podId,dcId,hostTag);
  }
 else {
    clusterHosts=_hostDao.listBy(type,clusterId,podId,dcId);
  }
  return allocateTo(offering,template,avoid,clusterHosts,returnUpTo);
}
