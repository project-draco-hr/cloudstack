{
  Pod pod=dest.getPod();
  String ipAddress=null;
  Long macLong=null;
  Integer cidrSize=null;
  StorageNetworkIpAddressVO ip=_sNwMgr.acquireIpAddress(pod.getId());
  if (ip != null) {
    ipAddress=ip.getIpAddress();
    macLong=ip.getMac();
    cidrSize=ip.getCidrSize();
  }
 else {
    s_logger.debug("Can not get an ip from storage network ip range for pod " + pod.getId() + ", acquire one from managment ip range");
    Pair<String,Long> ip1=_dcDao.allocatePrivateIpAddress(dest.getDataCenter().getId(),pod.getId(),nic.getId(),context.getReservationId());
    if (ip1 == null) {
      throw new InsufficientAddressCapacityException("Unable to get a storage network ip address",Pod.class,pod.getId());
    }
    ipAddress=ip1.first();
    macLong=ip1.second();
    cidrSize=pod.getCidrSize();
  }
  nic.setIp4Address(ipAddress);
  nic.setMacAddress(NetUtils.long2Mac(NetUtils.createSequenceBasedMacAddress(macLong)));
  nic.setFormat(AddressFormat.Ip4);
  nic.setNetmask(NetUtils.getCidrNetmask(cidrSize));
  nic.setBroadcastType(BroadcastDomainType.Native);
  nic.setBroadcastUri(null);
  nic.setIsolationUri(null);
  s_logger.debug("Allocated a nic " + nic + " for "+ vm);
}
