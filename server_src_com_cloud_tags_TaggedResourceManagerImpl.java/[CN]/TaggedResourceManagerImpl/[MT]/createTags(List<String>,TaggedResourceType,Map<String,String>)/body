{
  Account caller=UserContext.current().getCaller();
  List<ResourceTag> resourceTags=new ArrayList<ResourceTag>(tags.size());
  Transaction txn=Transaction.currentTxn();
  txn.start();
  for (  String tag : tags.keySet()) {
    for (    String resourceId : resourceIds) {
      Long id=getResourceId(resourceId,resourceType);
      if (_daoMap.get(resourceType).findById(id) == null) {
        throw new InvalidParameterValueException("Unable to find resource by id " + resourceId + " and type "+ resourceType);
      }
      Pair<Long,Long> accountDomainPair=getAccountDomain(id,resourceType);
      Long domainId=accountDomainPair.second();
      Long accountId=accountDomainPair.first();
      if (accountId != null) {
        _accountMgr.checkAccess(caller,null,false,_accountMgr.getAccount(accountId));
      }
 else       if (domainId != null && caller.getType() != Account.ACCOUNT_TYPE_NORMAL) {
        _accountMgr.checkAccess(caller,_domainMgr.getDomain(domainId));
      }
 else {
        throw new PermissionDeniedException("Account " + caller + " doesn't have permissions to create tags"+ " for resource "+ tag);
      }
      ResourceTagVO resourceTag=new ResourceTagVO(tag,tags.get(tag),accountDomainPair.first(),accountDomainPair.second(),id,resourceType);
      resourceTag=_resourceTagDao.persist(resourceTag);
      resourceTags.add(resourceTag);
    }
  }
  txn.commit();
  return resourceTags;
}
