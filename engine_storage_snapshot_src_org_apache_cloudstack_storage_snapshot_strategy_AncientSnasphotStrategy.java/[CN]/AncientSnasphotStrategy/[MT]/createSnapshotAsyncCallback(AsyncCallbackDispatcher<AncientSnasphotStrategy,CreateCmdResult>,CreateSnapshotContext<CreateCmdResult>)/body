{
  CreateCmdResult result=callback.getResult();
  SnapshotObject snapshot=(SnapshotObject)context.snapshot;
  VolumeInfo volume=context.volume;
  AsyncCallFuture<SnapshotResult> future=context.future;
  SnapshotResult snapResult=new SnapshotResult(snapshot);
  if (result.isFailed()) {
    s_logger.debug("create snapshot " + context.snapshot.getName() + " failed: "+ result.getResult());
    try {
      snapshot.processEvent(Snapshot.Event.OperationFailed);
    }
 catch (    NoTransitionException nte) {
      s_logger.debug("Failed to update snapshot state due to " + nte.getMessage());
    }
    snapResult.setResult(result.getResult());
    future.complete(snapResult);
    return null;
  }
  try {
    SnapshotVO preSnapshotVO=this.snapshotMgr.getParentSnapshot(volume,snapshot);
    String preSnapshotPath=preSnapshotVO.getPath();
    SnapshotVO snapshotVO=this.snapshotDao.findById(snapshot.getId());
    if (preSnapshotPath != null && preSnapshotPath.equals(result.getPath())) {
      s_logger.debug("CreateSnapshot: this is empty snapshot ");
      snapshotVO.setPath(preSnapshotPath);
      snapshotVO.setBackupSnapshotId(preSnapshotVO.getBackupSnapshotId());
      snapshotVO.setSwiftId(preSnapshotVO.getSwiftId());
      snapshotVO.setPrevSnapshotId(preSnapshotVO.getId());
      snapshotVO.setSecHostId(preSnapshotVO.getSecHostId());
      snapshot.processEvent(Snapshot.Event.OperationNotPerformed);
    }
 else {
      long preSnapshotId=0;
      if (preSnapshotVO != null && preSnapshotVO.getBackupSnapshotId() != null) {
        preSnapshotId=preSnapshotVO.getId();
        int _deltaSnapshotMax=NumbersUtil.parseInt(_configDao.getValue("snapshot.delta.max"),SnapshotManager.DELTAMAX);
        int deltaSnap=_deltaSnapshotMax;
        int i;
        for (i=1; i < deltaSnap; i++) {
          String prevBackupUuid=preSnapshotVO.getBackupSnapshotId();
          if (prevBackupUuid == null) {
            preSnapshotId=0;
            break;
          }
          long preSSId=preSnapshotVO.getPrevSnapshotId();
          if (preSSId == 0) {
            break;
          }
          preSnapshotVO=_snapshotDao.findByIdIncludingRemoved(preSSId);
        }
        if (i >= deltaSnap) {
          preSnapshotId=0;
        }
      }
      if (volume.getLastPoolId() != null && !volume.getLastPoolId().equals(volume.getPoolId())) {
        preSnapshotId=0;
        VolumeVO volumeVO=this.volumeDao.findById(volume.getId());
        volumeVO.setLastPoolId(volume.getPoolId());
        this.volumeDao.update(volume.getId(),volumeVO);
      }
      snapshot.setPath(result.getPath());
      snapshot.setPrevSnapshotId(preSnapshotId);
      snapshot.processEvent(Snapshot.Event.OperationSucceeded);
      snapResult=new SnapshotResult(this.snapshotfactory.getSnapshot(snapshot.getId()));
    }
  }
 catch (  Exception e) {
    s_logger.debug("Failed to create snapshot: ",e);
    snapResult.setResult(e.toString());
  }
  future.complete(snapResult);
  return null;
}
