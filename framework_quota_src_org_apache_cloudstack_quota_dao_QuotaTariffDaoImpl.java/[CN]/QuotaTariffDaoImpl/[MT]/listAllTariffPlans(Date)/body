{
  return Transaction.execute(TransactionLegacy.USAGE_DB,new TransactionCallback<List<QuotaTariffVO>>(){
    @Override public List<QuotaTariffVO> doInTransaction(    final TransactionStatus status){
      List<QuotaTariffVO> tariffs=new ArrayList<QuotaTariffVO>();
      final Filter filter=new Filter(QuotaTariffVO.class,"updatedOn",false,0L,1L);
      final SearchCriteria<QuotaTariffVO> sc=listAllIncludedUsageType.create();
      sc.setParameters("onorbefore",effectiveDate);
      for (      Integer quotaType : QuotaTypes.listQuotaTypes().keySet()) {
        sc.setParameters("quotatype",quotaType);
        List<QuotaTariffVO> result=search(sc,filter);
        if (result != null && !result.isEmpty()) {
          tariffs.add(result.get(0));
          if (s_logger.isDebugEnabled()) {
            s_logger.debug("ListAllTariffPlans on or before " + effectiveDate + " quota type "+ result.get(0).getDescription()+ " , effective Date="+ result.get(0).getEffectiveOn()+ " val="+ result.get(0).getCurrencyValue());
          }
        }
      }
      return tariffs;
    }
  }
);
}
