def _gcLoop(sr, dryRun):
    failedCandidates = []
    while True:
        if (not sr.xapi.isPluggedHere()):
            Util.log('SR no longer attached, exiting')
            break
        sr.scanLocked()
        if (not sr.hasWork()):
            Util.log('No work, exiting')
            break
        if (not lockRunning.acquireNoblock()):
            Util.log('Another instance already running, exiting')
            break
        try:
            sr.cleanupCoalesceJournals()
            sr.scanLocked()
            sr.updateBlockInfo()
            if (len(sr.findGarbage()) > 0):
                sr.garbageCollect(dryRun)
                sr.xapi.srUpdate()
                continue
            candidate = sr.findCoalesceable()
            if candidate:
                util.fistpoint.activate('LVHDRT_finding_a_suitable_pair', sr.uuid)
                sr.coalesce(candidate, dryRun)
                sr.xapi.srUpdate()
                continue
            candidate = sr.findLeafCoalesceable()
            if candidate:
                sr.coalesceLeaf(candidate, dryRun)
                sr.xapi.srUpdate()
                continue
            Util.log('No work left')
        finally:
            lockRunning.release()
