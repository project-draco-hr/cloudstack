def _snapshotCoalesce(self, vdi):
    assert AUTO_ONLINE_LEAF_COALESCE_ENABLED
    Util.log(('Single-snapshotting %s' % vdi.toString()))
    util.fistpoint.activate('LVHDRT_coaleaf_delay_1', self.uuid)
    try:
        ret = self.xapi.singleSnapshotVDI(vdi)
        Util.log(('Single-snapshot returned: %s' % ret))
    except XenAPI.Failure as e:
        if self.xapi.isInvalidHandleError(e):
            Util.log('The VDI appears to have been concurrently deleted')
            return False
        raise
    self.scanLocked()
    tempSnap = vdi.parent
    if (not tempSnap.isCoalesceable()):
        Util.log('The VDI appears to have been concurrently snapshotted')
        return False
    Util.log(('Coalescing parent %s' % tempSnap.toString()))
    util.fistpoint.activate('LVHDRT_coaleaf_delay_2', self.uuid)
    self._coalesce(tempSnap)
    self.deleteVDI(tempSnap)
    if (not vdi.isLeafCoalesceable()):
        Util.log('The VDI tree appears to have been altered since')
        return False
    return True
