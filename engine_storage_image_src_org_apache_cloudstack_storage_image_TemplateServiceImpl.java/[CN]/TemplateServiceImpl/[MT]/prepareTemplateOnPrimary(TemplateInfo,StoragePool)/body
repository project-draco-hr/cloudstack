{
  AsyncCallFuture<TemplateApiResult> future=new AsyncCallFuture<TemplateApiResult>();
  TemplateApiResult res=new TemplateApiResult(srcTemplate);
  long poolId=pool.getId();
  long templateId=srcTemplate.getId();
  try {
    VMTemplateStoragePoolVO templateStoragePoolRef=_tmpltPoolDao.findByPoolTemplate(poolId,templateId);
    if (templateStoragePoolRef == null) {
      templateStoragePoolRef=new VMTemplateStoragePoolVO(poolId,templateId);
      templateStoragePoolRef=_tmpltPoolDao.persist(templateStoragePoolRef);
    }
    DataStore destStore=(DataStore)pool;
    TemplateInfo destTemplate=this._templateFactory.getTemplate(templateStoragePoolRef.getTemplateId(),destStore);
    destTemplate.processEvent(Event.CreateOnlyRequested);
    srcTemplate.processEvent(Event.CopyingRequested);
    CopyTemplateContext<TemplateApiResult> context=new CopyTemplateContext<TemplateApiResult>(null,future,srcTemplate,destTemplate,destStore);
    AsyncCallbackDispatcher<TemplateServiceImpl,CopyCommandResult> caller=AsyncCallbackDispatcher.create(this);
    caller.setCallback(caller.getTarget().prepareTemplateCallBack(null,null)).setContext(context);
    this._motionSrv.copyAsync(srcTemplate,destTemplate,caller);
  }
 catch (  Exception e) {
    s_logger.debug("Failed to prepare template on storage pool",e);
    res.setResult(e.toString());
    future.complete(res);
  }
  return future;
}
