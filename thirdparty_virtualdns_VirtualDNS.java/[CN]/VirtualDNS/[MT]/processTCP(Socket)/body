{
  try {
    int inLength;
    DataInputStream dataIn;
    DataOutputStream dataOut;
    byte[] in;
    s.setSoTimeout(TCP_TIMEOUT);
    try {
      InputStream is=s.getInputStream();
      dataIn=new DataInputStream(is);
      inLength=dataIn.readUnsignedShort();
      in=new byte[inLength];
      dataIn.readFully(in);
    }
 catch (    InterruptedIOException e) {
      s.close();
      return;
    }
    Message query, response;
    try {
      query=new Message(in);
      response=generateReply(query,in,s,s.getInetAddress());
      if (response == null)       return;
    }
 catch (    IOException e) {
      response=ErrorMessages.makeFormatErrorMessage(in);
    }
    byte[] out=response.toWire();
    dataOut=new DataOutputStream(s.getOutputStream());
    dataOut.writeShort(out.length);
    dataOut.write(out);
  }
 catch (  IOException e) {
    logger.error("processTCP: " + e);
  }
 finally {
    try {
      s.close();
    }
 catch (    IOException e) {
    }
  }
}
