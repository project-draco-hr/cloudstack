{
  Long userId=UserContext.current().getUserId();
  String zoneName=cmd.getZoneName();
  String dns1=cmd.getDns1();
  String dns2=cmd.getDns2();
  String internalDns1=cmd.getInternalDns1();
  String internalDns2=cmd.getInternalDns2();
  String vnetRange=cmd.getVlan();
  String guestCidr=cmd.getGuestCidrAddress();
  if (userId == null) {
    userId=User.UID_SYSTEM;
  }
  int vnetStart, vnetEnd;
  if (vnetRange != null) {
    String[] tokens=vnetRange.split("-");
    try {
      vnetStart=Integer.parseInt(tokens[0]);
      if (tokens.length == 1) {
        vnetEnd=vnetStart + 1;
      }
 else {
        vnetEnd=Integer.parseInt(tokens[1]);
      }
    }
 catch (    NumberFormatException e) {
      throw new InvalidParameterValueException("Please specify valid integers for the vlan range.");
    }
  }
 else {
    String networkType=_configDao.getValue("network.type");
    if (networkType != null && networkType.equals("vnet")) {
      vnetStart=1000;
      vnetEnd=2000;
    }
 else {
      throw new InvalidParameterValueException("Please specify a vlan range.");
    }
  }
  if ((guestCidr != null) && !NetUtils.isValidCIDR(guestCidr)) {
    throw new InvalidParameterValueException("Please enter a valid guest cidr");
  }
  checkZoneParameters(zoneName,dns1,dns2,internalDns1,internalDns2,true);
  DataCenterVO zone=new DataCenterVO(null,zoneName,null,dns1,dns2,internalDns1,internalDns2,vnetRange,guestCidr);
  zone=_zoneDao.persist(zone);
  _zoneDao.addVnet(zone.getId(),vnetStart,vnetEnd);
  saveConfigurationEvent(userId,null,EventTypes.EVENT_ZONE_CREATE,"Successfully created new zone with name: " + zoneName + ".","dcId=" + zone.getId(),"dns1=" + dns1,"dns2=" + dns2,"internalDns1=" + internalDns1,"internalDns2=" + internalDns2,"vnetRange=" + vnetRange,"guestCidr=" + guestCidr);
  return zone;
}
