{
  if (podId != null && ((_podDao.findById(podId)) == null)) {
    throw new InvalidParameterValueException("Please specify a valid pod.");
  }
  if (podId != null && _podDao.findById(podId).getDataCenterId() != zoneId) {
    throw new InvalidParameterValueException("Pod id=" + podId + " doesn't belong to zone id="+ zoneId);
  }
  if (vlanId == null) {
    vlanId=Vlan.UNTAGGED;
  }
  DataCenterVO zone;
  if (zoneId == null || ((zone=_zoneDao.findById(zoneId)) == null)) {
    throw new InvalidParameterValueException("Please specify a valid zone.");
  }
  PhysicalNetworkVO pNtwk;
  if (physicalNetworkId == null || ((pNtwk=_physicalNetworkDao.findById(physicalNetworkId)) == null)) {
    throw new InvalidParameterValueException("Please specify a valid physical network.");
  }
  if (zone.getNetworkType() == NetworkType.Advanced && vlanId.equals(Vlan.UNTAGGED) && (!forVirtualNetwork || zone.isSecurityGroupEnabled())) {
    throw new InvalidParameterValueException("Direct untagged network is not supported for the zone " + zone.getId() + " of type "+ zone.getNetworkType());
  }
 else   if (zone.getNetworkType() == NetworkType.Basic && !((vlanId.equals(Vlan.UNTAGGED) && !forVirtualNetwork) || (forVirtualNetwork))) {
    throw new InvalidParameterValueException("Only Direct Untagged and Virtual networks are supported in the zone " + zone.getId() + " of type "+ zone.getNetworkType());
  }
  if ((zone.getNetworkType() == NetworkType.Advanced && pNtwk.getVnet() == null) && forVirtualNetwork) {
    throw new InvalidParameterValueException("Can't add virtual network to the physical Network id=" + pNtwk.getId() + " in zone id="+ zone.getId()+ " as there is no guest vlan configured");
  }
  VlanType vlanType=forVirtualNetwork ? VlanType.VirtualNetwork : VlanType.DirectAttached;
  checkAccess(account,zone);
  if (vlanType.equals(VlanType.DirectAttached)) {
    if (account != null) {
      if (vlanId.equals(Vlan.UNTAGGED)) {
        throw new InvalidParameterValueException("Direct Attached IP ranges for an account must be tagged.");
      }
      List<HostPodVO> podsInZone=_podDao.listByDataCenterId(zone.getId());
      for (      HostPodVO pod : podsInZone) {
        if (_podVlanMapDao.listPodVlanMapsByPod(pod.getId()).size() > 0) {
          throw new InvalidParameterValueException("Zone " + zone.getName() + " already has pod-wide IP ranges. A zone may contain either pod-wide IP ranges or account-wide IP ranges, but not both.");
        }
      }
    }
 else     if (podId != null) {
      if (!vlanId.equals(Vlan.UNTAGGED)) {
        throw new InvalidParameterValueException("Direct Attached IP ranges for a pod must be untagged.");
      }
      List<AccountVlanMapVO> accountVlanMaps=_accountVlanMapDao.listAllIncludingRemoved();
      for (      AccountVlanMapVO accountVlanMap : accountVlanMaps) {
        VlanVO vlan=_vlanDao.findById(accountVlanMap.getVlanDbId());
        if (vlan.getDataCenterId() == zone.getId()) {
          throw new InvalidParameterValueException("Zone " + zone.getName() + " already has account-wide IP ranges. A zone may contain either pod-wide IP ranges or account-wide IP ranges, but not both.");
        }
      }
    }
  }
  if (!NetUtils.isValidIp(vlanGateway)) {
    throw new InvalidParameterValueException("Please specify a valid gateway");
  }
  if (!NetUtils.isValidIp(vlanNetmask)) {
    throw new InvalidParameterValueException("Please specify a valid netmask");
  }
  String newVlanSubnet=NetUtils.getSubNet(vlanGateway,vlanNetmask);
  checkPublicIpRangeErrors(zoneId,vlanId,vlanGateway,vlanNetmask,startIP,endIP);
  List<VlanVO> vlans=_vlanDao.listByZone(zone.getId());
  for (  VlanVO vlan : vlans) {
    String otherVlanGateway=vlan.getVlanGateway();
    String otherVlanSubnet=NetUtils.getSubNet(vlan.getVlanGateway(),vlan.getVlanNetmask());
    String[] otherVlanIpRange=vlan.getIpRange().split("\\-");
    String otherVlanStartIP=otherVlanIpRange[0];
    String otherVlanEndIP=null;
    if (otherVlanIpRange.length > 1) {
      otherVlanEndIP=otherVlanIpRange[1];
    }
    if (forVirtualNetwork && !vlanId.equals(vlan.getVlanTag()) && newVlanSubnet.equals(otherVlanSubnet)&& !allowIpRangeOverlap(vlan,forVirtualNetwork,networkId)) {
      throw new InvalidParameterValueException("The IP range with tag: " + vlan.getVlanTag() + " in zone "+ zone.getName()+ " has the same subnet. Please specify a different gateway/netmask.");
    }
    boolean vlansUntaggedAndVirtual=(vlanId.equals(Vlan.UNTAGGED) && vlanId.equals(vlan.getVlanTag()) && forVirtualNetwork&& vlan.getVlanType() == VlanType.VirtualNetwork);
    if (vlansUntaggedAndVirtual && !newVlanSubnet.equals(otherVlanSubnet)) {
      throw new InvalidParameterValueException("The Untagged ip range with different subnet already exists in zone " + zone.getId());
    }
    if (vlanId.equals(vlan.getVlanTag()) && newVlanSubnet.equals(otherVlanSubnet)) {
      if (NetUtils.ipRangesOverlap(startIP,endIP,otherVlanStartIP,otherVlanEndIP)) {
        throw new InvalidParameterValueException("The IP range with tag: " + vlan.getVlanTag() + " already has IPs that overlap with the new range. Please specify a different start IP/end IP.");
      }
      if (!vlanGateway.equals(otherVlanGateway)) {
        throw new InvalidParameterValueException("The IP range with tag: " + vlan.getVlanTag() + " has already been added with gateway "+ otherVlanGateway+ ". Please specify a different tag.");
      }
    }
  }
  if (_zoneDao.findVnet(zoneId,physicalNetworkId,vlanId).size() > 0) {
    throw new InvalidParameterValueException("The VLAN tag " + vlanId + " is already being used for the guest network in zone "+ zone.getName());
  }
  if (zone.getNetworkType() == NetworkType.Basic && vlanId.equalsIgnoreCase(Vlan.UNTAGGED) && podId != null) {
    List<VlanVO> podVlans=_vlanDao.listVlansForPodByType(podId,VlanType.DirectAttached);
    if (podVlans != null && !podVlans.isEmpty()) {
      VlanVO podVlan=podVlans.get(0);
      if (!podVlan.getVlanNetmask().equals(vlanNetmask)) {
        throw new InvalidParameterValueException("Vlan netmask is different from the netmask of Untagged vlan id=" + podVlan.getId() + " existing in the pod "+ podId);
      }
 else       if (!podVlan.getVlanGateway().equals(vlanGateway)) {
        throw new InvalidParameterValueException("Vlan gateway is different from the gateway of Untagged vlan id=" + podVlan.getId() + " existing in the pod "+ podId);
      }
    }
  }
  String ipRange=startIP;
  if (endIP != null) {
    ipRange+="-" + endIP;
  }
  Transaction txn=Transaction.currentTxn();
  txn.start();
  VlanVO vlan=new VlanVO(vlanType,vlanId,vlanGateway,vlanNetmask,zone.getId(),ipRange,networkId,physicalNetworkId);
  vlan=_vlanDao.persist(vlan);
  if (!savePublicIPRange(startIP,endIP,zoneId,vlan.getId(),networkId,physicalNetworkId)) {
    throw new CloudRuntimeException("Failed to save IP range. Please contact Cloud Support.");
  }
  if (account != null) {
    AccountVlanMapVO accountVlanMapVO=new AccountVlanMapVO(account.getId(),vlan.getId());
    _accountVlanMapDao.persist(accountVlanMapVO);
  }
 else   if (podId != null) {
    PodVlanMapVO podVlanMapVO=new PodVlanMapVO(podId,vlan.getId());
    _podVlanMapDao.persist(podVlanMapVO);
  }
  txn.commit();
  return vlan;
}
