{
  Long zoneId=cmd.getId();
  String zoneName=cmd.getZoneName();
  String dns1=cmd.getDns1();
  String dns2=cmd.getDns2();
  String internalDns1=cmd.getInternalDns1();
  String internalDns2=cmd.getInternalDns2();
  String newVnetRangeString=cmd.getVlan();
  String guestCidr=cmd.getGuestCidrAddress();
  List<String> dnsSearchOrder=cmd.getDnsSearchOrder();
  Boolean isPublic=cmd.isPublic();
  String allocationStateStr=cmd.getAllocationState();
  String dhcpProvider=cmd.getDhcpProvider();
  Map<?,?> detailsMap=cmd.getDetails();
  String networkDomain=cmd.getDomain();
  Map<String,String> newDetails=new HashMap<String,String>();
  if (detailsMap != null) {
    Collection<?> zoneDetailsCollection=detailsMap.values();
    Iterator<?> iter=zoneDetailsCollection.iterator();
    while (iter.hasNext()) {
      HashMap<?,?> detail=(HashMap<?,?>)iter.next();
      String key=(String)detail.get("key");
      String value=(String)detail.get("value");
      if ((key == null) || (value == null)) {
        throw new InvalidParameterValueException("Invalid Zone Detail specified, fields 'key' and 'value' cannot be null, please specify details in the form:  details[0].key=XXX&details[0].value=YYY");
      }
      newDetails.put(key,value);
    }
  }
  if (dnsSearchOrder != null) {
    for (    String dom : dnsSearchOrder) {
      if (!NetUtils.verifyDomainName(dom)) {
        throw new InvalidParameterValueException("Invalid network domain suffixes. Total length shouldn't exceed 190 chars. Each domain label must be between 1 and 63 characters long, can contain ASCII letters 'a' through 'z', the digits '0' through '9', " + "and the hyphen ('-'); can't start or end with \"-\"");
      }
    }
    newDetails.put(ZoneConfig.DnsSearchOrder.getName(),StringUtils.join(dnsSearchOrder,","));
  }
  DataCenterVO zone=_zoneDao.findById(zoneId);
  if (zone == null) {
    throw new InvalidParameterValueException("unable to find zone by id " + zoneId);
  }
  if (zoneName == null) {
    zoneName=zone.getName();
  }
  if (zone.getNetworkType() == NetworkType.Basic) {
    if (newVnetRangeString != null) {
      throw new InvalidParameterValueException("Can't add vnet range for the zone that supports " + zone.getNetworkType() + " network");
    }
 else     if (guestCidr != null) {
      throw new InvalidParameterValueException("Can't add cidr for the zone that supports " + zone.getNetworkType() + " network");
    }
  }
  if ((guestCidr != null) && !NetUtils.validateGuestCidr(guestCidr)) {
    throw new InvalidParameterValueException("Please enter a valid guest cidr");
  }
  if (!validZone(zoneId)) {
    throw new InvalidParameterValueException("A zone with ID: " + zoneId + " does not exist.");
  }
  boolean replaceVnet=false;
  ArrayList<Pair<Integer,Integer>> vnetsToAdd=new ArrayList<Pair<Integer,Integer>>(2);
  if (newVnetRangeString != null) {
    Integer newStartVnet=0;
    Integer newEndVnet=0;
    String[] newVnetRange=newVnetRangeString.split("-");
    if (newVnetRange.length < 2) {
      throw new InvalidParameterValueException("Please provide valid vnet range between 0-4096");
    }
    if (newVnetRange[0] == null || newVnetRange[1] == null) {
      throw new InvalidParameterValueException("Please provide valid vnet range between 0-4096");
    }
    try {
      newStartVnet=Integer.parseInt(newVnetRange[0]);
      newEndVnet=Integer.parseInt(newVnetRange[1]);
    }
 catch (    NumberFormatException e) {
      s_logger.warn("Unable to parse vnet range:",e);
      throw new InvalidParameterValueException("Please provide valid vnet range between 0-4096");
    }
    if (newStartVnet < 0 || newEndVnet > 4096) {
      throw new InvalidParameterValueException("Vnet range has to be between 0-4096");
    }
    if (newStartVnet > newEndVnet) {
      throw new InvalidParameterValueException("Vnet range has to be between 0-4096 and start range should be lesser than or equal to stop range");
    }
    if (zoneHasAllocatedVnets(zoneId)) {
      String[] existingRange=zone.getVnet().split("-");
      int existingStartVnet=Integer.parseInt(existingRange[0]);
      int existingEndVnet=Integer.parseInt(existingRange[1]);
      if (!(newStartVnet.intValue() <= existingStartVnet && newEndVnet.intValue() >= existingEndVnet)) {
        throw new InvalidParameterValueException("Can's shrink existing vnet range as it the range has vnets allocated. Only extending existing vnet is supported");
      }
      if (newStartVnet < existingStartVnet) {
        vnetsToAdd.add(new Pair<Integer,Integer>(newStartVnet,existingStartVnet - 1));
      }
      if (newEndVnet > existingEndVnet) {
        vnetsToAdd.add(new Pair<Integer,Integer>(existingEndVnet + 1,newEndVnet));
      }
    }
 else {
      vnetsToAdd.add(new Pair<Integer,Integer>(newStartVnet,newEndVnet));
      replaceVnet=true;
    }
  }
  String oldZoneName=zone.getName();
  if (zoneName == null) {
    zoneName=oldZoneName;
  }
  if (dns1 == null) {
    dns1=zone.getDns1();
  }
  if (dns2 == null) {
    dns2=zone.getDns2();
  }
  if (internalDns1 == null) {
    internalDns1=zone.getInternalDns1();
  }
  if (guestCidr == null) {
    guestCidr=zone.getGuestNetworkCidr();
  }
  if (networkDomain != null) {
    if (!NetUtils.verifyDomainName(networkDomain)) {
      throw new InvalidParameterValueException("Invalid network domain. Total length shouldn't exceed 190 chars. Each domain label must be between 1 and 63 characters long, can contain ASCII letters 'a' through 'z', the digits '0' through '9', " + "and the hyphen ('-'); can't start or end with \"-\"");
    }
  }
 else {
    networkDomain=zone.getDomain();
  }
  boolean checkForDuplicates=!zoneName.equals(oldZoneName);
  checkZoneParameters(zoneName,dns1,dns2,internalDns1,internalDns2,checkForDuplicates,null,allocationStateStr);
  zone.setName(zoneName);
  zone.setDns1(dns1);
  zone.setDns2(dns2);
  zone.setInternalDns1(internalDns1);
  zone.setInternalDns2(internalDns2);
  zone.setGuestNetworkCidr(guestCidr);
  zone.setDomain(networkDomain);
  if (newVnetRangeString != null) {
    zone.setVnet(newVnetRangeString);
  }
  if (isPublic != null && isPublic) {
    zone.setDomainId(null);
    zone.setDomain(null);
  }
  Transaction txn=Transaction.currentTxn();
  txn.start();
  Map<String,String> updatedDetails=new HashMap<String,String>();
  _zoneDao.loadDetails(zone);
  if (zone.getDetails() != null) {
    updatedDetails.putAll(zone.getDetails());
  }
  updatedDetails.putAll(newDetails);
  zone.setDetails(updatedDetails);
  if (allocationStateStr != null && !allocationStateStr.isEmpty()) {
    Grouping.AllocationState allocationState=Grouping.AllocationState.valueOf(allocationStateStr);
    zone.setAllocationState(allocationState);
  }
  if (dhcpProvider != null) {
    zone.setDhcpProvider(dhcpProvider);
  }
  if (!_zoneDao.update(zoneId,zone)) {
    throw new CloudRuntimeException("Failed to edit zone. Please contact Cloud Support.");
  }
  if (replaceVnet) {
    s_logger.debug("Deleting existing vnet range for the zone id=" + zoneId + " as a part of updateZone call");
    _zoneDao.deleteVnet(zoneId);
  }
  for (  Pair<Integer,Integer> vnetToAdd : vnetsToAdd) {
    s_logger.debug("Adding vnet range " + vnetToAdd.first() + "-"+ vnetToAdd.second()+ " for the zone id="+ zoneId+ " as a part of updateZone call");
    _zoneDao.addVnet(zone.getId(),vnetToAdd.first(),vnetToAdd.second());
  }
  txn.commit();
  return zone;
}
