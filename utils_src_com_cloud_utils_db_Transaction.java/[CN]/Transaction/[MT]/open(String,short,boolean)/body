{
  Transaction txn=tls.get();
  boolean isNew=false;
  if (txn == null) {
    if (s_logger.isTraceEnabled()) {
      s_logger.trace("Creating the transaction: " + name);
    }
    txn=new Transaction(name,false,databaseId);
    tls.set(txn);
    isNew=true;
  }
 else   if (forceDbChange) {
    final short currentDbId=txn.getDatabaseId();
    if (currentDbId != databaseId) {
      txn.close(txn.getName());
      txn=new Transaction(name,false,databaseId);
      tls.set(txn);
      isNew=true;
    }
  }
  txn.takeOver(name,false);
  if (isNew) {
    try {
      s_logger.debug("Registering txn" + System.identityHashCode(txn));
      JmxUtil.registerMBean("Transaction","txn" + System.identityHashCode(txn),new TransactionMBeanImpl(txn));
    }
 catch (    Exception e) {
      s_logger.error("Unable to register MBean",e);
    }
  }
  return txn;
}
