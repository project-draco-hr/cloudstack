{
  long count=0;
  Transaction txn=Transaction.currentTxn();
  txn.start();
  try {
    Set<Long> rowIdsToLock=_resourceCountDao.listRowsToUpdateForDomain(domainId,type);
    SearchCriteria<ResourceCountVO> sc=ResourceCountSearch.create();
    sc.setParameters("id",rowIdsToLock.toArray());
    _resourceCountDao.lockRows(sc,null,true);
    List<DomainVO> domainChildren=_domainDao.findImmediateChildrenForParent(domainId);
    for (    DomainVO domainChild : domainChildren) {
      long domainCount=updateDomainResourceCount(domainChild.getId(),type);
      count=count + domainCount;
    }
    List<AccountVO> accounts=_accountDao.findActiveAccountsForDomain(domainId);
    for (    AccountVO account : accounts) {
      long accountCount=updateAccountResourceCount(account.getId(),type);
      count=count + accountCount;
    }
    _resourceCountDao.setDomainCount(domainId,type,count);
  }
 catch (  Exception e) {
    throw new CloudRuntimeException("Failed to update resource count for domain with Id " + domainId);
  }
 finally {
    txn.commit();
  }
  return count;
}
