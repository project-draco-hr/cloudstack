{
  long count=0;
  if (m_resourceCountLock.lock(120)) {
    try {
      List<DomainVO> domainChildren=_domainDao.findImmediateChildrenForParent(domainId);
      for (      DomainVO domainChild : domainChildren) {
        long domainCount=updateDomainResourceCount(domainChild.getId(),type);
        count=count + domainCount;
      }
      List<AccountVO> accounts=_accountDao.findActiveAccountsForDomain(domainId);
      for (      AccountVO account : accounts) {
        long accountCount=updateAccountResourceCount(account.getId(),type);
        count=count + accountCount;
      }
      _resourceCountDao.setDomainCount(domainId,type,count);
    }
 catch (    Exception e) {
      throw new CloudRuntimeException("Failed to update resource count for domain with Id " + domainId);
    }
 finally {
      m_resourceCountLock.unlock();
    }
  }
  return count;
}
