{
  Long domainId=domainIdRecursiveListProject.first();
  if (domainId != null) {
    Domain domain=_domainDao.findById(domainId);
    if (domain == null) {
      throw new InvalidParameterValueException("Unable to find domain by id " + domainId);
    }
    checkAccess(caller,domain);
  }
  if (id != null) {
    return;
  }
  if (accountName != null) {
    if (projectId != null) {
      throw new InvalidParameterValueException("Account and projectId can't be specified together");
    }
    Account userAccount=null;
    Domain domain=null;
    if (domainId != null) {
      userAccount=_accountDao.findActiveAccount(accountName,domainId);
      domain=_domainDao.findById(domainId);
    }
 else {
      userAccount=_accountDao.findActiveAccount(accountName,caller.getDomainId());
      domain=_domainDao.findById(caller.getDomainId());
    }
    if (userAccount != null) {
      checkAccess(caller,null,false,userAccount);
      permittedAccounts.add(userAccount.getId());
    }
 else {
      throw new InvalidParameterValueException("could not find account " + accountName + " in domain "+ domain.getUuid());
    }
  }
  if (projectId != null) {
    if (!forProjectInvitation) {
      if (projectId.longValue() == -1) {
        if (isNormalUser(caller.getId())) {
          permittedAccounts.addAll(_projectMgr.listPermittedProjectAccounts(caller.getId()));
        }
 else {
          domainIdRecursiveListProject.third(Project.ListProjectResourcesCriteria.ListProjectResourcesOnly);
        }
      }
 else {
        Project project=_projectMgr.getProject(projectId);
        if (project == null) {
          throw new InvalidParameterValueException("Unable to find project by id " + projectId);
        }
        if (!_projectMgr.canAccessProjectAccount(caller,project.getProjectAccountId())) {
          throw new PermissionDeniedException("Account " + caller + " can't access project id="+ projectId);
        }
        permittedAccounts.add(project.getProjectAccountId());
      }
    }
  }
 else {
    domainIdRecursiveListProject.third(Project.ListProjectResourcesCriteria.SkipProjectResources);
    AclPolicyPermission policyPerm=_aclService.getAclPolicyPermission(caller.getId(),AclEntityType.VM.toString(),"listVirtualMachine");
    if (policyPerm == null) {
      throw new PermissionDeniedException("Caller has no policy permission assigned to list VM");
    }
    if (permittedAccounts.isEmpty()) {
      if (policyPerm.getScope() == PermissionScope.ACCOUNT || !listAll) {
        permittedAccounts.add(caller.getId());
      }
 else       if (policyPerm.getScope() == PermissionScope.DOMAIN) {
        domainIdRecursiveListProject.first(caller.getDomainId());
      }
    }
  }
}
