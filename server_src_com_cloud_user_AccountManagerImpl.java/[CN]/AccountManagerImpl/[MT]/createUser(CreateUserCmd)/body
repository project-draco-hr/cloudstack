{
  String accountName=cmd.getAccountName();
  Long domainId=cmd.getDomainId();
  String userName=cmd.getUsername();
  String password=cmd.getPassword();
  String firstName=cmd.getFirstname();
  String lastName=cmd.getLastname();
  String email=cmd.getEmail();
  String timeZone=cmd.getTimezone();
  Long accountId=null;
  if (domainId == null) {
    domainId=Domain.ROOT_DOMAIN;
  }
  DomainVO domain=_domainDao.findById(domainId);
  checkAccess(UserContext.current().getCaller(),domain);
  Account account=_accountDao.findActiveAccount(accountName,domainId);
  if (account == null) {
    throw new InvalidParameterValueException("Unable to find account " + accountName + " in domain id="+ domainId+ " to create user");
  }
 else {
    accountId=account.getAccountId();
  }
  if (domain == null) {
    throw new CloudRuntimeException("The domain " + domainId + " does not exist; unable to create user");
  }
 else {
    if (domain.getState().equals(Domain.State.Inactive)) {
      throw new CloudRuntimeException("The user cannot be created as domain " + domain.getName() + " is being deleted");
    }
  }
  if (!_userAccountDao.validateUsernameInDomain(userName,domainId)) {
    throw new CloudRuntimeException("The user " + userName + " already exists in domain "+ domainId);
  }
  UserVO user=new UserVO();
  user.setUsername(userName);
  user.setPassword(password);
  user.setState(State.enabled);
  user.setFirstname(firstName);
  user.setLastname(lastName);
  user.setAccountId(accountId.longValue());
  user.setEmail(email);
  user.setTimezone(timeZone);
  if (s_logger.isDebugEnabled()) {
    s_logger.debug("Creating user: " + userName + ", account: "+ accountName+ " (id:"+ accountId+ "), domain: "+ domainId+ " timezone:"+ timeZone);
  }
  UserVO dbUser=_userDao.persist(user);
  if (!user.getPassword().equals(dbUser.getPassword())) {
    throw new CloudRuntimeException("The user " + userName + " being creating is using a password that is different than what's in the db");
  }
  return dbUser;
}
