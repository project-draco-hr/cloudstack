{
  long count=0;
  if (m_resourceCountLock.lock(120)) {
    try {
switch (type) {
case user_vm:
        count=_userVmDao.countAllocatedVMsForAccount(accountId);
      break;
case volume:
    count=_volumeDao.countAllocatedVolumesForAccount(accountId);
  long virtualRouterCount=_vmDao.countAllocatedVirtualRoutersForAccount(accountId);
count=count - virtualRouterCount;
break;
case snapshot:
count=_snapshotDao.countSnapshotsForAccount(accountId);
break;
case public_ip:
count=_ipAddressDao.countAllocatedIPsForAccount(accountId);
break;
case template:
count=_vmTemplateDao.countTemplatesForAccount(accountId);
break;
}
_resourceCountDao.setAccountCount(accountId,type,count);
}
 catch (Exception e) {
throw new CloudRuntimeException("Failed to update resource count for account with Id" + accountId);
}
 finally {
m_resourceCountLock.unlock();
}
}
return count;
}
