{
  Long domainId=domainIdRecursiveListProject.first();
  if (domainId != null) {
    Domain domain=_domainDao.findById(domainId);
    if (domain == null) {
      throw new InvalidParameterValueException("Unable to find domain by id " + domainId);
    }
    checkAccess(caller,domain);
  }
  if (id != null) {
    permittedResources.add(id);
    return;
  }
  if (accountName != null) {
    if (projectId != null) {
      throw new InvalidParameterValueException("Account and projectId can't be specified together");
    }
    Account userAccount=null;
    Domain domain=null;
    if (domainId != null) {
      userAccount=_accountDao.findActiveAccount(accountName,domainId);
      domain=_domainDao.findById(domainId);
    }
 else {
      userAccount=_accountDao.findActiveAccount(accountName,caller.getDomainId());
      domain=_domainDao.findById(caller.getDomainId());
    }
    if (userAccount != null) {
      checkAccess(caller,null,false,userAccount);
      permittedAccounts.add(userAccount.getId());
    }
 else {
      throw new InvalidParameterValueException("could not find account " + accountName + " in domain "+ domain.getUuid());
    }
  }
  if (projectId != null) {
    if (!forProjectInvitation) {
      if (projectId.longValue() == -1) {
        if (isNormalUser(caller.getId())) {
          permittedAccounts.addAll(_projectMgr.listPermittedProjectAccounts(caller.getId()));
        }
 else {
          domainIdRecursiveListProject.third(Project.ListProjectResourcesCriteria.ListProjectResourcesOnly);
        }
      }
 else {
        Project project=_projectMgr.getProject(projectId);
        if (project == null) {
          throw new InvalidParameterValueException("Unable to find project by id " + projectId);
        }
        if (!_projectMgr.canAccessProjectAccount(caller,project.getProjectAccountId())) {
          throw new PermissionDeniedException("Account " + caller + " can't access project id="+ projectId);
        }
        permittedAccounts.add(project.getProjectAccountId());
      }
    }
  }
 else {
    domainIdRecursiveListProject.third(Project.ListProjectResourcesCriteria.SkipProjectResources);
    List<Long> grantedDomains=_aclService.getGrantedDomains(caller.getId(),AclEntityType.VM,action);
    List<Long> grantedAccounts=_aclService.getGrantedAccounts(caller.getId(),AclEntityType.VM,action);
    List<Long> grantedResources=_aclService.getGrantedResources(caller.getId(),AclEntityType.VM,action);
    if (domainId != null) {
      if (grantedDomains.contains(domainId)) {
        permittedDomains.add(domainId);
      }
 else {
        for (        Long acctId : grantedAccounts) {
          Account acct=_accountDao.findById(acctId);
          if (acct != null && acct.getDomainId() == domainId) {
            permittedAccounts.add(acctId);
          }
        }
        permittedResources.addAll(grantedResources);
      }
    }
 else     if (permittedAccounts.isEmpty()) {
      permittedDomains.addAll(grantedDomains);
      permittedAccounts.addAll(grantedAccounts);
      permittedResources.addAll(grantedResources);
    }
  }
}
