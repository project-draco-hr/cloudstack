{
  Account caller=UserContext.current().getCaller();
  Long ownerId=null;
  OwnerType ownerType=OwnerType.Account;
  if (max == null) {
    max=new Long(-1);
  }
 else   if (max < -1) {
    throw new InvalidParameterValueException("Please specify either '-1' for an infinite limit, or a limit that is at least '0'.");
  }
  ResourceType resourceType=null;
  try {
    resourceType=ResourceType.values()[typeId];
  }
 catch (  ArrayIndexOutOfBoundsException e) {
    throw new InvalidParameterValueException("Please specify a valid resource type.");
  }
  if (domainId != null) {
    Domain domain=_domainDao.findById(domainId);
    if (domain == null) {
      throw new InvalidParameterValueException("Unable to find domain by id " + domainId);
    }
    checkAccess(caller,domain);
    if (accountName != null) {
      Account account=_accountDao.findAccount(accountName,domainId);
      checkAccess(caller,null,account);
      if (account.getType() == Account.ACCOUNT_ID_SYSTEM) {
        throw new InvalidParameterValueException("Can't update system account");
      }
      ownerId=account.getId();
    }
 else {
      if ((caller.getDomainId() == domainId.longValue()) && caller.getType() == Account.ACCOUNT_TYPE_DOMAIN_ADMIN || caller.getType() == Account.ACCOUNT_TYPE_RESOURCE_DOMAIN_ADMIN) {
        throw new PermissionDeniedException("Unable to update resource limit for domain " + domainId + ", permission denied");
      }
      Long parentDomainId=domain.getParent();
      if (parentDomainId != null) {
        DomainVO parentDomain=_domainDao.findById(parentDomainId);
        long parentMaximum=findCorrectResourceLimit(parentDomain,resourceType);
        if ((parentMaximum >= 0) && (max.longValue() > parentMaximum)) {
          throw new InvalidParameterValueException("Domain (id: " + domainId + ") has maximum allowed resource limit "+ parentMaximum+ " for "+ resourceType+ ", please specify a value less that or equal to "+ parentMaximum);
        }
      }
      ownerId=domain.getId();
      ownerType=OwnerType.Domain;
    }
  }
  ResourceLimitVO limit=_resourceLimitDao.findByOwnerIdAndType(ownerId,ownerType,resourceType);
  if (limit != null) {
    _resourceLimitDao.update(limit.getId(),max);
    return _resourceLimitDao.findById(limit.getId());
  }
 else {
    if (ownerType == OwnerType.Account) {
      return _resourceLimitDao.persist(new ResourceLimitVO(null,ownerId,resourceType,max));
    }
 else {
      return _resourceLimitDao.persist(new ResourceLimitVO(ownerId,null,resourceType,max));
    }
  }
}
