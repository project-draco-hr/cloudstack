{
  long accountId=account.getId();
  boolean accountCleanupNeeded=false;
  try {
    List<InstanceGroupVO> groups=_vmGroupDao.listByAccountId(accountId);
    for (    InstanceGroupVO group : groups) {
      if (!_vmMgr.deleteVmGroup(group.getId())) {
        s_logger.error("Unable to delete group: " + group.getId());
        accountCleanupNeeded=true;
      }
    }
    boolean success=_snapMgr.deleteSnapshotDirsForAccount(accountId);
    if (success) {
      s_logger.debug("Successfully deleted snapshots directories for all volumes under account " + accountId + " across all zones");
    }
    List<VMTemplateVO> userTemplates=_templateDao.listByAccountId(accountId);
    boolean allTemplatesDeleted=true;
    for (    VMTemplateVO template : userTemplates) {
      try {
        allTemplatesDeleted=_tmpltMgr.delete(callerUserId,template.getId(),null);
      }
 catch (      Exception e) {
        s_logger.warn("Failed to delete template while removing account: " + template.getName() + " due to: "+ e.getMessage());
        allTemplatesDeleted=false;
      }
    }
    if (!allTemplatesDeleted) {
      accountCleanupNeeded=true;
    }
    List<UserVmVO> vms=_userVmDao.listByAccountId(accountId);
    if (s_logger.isDebugEnabled()) {
      s_logger.debug("Destroying # of vms (accountId=" + accountId + "): "+ vms.size());
    }
    for (    UserVmVO vm : vms) {
      long startEventId=EventUtils.saveStartedEvent(callerUserId,vm.getAccountId(),EventTypes.EVENT_VM_DESTROY,"Destroyed VM instance : " + vm.getName());
      if (!_vmMgr.expunge(vm,callerUserId,caller)) {
        s_logger.error("Unable to destroy vm: " + vm.getId());
        accountCleanupNeeded=true;
        EventUtils.saveEvent(callerUserId,vm.getAccountId(),EventVO.LEVEL_ERROR,EventTypes.EVENT_VM_DESTROY,"Unable to destroy vm: " + vm.getId(),startEventId);
      }
 else {
        EventUtils.saveEvent(callerUserId,vm.getAccountId(),EventVO.LEVEL_INFO,EventTypes.EVENT_VM_DESTROY,"Successfully destroyed VM instance : " + vm.getName(),startEventId);
      }
    }
    List<VolumeVO> volumes=_volumeDao.findDetachedByAccount(accountId);
    for (    VolumeVO volume : volumes) {
      _storageMgr.destroyVolume(volume);
    }
    int numRemoved=_securityGroupDao.removeByAccountId(accountId);
    s_logger.info("deleteAccount: Deleted " + numRemoved + " network groups for account "+ accountId);
    s_logger.debug("Deleting networks for account " + account.getId());
    List<NetworkVO> networks=_networkDao.listByOwner(accountId);
    if (networks != null) {
      for (      NetworkVO network : networks) {
        if (!_networkMgr.deleteNetwork(network.getId())) {
          s_logger.warn("Unable to destroy network " + network + " as a part of account cleanup");
          accountCleanupNeeded=true;
        }
        s_logger.debug("Network " + network.getId() + " successfully deleted.");
      }
    }
    return true;
  }
  finally {
    s_logger.info("Cleanup for account " + account.getId() + (accountCleanupNeeded ? " is needed." : " is not needed."));
    if (accountCleanupNeeded) {
      _accountDao.markForCleanup(accountId);
    }
  }
}
