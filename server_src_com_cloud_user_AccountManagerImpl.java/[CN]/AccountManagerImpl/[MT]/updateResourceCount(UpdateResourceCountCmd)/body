{
  Account callerAccount=UserContext.current().getCaller();
  String accountName=cmd.getAccountName();
  Long domainId=cmd.getDomainId();
  Long accountId=null;
  long count=0;
  List<ResourceCountVO> counts=new ArrayList<ResourceCountVO>();
  List<ResourceType> resourceTypes=new ArrayList<ResourceType>();
  ResourceType resourceType=null;
  Integer typeId=cmd.getResourceType();
  if (typeId != null) {
    try {
      resourceType=ResourceType.values()[typeId];
    }
 catch (    ArrayIndexOutOfBoundsException e) {
      throw new InvalidParameterValueException("Please specify a valid resource type.");
    }
  }
  DomainVO domain=_domainDao.findById(domainId);
  if (domain == null) {
    throw new InvalidParameterValueException("Please specify a valid domain ID.");
  }
  checkAccess(callerAccount,domain);
  if (accountName != null) {
    Account userAccount=_accountDao.findActiveAccount(accountName,domainId);
    if (userAccount == null) {
      throw new InvalidParameterValueException("unable to find account by name " + accountName + " in domain with id "+ domainId);
    }
    accountId=userAccount.getId();
  }
  try {
    if (resourceType != null) {
      resourceTypes.add(resourceType);
    }
 else {
      resourceTypes=Arrays.asList(ResourceType.values());
    }
    for (    ResourceType type : resourceTypes) {
      if (accountId != null) {
        count=updateAccountResourceCount(accountId,type);
        counts.add(new ResourceCountVO(accountId,domainId,type,count));
      }
 else {
        count=updateDomainResourceCount(domainId,type);
        counts.add(new ResourceCountVO(accountId,domainId,type,count));
      }
    }
  }
 catch (  Exception e) {
    throw new CloudRuntimeException(e.getMessage());
  }
  return counts;
}
