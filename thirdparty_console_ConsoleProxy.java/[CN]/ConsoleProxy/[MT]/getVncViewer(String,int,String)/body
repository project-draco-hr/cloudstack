{
synchronized (connectionMap) {
    ConsoleViewer viewer=connectionMap.get(host + ":" + port);
    if (viewer == null) {
      viewer=createViewer();
      initViewer(viewer,host,port,sid);
      connectionMap.put(host + ":" + port,viewer);
      Logger.log(Logger.INFO,"Added viewer object " + viewer);
    }
 else     if (!viewer.rfbThread.isAlive()) {
      Logger.log(Logger.INFO,"The rfb thread died, reinitializing the viewer " + viewer);
      initViewer(viewer,host,port,sid);
    }
 else     if (!sid.equals(viewer.passwordParam)) {
      throw new AuthenticationException("Cannot use the existing viewer " + viewer + ": bad sid");
    }
    if (viewer.status == ConsoleViewer.STATUS_NORMAL_OPERATION) {
      viewer.lastUsedTime=System.currentTimeMillis();
    }
    return viewer;
  }
}
