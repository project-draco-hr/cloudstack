{
  VMTemplateVO template=persistTemplate(profile);
  if (template == null) {
    throw new CloudRuntimeException("Unable to persist the template " + profile.getTemplate());
  }
  DataStore imageStore=this.templateMgr.getImageStore(profile.getImageStoreUuid(),profile.getZoneId());
  AsyncCallFuture<CommandResult> future=this.imageService.createTemplateAsync(this.imageFactory.getTemplate(template.getId()),imageStore);
  try {
    future.get();
  }
 catch (  InterruptedException e) {
    s_logger.debug("create template Failed",e);
    throw new CloudRuntimeException("create template Failed",e);
  }
catch (  ExecutionException e) {
    s_logger.debug("create template Failed",e);
    throw new CloudRuntimeException("create template Failed",e);
  }
  _resourceLimitMgr.incrementResourceCount(profile.getAccountId(),ResourceType.template);
  return template;
}
