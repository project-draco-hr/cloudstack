{
  ProjectInvitationVO invite=_projectInvitationDao.findPendingByEmailAndProjectId(email,project.getId());
  if (invite != null) {
    if (_projectInvitationDao.isActive(invite.getId(),_invitationTimeOut)) {
      throw new InvalidParameterValueException("There is already a pending invitation for email=" + email + " to the project id="+ project);
    }
 else {
      if (invite.getState() == ProjectInvitation.State.Pending) {
        expireInvitation(invite);
      }
    }
  }
  ProjectInvitation projectInvitation=_projectInvitationDao.persist(new ProjectInvitationVO(project.getId(),null,project.getDomainId(),email,token));
  try {
    _emailInvite.sendInvite(token,email,project.getId());
  }
 catch (  Exception ex) {
    s_logger.warn("Failed to send project id=" + project + " invitation to the email "+ email+ "; removing the invitation record from the db",ex);
    _projectInvitationDao.remove(projectInvitation.getId());
    return null;
  }
  return projectInvitation;
}
