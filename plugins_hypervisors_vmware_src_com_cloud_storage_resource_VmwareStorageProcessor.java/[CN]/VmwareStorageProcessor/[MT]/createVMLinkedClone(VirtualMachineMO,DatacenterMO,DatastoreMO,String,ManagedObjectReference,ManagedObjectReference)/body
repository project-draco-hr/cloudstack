{
  ManagedObjectReference morBaseSnapshot=vmTemplate.getSnapshotMor("cloud.template.base");
  if (morBaseSnapshot == null) {
    String msg="Unable to find template base snapshot, invalid template";
    s_logger.error(msg);
    throw new Exception(msg);
  }
  s_logger.info("creating linked clone from template");
  if (!vmTemplate.createLinkedClone(vmdkName,morBaseSnapshot,dcMo.getVmFolder(),morPool,morDatastore)) {
    String msg="Unable to clone from the template";
    s_logger.error(msg);
    throw new Exception(msg);
  }
  s_logger.info("Move volume out of volume-wrapper VM ");
  String[] vmwareLayoutFilePair=VmwareStorageLayoutHelper.getVmdkFilePairDatastorePath(dsMo,vmdkName,vmdkName,VmwareStorageLayoutType.VMWARE,true);
  String[] legacyCloudStackLayoutFilePair=VmwareStorageLayoutHelper.getVmdkFilePairDatastorePath(dsMo,vmdkName,vmdkName,VmwareStorageLayoutType.CLOUDSTACK_LEGACY,true);
  dsMo.moveDatastoreFile(vmwareLayoutFilePair[0],dcMo.getMor(),dsMo.getMor(),legacyCloudStackLayoutFilePair[0],dcMo.getMor(),true);
  dsMo.moveDatastoreFile(vmwareLayoutFilePair[1],dcMo.getMor(),dsMo.getMor(),legacyCloudStackLayoutFilePair[1],dcMo.getMor(),true);
  return true;
}
