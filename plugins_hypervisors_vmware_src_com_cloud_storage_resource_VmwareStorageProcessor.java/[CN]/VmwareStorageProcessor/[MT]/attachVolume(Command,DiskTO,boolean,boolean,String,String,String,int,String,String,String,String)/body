{
  VolumeObjectTO volumeTO=(VolumeObjectTO)disk.getData();
  PrimaryDataStoreTO primaryStore=(PrimaryDataStoreTO)volumeTO.getDataStore();
  try {
    VmwareHypervisorHost hyperHost=hostService.getHyperHost(hostService.getServiceContext(null),null);
    VirtualMachineMO vmMo=hyperHost.findVmOnHyperHost(vmName);
    if (vmMo == null) {
      String msg="Unable to find the VM to execute AttachVolumeCommand, vmName: " + vmName;
      s_logger.error(msg);
      throw new Exception(msg);
    }
    ManagedObjectReference morDs=null;
    if (isAttach && isManaged) {
      morDs=hostService.handleDatastoreAndVmdkAttach(cmd,iScsiName,storageHost,storagePort,initiatorUsername,initiatorPassword,targetUsername,targetPassword);
    }
 else {
      morDs=HypervisorHostHelper.findDatastoreWithBackwardsCompatibility(hyperHost,isManaged ? VmwareResource.getDatastoreName(iScsiName) : primaryStore.getUuid());
    }
    if (morDs == null) {
      String msg="Unable to find the mounted datastore to execute AttachVolumeCommand, vmName: " + vmName;
      s_logger.error(msg);
      throw new Exception(msg);
    }
    DatastoreMO dsMo=new DatastoreMO(this.hostService.getServiceContext(null),morDs);
    String datastoreVolumePath=dsMo.getDatastorePath((isManaged ? dsMo.getName() : volumeTO.getPath()) + ".vmdk");
    disk.setVdiUuid(datastoreVolumePath);
    AttachAnswer answer=new AttachAnswer(disk);
    if (isAttach) {
      vmMo.attachDisk(new String[]{datastoreVolumePath},morDs);
    }
 else {
      vmMo.removeAllSnapshots();
      vmMo.detachDisk(datastoreVolumePath,false);
      if (isManaged) {
        hostService.handleDatastoreAndVmdkDetach(iScsiName,storageHost,storagePort);
      }
    }
    return answer;
  }
 catch (  Throwable e) {
    if (e instanceof RemoteException) {
      s_logger.warn("Encounter remote exception to vCenter, invalidate VMware session context");
      hostService.invalidateServiceContext(null);
    }
    String msg="AttachVolumeCommand failed due to " + VmwareHelper.getExceptionMessage(e);
    s_logger.error(msg,e);
    return new AttachAnswer(msg);
  }
}
