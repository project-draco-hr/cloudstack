{
  UserVmVO vm=listener.getVm();
  VMOperationParam param=listener.getParam();
  AsyncJobManager asyncMgr=getAsyncJobMgr();
  ManagementServer managementServer=asyncMgr.getExecutorContext().getManagementServer();
  String params="id=" + vm.getId() + "\nvmName="+ vm.getHostName()+ "\nsoId="+ vm.getServiceOfferingId()+ "\ntId="+ vm.getTemplateId()+ "\ndcId="+ vm.getDataCenterId();
  boolean jobStatusUpdated=false;
  try {
    if (s_logger.isDebugEnabled())     s_logger.debug("Execute asynchronize Reboot VM command: received answer, " + vm.getHostId() + "-"+ seq);
    if (answer != null) {
      asyncMgr.completeAsyncJob(getJob().getId(),AsyncJobResult.STATUS_SUCCEEDED,0,VMExecutorHelper.composeResultObject(asyncMgr.getExecutorContext().getManagementServer(),vm,null));
      jobStatusUpdated=true;
      EventUtils.saveEvent(param.getUserId(),param.getAccountId(),EventVO.LEVEL_INFO,EventTypes.EVENT_VM_REBOOT,"Successfully rebooted VM instance : " + vm.getHostName(),params,param.getEventId());
    }
 else {
      asyncMgr.completeAsyncJob(getJob().getId(),AsyncJobResult.STATUS_FAILED,BaseCmd.INTERNAL_ERROR,"Agent is unable to execute the command");
      jobStatusUpdated=true;
      EventUtils.saveEvent(param.getUserId(),param.getAccountId(),EventVO.LEVEL_ERROR,EventTypes.EVENT_VM_REBOOT,"Failed to reboot VM instance : " + vm.getHostName(),params,param.getEventId());
    }
  }
 catch (  Exception e) {
    s_logger.error("Unexpected exception " + e.getMessage(),e);
    if (!jobStatusUpdated) {
      if (answer != null) {
        asyncMgr.completeAsyncJob(getJob().getId(),AsyncJobResult.STATUS_SUCCEEDED,0,VMExecutorHelper.composeResultObject(asyncMgr.getExecutorContext().getManagementServer(),vm,null));
      }
 else {
        asyncMgr.completeAsyncJob(getJob().getId(),AsyncJobResult.STATUS_FAILED,BaseCmd.INTERNAL_ERROR,"Agent is unable to execute the command");
      }
    }
  }
 finally {
    asyncMgr.releaseSyncSource(this);
  }
}
