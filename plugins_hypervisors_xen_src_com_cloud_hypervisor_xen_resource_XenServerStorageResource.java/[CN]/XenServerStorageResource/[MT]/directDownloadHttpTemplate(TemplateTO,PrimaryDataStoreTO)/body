{
  String primaryStoreUuid=primarDataStore.getUuid();
  Connection conn=hypervisorResource.getConnection();
  SR poolsr=null;
  VDI vdi=null;
  try {
    Set<SR> srs=SR.getByNameLabel(conn,primaryStoreUuid);
    if (srs.size() != 1) {
      throw new CloudRuntimeException("storage uuid: " + primaryStoreUuid + " is not unique");
    }
    poolsr=srs.iterator().next();
    VDI.Record vdir=new VDI.Record();
    vdir.nameLabel="Base-Image-" + UUID.randomUUID().toString();
    vdir.SR=poolsr;
    vdir.type=Types.VdiType.USER;
    vdir.virtualSize=template.getSize();
    vdi=VDI.create(conn,vdir);
    vdir=vdi.getRecord(conn);
    String vdiLocation=vdir.location;
    Set<PBD> pbds=poolsr.getPBDs(conn);
    if (pbds.size() != 1) {
      throw new CloudRuntimeException("Don't how to handle multiple pbds:" + pbds.size() + " for sr: "+ poolsr.getUuid(conn));
    }
    PBD pbd=pbds.iterator().next();
    PBD.Record pbdRec=pbd.getRecord(conn);
    Map<String,String> deviceCfg=pbd.getDeviceConfig(conn);
    String pbdLocation=deviceCfg.get("location");
    if (pbdLocation == null) {
      throw new CloudRuntimeException("Can't get pbd: " + pbd.getUuid(conn) + " location");
    }
    String vdiPath=pbdLocation + "/" + vdiLocation;
  }
 catch (  BadServerResponse e) {
    e.printStackTrace();
  }
catch (  XenAPIException e) {
    e.printStackTrace();
  }
catch (  XmlRpcException e) {
    e.printStackTrace();
  }
}
