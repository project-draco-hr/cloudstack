{
  String primaryStoreUuid=primarDataStore.getUuid();
  Connection conn=hypervisorResource.getConnection();
  SR poolsr=null;
  VDI vdi=null;
  boolean result=false;
  try {
    Set<SR> srs=SR.getByNameLabel(conn,primaryStoreUuid);
    if (srs.size() != 1) {
      throw new CloudRuntimeException("storage uuid: " + primaryStoreUuid + " is not unique");
    }
    poolsr=srs.iterator().next();
    VDI.Record vdir=new VDI.Record();
    vdir.nameLabel="Base-Image-" + UUID.randomUUID().toString();
    vdir.SR=poolsr;
    vdir.type=Types.VdiType.USER;
    vdir.virtualSize=getTemplateSize(conn,template.getPath());
    vdi=VDI.create(conn,vdir);
    vdir=vdi.getRecord(conn);
    String vdiLocation=vdir.location;
    String pbdLocation=null;
    if (primarDataStore.getType().equalsIgnoreCase(DataStoreProtocol.NFS.toString())) {
      pbdLocation="/run/sr-mount/" + poolsr.getUuid(conn);
    }
 else {
      Set<PBD> pbds=poolsr.getPBDs(conn);
      if (pbds.size() != 1) {
        throw new CloudRuntimeException("Don't how to handle multiple pbds:" + pbds.size() + " for sr: "+ poolsr.getUuid(conn));
      }
      PBD pbd=pbds.iterator().next();
      Map<String,String> deviceCfg=pbd.getDeviceConfig(conn);
      pbdLocation=deviceCfg.get("location");
    }
    if (pbdLocation == null) {
      throw new CloudRuntimeException("Can't get pbd location");
    }
    String vdiPath=pbdLocation + "/" + vdiLocation+ ".vhd";
    hypervisorResource.callHostPlugin(conn,"storagePlugin","downloadTemplateFromUrl","destPath",vdiPath,"srcUrl",template.getPath());
    result=true;
    return new CopyTemplateToPrimaryStorageAnswer(cmd,vdi.getUuid(conn));
  }
 catch (  BadServerResponse e) {
    s_logger.debug("Failed to download template",e);
  }
catch (  XenAPIException e) {
    s_logger.debug("Failed to download template",e);
  }
catch (  XmlRpcException e) {
    s_logger.debug("Failed to download template",e);
  }
catch (  Exception e) {
    s_logger.debug("Failed to download template",e);
  }
 finally {
    if (!result && vdi != null) {
      try {
        vdi.destroy(conn);
      }
 catch (      BadServerResponse e) {
        s_logger.debug("Failed to cleanup newly created vdi");
      }
catch (      XenAPIException e) {
        s_logger.debug("Failed to cleanup newly created vdi");
      }
catch (      XmlRpcException e) {
        s_logger.debug("Failed to cleanup newly created vdi");
      }
    }
  }
  return new Answer(cmd,false,"Failed to download template");
}
