{
  long max=Resource.RESOURCE_UNLIMITED;
  if (domain.getId() == Domain.ROOT_DOMAIN) {
    return Resource.RESOURCE_UNLIMITED;
  }
  ResourceLimitVO limit=_resourceLimitDao.findByOwnerIdAndType(domain.getId(),ResourceOwnerType.Domain,type);
  if (limit != null) {
    max=limit.getMax().longValue();
  }
 else {
    Long domainId=domain.getParent();
    while ((domainId != null) && (limit == null)) {
      if (domainId == Domain.ROOT_DOMAIN) {
        break;
      }
      limit=_resourceLimitDao.findByOwnerIdAndType(domainId,ResourceOwnerType.Domain,type);
      DomainVO tmpDomain=_domainDao.findById(domainId);
      domainId=tmpDomain.getParent();
    }
    if (limit != null) {
      max=limit.getMax().longValue();
    }
 else {
      Long value=null;
      value=domainResourceLimitMap.get(type);
      if (value != null) {
        if (value < 0) {
          return max;
        }
        if (type == ResourceType.primary_storage || type == ResourceType.secondary_storage) {
          value=value * ResourceType.bytesToGiB;
        }
        return value;
      }
    }
  }
  return max;
}
