{
  long count=0;
  Transaction txn=Transaction.currentTxn();
  txn.start();
  try {
    Set<Long> rowIdsToLock=_resourceCountDao.listAllRowsToUpdate(domainId,ResourceOwnerType.Domain,type);
    SearchCriteria<ResourceCountVO> sc=ResourceCountSearch.create();
    sc.setParameters("id",rowIdsToLock.toArray());
    _resourceCountDao.lockRows(sc,null,true);
    List<DomainVO> domainChildren=_domainDao.findImmediateChildrenForParent(domainId);
    if (type.supportsOwner(ResourceOwnerType.Domain)) {
      for (      DomainVO domainChild : domainChildren) {
        long domainCount=recalculateDomainResourceCount(domainChild.getId(),type);
        count=count + domainCount;
      }
    }
    if (type.supportsOwner(ResourceOwnerType.Account)) {
      List<AccountVO> accounts=_accountDao.findActiveAccountsForDomain(domainId);
      for (      AccountVO account : accounts) {
        long accountCount=recalculateAccountResourceCount(account.getId(),type);
        count=count + accountCount;
      }
    }
    _resourceCountDao.setResourceCount(domainId,ResourceOwnerType.Domain,type,count);
  }
 catch (  Exception e) {
    throw new CloudRuntimeException("Failed to update resource count for domain with Id " + domainId);
  }
 finally {
    txn.commit();
  }
  return count;
}
