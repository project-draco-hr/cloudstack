{
  long numResources=((count.length == 0) ? 1 : count[0]);
  Transaction txn=Transaction.currentTxn();
  txn.start();
  try {
    Set<Long> rowIdsToLock=_resourceCountDao.listAllRowsToUpdate(domain.getId(),ResourceOwnerType.Domain,type);
    SearchCriteria<ResourceCountVO> sc=ResourceCountSearch.create();
    sc.setParameters("id",rowIdsToLock.toArray());
    _resourceCountDao.lockRows(sc,null,true);
    Long domainId=domain.getId();
    while (domainId != null) {
      ResourceLimitVO domainLimit=_resourceLimitDao.findByOwnerIdAndType(domainId,ResourceOwnerType.Domain,type);
      if (domainLimit != null) {
        long domainCount=_resourceCountDao.getResourceCount(domainId,ResourceOwnerType.Domain,type);
        if ((domainCount + numResources) > domainLimit.getMax().longValue()) {
          return true;
        }
      }
      domain=_domainDao.findById(domainId);
      domainId=domain.getParent();
    }
    return false;
  }
  finally {
    txn.commit();
  }
}
