def coalesceLeafAtomic(session, srUuid, vdiUuid):
    'Coalesce a leaf node onto its parent. This should be invoked in the\n    stop_using_these_vdis_() context to ensure that the leaf is offline. It is\n    dangerous to invoke this function otherwise. Return True on success, False\n    if the target VDI is no longer leaf-coalesceable'
    Util.log(('=== SR %s: coalesceLeafAtomic for VDI %s ===' % (srUuid, vdiUuid)))
    init(srUuid)
    sr = SR.getInstance(srUuid, session)
    sr.lock()
    try:
        sr.scan()
        vdi = sr.getVDI(vdiUuid)
        if (not vdi.isLeafCoalesceable()):
            return False
        try:
            sr._doCoalesceLeaf(vdi)
        except:
            Util.logException('_doCoalesceLeaf')
            sr._handleInterruptedCoalesceLeaf()
            raise
    finally:
        sr.cleanup()
        sr.unlock()
        Util.log('final SR state:')
        Util.log(sr.toString())
        sr.printVDIs()
    return True
