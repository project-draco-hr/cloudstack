def findLeafCoalesceable(self):
    'Find leaf-coalesceable VDIs in each VHD tree'
    candidates = []
    for vdi in self.vdis.values():
        if (not vdi.isLeafCoalesceable()):
            continue
        if (vdi in self._failedCoalesceTargets):
            continue
        if (vdi.getConfig(vdi.DB_LEAFCLSC) == vdi.LEAFCLSC_DISABLED):
            Util.log(('Leaf-coalesce disabled for %s' % vdi.toString()))
            continue
        if (not (AUTO_ONLINE_LEAF_COALESCE_ENABLED or (vdi.getConfig(vdi.DB_LEAFCLSC) == vdi.LEAFCLSC_FORCE))):
            continue
        candidates.append(vdi)
    freeSpace = self.getFreeSpace()
    for candidate in candidates:
        spaceNeeded = candidate._calcExtraSpaceForSnapshotCoalescing()
        spaceNeededLive = spaceNeeded
        if (spaceNeeded > freeSpace):
            spaceNeededLive = candidate._calcExtraSpaceForLeafCoalescing()
            if candidate.canLiveCoalesce():
                spaceNeeded = spaceNeededLive
        if (spaceNeeded <= freeSpace):
            Util.log(('Leaf-coalesce candidate: %s' % candidate.toString()))
            return candidate
        else:
            Util.log(('No space to leaf-coalesce %s (free space: %d)' % (candidate.toString(), freeSpace)))
            if (spaceNeededLive <= freeSpace):
                Util.log('...but enough space if skip snap-coalesce')
                candidate.setConfigUpdate(VDI.DB_LEAFCLSC, VDI.LEAFCLSC_OFFLINE)
    return None
