def _doCoalesceLeaf(self, vdi):
    'Actual coalescing of a leaf VDI onto parent. Must be called in an\n        offline/atomic context'
    vdi._activateChain()
    self.journaler.create(VDI.JRN_LEAF, vdi.uuid, vdi.parent.uuid)
    self.lvmCache.setReadonly(vdi.parent.lvName, False)
    vdi.parent._setHidden(False)
    vdi.deflate()
    vdi.inflateParentForCoalesce()
    vdi.parent._increaseSizeVirt(vdi.sizeVirt, False)
    vdi.validate()
    vdi.parent.validate()
    util.fistpoint.activate('LVHDRT_coaleaf_before_coalesce', self.uuid)
    timeout = vdi.LIVE_LEAF_COALESCE_TIMEOUT
    if (vdi.getConfig(vdi.DB_LEAFCLSC) == vdi.LEAFCLSC_FORCE):
        Util.log('Leaf-coalesce forced, will not use timeout')
        timeout = 0
    vdi._coalesceVHD(timeout)
    util.fistpoint.activate('LVHDRT_coaleaf_after_coalesce', self.uuid)
    vdi.parent.validate()
    vdiUuid = vdi.uuid
    oldNameLV = vdi.lvName
    origParentUuid = vdi.parent.uuid
    vdi.rename((self.TMP_RENAME_PREFIX + vdiUuid))
    util.fistpoint.activate('LVHDRT_coaleaf_one_renamed', self.uuid)
    vdi.parent.rename(vdiUuid)
    util.fistpoint.activate('LVHDRT_coaleaf_both_renamed', self.uuid)
    self._updateSlavesOnRename(vdi.parent, oldNameLV)
    vdi.parent.delConfig(VDI.DB_VHD_PARENT)
    if vdi.parent.raw:
        vdi.parent.setConfig(VDI.DB_VDI_TYPE, lvhdutil.VDI_TYPE_RAW)
    vdi.parent.delConfig(VDI.DB_VHD_BLOCKS)
    vdi.parent.updateConfig()
    util.fistpoint.activate('LVHDRT_coaleaf_after_vdirec', self.uuid)
    ns = (lvhdutil.NS_PREFIX_LVM + self.uuid)
    (cCnt, cBcnt) = RefCounter.check(vdi.uuid, ns)
    (pCnt, pBcnt) = RefCounter.check(vdi.parent.uuid, ns)
    pCnt = (pCnt - cBcnt)
    assert (pCnt >= 0)
    RefCounter.set(vdi.parent.uuid, pCnt, cBcnt, ns)
    parent = vdi.parent
    vdi._setHidden(True)
    vdi.parent.children = []
    vdi.parent = None
    util.fistpoint.activate('LVHDRT_coaleaf_before_delete', self.uuid)
    self.deleteVDI(vdi)
    util.fistpoint.activate('LVHDRT_coaleaf_after_delete', self.uuid)
    self.xapi.forgetVDI(origParentUuid)
    parent.inflateFully()
    util.fistpoint.activate('LVHDRT_coaleaf_before_remove_j', self.uuid)
    self.journaler.remove(VDI.JRN_LEAF, vdiUuid)
