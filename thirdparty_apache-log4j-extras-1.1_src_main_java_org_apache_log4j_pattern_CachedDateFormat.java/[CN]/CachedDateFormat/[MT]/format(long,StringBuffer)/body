{
  if (now == previousTime) {
    buf.append(cache);
    return buf;
  }
  if (millisecondStart != UNRECOGNIZED_MILLISECONDS && (now < (slotBegin + expiration)) && (now >= slotBegin) && (now < (slotBegin + 1000L))) {
    if (millisecondStart >= 0) {
      millisecondFormat((int)(now - slotBegin),cache,millisecondStart);
    }
    previousTime=now;
    buf.append(cache);
    return buf;
  }
  cache.setLength(0);
  tmpDate.setTime(now);
  cache.append(formatter.format(tmpDate));
  buf.append(cache);
  previousTime=now;
  slotBegin=(previousTime / 1000) * 1000;
  if (slotBegin > previousTime) {
    slotBegin-=1000;
  }
  if (millisecondStart >= 0) {
    millisecondStart=findMillisecondStart(now,cache.toString(),formatter);
  }
  return buf;
}
