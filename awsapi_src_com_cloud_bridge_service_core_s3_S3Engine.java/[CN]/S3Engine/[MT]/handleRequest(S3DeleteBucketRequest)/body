{
  S3Response response=new S3Response();
  String bucketName=request.getBucketName();
  SBucketVO sbucket=bucketDao.getByName(bucketName);
  Transaction txn=null;
  if (sbucket != null) {
    txn=Transaction.open(Transaction.AWSAPI_DB);
    txn.start();
    S3PolicyContext context=new S3PolicyContext(PolicyActions.DeleteBucket,bucketName);
switch (verifyPolicy(context)) {
case ALLOW:
      break;
case DENY:
    throw new PermissionDeniedException("Access Denied - bucket policy DENY result");
case DEFAULT_DENY:
default :
  String client=UserContext.current().getCanonicalUserId();
if (!client.equals(sbucket.getOwnerCanonicalId())) {
  throw new PermissionDeniedException("Access Denied - only the owner can delete a bucket");
}
break;
}
OrderedPair<SHostVO,String> host_storagelocation_pair=getBucketStorageHost(sbucket);
S3BucketAdapter bucketAdapter=getStorageHostBucketAdapter(host_storagelocation_pair.getFirst());
bucketAdapter.deleteContainer(host_storagelocation_pair.getSecond(),request.getBucketName());
Set<SObjectVO> objectsInBucket=sbucket.getObjectsInBucket();
Iterator<SObjectVO> it=objectsInBucket.iterator();
while (it.hasNext()) {
SObjectVO oneObject=it.next();
Set<SObjectItemVO> itemsInObject=oneObject.getItems();
Iterator<SObjectItemVO> is=itemsInObject.iterator();
while (is.hasNext()) {
SObjectItemVO oneItem=is.next();
deleteMetaData(oneItem.getId());
deleteObjectAcls("SObjectItem",oneItem.getId());
}
}
try {
ServiceProvider.getInstance().deleteBucketPolicy(bucketName);
bPolicyDao.deletePolicy(bucketName);
}
 catch (Exception e) {
logger.error("When deleting a bucket we must try to delete its policy: ",e);
}
deleteBucketAcls(sbucket.getId());
bucketDao.remove(sbucket.getId());
response.setResultCode(204);
response.setResultDescription("OK");
txn.close();
}
 else {
response.setResultCode(404);
response.setResultDescription("Bucket does not exist");
}
return response;
}
